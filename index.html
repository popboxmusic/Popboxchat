<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Popbox Chat - WhatsApp Tasarƒ±mƒ±</title>
    <!-- FIREBASE SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        /* WHATSAPP TASARIMI */
        :root {
            --whatsapp-green: #25D366;
            --whatsapp-green-dark: #128C7E;
            --whatsapp-green-light: #DCF8C6;
            --whatsapp-gray-light: #ECE5DD;
            --whatsapp-gray-dark: #075E54;
            --whatsapp-blue: #34B7F1;
            --whatsapp-gray: #667781;
            --bg-dark: #0C1317;
            --bg-medium: #111B21;
            --bg-light: #202C33;
            --text-light: #E9EDEF;
            --text-gray: #8696A0;
            --online-green: #00A884;
            --admin-red: #FF3E30;
            --coadmin-yellow: #FFD700;
            --operator-blue: #0084FF;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
        }
        
        /* WHATSAPP STYLE Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            background: linear-gradient(to bottom, var(--whatsapp-green-dark), var(--whatsapp-green));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            gap: 30px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-logo {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .login-title {
            color: white;
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            font-weight: 300;
        }
        
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            min-width: 320px;
        }
        
        .login-input {
            width: 100%;
            padding: 18px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f8f8f8;
            color: #333;
            font-size: 17px;
            outline: none;
            transition: all 0.3s;
        }
        
        .login-input:focus {
            border-color: var(--whatsapp-green);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 18px;
            margin-top: 20px;
            background: var(--whatsapp-green);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 17px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: var(--whatsapp-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .login-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        /* ANA UYGULAMA - WHATSAPP STYLE */
        .app-container {
            display: none;
            height: 100vh;
            background: var(--bg-dark);
        }
        
        /* HEADER - WHATSAPP STYLE */
        .header {
            background: var(--bg-light);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            height: 60px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--whatsapp-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-status {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }
        
        /* ANA ƒ∞√áERƒ∞K */
        .main-content {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }
        
        /* SOL Sƒ∞DEBAR - CHAT Lƒ∞ST */
        .sidebar {
            width: 380px;
            background: var(--bg-dark);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .search-box {
            padding: 15px;
            background: var(--bg-light);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-medium);
            border: none;
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            outline: none;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .chat-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
        }
        
        .chat-item:hover {
            background: var(--bg-light);
        }
        
        .chat-item.active {
            background: var(--bg-light);
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            background: var(--whatsapp-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            position: relative;
        }
        
        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid var(--bg-dark);
            border-radius: 50%;
        }
        
        .chat-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-preview {
            font-size: 14px;
            color: var(--text-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .chat-time {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .unread-count {
            background: var(--whatsapp-green);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        /* SAƒû PANEL - CHAT ALANI */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-medium);
        }
        
        .chat-header {
            padding: 15px;
            background: var(--bg-light);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-contact {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-actions {
            display: flex;
            gap: 15px;
        }
        
        /* MESAJLAR ALANI - WHATSAPP STYLE */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: url('https://web.whatsapp.com/img/bg-chat-tile-light_686b98c9fdffef3f63127759e2057750.png');
            background-color: var(--bg-medium);
            background-blend-mode: overlay;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* WHATSAPP MESAJ STƒ∞LLERƒ∞ */
        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* G√ñNDERƒ∞LEN MESAJ (SAƒû) */
        .message.sent {
            align-self: flex-end;
            background: var(--whatsapp-green-light);
            color: #111;
            border-top-right-radius: 0;
            margin-left: auto;
        }
        
        /* ALINAN MESAJ (SOL) */
        .message.received {
            align-self: flex-start;
            background: white;
            color: #111;
            border-top-left-radius: 0;
            margin-right: auto;
        }
        
        /* Sƒ∞STEM MESAJI */
        .message.system {
            align-self: center;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
            max-width: 80%;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        /* YETKƒ∞Lƒ∞ MESAJLARI */
        .message.admin {
            border-left: 3px solid var(--admin-red);
            background: rgba(255, 62, 48, 0.1);
        }
        
        .message.coadmin {
            border-left: 3px solid var(--coadmin-yellow);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .message.operator {
            border-left: 3px solid var(--operator-blue);
            background: rgba(0, 132, 255, 0.1);
        }
        
        /* √ñZEL MESAJ */
        .message.private {
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-left: 3px solid #EC4899;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .message-sender {
            font-weight: 600;
            color: var(--whatsapp-green-dark);
        }
        
        .message-time {
            color: var(--text-gray);
            font-size: 11px;
            margin-left: 10px;
        }
        
        /* MESAJ Gƒ∞Rƒ∞≈û ALANI - WHATSAPP STYLE */
        .message-input-container {
            padding: 15px;
            background: var(--bg-light);
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 20px;
            background: var(--bg-medium);
            border: none;
            border-radius: 25px;
            color: var(--text-light);
            font-size: 15px;
            outline: none;
            resize: none;
            height: 45px;
            line-height: 20px;
            font-family: inherit;
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            background: var(--whatsapp-green);
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: var(--whatsapp-green-dark);
            transform: scale(1.05);
        }
        
        /* YOUTUBE PLAYER */
        .youtube-player {
            width: 100%;
            height: 250px;
            background: #000;
            position: relative;
        }
        
        #youtube-player {
            width: 100%;
            height: 100%;
        }
        
        .youtube-controls {
            padding: 10px 15px;
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* MODAL STƒ∞LLERƒ∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--bg-light);
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px;
            background: var(--whatsapp-green-dark);
            color: white;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--bg-medium);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: var(--whatsapp-green);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: var(--whatsapp-green-dark);
        }
        
        .modal-btn.secondary {
            background: var(--bg-medium);
            color: var(--text-light);
        }
        
        /* MOBƒ∞L UYUMLULUK */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .sidebar.active {
                display: flex;
            }
            
            .chat-panel {
                display: none;
            }
            
            .chat-panel.active {
                display: flex;
            }
            
            .login-box {
                padding: 25px;
                min-width: 300px;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .message {
                max-width: 85%;
            }
        }
        
        /* Bƒ∞LDƒ∞Rƒ∞M BADGE */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--admin-red);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* YETKƒ∞ BADGE'LERƒ∞ */
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .badge.admin {
            background: var(--admin-red);
            color: white;
        }
        
        .badge.coadmin {
            background: var(--coadmin-yellow);
            color: black;
        }
        
        .badge.operator {
            background: var(--operator-blue);
            color: white;
        }
    </style>
</head>
<body>
    <!-- WHATSAPP STYLE Gƒ∞Rƒ∞≈û -->
    <div id="login-screen">
        <div class="login-header">
            <div class="login-logo">üí¨</div>
            <div class="login-title">Popbox Chat</div>
            <div class="login-subtitle">WhatsApp Tasarƒ±mlƒ± Sohbet Platformu</div>
        </div>
        <div class="login-box">
            <input type="text" id="login-nick" class="login-input" placeholder="Kullanƒ±cƒ± adƒ±nƒ±z" autocomplete="off">
            <button class="login-btn" onclick="login()" id="login-btn">Sohbete Katƒ±l</button>
            <div class="login-info">
                üí° Sadece kullanƒ±cƒ± adƒ±nƒ±zƒ± yazƒ±n, ≈üifre gerekmemektedir.<br>
                üëë Adminler: popbox, popboxmusic
            </div>
            <div class="error-message" id="login-error" style="display:none;color:red;margin-top:10px;"></div>
        </div>
    </div>
    
    <!-- WHATSAPP STYLE ANA UYGULAMA -->
    <div class="app-container" id="app">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Kullanƒ±cƒ±</div>
                    <div class="user-status" id="userStatus">√áevrimi√ßi</div>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="toggleYoutube()">üéµ</button>
                <button class="icon-btn" onclick="showOnlineUsers()">üë•</button>
            </div>
        </div>
        
        <!-- ANA ƒ∞√áERƒ∞K -->
        <div class="main-content">
            <!-- SOL Sƒ∞DEBAR - CHAT Lƒ∞ST -->
            <div class="sidebar" id="sidebar">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Sohbet ara..." id="searchChat">
                </div>
                <div class="chat-list" id="chatList">
                    <!-- Sohbet listesi buraya gelecek -->
                </div>
            </div>
            
            <!-- SAƒû PANEL - AKTƒ∞F CHAT -->
            <div class="chat-panel" id="chatPanel">
                <!-- CHAT HEADER -->
                <div class="chat-header" id="chatHeader">
                    <div class="chat-contact">
                        <div class="chat-avatar" id="chatAvatar">G</div>
                        <div class="chat-info">
                            <div class="chat-name" id="chatTitle">üí¨ Genel Sohbet</div>
                            <div class="chat-preview" id="chatSubtitle">Online kullanƒ±cƒ±larla sohbet</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="icon-btn" onclick="toggleVideo()">üìπ</button>
                    </div>
                </div>
                
                <!-- YOUTUBE PLAYER (Gƒ∞ZLƒ∞) -->
                <div class="youtube-player" id="youtubeContainer" style="display: none;">
                    <div id="youtube-player"></div>
                    <div class="youtube-controls">
                        <div id="video-title">Popbox Music</div>
                        <button class="send-btn" onclick="playRandomMusic()" style="width: auto; padding: 8px 15px;">
                            ‚ñ∂Ô∏è Rastgele √áal
                        </button>
                    </div>
                </div>
                
                <!-- MESAJLAR -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Mesajlar buraya gelecek -->
                </div>
                
                <!-- MESAJ Gƒ∞Rƒ∞≈û -->
                <div class="message-input-container">
                    <input type="text" class="message-input" id="messageInput" 
                           placeholder="Mesaj yazƒ±n..." 
                           autocomplete="off">
                    <button class="send-btn" onclick="sendMessage()">
                        üì§
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- √ñZEL SOHBET MODAL -->
    <div class="modal-overlay" id="privateChatModal">
        <div class="modal-content">
            <div class="modal-header">
                üíå √ñzel Sohbet - <span id="privateUserName"></span>
            </div>
            <div class="modal-body">
                <div class="messages-container" id="privateMessages" 
                     style="height: 300px; background: transparent; padding: 10px;">
                    <!-- √ñzel mesajlar -->
                </div>
                <div class="message-input-container" style="margin-top: 15px; padding: 0;">
                    <input type="text" class="message-input" id="privateMessageInput" 
                           placeholder="√ñzel mesaj yazƒ±n..." 
                           autocomplete="off">
                    <button class="send-btn" onclick="sendPrivateMessage()">
                        üì§
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Y√ñNETƒ∞Cƒ∞ MODAL -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                üëë Y√∂netici Paneli
            </div>
            <div class="modal-body">
                <input type="text" id="adminNick" class="modal-input" placeholder="Kullanƒ±cƒ± adƒ±">
                <input type="text" id="adminPassword" class="modal-input" placeholder="≈ûifre">
                <select id="adminRole" class="modal-input">
                    <option value="user">Kullanƒ±cƒ±</option>
                    <option value="operator">Operat√∂r</option>
                    <option value="coadmin">Co-Admin</option>
                    <option value="admin">Admin</option>
                </select>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeModal('adminModal')">
                        ƒ∞ptal
                    </button>
                    <button class="modal-btn primary" onclick="registerUser()">
                        Kaydet
                    </button>
                    <button class="modal-btn" style="background: #FF3E30;" 
                            onclick="deleteUser()">
                        Sil
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== KONFƒ∞G√úRASYON ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.firebasestorage.app",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835",
            measurementId: "G-SB1K22FLEX"
        };
        
        // Admin bilgileri
        const ADMINS = {
            'popbox': { password: 'kumsal07@', role: 'admin' },
            'popboxmusic': { password: 'popbox07@', role: 'admin' }
        };
        
        // Popbox Music videolarƒ±
        const POPBOX_MUSIC_VIDEOS = [
            'dQw4w9WgXcQ', '9bZkp7q19f0', 'kJQP7kiw5Fk', 'JGwWNGJdvx8'
        ];
        
        // ========== DEƒûƒ∞≈ûKENLER ==========
        let database, usersRef, messagesRef, privateChatsRef, registeredUsersRef, notificationsRef;
        let currentUser = null;
        let currentChat = 'general';
        let privateChatWith = null;
        let youtubePlayer = null;
        let isAdmin = false;
        let isCoAdmin = false;
        let isOperator = false;
        let notificationCount = 0;
        
        // ========== FIREBASE BA≈ûLATMA ==========
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                usersRef = database.ref('users');
                messagesRef = database.ref('messages');
                privateChatsRef = database.ref('privateChats');
                registeredUsersRef = database.ref('registeredUsers');
                notificationsRef = database.ref('notifications');
                
                console.log("Firebase ba≈ülatƒ±ldƒ±");
            } catch (error) {
                showLoginError("Firebase baƒülantƒ± hatasƒ±!");
            }
        }
        
        // ========== Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ (≈ûƒ∞FRESƒ∞Z) ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const nick = nickInput.value.trim();
            
            if (!nick || nick.length < 2) {
                showLoginError("Kullanƒ±cƒ± adƒ± en az 2 karakter olmalƒ±!");
                return;
            }
            
            // Bot isimlerini engelle
            const botNames = ['gamze', 'murat', 'sabri', 'sevgi'];
            if (botNames.includes(nick.toLowerCase())) {
                showLoginError("Bu kullanƒ±cƒ± adƒ± kullanƒ±lamaz!");
                return;
            }
            
            try {
                // Admin kontrol√º
                if (ADMINS[nick.toLowerCase()]) {
                    currentUser = {
                        name: nick,
                        role: 'admin'
                    };
                    isAdmin = true;
                } else {
                    // Kayƒ±tlƒ± kullanƒ±cƒ± kontrol√º
                    const userSnap = await registeredUsersRef.child(nick).once('value');
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        currentUser = {
                            name: nick,
                            role: userData.role || 'user'
                        };
                        
                        if (userData.role === 'admin') isAdmin = true;
                        if (userData.role === 'coadmin') isCoAdmin = true;
                        if (userData.role === 'operator') isOperator = true;
                        
                    } else {
                        // Yeni kullanƒ±cƒ±
                        currentUser = {
                            name: nick,
                            role: 'user'
                        };
                    }
                }
                
                // Online listeye ekle
                await usersRef.child(nick).set({
                    name: nick,
                    role: currentUser.role,
                    status: 'online',
                    lastSeen: Date.now()
                });
                
                // Disconnect handler
                usersRef.child(nick).onDisconnect().remove();
                
                // PopboxChat botunu co-admin yap
                if (nick.toLowerCase() === 'popboxchat') {
                    await registeredUsersRef.child('PopboxChat').set({
                        role: 'coadmin',
                        registeredAt: Date.now()
                    });
                }
                
                // Giri≈ü ba≈üarƒ±lƒ±
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Kullanƒ±cƒ± aray√ºz√ºn√º g√ºncelle
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
                
                // Uygulamayƒ± ba≈ülat
                initializeApp();
                
            } catch (error) {
                showLoginError("Giri≈ü hatasƒ±: " + error.message);
            }
        }
        
        // ========== UYGULAMA BA≈ûLATMA ==========
        function initializeApp() {
            // Event listener'lar
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('privateMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendPrivateMessage();
            });
            
            // Touch scroll i√ßin
            setupTouchScrolling();
            
            // YouTube player
            initYouTubePlayer();
            
            // Firebase listener'larƒ±
            setupFirebaseListeners();
            
            // Sohbet listesini y√ºkle
            loadChatList();
            
            // Genel sohbeti a√ß
            loadChat('general');
            
            // Online status g√ºncelleme
            setInterval(updateOnlineStatus, 30000);
        }
        
        // ========== TOUCH SCROLL D√úZELTMESƒ∞ ==========
        function setupTouchScrolling() {
            const container = document.getElementById('messagesContainer');
            
            container.addEventListener('touchstart', handleTouchStart, { passive: true });
            container.addEventListener('touchmove', handleTouchMove, { passive: false });
            container.addEventListener('touchend', handleTouchEnd, { passive: true });
            
            let startY = 0;
            let isScrolling = false;
            
            function handleTouchStart(e) {
                startY = e.touches[0].clientY;
                isScrolling = true;
            }
            
            function handleTouchMove(e) {
                if (!isScrolling) return;
                
                const currentY = e.touches[0].clientY;
                const diff = startY - currentY;
                
                container.scrollTop += diff;
                startY = currentY;
                
                e.preventDefault();
            }
            
            function handleTouchEnd() {
                isScrolling = false;
            }
        }
        
        // ========== FIREBASE LISTENERS ==========
        function setupFirebaseListeners() {
            // Genel mesajlar
            messagesRef.child('general').limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (currentChat === 'general') {
                    addMessageToChat(message, 'general');
                }
            });
            
            // √ñzel mesajlar
            if (currentUser) {
                privateChatsRef.on('child_added', (snapshot) => {
                    const chatId = snapshot.key;
                    const [user1, user2] = chatId.split('_');
                    
                    if (user1 === currentUser.name || user2 === currentUser.name) {
                        const otherUser = user1 === currentUser.name ? user2 : user1;
                        snapshot.ref.limitToLast(1).on('child_added', (msgSnap) => {
                            const message = msgSnap.val();
                            if (message.sender !== currentUser.name) {
                                showPrivateNotification(otherUser, message.text);
                            }
                        });
                    }
                });
            }
            
            // Bildirimler
            if (currentUser) {
                notificationsRef.child(currentUser.name).on('child_added', (snapshot) => {
                    const notification = snapshot.val();
                    showAdminNotification(notification);
                    snapshot.ref.remove();
                });
            }
            
            // Online kullanƒ±cƒ±lar
            usersRef.on('value', (snapshot) => {
                updateOnlineUsers(snapshot.val());
            });
        }
        
        // ========== CHAT Sƒ∞STEMƒ∞ ==========
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                return;
            }
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                role: currentUser.role
            };
            
            try {
                if (currentChat === 'general') {
                    await messagesRef.child('general').push(messageData);
                } else if (currentChat.startsWith('private_')) {
                    const targetUser = currentChat.replace('private_', '');
                    await sendPrivateMessageToUser(targetUser, text);
                }
                
                // Online status g√ºncelle
                updateOnlineStatus();
                
            } catch (error) {
                console.error("Mesaj g√∂nderme hatasƒ±:", error);
            }
            
            input.value = '';
            input.focus();
        }
        
        function loadChat(chatId) {
            currentChat = chatId;
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (chatId === 'general') {
                document.getElementById('chatTitle').textContent = 'üí¨ Genel Sohbet';
                document.getElementById('chatAvatar').textContent = 'G';
                document.getElementById('chatSubtitle').textContent = 'Online kullanƒ±cƒ±larla sohbet';
                
                // Mesajlarƒ± y√ºkle
                messagesRef.child('general').limitToLast(50).once('value', (snapshot) => {
                    const messages = snapshot.val();
                    if (messages) {
                        Object.values(messages).forEach(msg => {
                            addMessageToChat(msg, 'general');
                        });
                    }
                });
                
            } else if (chatId.startsWith('private_')) {
                const targetUser = chatId.replace('private_', '');
                document.getElementById('chatTitle').textContent = `üíå ${targetUser}`;
                document.getElementById('chatAvatar').textContent = targetUser.charAt(0).toUpperCase();
                document.getElementById('chatSubtitle').textContent = '√ñzel sohbet';
                
                loadPrivateMessages(targetUser);
            }
            
            // Mobile i√ßin panel g√∂ster
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('chatPanel').classList.add('active');
            }
        }
        
        function addMessageToChat(message, type) {
            const container = document.getElementById('messagesContainer');
            const isOwnMessage = message.sender === currentUser.name;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
            
            // Rol class'ƒ±nƒ± ekle
            if (message.role === 'admin') messageDiv.classList.add('admin');
            else if (message.role === 'coadmin') messageDiv.classList.add('coadmin');
            else if (message.role === 'operator') messageDiv.classList.add('operator');
            
            if (type === 'private') messageDiv.classList.add('private');
            
            // Avatar renk
            const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2'];
            const hash = message.sender.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const color = colors[hash % colors.length];
            
            let roleBadge = '';
            if (message.role === 'admin') roleBadge = '<span class="badge admin">ADMIN</span> ';
            else if (message.role === 'coadmin') roleBadge = '<span class="badge coadmin">CO-ADMIN</span> ';
            else if (message.role === 'operator') roleBadge = '<span class="badge operator">OP</span> ';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender" style="color: ${color}">
                        ${roleBadge}${message.sender}
                    </span>
                    <span class="message-time">${message.time}</span>
                </div>
                <div>${message.text}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== √ñZEL MESAJ Sƒ∞STEMƒ∞ ==========
        function openPrivateChat(userName) {
            privateChatWith = userName;
            
            // Modal'ƒ± a√ß
            document.getElementById('privateUserName').textContent = userName;
            document.getElementById('privateChatModal').style.display = 'flex';
            
            // Mesajlarƒ± y√ºkle
            loadPrivateMessages(userName);
            
            // Input'a focus
            setTimeout(() => {
                document.getElementById('privateMessageInput').focus();
            }, 100);
        }
        
        async function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            
            if (!text || !privateChatWith) return;
            
            await sendPrivateMessageToUser(privateChatWith, text);
            input.value = '';
            input.focus();
        }
        
        async function sendPrivateMessageToUser(targetUser, text) {
            const chatId = [currentUser.name, targetUser].sort().join('_');
            
            const messageData = {
                sender: currentUser.name,
                receiver: targetUser,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                read: false
            };
            
            await privateChatsRef.child(chatId).push(messageData);
            
            // Bildirim g√∂nder
            await sendNotification(targetUser, {
                title: "üíå √ñzel Mesaj",
                message: `${currentUser.name}: ${text}`,
                type: "private"
            });
        }
        
        function loadPrivateMessages(targetUser) {
            const chatId = [currentUser.name, targetUser].sort().join('_');
            const privateRef = privateChatsRef.child(chatId);
            
            privateRef.limitToLast(50).once('value', (snapshot) => {
                const container = document.getElementById('privateMessages');
                container.innerHTML = '';
                
                const messages = snapshot.val();
                if (messages) {
                    const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                    
                    sortedMessages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${msg.sender === currentUser.name ? 'sent' : 'received'} private`;
                        
                        messageDiv.innerHTML = `
                            <div class="message-header">
                                <span class="message-sender">${msg.sender}</span>
                                <span class="message-time">${msg.time}</span>
                            </div>
                            <div>${msg.text}</div>
                        `;
                        
                        container.appendChild(messageDiv);
                    });
                    
                    container.scrollTop = container.scrollHeight;
                }
            });
        }
        
        function closePrivateChat() {
            document.getElementById('privateChatModal').style.display = 'none';
            privateChatWith = null;
        }
        
        // ========== Y√ñNETƒ∞Cƒ∞ KOMUTLARI ==========
        function handleCommand(command) {
            const parts = command.substring(1).split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(cmd) {
                case 'reg':
                    if (args.length >= 2 && (isAdmin || isCoAdmin)) {
                        registerUserCommand(args[0], args[1], args[2] || 'user');
                    } else {
                        addSystemMessage("Kullanƒ±m: /reg nick ≈üifre [rol]");
                    }
                    break;
                    
                case 'unreg':
                    if (args.length === 1 && isAdmin) {
                        unregisterUserCommand(args[0]);
                    }
                    break;
                    
                case 'ban':
                    if (args.length >= 2 && (isAdmin || isCoAdmin)) {
                        banUser(args[0], args.slice(1).join(' '));
                    }
                    break;
                    
                case 'op':
                    if (args.length === 1 && isAdmin) {
                        promoteUser(args[0], 'operator');
                    }
                    break;
                    
                case 'coadmin':
                    if (args.length === 1 && isAdmin) {
                        promoteUser(args[0], 'coadmin');
                    }
                    break;
                    
                case 'admin':
                    if (args.length === 1 && isAdmin) {
                        promoteUser(args[0], 'admin');
                    }
                    break;
                    
                case 'bildirim':
                    if (args.length >= 2 && (isAdmin || isCoAdmin || isOperator)) {
                        sendNotificationCommand(args[0], args.slice(1).join(' '));
                    }
                    break;
                    
                case 'clear':
                    if (isAdmin || isCoAdmin) {
                        clearChat();
                    }
                    break;
                    
                case 'pm':
                    if (args.length >= 2) {
                        openPrivateChat(args[0]);
                        setTimeout(() => {
                            sendPrivateMessageToUser(args[0], args.slice(1).join(' '));
                        }, 500);
                    }
                    break;
                    
                case 'help':
                    showHelp();
                    break;
                    
                default:
                    addSystemMessage("Bilinmeyen komut: " + cmd);
            }
        }
        
        async function registerUserCommand(nick, password, role) {
            try {
                await registeredUsersRef.child(nick).set({
                    password: password,
                    role: role,
                    registeredBy: currentUser.name,
                    registeredAt: Date.now()
                });
                
                addSystemMessage(`‚úÖ ${nick} kullanƒ±cƒ±sƒ± ${role} olarak kaydedildi.`);
                
            } catch (error) {
                addSystemMessage("Kayƒ±t hatasƒ±: " + error.message);
            }
        }
        
        async function unregisterUserCommand(nick) {
            if (!isAdmin) {
                addSystemMessage("Sadece adminler kullanƒ±cƒ± silebilir!");
                return;
            }
            
            try {
                await registeredUsersRef.child(nick).remove();
                addSystemMessage(`‚úÖ ${nick} kullanƒ±cƒ±sƒ± silindi.`);
                
            } catch (error) {
                addSystemMessage("Silme hatasƒ±: " + error.message);
            }
        }
        
        async function sendNotificationCommand(targetUser, message) {
            try {
                await sendNotification(targetUser, {
                    title: "üì¢ Y√∂netici Bildirimi",
                    message: `${currentUser.name}: ${message}`,
                    type: "admin"
                });
                
                addSystemMessage(`‚úÖ ${targetUser} kullanƒ±cƒ±sƒ±na bildirim g√∂nderildi.`);
                
            } catch (error) {
                addSystemMessage("Bildirim hatasƒ±: " + error.message);
            }
        }
        
        async function sendNotification(targetUser, notification) {
            await notificationsRef.child(targetUser).push({
                ...notification,
                timestamp: Date.now(),
                from: currentUser.name
            });
        }
        
        // ========== Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ==========
        function showPrivateNotification(sender, message) {
            // Browser notification
            if (Notification.permission === 'granted') {
                new Notification(`üíå ${sender}`, {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%2325D366"/></svg>'
                });
            }
            
            // Tab ba≈ülƒ±ƒüƒ±
            notificationCount++;
            document.title = `(${notificationCount}) Popbox Chat`;
            
            // Sohbet listesinde bildirim
            updateChatNotification(sender);
        }
        
        function showAdminNotification(notification) {
            addSystemMessage(`üì¢ ${notification.from}: ${notification.message}`);
            
            // Browser notification
            if (Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message
                });
            }
        }
        
        // ========== YOUTUBE PLAYER ==========
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: POPBOX_MUSIC_VIDEOS[0],
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
        
        function onPlayerReady(event) {
            updateVideoTitle();
        }
        
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                playRandomMusic();
            }
        }
        
        function playRandomMusic() {
            if (!youtubePlayer) return;
            
            const randomIndex = Math.floor(Math.random() * POPBOX_MUSIC_VIDEOS.length);
            youtubePlayer.loadVideoById(POPBOX_MUSIC_VIDEOS[randomIndex]);
            updateVideoTitle();
        }
        
        function updateVideoTitle() {
            if (youtubePlayer) {
                const title = youtubePlayer.getVideoData().title || "Popbox Music";
                document.getElementById('video-title').textContent = title;
            }
        }
        
        function initYouTubePlayer() {
            if (typeof YT !== 'undefined') {
                onYouTubeIframeAPIReady();
            }
        }
        
        function toggleVideo() {
            const container = document.getElementById('youtubeContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
        
        // ========== YARDIMCI FONKSƒ∞YONLAR ==========
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function addSystemMessage(text) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatPanel = document.getElementById('chatPanel');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
                chatPanel.classList.toggle('active');
            }
        }
        
        function showOnlineUsers() {
            // TODO: Online kullanƒ±cƒ± listesi modalƒ±
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function updateOnlineStatus() {
            if (currentUser && usersRef) {
                await usersRef.child(currentUser.name).update({
                    lastSeen: Date.now(),
                    status: 'online'
                });
            }
        }
        
        function updateOnlineUsers(users) {
            const onlineCount = users ? Object.keys(users).length : 0;
            document.getElementById('userStatus').textContent = `${onlineCount} √ßevrimi√ßi`;
        }
        
        function loadChatList() {
            // TODO: Sohbet listesini dinamik y√ºkle
        }
        
        function updateChatNotification(userName) {
            // TODO: Sohbet listesinde bildirim g√ºncelle
        }
        
        // ========== BA≈ûLATMA ==========
        window.addEventListener('load', () => {
            initializeFirebase();
            
            // Enter ile giri≈ü
            document.getElementById('login-nick').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            
            // Notification izni
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (currentUser && usersRef) {
                usersRef.child(currentUser.name).remove();
            }
        });
    </script>
</body>
</html>
