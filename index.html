<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CanlÄ± YayÄ±n & Sohbet</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <!-- CryptoJS - Åžifre hash iÃ§in -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: #1a1a1a;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      z-index: 10;
    }
    .online-count {
      font-size: 0.95rem;
      color: #4caf50;
      font-weight: 500;
    }
    .admin-badge {
      background: #ff9800;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #video-container {
      flex: 3;
      background: #000;
      position: relative;
    }
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 320px;
      background: #111;
      border-left: 1px solid #222;
    }
    #users-container {
      width: 240px;
      background: #0a0a0a;
      border-left: 1px solid #222;
      padding: 16px;
      overflow-y: auto;
    }
    #messages, #private-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .message {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 80%;
      word-break: break-word;
    }
    .message.own {
      background: #e91e63;
      color: white;
      margin-left: auto;
    }
    .message.other {
      background: #2a2a2a;
    }
    .message img {
      max-width: 240px;
      border-radius: 8px;
      margin-top: 6px;
      display: block;
    }
    .new-message-highlight {
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background: rgba(233, 30, 99, 0.3); }
      100% { background: transparent; }
    }
    .blink-notification {
      animation: blink-red 1.2s infinite alternate;
      background: rgba(255, 0, 0, 0.25) !important;
      border-left: 4px solid #ff1744;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    @keyframes blink-red {
      from { opacity: 1; }
      to   { opacity: 0.35; }
    }
    #input-area, #auth-area {
      padding: 12px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    input, button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
    }
    input {
      background: #222;
      color: white;
    }
    button {
      background: #e91e63;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #c2185b;
    }
    #private-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 360px;
      height: 420px;
      background: #111;
      border: 1px solid #444;
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    #private-panel.open {
      transform: translateX(0);
    }
    #private-header {
      padding: 12px;
      background: #1f1f1f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    .user-item {
      padding: 8px 0;
      cursor: pointer;
      border-bottom: 1px solid #222;
      transition: all 0.3s;
    }
    .user-item:hover {
      background: #1a1a1a;
    }
    .auth-container {
      padding: 20px;
      background: #111;
      border-radius: 12px;
      max-width: 400px;
      margin: 20px auto;
    }
    .auth-toggle {
      text-align: center;
      margin: 10px 0;
      color: #4caf50;
      cursor: pointer;
    }
    #auth-error {
      color: #ff5252;
      text-align: center;
      margin-top: 10px;
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      #users-container {
        width: 100%;
        height: 140px;
        border-left: none;
        border-top: 1px solid #333;
      }
      #chat-container { min-width: auto; }
    }
  </style>
</head>
<body>

  <!-- GiriÅŸ / KayÄ±t EkranÄ± -->
  <div id="auth-screen" class="auth-container">
    <h2 id="auth-title">GiriÅŸ Yap</h2>
    <input id="auth-nick" placeholder="KullanÄ±cÄ± adÄ±n (nick)" />
    <input id="auth-password" type="password" placeholder="Åžifre" />
    <button id="auth-action-btn">GiriÅŸ Yap</button>
    <div id="auth-toggle" class="auth-toggle">HesabÄ±n yok mu? KayÄ±t Ol</div>
    <div id="auth-error"></div>
  </div>

  <!-- Ana Sayfa -->
  <div id="main-screen" style="display:none; flex:1; display:flex; flex-direction:column;">
    <header>
      <div>ðŸŽ¤ CanlÄ± YayÄ±n & Sohbet</div>
      <div style="display:flex; align-items:center; gap:16px;">
        <div id="user-info"></div>
        <button id="logout-btn">Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </header>

    <div class="main">
      <div id="video-container">
        <iframe 
          width="100%" 
          height="100%" 
          src="https://www.youtube.com/embed/RN4h0sBtzlc?autoplay=1&mute=1&controls=1&playsinline=1&modestbranding=1"
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      </div>

      <div id="chat-container">
        <div id="messages"></div>
        <div id="input-area">
          <input id="message-input" placeholder="Mesaj yaz..." />
          <button id="send-btn">GÃ¶nder</button>
        </div>
      </div>

      <div id="users-container">
        <h3 style="margin-bottom:12px; color:#e91e63">Online KullanÄ±cÄ±lar</h3>
        <div id="user-list"></div>
      </div>
    </div>

    <!-- Ã–zel sohbet paneli -->
    <div id="private-panel">
      <div id="private-header">
        <span id="private-title">Ã–zel sohbet: ...</span>
        <button onclick="closePrivate()">Ã—</button>
      </div>
      <div id="private-messages"></div>
      <div id="input-area">
        <input id="private-message-input" placeholder="Ã–zel mesaj..." />
        <input type="file" id="private-image-input" accept="image/*" style="display:none;" />
        <button onclick="document.getElementById('private-image-input').click()">ðŸ“Ž</button>
        <button id="send-private-btn">GÃ¶nder</button>
      </div>
    </div>
  </div>

  <script>
    // ====================================================
    // FIREBASE CONFIG
    // ====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
      authDomain: "popboxmusicchat.firebaseapp.com",
      databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
      projectId: "popboxmusicchat",
      storageBucket: "popboxmusicchat.appspot.com",
      messagingSenderId: "206625719024",
      appId: "1:206625719024:web:d28f478a2c96d10412f835",
      measurementId: "G-SB1K22FLEX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentNick = "";
    let currentUid = "";
    let currentPrivateToUid = null;
    let currentPrivateToNick = "";
    let currentPrivateListener = null;
    let currentRole = "user";

    // Emoji map
    const emojiMap = {
      ":)": "ðŸ˜Š", ":(": "ðŸ˜”", ":D": "ðŸ˜„", ":P": "ðŸ˜›", "<3": "â¤ï¸",
      ":fire:": "ðŸ”¥", ":smile:": "ðŸ˜„", ":sad:": "ðŸ˜¢", ":heart:": "â¤ï¸",
      ":thumbsup:": "ðŸ‘", ":thumbsdown:": "ðŸ‘Ž", ":laugh:": "ðŸ˜‚",
      ":cry:": "ðŸ˜­", ":angry:": "ðŸ˜ ", ":love:": "ðŸ¥°", ":cool:": "ðŸ˜Ž"
    };

    function convertEmojis(text) {
      let result = text;
      for (const [code, emoji] of Object.entries(emojiMap)) {
        const regex = new RegExp(code.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), "g");
        result = result.replace(regex, emoji);
      }
      return result;
    }

    // Bildirim sesi
    function playNotificationSound() {
      const sound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
      sound.play().catch(() => {});
    }

    // Admin / CoAdmin / Operator seviyesi
    function getRoleLevel(role) {
      if (role === "admin") return 3;
      if (role === "coadmin") return 2;
      if (role === "operator") return 1;
      return 0;
    }

    // GiriÅŸ / KayÄ±t ekranÄ± toggle
    const authTitle = document.getElementById("auth-title");
    const authActionBtn = document.getElementById("auth-action-btn");
    const authToggle = document.getElementById("auth-toggle");
    let isLogin = true;

    authToggle.onclick = () => {
      isLogin = !isLogin;
      authTitle.textContent = isLogin ? "GiriÅŸ Yap" : "KayÄ±t Ol";
      authActionBtn.textContent = isLogin ? "GiriÅŸ Yap" : "KayÄ±t Ol";
      authToggle.textContent = isLogin ? "HesabÄ±n yok mu? KayÄ±t Ol" : "Zaten hesabÄ±n var mÄ±? GiriÅŸ Yap";
    };

    // GiriÅŸ / KayÄ±t iÅŸlemi
    authActionBtn.onclick = () => {
      const nick = document.getElementById("auth-nick").value.trim();
      const password = document.getElementById("auth-password").value.trim();
      const errorDiv = document.getElementById("auth-error");

      errorDiv.textContent = "";

      if (!nick || !password) {
        errorDiv.textContent = "TÃ¼m alanlarÄ± doldurun!";
        return;
      }

      if (password.length < 6) {
        errorDiv.textContent = "Åžifre en az 6 karakter olmalÄ±!";
        return;
      }

      // Åžifre hash
      const hashedPassword = CryptoJS.SHA256(password).toString();

      db.ref("users").once("value", snapshot => {
        let nickInUse = false;
        let existingUid = null;

        snapshot.forEach(child => {
          const user = child.val();
          if (user && user.nick === nick) {
            nickInUse = true;
            existingUid = child.key;
            return true;
          }
        });

        if (isLogin) {
          // GiriÅŸ
          if (!nickInUse) {
            errorDiv.textContent = "Bu nick kayÄ±tlÄ± deÄŸil.";
            return;
          }

          db.ref("users/" + existingUid).once("value", snap => {
            const userData = snap.val();
            if (userData && userData.password === hashedPassword) {
              currentNick = nick;
              currentUid = existingUid;
              currentRole = userData.role || "user";

              db.ref("users/" + currentUid).update({
                online: true,
                lastSeen: Date.now()
              });

              document.getElementById("auth-screen").style.display = "none";
              document.getElementById("main-screen").style.display = "flex";
              document.getElementById("user-info").textContent = `HoÅŸ geldin, ${currentNick}${getRoleLevel(currentRole) > 0 ? ' (Admin)' : ''}`;
            } else {
              errorDiv.textContent = "Åžifre yanlÄ±ÅŸ.";
            }
          });
        } else {
          // KayÄ±t
          if (nickInUse) {
            errorDiv.textContent = "Bu nick zaten alÄ±nmÄ±ÅŸ.";
            return;
          }

          const newUid = db.ref("users").push().key;
          db.ref("users/" + newUid).set({
            nick: nick,
            password: hashedPassword,
            online: true,
            lastSeen: Date.now(),
            role: (nick === "popbox") ? "admin" : "user"
          }).then(() => {
            currentNick = nick;
            currentUid = newUid;
            currentRole = (nick === "popbox") ? "admin" : "user";

            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("main-screen").style.display = "flex";
            document.getElementById("user-info").textContent = `HoÅŸ geldin, ${currentNick}${getRoleLevel(currentRole) > 0 ? ' (Admin)' : ''}`;
          });
        }
      });
    };

    // Ã‡Ä±kÄ±ÅŸ yap
    document.getElementById("logout-btn").onclick = () => {
      if (currentUid) {
        db.ref("users/" + currentUid).update({
          online: false,
          lastSeen: Date.now()
        });
      }
      location.reload();
    };

    // Online kullanÄ±cÄ±lar + sayaÃ§ + role badge
    db.ref("users").on("value", snapshot => {
      let count = 0;
      const list = document.getElementById("user-list");
      list.innerHTML = "";

      snapshot.forEach(child => {
        const user = child.val();
        if (user && user.online) {
          count++;
          const div = document.createElement("div");
          div.className = "user-item";
          div.id = `user-${child.key}`;
          let badge = '';
          if (getRoleLevel(user.role) > 0) badge = '<span class="admin-badge">Admin</span>';
          div.innerHTML = `${user.nick}${badge}`;
          div.onclick = () => openPrivateChat(child.key, user.nick);
          list.appendChild(div);
        }
      });

      document.getElementById("online-count").textContent = `Online: ${count} kiÅŸi`;
    });

    // Genel sohbet + otomatik silme + emoji + vurgu
    db.ref("messages").limitToLast(101).on("child_added", snapshot => {
      db.ref("messages").limitToFirst(1).once("child_added", oldest => {
        if (oldest.key !== snapshot.key) oldest.ref.remove();
      });

      const msg = snapshot.val();
      const div = document.createElement("div");
      div.className = `message ${msg.nick === currentNick ? "own" : "other"} new-message-highlight`;
      div.innerHTML = `<strong>${msg.nick}:</strong> ${convertEmojis(msg.text || "")}`;
      document.getElementById("messages").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });

      if (msg.nick !== currentNick) {
        setTimeout(() => div.classList.remove("new-message-highlight"), 2000);
      }
    });

    function sendPublicMessage() {
      let text = document.getElementById("message-input").value.trim();
      if (!text || !currentNick) return alert("Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z!");

      // Komut kontrolÃ¼
      if (text.startsWith("/")) {
        const parts = text.substring(1).split(" ");
        const command = parts[0].toLowerCase();

        const myLevel = getRoleLevel(currentRole);

        if (myLevel < 1) {
          alert("Bu komutu kullanmak iÃ§in en az operator olmalÄ±sÄ±n.");
          return;
        }

        if (command === "temiz") {
          if (myLevel >= 2) {
            db.ref("messages").remove();
            alert("Genel sohbet temizlendi.");
          } else {
            alert("Bu komut iÃ§in en az CoAdmin olmalÄ±sÄ±n.");
          }
        } else if (command === "sil") {
          if (myLevel >= 1) {
            db.ref("messages").limitToLast(1).once("value", snap => {
              snap.forEach(child => child.ref.remove());
            });
            alert("Son mesaj silindi.");
          } else {
            alert("Bu komut iÃ§in en az Operator olmalÄ±sÄ±n.");
          }
        } else if (command === "kick" && parts[1]) {
          const targetNick = parts[1];
          db.ref("users").once("value", snap => {
            snap.forEach(child => {
              if (child.val().nick.toLowerCase() === targetNick.toLowerCase()) {
                child.ref.update({ online: false });
                alert(`${targetNick} kicklendi.`);
              }
            });
          });
        } else {
          alert("GeÃ§ersiz komut.");
        }
        document.getElementById("message-input").value = "";
        return;
      }

      db.ref("messages").push({
        nick: currentNick,
        text,
        timestamp: Date.now()
      });
      document.getElementById("message-input").value = "";
    }

    document.getElementById("send-btn").onclick = sendPublicMessage;
    document.getElementById("message-input").onkeypress = e => {
      if (e.key === "Enter") sendPublicMessage();
    };

    // Ã–zel sohbet ve diÄŸer fonksiyonlar (Ã¶nceki kodla aynÄ± kalÄ±yor)
    // EÄŸer istersen tam halini tekrar paylaÅŸÄ±rÄ±m.
  </script>
</body>
</html>
