<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PopboxMusic Chat</title>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial}
body{background:#0e0e0e;color:#fff;height:100vh;overflow:hidden}
#wrap{display:flex;flex-direction:column;height:100vh}

#video iframe{width:100%;height:240px;border:0}

#main{flex:1;display:flex;height:100%}

#chatArea{flex:3;display:flex;flex-direction:column;background:#111}
#messages{flex:1;overflow-y:auto;padding:10px}
.msg{margin:5px 0;padding:6px;background:#1b1b1b;border-radius:6px}
.own{background:#263238}

#inputArea{display:flex;padding:8px;background:#000}
#msgInput{flex:1;padding:10px;font-size:16px}
button{padding:10px 15px;background:#ff3d00;color:#fff;border:0}

#users{flex:1;background:#0b0b0b;border-left:1px solid #222;padding:10px;overflow-y:auto}
.user{padding:5px;cursor:pointer}
.user:hover{background:#222}

#privateBox{
position:fixed;
bottom:0;
right:20px;
width:300px;
height:350px;
background:#121212;
border:1px solid #333;
display:none;
flex-direction:column
}
#pmHeader{background:#000;padding:8px;display:flex;justify-content:space-between}
#pmMessages{flex:1;overflow:auto;padding:6px}
#pmInput{display:flex}
#pmInput input{flex:1;padding:8px}

.blink{animation:blink 1s infinite}
@keyframes blink{50%{background:red}}
</style>
</head>

<body>
<div id="wrap">

<div id="video">
<iframe src="https://www.youtube.com/embed/if4gZc4v0ag?autoplay=1" allow="autoplay"></iframe>
</div>

<div id="main">

<div id="chatArea">
<div id="messages"></div>
<div id="inputArea">
<input id="msgInput" placeholder="Mesaj yaz ve Enter'a bas"/>
<button onclick="sendMsg()">Gönder</button>
</div>
</div>

<div id="users"></div>

</div>
</div>

<!-- PRIVATE CHAT -->
<div id="privateBox">
<div id="pmHeader">
<span id="pmNick"></span>
<button onclick="closePM()">X</button>
</div>
<div id="pmMessages"></div>
<div id="pmInput">
<input id="pmText" placeholder="Özel mesaj"/>
<button onclick="sendPM()">Gönder</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
authDomain:"popboxmusicchat.firebaseapp.com",
projectId:"popboxmusicchat"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let myNick = prompt("Nick gir");
const msgBox=document.getElementById("messages");
const usersBox=document.getElementById("users");

function renderMsg(id,data){
let div=document.createElement("div");
div.className="msg"+(data.nick==myNick?" own":"");
div.innerHTML=`<b>${data.nick}:</b> ${data.text}`;
if(data.nick==myNick){
div.onclick=()=>deleteDoc(doc(db,"messages",id));
}
msgBox.appendChild(div);
msgBox.scrollTop=msgBox.scrollHeight;
}

const q=query(collection(db,"messages"),orderBy("time"));
onSnapshot(q,snap=>{
msgBox.innerHTML="";
snap.forEach(d=>renderMsg(d.id,d.data()));
});

window.sendMsg=async()=>{
let text=msgInput.value;
if(!text)return;
await addDoc(collection(db,"messages"),{nick:myNick,text,time:Date.now()});
msgInput.value="";
}

msgInput.addEventListener("keydown",e=>{
if(e.key==="Enter")sendMsg();
});

onSnapshot(collection(db,"users"),snap=>{
usersBox.innerHTML="";
snap.forEach(d=>{
let u=document.createElement("div");
u.className="user";
u.innerText=d.id;
u.onclick=()=>openPM(d.id);
usersBox.appendChild(u);
});
});

addDoc(collection(db,"users"),{name:myNick});

let pmTo=null;
function openPM(nick){
pmTo=nick;
privateBox.style.display="flex";
pmNick.innerText=nick;
}

window.closePM=()=>privateBox.style.display="none";

window.sendPM=async()=>{
let t=pmText.value;
await addDoc(collection(db,"pm"),{from:myNick,to:pmTo,text:t,time:Date.now()});
pmText.value="";
}

onSnapshot(collection(db,"pm"),snap=>{
snap.forEach(d=>{
let m=d.data();
if(m.to==myNick && privateBox.style.display=="none"){
usersBox.classList.add("blink");
}
});
});
</script>

</body>
</html>
