<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CETCETY â€¢ SON</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
        body { background: #0f0f0f; color: #fff; overflow: hidden; height: 100vh; transition: 0.3s; }
        body.light-theme { background: #f5f5f5; color: #1a1a1a; }
        
        /* SCROLLBAR DÃœZELTÄ°LDÄ° */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        body.light-theme ::-webkit-scrollbar-track { background: #ddd; }
        ::-webkit-scrollbar-thumb { background: #ff0000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #cc0000; }

        .app { display: flex; height: 100vh; width: 100vw; }

        /* GÄ°RÄ°Åž */
        .login-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: #0a0a0a;
            background-image: radial-gradient(rgba(255,0,0,0.2) 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex; align-items: center; justify-content: center;
        }
        .login-overlay::before {
            content: ''; position: absolute; inset: 0;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .login-overlay.hidden { display: none; }
        .login-panel {
            width: 380px; background: rgba(20,20,20,0.8); border: 1px solid #ff0000;
            border-radius: 24px; padding: 32px; position: relative; z-index: 10;
            box-shadow: 0 0 30px rgba(255,0,0,0.3);
        }
        .login-panel h2 { text-align: center; margin-bottom: 24px; color: #ff0000; font-size: 28px; }
        .login-panel input {
            width: 100%; padding: 14px; background: #1a1a1a; border: 1px solid #333;
            border-radius: 12px; color: #fff; margin-bottom: 16px;
        }
        .login-panel button {
            width: 100%; padding: 14px; background: #ff0000; border: none;
            border-radius: 12px; color: #fff; font-weight: bold; cursor: pointer;
        }
        .password-toggle {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            color: #aaa; cursor: pointer;
        }

        /* SOL Ä°KON PANEL */
        .icon-panel {
            width: 72px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; align-items: center; padding: 24px 0;
        }
        .icon-item {
            width: 48px; height: 48px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; color: #aaa; cursor: pointer;
            margin-bottom: 8px; position: relative;
        }
        .icon-item:hover { background: #2a2a2a; color: #fff; }
        .icon-item.active { background: #ff0000; color: #fff; }
        .icon-badge {
            position: absolute; top: -4px; right: -4px; width: 18px; height: 18px;
            background: #ff4444; border-radius: 50%; color: white; font-size: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        .profile-avatar {
            margin-top: auto; width: 48px; height: 48px; border-radius: 50%;
            background: #ff0000; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer;
        }

        /* ANA Ä°Ã‡ERÄ°K */
        .main-content { flex: 1; display: flex; overflow: hidden; }

        /* SOL PANEL */
        .left-panel {
            width: 320px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column;
        }
        .panel-header {
            padding: 16px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }

        /* CHAT PANELÄ° */
        .chat-container {
            flex: 1; display: flex; flex-direction: column; background: #0f0f0f;
        }
        .chat-header {
            padding: 16px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .messages {
            flex: 1; overflow-y: auto; padding: 16px;
        }
        .message {
            max-width: 70%; margin-bottom: 12px;
        }
        .message.right { margin-left: auto; }
        .message-text {
            padding: 8px 12px; background: #1a1a1a; border-radius: 12px; color: #fff;
        }
        .message.right .message-text { background: #ff0000; }
        .system-message {
            text-align: center; color: #aaa; font-size: 12px; padding: 8px;
        }
        .message-input-container {
            padding: 16px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        .input-wrapper {
            display: flex; background: #1a1a1a; border: 1px solid #333;
            border-radius: 24px; padding: 4px;
        }
        .message-input {
            flex: 1; background: transparent; border: none; color: #fff; padding: 8px 12px;
        }
        .send-btn {
            width: 40px; height: 40px; background: #ff0000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* MEDYA PANELÄ° */
        .media-panel {
            width: 400px; background: #0a0a0a; border-left: 1px solid #2a2a2a;
            display: flex; flex-direction: column;
        }
        .media-header {
            padding: 16px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .media-controls { display: flex; gap: 8px; }
        .media-control {
            width: 36px; height: 36px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .youtube-player {
            width: 100%; aspect-ratio: 16/9; background: #000;
        }
        .now-playing {
            padding: 12px; background: #0f0f0f; border-bottom: 1px solid #2a2a2a;
        }
        .playlist-container {
            flex: 1; overflow-y: auto; padding: 16px;
        }
        .playlist-item {
            display: flex; align-items: center; gap: 12px; padding: 8px;
            border-radius: 8px; cursor: pointer;
        }
        .playlist-item:hover { background: #1a1a1a; }
        .playlist-item.active { background: #1a1a1a; border-left: 4px solid #ff0000; }

        /* MODAL */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a1a; padding: 32px; border-radius: 24px; width: 400px;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #333;
            border-radius: 8px; color: #fff; margin-bottom: 16px;
        }
        .modal-buttons { display: flex; gap: 12px; }
        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer;
        }
        .modal-btn.primary { background: #ff0000; color: #fff; }
        .modal-btn.secondary { background: #333; color: #fff; }

        /* Ã–ZEL SOHBET */
        .private-chat-panel {
            position: absolute; inset: 0; background: #0a0a0a; display: none;
            flex-direction: column; z-index: 30;
        }
        .private-chat-panel.active { display: flex; }
        .private-chat-header {
            padding: 16px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .private-chat-messages {
            flex: 1; overflow-y: auto; padding: 16px;
        }
        .private-message {
            max-width: 80%; margin-bottom: 12px;
        }
        .private-message.right { margin-left: auto; }
        .private-message-text {
            padding: 8px 12px; background: #1a1a1a; border-radius: 12px;
        }
        .private-message.right .private-message-text { background: #ff0000; }
        .private-message-media img, .private-message-media video {
            max-width: 200px; border-radius: 8px; cursor: pointer;
        }
        .private-input-container {
            padding: 16px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        .private-input-wrapper {
            display: flex; gap: 8px; background: #1a1a1a; border-radius: 24px; padding: 4px;
        }
        .private-input {
            flex: 1; background: transparent; border: none; color: #fff; padding: 8px 12px;
        }
        .private-send-btn {
            width: 40px; height: 40px; background: #ff0000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-panel">
            <h2>ðŸŽ§ CETCETY</h2>
            <input type="text" id="loginNick" placeholder="KullanÄ±cÄ± adÄ±">
            <div style="position:relative">
                <input type="password" id="loginPassword" placeholder="Åžifre">
                <i class="fas fa-eye password-toggle" onclick="togglePassword()"></i>
            </div>
            <button onclick="handleLogin()">GÄ°RÄ°Åž</button>
            <div style="text-align:center; margin-top:16px; color:#aaa">Owner: mateky / Åžifre: Sahi17407@SCM</div>
        </div>
    </div>

    <div id="app" class="app" style="display:none">
        <div class="icon-panel">
            <div class="icon-item" onclick="showHome()"><i class="fas fa-home"></i></div>
            <div class="icon-item" onclick="openSubscriptions()"><i class="fas fa-bell"></i><span class="icon-badge" id="subscriptionBadge">0</span></div>
            <div class="icon-item" onclick="openChannelPanel()"><i class="fas fa-list-ul"></i><span class="icon-badge" id="channelCountBadge">0</span></div>
            <div class="icon-item" onclick="openChatListPanel()"><i class="fas fa-comment"></i><span class="icon-badge" id="chatListBadge">0</span></div>
            <div class="icon-item" onclick="openCreateChannelPanel()"><i class="fas fa-plus-circle"></i></div>
            <div class="icon-item" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></div>
            <div class="profile-avatar" onclick="openProfilePanel()"><span id="avatarText">?</span></div>
        </div>

        <div class="main-content">
            <div class="left-panel" id="leftPanel"></div>

            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <span id="currentChannelName">genel</span>
                        <span id="channelUserCount">0</span> Ã§evrimiÃ§i
                    </div>
                    <button id="subscribeChannelBtn" onclick="toggleSubscribe()">Abone Ol</button>
                </div>
                <div class="messages" id="messages"></div>
                <div class="message-input-container">
                    <div class="input-wrapper">
                        <input type="text" id="messageInput" class="message-input" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>

                <div id="privateChatPanel" class="private-chat-panel">
                    <div class="private-chat-header">
                        <span id="privateChatName"></span>
                        <div>
                            <button onclick="blockUser()"><i class="fas fa-ban"></i></button>
                            <button onclick="reportUser()"><i class="fas fa-flag"></i></button>
                            <button onclick="closePrivateChat()"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="private-chat-messages" id="privateChatMessages"></div>
                    <div class="private-input-container">
                        <div class="private-input-wrapper">
                            <input type="text" id="privateMessageInput" class="private-input" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendPrivateMessage()">
                            <div class="private-send-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:8px">
                            <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="sendImage(this)">
                            <button onclick="document.getElementById('imageUpload').click()">ðŸ“¸ Resim</button>
                            <input type="file" id="videoUpload" accept="video/*" style="display:none" onchange="sendVideo(this)">
                            <button onclick="document.getElementById('videoUpload').click()">ðŸŽ¥ Video</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="media-panel">
                <div class="media-header">
                    <span>Medya</span>
                    <div class="media-controls">
                        <div class="media-control" onclick="showAddVideo()"><i class="fas fa-plus"></i></div>
                        <div class="media-control" onclick="showLiveModal()"><i class="fas fa-video"></i></div>
                        <div class="media-control" onclick="showReportModal()"><i class="fas fa-flag"></i></div>
                        <div class="media-control" onclick="toggleHide()"><i id="hideIcon" class="fas fa-eye"></i></div>
                    </div>
                </div>
                <div class="youtube-player"><div id="youtubeContainer"></div></div>
                <div class="now-playing" id="nowPlaying">CETCETY Radio</div>
                <div class="playlist-container" id="playlist"></div>
            </div>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div class="modal-content">
            <h3>Video Ekle</h3>
            <input type="text" id="videoUrl" placeholder="YouTube URL">
            <input type="text" id="videoTitle" placeholder="BaÅŸlÄ±k">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="addVideo()">Ekle</button>
                <button class="modal-btn secondary" onclick="closeModal('videoModal')">Ä°ptal</button>
            </div>
        </div>
    </div>

    <div id="liveModal" class="modal">
        <div class="modal-content">
            <h3>CanlÄ± YayÄ±n</h3>
            <input type="text" id="streamTitle" placeholder="YayÄ±n BaÅŸlÄ±ÄŸÄ±">
            <select id="cameraSelect">
                <option value="front">Ã–n Kamera</option>
                <option value="back">Arka Kamera</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="startLive()">BaÅŸlat</button>
                <button class="modal-btn secondary" onclick="closeModal('liveModal')">Ä°ptal</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3>Åžikayet Et</h3>
            <select id="reportReason">
                <option value="spam">Spam</option>
                <option value="harassment">Taciz</option>
                <option value="inappropriate">Uygunsuz</option>
            </select>
            <textarea id="reportDetail" placeholder="Detay" rows="3"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="sendReport()">GÃ¶nder</button>
                <button class="modal-btn secondary" onclick="closeModal('reportModal')">Ä°ptal</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // FIREBASE
        firebase.initializeApp({
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat"
        });
        const db = firebase.database();

        // GLOBAL
        let user = null;
        let currentChannel = 'genel';
        let currentPrivate = null;
        let ytPlayer = null;
        let channels = {};

        // YARDIMCI
        function $(id) { return document.getElementById(id); }

        // GÄ°RÄ°Åž
        function handleLogin() {
            const nick = $('loginNick').value.trim();
            const pass = $('loginPassword').value.trim();
            if (!nick) return alert('Nick gerekli');

            if (nick === 'mateky' && pass !== 'Sahi17407@SCM') 
                return alert('âŒ Owner ÅŸifre hatalÄ±');

            user = {
                id: Date.now(),
                name: nick,
                role: nick === 'mateky' ? 'owner' : 'user',
                avatar: nick[0].toUpperCase(),
                subs: ['genel'],
                blocks: []
            };

            if (!channels.genel) channels.genel = { name:'genel', online:[], subs:0 };
            if (!channels.genel.online.includes(user.name)) channels.genel.online.push(user.name);

            if (user.role === 'owner' && !channels.owner) {
                channels.owner = { name:'owner', online:[], subs:0, hidden:true };
                user.subs.push('owner');
            }

            saveChannels();
            localStorage.setItem('user', JSON.stringify(user));

            $('loginOverlay').classList.add('hidden');
            $('app').style.display = 'flex';
            $('avatarText').innerText = user.avatar;

            db.ref(`online/${currentChannel}/${user.id}`).set({ name:user.name });
            db.ref(`online/${currentChannel}/${user.id}`).onDisconnect().remove();

            listenMessages();
            listenOnline();
            listenPlaylist();
            listenPrivate();

            loadPanel('subs');
            updateUI();
        }

        // FIREBASE DÄ°NLEMELER
        function listenMessages() {
            db.ref(`chats/${currentChannel}`).off();
            db.ref(`chats/${currentChannel}`).on('child_added', snap => {
                const msg = snap.val();
                if (msg.sender !== user?.name) showMessage(msg);
            });
        }

        function listenOnline() {
            db.ref(`online/${currentChannel}`).on('value', snap => {
                const users = snap.val();
                const count = users ? Object.keys(users).length : 0;
                $('channelUserCount').innerText = count;
                if ($('tabOnline')?.classList.contains('active')) showOnlineTab();
            });
        }

        function listenPlaylist() {
            db.ref(`playlist/${currentChannel}`).on('value', snap => {
                channels[currentChannel].playlist = snap.val() || [];
                updatePlaylist();
            });
            db.ref(`nowplaying/${currentChannel}`).on('value', snap => {
                const video = snap.val();
                if (video && ytPlayer) {
                    ytPlayer.loadVideoById(video.id);
                    $('nowPlaying').innerText = video.title;
                }
            });
        }

        function listenPrivate() {
            if (user.role === 'owner') {
                db.ref('private').on('child_added', snap => {
                    snap.ref.on('child_added', msgSnap => {
                        const msg = msgSnap.val();
                        if (msg.from !== user.id) {
                            db.ref('chats/owner/messages').push({
                                sender: `ðŸ”’ ${msg.fromName}`,
                                text: msg.type === 'text' ? msg.text : (msg.type === 'image' ? 'ðŸ“¸ Resim' : 'ðŸŽ¥ Video')
                            });
                        }
                    });
                });
            }
        }

        // MESAJ GÃ–STER
        function showMessage(msg, me=false) {
            const div = document.createElement('div');
            div.className = `message ${me ? 'right' : ''}`;
            div.innerHTML = `<div class="message-text">${escapeHTML(msg.text)}</div>`;
            $('messages').appendChild(div);
            $('messages').scrollTop = $('messages').scrollHeight;
        }

        function escapeHTML(t) { return t.replace(/[&<>"]/g, ''); }

        // MESAJ GÃ–NDER
        function sendMessage() {
            const text = $('messageInput').value.trim();
            if (!text) return;

            const msg = {
                from: user.id,
                sender: user.name,
                text: text,
                time: Date.now()
            };

            db.ref(`chats/${currentChannel}`).push(msg);
            showMessage(msg, true);
            $('messageInput').value = '';
        }

        // KANAL DEÄžÄ°ÅžTÄ°R
        function joinChannel(ch) {
            if (!channels[ch]) return;
            if (ch === 'owner' && user.role !== 'owner') return alert('EriÅŸim yok');

            db.ref(`online/${currentChannel}/${user.id}`).remove();
            currentChannel = ch;
            db.ref(`online/${currentChannel}/${user.id}`).set({ name:user.name });

            $('currentChannelName').innerText = ch;
            $('messages').innerHTML = '';

            listenMessages();
            listenOnline();
            listenPlaylist();

            updateUI();
        }

        // ABONELÄ°K
        function toggleSubscribe() {
            const ch = channels[currentChannel];
            if (user.subs.includes(currentChannel)) {
                user.subs = user.subs.filter(s => s !== currentChannel);
                ch.subs = Math.max(0, (ch.subs||0) - 1);
                $('subscribeChannelBtn').innerText = 'Abone Ol';
            } else {
                user.subs.push(currentChannel);
                ch.subs = (ch.subs||0) + 1;
                $('subscribeChannelBtn').innerText = 'Abone Olundu';
            }
            saveChannels();
            localStorage.setItem('user', JSON.stringify(user));
            updateBadges();
        }

        // PLAYLIST
        function updatePlaylist() {
            const ch = channels[currentChannel];
            if (!ch?.playlist) return $('playlist').innerHTML = '<div>Video yok</div>';

            let html = '';
            ch.playlist.forEach((v, i) => {
                html += `<div class="playlist-item" onclick="playVideo(${i})">ðŸŽ¬ ${v.title}</div>`;
            });
            $('playlist').innerHTML = html;
        }

        function playVideo(i) {
            const ch = channels[currentChannel];
            const v = ch.playlist[i];
            db.ref(`nowplaying/${currentChannel}`).set(v);
        }

        function addVideo() {
            let url = $('videoUrl').value.trim();
            const title = $('videoTitle').value.trim() || 'Video';
            
            let id = url;
            if (url.includes('v=')) id = url.split('v=')[1]?.split('&')[0];
            else if (url.includes('youtu.be/')) id = url.split('youtu.be/')[1]?.split('?')[0];

            if (!id || id.length !== 11) return alert('GeÃ§ersiz ID');

            const ch = channels[currentChannel];
            if (!ch.playlist) ch.playlist = [];
            ch.playlist.push({ id, title, by: user.name });

            db.ref(`playlist/${currentChannel}`).set(ch.playlist);
            closeModal('videoModal');
        }

        // CANLI YAYIN
        function startLive() {
            const title = $('streamTitle').value.trim() || 'CanlÄ± YayÄ±n';
            alert(`ðŸ“¹ CanlÄ± yayÄ±n baÅŸladÄ±: ${title}`);
            closeModal('liveModal');
        }

        // ÅžÄ°KAYET
        function sendReport() {
            const reason = $('reportReason').value;
            const detail = $('reportDetail').value;
            db.ref('chats/owner/messages').push({
                sender: 'ðŸš¨ ÅžÄ°KAYET',
                text: `#${currentChannel}\nSebep: ${reason}\nDetay: ${detail || 'Yok'}`
            });
            closeModal('reportModal');
            alert('Åžikayet iletildi');
        }

        // Ã–ZEL SOHBET
        function openPrivateChat(name) {
            if (name === user.name) return;
            if (user.blocks?.includes(name)) return alert('EngellenmiÅŸ');

            currentPrivate = name;
            $('privateChatName').innerText = name;
            $('privateChatPanel').classList.add('active');

            const chatId = [user.id, name].sort().join('_');
            db.ref(`private/${chatId}`).off();
            db.ref(`private/${chatId}`).on('child_added', snap => {
                const msg = snap.val();
                showPrivateMessage(msg, msg.from === user.id);
            });
        }

        function showPrivateMessage(msg, me) {
            const div = document.createElement('div');
            div.className = `private-message ${me ? 'right' : ''}`;
            if (msg.type === 'text') {
                div.innerHTML = `<div class="private-message-text">${escapeHTML(msg.text)}</div>`;
            } else {
                div.innerHTML = `<div class="private-message-media">${msg.type === 'image' ? '<img src="'+msg.content+'" onclick="window.open(this.src)">' : '<video src="'+msg.content+'" controls></video>'}</div>`;
            }
            $('privateChatMessages').appendChild(div);
        }

        function sendPrivateMessage() {
            const text = $('privateMessageInput').value.trim();
            if (!text || !currentPrivate) return;

            const chatId = [user.id, currentPrivate].sort().join('_');
            const msg = {
                from: user.id,
                fromName: user.name,
                text: text,
                type: 'text',
                time: Date.now()
            };
            db.ref(`private/${chatId}`).push(msg);
            showPrivateMessage(msg, true);
            $('privateMessageInput').value = '';
        }

        function sendImage(input) {
            if (!input.files?.[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const chatId = [user.id, currentPrivate].sort().join('_');
                db.ref(`private/${chatId}`).push({
                    from: user.id,
                    fromName: user.name,
                    content: e.target.result,
                    type: 'image',
                    time: Date.now()
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function sendVideo(input) {
            if (!input.files?.[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                const chatId = [user.id, currentPrivate].sort().join('_');
                db.ref(`private/${chatId}`).push({
                    from: user.id,
                    fromName: user.name,
                    content: e.target.result,
                    type: 'video',
                    time: Date.now()
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function blockUser() {
            if (!currentPrivate) return;
            if (!user.blocks) user.blocks = [];
            user.blocks.push(currentPrivate);
            localStorage.setItem('user', JSON.stringify(user));
            alert(`ðŸš« ${currentPrivate} engellendi`);
            closePrivateChat();
        }

        function reportUser() {
            alert('Åžikayet iletildi');
        }

        function closePrivateChat() {
            $('privateChatPanel').classList.remove('active');
            currentPrivate = null;
        }

        // YOUTUBE
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('youtubeContainer', {
                height: '100%', width: '100%',
                videoId: channels[currentChannel]?.currentVideo || 'jfKfPfyJRdk'
            });
        };

        // PANELLER
        function loadPanel(type) {
            let html = '';
            if (type === 'subs') {
                html += '<div class="panel-header">Abonelikler</div>';
                user.subs.forEach(ch => {
                    html += `<div class="channel-item" onclick="joinChannel('${ch}')">#${ch}</div>`;
                });
            } else if (type === 'channels') {
                html += '<div class="panel-header">Kanallar</div>';
                Object.values(channels).forEach(ch => {
                    if (ch.hidden && user.role !== 'owner') return;
                    html += `<div class="channel-item" onclick="joinChannel('${ch.name}')">#${ch.name} (${ch.subs||0})</div>`;
                });
            } else if (type === 'chatlist') {
                html = `<div class="panel-tabs">
                    <div class="panel-tab active" onclick="switchTab('chats')">Sohbetler</div>
                    <div class="panel-tab" onclick="switchTab('online')">Ã‡evrimiÃ§i</div>
                </div><div id="tabContent"></div>`;
                $('leftPanel').innerHTML = html;
                showChats();
                return;
            } else if (type === 'profile') {
                html = `<div class="panel-header">Profil</div>
                    <div style="text-align:center">
                        <div style="width:80px;height:80px;background:#ff0000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:20px auto;cursor:pointer" onclick="changeAvatar()">${user.avatar}</div>
                        <h3>${user.name}</h3>
                        <p>${user.role}</p>
                        <input type="text" id="newNick" placeholder="Yeni nick" style="width:100%;padding:8px;margin:10px 0">
                        <button onclick="changeNick()">Nick DeÄŸiÅŸtir</button>
                        <input type="text" id="blockNick" placeholder="Engelle" style="width:100%;padding:8px;margin:10px 0">
                        <button onclick="blockNick()">Engelle</button>
                        ${user.blocks?.length ? '<div>Engellenenler:<br>'+user.blocks.map(b=>`${b} <i class="fas fa-times" onclick="unblock('${b}')"></i>`).join('<br>')+'</div>' : ''}
                        <button onclick="logout()" style="background:#ff0000;color:#fff;width:100%;padding:12px;margin-top:20px">Ã‡Ä±kÄ±ÅŸ</button>
                    </div>`;
            }
            $('leftPanel').innerHTML = html;
        }

        function switchTab(tab) {
            document.querySelectorAll('.panel-tab').forEach((el,i) => {
                el.classList.toggle('active', (i===0 && tab==='chats') || (i===1 && tab==='online'));
            });
            if (tab === 'chats') showChats();
            else showOnline();
        }

        function showChats() {
            const chatList = [];
            db.ref('private').once('value', snap => {
                const chats = snap.val() || {};
                Object.keys(chats).forEach(key => {
                    if (key.includes(user.id)) {
                        const other = key.split('_').find(id => id != user.id);
                        chatList.push(other);
                    }
                });
                let html = '';
                chatList.forEach(c => {
                    html += `<div class="chat-item" onclick="openPrivateChat('${c}')">ðŸ’¬ ${c}</div>`;
                });
                $('tabContent').innerHTML = html || 'Sohbet yok';
            });
        }

        function showOnline() {
            const users = channels[currentChannel]?.online || [];
            let html = '';
            users.forEach(u => {
                if (u !== user.name) html += `<div class="online-item" onclick="openPrivateChat('${u}')">ðŸŸ¢ ${u}</div>`;
            });
            $('tabContent').innerHTML = html || 'Kimse yok';
        }

        // PROFÄ°L
        function changeAvatar() {
            const em = prompt('Yeni avatar:', user.avatar);
            if (em) {
                user.avatar = em[0];
                $('avatarText').innerText = em[0];
                localStorage.setItem('user', JSON.stringify(user));
                loadPanel('profile');
            }
        }

        function changeNick() {
            const nick = $('newNick')?.value.trim();
            if (nick) {
                user.name = nick;
                user.avatar = nick[0];
                $('avatarText').innerText = nick[0];
                localStorage.setItem('user', JSON.stringify(user));
                loadPanel('profile');
            }
        }

        function blockNick() {
            const nick = $('blockNick')?.value.trim();
            if (nick) {
                if (!user.blocks) user.blocks = [];
                user.blocks.push(nick);
                localStorage.setItem('user', JSON.stringify(user));
                loadPanel('profile');
            }
        }

        function unblock(nick) {
            user.blocks = user.blocks.filter(b => b !== nick);
            localStorage.setItem('user', JSON.stringify(user));
            loadPanel('profile');
        }

        // DÄ°ÄžER
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            $('themeIcon').className = document.body.classList.contains('light-theme') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function togglePassword() {
            const p = $('loginPassword');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        function toggleHide() {
            const ch = channels[currentChannel];
            if (user.role !== 'owner' && !ch.coadmins?.includes(user.name)) 
                return alert('Yetkiniz yok');
            ch.hidden = !ch.hidden;
            saveChannels();
            $('hideIcon').className = ch.hidden ? 'fas fa-eye-slash' : 'fas fa-eye';
        }

        function showAddVideo() { $('videoModal').classList.add('active'); }
        function showLiveModal() { $('liveModal').classList.add('active'); }
        function showReportModal() { $('reportModal').classList.add('active'); }
        function closeModal(id) { $(id).classList.remove('active'); }
        function showHome() { alert('CETCETY'); }
        function openSubscriptions() { loadPanel('subs'); }
        function openChannelPanel() { loadPanel('channels'); }
        function openChatListPanel() { loadPanel('chatlist'); }
        function openCreateChannelPanel() { 
            if (user.role !== 'owner' && user.role !== 'admin') 
                return alert('Yetkiniz yok');
            const name = prompt('Kanal adÄ±:');
            if (name && !channels[name]) {
                channels[name] = { name, owner:user.name, online:[user.name], playlist:[], coadmins:[user.name] };
                saveChannels();
                alert('Kanal oluÅŸturuldu');
            }
        }
        function openProfilePanel() { loadPanel('profile'); }

        function saveChannels() { localStorage.setItem('channels', JSON.stringify(channels)); }
        function updateUI() { updateBadges(); }
        function updateBadges() { $('subscriptionBadge').innerText = user.subs.length; }

        // ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closePrivateChat();
                $('leftPanel').innerHTML = '';
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            }
        });

        // BAÅžLANGIÃ‡
        channels = JSON.parse(localStorage.getItem('channels')) || { genel:{ name:'genel', online:[], subs:0 } };
        const saved = localStorage.getItem('user');
        if (saved) {
            user = JSON.parse(saved);
            $('loginOverlay').classList.add('hidden');
            $('app').style.display = 'flex';
            $('avatarText').innerText = user.avatar;
            loadPanel('subs');
            updateUI();
        }
    </script>
</body>
</html>
