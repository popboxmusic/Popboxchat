<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>POPBOX CanlÄ± Sohbet</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <!-- Åžifre hash iÃ§in -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: #0d0d0d;
      color: #e0e0e0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #auth-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #111;
    }
    #auth-screen input, #auth-screen button {
      width: 280px;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      border: none;
    }
    #auth-screen input {
      background: #222;
      color: white;
    }
    #auth-screen button {
      background: #ff3366;
      color: white;
      cursor: pointer;
    }
    #auth-toggle {
      color: #4caf50;
      margin-top: 12px;
      cursor: pointer;
    }
    #auth-error {
      color: #ff5252;
      margin-top: 8px;
    }
    #main-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    header {
      background: #1a1a1a;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    #online-count {
      color: #4caf50;
      font-weight: 600;
    }
    #main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #video-area {
      flex: 3;
      background: black;
    }
    #video-area iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #111;
      border-left: 1px solid #222;
    }
    #mesajlar {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .mesaj {
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      max-width: 75%;
      position: relative;
    }
    .mesaj.kendi {
      background: #ff3366;
      color: white;
      margin-left: auto;
    }
    .mesaj.baska {
      background: #2a2a2a;
    }
    .mesaj img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 6px;
    }
    #gonder-alan {
      padding: 10px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      display: flex;
      gap: 8px;
    }
    #gonder-alan input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      background: #222;
      color: white;
      border: none;
    }
    #gonder-alan button {
      background: #ff3366;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    #online-listesi {
      width: 220px;
      background: #0a0a0a;
      padding: 12px;
      overflow-y: auto;
      border-left: 1px solid #222;
    }
    #online-listesi h3 {
      margin-bottom: 12px;
      color: #e91e63;
    }
    .online-kisi {
      padding: 8px 0;
      cursor: pointer;
      border-bottom: 1px solid #222;
    }
    .online-kisi:hover {
      background: #1a1a1a;
    }
    .online-kisi.blink {
      animation: blink-red 1.5s infinite alternate;
      background: rgba(255, 0, 0, 0.2);
    }
    @keyframes blink-red {
      from { opacity: 1; }
      to { opacity: 0.4; }
    }
    #ozel-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 340px;
      height: 100%;
      background: #111;
      border-left: 1px solid #444;
      transform: translateX(100%);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    #ozel-panel.acik {
      transform: translateX(0);
    }
    #ozel-header {
      padding: 12px;
      background: #1a1a1a;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #333;
    }
    #ozel-mesajlar {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    #ozel-gonder-alan {
      padding: 10px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      display: flex;
      gap: 8px;
    }
    #ozel-gonder-alan input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      background: #222;
      color: white;
      border: none;
    }
    #ozel-gonder-alan button {
      background: #ff3366;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- GiriÅŸ / KayÄ±t EkranÄ± -->
  <div id="auth-screen">
    <div class="auth-container">
      <h2 id="auth-title">GiriÅŸ Yap</h2>
      <input id="auth-nick" placeholder="KullanÄ±cÄ± adÄ±n" />
      <input id="auth-sifre" type="password" placeholder="Åžifre" />
      <button id="auth-buton">GiriÅŸ Yap</button>
      <p id="auth-degistir" style="margin-top:12px; color:#4caf50; cursor:pointer;">HesabÄ±n yok mu? KayÄ±t Ol</p>
      <div id="auth-hata" style="color:#ff5252; margin-top:12px; text-align:center;"></div>
    </div>
  </div>

  <!-- Ana Sohbet EkranÄ± -->
  <div id="chat-screen" style="display:none;">
    <header>
      <div>ðŸŽ¤ CanlÄ± Sohbet</div>
      <div style="display:flex; align-items:center; gap:16px;">
        <span id="kullanici-bilgi"></span>
        <button id="cikis-buton">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </header>

    <div id="main">
      <div id="video-area">
        <iframe src="https://www.youtube.com/embed/RN4h0sBtzlc?autoplay=1&mute=1&controls=1&playsinline=1" frameborder="0" allowfullscreen></iframe>
      </div>

      <div id="sohbet-area">
        <div id="mesajlar"></div>
        <div id="gonder-alan">
          <input id="mesaj" placeholder="Mesaj yaz..." />
          <button id="gonder-buton">GÃ¶nder</button>
        </div>
      </div>

      <div id="online-listesi">
        <h3>Online KullanÄ±cÄ±lar</h3>
      </div>
    </div>

    <!-- Ã–zel sohbet penceresi -->
    <div id="ozel-panel">
      <div id="ozel-header">
        <span id="ozel-baslik">Ã–zel sohbet</span>
        <button id="ozel-kapat">Ã—</button>
      </div>
      <div id="ozel-mesajlar"></div>
      <div id="ozel-gonder-alan">
        <input id="ozel-mesaj" placeholder="Mesaj..." />
        <button id="ozel-gonder-buton">GÃ¶nder</button>
        <button id="ozel-resim-buton">ðŸ“Ž</button>
      </div>
    </div>
  </div>

  <script>
    // ====================================================
    // FIREBASE CONFIG (SENÄ°N GERÃ‡EK DEÄžERLERÄ°N)
    // ====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
      authDomain: "popboxmusicchat.firebaseapp.com",
      databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
      projectId: "popboxmusicchat",
      storageBucket: "popboxmusicchat.appspot.com",
      messagingSenderId: "206625719024",
      appId: "1:206625719024:web:d28f478a2c96d10412f835",
      measurementId: "G-SB1K22FLEX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let currentRole = "kullanici";

    // Yetki seviyeleri
    const yetkiSeviyeleri = {
      admin: 3,
      coadmin: 2,
      operator: 1,
      kullanici: 0
    };

    // GiriÅŸ / KayÄ±t toggle
    const authTitle = document.getElementById("auth-title");
    const authButon = document.getElementById("auth-buton");
    const authDegistir = document.getElementById("auth-degistir");
    let girisMi = true;

    authDegistir.onclick = () => {
      girisMi = !girisMi;
      authTitle.textContent = girisMi ? "GiriÅŸ Yap" : "KayÄ±t Ol";
      authButon.textContent = girisMi ? "GiriÅŸ Yap" : "KayÄ±t Ol";
      authDegistir.textContent = girisMi ? "HesabÄ±n yok mu? KayÄ±t Ol" : "Zaten hesabÄ±n var mÄ±? GiriÅŸ Yap";
    };

    // GiriÅŸ / KayÄ±t iÅŸlemi
    authButon.onclick = () => {
      const nick = document.getElementById("auth-nick").value.trim();
      const sifre = document.getElementById("auth-sifre").value.trim();
      const hata = document.getElementById("auth-hata");

      hata.textContent = "";

      if (!nick || !sifre) {
        hata.textContent = "TÃ¼m alanlarÄ± doldurun!";
        return;
      }

      if (sifre.length < 6) {
        hata.textContent = "Åžifre en az 6 karakter olmalÄ±!";
        return;
      }

      const sifreHash = CryptoJS.SHA256(sifre).toString();

      db.ref("kullanicilar").once("value", snapshot => {
        let nickVar = false;
        let mevcutUid = null;

        snapshot.forEach(child => {
          const veri = child.val();
          if (veri.nick === nick) {
            nickVar = true;
            mevcutUid = child.key;
            return true;
          }
        });

        if (girisMi) {
          // GiriÅŸ
          if (!nickVar) {
            hata.textContent = "Bu nick kayÄ±tlÄ± deÄŸil.";
            return;
          }

          db.ref("kullanicilar/" + mevcutUid).once("value", snap => {
            const veri = snap.val();
            if (veri && veri.sifre === sifreHash) {
              currentUser = nick;
              currentRole = veri.role || "kullanici";

              db.ref("kullanicilar/" + mevcutUid).update({
                online: true,
                sonGorulme: Date.now()
              });

              document.getElementById("auth-screen").style.display = "none";
              document.getElementById("chat-screen").style.display = "flex";
              document.getElementById("kullanici").textContent = `HoÅŸ geldin, ${nick}`;
            } else {
              hata.textContent = "Åžifre yanlÄ±ÅŸ.";
            }
          });
        } else {
          // KayÄ±t
          if (nickVar) {
            hata.textContent = "Bu nick zaten alÄ±nmÄ±ÅŸ.";
            return;
          }

          const yeniUid = db.ref("kullanicilar").push().key;
          db.ref("kullanicilar/" + yeniUid).set({
            nick: nick,
            sifre: sifreHash,
            online: true,
            sonGorulme: Date.now(),
            role: (nick === "popbox") ? "admin" : "kullanici"
          }).then(() => {
            currentUser = nick;
            currentRole = (nick === "popbox") ? "admin" : "kullanici";

            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("kullanici").textContent = `HoÅŸ geldin, ${nick}`;
          });
        }
      });
    };

    // Ã‡Ä±kÄ±ÅŸ yap
    document.getElementById("cikis-buton").onclick = () => {
      if (currentUser) {
        db.ref("kullanicilar").once("value", snapshot => {
          snapshot.forEach(child => {
            if (child.val().nick === currentUser) {
              child.ref.update({ online: false });
            }
          });
        });
      }
      location.reload();
    };

    // Online kullanÄ±cÄ±lar
    db.ref("kullanicilar").on("value", snapshot => {
      const liste = document.getElementById("online-listesi");
      liste.innerHTML = "<h3>Online KullanÄ±cÄ±lar</h3>";
      let sayi = 0;

      snapshot.forEach(child => {
        const veri = child.val();
        if (veri && veri.online) {
          sayi++;
          const div = document.createElement("div");
          div.className = "online-nick";
          div.id = `kisi-${child.key}`;
          div.textContent = veri.nick;
          if (veri.role === "admin") div.innerHTML += '<span class="admin-badge">Admin</span>';
          div.onclick = () => ozelSohbetAc(child.key, veri.nick);
          liste.appendChild(div);
        }
      });

      document.getElementById("online-count").textContent = `Online: ${sayi} kiÅŸi`;
    });

    // Genel sohbet mesajlarÄ±
    db.ref("mesajlar").limitToLast(100).on("child_added", snapshot => {
      const veri = snapshot.val();
      const div = document.createElement("div");
      div.className = "mesaj " + (veri.nick === currentUser ? "kendi" : "baska");
      div.innerHTML = `<strong>${veri.nick}:</strong> ${convertEmojis(veri.mesaj || "")}`;
      if (veri.nick === currentUser) {
        const silButon = document.createElement("button");
        silButon.textContent = "Sil";
        silButon.style.marginLeft = "8px";
        silButon.onclick = () => snapshot.ref.remove();
        div.appendChild(silButon);
      }
      document.getElementById("mesajlar").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    });

    // Mesaj gÃ¶nderme
    document.getElementById("gonder-buton").onclick = () => {
      const input = document.getElementById("mesaj");
      const metin = input.value.trim();
      if (!metin || !currentUser) return;

      db.ref("mesajlar").push({
        nick: currentUser,
        mesaj: metin,
        zaman: Date.now()
      });
      input.value = "";
    };

    // Ã–zel sohbet aÃ§ma
    function ozelSohbetAc(uid, nick) {
      currentPrivateToUid = uid;
      currentPrivateToNick = nick;
      document.getElementById("ozel-baslik").textContent = `Ã–zel: ${nick}`;
      document.getElementById("ozel-panel").style.display = "flex";
      document.getElementById("ozel-mesajlar").innerHTML = "";

      const sohbetId = [currentUid, uid].sort().join("_");

      db.ref(`ozel/${sohbetId}`).on("child_added", snapshot => {
        const veri = snapshot.val();
        const div = document.createElement("div");
        div.className = "mesaj " + (veri.nick === currentUser ? "kendi" : "baska");
        div.innerHTML = `<strong>${veri.nick}:</strong> ${convertEmojis(veri.mesaj || "")}`;
        if (veri.nick === currentUser) {
          const silButon = document.createElement("button");
          silButon.textContent = "Sil";
          silButon.style.marginLeft = "8px";
          silButon.onclick = () => snapshot.ref.remove();
          div.appendChild(silButon);
        }
        document.getElementById("ozel-mesajlar").appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });

        if (veri.nick !== currentUser) {
          const kisiDiv = document.getElementById(`kisi-${uid}`);
          if (kisiDiv) {
            kisiDiv.classList.add("blink");
            setTimeout(() => kisiDiv.classList.remove("blink"), 8000);
            playNotificationSound();
          }
        }
      });
    }

    // Ã–zel sohbet kapat
    document.getElementById("ozel-kapat").onclick = () => {
      document.getElementById("ozel-panel").style.display = "none";
    };

    // Ã–zel mesaj gÃ¶nderme
    document.getElementById("ozel-gonder-buton").onclick = () => {
      const input = document.getElementById("ozel-mesaj");
      const metin = input.value.trim();
      if (!metin || !currentPrivateToUid) return;

      const sohbetId = [currentUid, currentPrivateToUid].sort().join("_");

      db.ref(`ozel/${sohbetId}`).push({
        nick: currentUser,
        mesaj: metin,
        zaman: Date.now()
      });
      input.value = "";
    };

    // Resim gÃ¶nderme (Base64)
    document.getElementById("ozel-resim-buton").onclick = () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = e => {
        const dosya = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          const sohbetId = [currentUid, currentPrivateToUid].sort().join("_");
          db.ref(`ozel/${sohbetId}`).push({
            nick: currentUser,
            mesaj: reader.result,
            zaman: Date.now()
          });
        };
        reader.readAsDataURL(dosya);
      };
      input.click();
    };

    // Bildirim sesi
    function playNotificationSound() {
      const ses = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
      ses.play().catch(() => {});
    }
  </script>
</body>
</html>
