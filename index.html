<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Popbox IRC Chat</title>

<style>
body{margin:0;background:#0e0e0e;color:#fff;font-family:Arial}
#video{position:fixed;top:0;left:0;width:100%;height:220px}
#video iframe{width:100%;height:100%}
#chat{position:absolute;top:220px;bottom:70px;left:0;right:200px;overflow:auto;padding:10px}
#users{position:fixed;top:220px;right:0;width:200px;bottom:70px;background:#111;overflow:auto;padding:10px}
.user{padding:6px;background:#1c1c1c;margin-bottom:5px;border-radius:6px;cursor:pointer}
.msg{background:#1c1c1c;margin-bottom:8px;padding:8px;border-radius:8px}
#bar{position:fixed;bottom:0;left:0;right:0;height:70px;display:flex;background:#111}
#msg{flex:1;font-size:16px;border:none;padding:10px}
button{width:80px;border:none;background:#ff3c00;color:#fff;font-weight:bold}
.role{font-size:12px;color:#ff3c00;margin-left:6px}
#pmBox{position:fixed;bottom:80px;right:220px;width:300px;height:300px;background:#000;border:1px solid #333;display:none;flex-direction:column}
#pmChat{flex:1;overflow:auto;padding:5px}
#pmInput{display:flex}
#pmInput input{flex:1;padding:6px;border:none}
</style>
</head>
<body>

<div id="video">
<iframe src="https://www.youtube.com/embed/shD--eyF8ug?autoplay=1&mute=1" allow="autoplay"></iframe>
</div>

<div id="chat"></div>
<div id="users"></div>

<div id="pmBox">
  <div id="pmChat"></div>
  <div id="pmInput">
    <input id="pmMsg" placeholder="Özel mesaj...">
    <button onclick="sendPM()">Gönder</button>
  </div>
</div>

<div id="bar">
<input id="msg" placeholder="Mesaj yaz veya /komut gir"/>
<button onclick="send()">Gönder</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let nick = prompt("Nick gir");
const chat = document.getElementById("chat");
const usersDiv = document.getElementById("users");
const pmBox = document.getElementById("pmBox");
const pmChat = document.getElementById("pmChat");
let activePM = null;

const peer = new Peer("room-popbox");
const connections = {};
const onlineUsers = new Set();

peer.on("connection", conn=>{
  setupConn(conn);
});

function connectAll(){
  const conn = peer.connect("room-popbox");
  setupConn(conn);
}

function setupConn(conn){
  conn.on("open", ()=>{
    connections[conn.peer]=conn;
    sendSys({type:"join", nick});
  });

  conn.on("data", data=>{
    handleData(data);
  });
}

function broadcast(data){
  Object.values(connections).forEach(c=>c.send(data));
}

function handleData(d){
  if(d.type==="msg"){
    addMsg(d.nick, d.text);
  }
  if(d.type==="join"){
    onlineUsers.add(d.nick);
    renderUsers();
  }
  if(d.type==="pm"){
    if(d.to===nick){
      pmBox.style.display="flex";
      pmChat.innerHTML+=`<div><b>${d.nick}:</b> ${d.text}</div>`;
    }
  }
}

function send(){
  const input=document.getElementById("msg");
  const t=input.value.trim();
  if(!t) return;
  addMsg(nick,t);
  broadcast({type:"msg",nick,text:t});
  input.value="";
}

function addMsg(n,t){
  const d=document.createElement("div");
  d.className="msg";
  d.innerHTML=`<b>${n}:</b> ${t}`;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function renderUsers(){
  usersDiv.innerHTML="";
  onlineUsers.forEach(u=>{
    const d=document.createElement("div");
    d.className="user";
    d.innerText=u;
    d.onclick=()=>openPM(u);
    usersDiv.appendChild(d);
  });
}

function openPM(u){
  activePM=u;
  pmBox.style.display="flex";
}

function sendPM(){
  const t=document.getElementById("pmMsg").value;
  pmChat.innerHTML+=`<div><b>Sen:</b> ${t}</div>`;
  broadcast({type:"pm",nick,to:activePM,text:t});
  document.getElementById("pmMsg").value="";
}

document.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});

connectAll();
onlineUsers.add(nick);
renderUsers();
</script>

</body>
</html>
