<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Popbox Music Chat</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    :root {
      --bg: #0f0f0f;
      --text: #f1f1f1;
      --input: #272727;
      --primary: #ff0000;
      --system: #0f0;
      --border: #333;
      --owner: #ff4081;
    }
    body {
      margin:0; background:var(--bg); color:var(--text); font-family:Arial,sans-serif; height:100vh; overflow:hidden;
      display:flex; flex-direction:column;
    }
    header {
      height:50px; background:#000; display:flex; align-items:center; justify-content:space-between; padding:0 15px; border-bottom:1px solid var(--border);
    }
    #messages { flex:1; overflow-y:auto; padding:10px; }
    .message { margin:8px 0; padding:10px; border-radius:8px; background:#222; }
    .message.own { background:#065fd4; margin-left:auto; margin-right:10px; }
    .message.system { background:#333; color:var(--system); text-align:center; }
    #input-area { padding:10px; background:#111; display:flex; gap:8px; }
    #message-input { flex:1; padding:12px; border:none; border-radius:20px; background:var(--input); color:white; }
    button { padding:10px 16px; background:var(--primary); color:white; border:none; border-radius:20px; cursor:pointer; }
    #login-screen { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:15px; z-index:1000; }
    input, textarea { padding:12px; width:90%; max-width:350px; border-radius:6px; background:#222; color:white; border:none; }
    .hidden { display:none !important; }
    .owner-panel { position:fixed; inset:0; background:rgba(0,0,0,0.95); color:white; padding:20px; overflow-y:auto; z-index:999; }
    .story-bar { height:70px; overflow-x:auto; display:flex; gap:12px; padding:10px; background:rgba(0,0,0,0.7); }
    .story-item { width:55px; height:55px; border-radius:50%; background:#ff6b6b; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; cursor:pointer; background-size:cover; background-position:center; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:flex; justify-content:center; align-items:center; }
    .modal-content { background:#222; padding:25px; border-radius:12px; width:90%; max-width:420px; max-height:90vh; overflow-y:auto; }
    .night-mode { --bg:#0d1117; --text:#c9d1d9; --input:#161b22; }
    .night-mode .message { background:#161b22; }
    .night-mode header { background:#010409; }
  </style>
</head>
<body>

<div id="login-screen">
  <h2 style="color:#ff0000">Popbox Music Chat</h2>
  <input id="nick" placeholder="Nick">
  <input id="password" type="password" placeholder="Åžifre (sadece MateKy iÃ§in)">
  <button onclick="girisYap()">GiriÅŸ</button>
  <p id="hata" style="color:#ff4444"></p>
</div>

<div id="main" class="hidden">
  <header>
    <div>Popbox Music Chat</div>
    <div>Online: <span id="online-count">0</span></div>
    <button onclick="document.body.classList.toggle('night-mode')">ðŸŒ™</button>
    <button onclick="document.getElementById('owner-panel').classList.toggle('hidden')">Owner</button>
    <button onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ</button>
  </header>

  <div id="story-bar" class="story-bar"></div>

  <div id="messages">
    <div class="message system">HoÅŸ geldin!</div>
  </div>

  <div id="input-area">
    <input id="message-input" placeholder="Mesaj yaz...">
    <button onclick="mesajGonder()">GÃ¶nder</button>
    <input type="file" id="dosyaSec" accept="image/*,video/*" style="display:none" onchange="dosyaYukle()">
    <button onclick="document.getElementById('dosyaSec').click()">ðŸ“Ž</button>
  </div>
</div>

<!-- Owner Panel -->
<div id="owner-panel" class="owner-panel hidden">
  <h2>Owner Panel (MateKy)</h2>
  <button onclick="document.getElementById('owner-panel').classList.add('hidden')">Kapat</button>
  <hr>
  <textarea id="sistem-mesaj" placeholder="Sistem mesajÄ±..."></textarea>
  <button onclick="sistemMesajGonder()">GÃ¶nder</button>
  <hr>
  <button onclick="openStoryModal()">Yeni Story</button>
  <hr>
  <button onclick="sikayetleriGoster()">Åžikayetler</button>
  <div id="sikayetListesi"></div>
  <hr>
  <input id="komutAd" placeholder="Komut adÄ± (Ã¶r: selam)">
  <input id="komutYanit" placeholder="YanÄ±t (Ã¶r: Merhaba!)">
  <button onclick="komutEkle()">Komut Ekle</button>
</div>

<!-- Story OluÅŸturma Modal -->
<div id="storyModal" class="modal hidden">
  <div class="modal-content">
    <h3>Yeni Story</h3>
    <textarea id="storyText" placeholder="Metin..."></textarea>
    <input type="file" id="storyImage" accept="image/*">
    <button onclick="createStory()">YayÄ±nla</button>
    <button onclick="closeStoryModal()">Kapat</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
  authDomain: "popboxmusicchat.firebaseapp.com",
  databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
  projectId: "popboxmusicchat",
  storageBucket: "popboxmusicchat.firebasestorage.app",
  messagingSenderId: "206625719024",
  appId: "1:206625719024:web:d28f478a2c96d10412f835"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

const messagesRef = db.ref('messages');
const onlineRef = db.ref('online');
const storiesRef = db.ref('stories');
const reportsRef = db.ref('reports');
const commandsRef = db.ref('commands');

let user = null;
const OWNER = "mateky";
const SIFRE = "sahil7407@SCM";

function girisYap() {
  const nick = document.getElementById('nick').value.trim();
  const pass = document.getElementById('password').value;

  if (!nick) return document.getElementById('hata').textContent = "Nick gir";

  if (nick.toLowerCase() === OWNER && pass === SIFRE) {
    user = {nick: "MateKy", isOwner: true};
  } else {
    user = {nick, isOwner: false};
  }

  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');

  onlineRef.child(nick.toLowerCase()).set(true);
  onlineRef.child(nick.toLowerCase()).onDisconnect().remove();

  messagesRef.on('child_added', snap => {
    const msg = snap.val();
    const div = document.createElement('div');
    div.className = 'message' + (msg.system ? ' system' : '');
    div.textContent = msg.text;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView();
  });

  onlineRef.on('value', snap => {
    document.getElementById('online-count').textContent = snap.numChildren();
  });

  storiesRef.on('value', updateStories);
}

function mesajGonder() {
  const input = document.getElementById('message-input');
  let text = input.value.trim();
  if (!text) return;

  if (text.startsWith('/')) {
    handleCommand(text);
  } else {
    messagesRef.push({text, timestamp: Date.now()});
  }
  input.value = '';
}

function handleCommand(text) {
  const parts = text.substring(1).split(' ');
  const cmd = parts[0].toLowerCase();
  const arg = parts.slice(1).join(' ');

  if (cmd === 'komut' && user.isOwner) {
    const [name, ...response] = arg.split(' ');
    if (name && response.length) {
      commandsRef.child(name).set(response.join(' '));
      mesajEkle("Sistem", `Komut eklendi: /${name}`);
    }
  } else if (cmd === 'komutlar') {
    commandsRef.once('value', snap => {
      let list = 'Komutlar:\n';
      snap.forEach(c => list += `/${c.key}\n`);
      mesajEkle("Sistem", list || "Komut yok");
    });
  } else {
    commandsRef.child(cmd).once('value', snap => {
      const response = snap.val();
      if (response) mesajEkle("Komut", response);
    });
  }
}

function sistemMesajGonder() {
  const text = document.getElementById('sistem-mesaj').value.trim();
  if (text) {
    messagesRef.push({text: "[SÄ°STEM] " + text, system: true});
    document.getElementById('sistem-mesaj').value = '';
  }
}

function openStoryModal() {
  document.getElementById('storyModal').classList.remove('hidden');
}

function closeStoryModal() {
  document.getElementById('storyModal').classList.add('hidden');
}

function createStory() {
  const text = document.getElementById('storyText').value.trim();
  const file = document.getElementById('storyImage').files[0];

  if (!text && !file) return alert("Metin veya resim ekle");

  const data = {
    sender: user.nick,
    text,
    timestamp: Date.now(),
    expires: Date.now() + 86400000
  };

  if (file) {
    const ref = storage.ref('stories/' + Date.now() + '_' + file.name);
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
      data.image = url;
      storiesRef.push(data);
      closeStoryModal();
    }));
  } else {
    storiesRef.push(data);
    closeStoryModal();
  }
}

function updateStories(snapshot) {
  const bar = document.getElementById('story-bar');
  bar.innerHTML = '';
  const stories = snapshot.val() || {};

  Object.entries(stories).forEach(([id, s]) => {
    if (s.expires > Date.now()) {
      const item = document.createElement('div');
      item.className = 'story-item';
      item.style.backgroundImage = s.image ? `url(${s.image})` : 'none';
      item.innerHTML = s.image ? '' : s.sender[0];
      item.onclick = () => showStory(s);
      bar.appendChild(item);
    }
  });
}

function showStory(s) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>${s.sender}</h3>
      ${s.image ? `<img src="${s.image}" style="max-width:100%; border-radius:8px;">` : ''}
      <p>${s.text || ''}</p>
      <button onclick="sikayetEt('${s.sender}', '${s.text || 'resim'}')">Åžikayet Et</button>
      <button onclick="this.parentElement.parentElement.remove()">Kapat</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function sikayetEt(sender, content) {
  const reason = prompt("Åžikayet sebebibibi:");
  if (reason) {
    reportsRef.push({sender: user.nick, reported: sender, content, reason, time: Date.now()});
    alert("Åžikayet edildi");
  }
}

function sikayetleriGoster() {
  reportsRef.once('value', snap => {
    let html = '<h3>Åžikayetler</h3>';
    snap.forEach(r => {
      const v = r.val();
      html += `<p><strong>${v.reported}</strong> - ${v.reason}<br><small>${v.sender} â€¢ ${new Date(v.time).toLocaleString()}</small></p>`;
    });
    document.getElementById('sikayetListesi').innerHTML = html || '<p>HenÃ¼z ÅŸikayet yok</p>';
  });
}

function dosyaYukle() {
  const file = document.getElementById('dosyaSec').files[0];
  if (!file) return;

  const ref = storage.ref('media/' + Date.now() + '_' + file.name);
  ref.put(file).then(() => ref.getDownloadURL().then(url => {
    messagesRef.push({text: url, timestamp: Date.now()});
  }));
}

function cikisYap() {
  onlineRef.child(user.nick.toLowerCase()).remove();
  location.reload();
}
</script>
</body>
</html>
