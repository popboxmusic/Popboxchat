<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Popbox ‚Ä¢ Yetkili Medya Paneli</title>
    
    <!-- FONTS & ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0f0f0f;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ========== SCROLLBAR - TEMA UYUMLU ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f3f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        ::-webkit-scrollbar-corner {
            background: #0f0f0f;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #3f3f3f #1a1a1a;
        }

        /* ========== SOL MEN√ú - 80px ========== */
        .sidebar {
            width: 80px;
            background: #0a0a0a;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            gap: 24px;
            flex-shrink: 0;
            z-index: 10;
        }

        .menu-item {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            position: relative;
        }

        .menu-item:hover {
            background: #272727;
            color: #fff;
        }

        .menu-item.active {
            color: #fff;
            background: #3f3f3f;
        }

        .user-avatar {
            margin-top: auto;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #3f3f3f;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========== KULLANICI PANELƒ∞ ========== */
        .users-panel {
            width: 280px;
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .panel-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .online-tabs {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .tab {
            flex: 1;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            color: #aaa;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .tab.active {
            background: #272727;
            border-color: #3f3f3f;
            color: #fff;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .user-item:hover {
            background: #1a1a1a;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ba640;
            flex-shrink: 0;
        }

        .private-message-badge {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            font-weight: 600;
        }

        /* ========== CHAT PANELƒ∞ ========== */
        .chat-panel {
            flex: 1;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.right {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 13px;
            color: #fff;
            cursor: pointer;
        }

        .message-time {
            font-size: 11px;
            color: #aaa;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
            color: #fff;
            word-break: break-word;
            padding: 0;
            background: none;
            border: none;
        }

        .system-message {
            align-self: center;
            color: #aaa;
            font-size: 12px;
            padding: 8px 16px;
            background: #1a1a1a;
            border-radius: 20px;
            margin: 8px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-input-container {
            padding: 20px 24px;
            background: #0a0a0a;
            border-top: 1px solid #2a2a2a;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 28px;
            padding: 8px 8px 8px 20px;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            padding: 12px 0;
            resize: none;
            max-height: 120px;
            outline: none;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #272727;
            border: 1px solid #3f3f3f;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #3f3f3f;
        }

        /* ========== MEDYA PANELƒ∞ - YETKƒ∞ KONTROLL√ú ========== */
        .media-panel {
            width: 500px;
            background: #0a0a0a;
            border-left: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .media-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .media-tabs {
            display: flex;
            gap: 8px;
        }

        .media-tab {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
            position: relative;
        }

        .media-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .media-tab.active {
            background: #ff0000;
            color: #fff;
        }

        .media-tab.spotify.active {
            background: #1db954;
        }

        .media-tab.live {
            background: #1a1a1a;
            color: #ff6b6b;
        }

        .media-tab.live.active {
            background: #ff4444;
            color: #fff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        .media-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #272727;
        }

        .control-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .admin-badge {
            font-size: 10px;
            color: #ff0000;
            margin-left: 4px;
            font-weight: normal;
        }

        /* ========== YOUTUBE PLAYER ========== */
        .youtube-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-bottom: 1px solid #2a2a2a;
            display: block;
            position: relative;
        }

        .youtube-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .no-permission-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            gap: 16px;
            z-index: 100;
        }

        .no-permission-overlay i {
            font-size: 48px;
            color: #ff4444;
            margin-bottom: 16px;
        }

        .no-permission-overlay span {
            font-size: 18px;
            font-weight: 600;
        }

        .no-permission-overlay small {
            color: #aaa;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
        }

        .user-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: center;
            gap: 12px;
            z-index: 150;
        }

        .user-control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 2px solid #fff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .user-control-btn:hover {
            background: #ff0000;
            border-color: #ff0000;
        }

        /* ========== SPOTIFY PLAYER ========== */
        .spotify-player {
            width: 100%;
            height: 352px;
            background: #121212;
            border-bottom: 1px solid #2a2a2a;
            display: none;
            position: relative;
        }

        .spotify-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ========== CANLI YAYIN PLAYER ========== */
        .live-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-bottom: 1px solid #2a2a2a;
            display: none;
            position: relative;
        }

        .live-player video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .live-controls {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 16px;
            z-index: 100;
        }

        .live-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 2px solid #fff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
        }

        .live-btn:hover {
            background: #ff4444;
            border-color: #ff4444;
        }

        .live-btn.stop {
            background: #ff4444;
            border-color: #ff4444;
        }

        .live-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .live-status {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(255, 68, 68, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .live-status i {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* ========== PLAYLIST ========== */
        .playlist {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #2a2a2a;
        }

        .playlist-title {
            font-weight: 600;
            font-size: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 6px;
            border: 1px solid transparent;
        }

        .playlist-item:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }

        .playlist-item.active {
            background: #1a1a1a;
            border-left: 4px solid #ff0000;
        }

        .playlist-item.spotify.active {
            border-left-color: #1db954;
        }

        .playlist-item.live.active {
            border-left-color: #ff4444;
        }

        .playlist-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .playlist-thumb {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 22px;
            flex-shrink: 0;
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-title-text {
            font-weight: 500;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-meta {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #272727;
            color: #ccc;
        }

        .role-badge.owner {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
        }

        .role-badge.admin {
            background: rgba(255,0,0,0.2);
            color: #ff6b6b;
        }

        .role-badge.coadmin {
            background: rgba(100,149,237,0.2);
            color: #6495ed;
        }

        .role-badge.operator {
            background: rgba(255,165,0,0.2);
            color: #ffa500;
        }

        .playlist-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .playlist-item:hover .playlist-actions {
            opacity: 1;
        }

        .playlist-action {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #272727;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .playlist-action:hover {
            background: #3f3f3f;
        }

        .playlist-action.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .no-permission {
            padding: 32px;
            text-align: center;
            color: #aaa;
            background: #1a1a1a;
            border-radius: 8px;
            margin: 20px;
        }

        .no-permission i {
            font-size: 32px;
            margin-bottom: 12px;
            color: #555;
        }

        /* ========== MODAL ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 500px;
            max-width: 90%;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #272727;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 16px;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #ff0000;
        }

        .spotify .modal-input:focus {
            border-color: #1db954;
        }

        .modal-btn {
            width: 100%;
            padding: 16px;
            background: #ff0000;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.spotify {
            background: #1db954;
        }

        .modal-btn.live {
            background: #ff4444;
        }

        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .modal-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .complaint-reason {
            margin-bottom: 16px;
        }

        .complaint-reason label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
            font-size: 14px;
        }

        .complaint-reason select, .complaint-reason textarea {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        /* ========== LOGIN PANEL ========== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f0f0f;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .login-box {
            width: 420px;
            max-width: 90%;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 40px;
        }

        .login-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
        }

        .login-logo i {
            font-size: 56px;
            color: #ff0000;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            color: #fff;
        }

        .login-subtitle {
            text-align: center;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .password-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 16px;
        }

        .login-input {
            width: 100%;
            padding: 16px;
            padding-right: 50px;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            cursor: pointer;
            font-size: 18px;
        }

        .password-toggle:hover {
            color: #fff;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: #ff0000;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .login-error {
            background: rgba(255,0,0,0.1);
            border: 1px solid #ff0000;
            border-radius: 8px;
            padding: 12px;
            color: #ff6b6b;
            font-size: 13px;
            display: none;
            margin-bottom: 16px;
        }

        .hidden {
            display: none !important;
        }

        .active-panel-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid #3f3f3f;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-logo">
                <i class="fab fa-youtube"></i>
            </div>
            <h2 class="login-title">Popbox</h2>
            <p class="login-subtitle">Yetkili medya kontrol paneli</p>
            
            <input type="text" id="nickname" class="login-input" placeholder="Kullanƒ±cƒ± adƒ±" autocomplete="off">
            
            <div class="password-wrapper">
                <input type="password" id="password" class="login-input" placeholder="≈ûifre" autocomplete="off">
                <i class="fas fa-eye password-toggle" id="passwordToggle" onclick="togglePasswordVisibility()"></i>
            </div>
            
            <div id="loginError" class="login-error"></div>
            
            <button id="loginBtn" class="login-btn" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Giri≈ü Yap
            </button>
            
            <p style="color: #666; font-size: 12px; text-align: center;">
                üëë MateKy (owner) ‚Ä¢ ‚ö° popbox (admin) ‚Ä¢ ‚ö° popboxmusic (admin) ‚Ä¢ üîß coadmin ‚Ä¢ üõ°Ô∏è operator
            </p>
        </div>
    </div>

    <!-- ANA UYGULAMA -->
    <div id="app" class="app hidden">
        <!-- SOL MEN√ú -->
        <div class="sidebar">
            <div class="menu-item active" onclick="showUsersPanel(); closeAllModals();">
                <i class="fas fa-users"></i>
            </div>
            <div class="menu-item" onclick="toggleNotificationPanel(); closeAllModals();">
                <i class="fas fa-bell"></i>
            </div>
            
            <div class="user-avatar" id="userAvatar" onclick="showProfileMenu(); closeAllModalsExcept('profileModal');">
                <span id="avatarText"></span>
                <img id="avatarImg" src="" style="display:none;">
            </div>
        </div>

        <!-- KULLANICI PANELƒ∞ -->
        <div class="users-panel">
            <div class="panel-header">
                <h3><i class="fas fa-users"></i> Kullanƒ±cƒ±lar</h3>
                <div class="online-tabs">
                    <div class="tab active" onclick="switchUserTab('online')" id="onlineTab">√áevrimi√ßi (0)</div>
                    <div class="tab" onclick="switchUserTab('chatting')" id="chattingTab">Sohbette (0)</div>
                </div>
            </div>
            <div class="user-list" id="userList"></div>
        </div>

        <!-- CHAT PANELƒ∞ -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-hashtag"></i>
                    <span id="currentChannel">genel</span>
                    <span id="onlineCount" style="color:#aaa; font-size:13px; margin-left:8px;"></span>
                </div>
                <div id="privateChatControls" style="display: none; gap: 8px;">
                    <button class="control-btn" onclick="blockUser24h()" title="24 saat engelle">
                        <i class="fas fa-ban"></i>
                    </button>
                    <button class="control-btn" onclick="reportUser()" title="≈ûikayet et">
                        <i class="fas fa-flag"></i>
                    </button>
                    <button class="control-btn" onclick="closePrivateChat()" title="Pencereyi kapat">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="message-input-container">
                <div class="input-wrapper">
                    <textarea id="messageInput" class="message-input" placeholder="Mesaj yazƒ±n..." rows="1" oninput="autoResize(this)"></textarea>
                    <div class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEDYA PANELƒ∞ - YETKƒ∞ KONTROLL√ú -->
        <div class="media-panel">
            <div class="media-header">
                <div class="media-tabs">
                    <div class="media-tab active" onclick="switchMediaTab('youtube')" id="youtubeTab">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <div class="media-tab spotify" onclick="switchMediaTab('spotify')" id="spotifyTab">
                        <i class="fab fa-spotify"></i>
                    </div>
                    <div class="media-tab live" onclick="switchMediaTab('live')" id="liveTab">
                        <i class="fas fa-video"></i>
                    </div>
                </div>
                <div class="media-controls">
                    <div class="control-btn" id="addMediaBtn" onclick="openAddMediaModal()" title="Ekle">
                        <i class="fas fa-plus"></i>
                    </div>
                    <span class="admin-badge">(Sadece Admin Eri≈üimi)</span>
                    <div class="control-btn" id="clearPlaylistBtn" onclick="clearPlaylist()" title="Temizle">
                        <i class="fas fa-trash"></i>
                    </div>
                </div>
            </div>
            
            <!-- YOUTUBE PLAYER - YETKƒ∞ KONTROLL√ú -->
            <div id="youtubePlayer" class="youtube-player">
                <iframe id="youtubeIframe" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&mute=0&controls=0&modestbranding=1&rel=0&enablejsapi=1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                
                <!-- Normal kullanƒ±cƒ± kontrolleri - SADECE YETKƒ∞Sƒ∞ZLER G√ñR√úR -->
                <div id="userYouTubeControls" class="user-controls" style="display: none;">
                    <div class="user-control-btn" onclick="toggleMute()" title="Ses a√ß/kapat">
                        <i class="fas fa-volume-up" id="muteIcon"></i>
                    </div>
                    <div class="user-control-btn" onclick="togglePlayPause()" title="Oynat/durdur">
                        <i class="fas fa-play" id="playPauseIcon"></i>
                    </div>
                </div>
            </div>
            
            <!-- SPOTIFY PLAYER - YETKƒ∞ KONTROLL√ú -->
            <div id="spotifyPlayer" class="spotify-player">
                <iframe id="spotifyIframe" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture" loading="lazy"></iframe>
                <!-- Yetkisiz eri≈üim overlay'i -->
                <div id="spotifyNoPermission" class="no-permission-overlay" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <span>Yetkiniz Yok</span>
                    <small>Bu medya alanƒ±nƒ± kontrol etme yetkiniz bulunmamaktadƒ±r.</small>
                </div>
            </div>
            
            <!-- CANLI YAYIN PLAYER - YETKƒ∞ KONTROLL√ú -->
            <div id="livePlayer" class="live-player">
                <video id="liveVideo" autoplay playsinline></video>
                <div class="live-status">
                    <i class="fas fa-circle"></i> CANLI YAYIN
                </div>
                <div class="live-controls">
                    <div class="live-btn" id="switchCameraBtn" onclick="switchCamera()" title="Kamera deƒüi≈ütir (Admin)">
                        <i class="fas fa-camera-retro"></i>
                    </div>
                    <div class="live-btn stop" id="stopLiveBtn" onclick="stopLiveStream()" title="Yayƒ±nƒ± durdur (Admin)">
                        <i class="fas fa-stop"></i>
                    </div>
                </div>
                <!-- Yetkisiz eri≈üim overlay'i -->
                <div id="liveNoPermission" class="no-permission-overlay" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <span>Yetkiniz Yok</span>
                    <small>Canlƒ± yayƒ±n alanƒ±nƒ± kontrol etme yetkiniz bulunmamaktadƒ±r.</small>
                </div>
            </div>
            
            <!-- PLAYLIST -->
            <div class="playlist" id="playlist"></div>
        </div>
    </div>

    <!-- MEDYA EKLEME MODALI -->
    <div id="addMediaModal" class="modal">
        <div class="modal-content" id="modalContent">
            <div class="modal-header">
                <h3 id="modalTitle">YouTube Video Ekle</h3>
                <button class="modal-close" onclick="closeAddMediaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="text" id="mediaUrl" class="modal-input" placeholder="Video/Playlist URL'si veya ID'si">
            <input type="text" id="mediaTitle" class="modal-input" placeholder="Ba≈ülƒ±k">
            
            <button id="addMediaConfirmBtn" class="modal-btn" onclick="addToPlaylist()">
                <i class="fas fa-plus"></i> Playlist'e Ekle
            </button>
        </div>
    </div>

    <!-- CANLI YAYIN BA≈ûLATMA MODALI -->
    <div id="liveStreamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-video" style="color: #ff4444;"></i> Canlƒ± Yayƒ±n Ba≈ülat</h3>
                <button class="modal-close" onclick="closeLiveStreamModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="text" id="liveTitle" class="modal-input" placeholder="Yayƒ±n ba≈ülƒ±ƒüƒ±">
            <textarea id="liveDescription" class="modal-input" placeholder="Yayƒ±n a√ßƒ±klamasƒ±" rows="3" style="resize: none;"></textarea>
            
            <button class="modal-btn live" onclick="startLiveStream()">
                <i class="fas fa-video"></i> Yayƒ±nƒ± Ba≈ülat
            </button>
        </div>
    </div>

    <!-- PROFƒ∞L MODALI -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profil</h3>
                <button class="modal-close" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: #0f0f0f; border-radius: 12px;">
                    <div class="user-avatar" style="width: 70px; height: 70px;">
                        <span id="profileAvatarText" style="font-size: 28px;"></span>
                    </div>
                    <div>
                        <div id="profileName" style="font-weight: 600; font-size: 18px; margin-bottom: 6px;"></div>
                        <div id="profileRole" style="color: #aaa; font-size: 14px;"></div>
                    </div>
                </div>
                
                <button class="modal-btn" onclick="uploadAvatar()" style="background: #272727;">
                    <i class="fas fa-camera"></i> Fotoƒüraf Y√ºkle
                </button>
                <button class="modal-btn" onclick="logout()" style="background: #272727;">
                    <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap
                </button>
            </div>
        </div>
    </div>

    <!-- ≈ûƒ∞KAYET MODALI -->
    <div id="complaintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flag" style="color: #ff4444;"></i> Kullanƒ±cƒ± ≈ûikayet Et</h3>
                <button class="modal-close" onclick="closeComplaintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="complaintUserInfo" style="margin-bottom: 16px; padding: 12px; background: #0f0f0f; border-radius: 8px;">
                <span id="complaintUsername" style="font-weight: 600;"></span> kullanƒ±cƒ±sƒ±nƒ± ≈üikayet ediyorsunuz.
            </div>
            
            <div class="complaint-reason">
                <label>≈ûikayet Sebebi</label>
                <select id="complaintReason" class="modal-input">
                    <option value="spam">Spam / Reklam</option>
                    <option value="harassment">Taciz / Hakaret</option>
                    <option value="inappropriate">Uygunsuz ƒ∞√ßerik</option>
                    <option value="other">Diƒüer</option>
                </select>
            </div>
            
            <div class="complaint-reason">
                <label>A√ßƒ±klama (ƒ∞steƒüe baƒülƒ±)</label>
                <textarea id="complaintDescription" class="modal-input" rows="3" placeholder="Detaylƒ± a√ßƒ±klama..."></textarea>
            </div>
            
            <button class="modal-btn" onclick="submitComplaint()" style="background: #ff4444;">
                <i class="fas fa-paper-plane"></i> ≈ûikayeti G√∂nder
            </button>
        </div>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">

    <!-- AKTƒ∞F PANEL G√ñSTERGESƒ∞ -->
    <div id="activePanelIndicator" class="active-panel-indicator">Panel: Genel Sohbet</div>

    <script>
        // ========== FIREBASE KONFƒ∞G ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let database;
        let currentUser = null;
        let isOwner = false;
        let isAdmin = false;
        let isCoAdmin = false;
        let isOperator = false;
        let isFirebaseConnected = false;
        let currentMediaTab = 'youtube';
        
        // YOUTUBE PLAYLIST
        let youtubePlaylist = [
            { id: 'jfKfPfyJRdk', title: 'Popbox Radio ‚Ä¢ 24/7 Canlƒ± M√ºzik', addedBy: 'MateKy', role: 'owner', timestamp: Date.now() }
        ];
        
        // SPOTIFY PLAYLIST
        let spotifyPlaylist = [
            { id: '37i9dQZF1DXcBWIGoYBM5M', title: 'Popbox Spotify ‚Ä¢ G√ºn√ºn Hitleri', addedBy: 'MateKy', role: 'owner', type: 'playlist', timestamp: Date.now() }
        ];
        
        // CANLI YAYIN PLAYLIST
        let liveStreams = [];
        
        let onlineUsers = [];
        let privateChats = {};
        let activePrivateChat = null;
        let currentTab = 'online';
        let unreadPrivateMessages = {};
        let blockedUsers = {};
        
        // Canlƒ± yayƒ±n deƒüi≈ükenleri
        let mediaStream = null;
        let currentFacingMode = 'user';
        
        // Yetkili kullanƒ±cƒ±lar ve kanallarƒ±
        let authorizedChannels = {
            owner: ['*'],
            admin: ['*'],
            coadmin: []
        };

        let activeModal = null;

        // YouTube oynatma durumu
        let isMuted = false;
        let isPlaying = true;

        // ========== FIREBASE BA≈ûLAT ==========
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                console.log('‚úÖ Firebase ba≈ülatƒ±ldƒ±!');
                
                database.ref('.info/connected').on('value', (snap) => {
                    isFirebaseConnected = snap.val() === true;
                    console.log(isFirebaseConnected ? '‚úÖ Firebase baƒülandƒ±!' : '‚ùå Firebase baƒülantƒ±sƒ± kesildi!');
                });
                
                // AKTƒ∞F YAYINI Dƒ∞NLE - T√úM KULLANICILAR BURADAN G√úNCELLENƒ∞R
                database.ref('activeStream').on('value', (snapshot) => {
                    const streamData = snapshot.val();
                    if (streamData && streamData.type) {
                        // Medya tipini g√ºncelle
                        switchMediaTabForAll(streamData.type);
                        
                        // Medya i√ßeriƒüini g√ºncelle
                        if (streamData.type === 'youtube' && streamData.videoId) {
                            playVideoForAll(streamData.videoId, streamData.title);
                        } else if (streamData.type === 'spotify' && streamData.spotifyId) {
                            playSpotifyForAll(streamData.spotifyId, streamData.title);
                        } else if (streamData.type === 'live' && streamData.streamId) {
                            // Canlƒ± yayƒ±n zaten ba≈ülatƒ±lmƒ±≈ü
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Firebase hatasƒ±:', error);
            }
        }

        // ========== Gƒ∞Rƒ∞≈û ==========
        async function handleLogin() {
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            
            if (!nickname) {
                showError('Kullanƒ±cƒ± adƒ± gerekli!');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Baƒülanƒ±yor...';
            loginBtn.disabled = true;
            
            setTimeout(() => performLogin(nickname, password), 500);
        }

        function performLogin(nickname, password) {
            const normalizedNick = nickname.toLowerCase();
            
            isOwner = false;
            isAdmin = false;
            isCoAdmin = false;
            isOperator = false;
            
            if (normalizedNick === 'mateky') {
                if (password !== 'Sahi17407@SCM') {
                    showError('Hatalƒ± owner ≈üifresi!');
                    resetLoginButton();
                    return;
                }
                isOwner = true;
                isAdmin = true;
                currentUser = { name: 'MateKy', role: 'owner', roleLevel: 5 };
            }
            else if (normalizedNick === 'popbox' || normalizedNick === 'popboxmusic') {
                currentUser = { name: nickname, role: 'admin', roleLevel: 4 };
                isAdmin = true;
            }
            else if (normalizedNick === 'coadmin' || normalizedNick.startsWith('co-')) {
                currentUser = { name: nickname, role: 'coadmin', roleLevel: 3 };
                isCoAdmin = true;
                authorizedChannels.coadmin.push('genel');
            }
            else if (normalizedNick === 'operator' || normalizedNick.startsWith('op-')) {
                currentUser = { name: nickname, role: 'operator', roleLevel: 2 };
                isOperator = true;
            }
            else {
                currentUser = { name: nickname, role: 'user', roleLevel: 1 };
            }
            
            if (database) {
                const usersRef = database.ref('onlineUsers');
                
                window.addEventListener('beforeunload', function() {
                    database.ref(`onlineUsers/${currentUser.name}`).remove();
                });
                
                usersRef.child(currentUser.name).set({
                    name: currentUser.name,
                    role: currentUser.role,
                    roleLevel: currentUser.roleLevel,
                    lastSeen: Date.now(),
                    isOnline: true
                });
                usersRef.child(currentUser.name).onDisconnect().remove();
            }
            
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            document.getElementById('avatarText').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('profileAvatarText').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileRole').textContent = currentUser.role;
            
            updateMediaPermissions();
            updateMediaAccess();
            
            addSystemMessage(`üéâ ${currentUser.name} (${currentUser.role}) sohbete katƒ±ldƒ±!`);
            
            startFirebaseListeners();
            
            // Giri≈ü yapƒ±ldƒ±ƒüƒ±nda mevcut aktif yayƒ±nƒ± kontrol et
            database.ref('activeStream').once('value', (snapshot) => {
                const streamData = snapshot.val();
                if (streamData) {
                    switchMediaTabForAll(streamData.type);
                    if (streamData.type === 'youtube' && streamData.videoId) {
                        playVideoForAll(streamData.videoId, streamData.title);
                    } else if (streamData.type === 'spotify' && streamData.spotifyId) {
                        playSpotifyForAll(streamData.spotifyId, streamData.title);
                    }
                } else {
                    // Hi√ß aktif yayƒ±n yoksa varsayƒ±lan YouTube'u ba≈ülat
                    if (youtubePlaylist.length > 0) {
                        playVideo(0);
                    }
                }
            });
        }

        // ========== YETKƒ∞ KONTROL√ú ==========
        function canManageMedia() {
            return isOwner || isAdmin || isCoAdmin;
        }

        function canDeleteMedia() {
            return isOwner || isAdmin || isCoAdmin;
        }

        function canStartLiveStream() {
            return isOwner || isAdmin || isCoAdmin || isOperator;
        }

        function updateMediaPermissions() {
            const addBtn = document.getElementById('addMediaBtn');
            const clearBtn = document.getElementById('clearPlaylistBtn');
            
            if (canManageMedia()) {
                addBtn.classList.remove('disabled');
                clearBtn.classList.remove('disabled');
                addBtn.style.opacity = '1';
                clearBtn.style.opacity = '1';
                addBtn.style.pointerEvents = 'auto';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                addBtn.classList.add('disabled');
                clearBtn.classList.add('disabled');
                addBtn.style.opacity = '0.4';
                clearBtn.style.opacity = '0.4';
                addBtn.style.pointerEvents = 'none';
                clearBtn.style.pointerEvents = 'none';
            }
        }

        function updateMediaAccess() {
            const hasAccess = canManageMedia();
            const youtubeNoPerm = document.getElementById('youtubeNoPermission');
            const spotifyNoPerm = document.getElementById('spotifyNoPermission');
            const liveNoPerm = document.getElementById('liveNoPermission');
            const userControls = document.getElementById('userYouTubeControls');
            
            // YouTube sekmesi - Yetkisiz kullanƒ±cƒ±lar sadece ses/play butonlarƒ±nƒ± g√∂r√ºr
            if (!hasAccess) {
                // YouTube'da sadece kullanƒ±cƒ± kontrollerini g√∂ster
                userControls.style.display = 'flex';
                
                // Spotify ve Live i√ßin yetkisiz overlay'lerini g√∂ster
                spotifyNoPerm.style.display = 'flex';
                document.getElementById('spotifyPlayer').querySelector('iframe').style.display = 'none';
                
                liveNoPerm.style.display = 'flex';
                document.querySelector('#livePlayer video').style.display = 'none';
                document.querySelector('.live-status').style.display = 'none';
                document.querySelector('.live-controls').style.display = 'none';
            } else {
                // Yetkili kullanƒ±cƒ± - t√ºm kontroller a√ßƒ±k
                userControls.style.display = 'none'; // Admin i√ßin kullanƒ±cƒ± kontrollerini gizle
                
                spotifyNoPerm.style.display = 'none';
                document.getElementById('spotifyPlayer').querySelector('iframe').style.display = 'block';
                
                liveNoPerm.style.display = 'none';
                document.querySelector('#livePlayer video').style.display = 'block';
                document.querySelector('.live-status').style.display = 'flex';
                document.querySelector('.live-controls').style.display = 'flex';
            }
            
            // Playlist √∂ƒüelerini yetkiye g√∂re ayarla
            document.querySelectorAll('.playlist-item').forEach(item => {
                if (!hasAccess) {
                    item.classList.add('disabled');
                } else {
                    item.classList.remove('disabled');
                }
            });
            
            // Medya tab'larƒ±nƒ± yetkiye g√∂re ayarla
            const youtubeTab = document.getElementById('youtubeTab');
            const spotifyTab = document.getElementById('spotifyTab');
            const liveTab = document.getElementById('liveTab');
            
            if (!hasAccess) {
                youtubeTab.classList.remove('disabled'); // YouTube herkese a√ßƒ±k
                spotifyTab.classList.add('disabled');
                liveTab.classList.add('disabled');
            } else {
                youtubeTab.classList.remove('disabled');
                spotifyTab.classList.remove('disabled');
                liveTab.classList.remove('disabled');
            }
        }

        // ========== YOUTUBE KONTROLLERƒ∞ (Normal Kullanƒ±cƒ±) ==========
        function toggleMute() {
            const iframe = document.getElementById('youtubeIframe');
            isMuted = !isMuted;
            const muteIcon = document.getElementById('muteIcon');
            
            if (isMuted) {
                iframe.src = iframe.src.replace('mute=0', 'mute=1');
                if (!iframe.src.includes('mute=1')) {
                    iframe.src += '&mute=1';
                }
                muteIcon.className = 'fas fa-volume-mute';
            } else {
                iframe.src = iframe.src.replace('mute=1', 'mute=0');
                if (!iframe.src.includes('mute=0')) {
                    iframe.src += '&mute=0';
                }
                muteIcon.className = 'fas fa-volume-up';
            }
        }

        function togglePlayPause() {
            const iframe = document.getElementById('youtubeIframe');
            isPlaying = !isPlaying;
            const playPauseIcon = document.getElementById('playPauseIcon');
            
            if (isPlaying) {
                iframe.src = iframe.src.replace('autoplay=0', 'autoplay=1');
                if (!iframe.src.includes('autoplay=1')) {
                    iframe.src += '&autoplay=1';
                }
                playPauseIcon.className = 'fas fa-pause';
            } else {
                iframe.src = iframe.src.replace('autoplay=1', 'autoplay=0');
                if (!iframe.src.includes('autoplay=0')) {
                    iframe.src += '&autoplay=0';
                }
                playPauseIcon.className = 'fas fa-play';
            }
        }

        // ========== T√úM KULLANICILAR ƒ∞√áƒ∞N MEDYA KONTROLLERƒ∞ ==========
        function switchMediaTabForAll(tab) {
            if (!database) return;
            
            // UI'ƒ± g√ºncelle
            const youtubePlayer = document.getElementById('youtubePlayer');
            const spotifyPlayer = document.getElementById('spotifyPlayer');
            const livePlayer = document.getElementById('livePlayer');
            const youtubeTab = document.getElementById('youtubeTab');
            const spotifyTab = document.getElementById('spotifyTab');
            const liveTab = document.getElementById('liveTab');
            
            // Aktif sekmeyi g√ºncelle
            youtubeTab.classList.remove('active');
            spotifyTab.classList.remove('active');
            liveTab.classList.remove('active');
            
            youtubePlayer.style.display = 'none';
            spotifyPlayer.style.display = 'none';
            livePlayer.style.display = 'none';
            
            if (tab === 'youtube') {
                youtubeTab.classList.add('active');
                youtubePlayer.style.display = 'block';
                currentMediaTab = 'youtube';
                
                // Yetkisiz kullanƒ±cƒ± kontrollerini ayarla
                if (!canManageMedia()) {
                    document.getElementById('userYouTubeControls').style.display = 'flex';
                }
                
                if (canManageMedia()) {
                    renderPlaylist();
                }
            } else if (tab === 'spotify') {
                spotifyTab.classList.add('active');
                spotifyPlayer.style.display = 'block';
                currentMediaTab = 'spotify';
                
                if (canManageMedia()) {
                    renderSpotifyPlaylist();
                }
            } else if (tab === 'live') {
                liveTab.classList.add('active');
                livePlayer.style.display = 'block';
                currentMediaTab = 'live';
                
                if (canManageMedia()) {
                    renderLivePlaylist();
                }
            }
            
            // Yetki durumuna g√∂re eri≈üim kontrollerini g√ºncelle
            updateMediaAccess();
        }

        function playVideoForAll(videoId, title = 'Video') {
            const iframe = document.getElementById('youtubeIframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=0&modestbranding=1&rel=0&enablejsapi=1`;
        }

        function playSpotifyForAll(spotifyId, title = 'Spotify') {
            const iframe = document.getElementById('spotifyIframe');
            
            let embedUrl = '';
            if (spotifyId.includes('playlist') || spotifyId.length === 22) {
                embedUrl = `https://open.spotify.com/embed/playlist/${spotifyId}?utm_source=generator&autoplay=1`;
            } else if (spotifyId.includes('track')) {
                embedUrl = `https://open.spotify.com/embed/track/${spotifyId}?utm_source=generator&autoplay=1`;
            } else if (spotifyId.includes('album')) {
                embedUrl = `https://open.spotify.com/embed/album/${spotifyId}?utm_source=generator`;
            } else {
                embedUrl = `https://open.spotify.com/embed/${spotifyId}?utm_source=generator&autoplay=1`;
            }
            
            iframe.src = embedUrl;
        }

        // ========== YETKƒ∞Lƒ∞ MEDYA KONTROLLERƒ∞ (T√ºm kullanƒ±cƒ±lara yansƒ±r) ==========
        function switchMediaTab(tab) {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Bu medya alanƒ±nƒ± kontrol etme yetkiniz yok!');
                return;
            }
            
            // Firebase'e kaydet - T√úM KULLANICILAR bundan etkilenecek
            database.ref('activeStream').set({
                type: tab,
                timestamp: Date.now(),
                startedBy: currentUser.name
            });
            
            // Sistem mesajƒ±
            if (tab === 'youtube') {
                addSystemMessage(`üé¨ ${currentUser.name} YouTube medyasƒ±nƒ± a√ßtƒ±.`);
            } else if (tab === 'spotify') {
                addSystemMessage(`üéµ ${currentUser.name} Spotify medyasƒ±nƒ± a√ßtƒ±.`);
            } else if (tab === 'live') {
                addSystemMessage(`üìπ ${currentUser.name} Canlƒ± yayƒ±n moduna ge√ßti.`);
                openLiveStreamModal();
            }
            
            // UI'ƒ± g√ºncelle (Firebase listener zaten g√ºncelleyecek ama anlƒ±k olsun)
            switchMediaTabForAll(tab);
        }

        function playVideo(index, videoId = null) {
            if (!canManageMedia()) {
                return;
            }
            
            if (!youtubePlaylist[index] && !videoId) return;
            
            const video = videoId ? { id: videoId, title: 'Video' } : youtubePlaylist[index];
            
            // √ñnce Spotify ve Live'ƒ± durdur
            stopAllMedia();
            
            // Firebase'e kaydet - T√úM KULLANICILAR izleyecek
            database.ref('activeStream').set({
                type: 'youtube',
                videoId: video.id,
                title: video.title || 'YouTube Video',
                timestamp: Date.now(),
                startedBy: currentUser.name
            });
            
            // Medya tipini de g√ºncelle
            switchMediaTabForAll('youtube');
            
            addSystemMessage(`üé¨ YouTube: ${video.title || 'Video'} (${currentUser.name} tarafƒ±ndan oynatƒ±lƒ±yor)`);
        }

        function playSpotify(index, spotifyId = null) {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Bu medyayƒ± kontrol etme yetkiniz yok!');
                return;
            }
            
            if (!spotifyPlaylist[index] && !spotifyId) return;
            
            const item = spotifyId ? { id: spotifyId, title: 'Spotify', type: 'playlist' } : spotifyPlaylist[index];
            
            // √ñnce YouTube ve Live'ƒ± durdur
            stopAllMedia();
            
            // Firebase'e kaydet - T√úM KULLANICILAR izleyecek
            database.ref('activeStream').set({
                type: 'spotify',
                spotifyId: item.id,
                title: item.title || 'Spotify M√ºzik',
                timestamp: Date.now(),
                startedBy: currentUser.name
            });
            
            // Medya tipini de g√ºncelle
            switchMediaTabForAll('spotify');
            
            addSystemMessage(`üéµ Spotify: ${item.title || 'M√ºzik'} (${currentUser.name} tarafƒ±ndan oynatƒ±lƒ±yor)`);
        }

        async function startLiveStream() {
            if (!canStartLiveStream()) {
                addSystemMessage('‚õî Canlƒ± yayƒ±n ba≈ülatma yetkiniz yok!');
                closeLiveStreamModal();
                return;
            }
            
            const title = document.getElementById('liveTitle').value.trim() || `${currentUser.name} Canlƒ± Yayƒ±nƒ±`;
            
            try {
                // √ñnce diƒüer medyalarƒ± durdur
                stopAllMedia();
                
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode }, 
                    audio: true 
                });
                
                const videoElement = document.getElementById('liveVideo');
                videoElement.srcObject = mediaStream;
                
                const liveStream = {
                    id: `live_${Date.now()}`,
                    title: title,
                    addedBy: currentUser.name,
                    role: currentUser.role,
                    timestamp: Date.now(),
                    isActive: true
                };
                
                liveStreams.push(liveStream);
                renderLivePlaylist();
                
                // Firebase'e kaydet - T√úM KULLANICILAR izleyecek
                database.ref('activeStream').set({
                    type: 'live',
                    streamId: liveStream.id,
                    title: title,
                    timestamp: Date.now(),
                    startedBy: currentUser.name
                });
                
                // Medya tipini de g√ºncelle
                switchMediaTabForAll('live');
                
                addSystemMessage(`üìπ Canlƒ± yayƒ±n ba≈ülatƒ±ldƒ±: ${title} (${currentUser.name})`);
                closeLiveStreamModal();
                
            } catch (error) {
                console.error('Kamera hatasƒ±:', error);
                addSystemMessage('‚ùå Kamera eri≈üimi saƒülanamadƒ±!');
            }
        }

        function stopLiveStream() {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Canlƒ± yayƒ±nƒ± durdurma yetkiniz yok!');
                return;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            const videoElement = document.getElementById('liveVideo');
            videoElement.srcObject = null;
            
            if (liveStreams.length > 0) {
                liveStreams[liveStreams.length - 1].isActive = false;
            }
            
            // Firebase'deki aktif yayƒ±nƒ± temizle
            database.ref('activeStream').remove();
            
            addSystemMessage('üìπ Canlƒ± yayƒ±n sonlandƒ±rƒ±ldƒ±');
            
            // Varsayƒ±lan olarak YouTube'a d√∂n
            if (youtubePlaylist.length > 0) {
                playVideo(0);
            }
        }

        function switchCamera() {
            if (!mediaStream || !canManageMedia()) return;
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            mediaStream.getTracks().forEach(track => track.stop());
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: currentFacingMode }, 
                audio: true 
            }).then(newStream => {
                mediaStream = newStream;
                const videoElement = document.getElementById('liveVideo');
                videoElement.srcObject = newStream;
                
                addSystemMessage(`üì∏ Kamera deƒüi≈ütirildi: ${currentFacingMode === 'user' ? '√ñn' : 'Arka'} kamera`);
            }).catch(error => {
                console.error('Kamera deƒüi≈ütirme hatasƒ±:', error);
            });
        }

        function stopAllMedia() {
            // YouTube'u durdur (autoplay'i kaldƒ±r)
            const youtubeIframe = document.getElementById('youtubeIframe');
            youtubeIframe.src = youtubeIframe.src.replace('autoplay=1', 'autoplay=0');
            
            // Spotify'ƒ± durdur
            const spotifyIframe = document.getElementById('spotifyIframe');
            spotifyIframe.src = spotifyIframe.src.replace('autoplay=1', 'autoplay=0');
            
            // Canlƒ± yayƒ±nƒ± durdur (admin deƒüilse yapma)
            if (canManageMedia() && mediaStream) {
                // Sadece yetkili kullanƒ±cƒ± durdurabilir
            }
        }

        // ========== PLAYLIST'E EKLE ==========
        function addToPlaylist() {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Sadece Owner, Admin ve yetkili Co-Admin medya ekleyebilir!');
                closeAddMediaModal();
                return;
            }
            
            const url = document.getElementById('mediaUrl').value.trim();
            const title = document.getElementById('mediaTitle').value.trim();
            
            if (!url) {
                alert('L√ºtfen URL girin!');
                return;
            }
            
            if (currentMediaTab === 'youtube') {
                let videoId = '';
                if (url.includes('youtube.com/watch?v=')) {
                    videoId = url.split('v=')[1]?.split('&')[0];
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1]?.split('?')[0];
                } else if (url.includes('youtube.com/embed/')) {
                    videoId = url.split('embed/')[1]?.split('?')[0];
                } else {
                    videoId = url;
                }
                
                if (videoId) {
                    youtubePlaylist.push({
                        id: videoId,
                        title: title || `Video ${youtubePlaylist.length + 1}`,
                        addedBy: currentUser.name,
                        role: currentUser.role,
                        timestamp: Date.now()
                    });
                    renderPlaylist();
                    
                    if (youtubePlaylist.length === 1) {
                        playVideo(0);
                    }
                    
                    addSystemMessage(`‚úÖ YouTube eklendi: ${title || videoId}`);
                    closeAddMediaModal();
                }
            } else if (currentMediaTab === 'spotify') {
                let spotifyId = url;
                let type = 'playlist';
                
                if (url.includes('open.spotify.com/playlist/')) {
                    spotifyId = url.split('playlist/')[1]?.split('?')[0];
                    type = 'playlist';
                } else if (url.includes('open.spotify.com/track/')) {
                    spotifyId = url.split('track/')[1]?.split('?')[0];
                    type = 'track';
                } else if (url.includes('open.spotify.com/album/')) {
                    spotifyId = url.split('album/')[1]?.split('?')[0];
                    type = 'album';
                }
                
                if (spotifyId) {
                    spotifyPlaylist.push({
                        id: spotifyId,
                        title: title || `Spotify ${spotifyPlaylist.length + 1}`,
                        type: type,
                        addedBy: currentUser.name,
                        role: currentUser.role,
                        timestamp: Date.now()
                    });
                    renderSpotifyPlaylist();
                    
                    if (spotifyPlaylist.length === 1) {
                        playSpotify(0);
                    }
                    
                    addSystemMessage(`‚úÖ Spotify eklendi: ${title || spotifyId}`);
                    closeAddMediaModal();
                }
            }
            
            document.getElementById('mediaUrl').value = '';
            document.getElementById('mediaTitle').value = '';
        }

        // ========== PLAYLIST G√ñSTERME ==========
        function renderPlaylist() {
            const container = document.getElementById('playlist');
            const hasAccess = canManageMedia();
            
            if (currentMediaTab !== 'youtube') return;
            
            if (youtubePlaylist.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Playlist bo≈ü</div>';
                return;
            }
            
            let html = `
                <div class="playlist-header">
                    <span class="playlist-title"><i class="fab fa-youtube"></i> YouTube Playlist</span>
                    <span style="color:#aaa; font-size:12px;">${youtubePlaylist.length} video</span>
                </div>
            `;
            
            youtubePlaylist.forEach((item, index) => {
                const isActive = document.getElementById('youtubeIframe')?.src?.includes(item.id) || false;
                const canDelete = isOwner || isAdmin || (isCoAdmin && item.addedBy === currentUser?.name);
                
                html += `
                    <div class="playlist-item ${isActive ? 'active' : ''} ${!hasAccess ? 'disabled' : ''}" ${hasAccess ? `onclick="playVideo(${index})"` : ''}>
                        <div class="playlist-thumb">
                            <i class="fab fa-youtube" style="color:${isActive ? '#ff0000' : '#aaa'};"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title-text">${item.title}</div>
                            <div class="playlist-meta">
                                <span>${item.addedBy || 'MateKy'}</span>
                                <span class="role-badge ${item.role || 'owner'}">${item.role || 'owner'}</span>
                            </div>
                        </div>
                        ${canDelete && hasAccess ? `
                            <div class="playlist-actions">
                                <div class="playlist-action" onclick="event.stopPropagation(); playVideo(${index})">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="playlist-action" onclick="event.stopPropagation(); removeFromPlaylist(${index})">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderSpotifyPlaylist() {
            const container = document.getElementById('playlist');
            const hasAccess = canManageMedia();
            
            if (currentMediaTab !== 'spotify') return;
            
            if (spotifyPlaylist.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Spotify playlist bo≈ü</div>';
                return;
            }
            
            let html = `
                <div class="playlist-header">
                    <span class="playlist-title"><i class="fab fa-spotify" style="color:#1db954;"></i> Spotify Playlist</span>
                    <span style="color:#aaa; font-size:12px;">${spotifyPlaylist.length} √∂ƒüe</span>
                </div>
            `;
            
            spotifyPlaylist.forEach((item, index) => {
                const isActive = document.getElementById('spotifyIframe')?.src?.includes(item.id) || false;
                const canDelete = isOwner || isAdmin || (isCoAdmin && item.addedBy === currentUser?.name);
                
                let icon = 'fa-music';
                if (item.type === 'playlist') icon = 'fa-list';
                if (item.type === 'track') icon = 'fa-music';
                if (item.type === 'album') icon = 'fa-album';
                
                html += `
                    <div class="playlist-item spotify ${isActive ? 'active' : ''} ${!hasAccess ? 'disabled' : ''}" ${hasAccess ? `onclick="playSpotify(${index})"` : ''}>
                        <div class="playlist-thumb">
                            <i class="fab fa-spotify" style="color:${isActive ? '#1db954' : '#aaa'};"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title-text">${item.title}</div>
                            <div class="playlist-meta">
                                <span>${item.addedBy || 'MateKy'}</span>
                                <span class="role-badge ${item.role || 'owner'}">${item.role || 'owner'}</span>
                            </div>
                        </div>
                        ${canDelete && hasAccess ? `
                            <div class="playlist-actions">
                                <div class="playlist-action" onclick="event.stopPropagation(); playSpotify(${index})">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="playlist-action" onclick="event.stopPropagation(); removeFromSpotifyPlaylist(${index})">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderLivePlaylist() {
            const container = document.getElementById('playlist');
            const hasAccess = canManageMedia();
            
            if (currentMediaTab !== 'live') return;
            
            if (liveStreams.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Aktif canlƒ± yayƒ±n yok</div>';
                return;
            }
            
            let html = `
                <div class="playlist-header">
                    <span class="playlist-title"><i class="fas fa-video" style="color:#ff4444;"></i> Canlƒ± Yayƒ±nlar</span>
                    <span style="color:#aaa; font-size:12px;">${liveStreams.length} yayƒ±n</span>
                </div>
            `;
            
            liveStreams.forEach((item, index) => {
                const isActive = item.isActive;
                const canDelete = isOwner || isAdmin || (isCoAdmin && item.addedBy === currentUser?.name);
                
                html += `
                    <div class="playlist-item live ${isActive ? 'active' : ''} ${!hasAccess ? 'disabled' : ''}">
                        <div class="playlist-thumb">
                            <i class="fas fa-video" style="color:${isActive ? '#ff4444' : '#aaa'};"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title-text">${item.title}</div>
                            <div class="playlist-meta">
                                <span>${item.addedBy || 'MateKy'}</span>
                                <span class="role-badge ${item.role || 'owner'}">${item.role || 'owner'}</span>
                                ${isActive ? '<span style="color:#ff4444;"><i class="fas fa-circle"></i> CANLI</span>' : ''}
                            </div>
                        </div>
                        ${canDelete && hasAccess ? `
                            <div class="playlist-actions">
                                <div class="playlist-action" onclick="event.stopPropagation(); stopLiveStream()">
                                    <i class="fas fa-stop"></i>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== PLAYLIST'TEN KALDIR ==========
        function removeFromPlaylist(index) {
            if (!canDeleteMedia() && youtubePlaylist[index]?.addedBy !== currentUser?.name) {
                addSystemMessage('‚õî Bu videoyu silme yetkiniz yok!');
                return;
            }
            
            const removed = youtubePlaylist[index];
            youtubePlaylist.splice(index, 1);
            renderPlaylist();
            
            if (youtubePlaylist.length > 0) {
                playVideo(0);
            }
            
            addSystemMessage(`üóëÔ∏è YouTube silindi: ${removed.title}`);
        }

        function removeFromSpotifyPlaylist(index) {
            if (!canDeleteMedia() && spotifyPlaylist[index]?.addedBy !== currentUser?.name) {
                addSystemMessage('‚õî Bu √∂ƒüeyi silme yetkiniz yok!');
                return;
            }
            
            const removed = spotifyPlaylist[index];
            spotifyPlaylist.splice(index, 1);
            renderSpotifyPlaylist();
            
            if (spotifyPlaylist.length > 0) {
                playSpotify(0);
            }
            
            addSystemMessage(`üóëÔ∏è Spotify silindi: ${removed.title}`);
        }

        // ========== PLAYLIST TEMƒ∞ZLE ==========
        function clearPlaylist() {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Sadece Owner, Admin ve yetkili Co-Admin playlist temizleyebilir!');
                return;
            }
            
            if (currentMediaTab === 'youtube') {
                if (confirm('YouTube playlistini temizlemek istediƒüinize emin misiniz?')) {
                    youtubePlaylist = [];
                    renderPlaylist();
                    addSystemMessage('üóëÔ∏è YouTube playlist temizlendi');
                }
            } else if (currentMediaTab === 'spotify') {
                if (confirm('Spotify playlistini temizlemek istediƒüinize emin misiniz?')) {
                    spotifyPlaylist = [];
                    renderSpotifyPlaylist();
                    addSystemMessage('üóëÔ∏è Spotify playlist temizlendi');
                }
            }
        }

        // ========== FIREBASE Lƒ∞STENER'LAR ==========
        function startFirebaseListeners() {
            if (!database) return;
            
            database.ref('onlineUsers').on('value', (snapshot) => {
                updateOnlineUsers(snapshot.val());
            });
            
            database.ref('messages').limitToLast(100).on('value', (snapshot) => {
                updateMessages(snapshot.val());
            });
            
            // √ñzel mesajlarƒ± dinle
            if (currentUser) {
                database.ref(`privateMessages/${currentUser.name}`).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    handlePrivateMessage(message);
                    snapshot.ref.remove();
                });
            }
        }

        // ========== ONLINE KULLANICILAR ==========
        function updateOnlineUsers(usersData) {
            if (!usersData) {
                document.getElementById('onlineTab').textContent = '√áevrimi√ßi (0)';
                document.getElementById('chattingTab').textContent = 'Sohbette (0)';
                return;
            }
            
            const now = Date.now();
            onlineUsers = [];
            let onlineCount = 0;
            
            Object.entries(usersData).forEach(([username, data]) => {
                if (!data) return;
                
                if (now - (data.lastSeen || 0) < 60000) {
                    onlineCount++;
                    onlineUsers.push(data);
                } else {
                    database.ref(`onlineUsers/${username}`).remove();
                }
            });
            
            document.getElementById('onlineTab').textContent = `√áevrimi√ßi (${onlineCount})`;
            renderUserList();
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            const isOnlineTab = currentTab === 'online';
            
            let filteredUsers = onlineUsers.filter(user => user.name !== currentUser?.name);
            
            // Engellenen kullanƒ±cƒ±larƒ± filtrele
            filteredUsers = filteredUsers.filter(user => {
                const blocked = blockedUsers[user.name];
                if (blocked) {
                    if (Date.now() - blocked.timestamp < 24 * 60 * 60 * 1000) {
                        return false;
                    } else {
                        delete blockedUsers[user.name];
                    }
                }
                return true;
            });
            
            if (!isOnlineTab) {
                filteredUsers = filteredUsers.filter(user => privateChats[user.name] && privateChats[user.name].length > 0);
            }
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `<div style="color:#aaa; text-align:center; padding:32px;">${isOnlineTab ? 'Kimse online deƒüil' : 'Aktif sohbet yok'}</div>`;
                return;
            }
            
            let html = '';
            filteredUsers.forEach(user => {
                let roleIcon = '';
                if (user.role === 'owner') roleIcon = 'üëë ';
                else if (user.role === 'admin') roleIcon = '‚ö° ';
                else if (user.role === 'coadmin') roleIcon = 'üîß ';
                else if (user.role === 'operator') roleIcon = 'üõ°Ô∏è ';
                
                const unreadCount = unreadPrivateMessages[user.name] || 0;
                
                html += `
                    <div class="user-item" onclick="openPrivateChat('${user.name}')">
                        <div class="user-avatar-small">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${roleIcon}${user.name}</div>
                            <div class="user-status">${user.role || 'user'}</div>
                        </div>
                        ${unreadCount > 0 ? `<div class="private-message-badge">${unreadCount}</div>` : ''}
                        <div class="online-dot"></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            const chattingCount = filteredUsers.filter(user => privateChats[user.name] && privateChats[user.name].length > 0).length;
            document.getElementById('chattingTab').textContent = `Sohbette (${chattingCount})`;
        }

        // ========== √ñZEL MESAJLA≈ûMA ==========
        function openPrivateChat(username) {
            const blocked = blockedUsers[username];
            if (blocked && (Date.now() - blocked.timestamp < 24 * 60 * 60 * 1000)) {
                addSystemMessage(`‚õî ${username} kullanƒ±cƒ±sƒ±nƒ± 24 saat engellediniz.`);
                return;
            }
            
            closeAllModals();
            
            if (!privateChats[username]) {
                privateChats[username] = [];
            }
            
            activePrivateChat = username;
            unreadPrivateMessages[username] = 0;
            
            document.getElementById('currentChannel').textContent = `@${username}`;
            document.getElementById('privateChatControls').style.display = 'flex';
            
            renderPrivateMessages(username);
            
            switchUserTab('chatting');
            
            updateActivePanelIndicator(`√ñzel Sohbet: ${username}`);
        }

        function closePrivateChat() {
            activePrivateChat = null;
            document.getElementById('currentChannel').textContent = 'genel';
            document.getElementById('privateChatControls').style.display = 'none';
            startFirebaseListeners();
            updateActivePanelIndicator('Genel Sohbet');
        }

        function blockUser24h() {
            if (!activePrivateChat) return;
            
            const username = activePrivateChat;
            blockedUsers[username] = {
                timestamp: Date.now()
            };
            
            addSystemMessage(`‚õî ${username} kullanƒ±cƒ±sƒ± 24 saatliƒüine engellendi.`);
            closePrivateChat();
            renderUserList();
        }

        function reportUser() {
            if (!activePrivateChat) return;
            
            document.getElementById('complaintUsername').textContent = activePrivateChat;
            closeAllModals();
            document.getElementById('complaintModal').classList.add('active');
            activeModal = 'complaintModal';
            updateActivePanelIndicator('≈ûikayet Paneli');
        }

        function closeComplaintModal() {
            document.getElementById('complaintModal').classList.remove('active');
            if (activeModal === 'complaintModal') {
                activeModal = null;
                updateActivePanelIndicator(activePrivateChat ? `√ñzel Sohbet: ${activePrivateChat}` : 'Genel Sohbet');
            }
        }

        function submitComplaint() {
            const username = document.getElementById('complaintUsername').textContent;
            const reason = document.getElementById('complaintReason').value;
            const description = document.getElementById('complaintDescription').value;
            
            if (database) {
                database.ref('complaints').push({
                    reporter: currentUser.name,
                    reportedUser: username,
                    reason: reason,
                    description: description,
                    timestamp: Date.now()
                });
            }
            
            addSystemMessage(`‚úÖ ${username} kullanƒ±cƒ±sƒ± ≈üikayet edildi. Te≈üekk√ºrler!`);
            closeComplaintModal();
        }

        function renderPrivateMessages(username) {
            const container = document.getElementById('messages');
            
            if (!privateChats[username] || privateChats[username].length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Bu kullanƒ±cƒ±yla hen√ºz mesajla≈ümadƒ±nƒ±z.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            privateChats[username].forEach(msg => {
                const isOwn = msg.sender === currentUser?.name;
                const time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', {
                    hour: '2-digit', minute: '2-digit'
                });
                
                let senderName = msg.sender;
                if (msg.role === 'owner') senderName = 'üëë ' + senderName;
                else if (msg.role === 'admin') senderName = '‚ö° ' + senderName;
                else if (msg.role === 'coadmin') senderName = 'üîß ' + senderName;
                else if (msg.role === 'operator') senderName = 'üõ°Ô∏è ' + senderName;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'right' : ''}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${senderName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHTML(msg.text)}</div>
                `;
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function sendPrivateMessage(username, text) {
            if (!database || !currentUser) return;
            
            const blocked = blockedUsers[username];
            if (blocked && (Date.now() - blocked.timestamp < 24 * 60 * 60 * 1000)) {
                addSystemMessage(`‚õî ${username} kullanƒ±cƒ±sƒ±nƒ± 24 saat engellediniz.`);
                return;
            }
            
            const message = {
                sender: currentUser.name,
                receiver: username,
                text: text,
                role: currentUser.role,
                timestamp: Date.now()
            };
            
            database.ref(`privateMessages/${username}`).push(message);
            
            if (!privateChats[username]) {
                privateChats[username] = [];
            }
            privateChats[username].push(message);
            
            if (activePrivateChat === username) {
                renderPrivateMessages(username);
            }
            
            renderUserList();
        }

        function handlePrivateMessage(message) {
            if (!message || !message.sender) return;
            
            const sender = message.sender;
            
            const blocked = blockedUsers[sender];
            if (blocked && (Date.now() - blocked.timestamp < 24 * 60 * 60 * 1000)) {
                return;
            }
            
            if (!privateChats[sender]) {
                privateChats[sender] = [];
            }
            privateChats[sender].push(message);
            
            if (activePrivateChat !== sender) {
                unreadPrivateMessages[sender] = (unreadPrivateMessages[sender] || 0) + 1;
                
                if (currentTab === 'chatting') {
                    renderUserList();
                }
            }
            
            if (activePrivateChat === sender) {
                renderPrivateMessages(sender);
                unreadPrivateMessages[sender] = 0;
            }
            
            addSystemMessage(`üí¨ ${sender} size √∂zel mesaj g√∂nderdi!`);
        }

        // ========== MESAJLAR ==========
        function updateMessages(messagesData) {
            if (!messagesData) return;
            
            if (activePrivateChat) {
                renderPrivateMessages(activePrivateChat);
                return;
            }
            
            const container = document.getElementById('messages');
            const messagesArray = [];
            
            Object.entries(messagesData).forEach(([id, msg]) => {
                messagesArray.push({ id, ...msg });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = '';
            
            messagesArray.slice(-50).forEach(msg => {
                const isOwn = msg.sender === currentUser?.name;
                const time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', {
                    hour: '2-digit', minute: '2-digit'
                });
                
                let senderName = msg.sender;
                if (msg.role === 'owner') senderName = 'üëë ' + senderName;
                else if (msg.role === 'admin') senderName = '‚ö° ' + senderName;
                else if (msg.role === 'coadmin') senderName = 'üîß ' + senderName;
                else if (msg.role === 'operator') senderName = 'üõ°Ô∏è ' + senderName;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'right' : ''}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender" onclick="openPrivateChat('${msg.sender}')">${senderName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHTML(msg.text)}</div>
                `;
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // ========== MESAJ G√ñNDER ==========
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser || !database) return;
            
            if (activePrivateChat) {
                sendPrivateMessage(activePrivateChat, text);
                input.value = '';
                autoResize(input);
                return;
            }
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                autoResize(input);
                return;
            }
            
            await database.ref('messages').push({
                sender: currentUser.name,
                text: text,
                role: currentUser.role,
                timestamp: Date.now()
            });
            
            input.value = '';
            autoResize(input);
            
            database.ref(`onlineUsers/${currentUser.name}`).update({
                lastSeen: Date.now()
            });
        }

        // ========== Sƒ∞STEM MESAJI ==========
        function addSystemMessage(text) {
            if (!database) return;
            database.ref('messages').push({
                sender: 'Sistem',
                text: text,
                type: 'system',
                timestamp: Date.now()
            });
        }

        // ========== KOMUT ƒ∞≈ûLEME ==========
        function handleCommand(cmd) {
            const parts = cmd.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            
            if (command === 'temizle' || command === 'clear') {
                if (isOwner || isAdmin) {
                    if (confirm('T√ºm mesajlarƒ± temizlemek istediƒüinize emin misiniz?')) {
                        database.ref('messages').remove();
                        addSystemMessage('‚úÖ T√ºm mesajlar temizlendi!');
                    }
                } else {
                    addSystemMessage('‚õî Bu komutu kullanma yetkiniz yok!');
                }
            }
        }

        // ========== MODAL ƒ∞≈ûLEMLERƒ∞ ==========
        function closeAllModals() {
            document.getElementById('addMediaModal').classList.remove('active');
            document.getElementById('liveStreamModal').classList.remove('active');
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('complaintModal').classList.remove('active');
            activeModal = null;
        }

        function closeAllModalsExcept(modalId) {
            closeAllModals();
            activeModal = modalId;
            updateActivePanelIndicator(getPanelName(modalId));
        }

        function getPanelName(modalId) {
            const names = {
                'addMediaModal': 'Medya Ekleme',
                'liveStreamModal': 'Canlƒ± Yayƒ±n Ba≈ülatma',
                'profileModal': 'Profil',
                'complaintModal': '≈ûikayet'
            };
            return names[modalId] || 'Panel';
        }

        function openAddMediaModal() {
            if (!canManageMedia()) {
                addSystemMessage('‚õî Sadece Owner, Admin ve yetkili Co-Admin medya ekleyebilir!');
                return;
            }
            closeAllModals();
            document.getElementById('addMediaModal').classList.add('active');
            activeModal = 'addMediaModal';
            updateActivePanelIndicator('Medya Ekleme');
        }

        function closeAddMediaModal() {
            document.getElementById('addMediaModal').classList.remove('active');
            document.getElementById('mediaUrl').value = '';
            document.getElementById('mediaTitle').value = '';
            if (activeModal === 'addMediaModal') {
                activeModal = null;
                updateActivePanelIndicator(activePrivateChat ? `√ñzel Sohbet: ${activePrivateChat}` : 'Genel Sohbet');
            }
        }

        function showProfileMenu() {
            closeAllModals();
            document.getElementById('profileModal').classList.add('active');
            activeModal = 'profileModal';
            updateActivePanelIndicator('Profil');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
            if (activeModal === 'profileModal') {
                activeModal = null;
                updateActivePanelIndicator(activePrivateChat ? `√ñzel Sohbet: ${activePrivateChat}` : 'Genel Sohbet');
            }
        }

        function openLiveStreamModal() {
            if (!canStartLiveStream()) {
                addSystemMessage('‚õî Canlƒ± yayƒ±n ba≈ülatma yetkiniz yok!');
                return;
            }
            closeAllModals();
            document.getElementById('liveStreamModal').classList.add('active');
            activeModal = 'liveStreamModal';
            updateActivePanelIndicator('Canlƒ± Yayƒ±n Ba≈ülatma');
        }

        function closeLiveStreamModal() {
            document.getElementById('liveStreamModal').classList.remove('active');
            if (activeModal === 'liveStreamModal') {
                activeModal = null;
                updateActivePanelIndicator('Genel Sohbet');
            }
        }

        function updateActivePanelIndicator(text) {
            const indicator = document.getElementById('activePanelIndicator');
            if (indicator) {
                indicator.textContent = `Panel: ${text}`;
            }
        }

        // ========== Dƒ∞ƒûER FONKSƒ∞YONLAR ==========
        function uploadAvatar() {
            document.getElementById('avatarUpload').click();
        }

        document.getElementById('avatarUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('avatarImg').src = event.target.result;
                    document.getElementById('avatarImg').style.display = 'block';
                    document.getElementById('avatarText').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        function toggleNotificationPanel() {
            addSystemMessage('üîî Bildirim paneli');
        }

        function showUsersPanel() {
            closeAllModals();
            activePrivateChat = null;
            document.getElementById('currentChannel').textContent = 'genel';
            document.getElementById('privateChatControls').style.display = 'none';
            startFirebaseListeners();
            updateActivePanelIndicator('Genel Sohbet');
        }

        function switchUserTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderUserList();
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function resetLoginButton() {
            const btn = document.getElementById('loginBtn');
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Giri≈ü Yap';
            btn.disabled = false;
        }

        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => { errorEl.style.display = 'none'; }, 3000);
            resetLoginButton();
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash password-toggle';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye password-toggle';
            }
        }

        function logout() {
            if (database && currentUser) {
                database.ref(`onlineUsers/${currentUser.name}`).remove();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            location.reload();
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (document.activeElement.id === 'nickname' || document.activeElement.id === 'password') {
                        handleLogin();
                    } else if (document.activeElement.id === 'messageInput') {
                        sendMessage();
                    }
                    e.preventDefault();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                    e.preventDefault();
                }
            });
            
            renderPlaylist();
            updateActivePanelIndicator('Genel Sohbet');
        });

        // ========== GLOBAL FONKSƒ∞YONLAR ==========
        window.handleLogin = handleLogin;
        window.sendMessage = sendMessage;
        window.switchMediaTab = switchMediaTab;
        window.addToPlaylist = addToPlaylist;
        window.playVideo = playVideo;
        window.playSpotify = playSpotify;
        window.removeFromPlaylist = removeFromPlaylist;
        window.removeFromSpotifyPlaylist = removeFromSpotifyPlaylist;
        window.clearPlaylist = clearPlaylist;
        window.openAddMediaModal = openAddMediaModal;
        window.closeAddMediaModal = closeAddMediaModal;
        window.openPrivateChat = openPrivateChat;
        window.closePrivateChat = closePrivateChat;
        window.blockUser24h = blockUser24h;
        window.reportUser = reportUser;
        window.closeComplaintModal = closeComplaintModal;
        window.submitComplaint = submitComplaint;
        window.showProfileMenu = showProfileMenu;
        window.closeProfileModal = closeProfileModal;
        window.uploadAvatar = uploadAvatar;
        window.toggleNotificationPanel = toggleNotificationPanel;
        window.showUsersPanel = showUsersPanel;
        window.switchUserTab = switchUserTab;
        window.autoResize = autoResize;
        window.logout = logout;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.toggleMute = toggleMute;
        window.togglePlayPause = togglePlayPause;
        window.closeAllModals = closeAllModals;
        window.openLiveStreamModal = openLiveStreamModal;
        window.closeLiveStreamModal = closeLiveStreamModal;
        window.startLiveStream = startLiveStream;
        window.stopLiveStream = stopLiveStream;
        window.switchCamera = switchCamera;
        
        // T√ºm kullanƒ±cƒ±lar i√ßin medya fonksiyonlarƒ±
        window.switchMediaTabForAll = switchMediaTabForAll;
        window.playVideoForAll = playVideoForAll;
        window.playSpotifyForAll = playSpotifyForAll;
    </script>
</body>
</html>
