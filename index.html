<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CanlÄ± YayÄ±n & Sohbet</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: #1a1a1a;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      z-index: 10;
    }
    .online-count {
      font-size: 0.95rem;
      color: #4caf50;
      font-weight: 500;
    }
    .admin-badge {
      background: #ff9800;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #video-container {
      flex: 3;
      background: #000;
      position: relative;
    }
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 320px;
      background: #111;
      border-left: 1px solid #222;
    }
    #users-container {
      width: 240px;
      background: #0a0a0a;
      border-left: 1px solid #222;
      padding: 16px;
      overflow-y: auto;
    }
    #messages, #private-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .message {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 80%;
      word-break: break-word;
    }
    .message.own {
      background: #e91e63;
      color: white;
      margin-left: auto;
    }
    .message.other {
      background: #2a2a2a;
    }
    .message img {
      max-width: 240px;
      border-radius: 8px;
      margin-top: 6px;
      display: block;
    }
    .new-message-highlight {
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background: rgba(233, 30, 99, 0.3); }
      100% { background: transparent; }
    }
    .blink-notification {
      animation: blink-red 1.2s infinite alternate;
      background: rgba(255, 0, 0, 0.25) !important;
      border-left: 4px solid #ff1744;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    @keyframes blink-red {
      from { opacity: 1; }
      to   { opacity: 0.35; }
    }
    #input-area {
      padding: 12px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      display: flex;
      gap: 8px;
    }
    input, button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
    }
    input {
      flex: 1;
      background: #222;
      color: white;
    }
    button {
      background: #e91e63;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #c2185b;
    }
    #private-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 360px;
      height: 420px;
      background: #111;
      border: 1px solid #444;
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    #private-panel.open {
      transform: translateX(0);
    }
    #private-header {
      padding: 12px;
      background: #1f1f1f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    .user-item {
      padding: 8px 0;
      cursor: pointer;
      border-bottom: 1px solid #222;
      transition: all 0.3s;
    }
    .user-item:hover {
      background: #1a1a1a;
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      #users-container {
        width: 100%;
        height: 140px;
        border-left: none;
        border-top: 1px solid #333;
      }
      #chat-container { min-width: auto; }
    }
  </style>
</head>
<body>

  <header>
    <div>ðŸŽ¤ CanlÄ± YayÄ±n & Sohbet</div>
    <div style="display:flex; align-items:center; gap:16px;">
      <div id="login-area">
        <input id="nickname" placeholder="KullanÄ±cÄ± adÄ±n" />
        <button id="join-btn">Gir</button>
      </div>
      <div id="online-count" class="online-count">Online: 0 kiÅŸi</div>
    </div>
  </header>

  <div class="main">
    <div id="video-container">
      <iframe 
        width="100%" 
        height="100%" 
        src="https://www.youtube.com/embed/RN4h0sBtzlc?autoplay=1&mute=1&controls=1&playsinline=1&modestbranding=1"
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
      </iframe>
    </div>

    <div id="chat-container">
      <div id="messages"></div>
      <div id="input-area">
        <input id="message-input" placeholder="Mesaj yaz..." />
        <button id="send-btn">GÃ¶nder</button>
      </div>
    </div>

    <div id="users-container">
      <h3 style="margin-bottom:12px; color:#e91e63">Online KullanÄ±cÄ±lar</h3>
      <div id="user-list"></div>
    </div>
  </div>

  <!-- Ã–zel sohbet paneli -->
  <div id="private-panel">
    <div id="private-header">
      <span id="private-title">Ã–zel sohbet: ...</span>
      <button onclick="closePrivate()">Ã—</button>
    </div>
    <div id="private-messages"></div>
    <div id="input-area">
      <input id="private-message-input" placeholder="Ã–zel mesaj..." />
      <input type="file" id="private-image-input" accept="image/*" style="display:none;" />
      <button onclick="document.getElementById('private-image-input').click()">ðŸ“Ž</button>
      <button id="send-private-btn">GÃ¶nder</button>
    </div>
  </div>

  <script>
    // ====================================================
    // FIREBASE CONFIG
    // ====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
      authDomain: "popboxmusicchat.firebaseapp.com",
      databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
      projectId: "popboxmusicchat",
      storageBucket: "popboxmusicchat.appspot.com",
      messagingSenderId: "206625719024",
      appId: "1:206625719024:web:d28f478a2c96d10412f835",
      measurementId: "G-SB1K22FLEX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentNick = "";
    let currentPrivateToUid = null;
    let currentPrivateToNick = "";
    let currentPrivateListener = null;
    let currentRole = "user";

    // Emoji map
    const emojiMap = {
      ":)": "ðŸ˜Š", ":(": "ðŸ˜”", ":D": "ðŸ˜„", ":P": "ðŸ˜›", "<3": "â¤ï¸",
      ":fire:": "ðŸ”¥", ":smile:": "ðŸ˜„", ":sad:": "ðŸ˜¢", ":heart:": "â¤ï¸",
      ":thumbsup:": "ðŸ‘", ":thumbsdown:": "ðŸ‘Ž", ":laugh:": "ðŸ˜‚",
      ":cry:": "ðŸ˜­", ":angry:": "ðŸ˜ ", ":love:": "ðŸ¥°", ":cool:": "ðŸ˜Ž"
    };

    function convertEmojis(text) {
      let result = text;
      for (const [code, emoji] of Object.entries(emojiMap)) {
        const regex = new RegExp(code.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), "g");
        result = result.replace(regex, emoji);
      }
      return result;
    }

    // Admin / CoAdmin / Operator kontrolÃ¼
    function getRoleLevel(role) {
      if (role === "admin") return 3;
      if (role === "coadmin") return 2;
      if (role === "operator") return 1;
      return 0; // user
    }

    // GiriÅŸ
    document.getElementById("join-btn").onclick = () => {
      const nick = document.getElementById("nickname").value.trim();
      if (!nick) return alert("KullanÄ±cÄ± adÄ± girin");
      if (nick.length < 2) return alert("Nick en az 2 karakter olmalÄ±");

      db.ref("users").once("value", snapshot => {
        let nickInUse = false;
        snapshot.forEach(child => {
          const user = child.val();
          if (user && user.nick === nick && user.online) {
            nickInUse = true;
            return true;
          }
        });

        if (nickInUse && nick !== "popbox") { // popbox nick serbest kalabilir, ama sadece sen admin olursun
          alert("Bu nick zaten online biri tarafÄ±ndan kullanÄ±lÄ±yor. BaÅŸka bir nick dene.");
          return;
        }

        auth.signInAnonymously()
          .then(() => {
            currentNick = nick;
            const uid = auth.currentUser.uid;

            currentRole = (nick === "popbox") ? "admin" : "user";

            const userRef = db.ref("users/" + uid);
            userRef.set({
              nick: nick,
              online: true,
              lastSeen: Date.now(),
              role: currentRole
            });

            userRef.onDisconnect().update({
              online: false,
              lastSeen: firebase.database.ServerValue.TIMESTAMP
            });

            document.getElementById("login-area").innerHTML = `HoÅŸ geldin, <b>${nick}</b>${getRoleLevel(currentRole) > 0 ? ' (Admin)' : ''}`;
          })
          .catch(err => alert("GiriÅŸ hatasÄ±: " + err.message));
      });
    };

    // Online kullanÄ±cÄ±lar + sayaÃ§ + role badge
    db.ref("users").on("value", snapshot => {
      let count = 0;
      const list = document.getElementById("user-list");
      list.innerHTML = "";

      snapshot.forEach(child => {
        const user = child.val();
        if (user && user.online) {
          count++;
          const div = document.createElement("div");
          div.className = "user-item";
          div.id = `user-${child.key}`;
          let badge = '';
          if (getRoleLevel(user.role) > 0) badge = '<span class="admin-badge">Admin</span>';
          div.innerHTML = `${user.nick}${badge}`;
          div.onclick = () => openPrivateChat(child.key, user.nick);
          list.appendChild(div);
        }
      });

      document.getElementById("online-count").textContent = `Online: ${count} kiÅŸi`;
    });

    // Genel sohbet
    db.ref("messages").limitToLast(101).on("child_added", snapshot => {
      db.ref("messages").limitToFirst(1).once("child_added", oldest => {
        if (oldest.key !== snapshot.key) oldest.ref.remove();
      });

      const msg = snapshot.val();
      const div = document.createElement("div");
      div.className = `message ${msg.nick === currentNick ? "own" : "other"} new-message-highlight`;
      div.innerHTML = `<strong>${msg.nick}:</strong> ${convertEmojis(msg.text || "")}`;
      document.getElementById("messages").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });

      if (msg.nick !== currentNick) {
        setTimeout(() => div.classList.remove("new-message-highlight"), 2000);
      }
    });

    // Genel mesaj gÃ¶nderme + admin komutlarÄ±
    function sendPublicMessage() {
      let text = document.getElementById("message-input").value.trim();
      if (!text || !currentNick) return;

      // Komut kontrolÃ¼
      if (text.startsWith("/")) {
        const parts = text.substring(1).split(" ");
        const command = parts[0].toLowerCase();
        const target = parts[1] ? parts[1].toLowerCase() : null;

        const myLevel = getRoleLevel(currentRole);

        if (myLevel < 1) {
          alert("Bu komutu kullanmak iÃ§in en az operator olmalÄ±sÄ±n.");
          return;
        }

        if (command === "temiz") {
          if (myLevel >= 2) { // CoAdmin+
            db.ref("messages").remove();
            db.ref("messages").push({
              nick: "Sistem",
              text: "Sohbet temizlendi.",
              timestamp: Date.now()
            });
            alert("Genel sohbet temizlendi.");
          } else {
            alert("Bu komut iÃ§in en az CoAdmin olmalÄ±sÄ±n.");
          }
        } else if (command === "sil") {
          if (myLevel >= 1) { // Operator+
            db.ref("messages").limitToLast(1).once("value", snap => {
              snap.forEach(child => child.ref.remove());
            });
            db.ref("messages").push({
              nick: "Sistem",
              text: "Son mesaj silindi.",
              timestamp: Date.now()
            });
            alert("Son mesaj silindi.");
          } else {
            alert("Bu komut iÃ§in en az Operator olmalÄ±sÄ±n.");
          }
        } else if (command === "kick" && target) {
          if (myLevel >= 1) { // Operator+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ online: false });
                  db.ref("messages").push({
                    nick: "Sistem",
                    text: `${target} kicklendi.`,
                    timestamp: Date.now()
                  });
                  alert(`${target} kicklendi.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in en az Operator olmalÄ±sÄ±n.");
          }
        } else if (command === "spamengelle" && target) {
          if (myLevel >= 1) { // Operator+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ banned: true });
                  alert(`${target} spam engellendi.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in en az Operator olmalÄ±sÄ±n.");
          }
        } else if (command === "coadmin" && target) {
          if (myLevel >= 3) { // Admin+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ role: "coadmin" });
                  alert(`${target} artÄ±k CoAdmin.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in Admin olmalÄ±sÄ±n.");
          }
        } else if (command === "uncoadmin" && target) {
          if (myLevel >= 3) { // Admin+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ role: "user" });
                  alert(`${target} artÄ±k normal kullanÄ±cÄ±.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in Admin olmalÄ±sÄ±n.");
          }
        } else if (command === "operator" && target) {
          if (myLevel >= 2) { // CoAdmin+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ role: "operator" });
                  alert(`${target} artÄ±k Operator.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in en az CoAdmin olmalÄ±sÄ±n.");
          }
        } else if (command === "unoperator" && target) {
          if (myLevel >= 2) { // CoAdmin+
            db.ref("users").once("value", snap => {
              snap.forEach(child => {
                if (child.val().nick.toLowerCase() === target) {
                  child.ref.update({ role: "user" });
                  alert(`${target} artÄ±k normal kullanÄ±cÄ±.`);
                }
              });
            });
          } else {
            alert("Bu komut iÃ§in en az CoAdmin olmalÄ±sÄ±n.");
          }
        } else {
          alert("GeÃ§ersiz komut. KullanÄ±labilir: /temiz, /sil, /kick [nick], /spamengelle [nick], /coadmin [nick], /uncoadmin [nick], /operator [nick], /unoperator [nick]");
        }
        document.getElementById("message-input").value = "";
        return;
      }

      db.ref("messages").push({
        nick: currentNick,
        text,
        timestamp: Date.now()
      });
      document.getElementById("message-input").value = "";
    }

    // Ã–zel sohbet
    function openPrivateChat(uid, nick) {
      if (currentPrivateListener) {
        db.ref(`private/${currentPrivateListener.chatId}`).off("child_added", currentPrivateListener.listener);
      }

      currentPrivateToUid = uid;
      currentPrivateToNick = nick;
      document.getElementById("private-title").textContent = `Ã–zel: ${nick}`;
      document.getElementById("private-panel").classList.add("open");
      document.getElementById("private-messages").innerHTML = "";

      const chatId = [auth.currentUser.uid, uid].sort().join("_");

      const listener = snapshot => {
        db.ref(`private/${chatId}`).limitToFirst(1).once("child_added", oldest => {
          if (oldest.key !== snapshot.key) oldest.ref.remove();
        });

        const msg = snapshot.val();
        const div = document.createElement("div");
        div.className = `message ${msg.from === auth.currentUser.uid ? "own" : "other"} new-message-highlight`;

        let content = `<strong>${msg.fromNick}:</strong> ${convertEmojis(msg.text || "")}`;
        div.innerHTML = content;

        if (msg.imageBase64) {
          const img = document.createElement("img");
          img.src = msg.imageBase64;
          img.style.maxWidth = "240px";
          img.style.borderRadius = "8px";
          img.style.marginTop = "6px";
          img.style.display = "block";
          div.appendChild(img);
        }

        document.getElementById("private-messages").appendChild(div);
        div.scrollIntoView();

        if (msg.from !== auth.currentUser.uid) {
          setTimeout(() => div.classList.remove("new-message-highlight"), 2000);

          const userDiv = document.getElementById(`user-${msg.from}`);
          if (userDiv) {
            userDiv.classList.add("blink-notification");
            setTimeout(() => userDiv.classList.remove("blink-notification"), 10000);
            playNotificationSound();
          }
        }
      };

      db.ref(`private/${chatId}`).limitToLast(101).on("child_added", listener);
      currentPrivateListener = { chatId, listener };
    }

    function closePrivate() {
      if (currentPrivateListener) {
        db.ref(`private/${currentPrivateListener.chatId}`).off("child_added", currentPrivateListener.listener);
        currentPrivateListener = null;
      }

      document.getElementById("private-panel").classList.remove("open");
      currentPrivateToUid = null;
      currentPrivateToNick = "";
    }

    document.getElementById("send-private-btn").onclick = () => {
      let text = document.getElementById("private-message-input").value.trim();
      if (!text || !currentPrivateToUid) return;

      const chatId = [auth.currentUser.uid, currentPrivateToUid].sort().join("_");
      db.ref(`private/${chatId}`).push({
        from: auth.currentUser.uid,
        fromNick: currentNick,
        text,
        timestamp: Date.now()
      });
      document.getElementById("private-message-input").value = "";
    };

    // Base64 resim gÃ¶nderme
    document.getElementById("private-image-input").onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!currentPrivateToUid) {
        alert("Ã–zel sohbet aÃ§Ä±k deÄŸil!");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const base64 = event.target.result;

        if (base64.length > 800000) {
          if (!confirm("Resim bÃ¼yÃ¼k (" + (base64.length / 1000).toFixed(0) + " KB). Yine de gÃ¶ndermek ister misiniz?")) {
            return;
          }
        }

        const chatId = [auth.currentUser.uid, currentPrivateToUid].sort().join("_");

        db.ref(`private/${chatId}`).push({
          from: auth.currentUser.uid,
          fromNick: currentNick,
          text: "[Resim]",
          imageBase64: base64,
          timestamp: Date.now()
        }).then(() => {
          console.log("Resim Base64 kaydedildi");
        }).catch(err => {
          alert("GÃ¶nderme hatasÄ±: " + err.message);
        });
      };

      reader.readAsDataURL(file);
    };

    // Bildirim sesi
    function playNotificationSound() {
      const sound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
      sound.play().catch(() => {});
    }
  </script>
</body>
</html>
