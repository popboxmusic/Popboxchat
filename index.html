<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CetCety Â· Deepseek tarzÄ±</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- CETCETY STYLE -->
    <link rel="stylesheet" href="style.css">
    
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <!-- LOGO -->
    <div class="logo-area">
        <i class="fas fa-comment-dots logo-icon"></i>
        <div class="logo-text">CetCety <span>Â· deepseek</span></div>
    </div>

    <!-- ANA GRID -->
    <div class="app">
        <!-- Ä°KON PANELÄ° -->
        <div class="icon-panel">
            <div class="icon-item active" onclick="switchPanelTab('online')">
                <i class="fas fa-home"></i>
            </div>
            <div class="icon-item" style="margin-top: auto;" onclick="showProfile()">
                <i class="fas fa-user-circle"></i>
            </div>
        </div>

        <!-- DAR PANEL -->
        <div class="side-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchPanelTab('online')" id="tabOnline">Online</div>
                <div class="panel-tab" onclick="switchPanelTab('onchat')" id="tabOnchat">OnChat</div>
            </div>
            <div class="panel-content" id="panelContent">
                <div style="color: #606060; padding: 20px; text-align: center;">YÃ¼kleniyor...</div>
            </div>
        </div>

        <!-- SOHBET ALANI - KUTUCUKSUZ -->
        <div class="chat-area">
            <div class="chat-header">
                <i class="fas fa-hashtag"></i>
                <span>genel</span>
                <span style="color: #606060; margin-left: auto;" id="onlineCount">0</span>
            </div>
            <div class="chat-messages" id="messages">
                <!-- Mesajlar buraya dÃ¼z metin olarak gelecek -->
            </div>
            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Mesaj yaz..."
                        rows="1"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MEDYA PANELÄ° -->
        <div class="media-panel">
            <div class="media-header">
                <i class="fab fa-youtube"></i>
                <span>Medya</span>
            </div>
            <div class="video-container">
                <div id="youtube-player"></div>
            </div>
            <div class="playlist"></div>
        </div>
    </div>

    <!-- GÄ°RÄ°Åž EKRANI -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">
                <i class="fas fa-comment-dots"></i> CetCety
            </div>
            <input type="text" id="login-nick" class="login-input" placeholder="KullanÄ±cÄ± adÄ±" autocomplete="off">
            <button class="login-button" onclick="login()" id="login-btn">Sohbete KatÄ±l</button>
            <div id="login-error" class="error-message"></div>
        </div>
    </div>

    <!-- Ã–ZEL SOHBET MODAL - KUTUCUKSUZ -->
    <div class="private-modal" id="privateModal">
        <div class="private-header">
            <div id="privateWith">ðŸ”’ Ã–zel Sohbet</div>
            <button onclick="closePrivateChat()" style="background:none; border:none; color:#e0e0e0; font-size:24px;">Ã—</button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input-area">
            <input type="file" id="mediaUpload" accept="image/*,video/*" style="display:none;">
            <button class="media-upload-btn" onclick="document.getElementById('mediaUpload').click()">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="private-input" placeholder="Mesaj yaz..." rows="1" oninput="autoResize(this)"></textarea>
            <button class="send-button" onclick="sendPrivateMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- OVERLAY -->
    <div id="overlay" onclick="closePrivateChat()"></div>
    
    <!-- FIREBASE BADGE -->
    <div class="firebase-badge"><i class="fas fa-fire"></i> Firebase</div>

    <script>
        // ========== FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // ========== DEÄžÄ°ÅžKENLER ==========
        let currentUser = null;
        let usersRef = db.ref('onlineUsers');
        let messagesRef = db.ref('messages');
        let privateChatsRef = db.ref('privateChats');
        
        let privateChatWith = null;
        let currentPrivateChatId = null;
        let onlineUsers = {};
        let activeChats = {};
        let currentPanelTab = 'online';
        let player = null;

        function autoResize(t) { t.style.height='auto'; t.style.height=Math.min(t.scrollHeight,120)+'px'; }

        // ========== GÄ°RÄ°Åž ==========
        window.login = function() {
            const nick = document.getElementById('login-nick').value.trim();
            if (!nick) return;
            
            currentUser = { name: nick };
            
            usersRef.child(nick).set({ name: nick, lastSeen: Date.now() });
            usersRef.child(nick).onDisconnect().remove();
            
            document.getElementById('login-screen').style.display = 'none';
            initApp();
        };

        // ========== UYGULAMA ==========
        function initApp() {
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('private-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });

            if (typeof YT !== 'undefined') initYouTubePlayer();

            // Online kullanÄ±cÄ±lar
            usersRef.on('value', (snap) => {
                const users = snap.val() || {};
                const now = Date.now();
                const active = {};
                Object.entries(users).forEach(([name, data]) => {
                    if (now - (data.lastSeen || 0) < 15000) active[name] = data;
                });
                onlineUsers = active;
                document.getElementById('onlineCount').textContent = Object.keys(active).length;
                updatePanel();
            });

            // Genel mesajlar - KUTUCUKSUZ
            messagesRef.limitToLast(50).on('value', (snap) => {
                const msgs = snap.val() || {};
                const container = document.getElementById('messages');
                container.innerHTML = '';
                
                Object.entries(msgs).sort((a,b) => a[1].timestamp - b[1].timestamp).forEach(([id, msg]) => {
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `
                        <span class="message-time">${msg.time || '--:--'}</span>
                        <span class="message-sender" onclick="openPrivateChat('${msg.sender}')">${msg.sender}</span>
                        <span class="message-text">${msg.text || ''}</span>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });

            // Heartbeat
            setInterval(() => {
                if (currentUser) usersRef.child(currentUser.name).update({ lastSeen: Date.now() });
            }, 5000);
        }

        // ========== YOUTUBE ==========
        function initYouTubePlayer() {
            player = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                videoId: 'i75BZYOAPl4',
                playerVars: { autoplay: 1, controls: 1, rel: 0 }
            });
        }

        // ========== MESAJ GÃ–NDER ==========
        window.sendMessage = function() {
            if (!currentUser) return;
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;
            
            messagesRef.push({
                sender: currentUser.name,
                text: text,
                time: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            });
            input.value = '';
        };

        // ========== Ã–ZEL SOHBET ==========
        window.openPrivateChat = function(username) {
            if (username === currentUser?.name) return;
            
            privateChatWith = username;
            currentPrivateChatId = [currentUser.name, username].sort().join('_');
            
            document.getElementById('privateWith').textContent = `ðŸ”’ ${username}`;
            document.getElementById('privateModal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
            
            // OnChat - anlÄ±k
            activeChats[username] = { lastMessage: Date.now(), unread: 0, name: username };
            updatePanel();
            
            const container = document.getElementById('privateMessages');
            container.innerHTML = '';
            
            privateChatsRef.child(currentPrivateChatId).limitToLast(50).on('value', (snap) => {
                const msgs = snap.val() || {};
                container.innerHTML = '';
                
                Object.entries(msgs).sort((a,b) => a[1].timestamp - b[1].timestamp).forEach(([id, msg]) => {
                    const div = document.createElement('div');
                    div.className = 'private-message' + (msg.sender === currentUser.name ? ' own' : '');
                    
                    let content = msg.text || '';
                    if (msg.type === 'image') {
                        content = `<img src="${msg.url}" class="message-image" onclick="window.open('${msg.url}')">`;
                    } else if (msg.type === 'video') {
                        content = `<video src="${msg.url}" class="message-video" controls></video>`;
                    }
                    
                    div.innerHTML = `
                        <span class="private-message-time">${msg.time || '--:--'}</span>
                        <span class="private-message-sender">${msg.sender}</span>
                        <span class="private-message-content">${content}</span>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closePrivateChat = function() {
            privateChatWith = null;
            currentPrivateChatId = null;
            document.getElementById('privateModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        };

        window.sendPrivateMessage = function() {
            if (!privateChatWith || !currentPrivateChatId) return;
            const input = document.getElementById('private-input');
            const text = input.value.trim();
            if (!text) return;
            
            privateChatsRef.child(currentPrivateChatId).push({
                sender: currentUser.name,
                text: text,
                type: 'text',
                time: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            });
            input.value = '';
        };

        // ========== MEDYA YÃœKLE (RESIM + VIDEO) ==========
        document.getElementById('mediaUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !privateChatWith) return;
            
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            if (!isImage && !isVideo) {
                alert('Sadece resim veya video!');
                return;
            }
            
            const storageRef = storage.ref(`private/${Date.now()}_${file.name}`);
            storageRef.put(file).then(snap => snap.ref.getDownloadURL()).then(url => {
                privateChatsRef.child(currentPrivateChatId).push({
                    sender: currentUser.name,
                    url: url,
                    type: isImage ? 'image' : 'video',
                    time: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                });
            });
            e.target.value = '';
        });

        // ========== PANEL ==========
        window.switchPanelTab = function(tab) {
            currentPanelTab = tab;
            document.getElementById('tabOnline').classList.toggle('active', tab==='online');
            document.getElementById('tabOnchat').classList.toggle('active', tab==='onchat');
            updatePanel();
        };

        function updatePanel() {
            const content = document.getElementById('panelContent');
            
            if (currentPanelTab === 'online') {
                let html = '<div class="section-title">Ã‡EVRÄ°MÄ°Ã‡Ä°</div>';
                let has = false;
                Object.keys(onlineUsers).forEach(u => {
                    if (u !== currentUser?.name) {
                        has = true;
                        html += `<div class="online-item" onclick="openPrivateChat('${u}')">
                            <div class="online-status"></div>${u}
                        </div>`;
                    }
                });
                if (!has) html += '<div style="color:#606060; padding:20px;">Kimse yok</div>';
                content.innerHTML = html;
            } else {
                let html = '<div class="section-title">KONUÅžULANLAR</div>';
                const ids = Object.keys(activeChats).sort((a,b) => activeChats[b].lastMessage - activeChats[a].lastMessage);
                if (ids.length === 0) html += '<div style="color:#606060; padding:20px;">Yok</div>';
                ids.forEach(id => {
                    html += `<div class="chat-item" onclick="openPrivateChat('${id}')">
                        <i class="fas fa-comment"></i> ${id}
                    </div>`;
                });
                content.innerHTML = html;
            }
        }

        window.showProfile = function() {
            alert(`KullanÄ±cÄ±: ${currentUser?.name}`);
        };

        window.onYouTubeIframeAPIReady = initYouTubePlayer;
    </script>
</body>
</html>
