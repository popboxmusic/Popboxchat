<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popbox Music Chat - TÃœM KOMUTLAR + BAN SÄ°STEMÄ°</title>
    <!-- FIREBASE SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root {
            --primary: #4fc3f7;
            --secondary: #ff5555;
            --private: #9c27b0;
            --coadmin: #ff9800;
            --bg-dark: #1a1a2e;
            --bg-light: #2d2d44;
            --text-light: #ffffff;
            --online: #4caf50;
            --firebase: #ffa000;
            --ban-color: #ff3333;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        
        /* FIREBASE BADGE */
        .firebase-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--firebase);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* GÄ°RÄ°Å EKRANI */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-box {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid var(--primary);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .firebase-icon {
            color: var(--firebase);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        
        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ff5555;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
            white-space: pre-line;
            text-align: left;
            background: rgba(255,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #ff5555;
        }
        
        .success-message {
            color: var(--online);
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
            white-space: pre-line;
            text-align: left;
            background: rgba(76,175,80,0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--online);
        }
        
        /* ANA UYGULAMA */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        /* HEADER */
        .header {
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-badge {
            background: var(--secondary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            display: none;
        }
        
        .coadmin-badge {
            background: var(--coadmin);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            display: none;
        }
        
        /* ANA Ä°Ã‡ERÄ°K */
        .main-content {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }
        
        /* YOUTUBE */
        .video-section {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 200px;
            position: relative;
        }
        
        .youtube-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #ff0000, #ff5e00);
            color: white;
            font-size: 1.2em;
            gap: 10px;
        }
        
        /* CHAT */
        .chat-section {
            width: 400px;
            background: var(--bg-light);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-badge {
            background: var(--online);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        /* MESAJLAR */
        .messages-container {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .message {
            background: rgba(255,255,255,0.07);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            position: relative;
        }
        
        .message.system {
            border-left-color: var(--online);
            background: rgba(76,175,80,0.1);
        }
        
        .message.admin {
            border-left-color: var(--secondary);
            background: rgba(255,85,85,0.1);
        }
        
        .message.coadmin {
            border-left-color: var(--coadmin);
            background: rgba(255,152,0,0.1);
        }
        
        .message.private-msg {
            border-left-color: var(--private);
            background: rgba(156,39,176,0.1);
        }
        
        .message.ban-message {
            border-left-color: var(--ban-color);
            background: rgba(255,51,51,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .message-user {
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-user:hover {
            background: rgba(79, 195, 247, 0.2);
        }
        
        .message-time {
            color: #aaa;
            font-size: 0.8em;
        }
        
        .delete-btn {
            background: rgba(255,85,85,0.2);
            color: #ff5555;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7em;
            cursor: pointer;
            margin-left: 10px;
            display: none;
        }
        
        .message:hover .delete-btn {
            display: inline-block;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            border: 2px solid var(--primary);
            cursor: pointer;
        }
        
        /* INPUT */
        .input-container {
            padding: 10px;
            border-top: 1px solid rgba(79,195,247,0.2);
            display: flex;
            gap: 8px;
        }
        
        #message-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ONLINE KULLANICI LÄ°STESÄ° */
        .user-list-sidebar {
            width: 250px;
            background: var(--bg-light);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            border: 2px solid var(--primary);
        }
        
        .user-list-title {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-item {
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--online);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-item:hover {
            transform: translateX(5px);
            background: rgba(79, 195, 247, 0.1);
        }
        
        .user-item.idle {
            border-left-color: #ff9800;
            opacity: 0.8;
        }
        
        .user-item.banned {
            border-left-color: var(--ban-color);
            background: rgba(255,51,51,0.1);
            opacity: 0.7;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background: var(--online); }
        .status-idle { background: #ff9800; }
        .status-banned { background: var(--ban-color); }
        
        /* Ã–ZEL SOHBET MODALI */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }
        
        .private-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-light);
            border: 3px solid var(--private);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            z-index: 2001;
            flex-direction: column;
        }
        
        .private-header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--private);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--private);
            font-weight: bold;
        }
        
        .private-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
        }
        
        .private-input-container {
            padding: 10px;
            border-top: 1px solid var(--private);
            display: flex;
            gap: 8px;
        }
        
        /* BAN MODAL */
        .ban-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-light);
            border: 3px solid var(--ban-color);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            z-index: 2003;
            flex-direction: column;
        }
        
        .ban-header {
            padding: 15px;
            background: rgba(255,51,51,0.2);
            border-bottom: 1px solid var(--ban-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--ban-color);
            font-weight: bold;
        }
        
        /* RESÄ°M MODALI */
        .image-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 2002;
        }
        
        .image-modal img {
            max-width: 80vw;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* MOBÄ°L */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .chat-section {
                width: 100%;
                height: 300px;
            }
            
            .user-list-sidebar {
                width: 100%;
                height: 200px;
                order: -1;
            }
            
            #message-input, #private-input {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- FIREBASE BADGE -->
    <div class="firebase-badge">
        <span class="firebase-icon">ğŸ”¥</span> Firebase Active
    </div>
    
    <!-- GÄ°RÄ°Å EKRANI -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">
                <span class="firebase-icon">ğŸ”¥</span>
                ğŸ” Popbox Music Chat PRO
            </div>
            <input type="text" id="login-nick" class="login-input" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" autocomplete="off">
            <button class="login-btn" onclick="login()" id="login-btn">Sohbete KatÄ±l</button>
            <div class="error-message" id="login-error"></div>
            <div class="success-message" id="login-success"></div>
            <div style="margin-top: 15px; color: #aaa; font-size: 0.9em;">
                âœ… <strong>TÃœM KOMUTLAR + BAN SÄ°STEMÄ°:</strong><br>
                â€¢ GeliÅŸmiÅŸ Ban/Kick Sistemi ğŸš«<br>
                â€¢ KiÅŸisel mesaj silme ğŸ—‘ï¸<br>
                â€¢ Admin + Co-admin sistemi<br>
                â€¢ Ã–zel sohbet + Resim gÃ¶nderme<br>
                <small>Proje ID: popboxmusicchat</small>
            </div>
        </div>
    </div>
    
    <!-- ANA UYGULAMA -->
    <div class="app-container" id="app">
        <div class="header">
            <div class="header-title">
                <span class="firebase-icon">ğŸ”¥</span>
                ğŸµ Popbox Music
                <span class="admin-badge" id="adminBadge">ğŸ‘‘ ADMIN</span>
                <span class="coadmin-badge" id="coadminBadge">âš¡ CO-ADMIN</span>
            </div>
            <div>
                ğŸ‘¥ <span id="online-count">0</span> online
            </div>
        </div>
        
        <div class="main-content">
            <!-- ONLINE KULLANICILAR -->
            <div class="user-list-sidebar">
                <div class="user-list-title">
                    ğŸŸ¢ Online KullanÄ±cÄ±lar
                    <span id="sidebar-online-count">0</span>
                </div>
                <div id="userListContent">
                    <div style="color:#aaa; text-align:center; padding:20px;">
                        <div class="loading"></div><br>
                        Firebase baÄŸlanÄ±yor...
                    </div>
                </div>
            </div>
            
            <!-- YOUTUBE -->
            <div class="video-section">
                <div class="youtube-placeholder">
                    <div style="font-size: 2em;">ğŸµ</div>
                    <div>Popbox Music Player</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">YouTube Player YÃ¼kleniyor...</div>
                </div>
                <div id="youtube-player"></div>
            </div>
            
            <!-- CHAT -->
            <div class="chat-section">
                <div class="chat-header">
                    <div>ğŸ’¬ Popbox Chat</div>
                    <div class="online-badge">
                        <span id="chat-online-count">0</span> online
                    </div>
                </div>
                
                <div class="messages-container" id="messages">
                    <div class="message system">
                        <strong>ğŸ”¥ TÃ¼m Komutlar + Ban Sistemi Aktif!</strong><br>
                        Komutlar iÃ§in: /yardÄ±m yazÄ±n
                    </div>
                </div>
                
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="Mesaj yazÄ±n veya / komutlarÄ± kullanÄ±n..." autocomplete="off">
                    <button class="action-btn" onclick="sendMessage()">
                        <span>ğŸ“¤</span> GÃ¶nder
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ã–ZEL SOHBET MODALI -->
    <div class="overlay" id="overlay"></div>
    <div class="private-modal" id="privateChat">
        <div class="private-header">
            <span id="privateWith">ğŸ”’ Ã–zel Sohbet</span>
            <button onclick="closePrivateChat()" style="background:none;border:none;color:white;font-size:1.5em;cursor:pointer;">Ã—</button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input-container">
            <input type="text" id="private-input" class="login-input" placeholder="Ã–zel mesaj yazÄ±n..." autocomplete="off">
            <button class="action-btn" onclick="openPrivateImageUpload()" style="background:var(--private);">ğŸ“·</button>
            <button class="action-btn" onclick="sendPrivateMessage()" style="background:var(--private);">ğŸ“¤</button>
        </div>
    </div>
    
    <!-- BAN MODAL -->
    <div class="ban-modal" id="banModal">
        <div class="ban-header">
            <span>ğŸš« KullanÄ±cÄ± Banla</span>
            <button onclick="closeBanModal()" style="background:none;border:none;color:white;font-size:1.5em;cursor:pointer;">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <input type="text" id="ban-username" class="login-input" placeholder="KullanÄ±cÄ± adÄ±" autocomplete="off">
            </div>
            <div style="margin-bottom: 15px;">
                <input type="number" id="ban-duration" class="login-input" placeholder="Ban sÃ¼resi (dakika)" value="5" min="1" max="1440">
            </div>
            <div style="margin-bottom: 20px;">
                <input type="text" id="ban-reason" class="login-input" placeholder="Ban sebebi (opsiyonel)" autocomplete="off">
            </div>
            <button class="login-btn" onclick="executeBan()" style="background:var(--ban-color);">ğŸš« Banla</button>
        </div>
    </div>
    
    <!-- RESÄ°M MODALI -->
    <div class="image-modal" id="imageModal">
        <img id="modalImage" src="" alt="">
        <button onclick="closeImageModal()" style="position:absolute;top:-10px;right:-10px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;">Ã—</button>
    </div>
    
    <!-- GÄ°ZLÄ° DOSYA INPUT -->
    <input type="file" id="imageUpload" accept="image/*" style="display:none;">

    <script>
        // ========== FIREBASE KONFÄ°GÃœRASYONU ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.firebasestorage.app",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835",
            measurementId: "G-SB1K22FLEX"
        };
        
        // ========== FIREBASE BAÅLATMA ==========
        let database;
        let usersRef;
        let messagesRef;
        let privateChatsRef;
        let coAdminsRef;
        let bansRef;
        let isFirebaseConnected = false;
        
        function initializeFirebase() {
            try {
                console.log("ğŸ”¥ Firebase baÅŸlatÄ±lÄ±yor...");
                
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                console.log("âœ… Firebase baÅŸlatÄ±ldÄ±!");
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("âœ… Firebase'e BAÄLANDI!");
                        isFirebaseConnected = true;
                        showLoginSuccess("ğŸ”¥ Firebase baÄŸlantÄ±sÄ± kuruldu!");
                        
                        usersRef = database.ref('onlineUsers');
                        messagesRef = database.ref('messages');
                        privateChatsRef = database.ref('privateChats');
                        coAdminsRef = database.ref('coAdmins');
                        bansRef = database.ref('bans');
                        
                        console.log("âœ… TÃ¼m refs created!");
                        
                        updateBannedUsers();
                        
                        // REAL-TIME BAN TAKÄ°BÄ° BAÅLAT
                        startBanMonitoring();
                    } else {
                        console.log("âŒ Firebase baÄŸlantÄ±sÄ± KESÄ°LDÄ°");
                        isFirebaseConnected = false;
                        showLoginError("Firebase baÄŸlantÄ±sÄ± kesildi!");
                    }
                });
                
            } catch (error) {
                console.error("âŒ Firebase baÅŸlatma hatasÄ±:", error);
                showLoginError("Firebase baÅŸlatma hatasÄ±!");
            }
        }
        
        // ========== GLOBAL DEÄÄ°ÅKENLER ==========
        let currentUser = null;
        let isAdmin = false;
        let isCoAdmin = false;
        let player = null;
        let privateChatWith = null;
        let currentPrivateChatId = null;
        let coAdminList = [];
        let bannedUsers = {};
        
        // Admin bilgileri
        const ADMIN_USERS = ['popbox', 'popboxmusic'];
        const ADMIN_PASSWORDS = {
            'popbox': 'kumsal07@',
            'popboxmusic': 'popbox123'
        };
        
        // ========== REAL-TIME BAN TAKÄ°BÄ° ==========
        function startBanMonitoring() {
            if (!bansRef) return;
            
            // Ban deÄŸiÅŸikliklerini REAL-TIME takip et
            bansRef.on('value', async (snapshot) => {
                const bans = snapshot.val() || {};
                const now = Date.now();
                
                // Her ban deÄŸiÅŸikliÄŸinde kontrol et
                for (const [username, banData] of Object.entries(bans)) {
                    if (banData && banData.bannedUntil > now) {
                        // Bu kullanÄ±cÄ± BANLI, hemen at!
                        await forceKickUser(username);
                    }
                }
            });
            
            console.log("âœ… Real-time ban takibi baÅŸlatÄ±ldÄ±!");
        }
        
        async function forceKickUser(username) {
            try {
                if (!usersRef) return;
                
                // 1. KullanÄ±cÄ±yÄ± online listeden HEMEN kaldÄ±r
                await usersRef.child(username).remove();
                
                // 2. EÄŸer bu kullanÄ±cÄ± ÅŸu an aktifse (aynÄ± tarayÄ±cÄ±da)
                if (currentUser && currentUser.name === username) {
                    // KullanÄ±cÄ±yÄ± HEMEN Ã§Ä±kÄ±ÅŸ yaptÄ±r
                    addSystemMessage("ğŸš« BANLANDINIZ! Sayfadan atÄ±lÄ±yorsunuz...");
                    
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
                
                // 3. Chat'ten de mesaj gÃ¶ndermesini engelle
                addBanMessage(`â›” ${username} kullanÄ±cÄ±sÄ± banlandÄ±ÄŸÄ± iÃ§in atÄ±ldÄ±!`);
                
            } catch (error) {
                console.error("Force kick hatasÄ±:", error);
            }
        }
        
        // ========== YARDIMCI FONKSÄ°YONLAR ==========
        function showLoginError(message) {
            const errorMsg = document.getElementById('login-error');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            
            const successMsg = document.getElementById('login-success');
            successMsg.style.display = 'none';
        }
        
        function showLoginSuccess(message) {
            const successMsg = document.getElementById('login-success');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            
            const errorMsg = document.getElementById('login-error');
            errorMsg.style.display = 'none';
        }
        
        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `<strong>ğŸ¤– Sistem:</strong> ${text}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addBanMessage(text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ban-message';
            messageDiv.innerHTML = `<strong>ğŸš« Ban Sistemi:</strong> ${text}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function generateChatId(user1, user2) {
            const users = [user1, user2].sort();
            return `chat_${users[0]}_${users[1]}`;
        }
        
        function generateFakeIP() {
            return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
        }
        
        // ========== BAN SÄ°STEMÄ° FONKSÄ°YONLARI ==========
        async function checkIfBanned(username) {
            try {
                if (!bansRef) return { isBanned: false };
                
                const banSnapshot = await bansRef.child(username).once('value');
                const banData = banSnapshot.val();
                
                if (banData && banData.bannedUntil > Date.now()) {
                    return {
                        isBanned: true,
                        banData: banData
                    };
                } else if (banData) {
                    await bansRef.child(username).remove();
                }
                
                return { isBanned: false };
            } catch (error) {
                console.error("Ban kontrol hatasÄ±:", error);
                return { isBanned: false };
            }
        }
        
        async function kickUser(username, duration = 5, reason = "Kick komutu") {
            if (!currentUser || (!isAdmin && !isCoAdmin)) {
                addSystemMessage("â›” Yetkiniz yok!");
                return;
            }
            
            if (!username) {
                addSystemMessage("âŒ KullanÄ±cÄ± adÄ± belirtin!");
                return;
            }
            
            if (username === currentUser.name) {
                addSystemMessage("âŒ Kendinizi banlayamazsÄ±nÄ±z!");
                return;
            }
            
            if (ADMIN_USERS.includes(username.toLowerCase())) {
                addSystemMessage("â›” Admin kullanÄ±cÄ±larÄ± banlayamazsÄ±nÄ±z!");
                return;
            }
            
            try {
                const durationNum = parseInt(duration) || 5;
                const banUntil = Date.now() + (durationNum * 60000);
                
                // 1. Ban kaydÄ± oluÅŸtur (REAL-TIME tetiklenecek)
                await bansRef.child(username).set({
                    bannedUntil: banUntil,
                    bannedBy: currentUser.name,
                    reason: reason,
                    timestamp: Date.now(),
                    duration: durationNum
                });
                
                // 2. KullanÄ±cÄ±yÄ± HEMEN online listeden kaldÄ±r
                await usersRef.child(username).remove();
                
                // 3. Sistem mesajÄ±
                addBanMessage(
                    `ğŸš« ${username} kullanÄ±cÄ±sÄ± ${currentUser.name} tarafÄ±ndan ${durationNum} dakika banlandÄ±!\n` +
                    `Sebep: ${reason}`
                );
                
                // 4. Chat mesajÄ± olarak da gÃ¶nder
                const banMessage = {
                    sender: 'Sistem',
                    text: `ğŸš« ${username} kullanÄ±cÄ±sÄ± ${durationNum} dakika banlandÄ±!`,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                    type: 'ban'
                };
                
                await messagesRef.push(banMessage);
                
                // 5. REAL-TIME olarak kullanÄ±cÄ±yÄ± at
                await forceKickUser(username);
                
                console.log(`âœ… ${username} banlandÄ± ve atÄ±ldÄ± (${durationNum} dakika)`);
                
            } catch (error) {
                console.error("Ban hatasÄ±:", error);
                addSystemMessage("âŒ Ban iÅŸlemi baÅŸarÄ±sÄ±z!");
            }
        }
        
        async function unbanUser(username) {
            if (!currentUser || (!isAdmin && !isCoAdmin)) {
                addSystemMessage("â›” Yetkiniz yok!");
                return;
            }
            
            try {
                await bansRef.child(username).remove();
                
                addSystemMessage(`âœ… ${username} kullanÄ±cÄ±sÄ±nÄ±n banÄ± kaldÄ±rÄ±ldÄ±!`);
                
                const unbanMessage = {
                    sender: 'Sistem',
                    text: `ğŸ‰ ${username} kullanÄ±cÄ±sÄ±nÄ±n banÄ± kaldÄ±rÄ±ldÄ±!`,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                    type: 'system'
                };
                
                await messagesRef.push(unbanMessage);
                
                await updateBannedUsers();
                
            } catch (error) {
                console.error("Unban hatasÄ±:", error);
                addSystemMessage("âŒ Ban kaldÄ±rma iÅŸlemi baÅŸarÄ±sÄ±z!");
            }
        }
        
        async function showBanList() {
            try {
                const banSnapshot = await bansRef.once('value');
                const bans = banSnapshot.val() || {};
                
                if (Object.keys(bans).length === 0) {
                    addBanMessage("âœ… Aktif banlÄ± kullanÄ±cÄ± yok!");
                    return;
                }
                
                let banList = "ğŸš« <strong>AKTÄ°F BANLAR:</strong><br><br>";
                const now = Date.now();
                let activeCount = 0;
                
                Object.entries(bans).forEach(([username, banData]) => {
                    if (banData.bannedUntil > now) {
                        activeCount++;
                        const remaining = Math.ceil((banData.bannedUntil - now) / 60000);
                        const by = banData.bannedBy || 'Admin';
                        const reason = banData.reason || 'BelirtilmemiÅŸ';
                        
                        banList += `
                            <strong>${username}</strong><br>
                            â€¢ Kalan SÃ¼re: ${remaining} dakika<br>
                            â€¢ Banlayan: ${by}<br>
                            â€¢ Sebep: ${reason}<br><br>
                        `;
                    }
                });
                
                if (activeCount === 0) {
                    addBanMessage("âœ… Aktif banlÄ± kullanÄ±cÄ± yok!");
                } else {
                    banList += `<em>Toplam ${activeCount} aktif ban</em>`;
                    addBanMessage(banList);
                }
                
            } catch (error) {
                console.error("Ban listesi hatasÄ±:", error);
                addBanMessage("âŒ Ban listesi getirilemedi!");
            }
        }
        
        async function updateBannedUsers() {
            try {
                const banSnapshot = await bansRef.once('value');
                bannedUsers = banSnapshot.val() || {};
                
                const now = Date.now();
                for (const [username, banData] of Object.entries(bannedUsers)) {
                    if (banData.bannedUntil < now) {
                        await bansRef.child(username).remove();
                        console.log(`Ban sÃ¼resi doldu: ${username}`);
                    }
                }
                
            } catch (error) {
                console.error("Ban listesi gÃ¼ncelleme hatasÄ±:", error);
            }
        }
        
        function openBanModal() {
            if (!currentUser || (!isAdmin && !isCoAdmin)) {
                addSystemMessage("â›” Yetkiniz yok!");
                return;
            }
            
            document.getElementById('banModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
        
        function closeBanModal() {
            document.getElementById('banModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        async function executeBan() {
            const username = document.getElementById('ban-username').value.trim();
            const duration = document.getElementById('ban-duration').value;
            const reason = document.getElementById('ban-reason').value.trim() || "BelirtilmemiÅŸ";
            
            if (!username) {
                addSystemMessage("âŒ KullanÄ±cÄ± adÄ± girin!");
                return;
            }
            
            await kickUser(username, duration, reason);
            closeBanModal();
            
            document.getElementById('ban-username').value = '';
            document.getElementById('ban-reason').value = '';
        }
        
        // ========== MESAJ GÃ–NDERME KONTROLÃœ ==========
        async function checkBanBeforeMessage() {
            if (!currentUser || !bansRef) return true;
            
            try {
                const banCheck = await checkIfBanned(currentUser.name);
                if (banCheck.isBanned) {
                    addSystemMessage("ğŸš« BANLANDINIZ! Mesaj gÃ¶nderemezsiniz.");
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Ban kontrol hatasÄ±:", error);
                return true;
            }
        }
        
        // ========== MESAJ SÄ°LME SÄ°STEMÄ° ==========
        async function deleteMessage(messageId) {
            if (!messagesRef || !currentUser) return;
            
            try {
                const snapshot = await messagesRef.child(messageId).once('value');
                const message = snapshot.val();
                
                if (!message) {
                    addSystemMessage('âŒ Mesaj bulunamadÄ±!');
                    return;
                }
                
                const canDelete = message.sender === currentUser.name || isAdmin || isCoAdmin;
                
                if (!canDelete) {
                    addSystemMessage('â›” Sadece kendi mesajlarÄ±nÄ±zÄ± silebilirsiniz!');
                    return;
                }
                
                if (confirm('Bu mesajÄ± silmek istediÄŸinize emin misiniz?')) {
                    await messagesRef.child(messageId).remove();
                    
                    const messageDiv = document.getElementById(`msg_${messageId}`);
                    if (messageDiv) {
                        messageDiv.style.opacity = '0.5';
                        messageDiv.style.textDecoration = 'line-through';
                        messageDiv.innerHTML = '<em style="color:#aaa;">(mesaj silindi)</em>';
                        
                        setTimeout(() => {
                            if (messageDiv.parentNode) {
                                messageDiv.remove();
                            }
                        }, 2000);
                    }
                    
                    console.log(`Mesaj silindi: ${messageId}`);
                }
                
            } catch (error) {
                console.error('Mesaj silme hatasÄ±:', error);
                addSystemMessage('âŒ Mesaj silinemedi!');
            }
        }
        
        async function deletePrivateMessage(messageId, chatId) {
            if (!privateChatsRef || !currentUser || !chatId) return;
            
            try {
                const snapshot = await privateChatsRef.child(chatId).child(messageId).once('value');
                const message = snapshot.val();
                
                if (!message) {
                    alert('Mesaj bulunamadÄ±!');
                    return;
                }
                
                if (message.sender !== currentUser.name) {
                    alert('Sadece kendi mesajlarÄ±nÄ±zÄ± silebilirsiniz!');
                    return;
                }
                
                if (confirm('Bu Ã¶zel mesajÄ± silmek istediÄŸinize emin misiniz?')) {
                    await privateChatsRef.child(chatId).child(messageId).remove();
                    
                    const messageDiv = document.getElementById(`private_msg_${messageId}`);
                    if (messageDiv) {
                        messageDiv.style.opacity = '0.5';
                        messageDiv.style.textDecoration = 'line-through';
                        messageDiv.innerHTML = '<em style="color:#aaa;">(mesaj silindi)</em>';
                        
                        setTimeout(() => {
                            if (messageDiv.parentNode) {
                                messageDiv.remove();
                            }
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('Ã–zel mesaj silme hatasÄ±:', error);
                alert('Ã–zel mesaj silinemedi!');
            }
        }
        
        // ========== GÄ°RÄ°Å SÄ°STEMÄ° ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const nick = nickInput.value.trim();
            const loginBtn = document.getElementById('login-btn');
            
            if (!nick) {
                showLoginError('âŒ LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin!');
                return;
            }
            
            if (nick.length < 2 || nick.length > 20) {
                showLoginError('âŒ KullanÄ±cÄ± adÄ± 2-20 karakter arasÄ±nda olmalÄ±!');
                return;
            }
            
            if (!isFirebaseConnected || !usersRef) {
                showLoginError('âŒ Firebase baÄŸlantÄ±sÄ± yok! LÃ¼tfen bekleyin...');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Firebase kontrol ediliyor...';
            showLoginError('');
            showLoginSuccess('');
            
            try {
                // BAN KONTROLÃœ
                const banCheck = await checkIfBanned(nick);
                if (banCheck.isBanned) {
                    const remaining = Math.ceil((banCheck.banData.bannedUntil - Date.now()) / 60000);
                    showLoginError(
                        `ğŸš« BU KULLANICI BANLI!\n\n` +
                        `KullanÄ±cÄ±: ${nick}\n` +
                        `Ban SÃ¼resi: ${remaining} dakika kaldÄ±\n` +
                        `Banlayan: ${banCheck.banData.bannedBy || 'Admin'}\n` +
                        `Sebep: ${banCheck.banData.reason || 'BelirtilmemiÅŸ'}`
                    );
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sohbete KatÄ±l';
                    return;
                }
                
                const snapshot = await usersRef.child(nick).once('value');
                const existingUser = snapshot.val();
                
                if (existingUser) {
                    const now = Date.now();
                    const lastSeen = existingUser.lastSeen || 0;
                    const timeDiff = now - lastSeen;
                    
                    if (timeDiff < 10000) {
                        const seconds = Math.floor(timeDiff / 1000);
                        showLoginError(
                            `â›” "${nick}" kullanÄ±cÄ±sÄ± ÅU ANDA AKTÄ°F!\n\n` +
                            `Son aktivite: ${seconds} saniye Ã¶nce\n` +
                            `ğŸ’¡ LÃ¼tfen baÅŸka bir kullanÄ±cÄ± adÄ± seÃ§in veya ${10-seconds} sn bekleyin`
                        );
                        
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sohbete KatÄ±l';
                        return;
                    }
                }
                
                const userData = {
                    name: nick,
                    lastSeen: Date.now(),
                    joinedAt: Date.now(),
                    ip: generateFakeIP(),
                    userAgent: navigator.userAgent.substring(0, 80),
                    isOnline: true,
                    timestamp: Date.now(),
                    role: 'user'
                };
                
                await usersRef.child(nick).set(userData);
                
                currentUser = {
                    name: nick,
                    role: 'user',
                    isAdminUser: ADMIN_USERS.includes(nick.toLowerCase()),
                    data: userData
                };
                
                usersRef.child(nick).onDisconnect().remove();
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                initApp();
                
                addSystemMessage(`ğŸ‰ HoÅŸ geldin, ${currentUser.name}!`);
                addSystemMessage('ğŸ’¡ MesajÄ±nÄ±zÄ±n Ã¼zerine gelin â†’ ğŸ—‘ï¸ ile silin');
                
                if (currentUser.isAdminUser) {
                    addSystemMessage('ğŸ”‘ Admin giriÅŸi iÃ§in: /admin [ÅŸifre]');
                }
                
            } catch (error) {
                console.error('GiriÅŸ hatasÄ±:', error);
                showLoginError(`âŒ GiriÅŸ hatasÄ±: ${error.message}`);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sohbete KatÄ±l';
            }
        }
        
        // ========== UYGULAMA BAÅLATMA ==========
        function initApp() {
            console.log("ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor...");
            
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('private-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendPrivateMessage();
            });
            
            document.getElementById('overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePrivateChat();
                    closeImageModal();
                    closeBanModal();
                }
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            if (typeof YT !== 'undefined') {
                initYouTubePlayer();
            }
            
            if (usersRef) {
                usersRef.on('value', (snapshot) => {
                    updateOnlineUsers(snapshot.val());
                });
            }
            
            if (messagesRef) {
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    updateMessages(snapshot.val());
                });
            }
            
            if (coAdminsRef) {
                coAdminsRef.on('value', (snapshot) => {
                    coAdminList = snapshot.val() || [];
                    checkCoAdminStatus();
                });
            }
            
            // KENDÄ° BAN DURUMUNUZU KONTROL ET
            const banCheckInterval = setInterval(async () => {
                if (currentUser && bansRef) {
                    const banCheck = await checkIfBanned(currentUser.name);
                    if (banCheck.isBanned) {
                        addSystemMessage("ğŸš« BANLANDINIZ! Sayfadan atÄ±lÄ±yorsunuz...");
                        clearInterval(banCheckInterval);
                        
                        setTimeout(() => {
                            logout();
                        }, 3000);
                    }
                }
            }, 5000);
            
            setInterval(() => {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now(),
                        isOnline: true
                    });
                }
            }, 5000);
            
            window.addEventListener('beforeunload', function() {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).remove();
                }
            });
            
            console.log("âœ… Uygulama baÅŸlatÄ±ldÄ±!");
        }
        
        // ========== CO-ADMIN KONTROLÃœ ==========
        function checkCoAdminStatus() {
            if (currentUser && coAdminList.includes(currentUser.name)) {
                isCoAdmin = true;
                document.getElementById('coadminBadge').style.display = 'inline-block';
                console.log(`${currentUser.name} co-admin olarak tanÄ±ndÄ±!`);
            }
        }
        
        // ========== ONLINE KULLANICI GÃœNCELLEME ==========
        function updateOnlineUsers(users) {
            if (!users) users = {};
            
            const now = Date.now();
            let onlineCount = 0;
            const activeUsers = [];
            
            Object.entries(users).forEach(([username, userData]) => {
                if (!userData) return;
                
                const timeDiff = now - (userData.lastSeen || 0);
                const secondsAgo = Math.floor(timeDiff / 1000);
                
                if (secondsAgo < 30) {
                    onlineCount++;
                    activeUsers.push({
                        username: username,
                        ...userData,
                        secondsAgo: secondsAgo
                    });
                }
            });
            
            document.getElementById('online-count').textContent = onlineCount;
            document.getElementById('chat-online-count').textContent = onlineCount;
            document.getElementById('sidebar-online-count').textContent = onlineCount;
            
            updateUserList(activeUsers);
        }
        
        function updateUserList(users) {
            const container = document.getElementById('userListContent');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">HenÃ¼z kimse online deÄŸil</div>';
                return;
            }
            
            users.sort((a, b) => a.secondsAgo - b.secondsAgo);
            
            let html = '';
            users.forEach(user => {
                const isCurrentUser = user.username === (currentUser?.name || '');
                const statusClass = user.secondsAgo > 10 ? 'idle' : '';
                const isAdminUser = ADMIN_USERS.includes(user.username.toLowerCase());
                const isCoAdminUser = coAdminList.includes(user.username);
                const isBanned = bannedUsers[user.username] && bannedUsers[user.username].bannedUntil > Date.now();
                
                let badge = '';
                if (isAdminUser) badge = 'ğŸ‘‘';
                else if (isCoAdminUser) badge = 'âš¡';
                
                html += `
                    <div class="user-item ${statusClass} ${isBanned ? 'banned' : ''}" onclick="openPrivateChat('${user.username}')">
                        <div class="user-status">
                            <span class="status-dot ${isBanned ? 'status-banned' : (user.secondsAgo > 10 ? 'status-idle' : 'status-online')}"></span>
                            <strong>${isCurrentUser ? 'ğŸ‘¤ ' : ''}${badge} ${user.username} ${isBanned ? 'ğŸš«' : ''}</strong>
                        </div>
                        <div style="font-size:0.8em; color:#aaa;">
                            ${user.secondsAgo < 5 ? 'Åimdi' : user.secondsAgo + 'sn'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ========== Ã–ZEL SOHBET SÄ°STEMÄ° ==========
        function openPrivateChat(username) {
            if (username === currentUser.name) {
                addSystemMessage('Kendinle Ã¶zel sohbet baÅŸlatamazsÄ±n!');
                return;
            }
            
            privateChatWith = username;
            currentPrivateChatId = generateChatId(currentUser.name, username);
            
            document.getElementById('privateWith').textContent = `ğŸ”’ ${username} ile Ã¶zel sohbet`;
            document.getElementById('privateChat').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
            
            loadPrivateMessages();
            
            setTimeout(() => {
                document.getElementById('private-input').focus();
            }, 100);
        }
        
        function closePrivateChat() {
            privateChatWith = null;
            currentPrivateChatId = null;
            document.getElementById('privateChat').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('private-input').value = '';
        }
        
        function loadPrivateMessages() {
            if (!currentPrivateChatId || !privateChatsRef) return;
            
            const container = document.getElementById('privateMessages');
            container.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">Ã–zel mesajlar yÃ¼kleniyor...</div>';
            
            privateChatsRef.child(currentPrivateChatId).limitToLast(50).on('value', (snapshot) => {
                const messages = snapshot.val();
                updatePrivateMessages(messages);
            });
        }
        
        function updatePrivateMessages(messages) {
            const container = document.getElementById('privateMessages');
            
            if (!messages) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen gÃ¶nder!</div>';
                return;
            }
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({
                    id: messageId,
                    ...value
                });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = '';
            
            messagesArray.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message private-msg';
                messageDiv.id = `private_msg_${msg.id}`;
                
                let deleteButton = '';
                if (currentUser && msg.sender === currentUser.name) {
                    deleteButton = `<button class="delete-btn" onclick="deletePrivateMessage('${msg.id}', '${currentPrivateChatId}')">ğŸ—‘ï¸</button>`;
                }
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="message-image" onclick="showImage('${msg.image}')">`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user">
                            ${msg.sender === currentUser.name ? 'ğŸ‘¤ ' : ''}${msg.sender}
                        </span>
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div>${content}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        async function sendPrivateMessage() {
            if (!privateChatWith || !currentPrivateChatId || !privateChatsRef) return;
            
            // Ban kontrolÃ¼
            const canSend = await checkBanBeforeMessage();
            if (!canSend) return;
            
            const input = document.getElementById('private-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const messageData = {
                sender: currentUser.name,
                receiver: privateChatWith,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            try {
                await privateChatsRef.child(currentPrivateChatId).push(messageData);
                input.value = '';
                input.focus();
                
                if (usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now()
                    });
                }
                
            } catch (error) {
                console.error('Ã–zel mesaj hatasÄ±:', error);
                alert('Ã–zel mesaj gÃ¶nderilemedi!');
            }
        }
        
        // ========== GÃ–RSEL GÃ–NDERME ==========
        function openPrivateImageUpload() {
            if (!privateChatWith) {
                alert('Ã–nce bir kullanÄ±cÄ± ile Ã¶zel sohbette olmalÄ±sÄ±nÄ±z!');
                return;
            }
            
            document.getElementById('imageUpload').click();
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('LÃ¼tfen sadece resim dosyasÄ± seÃ§in!');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                alert('Resim Ã§ok bÃ¼yÃ¼k! Maksimum 2MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                const imageData = event.target.result;
                
                if (privateChatWith && currentPrivateChatId && privateChatsRef) {
                    const messageData = {
                        sender: currentUser.name,
                        receiver: privateChatWith,
                        text: 'ğŸ“¸ Resim gÃ¶nderdi',
                        image: imageData,
                        timestamp: Date.now(),
                        time: new Date().toLocaleTimeString('tr-TR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })
                    };
                    
                    try {
                        await privateChatsRef.child(currentPrivateChatId).push(messageData);
                    } catch (error) {
                        console.error('Resim gÃ¶nderme hatasÄ±:', error);
                        alert('Resim gÃ¶nderilemedi!');
                    }
                }
            };
            
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        
        function showImage(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        // ========== GENEL MESAJ SÄ°STEMÄ° ==========
        async function sendMessage() {
            // Ban kontrolÃ¼
            const canSend = await checkBanBeforeMessage();
            if (!canSend) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
            } else {
                const messageData = {
                    sender: currentUser.name,
                    text: text,
                    type: isAdmin ? 'admin' : (isCoAdmin ? 'coadmin' : 'user'),
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })
                };
                
                try {
                    if (messagesRef) {
                        await messagesRef.push(messageData);
                        
                        if (usersRef) {
                            usersRef.child(currentUser.name).update({
                                lastSeen: Date.now()
                            });
                        }
                    }
                } catch (error) {
                    console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
                }
            }
            
            input.value = '';
            input.focus();
        }
        
        function updateMessages(messages) {
            const container = document.getElementById('messages');
            
            if (!messages) return;
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({
                    id: messageId,
                    ...value
                });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            const recentMessages = messagesArray.slice(-50);
            
            container.innerHTML = '';
            
            recentMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type || 'user'}`;
                messageDiv.id = `msg_${msg.id}`;
                
                let deleteButton = '';
                if (currentUser && 
                    (msg.sender === currentUser.name || isAdmin || isCoAdmin)) {
                    deleteButton = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸</button>`;
                }
                
                const userHtml = `<span class="message-user" onclick="openPrivateChat('${msg.sender}')">
                    ${msg.type === 'admin' ? 'ğŸ‘‘ ' : msg.type === 'coadmin' ? 'âš¡ ' : ''}${msg.sender}
                </span>`;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${userHtml}
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div>${msg.text}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== TÃœM KOMUT SÄ°STEMÄ° ==========
        async function handleCommand(cmd) {
            // Ban kontrolÃ¼
            const canSend = await checkBanBeforeMessage();
            if (!canSend) return;
            
            const parts = cmd.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(command) {
                // ğŸ” ADMIN GÄ°RÄ°Å
                case 'admin':
                    if (args.length === 1) {
                        await checkAdminPassword(args[0]);
                    } else {
                        addSystemMessage('KullanÄ±m: /admin [ÅŸifre]');
                    }
                    break;
                    
                // ğŸ‘¥ CO-ADMIN YÃ–NETÄ°MÄ°
                case 'coadmin':
                    if (isAdmin && args.length === 1) {
                        await makeCoAdmin(args[0]);
                    } else if (!isAdmin) {
                        addSystemMessage('â›” Sadece adminler co-admin ekleyebilir!');
                    } else {
                        addSystemMessage('KullanÄ±m: /coadmin [kullanÄ±cÄ±-adÄ±]');
                    }
                    break;
                    
                case 'removecoadmin':
                    if (isAdmin && args.length === 1) {
                        await removeCoAdmin(args[0]);
                    } else if (!isAdmin) {
                        addSystemMessage('â›” Sadece adminler co-admin kaldÄ±rabilir!');
                    } else {
                        addSystemMessage('KullanÄ±m: /removecoadmin [kullanÄ±cÄ±-adÄ±]');
                    }
                    break;
                    
                // ğŸ—‘ï¸ Ä°Ã‡ERÄ°K TEMÄ°ZLEME
                case 'temizle':
                    if (isAdmin || isCoAdmin) {
                        try {
                            if (messagesRef) {
                                await messagesRef.remove();
                                addSystemMessage('ğŸ—‘ï¸ TÃ¼m mesajlar temizlendi!');
                                
                                const systemMsg = {
                                    sender: 'Sistem',
                                    text: `${currentUser.name} tÃ¼m mesajlarÄ± temizledi!`,
                                    type: isAdmin ? 'admin' : 'coadmin',
                                    timestamp: Date.now(),
                                    time: new Date().toLocaleTimeString('tr-TR', { 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })
                                };
                                await messagesRef.push(systemMsg);
                            }
                        } catch (error) {
                            console.error('Temizleme hatasÄ±:', error);
                            addSystemMessage('âŒ Temizleme hatasÄ±!');
                        }
                    } else {
                        addSystemMessage('â›” Yetkiniz yok!');
                    }
                    break;
                    
                // ğŸš« BAN KOMUTLARI
                case 'ban':
                    if ((isAdmin || isCoAdmin) && args.length >= 1) {
                        const username = args[0];
                        const duration = args[1] || 5;
                        const reason = args.slice(2).join(' ') || "BelirtilmemiÅŸ";
                        await kickUser(username, duration, reason);
                    } else {
                        addSystemMessage('KullanÄ±m: /ban [kullanÄ±cÄ±] [dakika] [sebep]');
                    }
                    break;
                    
                case 'kick':
                    if ((isAdmin || isCoAdmin) && args.length >= 1) {
                        const username = args[0];
                        const duration = args[1] || 5;
                        const reason = args.slice(2).join(' ') || "BelirtilmemiÅŸ";
                        await kickUser(username, duration, reason);
                    } else {
                        addSystemMessage('KullanÄ±m: /kick [kullanÄ±cÄ±] [dakika] [sebep]');
                    }
                    break;
                    
                case 'unban':
                    if ((isAdmin || isCoAdmin) && args.length === 1) {
                        await unbanUser(args[0]);
                    } else {
                        addSystemMessage('KullanÄ±m: /unban [kullanÄ±cÄ±]');
                    }
                    break;
                    
                case 'banlist':
                    await showBanList();
                    break;
                    
                case 'banpanel':
                    openBanModal();
                    break;
                    
                // ğŸ†” ID Ä°LE MESAJ SÄ°LME
                case 'sil':
                    if ((isAdmin || isCoAdmin) && args.length === 1) {
                        await deleteMessage(args[0]);
                    } else if (!isAdmin && !isCoAdmin) {
                        addSystemMessage('â›” Sadece admin/co-admin ID ile mesaj silebilir!');
                    } else {
                        addSystemMessage('KullanÄ±m: /sil [mesaj-id] (sadece admin/co-admin)');
                    }
                    break;
                    
                // ğŸ‘¥ KULLANICI LÄ°STESÄ°
                case 'kullanÄ±cÄ±lar':
                case 'users':
                    await showFirebaseUsers();
                    break;
                    
                case 'list':
                case 'online':
                    await showFirebaseUsers();
                    break;
                    
                // â„¹ï¸ YARDIM
                case 'yardÄ±m':
                case 'help':
                case 'komutlar':
                    showHelp();
                    break;
                    
                // ğŸ”¥ FIREBASE BÄ°LGÄ°
                case 'firebase':
                case 'fb':
                case 'info':
                    addSystemMessage('ğŸ”¥ Firebase Realtime Database aktif!');
                    addSystemMessage(`ğŸ“Š Proje: ${firebaseConfig.projectId}`);
                    addSystemMessage(`ğŸ‘¤ Online: ${document.getElementById('online-count').textContent}`);
                    addSystemMessage(`ğŸ” Durum: ${isFirebaseConnected ? 'âœ… BaÄŸlÄ±' : 'âŒ BaÄŸlÄ± DeÄŸil'}`);
                    break;
                    
                // ğŸ“ PÄ°NG TEST
                case 'ping':
                    addSystemMessage('ğŸ“ Pong! BaÄŸlantÄ± aktif.');
                    break;
                    
                // ğŸšª Ã‡IKIÅ
                case 'Ã§Ä±kÄ±ÅŸ':
                case 'exit':
                case 'logout':
                case 'quit':
                    logout();
                    break;
                    
                default:
                    addSystemMessage(`âŒ Bilinmeyen komut: ${command}`);
            }
        }
        
        async function checkAdminPassword(password) {
            if (!currentUser?.isAdminUser) {
                addSystemMessage('âŒ Bu kullanÄ±cÄ± admin deÄŸil!');
                return;
            }
            
            const correctPassword = ADMIN_PASSWORDS[currentUser.name.toLowerCase()];
            if (password === correctPassword) {
                isAdmin = true;
                currentUser.role = 'admin';
                document.getElementById('adminBadge').style.display = 'inline-block';
                
                document.body.style.border = '5px solid red';
                document.body.style.boxShadow = '0 0 30px rgba(255,0,0,0.5)';
                
                addSystemMessage('âœ… Admin giriÅŸi baÅŸarÄ±lÄ±!');
                addSystemMessage('âš¡ Co-admin eklemek iÃ§in: /coadmin [kullanÄ±cÄ±-adÄ±]');
                addSystemMessage('ğŸš« Ban komutlarÄ±: /ban [kullanÄ±cÄ±] [dakika] [sebep]');
            } else {
                addSystemMessage('âŒ HatalÄ± ÅŸifre!');
            }
        }
        
        async function makeCoAdmin(username) {
            try {
                if (!coAdminsRef) return;
                
                const snapshot = await coAdminsRef.once('value');
                let coAdmins = snapshot.val() || [];
                
                if (!Array.isArray(coAdmins)) {
                    coAdmins = [];
                }
                
                if (!coAdmins.includes(username)) {
                    coAdmins.push(username);
                    await coAdminsRef.set(coAdmins);
                    addSystemMessage(`âœ… ${username} co-admin yapÄ±ldÄ±!`);
                    
                    const messageData = {
                        sender: 'Sistem',
                        text: `ğŸ‰ ${username} artÄ±k co-admin!`,
                        type: 'system',
                        timestamp: Date.now(),
                        time: new Date().toLocaleTimeString('tr-TR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })
                    };
                    
                    if (messagesRef) {
                        await messagesRef.push(messageData);
                    }
                } else {
                    addSystemMessage(`â„¹ï¸ ${username} zaten co-admin!`);
                }
            } catch (error) {
                console.error('Co-admin ekleme hatasÄ±:', error);
                addSystemMessage('âŒ Co-admin eklenemedi!');
            }
        }
        
        async function removeCoAdmin(username) {
            try {
                if (!coAdminsRef) return;
                
                const snapshot = await coAdminsRef.once('value');
                let coAdmins = snapshot.val() || [];
                
                if (!Array.isArray(coAdmins)) {
                    coAdmins = [];
                }
                
                const index = coAdmins.indexOf(username);
                if (index > -1) {
                    coAdmins.splice(index, 1);
                    await coAdminsRef.set(coAdmins);
                    addSystemMessage(`âœ… ${username} co-admin'lÄ±ktan kaldÄ±rÄ±ldÄ±!`);
                } else {
                    addSystemMessage(`â„¹ï¸ ${username} co-admin deÄŸil!`);
                }
            } catch (error) {
                console.error('Co-admin kaldÄ±rma hatasÄ±:', error);
                addSystemMessage('âŒ Co-admin kaldÄ±rÄ±lamadÄ±!');
            }
        }
        
        async function showFirebaseUsers() {
            try {
                if (!usersRef) {
                    addSystemMessage('âŒ Firebase baÄŸlantÄ±sÄ± yok!');
                    return;
                }
                
                const snapshot = await usersRef.once('value');
                const users = snapshot.val() || {};
                
                let userList = 'ğŸ”¥ <strong>Online KullanÄ±cÄ±lar:</strong><br>';
                const now = Date.now();
                let onlineCount = 0;
                
                Object.entries(users).forEach(([username, userData]) => {
                    if (!userData) return;
                    
                    const timeDiff = now - (userData.lastSeen || 0);
                    const secondsAgo = Math.floor(timeDiff / 1000);
                    
                    if (secondsAgo < 30) {
                        onlineCount++;
                        const status = secondsAgo < 10 ? 'ğŸŸ¢' : 'ğŸŸ¡';
                        const isAdminUser = ADMIN_USERS.includes(username.toLowerCase());
                        const isCoAdminUser = coAdminList.includes(username);
                        const isBanned = bannedUsers[username] && bannedUsers[username].bannedUntil > now;
                        
                        let badge = '';
                        if (isAdminUser) badge = 'ğŸ‘‘';
                        else if (isCoAdminUser) badge = 'âš¡';
                        else if (isBanned) badge = 'ğŸš«';
                        
                        userList += `${status} ${badge} ${username} (${secondsAgo}sn Ã¶nce)<br>`;
                    }
                });
                
                userList += `<br>Toplam: ${onlineCount} online kullanÄ±cÄ±`;
                addSystemMessage(userList);
            } catch (error) {
                addSystemMessage('âŒ KullanÄ±cÄ±larÄ± getirirken hata!');
            }
        }
        
        function showHelp() {
            let help = 'ğŸ”¥ <strong>TÃœM KOMUTLAR:</strong><br><br>';
            
            help += 'ğŸ‘‘ <strong>ADMIN KOMUTLARI:</strong><br>';
            help += 'â€¢ /admin [ÅŸifre] - Admin giriÅŸi<br>';
            help += 'â€¢ /coadmin [kullanÄ±cÄ±] - Co-admin yap<br>';
            help += 'â€¢ /removecoadmin [kullanÄ±cÄ±] - Co-admin kaldÄ±r<br>';
            help += 'â€¢ /temizle - TÃ¼m mesajlarÄ± temizle<br>';
            help += 'â€¢ /ban [kullanÄ±cÄ±] [dakika] [sebep] - SÃ¼reli ban<br>';
            help += 'â€¢ /kick [kullanÄ±cÄ±] [dakika] [sebep] - SÃ¼reli ban<br>';
            help += 'â€¢ /unban [kullanÄ±cÄ±] - Ban kaldÄ±r<br>';
            help += 'â€¢ /banlist - Aktif banlarÄ± gÃ¶ster<br>';
            help += 'â€¢ /banpanel - Ban panelini aÃ§<br>';
            help += 'â€¢ /sil [mesaj-id] - MesajÄ± ID ile sil<br><br>';
            
            help += 'âš¡ <strong>CO-ADMIN KOMUTLARI:</strong><br>';
            help += 'â€¢ /temizle - TÃ¼m mesajlarÄ± temizle<br>';
            help += 'â€¢ /ban [kullanÄ±cÄ±] [dakika] [sebep] - SÃ¼reli ban<br>';
            help += 'â€¢ /kick [kullanÄ±cÄ±] [dakika] [sebep] - SÃ¼reli ban<br>';
            help += 'â€¢ /unban [kullanÄ±cÄ±] - Ban kaldÄ±r<br>';
            help += 'â€¢ /banlist - Aktif banlarÄ± gÃ¶ster<br>';
            help += 'â€¢ /sil [mesaj-id] - MesajÄ± ID ile sil<br><br>';
            
            help += 'ğŸ‘¤ <strong>HERKES Ä°Ã‡Ä°N:</strong><br>';
            help += 'â€¢ /kullanÄ±cÄ±lar - Online kullanÄ±cÄ±larÄ± gÃ¶ster<br>';
            help += 'â€¢ /yardÄ±m - Bu mesajÄ± gÃ¶ster<br>';
            help += 'â€¢ /firebase - Firebase bilgileri<br>';
            help += 'â€¢ /ping - BaÄŸlantÄ± testi<br>';
            help += 'â€¢ /Ã§Ä±kÄ±ÅŸ - Ã‡Ä±kÄ±ÅŸ yap<br><br>';
            
            help += 'ğŸ’¡ <strong>Ã–ZELLÄ°KLER:</strong><br>';
            help += 'â€¢ MesajÄ±nÄ±zÄ±n Ã¼zerine gelin â†’ ğŸ—‘ï¸ ile silin<br>';
            help += 'â€¢ KullanÄ±cÄ± adÄ±na tÄ±kla â†’ Ã–zel sohbet<br>';
            help += 'â€¢ Ã–zel sohbette ğŸ“· â†’ Resim gÃ¶nder<br>';
            help += 'â€¢ GerÃ§ek zamanlÄ± nick kontrolÃ¼<br>';
            help += 'â€¢ GeliÅŸmiÅŸ Ban/Kick sistemi ğŸš«';
            
            addSystemMessage(help);
        }
        
        async function logout() {
            if (currentUser && usersRef) {
                try {
                    await usersRef.child(currentUser.name).remove();
                } catch (error) {
                    console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±:', error);
                }
            }
            
            location.reload();
        }
        
        // ========== YOUTUBE PLAYER ==========
        function initYouTubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) {
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: 'i75BZYOAPl4',
                    playerVars: {
                        'autoplay': 1,
                        'controls': 1,
                        'rel': 0,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': function(event) {
                            document.querySelector('.youtube-placeholder').style.display = 'none';
                            event.target.playVideo();
                        }
                    }
                });
            }
        }
        
        // ========== SAYFA YÃœKLENDÄ°ÄÄ°NDE ==========
        window.addEventListener('load', function() {
            console.log("ğŸ“± Sayfa yÃ¼klendi!");
            
            initializeFirebase();
            
            document.getElementById('login-nick').focus();
            
            document.getElementById('login-nick').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            function onYouTubeIframeAPIReady() {
                console.log("ğŸ¬ YouTube API hazÄ±r!");
                initYouTubePlayer();
            }
            window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
            
            console.log("âœ… TÃ¼m scriptler yÃ¼klendi!");
        });
    </script>
    
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
