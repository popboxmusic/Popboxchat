<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CetCety Â· REAL-TIME TEST</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: #111; color: #ddd; height: 100vh; overflow: hidden; }
        
        /* BASÄ°T GRÄ° TEMA - KUTUCUK YOK */
        .app {
            display: grid;
            grid-template-columns: 70px 200px 1fr 300px;
            height: 100vh;
        }
        
        .panel { background: #1a1a1a; border-right: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; }
        .icon-panel { align-items: center; padding: 20px 0; }
        .icon-item { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: #888; cursor: pointer; margin: 10px 0; border-radius: 8px; }
        .icon-item:hover { background: #333; color: #fff; }
        
        .chat-area { display: flex; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid #333; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* MESAJLAR - KUTUCUK YOK, SADECE METÄ°N */
        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 4px 0;
            border-bottom: 1px solid #2a2a2a;
            font-size: 14px;
        }
        .msg-time { color: #666; min-width: 45px; }
        .msg-sender { color: #aaa; min-width: 100px; cursor: pointer; }
        .msg-sender:hover { text-decoration: underline; }
        .msg-text { color: #ccc; word-break: break-word; flex: 1; }
        
        .chat-input { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
        .chat-input textarea { flex: 1; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 10px; color: #fff; resize: none; }
        .chat-input button { width: 40px; height: 40px; border-radius: 50%; background: #333; border: none; color: #fff; cursor: pointer; }
        
        .private-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 500px; background: #1a1a1a; border: 1px solid #444;
            border-radius: 12px; display: none; flex-direction: column; z-index: 2000;
        }
        .private-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .private-messages { flex: 1; overflow-y: auto; padding: 15px; }
        .private-input { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; align-items: center; justify-content: center; z-index: 3000;
        }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 12px; width: 300px; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 6px; }
        .login-box button { width: 100%; padding: 10px; background: #333; border: none; color: #fff; cursor: pointer; border-radius: 6px; }
        
        .video-container { aspect-ratio: 16/9; background: #000; margin: 10px; border-radius: 8px; overflow: hidden; }
        #youtube-player { width: 100%; height: 100%; }
        
        .online-item, .chat-item { padding: 8px; margin: 4px; background: #2a2a2a; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h3 style="color:#888; text-align:center;">CetCety</h3>
            <input type="text" id="nickInput" placeholder="KullanÄ±cÄ± adÄ±">
            <button onclick="login()">GÄ°RÄ°Åž</button>
            <div id="loginError" style="color:#f66; margin-top:10px; display:none;"></div>
        </div>
    </div>

    <div class="app" id="mainApp" style="display:none;">
        <!-- Ä°kon panel -->
        <div class="panel icon-panel">
            <div class="icon-item" onclick="switchTab('online')"><i class="fas fa-home"></i></div>
        </div>
        
        <!-- Online/OnChat panel -->
        <div class="panel">
            <div style="display:flex; border-bottom:1px solid #333;">
                <div style="flex:1; padding:10px; text-align:center; cursor:pointer; background:#2a2a2a;" id="tabOnlineBtn" onclick="switchTab('online')">Online</div>
                <div style="flex:1; padding:10px; text-align:center; cursor:pointer;" id="tabOnchatBtn" onclick="switchTab('onchat')">OnChat</div>
            </div>
            <div style="flex:1; overflow-y:auto; padding:10px;" id="panelContent"></div>
        </div>
        
        <!-- Sohbet alanÄ± -->
        <div class="panel chat-area">
            <div class="chat-header">
                <span>#genel</span>
                <span style="margin-left:auto; color:#888;" id="onlineCount">0</span>
            </div>
            <div class="messages" id="messages"></div>
            <div class="chat-input">
                <textarea id="messageInput" rows="1" placeholder="Mesaj..."></textarea>
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        
        <!-- Medya paneli -->
        <div class="panel">
            <div style="padding:15px; border-bottom:1px solid #333;">YouTube</div>
            <div class="video-container">
                <div id="youtube-player"></div>
            </div>
        </div>
    </div>

    <!-- Ã–zel sohbet modal -->
    <div class="private-modal" id="privateModal">
        <div class="private-header">
            <span id="privateWith">Ã–zel Sohbet</span>
            <button onclick="closePrivateChat()" style="background:none; border:none; color:#fff; font-size:20px;">Ã—</button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input">
            <input type="file" id="privateFile" accept="image/*,video/*" style="display:none;">
            <button onclick="document.getElementById('privateFile').click()" style="background:#333; border:none; color:#fff; width:40px; border-radius:50%;"><i class="fas fa-paperclip"></i></button>
            <textarea id="privateInput" rows="1" placeholder="Mesaj..." style="flex:1; background:#2a2a2a; border:1px solid #444; color:#fff; padding:8px; border-radius:6px;"></textarea>
            <button onclick="sendPrivateMessage()" style="background:#333; border:none; color:#fff; width:40px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div id="overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:1999;" onclick="closePrivateChat()"></div>

    <script>
        // ========== FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        // Firebase baÅŸlat
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // ========== DEÄžÄ°ÅžKENLER ==========
        let currentUser = null;
        let usersRef = db.ref('onlineUsers');
        let messagesRef = db.ref('messages');
        let privateChatsRef = db.ref('privateChats');
        
        let privateWith = null;
        let privateChatId = null;
        let onlineUsers = {};
        let activeChats = {}; // Sadece RAM'de, localStorage yok!
        let currentTab = 'online';

        // ========== GÄ°RÄ°Åž ==========
        window.login = function() {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            
            currentUser = { name: nick };
            
            // Online kaydet
            usersRef.child(nick).set({
                name: nick,
                lastSeen: Date.now()
            });
            usersRef.child(nick).onDisconnect().remove();
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'grid';
            
            initApp();
        };

        // ========== UYGULAMA ==========
        function initApp() {
            // YouTube
            if (typeof YT !== 'undefined') initYT();
            
            // Online kullanÄ±cÄ±lar - REAL-TIME
            usersRef.on('value', (snap) => {
                const users = snap.val() || {};
                const now = Date.now();
                const active = {};
                
                Object.entries(users).forEach(([name, data]) => {
                    if (now - (data.lastSeen || 0) < 10000) { // 10 saniye
                        active[name] = data;
                    }
                });
                
                onlineUsers = active;
                document.getElementById('onlineCount').textContent = Object.keys(active).length;
                updatePanel();
            });
            
            // Genel mesajlar - REAL-TIME
            messagesRef.limitToLast(50).on('value', (snap) => {
                const msgs = snap.val() || {};
                const container = document.getElementById('messages');
                container.innerHTML = '';
                
                Object.entries(msgs)
                    .sort((a, b) => a[1].timestamp - b[1].timestamp)
                    .forEach(([id, msg]) => {
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `
                            <span class="msg-time">${msg.time || '--:--'}</span>
                            <span class="msg-sender" onclick="openPrivate('${msg.sender}')">${msg.sender}</span>
                            <span class="msg-text">${msg.text || ''}</span>
                        `;
                        container.appendChild(div);
                    });
                container.scrollTop = container.scrollHeight;
            });
            
            // Heartbeat - her 3 saniyede
            setInterval(() => {
                if (currentUser) {
                    usersRef.child(currentUser.name).update({ lastSeen: Date.now() });
                }
            }, 3000);
        }

        // ========== YOUTUBE ==========
        function initYT() {
            new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                videoId: 'i75BZYOAPl4',
                playerVars: { autoplay: 1, controls: 1 }
            });
        }

        // ========== MESAJ GÃ–NDER ==========
        window.sendMessage = function() {
            if (!currentUser) return;
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            messagesRef.push({
                sender: currentUser.name,
                text: text,
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            });
            input.value = '';
        };

        // ========== Ã–ZEL SOHBET ==========
        window.openPrivate = function(username) {
            if (username === currentUser?.name) return;
            
            privateWith = username;
            privateChatId = [currentUser.name, username].sort().join('_');
            
            document.getElementById('privateWith').textContent = `ðŸ”’ ${username}`;
            document.getElementById('privateModal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
            
            // OnChat'e ekle (sadece RAM)
            activeChats[username] = {
                lastMessage: Date.now(),
                name: username
            };
            updatePanel();
            
            // Ã–zel mesajlarÄ± yÃ¼kle - REAL-TIME
            const container = document.getElementById('privateMessages');
            
            privateChatsRef.child(privateChatId).limitToLast(50).on('value', (snap) => {
                const msgs = snap.val() || {};
                container.innerHTML = '';
                
                Object.entries(msgs)
                    .sort((a, b) => a[1].timestamp - b[1].timestamp)
                    .forEach(([id, msg]) => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.gap = '10px';
                        div.style.padding = '4px 0';
                        div.style.borderBottom = '1px solid #2a2a2a';
                        
                        let content = '';
                        if (msg.type === 'text') {
                            content = msg.text;
                        } else if (msg.type === 'image') {
                            content = `<img src="${msg.url}" style="max-width:200px; max-height:150px; border-radius:4px;" onclick="window.open('${msg.url}')">`;
                        } else if (msg.type === 'video') {
                            content = `<video src="${msg.url}" style="max-width:200px; max-height:150px;" controls></video>`;
                        }
                        
                        div.innerHTML = `
                            <span style="color:#666; min-width:45px;">${msg.time || '--:--'}</span>
                            <span style="color:#aaa; min-width:80px;">${msg.sender}</span>
                            <span style="color:#ccc;">${content}</span>
                        `;
                        container.appendChild(div);
                    });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closePrivateChat = function() {
            privateWith = null;
            privateChatId = null;
            document.getElementById('privateModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            
            // Listener'Ä± kaldÄ±r
            if (privateChatId) {
                privateChatsRef.child(privateChatId).off();
            }
        };

        window.sendPrivateMessage = function() {
            if (!privateWith || !privateChatId) return;
            const input = document.getElementById('privateInput');
            const text = input.value.trim();
            if (!text) return;
            
            privateChatsRef.child(privateChatId).push({
                sender: currentUser.name,
                text: text,
                type: 'text',
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            });
            input.value = '';
        };

        // ========== MEDYA YÃœKLE (RESÄ°M + VÄ°DEO) ==========
        document.getElementById('privateFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !privateWith) {
                alert('Ã–nce bir kullanÄ±cÄ± seÃ§in!');
                return;
            }
            
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (!isImage && !isVideo) {
                alert('Sadece resim veya video dosyasÄ±!');
                return;
            }
            
            // Storage'a yÃ¼kle
            const fileName = `${Date.now()}_${file.name}`;
            const storageRef = storage.ref(`private/${fileName}`);
            
            storageRef.put(file).then((snapshot) => {
                return snapshot.ref.getDownloadURL();
            }).then((url) => {
                return privateChatsRef.child(privateChatId).push({
                    sender: currentUser.name,
                    url: url,
                    type: isImage ? 'image' : 'video',
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                    timestamp: Date.now()
                });
            }).catch((error) => {
                console.error('YÃ¼kleme hatasÄ±:', error);
                alert('Dosya yÃ¼klenemedi! Firebase Storage kurallarÄ±nÄ± kontrol edin.');
            });
            
            e.target.value = '';
        });

        // ========== PANEL ==========
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tabOnlineBtn').style.background = tab === 'online' ? '#2a2a2a' : 'transparent';
            document.getElementById('tabOnchatBtn').style.background = tab === 'onchat' ? '#2a2a2a' : 'transparent';
            updatePanel();
        };

        function updatePanel() {
            const content = document.getElementById('panelContent');
            
            if (currentTab === 'online') {
                let html = '<div style="color:#888; margin:10px 0;">Ã‡EVRÄ°MÄ°Ã‡Ä°</div>';
                let has = false;
                
                Object.keys(onlineUsers).forEach(u => {
                    if (u !== currentUser?.name) {
                        has = true;
                        html += `<div class="online-item" onclick="openPrivate('${u}')">${u}</div>`;
                    }
                });
                
                if (!has) html += '<div style="color:#666; padding:20px; text-align:center;">Kimse yok</div>';
                content.innerHTML = html;
                
            } else {
                let html = '<div style="color:#888; margin:10px 0;">KONUÅžULANLAR</div>';
                const ids = Object.keys(activeChats).sort((a,b) => activeChats[b].lastMessage - activeChats[a].lastMessage);
                
                if (ids.length === 0) {
                    html += '<div style="color:#666; padding:20px; text-align:center;">Yok</div>';
                }
                
                ids.forEach(id => {
                    html += `<div class="chat-item" onclick="openPrivate('${id}')">
                        <i class="fas fa-comment" style="margin-right:8px;"></i>${id}
                    </div>`;
                });
                
                content.innerHTML = html;
            }
        }

        // ========== YARDIMCI ==========
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('privateInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendPrivateMessage();
            }
        });

        window.onYouTubeIframeAPIReady = initYT;
    </script>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
