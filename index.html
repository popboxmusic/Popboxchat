<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popbox Live Chat</title>
    <style>
        :root {
            --primary: #4fc3f7;
            --secondary: #ff5555;
            --private: #9c27b0;
            --bg-dark: #1a1a2e;
            --bg-light: #2d2d44;
            --text-light: #ffffff;
            --online: #4caf50;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        
        /* GÄ°RÄ°Å EKRANI */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-box {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid var(--primary);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        
        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ff5555;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
            white-space: pre-line;
            text-align: left;
            background: rgba(255,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #ff5555;
        }
        
        /* ANA UYGULAMA */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        
        /* HEADER */
        .header {
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
        }
        
        .admin-badge {
            background: var(--secondary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            display: none;
        }
        
        /* ANA Ä°Ã‡ERÄ°K */
        .main-content {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }
        
        /* YOUTUBE */
        .video-section {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 200px;
        }
        
        /* CHAT */
        .chat-section {
            width: 400px;
            background: var(--bg-light);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-badge {
            background: var(--online);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        /* MESAJLAR */
        .messages-container {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .message {
            background: rgba(255,255,255,0.07);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }
        
        .message.system {
            border-left-color: var(--online);
            background: rgba(76,175,80,0.1);
        }
        
        .message.admin {
            border-left-color: var(--secondary);
            background: rgba(255,85,85,0.1);
        }
        
        .message.private-msg {
            border-left-color: var(--private);
            background: rgba(156,39,176,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .message-user {
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .message-user:hover {
            background: rgba(79, 195, 247, 0.2);
        }
        
        .message-time {
            color: #aaa;
            font-size: 0.8em;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            border: 2px solid var(--primary);
            cursor: pointer;
        }
        
        /* INPUT */
        .input-container {
            padding: 10px;
            border-top: 1px solid rgba(79,195,247,0.2);
            display: flex;
            gap: 8px;
        }
        
        #message-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Ã–ZEL SOHBET MODALI */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .private-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-light);
            border: 3px solid var(--private);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            z-index: 1001;
            flex-direction: column;
        }
        
        .private-header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--private);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--private);
            font-weight: bold;
        }
        
        .private-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
        }
        
        .private-input-container {
            padding: 10px;
            border-top: 1px solid var(--private);
            display: flex;
            gap: 8px;
        }
        
        /* RESÄ°M MODALI */
        .image-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1002;
        }
        
        .image-modal img {
            max-width: 80vw;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        /* MOBÄ°L */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .chat-section {
                width: 100%;
                height: 300px;
            }
            
            .message-user {
                min-height: 44px;
                padding: 10px 0;
            }
            
            .login-input {
                font-size: 16px;
            }
        }
        
        /* USER LIST */
        .user-list {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--bg-light);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 999;
        }
        
        .user-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        
        .status-online {
            background: var(--online);
        }
        
        .status-idle {
            background: #ff9800;
        }
        
        .user-time {
            font-size: 0.8em;
            color: #aaa;
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <!-- GÄ°RÄ°Å EKRANI -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">ğŸ” Popbox Chat GiriÅŸ</div>
            <input type="text" id="login-nick" class="login-input" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" autocomplete="off">
            <button class="login-btn" onclick="login()" id="login-btn">Sohbete KatÄ±l</button>
            <div class="error-message" id="login-error"></div>
            <div style="margin-top: 15px; color: #aaa; font-size: 0.9em;">
                âš ï¸ <strong>GELÄ°ÅTÄ°RÄ°LMÄ°Å GÃœVENLÄ°K:</strong><br>
                â€¢ AynÄ± nick iki cihazda kullanÄ±lamaz!<br>
                â€¢ 15 saniye aktiflik kontrolÃ¼<br>
                â€¢ GerÃ§ek zamanlÄ± bloklama<br>
                <small>Admin: popbox | Åifre: /admin kumsal07@</small>
            </div>
        </div>
    </div>
    
    <!-- ANA UYGULAMA -->
    <div class="app-container" id="app">
        <div class="header">
            <div class="header-title">
                ğŸ¥ Popbox Live
                <span class="admin-badge" id="adminBadge">ğŸ‘‘ ADMIN</span>
            </div>
            <div>
                <span onclick="showUserList()" style="cursor:pointer;">
                    ğŸ‘¥ <span id="online-count">1</span> online
                </span>
            </div>
        </div>
        
        <!-- ONLINE KULLANICI LÄ°STESÄ° -->
        <div class="user-list" id="userList">
            <div style="color:var(--primary); margin-bottom:10px; font-weight:bold;">ğŸŸ¢ Online KullanÄ±cÄ±lar</div>
            <div id="userListContent"></div>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <div id="youtube-player"></div>
            </div>
            
            <div class="chat-section">
                <div class="chat-header">
                    <div>ğŸ’¬ Popbox Chat</div>
                    <div class="online-badge">
                        <span id="chat-online-count">1</span> online
                    </div>
                </div>
                
                <div class="messages-container" id="messages">
                    <!-- Mesajlar buraya gelecek -->
                </div>
                
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="Mesaj yazÄ±n veya / komutlarÄ± kullanÄ±n..." autocomplete="off">
                    <button class="action-btn" onclick="sendMessage()">
                        <span>ğŸ“¤</span> GÃ¶nder
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ã–ZEL SOHBET MODALI -->
    <div class="overlay" id="overlay"></div>
    <div class="private-modal" id="privateChat">
        <div class="private-header">
            <span id="privateWith">ğŸ”’ Ã–zel Sohbet</span>
            <button onclick="closePrivateChat()" style="background:none;border:none;color:white;font-size:1.5em;cursor:pointer;">Ã—</button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input-container">
            <input type="text" id="private-input" class="login-input" placeholder="Ã–zel mesaj yazÄ±n..." autocomplete="off">
            <button class="action-btn" onclick="openPrivateImageUpload()" style="background:var(--private);">ğŸ“·</button>
            <button class="action-btn" onclick="sendPrivateMessage()" style="background:var(--private);">ğŸ“¤</button>
        </div>
    </div>
    
    <!-- RESÄ°M MODALI -->
    <div class="image-modal" id="imageModal">
        <img id="modalImage" src="" alt="">
        <button onclick="closeImageModal()" style="position:absolute;top:-10px;right:-10px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;">Ã—</button>
    </div>
    
    <!-- GÄ°ZLÄ° DOSYA INPUT -->
    <input type="file" id="imageUpload" accept="image/*" style="display:none;">

    <script>
        // ========== GLOBAL DEÄÄ°ÅKENLER ==========
        let currentUser = null;
        let isAdmin = false;
        let privateChatWith = null;
        let player = null;
        let onlineUsers = {};
        let userCheckInterval = null;
        
        // HER SAYFA Ä°Ã‡Ä°N UNIQUE SESSION ID
        const GLOBAL_SESSION_ID = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Admin bilgileri
        const ADMIN_USERS = ['popbox', 'popboxmusic'];
        const ADMIN_PASSWORDS = {
            'popbox': 'kumsal07@',
            'popboxmusic': 'popbox123'
        };
        
        // ========== GELÄ°ÅMÄ°Å USER API SÄ°STEMÄ° ==========
        class UserAPI {
            static STORAGE_KEY = 'popbox_global_users_v4'; // Version deÄŸiÅŸti
            static CLEANUP_INTERVAL = 15000; // 15 saniye
            
            // TÃ¼m online kullanÄ±cÄ±larÄ± getir ve temizle
            static getAllOnlineUsers() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (!data) return {};
                    
                    const users = JSON.parse(data);
                    const now = Date.now();
                    const cleanedUsers = {};
                    
                    // 15 SANÄ°YE KURALI - agresif temizleme
                    Object.keys(users).forEach(username => {
                        const user = users[username];
                        // Sadece 15 saniye iÃ§inde aktif olanlarÄ± tut
                        if (now - user.lastSeen < this.CLEANUP_INTERVAL) {
                            cleanedUsers[username] = user;
                        } else {
                            console.log(`${username} temizlendi (${Math.floor((now - user.lastSeen)/1000)}sn)`);
                        }
                    });
                    
                    // TemizlenmiÅŸ listeyi kaydet
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cleanedUsers));
                    return cleanedUsers;
                } catch (error) {
                    console.error('KullanÄ±cÄ± getirme hatasÄ±:', error);
                    return {};
                }
            }
            
            // KullanÄ±cÄ± ekle - SIKI KONTROLLÃœ
            static addUser(username) {
                const users = this.getAllOnlineUsers();
                const now = Date.now();
                
                // GÃœÃ‡LÃœ NICK KONTROLÃœ
                if (users[username]) {
                    const existingUser = users[username];
                    const timeDiff = now - existingUser.lastSeen;
                    
                    // DURUM 1: 8 SANÄ°YEDEN AZ Ä°SE KESÄ°NLÄ°KLE DOLU
                    if (timeDiff < 8000) {
                        return { 
                            success: false, 
                            error: `"${username}" ÅU ANDA AKTÄ°F!\n\n` +
                                   `Son aktivite: ${Math.floor(timeDiff/1000)} saniye Ã¶nce\n` +
                                   `Cihaz: ${existingUser.userAgent || 'Bilinmiyor'}\n` +
                                   `IP Benzeri: ${existingUser.sessionId.substr(0, 10)}...`
                        };
                    }
                    
                    // DURUM 2: 8-15 saniye arasÄ± - uyarÄ± ver ama izin ver
                    if (timeDiff < 15000) {
                        console.warn(`${username} kullanÄ±cÄ±sÄ± ${Math.floor(timeDiff/1000)}sn Ã¶nce aktifti`);
                    }
                }
                
                // YENÄ° KULLANICI EKLE
                users[username] = {
                    name: username,
                    sessionId: GLOBAL_SESSION_ID, // HER SAYFA FARKLI ID
                    lastSeen: now,
                    joinedAt: now,
                    userAgent: navigator.userAgent.substring(0, 80),
                    ipSimulation: '192.168.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255)
                };
                
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(users));
                return { 
                    success: true, 
                    data: users[username],
                    message: 'âœ… KullanÄ±cÄ± baÅŸarÄ±yla eklendi!'
                };
            }
            
            // KullanÄ±cÄ±yÄ± gÃ¼ncelle (aktivite)
            static updateUser(username) {
                try {
                    const users = this.getAllOnlineUsers();
                    if (users[username]) {
                        users[username].lastSeen = Date.now();
                        // Session ID'yi de gÃ¼ncelle (aktivite gÃ¶ster)
                        users[username].sessionId = GLOBAL_SESSION_ID;
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(users));
                    }
                } catch (error) {
                    console.error('KullanÄ±cÄ± gÃ¼ncelleme hatasÄ±:', error);
                }
            }
            
            // KullanÄ±cÄ±yÄ± sil
            static removeUser(username) {
                try {
                    const users = this.getAllOnlineUsers();
                    if (users[username]) {
                        delete users[username];
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(users));
                        console.log(`${username} kullanÄ±cÄ±sÄ± silindi`);
                    }
                } catch (error) {
                    console.error('KullanÄ±cÄ± silme hatasÄ±:', error);
                }
            }
            
            // Nick kullanÄ±mda mÄ± kontrol et
            static isNickTaken(username) {
                const users = this.getAllOnlineUsers();
                if (!users[username]) return false;
                
                const user = users[username];
                const now = Date.now();
                const timeDiff = now - user.lastSeen;
                
                // 8 saniyeden az ise KESÄ°NLÄ°KLE dolu
                if (timeDiff < 8000) {
                    return {
                        taken: true,
                        user: user,
                        timeAgo: Math.floor(timeDiff / 1000),
                        message: `KullanÄ±cÄ± ${timeDiff < 3000 ? 'Ã‡OK YAKINDA' : 'yakÄ±n zamanda'} aktif`
                    };
                }
                
                // 8-15 saniye arasÄ± - riskli ama boÅŸ say
                if (timeDiff < 15000) {
                    return {
                        taken: false,
                        warning: true,
                        user: user,
                        timeAgo: Math.floor(timeDiff / 1000),
                        message: 'âš ï¸ Bu kullanÄ±cÄ± yakÄ±n zamanda Ã§Ä±kmÄ±ÅŸ'
                    };
                }
                
                return false;
            }
            
            // TÃ¼m kullanÄ±cÄ±larÄ± temizle (admin iÃ§in)
            static clearAllUsers() {
                localStorage.removeItem(this.STORAGE_KEY);
                return { success: true };
            }
        }
        
        // ========== GÄ°RÄ°Å SÄ°STEMÄ° ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const nick = nickInput.value.trim();
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');
            
            if (!nick) {
                showError('âŒ LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin!');
                return;
            }
            
            if (nick.length < 2 || nick.length > 20) {
                showError('âŒ KullanÄ±cÄ± adÄ± 2-20 karakter arasÄ±nda olmalÄ±!');
                return;
            }
            
            // Ã–zel karakter kontrolÃ¼
            if (/[<>\/\\]/.test(nick)) {
                showError('âŒ GeÃ§ersiz karakterler iÃ§eriyor!');
                return;
            }
            
            // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            loginBtn.disabled = true;
            loginBtn.textContent = 'â³ Kontrol ediliyor...';
            errorMsg.style.display = 'none';
            
            // 1 saniye bekle (gerÃ§ekÃ§i hissiyat)
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // GELÄ°ÅMÄ°Å NICK KONTROLÃœ
            const checkResult = UserAPI.isNickTaken(nick);
            
            if (checkResult && checkResult.taken) {
                const user = checkResult.user;
                const timeAgo = checkResult.timeAgo;
                const userInfo = `ğŸ‘¤ ${user.name}\nâ° ${timeAgo}sn Ã¶nce aktif\nğŸ“± ${user.userAgent || 'Unknown'}\nğŸ”‘ ${user.sessionId.substr(0, 15)}...`;
                
                showError(`â›” BU KULLANICI ÅU ANDA AKTÄ°F!\n\n${userInfo}\n\nğŸ’¡ LÃ¼tfen:\n1. BaÅŸka bir kullanÄ±cÄ± adÄ± seÃ§in\n2. ${15-timeAgo} saniye bekleyin`);
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sohbete KatÄ±l';
                return;
            }
            
            if (checkResult && checkResult.warning) {
                // UyarÄ± ver ama izin ver
                console.warn(`UyarÄ±: ${nick} kullanÄ±cÄ±sÄ± ${checkResult.timeAgo}sn Ã¶nce aktifti`);
            }
            
            // KullanÄ±cÄ±yÄ± oluÅŸtur
            const addResult = UserAPI.addUser(nick);
            
            if (!addResult.success) {
                showError(addResult.error);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sohbete KatÄ±l';
                return;
            }
            
            currentUser = {
                name: nick,
                role: 'user',
                isAdminUser: ADMIN_USERS.includes(nick.toLowerCase()),
                sessionId: GLOBAL_SESSION_ID,
                lastSeen: Date.now(),
                data: addResult.data
            };
            
            // UygulamayÄ± gÃ¶ster
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // BaÅŸlat
            initApp();
            
            // BaÅŸarÄ± mesajÄ±
            showTemporaryMessage('âœ… BaÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±!', 'success');
        }
        
        function showError(message) {
            const errorMsg = document.getElementById('login-error');
            errorMsg.innerHTML = message.replace(/\n/g, '<br>');
            errorMsg.style.display = 'block';
            
            // Otomatik kaydÄ±r
            setTimeout(() => {
                errorMsg.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        function showTemporaryMessage(message, type = 'info') {
            const container = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type === 'success' ? 'system' : ''}`;
            msgDiv.innerHTML = `<strong>${type === 'success' ? 'âœ…' : 'â„¹ï¸'} Sistem:</strong> ${message}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            if (type === 'success') {
                setTimeout(() => {
                    msgDiv.style.opacity = '0.7';
                }, 3000);
            }
        }
        
        // ========== UYGULAMA BAÅLATMA ==========
        function initApp() {
            // HoÅŸ geldin mesajÄ±
            addSystemMessage(`ğŸ‰ HoÅŸ geldin, ${currentUser.name}!`);
            
            if (currentUser.isAdminUser) {
                addSystemMessage('ğŸ”‘ Admin giriÅŸi iÃ§in: /admin [ÅŸifre]');
            }
            
            addSystemMessage('ğŸ’¬ KullanÄ±cÄ± adÄ±na tÄ±klayarak Ã¶zel sohbet baÅŸlatabilirsin!');
            addSystemMessage('ğŸ‘¥ Online listesi iÃ§in header\'daki sayÄ±ya tÄ±klayÄ±n');
            
            // Event listener'lar
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('private-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendPrivateMessage();
            });
            
            document.getElementById('overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePrivateChat();
                    closeImageModal();
                }
            });
            
            // YouTube player
            if (typeof YT !== 'undefined') {
                initYouTubePlayer();
            }
            
            // Online kullanÄ±cÄ±larÄ± gÃ¼ncelle
            updateOnlineUsers();
            
            // Periyodik gÃ¼ncellemeler - DAHA SIK
            userCheckInterval = setInterval(() => {
                updateOnlineUsers();
                updateUserActivity();
                
                // Her 10 saniyede bir storage temizle
                if (Date.now() % 10000 < 3000) {
                    UserAPI.getAllOnlineUsers(); // Otomatik temizler
                }
            }, 3000); // 3 SANÄ°YEDE BÄ°R
            
            // Demo mesajlar
            setTimeout(() => startDemoMessages(), 2000);
            
            // Sayfa kapanÄ±rken Ã§Ä±kÄ±ÅŸ yap
            window.addEventListener('beforeunload', function() {
                if (currentUser) {
                    UserAPI.removeUser(currentUser.name);
                }
                if (userCheckInterval) {
                    clearInterval(userCheckInterval);
                }
            });
            
            // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸince
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Sayfa gizlendi
                    console.log('Sayfa gizlendi, aktivite durduruldu');
                } else {
                    // Sayfa gÃ¶rÃ¼nÃ¼r oldu
                    updateUserActivity();
                    updateOnlineUsers();
                }
            });
        }
        
        // ========== ONLINE KULLANICI YÃ–NETÄ°MÄ° ==========
        function updateOnlineUsers() {
            onlineUsers = UserAPI.getAllOnlineUsers();
            
            // Online sayÄ±sÄ±nÄ± gÃ¶ster
            const activeUsers = Object.values(onlineUsers).filter(user => 
                (Date.now() - user.lastSeen) < 15000
            );
            
            const onlineCount = activeUsers.length;
            document.getElementById('online-count').textContent = onlineCount;
            document.getElementById('chat-online-count').textContent = onlineCount;
            
            // KullanÄ±cÄ± listesini gÃ¼ncelle
            updateUserList();
            
            // Kendi kullanÄ±cÄ±mÄ±zÄ±n aktivitesini gÃ¼ncelle
            updateUserActivity();
        }
        
        function updateUserActivity() {
            if (currentUser) {
                UserAPI.updateUser(currentUser.name);
            }
        }
        
        function showUserList() {
            const userList = document.getElementById('userList');
            userList.style.display = userList.style.display === 'block' ? 'none' : 'block';
        }
        
        function updateUserList() {
            const container = document.getElementById('userListContent');
            container.innerHTML = '';
            
            const activeUsers = Object.values(onlineUsers)
                .filter(user => (Date.now() - user.lastSeen) < 15000)
                .sort((a, b) => b.lastSeen - a.lastSeen);
            
            if (activeUsers.length === 0) {
                container.innerHTML = '<div style="color:#aaa; padding:10px; text-align:center;">Online kullanÄ±cÄ± yok</div>';
                return;
            }
            
            activeUsers.forEach(user => {
                const timeDiff = Date.now() - user.lastSeen;
                const secondsAgo = Math.floor(timeDiff / 1000);
                
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                let statusClass = 'status-online';
                let statusText = 'ğŸŸ¢ Online';
                
                if (secondsAgo > 10) {
                    statusClass = 'status-idle';
                    statusText = 'ğŸŸ¡ BoÅŸta';
                }
                
                userDiv.innerHTML = `
                    <div>
                        <span class="user-status ${statusClass}"></span>
                        <strong>${user.name === currentUser.name ? 'ğŸ‘¤ ' + user.name + ' (Siz)' : user.name}</strong>
                        ${user.name === currentUser.name ? ' <small>(Siz)</small>' : ''}
                    </div>
                    <div class="user-time">
                        ${secondsAgo < 5 ? 'Åimdi' : secondsAgo + 'sn Ã¶nce'}
                    </div>
                `;
                
                // Kendimiz deÄŸilse tÄ±klanabilir yap
                if (user.name !== currentUser.name) {
                    userDiv.style.cursor = 'pointer';
                    userDiv.onclick = () => openPrivateChat(user.name);
                    userDiv.title = `${user.name} ile Ã¶zel sohbet baÅŸlat`;
                }
                
                container.appendChild(userDiv);
            });
        }
        
        // ========== MESAJ SÄ°STEMÄ° ==========
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
            } else {
                addMessage(currentUser.name, text, isAdmin ? 'admin' : 'user');
                
                // Demo cevap
                setTimeout(() => {
                    sendDemoReply(text);
                }, 1000 + Math.random() * 2000);
            }
            
            input.value = '';
            input.focus();
            
            // Aktiviteyi gÃ¼ncelle
            updateUserActivity();
        }
        
        function addMessage(sender, text, type = 'user', image = null) {
            const container = document.getElementById('messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            
            let content = text;
            if (image) {
                content += `<br><img src="${image}" class="message-image" onclick="showImage('${image}')">`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user" onclick="openPrivateChat('${sender}')">
                        ${type === 'admin' ? 'ğŸ‘‘ ' : ''}${sender}
                    </span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div>${content}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `<strong>ğŸ¤– Sistem:</strong> ${text}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== Ã–ZEL SOHBET SÄ°STEMÄ° ==========
        function openPrivateChat(username) {
            if (username === currentUser.name) {
                addSystemMessage('Kendinize Ã¶zel mesaj gÃ¶nderemezsiniz!');
                return;
            }
            
            privateChatWith = username;
            document.getElementById('privateWith').textContent = `ğŸ”’ ${username} ile Ã¶zel sohbet`;
            document.getElementById('privateChat').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
            
            // KullanÄ±cÄ± listesini gizle
            document.getElementById('userList').style.display = 'none';
            
            // Ã–zel mesajlarÄ± yÃ¼kle
            loadPrivateMessages(username);
            
            setTimeout(() => {
                document.getElementById('private-input').focus();
            }, 100);
        }
        
        function closePrivateChat() {
            privateChatWith = null;
            document.getElementById('privateChat').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('private-input').value = '';
        }
        
        function loadPrivateMessages(username) {
            const container = document.getElementById('privateMessages');
            container.innerHTML = '';
            
            // Demo Ã¶zel mesajlar
            const demoPrivateMessages = [
                { sender: username, text: 'Merhaba!', time: '10:00' },
                { sender: currentUser.name, text: 'Selam! NasÄ±lsÄ±n?', time: '10:01' },
                { sender: username, text: 'Ä°yiyim, teÅŸekkÃ¼rler!', time: '10:02' }
            ];
            
            demoPrivateMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message private-msg';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user">${msg.sender}</span>
                        <span class="message-time">${msg.time}</span>
                    </div>
                    <div>${msg.text}</div>
                `;
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function sendPrivateMessage() {
            if (!privateChatWith) return;
            
            const input = document.getElementById('private-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Ã–zel mesajÄ± ekle
            addPrivateMessage(currentUser.name, text);
            
            // Demo cevap
            setTimeout(() => {
                const replies = ['AnladÄ±m!', 'Tamam', 'TeÅŸekkÃ¼rler', 'ğŸ‘Œ', 'Peki'];
                const randomReply = replies[Math.floor(Math.random() * replies.length)];
                addPrivateMessage(privateChatWith, randomReply);
            }, 1000);
            
            input.value = '';
            input.focus();
            
            // Aktivite gÃ¼ncelle
            updateUserActivity();
        }
        
        function addPrivateMessage(sender, text, image = null) {
            const container = document.getElementById('privateMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message private-msg';
            
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            
            let content = text;
            if (image) {
                content += `<br><img src="${image}" class="message-image" onclick="showImage('${image}')">`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${sender}</span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div>${content}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== RESÄ°M GÃ–NDERME SÄ°STEMÄ° ==========
        function openPrivateImageUpload() {
            if (!privateChatWith) {
                alert('Ã–nce bir kullanÄ±cÄ± ile Ã¶zel sohbette olmalÄ±sÄ±nÄ±z!');
                return;
            }
            
            document.getElementById('imageUpload').click();
        }
        
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('LÃ¼tfen sadece resim dosyasÄ± seÃ§in!');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                alert('Resim Ã§ok bÃ¼yÃ¼k! Maksimum 2MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                
                if (privateChatWith) {
                    // Ã–zel sohbete resim gÃ¶nder
                    addPrivateMessage(currentUser.name, 'ğŸ“¸ Resim gÃ¶nderdi', imageData);
                    
                    // Demo cevap
                    setTimeout(() => {
                        addPrivateMessage(privateChatWith, 'Harika resim! ğŸ‘');
                    }, 1500);
                } else {
                    // Genel sohbete resim gÃ¶nder
                    addMessage(currentUser.name, 'ğŸ“¸ Resim paylaÅŸtÄ±', isAdmin ? 'admin' : 'user', imageData);
                    
                    // Demo cevap
                    setTimeout(() => {
                        const users = Object.keys(onlineUsers).filter(u => u !== currentUser.name);
                        if (users.length > 0) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            addMessage(randomUser, 'GÃ¼zel resim! ğŸ‘');
                        }
                    }, 1500);
                }
            };
            
            reader.readAsDataURL(file);
            e.target.value = '';
            
            // Aktivite gÃ¼ncelle
            updateUserActivity();
        });
        
        function showImage(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        // ========== KOMUT SÄ°STEMÄ° ==========
        function handleCommand(cmd) {
            const parts = cmd.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(command) {
                case 'admin':
                    if (args.length === 1) {
                        checkAdminPassword(args[0]);
                    } else {
                        addSystemMessage('KullanÄ±m: /admin [ÅŸifre]');
                    }
                    break;
                    
                case 'temizle':
                    if (isAdmin) {
                        document.getElementById('messages').innerHTML = '';
                        addSystemMessage('ğŸ—‘ï¸ Sohbet temizlendi!');
                    } else {
                        addSystemMessage('â›” Yetkiniz yok!');
                    }
                    break;
                    
                case 'kullanÄ±cÄ±lar':
                    showOnlineUsers();
                    break;
                    
                case 'temizkullanici':
                    if (isAdmin) {
                        UserAPI.clearAllUsers();
                        updateOnlineUsers();
                        addSystemMessage('âœ… TÃ¼m kullanÄ±cÄ±lar temizlendi!');
                    } else {
                        addSystemMessage('â›” Admin yetkisi gerekiyor!');
                    }
                    break;
                    
                case 'yardÄ±m':
                    showHelp();
                    break;
                    
                case 'ping':
                    addSystemMessage(`ğŸ“ Pong! Session ID: ${GLOBAL_SESSION_ID.substr(0, 20)}...`);
                    break;
                    
                default:
                    addSystemMessage(`âŒ Bilinmeyen komut: ${command}`);
            }
        }
        
        function checkAdminPassword(password) {
            if (!currentUser.isAdminUser) {
                addSystemMessage('âŒ Bu kullanÄ±cÄ± admin deÄŸil!');
                return;
            }
            
            const correctPassword = ADMIN_PASSWORDS[currentUser.name.toLowerCase()];
            if (password === correctPassword) {
                isAdmin = true;
                currentUser.role = 'admin';
                document.getElementById('adminBadge').style.display = 'inline-block';
                
                // Gizli admin giriÅŸi
                document.body.style.border = '5px solid red';
                document.body.style.boxShadow = '0 0 30px rgba(255,0,0,0.5)';
                
                addSystemMessage('âœ… Admin giriÅŸi baÅŸarÄ±lÄ±! Gizli mod aktif!');
                
                // Admin mesajÄ±
                setTimeout(() => {
                    addMessage(currentUser.name, 'ğŸ‘‘ Admin olarak giriÅŸ yaptÄ±m!', 'admin');
                }, 1000);
            } else {
                addSystemMessage('âŒ HatalÄ± ÅŸifre!');
            }
        }
        
        function showOnlineUsers() {
            const activeUsers = Object.values(onlineUsers).filter(user => 
                (Date.now() - user.lastSeen) < 30000
            );
            
            if (activeUsers.length === 0) {
                addSystemMessage('ğŸ‘¥ Online kullanÄ±cÄ± yok');
                return;
            }
            
            let userList = '<strong>ğŸ‘¥ Online KullanÄ±cÄ±lar:</strong><br>';
            activeUsers.forEach(user => {
                const minutes = Math.floor((Date.now() - user.joinedAt) / 60000);
                const seconds = Math.floor((Date.now() - user.lastSeen) / 1000);
                const isMe = user.name === currentUser.name;
                userList += `â€¢ ${isMe ? 'ğŸ‘¤ ' : ''}${user.name} (${minutes}dk, ${seconds}sn Ã¶nce)${isMe ? ' (Siz)' : ''}<br>`;
            });
            
            addSystemMessage(userList);
        }
        
        function showHelp() {
            let help = '<strong>ğŸ“‹ Komut Listesi:</strong><br>';
            help += 'â€¢ /admin [ÅŸifre] - Admin giriÅŸi<br>';
            
            if (isAdmin) {
                help += 'â€¢ /temizle - Sohbeti temizle<br>';
                help += 'â€¢ /temizkullanici - TÃ¼m kullanÄ±cÄ±larÄ± temizle<br>';
            }
            
            help += 'â€¢ /kullanÄ±cÄ±lar - Online kullanÄ±cÄ±larÄ± listele<br>';
            help += 'â€¢ /yardÄ±m - Bu mesajÄ± gÃ¶ster<br>';
            help += 'â€¢ /ping - BaÄŸlantÄ± testi<br><br>';
            help += '<strong>ğŸ’¡ Ä°puÃ§larÄ±:</strong><br>';
            help += 'â€¢ KullanÄ±cÄ± adÄ±na tÄ±kla â†’ Ã–zel sohbet<br>';
            help += 'â€¢ Header\'daki sayÄ±ya tÄ±kla â†’ Online listesi<br>';
            help += 'â€¢ Ã–zel sohbette ğŸ“· â†’ Resim gÃ¶nder';
            
            addSystemMessage(help);
        }
        
        // ========== YOUTUBE PLAYER ==========
        function initYouTubePlayer() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: 'dQw4w9WgXcQ',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        }
        
        function onPlayerReady(event) {
            event.target.playVideo();
        }
        
        function onYouTubeIframeAPIReady() {
            initYouTubePlayer();
        }
        
        // ========== DEMO MESAJLAR ==========
        function startDemoMessages() {
            // Demo mesaj ekle
            setTimeout(() => {
                if (Object.keys(onlineUsers).length > 1) {
                    const demoUsers = ['Ahmet', 'Mehmet', 'AyÅŸe', 'Fatma', 'Ali'];
                    const randomUser = demoUsers[Math.floor(Math.random() * demoUsers.length)];
                    
                    // Bu kullanÄ±cÄ± online deÄŸilse gÃ¶nder
                    if (!onlineUsers[randomUser]) {
                        addMessage(randomUser, 'Selam herkese! Popbox harika! ğŸ‘');
                    }
                }
            }, 2000);
            
            setTimeout(() => {
                if (Math.random() > 0.5) {
                    addMessage('CanlÄ±_YayÄ±n', 'ğŸ¬ CanlÄ± yayÄ±n devam ediyor!', 'system');
                }
            }, 5000);
        }
        
        function sendDemoReply(text) {
            const activeUsers = Object.values(onlineUsers).filter(user => 
                user.name !== currentUser.name && 
                (Date.now() - user.lastSeen) < 30000
            );
            
            if (activeUsers.length === 0) return;
            
            // Demo kullanÄ±cÄ±lar
            const demoUsers = ['ChatBot', 'Sistem', 'ModeratÃ¶r', 'PopboxFan'];
            const allPossibleUsers = [...activeUsers.map(u => u.name), ...demoUsers];
            const randomUser = allPossibleUsers[Math.floor(Math.random() * allPossibleUsers.length)];
            
            const replies = {
                'merhaba': ['Merhaba!', 'Selam!', 'HoÅŸ geldin! ğŸ‘‹', 'Merhabalar!'],
                'nasÄ±lsÄ±n': ['Ä°yiyim, sen?', 'Harika!', 'TeÅŸekkÃ¼rler! ğŸ˜Š'],
                'admin': ['Admin aktif.', 'Popbox yÃ¶netiyor! ğŸ‘‘'],
                'Ã¶zel': ['Evet! KullanÄ±cÄ± adÄ±ma tÄ±klayarak Ã¶zel sohbet baÅŸlatabilirsin! ğŸ”’'],
                'resim': ['Ã–zel sohbette resim gÃ¶nderebilirsin! ğŸ“¸'],
                'popbox': ['Popbox en iyisi! ğŸµ', 'Popbox music forever! ğŸ§'],
                'canlÄ±': ['CanlÄ± yayÄ±n sÃ¼per gidiyor! ğŸ¥']
            };
            
            let reply = 'Evet, katÄ±lÄ±yorum! ğŸ‘';
            const lowerText = text.toLowerCase();
            
            for (const [key, responseArray] of Object.entries(replies)) {
                if (lowerText.includes(key)) {
                    reply = responseArray[Math.floor(Math.random() * responseArray.length)];
                    break;
                }
            }
            
            // Bazen random cevap ver
            if (Math.random() > 0.7) {
                const randomReplies = ['ğŸ‘Œ', 'ğŸ˜‚', 'Harika!', 'Aynen!', 'DoÄŸru!', 'ğŸ‘'];
                reply = randomReplies[Math.floor(Math.random() * randomReplies.length)];
            }
            
            setTimeout(() => {
                addMessage(randomUser, reply);
            }, 1000 + Math.random() * 2000);
        }
        
        // ========== SAYFA YÃœKLENDÄ°ÄÄ°NDE ==========
        window.addEventListener('load', function() {
            // Otomatik focus
            document.getElementById('login-nick').focus();
            
            // Eski online kullanÄ±cÄ±larÄ± temizle (15 saniyeden eski)
            UserAPI.getAllOnlineUsers();
            
            // Enter tuÅŸu ile login
            document.getElementById('login-nick').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Sayfa baÅŸlÄ±ÄŸÄ±na session ID ekle (debug iÃ§in)
            document.title += ' | Session: ' + GLOBAL_SESSION_ID.substr(0, 8);
            
            // Sayfa kapatma uyarÄ±sÄ±
            window.addEventListener('beforeunload', function(e) {
                if (currentUser) {
                    // Ã‡Ä±kÄ±ÅŸ yap
                    UserAPI.removeUser(currentUser.name);
                }
            });
        });
        
        // ========== DEBUG MODU ==========
        function debugInfo() {
            console.log('=== DEBUG INFO ===');
            console.log('Session ID:', GLOBAL_SESSION_ID);
            console.log('Current User:', currentUser);
            console.log('Online Users:', onlineUsers);
            console.log('Is Admin:', isAdmin);
            console.log('Storage:', localStorage.getItem(UserAPI.STORAGE_KEY));
        }
        
        // Debug iÃ§in global eriÅŸim
        window.debugInfo = debugInfo;
        window.UserAPI = UserAPI;
        
    </script>
</body>
</html>
