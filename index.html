<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CetCety Â· Havada AsÄ±lÄ± Paneller</title>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase SDK v8 (ESKÄ° Ã‡ALIÅAN VERSÄ°YON) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- CETCETY STYLE -->
    <link rel="stylesheet" href="style.css">
    
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <!-- LOGO -->
    <div class="logo-area">
        <i class="fas fa-comment-dots logo-icon"></i>
        <div class="logo-text">CetCety <span>Â· floating</span></div>
    </div>

    <!-- ANA GRID -->
    <div class="app">
        <!-- Ä°KON PANELÄ° -->
        <div class="icon-panel">
            <div class="icon-item active" title="Ana Sayfa" onclick="switchPanelTab('online')">
                <i class="fas fa-home"></i>
            </div>
            <div class="icon-item" title="Story" onclick="openStoryCreateModal()">
                <i class="fas fa-plus-circle"></i>
            </div>
            <div class="icon-item" title="Profil" style="margin-top: auto;" onclick="showProfile()">
                <i class="fas fa-user-circle"></i>
            </div>
        </div>

        <!-- DAR PANEL (ONLINE/ONCHAT) -->
        <div class="side-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchPanelTab('online')" id="tabOnline">Online</div>
                <div class="panel-tab" onclick="switchPanelTab('onchat')" id="tabOnchat">OnChat</div>
            </div>
            <div class="panel-content" id="panelContent">
                <div style="color: #606060; padding: 20px; text-align: center;">YÃ¼kleniyor...</div>
            </div>
        </div>

        <!-- SOHBET ALANI -->
        <div class="chat-area">
            <div class="chat-header">
                <i class="fas fa-hashtag"></i>
                <span id="currentChannelName">genel</span>
                <span style="color: #606060; margin-left: auto;" id="onlineCount">0 Ã§evrimiÃ§i</span>
            </div>
            <div class="chat-messages" id="messages">
                <div class="yt-message system">
                    ğŸ‰ CetCety'e hoÅŸ geldiniz! Sohbete katÄ±lÄ±n.
                </div>
            </div>
            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Mesaj yazÄ±n veya / komutlarÄ±..."
                        rows="1"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- MEDYA PANELÄ° -->
        <div class="media-panel">
            <div class="media-header">
                <i class="fab fa-youtube"></i>
                <span>Medya</span>
            </div>
            <div class="video-container" id="videoContainer">
                <div id="youtube-player"></div>
                <div class="video-placeholder" style="display: none;">
                    <i class="fas fa-play-circle"></i>
                    <span>Video oynatÄ±cÄ±</span>
                </div>
            </div>
            <div class="playlist" id="playlist">
                <div style="color: #606060; padding: 20px; text-align: center;">HenÃ¼z playlist yok</div>
            </div>
        </div>
    </div>

    <!-- GÄ°RÄ°Å EKRANI -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">
                <i class="fas fa-comment-dots logo-icon"></i>
                CetCety
            </div>
            
            <input 
                type="text" 
                id="login-nick" 
                class="login-input" 
                placeholder="KullanÄ±cÄ± adÄ±nÄ±z"
                autocomplete="off"
            >
            
            <input 
                type="password" 
                id="login-password" 
                class="login-input" 
                placeholder="Åifre (sadece kayÄ±tlÄ± kullanÄ±cÄ±lar)"
                autocomplete="off"
                style="display: none;"
            >
            
            <div id="password-info" style="color: #a0a0a0; font-size: 14px; margin-bottom: 12px; display: none;">
                ğŸ” Bu kullanÄ±cÄ± kayÄ±tlÄ±dÄ±r, lÃ¼tfen ÅŸifrenizi girin
            </div>
            
            <button class="login-button" onclick="login()" id="login-btn">
                Sohbete KatÄ±l
            </button>
            
            <div id="login-error" class="error-message"></div>
            <div id="login-success" class="success-message"></div>
        </div>
    </div>

    <!-- Ã–ZEL SOHBET MODAL -->
    <div class="private-modal" id="privateModal">
        <div class="private-header">
            <div id="privateWith">ğŸ”’ Ã–zel Sohbet</div>
            <button onclick="closePrivateChat()" style="background: none; border: none; color: #e0e0e0; font-size: 24px; cursor: pointer;">
                Ã—
            </button>
        </div>
        <div class="private-messages" id="privateMessages"></div>
        <div class="private-input-area">
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <button class="image-upload-btn" onclick="document.getElementById('imageUpload').click()" title="Resim gÃ¶nder">
                <i class="fas fa-image"></i>
            </button>
            <textarea 
                id="private-input" 
                placeholder="Ã–zel mesaj yazÄ±n..."
                rows="1"
                oninput="autoResize(this)"
            ></textarea>
            <button class="send-button" onclick="sendPrivateMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- OVERLAY -->
    <div id="overlay" onclick="closeAllModals()"></div>
    
    <!-- FIREBASE BADGE -->
    <div class="firebase-badge">
        <i class="fas fa-fire"></i> Firebase Active
    </div>

    <!-- SES ELEMANI -->
    <audio id="notificationSound" style="display: none;">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========== FIREBASE KONFÄ°G (ESKÄ° Ã‡ALIÅAN) ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        // ========== GLOBAL DEÄÄ°ÅKENLER ==========
        let database;
        let usersRef;
        let messagesRef;
        let privateChatsRef;
        let registeredUsersRef;
        let customCommandsRef;
        
        let currentUser = null;
        let isAdmin = false;
        let isCoAdmin = false;
        let isOperator = false;
        let isOwner = false;
        let privateChatWith = null;
        let currentPrivateChatId = null;
        let onlineUsers = {};
        let activeChats = {};
        let currentPanelTab = 'online';
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers') || '{}');
        let customCommands = {};
        let player = null;

        // ========== FIREBASE BAÅLAT ==========
        function initializeFirebase() {
            try {
                console.log("ğŸ”¥ Firebase baÅŸlatÄ±lÄ±yor...");
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("âœ… Firebase BAÄLANDI!");
                        
                        usersRef = database.ref('onlineUsers');
                        messagesRef = database.ref('messages');
                        privateChatsRef = database.ref('privateChats');
                        registeredUsersRef = database.ref('registeredUsers');
                        customCommandsRef = database.ref('customCommands');
                        
                        loadCustomCommands();
                        checkUsernameRealTime();
                        
                        // Login ekranÄ±nÄ± gÃ¶ster
                        document.getElementById('login-nick').focus();
                    }
                });
                
            } catch (error) {
                console.error("âŒ Firebase hatasÄ±:", error);
            }
        }

        // ========== YARDIMCI FONKSÄ°YONLAR ==========
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function closeAllModals() {
            closePrivateChat();
        }

        function normalizeNick(nick) {
            return nick ? nick.toLowerCase().trim() : '';
        }

        // ========== KULLANICI ADI KONTROLÃœ ==========
        function checkUsernameRealTime() {
            const nickInput = document.getElementById('login-nick');
            const passwordInput = document.getElementById('login-password');
            const passwordInfo = document.getElementById('password-info');
            
            nickInput.addEventListener('input', async function() {
                const nick = this.value.trim();
                
                if (nick.length < 2) {
                    passwordInput.style.display = 'none';
                    passwordInfo.style.display = 'none';
                    return;
                }
                
                try {
                    const snapshot = await registeredUsersRef.once('value');
                    const users = snapshot.val() || {};
                    
                    let found = null;
                    for (const [username, userData] of Object.entries(users)) {
                        if (normalizeNick(username) === normalizeNick(nick)) {
                            found = { username, ...userData };
                            break;
                        }
                    }
                    
                    if (found) {
                        passwordInput.style.display = 'block';
                        passwordInfo.style.display = 'block';
                        passwordInfo.innerHTML = `ğŸ” ${found.username} iÃ§in ÅŸifre gerekli`;
                    } else {
                        passwordInput.style.display = 'none';
                        passwordInfo.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('KullanÄ±cÄ± kontrol hatasÄ±:', error);
                }
            });
        }

        // ========== GÄ°RÄ°Å ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const passwordInput = document.getElementById('login-password');
            const rawNick = nickInput.value.trim();
            const password = passwordInput.value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!rawNick) {
                showLoginError('âŒ LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin!');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Kontrol ediliyor...';
            showLoginError('');
            showLoginSuccess('');
            
            try {
                // KayÄ±tlÄ± kullanÄ±cÄ± kontrolÃ¼
                const snapshot = await registeredUsersRef.once('value');
                const registered = snapshot.val() || {};
                
                let foundUser = null;
                let originalName = rawNick;
                
                for (const [username, userData] of Object.entries(registered)) {
                    if (normalizeNick(username) === normalizeNick(rawNick)) {
                        foundUser = userData;
                        originalName = username;
                        break;
                    }
                }
                
                // Åifre kontrolÃ¼
                if (foundUser) {
                    if (!password) {
                        showLoginError('ğŸ” Åifre gerekli!');
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sohbete KatÄ±l';
                        return;
                    }
                    
                    if (password !== foundUser.password) {
                        showLoginError('âŒ HatalÄ± ÅŸifre!');
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sohbete KatÄ±l';
                        return;
                    }
                }
                
                // Owner kontrolÃ¼
                const isOwnerUser = normalizeNick(rawNick) === normalizeNick('MateKy');
                
                // KullanÄ±cÄ±yÄ± oluÅŸtur
                const userInfo = {
                    name: foundUser ? originalName : rawNick,
                    lastSeen: Date.now(),
                    joinedAt: Date.now(),
                    isOnline: true,
                    role: foundUser?.role || (isOwnerUser ? 'owner' : 'user'),
                    isRegistered: !!foundUser
                };
                
                await usersRef.child(userInfo.name).set(userInfo);
                usersRef.child(userInfo.name).onDisconnect().remove();
                
                currentUser = userInfo;
                
                // Yetkiler
                if (userInfo.role === 'owner') isOwner = true;
                if (userInfo.role === 'admin') isAdmin = true;
                if (userInfo.role === 'coadmin') isCoAdmin = true;
                if (userInfo.role === 'operator') isOperator = true;
                
                // GiriÅŸ ekranÄ±nÄ± kapat
                document.getElementById('login-screen').style.display = 'none';
                
                // UygulamayÄ± baÅŸlat
                initApp();
                
                addSystemMessage(`ğŸ‰ HoÅŸ geldin, ${currentUser.name}!`);
                
            } catch (error) {
                console.error('GiriÅŸ hatasÄ±:', error);
                showLoginError('âŒ GiriÅŸ hatasÄ±: ' + error.message);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sohbete KatÄ±l';
            }
        }

        function showLoginError(message) {
            const errorMsg = document.getElementById('login-error');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            
            const successMsg = document.getElementById('login-success');
            successMsg.style.display = 'none';
        }

        function showLoginSuccess(message) {
            const successMsg = document.getElementById('login-success');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            
            const errorMsg = document.getElementById('login-error');
            errorMsg.style.display = 'none';
        }

        // ========== UYGULAMA BAÅLAT ==========
        function initApp() {
            // Mesaj gÃ¶nderme
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('private-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // YouTube player
            if (typeof YT !== 'undefined') {
                initYouTubePlayer();
            }
            
            // Online kullanÄ±cÄ±larÄ± dinle
            if (usersRef) {
                usersRef.on('value', (snapshot) => {
                    updateOnlineUsers(snapshot.val());
                });
            }
            
            // MesajlarÄ± dinle
            if (messagesRef) {
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    updateMessages(snapshot.val());
                });
            }
            
            // Heartbeat
            setInterval(() => {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now(),
                        isOnline: true
                    });
                }
            }, 5000);
            
            // Sayfa kapanÄ±rken
            window.addEventListener('beforeunload', function() {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).remove();
                }
            });
        }

        // ========== YOUTUBE PLAYER ==========
        function initYouTubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) {
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: 'i75BZYOAPl4',
                    playerVars: {
                        'autoplay': 1,
                        'controls': 1,
                        'rel': 0,
                        'modestbranding': 1,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': function(event) {
                            document.querySelector('.video-placeholder').style.display = 'none';
                        }
                    }
                });
            }
        }

        // ========== ONLINE KULLANICILAR ==========
        function updateOnlineUsers(users) {
            if (!users) users = {};
            
            const now = Date.now();
            const activeUsers = {};
            
            Object.entries(users).forEach(([username, userData]) => {
                if (!userData) return;
                
                const timeDiff = now - (userData.lastSeen || 0);
                if (timeDiff < 15000) {
                    activeUsers[username] = userData;
                }
            });
            
            onlineUsers = activeUsers;
            document.getElementById('onlineCount').textContent = Object.keys(activeUsers).length;
            
            updatePanel();
        }

        // ========== MESAJLAR ==========
        function sendMessage() {
            if (!currentUser || !messagesRef) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                autoResize(input);
                return;
            }
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                type: currentUser.role || 'user',
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            messagesRef.push(messageData);
            input.value = '';
            autoResize(input);
        }

        function updateMessages(messages) {
            if (!messages) return;
            
            const container = document.getElementById('messages');
            const messagesArray = [];
            
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = '';
            
            messagesArray.slice(-50).forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `yt-message ${msg.type || 'user'}`;
                
                let senderName = msg.sender;
                if (msg.type === 'owner') senderName = 'ğŸ¤´ ' + senderName;
                else if (msg.type === 'admin') senderName = 'â­ï¸ ' + senderName;
                else if (msg.type === 'coadmin') senderName = 'âš¡ï¸ ' + senderName;
                else if (msg.type === 'operator') senderName = 'ğŸ› ï¸ ' + senderName;
                
                let deleteButton = '';
                if (currentUser && (msg.sender === currentUser.name || isAdmin || isCoAdmin || isOperator || isOwner)) {
                    deleteButton = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸</button>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user" onclick="openPrivateChat('${msg.sender}')">
                            ${senderName}
                        </span>
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div class="message-content">${msg.text}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        async function deleteMessage(messageId) {
            if (!messagesRef || !currentUser) return;
            
            if (confirm('Bu mesajÄ± silmek istediÄŸinize emin misiniz?')) {
                await messagesRef.child(messageId).remove();
            }
        }

        // ========== Ã–ZEL SOHBET ==========
        function openPrivateChat(username) {
            if (username === currentUser?.name) {
                addSystemMessage('Kendinle Ã¶zel sohbet baÅŸlatamazsÄ±n!');
                return;
            }
            
            privateChatWith = username;
            currentPrivateChatId = generateChatId(currentUser.name, username);
            
            document.getElementById('privateWith').textContent = `ğŸ”’ ${username} ile Ã¶zel sohbet`;
            document.getElementById('privateModal').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
            
            loadPrivateMessages();
            
            // OnChat'e ekle
            trackPrivateChat(username, username, false);
        }

        function closePrivateChat() {
            privateChatWith = null;
            currentPrivateChatId = null;
            document.getElementById('privateModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function generateChatId(user1, user2) {
            const users = [user1, user2].sort();
            return `chat_${users[0]}_${users[1]}`;
        }

        function loadPrivateMessages() {
            if (!currentPrivateChatId || !privateChatsRef) return;
            
            const container = document.getElementById('privateMessages');
            container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:20px;">YÃ¼kleniyor...</div>';
            
            privateChatsRef.child(currentPrivateChatId).limitToLast(50).on('value', (snapshot) => {
                updatePrivateMessages(snapshot.val());
            });
        }

        function updatePrivateMessages(messages) {
            const container = document.getElementById('privateMessages');
            
            if (!messages) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:20px;">HenÃ¼z mesaj yok.</div>';
                return;
            }
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = '';
            
            messagesArray.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'yt-message private-msg';
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="message-image" onclick="window.open('${msg.image}')">`;
                }
                
                let deleteButton = '';
                if (currentUser && msg.sender === currentUser.name) {
                    deleteButton = `<button class="delete-btn" onclick="deletePrivateMessage('${msg.id}')">ğŸ—‘ï¸</button>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user">
                            ${msg.sender === currentUser.name ? 'ğŸ‘¤ ' : ''}${msg.sender}
                        </span>
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        async function sendPrivateMessage() {
            if (!privateChatWith || !currentPrivateChatId || !privateChatsRef) return;
            
            const input = document.getElementById('private-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const messageData = {
                sender: currentUser.name,
                receiver: privateChatWith,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            await privateChatsRef.child(currentPrivateChatId).push(messageData);
            input.value = '';
            autoResize(input);
        }

        async function deletePrivateMessage(messageId) {
            if (!privateChatsRef || !currentPrivateChatId) return;
            
            if (confirm('Bu mesajÄ± silmek istediÄŸinize emin misiniz?')) {
                await privateChatsRef.child(currentPrivateChatId).child(messageId).remove();
            }
        }

        // Resim yÃ¼kleme
        document.getElementById('imageUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file || !privateChatWith) return;
            
            if (!file.type.startsWith('image/')) {
                alert('LÃ¼tfen sadece resim dosyasÄ± seÃ§in!');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Resim Ã§ok bÃ¼yÃ¼k! Maksimum 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                const imageData = event.target.result;
                
                const messageData = {
                    sender: currentUser.name,
                    receiver: privateChatWith,
                    text: 'ğŸ“¸ Resim gÃ¶nderdi',
                    image: imageData,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })
                };
                
                await privateChatsRef.child(currentPrivateChatId).push(messageData);
            };
            
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ========== ONCHAT SÄ°STEMÄ° ==========
        function trackPrivateChat(userId, userName, isReceived = false) {
            if (!activeChats[userId]) {
                activeChats[userId] = {
                    lastMessage: Date.now(),
                    unread: isReceived ? 1 : 0,
                    name: userName
                };
            } else {
                activeChats[userId].lastMessage = Date.now();
                if (isReceived) {
                    activeChats[userId].unread = (activeChats[userId].unread || 0) + 1;
                } else {
                    activeChats[userId].unread = 0;
                }
            }
            
            localStorage.setItem('activeChats', JSON.stringify(activeChats));
            updatePanel();
        }

        function loadActiveChats() {
            const saved = localStorage.getItem('activeChats');
            if (saved) {
                activeChats = JSON.parse(saved);
            }
        }

        function markChatAsRead(userId) {
            if (activeChats[userId]) {
                activeChats[userId].unread = 0;
                localStorage.setItem('activeChats', JSON.stringify(activeChats));
                updatePanel();
            }
        }

        // ========== PANEL SEKMELERÄ° ==========
        window.switchPanelTab = function(tab) {
            currentPanelTab = tab;
            document.getElementById('tabOnline').classList.toggle('active', tab === 'online');
            document.getElementById('tabOnchat').classList.toggle('active', tab === 'onchat');
            updatePanel();
        };

        function updatePanel() {
            const content = document.getElementById('panelContent');
            
            if (currentPanelTab === 'online') {
                let html = '<div class="section-title">Ã‡EVRÄ°MÄ°Ã‡Ä° (' + Object.keys(onlineUsers).length + ')</div>';
                
                let hasOthers = false;
                Object.keys(onlineUsers).forEach(userId => {
                    if (userId !== currentUser?.name && !blockedUsers[userId]) {
                        hasOthers = true;
                        const user = onlineUsers[userId];
                        const timeDiff = Date.now() - (user.lastSeen || 0);
                        const statusClass = timeDiff > 10000 ? 'status-idle' : 'status-online';
                        
                        let badge = '';
                        if (user.role === 'owner') badge = 'ğŸ¤´';
                        else if (user.role === 'admin') badge = 'â­ï¸';
                        else if (user.role === 'coadmin') badge = 'âš¡ï¸';
                        else if (user.role === 'operator') badge = 'ğŸ› ï¸';
                        
                        html += `
                            <div class="online-item" onclick="openPrivateChat('${userId}')">
                                <div class="online-status ${statusClass}"></div>
                                ${badge} ${userId}
                                <span style="margin-left: auto; font-size: 0.7rem;">${timeDiff < 5000 ? 'ÅŸimdi' : Math.floor(timeDiff/1000)+'sn'}</span>
                            </div>
                        `;
                    }
                });
                
                if (!hasOthers) {
                    html += '<div style="color: #606060; padding: 20px; text-align: center;">Ã‡evrimiÃ§i kullanÄ±cÄ± yok</div>';
                }
                
                content.innerHTML = html;
                
            } else {
                const chatUserIds = Object.keys(activeChats).sort((a, b) => 
                    activeChats[b].lastMessage - activeChats[a].lastMessage
                );
                
                let html = '<div class="section-title">KONUÅULANLAR (' + chatUserIds.length + ')</div>';
                
                if (chatUserIds.length === 0) {
                    html += '<div style="color: #606060; padding: 20px; text-align: center;">HenÃ¼z Ã¶zel sohbetiniz yok</div>';
                }
                
                chatUserIds.forEach(userId => {
                    const chat = activeChats[userId];
                    const lastActive = new Date(chat.lastMessage).toLocaleTimeString('tr-TR', {
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    const unreadBadge = chat.unread > 0 ? `<span class="unread-badge">${chat.unread}</span>` : '';
                    
                    html += `
                        <div class="chat-item" onclick="openPrivateChat('${userId}')">
                            <i class="fas fa-comment"></i>
                            ${chat.name} ${unreadBadge}
                            <span class="chat-badge">${lastActive}</span>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            }
        }

        // ========== KOMUTLAR ==========
        async function loadCustomCommands() {
            try {
                const snapshot = await customCommandsRef.once('value');
                customCommands = snapshot.val() || {};
            } catch (error) {
                console.error('Komut yÃ¼kleme hatasÄ±:', error);
            }
        }

        function handleCommand(cmd) {
            const parts = cmd.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            // Ã–zel komut kontrolÃ¼
            if (customCommands[command]) {
                addSystemMessage(customCommands[command].response);
                return;
            }
            
            switch(command) {
                case 'yardÄ±m':
                case 'help':
                    showHelp();
                    break;
                    
                case 'temizle':
                    if (isAdmin || isCoAdmin || isOperator || isOwner) {
                        if (confirm('TÃ¼m mesajlarÄ± temizlemek istediÄŸinize emin misiniz?')) {
                            messagesRef.remove();
                        }
                    } else {
                        addSystemMessage('â›” Yetkiniz yok!');
                    }
                    break;
                    
                case 'online':
                case 'kullanÄ±cÄ±lar':
                    showOnlineUsers();
                    break;
                    
                case 'profil':
                case 'profile':
                    showProfile();
                    break;
                    
                default:
                    addSystemMessage(`âŒ Bilinmeyen komut: ${command}`);
            }
        }

        function showHelp() {
            let help = 'ğŸ”¥ <strong>KOMUTLAR:</strong><br><br>';
            help += 'â€¢ /yardÄ±m - Bu menÃ¼yÃ¼ gÃ¶ster<br>';
            help += 'â€¢ /online - Online kullanÄ±cÄ±larÄ± gÃ¶ster<br>';
            help += 'â€¢ /profil - Profil bilgilerinizi gÃ¶ster<br>';
            help += 'â€¢ /temizle - TÃ¼m mesajlarÄ± temizle (yetkililer)<br>';
            
            if (Object.keys(customCommands).length > 0) {
                help += '<br>ğŸ“Œ <strong>Ã–ZEL KOMUTLAR:</strong><br>';
                Object.keys(customCommands).forEach(cmd => {
                    help += `â€¢ /${cmd}<br>`;
                });
            }
            
            addSystemMessage(help);
        }

        function showOnlineUsers() {
            let list = 'ğŸ‘¥ <strong>Online KullanÄ±cÄ±lar:</strong><br><br>';
            let count = 0;
            
            Object.keys(onlineUsers).forEach(userId => {
                if (userId !== currentUser?.name) {
                    count++;
                    list += `â€¢ ${userId}<br>`;
                }
            });
            
            if (count === 0) {
                list += 'BaÅŸka online kullanÄ±cÄ± yok.';
            } else {
                list += `<br>Toplam: ${count} kullanÄ±cÄ±`;
            }
            
            addSystemMessage(list);
        }

        function showProfile() {
            if (!currentUser) return;
            
            let profile = `ğŸ‘¤ <strong>${currentUser.name}</strong><br><br>`;
            profile += `â€¢ Rol: ${currentUser.role || 'user'}<br>`;
            profile += `â€¢ KayÄ±tlÄ±: ${currentUser.isRegistered ? 'Evet' : 'HayÄ±r'}<br>`;
            profile += `â€¢ KatÄ±lÄ±m: ${new Date(currentUser.joinedAt).toLocaleString('tr-TR')}<br>`;
            profile += `â€¢ KonuÅŸulan: ${Object.keys(activeChats).length} kiÅŸi`;
            
            addSystemMessage(profile);
        }

        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'yt-message system';
            messageDiv.innerHTML = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ========== STORY SÄ°STEMÄ° (BASÄ°T) ==========
        window.openStoryCreateModal = function() {
            addSystemMessage('ğŸ“± Story Ã¶zelliÄŸi yakÄ±nda...');
        };

        // ========== PROFÄ°L ==========
        window.showProfile = function() {
            showProfile();
        };

        // ========== BAÅLANGIÃ‡ ==========
        window.addEventListener('load', function() {
            initializeFirebase();
            loadActiveChats();
            
            // YouTube API
            window.onYouTubeIframeAPIReady = function() {
                console.log("ğŸ¬ YouTube API hazÄ±r!");
                if (!currentUser) return;
                initYouTubePlayer();
            };
        });
    </script>
</body>
</html>
