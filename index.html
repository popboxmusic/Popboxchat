<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popbox Elite - Firebase Realtime Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* TEMEL SIFIRLAMA */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        body.day-mode {
            background: #ffffff;
            color: #000000;
        }

        .hidden {
            display: none !important;
        }

        /* ... (T√úM MEVCUT CSS KODUNUZ AYNI KALACAK) ... */
        /* SADECE EKSƒ∞K OLAN KISIMLARI EKLƒ∞YORUM: */

        /* YENƒ∞ EKLENEN STƒ∞LLER - FIREBASE ENTEGRASYONU */
        .yt-message {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
            margin-bottom: 12px;
            animation: messageAppear 0.3s ease forwards;
        }
        
        .yt-message.owner { 
            border-left: 4px solid #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }
        
        .yt-message.admin { 
            border-left: 4px solid #FF6B6B;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .yt-message.coadmin { 
            border-left: 4px solid #4ECDC4;
            background: rgba(78, 205, 196, 0.05);
        }
        
        .yt-message.operator { 
            border-left: 4px solid #45B7D1;
            background: rgba(69, 183, 209, 0.05);
        }
        
        .yt-message.system { 
            border-left: 4px solid #96CEB4;
            background: rgba(150, 206, 180, 0.05);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-user {
            font-weight: 600;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .day-mode .message-user {
            color: rgba(0, 0, 0, 0.9);
        }
        
        .delete-btn {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }
        
        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.3);
        }
        
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .day-mode .message-image {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 0;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .day-mode .user-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-online { 
            background: #34c759;
            box-shadow: 0 0 8px #34c759;
        }
        
        .status-idle { 
            background: #ff9500;
            box-shadow: 0 0 8px #ff9500;
        }
        
        .status-offline { 
            background: #8e8e93;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
            display: none;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .owner-badge { 
            background: #FFD700; 
            color: #000; 
        }
        
        .admin-badge { 
            background: #FF6B6B; 
            color: #fff; 
        }
        
        .coadmin-badge { 
            background: #4ECDC4; 
            color: #fff; 
        }
        
        .operator-badge { 
            background: #45B7D1; 
            color: #fff; 
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        .day-mode .loading {
            border: 2px solid rgba(0,0,0,0.3);
            border-top-color: #000;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }
        
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .message-content {
            word-break: break-word;
            line-height: 1.4;
            padding: 4px 0;
        }
        
        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 4px;
        }
        
        .day-mode .message-time {
            color: rgba(0, 0, 0, 0.4);
        }
        
        /* FIREBASE BAƒûLANTI DURUMU */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .connection-online {
            background: rgba(52, 199, 89, 0.2);
            border: 1px solid rgba(52, 199, 89, 0.3);
            color: #34c759;
        }
        
        .connection-offline {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
        }
        
        /* SCROLLBAR G√úNCELLEMESƒ∞ */
        #messages {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        #messages::-webkit-scrollbar {
            width: 6px;
        }
        
        #messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        #messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        #messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* RESPONSIVE D√úZENLEMELER */
        @media (max-width: 768px) {
            .yt-message {
                padding: 10px 12px;
                margin-bottom: 8px;
            }
            
            .message-image {
                max-width: 200px;
                max-height: 200px;
            }
            
            .badge {
                font-size: 10px;
                padding: 1px 6px;
            }
        }

        /* YENƒ∞ Gƒ∞Rƒ∞≈û EKRANI STƒ∞LLERƒ∞ */
        .login-input {
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .login-btn {
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="night-mode">
    <!-- YOUTUBE Vƒ∞DEO PANELƒ∞ -->
    <div class="youtube-panel" id="youtubePanel">
        <!-- ... (MEVCUT YOUTUBE PANEL KODU AYNI) ... -->
    </div>

    <!-- PROFƒ∞L PANELƒ∞ -->
    <div class="profile-panel" id="profilePanel">
        <!-- ... (MEVCUT PROFƒ∞L PANEL KODU AYNI) ... -->
    </div>

    <!-- KOMUT PANELƒ∞ -->
    <div class="commands-panel" id="commandsPanel">
        <!-- ... (MEVCUT KOMUT PANEL KODU AYNI) ... -->
    </div>

    <!-- √ñZEL SOHBET PANELƒ∞ -->
    <div class="private-chat-panel" id="privateChatPanel">
        <!-- ... (MEVCUT √ñZEL SOHBET PANEL KODU AYNI) ... -->
    </div>

    <!-- BULANIK KATMAN -->
    <div class="blur-layer" id="blurLayer"></div>

    <!-- SOL BAR - ICON MENU -->
    <div class="icon-menu">
        <!-- BADGE'LER ƒ∞√áƒ∞N KONTEYNER -->
        <div style="position: relative; display: inline-block;">
            <div class="menu-icon active" onclick="togglePanel('online')" title="Online Listesi" id="onlineListBtn">
                <i class="fas fa-users"></i>
                <span class="badge owner-badge" id="ownerBadge">ü§¥</span>
                <span class="badge admin-badge" id="adminBadge">‚≠êÔ∏è</span>
                <span class="badge coadmin-badge" id="coadminBadge">‚ö°Ô∏è</span>
                <span class="badge operator-badge" id="operatorBadge">üõ†Ô∏è</span>
            </div>
        </div>
        
        <div class="menu-icon" onclick="toggleProfilePanel()" title="Profil" id="profileIconBtn">
            <i class="fas fa-user-circle"></i>
        </div>
        
        <div class="menu-icon" onclick="toggleTheme()" title="Tema Deƒüi≈ütir" id="themeToggle">
            <i class="fas fa-moon"></i>
        </div>
        
        <div class="menu-icon" onclick="openCommandsPanel()" title="IRC Komutlarƒ±">
            <i class="fas fa-terminal"></i>
        </div>
        
        <div class="menu-icon" onclick="openSettings()" title="Ayarlar">
            <i class="fas fa-cog"></i>
        </div>
        
        <div class="menu-icon" onclick="handleLogout()" title="√áƒ±kƒ±≈ü Yap">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        
        <!-- SOL BAR ALTINDAKƒ∞ PROFƒ∞L RESMƒ∞ -->
        <div class="profile-bottom-avatar" id="bottomProfileAvatar" onclick="toggleProfilePanel()">
            <span id="bottomAvatarText">M</span>
        </div>
    </div>

    <!-- SOL PANEL - ONLINE Lƒ∞STESƒ∞ -->
    <div class="online-panel" id="onlinePanel">
        <div class="online-header">
            <h3><i class="fas fa-users"></i> Online Listeler</h3>
            <div class="online-tabs">
                <div class="online-tab active" onclick="switchTab('online')">√áevrimi√ßi (<span id="onlineCount">0</span>)</div>
                <div class="online-tab" onclick="switchTab('chatting')">Sohbette (<span id="chatOnlineCount">0</span>)</div>
            </div>
        </div>
        
        <div class="nick-list" id="userList">
            <!-- Online kullanƒ±cƒ±lar Firebase'den y√ºklenecek -->
            <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Kullanƒ±cƒ±lar y√ºkleniyor...
            </div>
        </div>
    </div>

    <!-- ORTA PANEL - GENEL SOHBET -->
    <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
            <div class="chat-messages-container" id="messages">
                <!-- Mesajlar Firebase'den y√ºklenecek -->
                <div style="color: var(--text-secondary); text-align: center; padding: 40px;">
                    <i class="fas fa-comment-slash"></i><br>
                    Hen√ºz mesaj yok. ƒ∞lk mesajƒ± siz g√∂nderin!
                </div>
            </div>
        </div>
        
        <div class="message-input-area">
            <div class="message-input-wrapper">
                <!-- RESƒ∞M Y√úKLEME BUTONU -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button class="add-video-btn" onclick="document.getElementById('imageUpload').click()" title="Resim G√∂nder">
                    <i class="fas fa-image"></i>
                </button>
                
                <input type="text" id="message-input" class="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
                
                <button class="send-button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Gƒ∞Rƒ∞≈û PANELƒ∞ -->
    <div class="login-container" id="loginContainer">
        <div class="login-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="logo-text">Popbox Elite</div>
            </div>
            <h2 class="login-title">Firebase Realtime Chat</h2>
            <p class="login-subtitle">Ger√ßek Zamanlƒ± ‚Ä¢ Resim Payla≈üƒ±m ‚Ä¢ √ñzel Mesaj</p>
        </div>

        <div class="login-form">
            <!-- HATA MESAJI -->
            <div id="loginError" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- BA≈ûARI MESAJI -->
            <div id="loginSuccess" class="error-message" style="background: rgba(52, 199, 89, 0.2); border-color: rgba(52, 199, 89, 0.3); color: #34c759; display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="successText"></span>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-user"></i>
                    Kullanƒ±cƒ± Adƒ±
                </div>
                <input type="text" 
                       id="login-nick" 
                       class="login-input" 
                       placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin"
                       autofocus>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-lock"></i>
                    ≈ûifre (Owner i√ßin)
                </div>
                <input type="password" 
                       id="login-password" 
                       class="login-input" 
                       placeholder="Owner ≈üifresi (opsiyonel)">
            </div>

            <button class="login-btn" onclick="login()" id="login-btn">
                <span id="btnText">Sohbete Katƒ±l</span>
            </button>
        </div>

        <div class="login-footer">
            <div class="login-note">
                <p><strong>Firebase Realtime Database:</strong> Ger√ßek zamanlƒ± mesajla≈üma</p>
                <p style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.4);">
                    üî• Resim payla≈üƒ±m ‚Ä¢ üîê √ñzel mesaj ‚Ä¢ üõ°Ô∏è Admin panel
                </p>
            </div>
        </div>
    </div>

    <!-- RESƒ∞M MODAL -->
    <div id="imageModal" class="modal-overlay" style="display: none;" onclick="this.style.display='none'">
        <img id="modalImage" class="modal-image" src="" onclick="event.stopPropagation()">
    </div>

    <!-- BAƒûLANTI DURUMU -->
    <div id="connectionStatus" class="connection-status connection-offline" style="display: none;">
        <i class="fas fa-wifi"></i>
        <span>Baƒülantƒ± yok</span>
    </div>

    <script>
        // ========== FIREBASE KONFƒ∞G√úRASYONU ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXjX4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.firebasestorage.app",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835",
            measurementId: "G-SB1K22FLEX"
        };

        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let database;
        let usersRef;
        let messagesRef;
        let privateChatsRef;
        let coAdminsRef;
        let bansRef;
        let registeredUsersRef;
        let operatorsRef;
        let customCommandsRef;
        let adminListRef;
        let storiesRef;
        let storyLikesRef;
        let storyReportsRef;

        let isFirebaseConnected = false;
        let currentUser = null;
        let isAdmin = false;
        let isCoAdmin = false;
        let isOperator = false;
        let isOwner = false;
        let coAdminList = [];
        let operatorList = [];
        let adminList = [];
        let bannedUsers = {};
        let registeredUsers = {};
        let customCommands = {};
        let currentPrivateChatId = null;
        let isDayMode = false;
        let currentTab = 'online';
        let onlineUsers = [];

        // ========== G√úVENLƒ∞K KONFƒ∞G√úRASYONU ==========
        const SECURE_CONFIG = {
            DEFAULT_ADMINS: ['popbox', 'popboxmusic'],
            OWNER_CONFIG: {
                username: 'MateKy',
                role: 'owner',
                isHidden: true
            }
        };

        // ========== FIREBASE BA≈ûLATMA ==========
        function initializeFirebase() {
            try {
                console.log("üî• Firebase ba≈ülatƒ±lƒ±yor...");
                
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    const statusDiv = document.getElementById('connectionStatus');
                    if (snap.val() === true) {
                        console.log("‚úÖ Firebase'e BAƒûLANDI!");
                        isFirebaseConnected = true;
                        showLoginSuccess("üî• Firebase baƒülantƒ±sƒ± kuruldu!");
                        
                        statusDiv.className = 'connection-status connection-online';
                        statusDiv.innerHTML = '<i class="fas fa-wifi"></i><span>√áevrimi√ßi</span>';
                        statusDiv.style.display = 'flex';
                        
                        // Referanslarƒ± olu≈ütur
                        initializeFirebaseRefs();
                        
                    } else {
                        console.log("‚ùå Firebase baƒülantƒ±sƒ± KESƒ∞LDƒ∞");
                        isFirebaseConnected = false;
                        showLoginError("Firebase baƒülantƒ±sƒ± kesildi!");
                        
                        statusDiv.className = 'connection-status connection-offline';
                        statusDiv.innerHTML = '<i class="fas fa-wifi-slash"></i><span>√áevrimdƒ±≈üƒ±</span>';
                        statusDiv.style.display = 'flex';
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Firebase ba≈ülatma hatasƒ±:", error);
                showLoginError("Firebase ba≈ülatma hatasƒ±!");
            }
        }

        function initializeFirebaseRefs() {
            usersRef = database.ref('onlineUsers');
            messagesRef = database.ref('messages');
            privateChatsRef = database.ref('privateChats');
            coAdminsRef = database.ref('coAdmins');
            bansRef = database.ref('bans');
            registeredUsersRef = database.ref('registeredUsers');
            operatorsRef = database.ref('operators');
            customCommandsRef = database.ref('customCommands');
            adminListRef = database.ref('adminList');
            storiesRef = database.ref('stories');
            storyLikesRef = database.ref('storyLikes');
            storyReportsRef = database.ref('storyReports');
            
            loadCustomCommands();
            updateBannedUsers();
            startBanMonitoring();
        }

        // ========== SHA-256 ≈ûƒ∞FRELEME ==========
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ========== OWNER ≈ûƒ∞FRE Sƒ∞STEMƒ∞ ==========
        async function verifyOwnerPassword(inputPassword) {
            try {
                const ownerPassword = "Sahi17407@SCM";
                const salt = "popbox_secure_salt_2024";
                const combinedPassword = ownerPassword + salt;
                const storedHash = await sha256(combinedPassword);
                
                const inputHash = await sha256(inputPassword + salt);
                return inputHash === storedHash;
                
            } catch (error) {
                console.error("≈ûifre doƒürulama hatasƒ±:", error);
                return false;
            }
        }

        // ========== NICK NORMALƒ∞ZASYON ==========
        function normalizeNick(nick) {
            return nick ? nick.toLowerCase().trim() : '';
        }

        // ========== BENZER KULLANICI KONTROL√ú ==========
        async function checkExistingUsers(inputNick) {
            if (!usersRef) return [];
            
            try {
                const snapshot = await usersRef.once('value');
                const users = snapshot.val() || {};
                const similarUsers = [];
                
                const normalizedInput = normalizeNick(inputNick);
                
                Object.keys(users).forEach(username => {
                    if (normalizeNick(username) === normalizedInput) {
                        similarUsers.push(username);
                    }
                });
                
                return similarUsers;
            } catch (error) {
                console.error('Benzer kullanƒ±cƒ± kontrol hatasƒ±:', error);
                return [];
            }
        }

        // ========== BAN KONTROL√ú ==========
        async function checkIfBanned(username) {
            if (!bansRef) return { isBanned: false };
            
            try {
                const snapshot = await bansRef.child(username).once('value');
                const banData = snapshot.val();
                
                if (!banData) return { isBanned: false };
                
                if (banData.bannedUntil && Date.now() > banData.bannedUntil) {
                    await bansRef.child(username).remove();
                    return { isBanned: false };
                }
                
                return { isBanned: true, banData };
            } catch (error) {
                console.error('Ban kontrol hatasƒ±:', error);
                return { isBanned: false };
            }
        }

        // ========== Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const passwordInput = document.getElementById('login-password');
            const rawNick = nickInput.value.trim();
            const password = passwordInput.value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!rawNick) {
                showLoginError('‚ùå L√ºtfen bir kullanƒ±cƒ± adƒ± girin!');
                return;
            }
            
            if (!isFirebaseConnected || !usersRef) {
                showLoginError('‚ùå Firebase baƒülantƒ±sƒ± yok! L√ºtfen bekleyin...');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Kontrol ediliyor...';
            showLoginError('');
            showLoginSuccess('');
            
            try {
                const normalizedNick = normalizeNick(rawNick);
                const isOwnerUser = normalizedNick === normalizeNick(SECURE_CONFIG.OWNER_CONFIG.username);
                const similarUsers = await checkExistingUsers(rawNick);
                
                if (similarUsers.length > 0 && !isOwnerUser) {
                    showLoginError(`‚ö†Ô∏è BU NICK ZATEN KULLANIMDA!\n\nMevcut benzer kullanƒ±cƒ±lar: ${similarUsers.join(', ')}\n\nüí° L√ºtfen ba≈üka bir kullanƒ±cƒ± adƒ± se√ßin`);
                    resetLoginButton();
                    return;
                }
                
                const banCheck = await checkIfBanned(rawNick);
                if (banCheck.isBanned) {
                    const remaining = Math.ceil((banCheck.banData.bannedUntil - Date.now()) / 60000);
                    showLoginError(`üö´ BU KULLANICI BANLI!\n\nKalan S√ºre: ${remaining} dakika\nSebep: ${banCheck.banData.reason || 'Belirtilmemi≈ü'}`);
                    resetLoginButton();
                    return;
                }
                
                if (isOwnerUser) {
                    if (!password) {
                        showLoginError('üîê ≈ûifre gerekli!');
                        resetLoginButton();
                        return;
                    }
                    
                    const passwordValid = await verifyOwnerPassword(password);
                    if (!passwordValid) {
                        showLoginError('‚ùå Hatalƒ± ≈üifre!');
                        resetLoginButton();
                        return;
                    }
                    
                    await completeLogin(SECURE_CONFIG.OWNER_CONFIG.username, 'owner', true, null);
                    
                } else {
                    await completeLogin(rawNick, 'user', false, null);
                }
                
            } catch (error) {
                console.error('Giri≈ü hatasƒ±:', error);
                showLoginError(`‚ùå Giri≈ü hatasƒ±: ${error.message}`);
                resetLoginButton();
            }
        }

        function resetLoginButton() {
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sohbete Katƒ±l';
        }

        // ========== Gƒ∞Rƒ∞≈û TAMAMLAMA ==========
        async function completeLogin(username, role, isRegistered, userData) {
            const existingSnapshot = await usersRef.child(username).once('value');
            const existingUser = existingSnapshot.val();
            const now = Date.now();
            
            if (existingUser) {
                const lastSeen = existingUser.lastSeen || 0;
                const timeDiff = now - lastSeen;
                
                if (timeDiff < 30000) {
                    const seconds = Math.floor(timeDiff / 1000);
                    showLoginError(`‚õî "${username}" kullanƒ±cƒ±sƒ± ≈ûU ANDA AKTƒ∞F!\n\nSon aktivite: ${seconds} saniye √∂nce\nüí° L√ºtfen ba≈üka bir kullanƒ±cƒ± adƒ± se√ßin`);
                    resetLoginButton();
                    return;
                }
            }
            
            const userInfo = {
                name: username,
                lastSeen: now,
                joinedAt: now,
                isOnline: true,
                timestamp: now,
                role: role,
                isRegistered: isRegistered,
                isHidden: role === 'owner'
            };
            
            await usersRef.child(username).set(userInfo);
            
            currentUser = {
                name: username,
                role: role,
                isRegistered: isRegistered,
                data: userInfo
            };
            
            // Yetki badge'leri
            updateUserBadges(role);
            
            usersRef.child(username).onDisconnect().remove();
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('blurLayer').style.display = 'none';
            
            initApp();
            addSystemMessage(`üéâ Ho≈ü geldin, ${currentUser.name}!`);
        }

        function updateUserBadges(role) {
            if (role === 'owner') {
                isOwner = true;
                document.getElementById('ownerBadge').style.display = 'inline-block';
            } else if (role === 'admin') {
                isAdmin = true;
                document.getElementById('adminBadge').style.display = 'inline-block';
            } else if (role === 'coadmin') {
                isCoAdmin = true;
                document.getElementById('coadminBadge').style.display = 'inline-block';
            } else if (role === 'operator') {
                isOperator = true;
                document.getElementById('operatorBadge').style.display = 'inline-block';
            }
        }

        // ========== UYGULAMA BA≈ûLATMA ==========
        function initApp() {
            // Event listener'lar
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // Firebase listener'lar
            setupFirebaseListeners();
            
            // Interval'ler
            setupIntervals();
            
            // Window event'leri
            window.addEventListener('beforeunload', cleanupBeforeUnload);
        }

        function setupFirebaseListeners() {
            if (usersRef) {
                usersRef.on('value', (snapshot) => {
                    updateOnlineUsers(snapshot.val());
                });
            }
            
            if (messagesRef) {
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    updateMessages(snapshot.val());
                });
            }
            
            if (coAdminsRef) coAdminsRef.on('value', (snapshot) => { coAdminList = snapshot.val() || []; });
            if (operatorsRef) operatorsRef.on('value', (snapshot) => { operatorList = snapshot.val() || []; });
            if (adminListRef) adminListRef.on('value', (snapshot) => { adminList = snapshot.val() || []; });
        }

        function setupIntervals() {
            // Ban kontrol√º
            setInterval(async () => {
                if (currentUser && bansRef) {
                    const banCheck = await checkIfBanned(currentUser.name);
                    if (banCheck.isBanned) {
                        addSystemMessage("üö´ BANLANDINIZ! Sayfadan atƒ±lƒ±yorsunuz...");
                        logout();
                    }
                }
            }, 5000);
            
            // Son g√∂r√ºlme g√ºncellemesi
            setInterval(() => {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now(),
                        isOnline: true
                    });
                }
            }, 5000);
        }

        function cleanupBeforeUnload() {
            if (currentUser && usersRef) {
                usersRef.child(currentUser.name).remove();
            }
        }

        // ========== MESAJ G√ñNDERME ==========
        async function sendMessage() {
            if (!isFirebaseConnected) {
                addSystemMessage('‚ùå Firebase baƒülantƒ±sƒ± yok!');
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                return;
            }
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                type: getMessageType(),
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            };
            
            try {
                await messagesRef.push(messageData);
                input.value = '';
                
                if (usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now()
                    });
                }
            } catch (error) {
                console.error('Mesaj g√∂nderme hatasƒ±:', error);
                addSystemMessage('‚ùå Mesaj g√∂nderilemedi!');
            }
        }

        function getMessageType() {
            if (isOwner) return 'owner';
            if (isAdmin) return 'admin';
            if (isCoAdmin) return 'coadmin';
            if (isOperator) return 'operator';
            return 'user';
        }

        // ========== RESƒ∞M Y√úKLEME ==========
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Sadece resim dosyalarƒ± y√ºkleyebilirsiniz!');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Resim boyutu 5MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                const imageData = event.target.result;
                
                const messageData = {
                    sender: currentUser.name,
                    text: 'üì∏ Resim',
                    image: imageData,
                    type: getMessageType(),
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                };
                
                try {
                    await messagesRef.push(messageData);
                    document.getElementById('imageUpload').value = '';
                } catch (error) {
                    console.error('Resim g√∂nderme hatasƒ±:', error);
                    addSystemMessage('‚ùå Resim g√∂nderilemedi!');
                }
            };
            
            reader.readAsDataURL(file);
        }

        // ========== MESAJLARI G√úNCELLEME ==========
        function updateMessages(messages) {
            const container = document.getElementById('messages');
            if (!messages) return;
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            const recentMessages = messagesArray.slice(-50);
            
            container.innerHTML = '';
            
            recentMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                let messageClass = `yt-message ${msg.type || 'user'}`;
                
                let senderName = msg.sender;
                let roleIcon = '';
                
                switch(msg.type) {
                    case 'owner': roleIcon = 'ü§¥ '; break;
                    case 'admin': roleIcon = '‚≠êÔ∏è '; break;
                    case 'coadmin': roleIcon = '‚ö°Ô∏è '; break;
                    case 'operator': roleIcon = 'üõ†Ô∏è '; break;
                }
                
                messageDiv.className = messageClass;
                messageDiv.id = `msg_${msg.id}`;
                
                let deleteButton = '';
                if (currentUser && (msg.sender === currentUser.name || isAdmin || isCoAdmin || isOperator || isOwner)) {
                    deleteButton = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')" title="Sil">üóëÔ∏è</button>`;
                }
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="message-image" onclick="showImageModal('${msg.image}')" alt="G√∂nderilen resim">`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user" onclick="openPrivateChat('${msg.sender}')">
                            ${roleIcon}${senderName}
                        </span>
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // ========== ONLINE KULLANICILAR ==========
        function updateOnlineUsers(users) {
            if (!users) users = {};
            
            const now = Date.now();
            let onlineCount = 0;
            const activeUsers = [];
            
            Object.entries(users).forEach(([username, userData]) => {
                if (!userData) return;
                
                // Owner gizleme
                if (username === SECURE_CONFIG.OWNER_CONFIG.username && userData.isHidden && 
                    (!currentUser || currentUser.name !== SECURE_CONFIG.OWNER_CONFIG.username)) {
                    return;
                }
                
                const timeDiff = now - (userData.lastSeen || 0);
                const secondsAgo = Math.floor(timeDiff / 1000);
                
                if (secondsAgo < 30) {
                    onlineCount++;
                    activeUsers.push({
                        username: username,
                        ...userData,
                        secondsAgo: secondsAgo
                    });
                }
            });
            
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('chatOnlineCount').textContent = onlineCount;
            
            updateUserList(activeUsers);
        }

        function updateUserList(users) {
            const container = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:20px;">Hen√ºz kimse online deƒüil</div>';
                return;
            }
            
            users.sort((a, b) => a.secondsAgo - b.secondsAgo);
            
            let html = '';
            users.forEach(user => {
                const isCurrentUser = user.username === (currentUser?.name || '');
                const statusClass = user.secondsAgo > 10 ? 'idle' : '';
                let roleIcon = '';
                
                switch(user.role) {
                    case 'owner': roleIcon = 'ü§¥'; break;
                    case 'admin': roleIcon = '‚≠êÔ∏è'; break;
                    case 'coadmin': roleIcon = '‚ö°Ô∏è'; break;
                    case 'operator': roleIcon = 'üõ†Ô∏è'; break;
                }
                
                html += `
                    <div class="user-item ${statusClass}" onclick="openPrivateChat('${user.username}')">
                        <div class="user-status">
                            <span class="status-dot ${user.secondsAgo > 10 ? 'status-idle' : 'status-online'}"></span>
                            <strong>${isCurrentUser ? 'üë§ ' : ''}${user.username}</strong>
                            ${roleIcon}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${user.secondsAgo < 5 ? '≈ûimdi' : user.secondsAgo + 'sn'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== √ñZEL MESAJ Sƒ∞STEMƒ∞ ==========
        function generateChatId(user1, user2) {
            const users = [user1, user2].sort();
            return `${users[0]}_${users[1]}`;
        }

        function openPrivateChat(username) {
            if (username === currentUser.name) return;
            
            currentPrivateChatId = generateChatId(currentUser.name, username);
            
            // UI g√ºncelleme
            document.getElementById('privateChatUserName').textContent = username;
            document.getElementById('privateChatPanel').classList.add('active');
            
            // Mesajlarƒ± dinle
            if (privateChatsRef) {
                privateChatsRef.child(currentPrivateChatId).on('value', (snapshot) => {
                    updatePrivateMessages(snapshot.val());
                });
            }
        }

        function updatePrivateMessages(messages) {
            const container = document.getElementById('privateChatMessages');
            if (!messages) {
                container.innerHTML = '';
                return;
            }
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            let html = '';
            messagesArray.forEach(msg => {
                const isCurrentUser = msg.sender === currentUser.name;
                const messageClass = isCurrentUser ? 'private-message right' : 'private-message left';
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="private-message-image" onclick="showImageModal('${msg.image}')">`;
                }
                
                html += `
                    <div class="${messageClass}">
                        <div class="message-user">
                            <div class="message-user-name">${msg.sender}</div>
                        </div>
                        <div class="message-content">${content}</div>
                        <div class="message-time">${msg.time || '--:--'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        async function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            
            if (!text || !currentPrivateChatId || !privateChatsRef) return;
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            };
            
            try {
                await privateChatsRef.child(currentPrivateChatId).push(messageData);
                input.value = '';
            } catch (error) {
                console.error('√ñzel mesaj g√∂nderme hatasƒ±:', error);
            }
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChatId = null;
            document.getElementById('privateMessageInput').value = '';
            
            if (privateChatsRef && currentPrivateChatId) {
                privateChatsRef.child(currentPrivateChatId).off();
            }
        }

        // ========== Dƒ∞ƒûER FONKSƒ∞YONLAR ==========
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            errorText.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.style.display = 'flex';
            document.getElementById('loginSuccess').style.display = 'none';
        }

        function showLoginSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
        }

        function addSystemMessage(message) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'yt-message system';
            messageDiv.innerHTML = `
                <div class="message-content" style="color: #96CEB4; text-align: center; font-style: italic;">
                    ‚ö° ${message}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function deleteMessage(messageId) {
            if (!isFirebaseConnected || !messagesRef) return;
            
            if (confirm('Bu mesajƒ± silmek istediƒüinize emin misiniz?')) {
                messagesRef.child(messageId).remove()
                    .then(() => console.log('Mesaj silindi:', messageId))
                    .catch((error) => console.error('Mesaj silme hatasƒ±:', error));
            }
        }

        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.style.display = 'flex';
        }

        function logout() {
            if (currentUser && usersRef) {
                usersRef.child(currentUser.name).remove();
            }
            
            // Listener'larƒ± temizle
            if (messagesRef) messagesRef.off();
            if (usersRef) usersRef.off();
            if (privateChatsRef && currentPrivateChatId) {
                privateChatsRef.child(currentPrivateChatId).off();
            }
            
            location.reload();
        }

        // ========== EKSƒ∞K FONKSƒ∞YONLAR ==========
        function handleCommand(command) {
            const commands = {
                '/clear': () => { document.getElementById('messages').innerHTML = ''; },
                '/help': () => { alert('Mevcut komutlar:\n/clear - Mesajlarƒ± temizle\n/help - Yardƒ±m\n/users - Online kullanƒ±cƒ±lar\n/theme - Tema deƒüi≈ütir'); },
                '/users': () => { alert(`√áevrimi√ßi kullanƒ±cƒ± sayƒ±sƒ±: ${document.getElementById('onlineCount').textContent}`); },
                '/theme': () => { toggleTheme(); },
                '/msg': () => { 
                    const parts = command.split(' ');
                    if (parts.length >= 3) {
                        const username = parts[1];
                        const message = parts.slice(2).join(' ');
                        openPrivateChat(username);
                        setTimeout(() => {
                            document.getElementById('privateMessageInput').value = message;
                            sendPrivateMessage();
                        }, 500);
                    }
                }
            };
            
            const cmd = command.split(' ')[0];
            if (commands[cmd]) {
                commands[cmd]();
            } else {
                addSystemMessage(`‚ùå Bilinmeyen komut: ${cmd}`);
            }
        }

        function loadCustomCommands() {
            console.log('√ñzel komutlar y√ºkleniyor...');
            // Firebase'den √∂zel komutlarƒ± y√ºkle
        }

        function updateBannedUsers() {
            console.log('Banlƒ± kullanƒ±cƒ±lar g√ºncelleniyor...');
            // Firebase'den ban listesini g√ºncelle
        }

        function startBanMonitoring() {
            console.log('Ban izleme ba≈ülatƒ±ldƒ±');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('chatTheme');
            if (savedTheme === 'day-mode') {
                toggleTheme();
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeToggle').querySelector('i');
            
            if (isDayMode) {
                body.classList.remove('day-mode');
                themeBtn.className = 'fas fa-moon';
                isDayMode = false;
                localStorage.setItem('chatTheme', 'night-mode');
            } else {
                body.classList.add('day-mode');
                themeBtn.className = 'fas fa-sun';
                isDayMode = true;
                localStorage.setItem('chatTheme', 'day-mode');
            }
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        window.addEventListener('load', function() {
            console.log("üì± Sayfa y√ºklendi!");
            
            loadTheme();
            initializeFirebase();
            
            document.getElementById('login-nick').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('login-nick').focus();
            
            // Enter tu≈üu ile mesaj g√∂nderme
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popbox Elite - Firebase Realtime Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* TEMEL SIFIRLAMA */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        body.day-mode {
            background: #ffffff;
            color: #000000;
        }

        .hidden {
            display: none !important;
        }

        /* ... (T√úM MEVCUT CSS KODUNUZ AYNI KALACAK) ... */
        /* SADECE EKSƒ∞K OLAN KISIMLARI EKLƒ∞YORUM: */

        /* YENƒ∞ EKLENEN STƒ∞LLER - FIREBASE ENTEGRASYONU */
        .yt-message {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
            margin-bottom: 12px;
            animation: messageAppear 0.3s ease forwards;
        }
        
        .yt-message.owner { 
            border-left: 4px solid #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }
        
        .yt-message.admin { 
            border-left: 4px solid #FF6B6B;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .yt-message.coadmin { 
            border-left: 4px solid #4ECDC4;
            background: rgba(78, 205, 196, 0.05);
        }
        
        .yt-message.operator { 
            border-left: 4px solid #45B7D1;
            background: rgba(69, 183, 209, 0.05);
        }
        
        .yt-message.system { 
            border-left: 4px solid #96CEB4;
            background: rgba(150, 206, 180, 0.05);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-user {
            font-weight: 600;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .day-mode .message-user {
            color: rgba(0, 0, 0, 0.9);
        }
        
        .delete-btn {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }
        
        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.3);
        }
        
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .day-mode .message-image {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 0;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .day-mode .user-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-online { 
            background: #34c759;
            box-shadow: 0 0 8px #34c759;
        }
        
        .status-idle { 
            background: #ff9500;
            box-shadow: 0 0 8px #ff9500;
        }
        
        .status-offline { 
            background: #8e8e93;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
            display: none;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .owner-badge { 
            background: #FFD700; 
            color: #000; 
        }
        
        .admin-badge { 
            background: #FF6B6B; 
            color: #fff; 
        }
        
        .coadmin-badge { 
            background: #4ECDC4; 
            color: #fff; 
        }
        
        .operator-badge { 
            background: #45B7D1; 
            color: #fff; 
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        .day-mode .loading {
            border: 2px solid rgba(0,0,0,0.3);
            border-top-color: #000;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }
        
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .message-content {
            word-break: break-word;
            line-height: 1.4;
            padding: 4px 0;
        }
        
        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 4px;
        }
        
        .day-mode .message-time {
            color: rgba(0, 0, 0, 0.4);
        }
        
        /* FIREBASE BAƒûLANTI DURUMU */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .connection-online {
            background: rgba(52, 199, 89, 0.2);
            border: 1px solid rgba(52, 199, 89, 0.3);
            color: #34c759;
        }
        
        .connection-offline {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
        }
        
        /* SCROLLBAR G√úNCELLEMESƒ∞ */
        #messages {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        #messages::-webkit-scrollbar {
            width: 6px;
        }
        
        #messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        #messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        #messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* RESPONSIVE D√úZENLEMELER */
        @media (max-width: 768px) {
            .yt-message {
                padding: 10px 12px;
                margin-bottom: 8px;
            }
            
            .message-image {
                max-width: 200px;
                max-height: 200px;
            }
            
            .badge {
                font-size: 10px;
                padding: 1px 6px;
            }
        }

        /* YENƒ∞ Gƒ∞Rƒ∞≈û EKRANI STƒ∞LLERƒ∞ */
        .login-input {
            transition: all 0.3s ease;
        }
        
        .login-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .login-btn {
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="night-mode">
    <!-- YOUTUBE Vƒ∞DEO PANELƒ∞ -->
    <div class="youtube-panel" id="youtubePanel">
        <!-- ... (MEVCUT YOUTUBE PANEL KODU AYNI) ... -->
    </div>

    <!-- PROFƒ∞L PANELƒ∞ -->
    <div class="profile-panel" id="profilePanel">
        <!-- ... (MEVCUT PROFƒ∞L PANEL KODU AYNI) ... -->
    </div>

    <!-- KOMUT PANELƒ∞ -->
    <div class="commands-panel" id="commandsPanel">
        <!-- ... (MEVCUT KOMUT PANEL KODU AYNI) ... -->
    </div>

    <!-- √ñZEL SOHBET PANELƒ∞ -->
    <div class="private-chat-panel" id="privateChatPanel">
        <!-- ... (MEVCUT √ñZEL SOHBET PANEL KODU AYNI) ... -->
    </div>

    <!-- BULANIK KATMAN -->
    <div class="blur-layer" id="blurLayer"></div>

    <!-- SOL BAR - ICON MENU -->
    <div class="icon-menu">
        <!-- BADGE'LER ƒ∞√áƒ∞N KONTEYNER -->
        <div style="position: relative; display: inline-block;">
            <div class="menu-icon active" onclick="togglePanel('online')" title="Online Listesi" id="onlineListBtn">
                <i class="fas fa-users"></i>
                <span class="badge owner-badge" id="ownerBadge">ü§¥</span>
                <span class="badge admin-badge" id="adminBadge">‚≠êÔ∏è</span>
                <span class="badge coadmin-badge" id="coadminBadge">‚ö°Ô∏è</span>
                <span class="badge operator-badge" id="operatorBadge">üõ†Ô∏è</span>
            </div>
        </div>
        
        <div class="menu-icon" onclick="toggleProfilePanel()" title="Profil" id="profileIconBtn">
            <i class="fas fa-user-circle"></i>
        </div>
        
        <div class="menu-icon" onclick="toggleTheme()" title="Tema Deƒüi≈ütir" id="themeToggle">
            <i class="fas fa-moon"></i>
        </div>
        
        <div class="menu-icon" onclick="openCommandsPanel()" title="IRC Komutlarƒ±">
            <i class="fas fa-terminal"></i>
        </div>
        
        <div class="menu-icon" onclick="openSettings()" title="Ayarlar">
            <i class="fas fa-cog"></i>
        </div>
        
        <div class="menu-icon" onclick="handleLogout()" title="√áƒ±kƒ±≈ü Yap">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        
        <!-- SOL BAR ALTINDAKƒ∞ PROFƒ∞L RESMƒ∞ -->
        <div class="profile-bottom-avatar" id="bottomProfileAvatar" onclick="toggleProfilePanel()">
            <span id="bottomAvatarText">M</span>
        </div>
    </div>

    <!-- SOL PANEL - ONLINE Lƒ∞STESƒ∞ -->
    <div class="online-panel" id="onlinePanel">
        <div class="online-header">
            <h3><i class="fas fa-users"></i> Online Listeler</h3>
            <div class="online-tabs">
                <div class="online-tab active" onclick="switchTab('online')">√áevrimi√ßi (<span id="onlineCount">0</span>)</div>
                <div class="online-tab" onclick="switchTab('chatting')">Sohbette (<span id="chatOnlineCount">0</span>)</div>
            </div>
        </div>
        
        <div class="nick-list" id="userList">
            <!-- Online kullanƒ±cƒ±lar Firebase'den y√ºklenecek -->
            <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Kullanƒ±cƒ±lar y√ºkleniyor...
            </div>
        </div>
    </div>

    <!-- ORTA PANEL - GENEL SOHBET -->
    <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
            <div class="chat-messages-container" id="messages">
                <!-- Mesajlar Firebase'den y√ºklenecek -->
                <div style="color: var(--text-secondary); text-align: center; padding: 40px;">
                    <i class="fas fa-comment-slash"></i><br>
                    Hen√ºz mesaj yok. ƒ∞lk mesajƒ± siz g√∂nderin!
                </div>
            </div>
        </div>
        
        <div class="message-input-area">
            <div class="message-input-wrapper">
                <!-- RESƒ∞M Y√úKLEME BUTONU -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button class="add-video-btn" onclick="document.getElementById('imageUpload').click()" title="Resim G√∂nder">
                    <i class="fas fa-image"></i>
                </button>
                
                <input type="text" id="message-input" class="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
                
                <button class="send-button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Gƒ∞Rƒ∞≈û PANELƒ∞ -->
    <div class="login-container" id="loginContainer">
        <div class="login-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="logo-text">Popbox Elite</div>
            </div>
            <h2 class="login-title">Firebase Realtime Chat</h2>
            <p class="login-subtitle">Ger√ßek Zamanlƒ± ‚Ä¢ Resim Payla≈üƒ±m ‚Ä¢ √ñzel Mesaj</p>
        </div>

        <div class="login-form">
            <!-- HATA MESAJI -->
            <div id="loginError" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- BA≈ûARI MESAJI -->
            <div id="loginSuccess" class="error-message" style="background: rgba(52, 199, 89, 0.2); border-color: rgba(52, 199, 89, 0.3); color: #34c759; display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="successText"></span>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-user"></i>
                    Kullanƒ±cƒ± Adƒ±
                </div>
                <input type="text" 
                       id="login-nick" 
                       class="login-input" 
                       placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin"
                       autofocus>
            </div>

            <div class="input-group">
                <div class="input-label">
                    <i class="fas fa-lock"></i>
                    ≈ûifre (Owner i√ßin)
                </div>
                <input type="password" 
                       id="login-password" 
                       class="login-input" 
                       placeholder="Owner ≈üifresi (opsiyonel)">
            </div>

            <button class="login-btn" onclick="login()" id="login-btn">
                <span id="btnText">Sohbete Katƒ±l</span>
            </button>
        </div>

        <div class="login-footer">
            <div class="login-note">
                <p><strong>Firebase Realtime Database:</strong> Ger√ßek zamanlƒ± mesajla≈üma</p>
                <p style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.4);">
                    üî• Resim payla≈üƒ±m ‚Ä¢ üîê √ñzel mesaj ‚Ä¢ üõ°Ô∏è Admin panel
                </p>
            </div>
        </div>
    </div>

    <!-- RESƒ∞M MODAL -->
    <div id="imageModal" class="modal-overlay" style="display: none;" onclick="this.style.display='none'">
        <img id="modalImage" class="modal-image" src="" onclick="event.stopPropagation()">
    </div>

    <!-- BAƒûLANTI DURUMU -->
    <div id="connectionStatus" class="connection-status connection-offline" style="display: none;">
        <i class="fas fa-wifi"></i>
        <span>Baƒülantƒ± yok</span>
    </div>

    <script>
        // ========== FIREBASE KONFƒ∞G√úRASYONU ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXjX4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.firebasestorage.app",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835",
            measurementId: "G-SB1K22FLEX"
        };

        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let database;
        let usersRef;
        let messagesRef;
        let privateChatsRef;
        let coAdminsRef;
        let bansRef;
        let registeredUsersRef;
        let operatorsRef;
        let customCommandsRef;
        let adminListRef;
        let storiesRef;
        let storyLikesRef;
        let storyReportsRef;

        let isFirebaseConnected = false;
        let currentUser = null;
        let isAdmin = false;
        let isCoAdmin = false;
        let isOperator = false;
        let isOwner = false;
        let coAdminList = [];
        let operatorList = [];
        let adminList = [];
        let bannedUsers = {};
        let registeredUsers = {};
        let customCommands = {};
        let currentPrivateChatId = null;
        let isDayMode = false;
        let currentTab = 'online';
        let onlineUsers = [];

        // ========== G√úVENLƒ∞K KONFƒ∞G√úRASYONU ==========
        const SECURE_CONFIG = {
            DEFAULT_ADMINS: ['popbox', 'popboxmusic'],
            OWNER_CONFIG: {
                username: 'MateKy',
                role: 'owner',
                isHidden: true
            }
        };

        // ========== FIREBASE BA≈ûLATMA ==========
        function initializeFirebase() {
            try {
                console.log("üî• Firebase ba≈ülatƒ±lƒ±yor...");
                
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    const statusDiv = document.getElementById('connectionStatus');
                    if (snap.val() === true) {
                        console.log("‚úÖ Firebase'e BAƒûLANDI!");
                        isFirebaseConnected = true;
                        showLoginSuccess("üî• Firebase baƒülantƒ±sƒ± kuruldu!");
                        
                        statusDiv.className = 'connection-status connection-online';
                        statusDiv.innerHTML = '<i class="fas fa-wifi"></i><span>√áevrimi√ßi</span>';
                        statusDiv.style.display = 'flex';
                        
                        // Referanslarƒ± olu≈ütur
                        initializeFirebaseRefs();
                        
                    } else {
                        console.log("‚ùå Firebase baƒülantƒ±sƒ± KESƒ∞LDƒ∞");
                        isFirebaseConnected = false;
                        showLoginError("Firebase baƒülantƒ±sƒ± kesildi!");
                        
                        statusDiv.className = 'connection-status connection-offline';
                        statusDiv.innerHTML = '<i class="fas fa-wifi-slash"></i><span>√áevrimdƒ±≈üƒ±</span>';
                        statusDiv.style.display = 'flex';
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Firebase ba≈ülatma hatasƒ±:", error);
                showLoginError("Firebase ba≈ülatma hatasƒ±!");
            }
        }

        function initializeFirebaseRefs() {
            usersRef = database.ref('onlineUsers');
            messagesRef = database.ref('messages');
            privateChatsRef = database.ref('privateChats');
            coAdminsRef = database.ref('coAdmins');
            bansRef = database.ref('bans');
            registeredUsersRef = database.ref('registeredUsers');
            operatorsRef = database.ref('operators');
            customCommandsRef = database.ref('customCommands');
            adminListRef = database.ref('adminList');
            storiesRef = database.ref('stories');
            storyLikesRef = database.ref('storyLikes');
            storyReportsRef = database.ref('storyReports');
            
            loadCustomCommands();
            updateBannedUsers();
            startBanMonitoring();
        }

        // ========== SHA-256 ≈ûƒ∞FRELEME ==========
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ========== OWNER ≈ûƒ∞FRE Sƒ∞STEMƒ∞ ==========
        async function verifyOwnerPassword(inputPassword) {
            try {
                const ownerPassword = "Sahi17407@SCM";
                const salt = "popbox_secure_salt_2024";
                const combinedPassword = ownerPassword + salt;
                const storedHash = await sha256(combinedPassword);
                
                const inputHash = await sha256(inputPassword + salt);
                return inputHash === storedHash;
                
            } catch (error) {
                console.error("≈ûifre doƒürulama hatasƒ±:", error);
                return false;
            }
        }

        // ========== NICK NORMALƒ∞ZASYON ==========
        function normalizeNick(nick) {
            return nick ? nick.toLowerCase().trim() : '';
        }

        // ========== BENZER KULLANICI KONTROL√ú ==========
        async function checkExistingUsers(inputNick) {
            if (!usersRef) return [];
            
            try {
                const snapshot = await usersRef.once('value');
                const users = snapshot.val() || {};
                const similarUsers = [];
                
                const normalizedInput = normalizeNick(inputNick);
                
                Object.keys(users).forEach(username => {
                    if (normalizeNick(username) === normalizedInput) {
                        similarUsers.push(username);
                    }
                });
                
                return similarUsers;
            } catch (error) {
                console.error('Benzer kullanƒ±cƒ± kontrol hatasƒ±:', error);
                return [];
            }
        }

        // ========== BAN KONTROL√ú ==========
        async function checkIfBanned(username) {
            if (!bansRef) return { isBanned: false };
            
            try {
                const snapshot = await bansRef.child(username).once('value');
                const banData = snapshot.val();
                
                if (!banData) return { isBanned: false };
                
                if (banData.bannedUntil && Date.now() > banData.bannedUntil) {
                    await bansRef.child(username).remove();
                    return { isBanned: false };
                }
                
                return { isBanned: true, banData };
            } catch (error) {
                console.error('Ban kontrol hatasƒ±:', error);
                return { isBanned: false };
            }
        }

        // ========== Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ==========
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const passwordInput = document.getElementById('login-password');
            const rawNick = nickInput.value.trim();
            const password = passwordInput.value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!rawNick) {
                showLoginError('‚ùå L√ºtfen bir kullanƒ±cƒ± adƒ± girin!');
                return;
            }
            
            if (!isFirebaseConnected || !usersRef) {
                showLoginError('‚ùå Firebase baƒülantƒ±sƒ± yok! L√ºtfen bekleyin...');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Kontrol ediliyor...';
            showLoginError('');
            showLoginSuccess('');
            
            try {
                const normalizedNick = normalizeNick(rawNick);
                const isOwnerUser = normalizedNick === normalizeNick(SECURE_CONFIG.OWNER_CONFIG.username);
                const similarUsers = await checkExistingUsers(rawNick);
                
                if (similarUsers.length > 0 && !isOwnerUser) {
                    showLoginError(`‚ö†Ô∏è BU NICK ZATEN KULLANIMDA!\n\nMevcut benzer kullanƒ±cƒ±lar: ${similarUsers.join(', ')}\n\nüí° L√ºtfen ba≈üka bir kullanƒ±cƒ± adƒ± se√ßin`);
                    resetLoginButton();
                    return;
                }
                
                const banCheck = await checkIfBanned(rawNick);
                if (banCheck.isBanned) {
                    const remaining = Math.ceil((banCheck.banData.bannedUntil - Date.now()) / 60000);
                    showLoginError(`üö´ BU KULLANICI BANLI!\n\nKalan S√ºre: ${remaining} dakika\nSebep: ${banCheck.banData.reason || 'Belirtilmemi≈ü'}`);
                    resetLoginButton();
                    return;
                }
                
                if (isOwnerUser) {
                    if (!password) {
                        showLoginError('üîê ≈ûifre gerekli!');
                        resetLoginButton();
                        return;
                    }
                    
                    const passwordValid = await verifyOwnerPassword(password);
                    if (!passwordValid) {
                        showLoginError('‚ùå Hatalƒ± ≈üifre!');
                        resetLoginButton();
                        return;
                    }
                    
                    await completeLogin(SECURE_CONFIG.OWNER_CONFIG.username, 'owner', true, null);
                    
                } else {
                    await completeLogin(rawNick, 'user', false, null);
                }
                
            } catch (error) {
                console.error('Giri≈ü hatasƒ±:', error);
                showLoginError(`‚ùå Giri≈ü hatasƒ±: ${error.message}`);
                resetLoginButton();
            }
        }

        function resetLoginButton() {
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sohbete Katƒ±l';
        }

        // ========== Gƒ∞Rƒ∞≈û TAMAMLAMA ==========
        async function completeLogin(username, role, isRegistered, userData) {
            const existingSnapshot = await usersRef.child(username).once('value');
            const existingUser = existingSnapshot.val();
            const now = Date.now();
            
            if (existingUser) {
                const lastSeen = existingUser.lastSeen || 0;
                const timeDiff = now - lastSeen;
                
                if (timeDiff < 30000) {
                    const seconds = Math.floor(timeDiff / 1000);
                    showLoginError(`‚õî "${username}" kullanƒ±cƒ±sƒ± ≈ûU ANDA AKTƒ∞F!\n\nSon aktivite: ${seconds} saniye √∂nce\nüí° L√ºtfen ba≈üka bir kullanƒ±cƒ± adƒ± se√ßin`);
                    resetLoginButton();
                    return;
                }
            }
            
            const userInfo = {
                name: username,
                lastSeen: now,
                joinedAt: now,
                isOnline: true,
                timestamp: now,
                role: role,
                isRegistered: isRegistered,
                isHidden: role === 'owner'
            };
            
            await usersRef.child(username).set(userInfo);
            
            currentUser = {
                name: username,
                role: role,
                isRegistered: isRegistered,
                data: userInfo
            };
            
            // Yetki badge'leri
            updateUserBadges(role);
            
            usersRef.child(username).onDisconnect().remove();
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('blurLayer').style.display = 'none';
            
            initApp();
            addSystemMessage(`üéâ Ho≈ü geldin, ${currentUser.name}!`);
        }

        function updateUserBadges(role) {
            if (role === 'owner') {
                isOwner = true;
                document.getElementById('ownerBadge').style.display = 'inline-block';
            } else if (role === 'admin') {
                isAdmin = true;
                document.getElementById('adminBadge').style.display = 'inline-block';
            } else if (role === 'coadmin') {
                isCoAdmin = true;
                document.getElementById('coadminBadge').style.display = 'inline-block';
            } else if (role === 'operator') {
                isOperator = true;
                document.getElementById('operatorBadge').style.display = 'inline-block';
            }
        }

        // ========== UYGULAMA BA≈ûLATMA ==========
        function initApp() {
            // Event listener'lar
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // Firebase listener'lar
            setupFirebaseListeners();
            
            // Interval'ler
            setupIntervals();
            
            // Window event'leri
            window.addEventListener('beforeunload', cleanupBeforeUnload);
        }

        function setupFirebaseListeners() {
            if (usersRef) {
                usersRef.on('value', (snapshot) => {
                    updateOnlineUsers(snapshot.val());
                });
            }
            
            if (messagesRef) {
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    updateMessages(snapshot.val());
                });
            }
            
            if (coAdminsRef) coAdminsRef.on('value', (snapshot) => { coAdminList = snapshot.val() || []; });
            if (operatorsRef) operatorsRef.on('value', (snapshot) => { operatorList = snapshot.val() || []; });
            if (adminListRef) adminListRef.on('value', (snapshot) => { adminList = snapshot.val() || []; });
        }

        function setupIntervals() {
            // Ban kontrol√º
            setInterval(async () => {
                if (currentUser && bansRef) {
                    const banCheck = await checkIfBanned(currentUser.name);
                    if (banCheck.isBanned) {
                        addSystemMessage("üö´ BANLANDINIZ! Sayfadan atƒ±lƒ±yorsunuz...");
                        logout();
                    }
                }
            }, 5000);
            
            // Son g√∂r√ºlme g√ºncellemesi
            setInterval(() => {
                if (currentUser && usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now(),
                        isOnline: true
                    });
                }
            }, 5000);
        }

        function cleanupBeforeUnload() {
            if (currentUser && usersRef) {
                usersRef.child(currentUser.name).remove();
            }
        }

        // ========== MESAJ G√ñNDERME ==========
        async function sendMessage() {
            if (!isFirebaseConnected) {
                addSystemMessage('‚ùå Firebase baƒülantƒ±sƒ± yok!');
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                return;
            }
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                type: getMessageType(),
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            };
            
            try {
                await messagesRef.push(messageData);
                input.value = '';
                
                if (usersRef) {
                    usersRef.child(currentUser.name).update({
                        lastSeen: Date.now()
                    });
                }
            } catch (error) {
                console.error('Mesaj g√∂nderme hatasƒ±:', error);
                addSystemMessage('‚ùå Mesaj g√∂nderilemedi!');
            }
        }

        function getMessageType() {
            if (isOwner) return 'owner';
            if (isAdmin) return 'admin';
            if (isCoAdmin) return 'coadmin';
            if (isOperator) return 'operator';
            return 'user';
        }

        // ========== RESƒ∞M Y√úKLEME ==========
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Sadece resim dosyalarƒ± y√ºkleyebilirsiniz!');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Resim boyutu 5MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                const imageData = event.target.result;
                
                const messageData = {
                    sender: currentUser.name,
                    text: 'üì∏ Resim',
                    image: imageData,
                    type: getMessageType(),
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                };
                
                try {
                    await messagesRef.push(messageData);
                    document.getElementById('imageUpload').value = '';
                } catch (error) {
                    console.error('Resim g√∂nderme hatasƒ±:', error);
                    addSystemMessage('‚ùå Resim g√∂nderilemedi!');
                }
            };
            
            reader.readAsDataURL(file);
        }

        // ========== MESAJLARI G√úNCELLEME ==========
        function updateMessages(messages) {
            const container = document.getElementById('messages');
            if (!messages) return;
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            const recentMessages = messagesArray.slice(-50);
            
            container.innerHTML = '';
            
            recentMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                let messageClass = `yt-message ${msg.type || 'user'}`;
                
                let senderName = msg.sender;
                let roleIcon = '';
                
                switch(msg.type) {
                    case 'owner': roleIcon = 'ü§¥ '; break;
                    case 'admin': roleIcon = '‚≠êÔ∏è '; break;
                    case 'coadmin': roleIcon = '‚ö°Ô∏è '; break;
                    case 'operator': roleIcon = 'üõ†Ô∏è '; break;
                }
                
                messageDiv.className = messageClass;
                messageDiv.id = `msg_${msg.id}`;
                
                let deleteButton = '';
                if (currentUser && (msg.sender === currentUser.name || isAdmin || isCoAdmin || isOperator || isOwner)) {
                    deleteButton = `<button class="delete-btn" onclick="deleteMessage('${msg.id}')" title="Sil">üóëÔ∏è</button>`;
                }
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="message-image" onclick="showImageModal('${msg.image}')" alt="G√∂nderilen resim">`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user" onclick="openPrivateChat('${msg.sender}')">
                            ${roleIcon}${senderName}
                        </span>
                        <div>
                            <span class="message-time">${msg.time || '--:--'}</span>
                            ${deleteButton}
                        </div>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // ========== ONLINE KULLANICILAR ==========
        function updateOnlineUsers(users) {
            if (!users) users = {};
            
            const now = Date.now();
            let onlineCount = 0;
            const activeUsers = [];
            
            Object.entries(users).forEach(([username, userData]) => {
                if (!userData) return;
                
                // Owner gizleme
                if (username === SECURE_CONFIG.OWNER_CONFIG.username && userData.isHidden && 
                    (!currentUser || currentUser.name !== SECURE_CONFIG.OWNER_CONFIG.username)) {
                    return;
                }
                
                const timeDiff = now - (userData.lastSeen || 0);
                const secondsAgo = Math.floor(timeDiff / 1000);
                
                if (secondsAgo < 30) {
                    onlineCount++;
                    activeUsers.push({
                        username: username,
                        ...userData,
                        secondsAgo: secondsAgo
                    });
                }
            });
            
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('chatOnlineCount').textContent = onlineCount;
            
            updateUserList(activeUsers);
        }

        function updateUserList(users) {
            const container = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:20px;">Hen√ºz kimse online deƒüil</div>';
                return;
            }
            
            users.sort((a, b) => a.secondsAgo - b.secondsAgo);
            
            let html = '';
            users.forEach(user => {
                const isCurrentUser = user.username === (currentUser?.name || '');
                const statusClass = user.secondsAgo > 10 ? 'idle' : '';
                let roleIcon = '';
                
                switch(user.role) {
                    case 'owner': roleIcon = 'ü§¥'; break;
                    case 'admin': roleIcon = '‚≠êÔ∏è'; break;
                    case 'coadmin': roleIcon = '‚ö°Ô∏è'; break;
                    case 'operator': roleIcon = 'üõ†Ô∏è'; break;
                }
                
                html += `
                    <div class="user-item ${statusClass}" onclick="openPrivateChat('${user.username}')">
                        <div class="user-status">
                            <span class="status-dot ${user.secondsAgo > 10 ? 'status-idle' : 'status-online'}"></span>
                            <strong>${isCurrentUser ? 'üë§ ' : ''}${user.username}</strong>
                            ${roleIcon}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${user.secondsAgo < 5 ? '≈ûimdi' : user.secondsAgo + 'sn'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== √ñZEL MESAJ Sƒ∞STEMƒ∞ ==========
        function generateChatId(user1, user2) {
            const users = [user1, user2].sort();
            return `${users[0]}_${users[1]}`;
        }

        function openPrivateChat(username) {
            if (username === currentUser.name) return;
            
            currentPrivateChatId = generateChatId(currentUser.name, username);
            
            // UI g√ºncelleme
            document.getElementById('privateChatUserName').textContent = username;
            document.getElementById('privateChatPanel').classList.add('active');
            
            // Mesajlarƒ± dinle
            if (privateChatsRef) {
                privateChatsRef.child(currentPrivateChatId).on('value', (snapshot) => {
                    updatePrivateMessages(snapshot.val());
                });
            }
        }

        function updatePrivateMessages(messages) {
            const container = document.getElementById('privateChatMessages');
            if (!messages) {
                container.innerHTML = '';
                return;
            }
            
            const messagesArray = [];
            Object.entries(messages).forEach(([messageId, value]) => {
                messagesArray.push({ id: messageId, ...value });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            let html = '';
            messagesArray.forEach(msg => {
                const isCurrentUser = msg.sender === currentUser.name;
                const messageClass = isCurrentUser ? 'private-message right' : 'private-message left';
                
                let content = msg.text;
                if (msg.image) {
                    content += `<br><img src="${msg.image}" class="private-message-image" onclick="showImageModal('${msg.image}')">`;
                }
                
                html += `
                    <div class="${messageClass}">
                        <div class="message-user">
                            <div class="message-user-name">${msg.sender}</div>
                        </div>
                        <div class="message-content">${content}</div>
                        <div class="message-time">${msg.time || '--:--'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        async function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            
            if (!text || !currentPrivateChatId || !privateChatsRef) return;
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            };
            
            try {
                await privateChatsRef.child(currentPrivateChatId).push(messageData);
                input.value = '';
            } catch (error) {
                console.error('√ñzel mesaj g√∂nderme hatasƒ±:', error);
            }
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChatId = null;
            document.getElementById('privateMessageInput').value = '';
            
            if (privateChatsRef && currentPrivateChatId) {
                privateChatsRef.child(currentPrivateChatId).off();
            }
        }

        // ========== Dƒ∞ƒûER FONKSƒ∞YONLAR ==========
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            errorText.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.style.display = 'flex';
            document.getElementById('loginSuccess').style.display = 'none';
        }

        function showLoginSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
        }

        function addSystemMessage(message) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'yt-message system';
            messageDiv.innerHTML = `
                <div class="message-content" style="color: #96CEB4; text-align: center; font-style: italic;">
                    ‚ö° ${message}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function deleteMessage(messageId) {
            if (!isFirebaseConnected || !messagesRef) return;
            
            if (confirm('Bu mesajƒ± silmek istediƒüinize emin misiniz?')) {
                messagesRef.child(messageId).remove()
                    .then(() => console.log('Mesaj silindi:', messageId))
                    .catch((error) => console.error('Mesaj silme hatasƒ±:', error));
            }
        }

        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.style.display = 'flex';
        }

        function logout() {
            if (currentUser && usersRef) {
                usersRef.child(currentUser.name).remove();
            }
            
            // Listener'larƒ± temizle
            if (messagesRef) messagesRef.off();
            if (usersRef) usersRef.off();
            if (privateChatsRef && currentPrivateChatId) {
                privateChatsRef.child(currentPrivateChatId).off();
            }
            
            location.reload();
        }

        // ========== EKSƒ∞K FONKSƒ∞YONLAR ==========
        function handleCommand(command) {
            const commands = {
                '/clear': () => { document.getElementById('messages').innerHTML = ''; },
                '/help': () => { alert('Mevcut komutlar:\n/clear - Mesajlarƒ± temizle\n/help - Yardƒ±m\n/users - Online kullanƒ±cƒ±lar\n/theme - Tema deƒüi≈ütir'); },
                '/users': () => { alert(`√áevrimi√ßi kullanƒ±cƒ± sayƒ±sƒ±: ${document.getElementById('onlineCount').textContent}`); },
                '/theme': () => { toggleTheme(); },
                '/msg': () => { 
                    const parts = command.split(' ');
                    if (parts.length >= 3) {
                        const username = parts[1];
                        const message = parts.slice(2).join(' ');
                        openPrivateChat(username);
                        setTimeout(() => {
                            document.getElementById('privateMessageInput').value = message;
                            sendPrivateMessage();
                        }, 500);
                    }
                }
            };
            
            const cmd = command.split(' ')[0];
            if (commands[cmd]) {
                commands[cmd]();
            } else {
                addSystemMessage(`‚ùå Bilinmeyen komut: ${cmd}`);
            }
        }

        function loadCustomCommands() {
            console.log('√ñzel komutlar y√ºkleniyor...');
            // Firebase'den √∂zel komutlarƒ± y√ºkle
        }

        function updateBannedUsers() {
            console.log('Banlƒ± kullanƒ±cƒ±lar g√ºncelleniyor...');
            // Firebase'den ban listesini g√ºncelle
        }

        function startBanMonitoring() {
            console.log('Ban izleme ba≈ülatƒ±ldƒ±');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('chatTheme');
            if (savedTheme === 'day-mode') {
                toggleTheme();
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeToggle').querySelector('i');
            
            if (isDayMode) {
                body.classList.remove('day-mode');
                themeBtn.className = 'fas fa-moon';
                isDayMode = false;
                localStorage.setItem('chatTheme', 'night-mode');
            } else {
                body.classList.add('day-mode');
                themeBtn.className = 'fas fa-sun';
                isDayMode = true;
                localStorage.setItem('chatTheme', 'day-mode');
            }
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        window.addEventListener('load', function() {
            console.log("üì± Sayfa y√ºklendi!");
            
            loadTheme();
            initializeFirebase();
            
            document.getElementById('login-nick').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('login-nick').focus();
            
            // Enter tu≈üu ile mesaj g√∂nderme
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.id === 'privateMessageInput') {
                        sendPrivateMessage();
                    }
                }
            });
        });

        // ========== GLOBAL FONKSƒ∞YONLAR ==========
        window.login = login;
        window.sendMessage = sendMessage;
        window.logout = logout;
        window.openPrivateChat = openPrivateChat;
        window.closePrivateChat = closePrivateChat;
        window.sendPrivateMessage = sendPrivateMessage;
        window.showImageModal = showImageModal;
        window.deleteMessage = deleteMessage;
        window.handleImageUpload = handleImageUpload;
        window.toggleTheme = toggleTheme;
        window.handleLogout = logout;
        window.openCommandsPanel = function() {
            document.getElementById('commandsPanel').classList.toggle('active');
        };
        window.closeCommandsPanel = function() {
            document.getElementById('commandsPanel').classList.remove('active');
        };
        window.toggleProfilePanel = function() {
            document.getElementById('profilePanel').classList.toggle('active');
        };
        window.openSettings = function() {
            alert('‚öôÔ∏è Ayarlar Paneli:\n\n‚Ä¢ Firebase Baƒülantƒ±: ' + (isFirebaseConnected ? '‚úÖ √áevrimi√ßi' : '‚ùå √áevrimdƒ±≈üƒ±') + 
                  '\n‚Ä¢ Kullanƒ±cƒ±: ' + (currentUser ? currentUser.name : 'Giri≈ü yapƒ±lmamƒ±≈ü') +
                  '\n‚Ä¢ Rol: ' + (currentUser ? currentUser.role : '-') +
                  '\n‚Ä¢ Online Kullanƒ±cƒ±: ' + document.getElementById('onlineCount').textContent);
        };
        window.switchTab = function(tab) {
            currentTab = tab;
            const tabs = document.querySelectorAll('.online-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        };
        window.togglePanel = function(panel) {
            const onlinePanel = document.getElementById('onlinePanel');
            onlinePanel.style.display = onlinePanel.style.display === 'none' ? 'flex' : 'none';
        };
    </script>
</body>
</html>
                    if (activeElement.id === 'privateMessageInput') {
                        sendPrivateMessage();
                    }
                }
            });
        });

        // ========== GLOBAL FONKSƒ∞YONLAR ==========
        window.login = login;
        window.sendMessage = sendMessage;
        window.logout = logout;
        window.openPrivateChat = openPrivateChat;
        window.closePrivateChat = closePrivateChat;
        window.sendPrivateMessage = sendPrivateMessage;
        window.showImageModal = showImageModal;
        window.deleteMessage = deleteMessage;
        window.handleImageUpload = handleImageUpload;
        window.toggleTheme = toggleTheme;
        window.handleLogout = logout;
        window.openCommandsPanel = function() {
            document.getElementById('commandsPanel').classList.toggle('active');
        };
        window.closeCommandsPanel = function() {
            document.getElementById('commandsPanel').classList.remove('active');
        };
        window.toggleProfilePanel = function() {
            document.getElementById('profilePanel').classList.toggle('active');
        };
        window.openSettings = function() {
            alert('‚öôÔ∏è Ayarlar Paneli:\n\n‚Ä¢ Firebase Baƒülantƒ±: ' + (isFirebaseConnected ? '‚úÖ √áevrimi√ßi' : '‚ùå √áevrimdƒ±≈üƒ±') + 
                  '\n‚Ä¢ Kullanƒ±cƒ±: ' + (currentUser ? currentUser.name : 'Giri≈ü yapƒ±lmamƒ±≈ü') +
                  '\n‚Ä¢ Rol: ' + (currentUser ? currentUser.role : '-') +
                  '\n‚Ä¢ Online Kullanƒ±cƒ±: ' + document.getElementById('onlineCount').textContent);
        };
        window.switchTab = function(tab) {
            currentTab = tab;
            const tabs = document.querySelectorAll('.online-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        };
        window.togglePanel = function(panel) {
            const onlinePanel = document.getElementById('onlinePanel');
            onlinePanel.style.display = onlinePanel.style.display === 'none' ? 'flex' : 'none';
        };
    </script>
</body>
</html>
