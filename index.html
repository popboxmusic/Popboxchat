<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Popbox Chat</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0b0f14;color:#e6e6e6;height:100vh;overflow:hidden}
.wrapper{display:flex;justify-content:center;align-items:center;height:100vh}
.container{width:95%;max-width:1400px;height:95vh;background:#141b23;border:1px solid #223041;display:flex;flex-direction:column}
.header{height:200px}
.header iframe{width:100%;height:100%}
.main{flex:1;display:flex;overflow:hidden}
.chat{flex:3;padding:10px;overflow-y:auto}
.users{flex:1;border-left:1px solid #223041;padding:10px;background:#1c2632;overflow-y:auto}
.msg{background:#1c2632;margin-bottom:8px;padding:8px;border-radius:6px}
.input-area{display:flex;border-top:1px solid #223041}
.input-area input{flex:1;padding:15px;background:#1c2632;border:none;color:white;font-size:16px}
.input-area button{width:120px;background:#e50914;border:none;color:white;font-weight:bold}
.login{position:absolute;inset:0;background:#0b0f14;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:10px}
.login input{padding:12px;width:250px}
</style>
</head>

<body>

<div id="login" class="login">
  <h2>Nick Giriş</h2>
  <input id="nick" placeholder="Nick">
  <input id="pass" placeholder="Şifre" type="password">
  <button onclick="login()">Giriş / Kayıt</button>
</div>

<div class="wrapper">
<div class="container">

<div class="header">
<iframe
src="https://www.youtube.com/embed/shD--eyF8ug?autoplay=1&mute=1&rel=0&playsinline=1"
allow="autoplay; encrypted-media"
allowfullscreen>
</iframe>
</div>

<div class="main">
  <div class="chat" id="chat"></div>
  <div class="users" id="users"></div>
</div>

<div class="input-area">
  <input type="text" id="msg" placeholder="Mesaj yaz...">
  <button onclick="send()">Gönder</button>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
  authDomain: "popboxmusicchat.firebaseapp.com",
  projectId: "popboxmusicchat",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentNick = "";

window.login = async function(){
  const nick = nickInput.value.trim();
  const pass = passInput.value.trim();
  if(!nick || !pass) return alert("Doldur");

  const ref = doc(db,"users",nick);
  const snap = await getDoc(ref);

  if(snap.exists()){
    if(snap.data().pass !== pass) return alert("Şifre yanlış");
  }else{
    await setDoc(ref,{pass});
  }

  currentNick = nick;
  loginDiv.style.display="none";
  loadUsers();
  loadMessages();
}

const nickInput = document.getElementById("nick");
const passInput = document.getElementById("pass");
const loginDiv = document.getElementById("login");
const chat = document.getElementById("chat");
const users = document.getElementById("users");
const msgInput = document.getElementById("msg");

window.send = async function(){
  if(!msgInput.value) return;
  await addDoc(collection(db,"messages"),{
    nick:currentNick,
    text:msgInput.value,
    time:Date.now()
  });
  msgInput.value="";
}

msgInput.addEventListener("keypress",e=>{
  if(e.key==="Enter") send();
});

function loadMessages(){
  const q=query(collection(db,"messages"),orderBy("time"));
  onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const data=d.data();
      const div=document.createElement("div");
      div.className="msg";
      div.innerHTML="<b>"+data.nick+":</b> "+data.text;
      if(data.nick===currentNick){
        div.onclick=()=>deleteDoc(doc(db,"messages",d.id));
      }
      chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

function loadUsers(){
  onSnapshot(collection(db,"users"),snap=>{
    users.innerHTML="";
    snap.forEach(d=>{
      const div=document.createElement("div");
      div.innerText=d.id;
      users.appendChild(div);
    });
  });
}
</script>

</body>
</html>
