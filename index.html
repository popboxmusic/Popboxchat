<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY • Çift Medya</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Stil dosyası -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Tüm HTML içeriği aynen kalacak -->
    <!-- ... -->

    <!-- JAVASCRIPT DOSYALARI - SIRALAMA ÖNEMLİ! -->
    <!-- 1. Önce global değişkenler ve firebase -->
    <script>
        // ========== GLOBAL DEĞİŞKENLER (EN ÜSTTE) ==========
        let ytPlayer = null;
        let ytPlayerReady = false;
        let isMuted = false;
        let isPlaying = true;
        let USERS_DB = JSON.parse(localStorage.getItem('cetcety_users')) || [];
        let ACTIVE_USER = null;
        let BLOCKED_USERS = JSON.parse(localStorage.getItem('cetcety_blocks')) || {};
        let PRIVATE_CHATS = JSON.parse(localStorage.getItem('cetcety_private_chats')) || {};
        let BANNED_WORDS = JSON.parse(localStorage.getItem('cetcety_banned_words')) || ['spam', 'reklam', 'şiddet', 'hakaret'];
        let CUSTOM_COMMANDS = JSON.parse(localStorage.getItem('cetcety_custom_commands')) || [];
        let CHANNEL_MESSAGES = JSON.parse(localStorage.getItem('cetcety_channel_messages')) || {};
        let currentPrivateChat = null;
        let currentChannel = 'genel';
        let PRIVATE_SPY_CHANNELS = JSON.parse(localStorage.getItem('cetcety_private_spy')) || {};
        let PRIVATE_SPY_ACTIVE = false;
        let PRIVATE_SPY_CURRENT_CHANNEL = null;
        let SUPER_HIDDEN_CHANNELS = JSON.parse(localStorage.getItem('cetcety_super_hidden')) || [];
        
        // Kanallar
        let channels = JSON.parse(localStorage.getItem('cetcety_channels')) || {
            'genel': { 
                name:'genel', 
                owner:'MateKy', 
                ownerRole:'owner', 
                coAdmins:[], 
                subscribers:1, 
                online:1, 
                isHidden:false,
                isSuperHidden: false,
                youtube: { 
                    currentVideo:'jfKfPfyJRdk', 
                    currentTitle:'CETCETY Radio', 
                    currentArtist:'MateKy', 
                    playlist:[{id:'jfKfPfyJRdk', title:'CETCETY Radio', addedBy:'MateKy', role:'owner'}]
                },
                onlineUsers:[]
            },
            'admin': { 
                name:'admin', 
                owner:'MateKy', 
                ownerRole:'owner', 
                coAdmins:[], 
                subscribers:1, 
                online:1, 
                isHidden:false,
                isSuperHidden: false,
                youtube: { 
                    currentVideo:'jfKfPfyJRdk', 
                    currentTitle:'Admin Kanalı', 
                    currentArtist:'MateKy', 
                    playlist:[{id:'jfKfPfyJRdk', title:'Admin Kanalı', addedBy:'MateKy', role:'owner'}]
                },
                onlineUsers:[]
            }
        };
    </script>
    
    <!-- 2. Firebase config -->
    <script src="firebase-config.js"></script>
    
    <!-- 3. Yardımcı fonksiyonlar -->
    <script src="utils.js"></script>
    
    <!-- 4. Firebase fonksiyonları -->
    <script>
        // ========== FIREBASE FONKSİYONLARI (utils.js'den sonra) ==========
        function updateUserOnlineStatus(user, channel, status) {
            if (!database || !user) return;
            
            const onlineRef = database.ref(`online/${channel}/${user.id}`);
            
            if (status === 'online') {
                onlineRef.set({
                    name: user.name,
                    role: user.role,
                    lastSeen: Date.now(),
                    avatar: user.avatarData || null
                });
                onlineRef.onDisconnect().remove();
            } else {
                onlineRef.remove();
            }
        }

        function listenChannelUsers(channel) {
            if (!database) return;
            
            if (firebaseListeners[`online_${channel}`]) {
                database.ref(`online/${channel}`).off('value', firebaseListeners[`online_${channel}`]);
            }
            
            const callback = (snapshot) => {
                const users = snapshot.val() || {};
                const userList = Object.values(users).map(u => u.name);
                
                if (channels[channel]) {
                    channels[channel].onlineUsers = userList;
                    document.getElementById('channelUserCount').textContent = userList.length;
                }
                
                if (document.getElementById('tabOnline')?.classList.contains('active')) {
                    showOnlineTab();
                }
            };
            
            firebaseListeners[`online_${channel}`] = callback;
            database.ref(`online/${channel}`).on('value', callback);
        }

        function listenChannelMessages(channel) {
            if (!database) return;
            
            if (firebaseListeners[`chats_${channel}`]) {
                database.ref(`chats/${channel}`).off('child_added', firebaseListeners[`chats_${channel}`]);
            }
            
            const callback = (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                
                if (!CHANNEL_MESSAGES[channel]) {
                    CHANNEL_MESSAGES[channel] = [];
                }
                
                CHANNEL_MESSAGES[channel].push(msg);
                localStorage.setItem('cetcety_channel_messages', JSON.stringify(CHANNEL_MESSAGES));
                
                if (channel === currentChannel) {
                    const isMe = msg.sender === ACTIVE_USER?.name;
                    appendMessageToChat(msg, isMe);
                }
            };
            
            firebaseListeners[`chats_${channel}`] = callback;
            database.ref(`chats/${channel}`).limitToLast(50).on('child_added', callback);
        }

        function listenChannelInfo(channel) {
            if (!database) return;
            
            if (firebaseListeners[`playlist_${channel}`]) {
                database.ref(`playlist/${channel}`).off('value', firebaseListeners[`playlist_${channel}`]);
            }
            
            const playlistCallback = (snapshot) => {
                const playlist = snapshot.val() || [];
                if (channels[channel]) {
                    channels[channel].youtube.playlist = playlist;
                    if (channel === currentChannel) {
                        updateYoutubePlaylist();
                    }
                }
            };
            
            firebaseListeners[`playlist_${channel}`] = playlistCallback;
            database.ref(`playlist/${channel}`).on('value', playlistCallback);
            
            if (firebaseListeners[`nowplaying_${channel}`]) {
                database.ref(`nowplaying/${channel}`).off('value', firebaseListeners[`nowplaying_${channel}`]);
            }
            
            const nowplayingCallback = (snapshot) => {
                const now = snapshot.val();
                if (now && channels[channel]) {
                    channels[channel].youtube.currentVideo = now.id;
                    channels[channel].youtube.currentTitle = now.title;
                    channels[channel].youtube.currentArtist = now.artist;
                    
                    if (channel === currentChannel) {
                        document.getElementById('youtubeNowPlayingTitle').textContent = now.title;
                        document.getElementById('youtubeNowPlayingOwner').textContent = now.artist;
                        
                        if (ytPlayer && ytPlayerReady && typeof ytPlayer.loadVideoById === 'function') {
                            try {
                                ytPlayer.loadVideoById(now.id);
                            } catch (e) {
                                console.log('YouTube güncelleme hatası:', e);
                            }
                        }
                        
                        updateYoutubePlaylist();
                    }
                }
            };
            
            firebaseListeners[`nowplaying_${channel}`] = nowplayingCallback;
            database.ref(`nowplaying/${channel}`).on('value', nowplayingCallback);
        }

        function listenPrivateMessages() {
            if (!database || !ACTIVE_USER) return;
            
            if (firebaseListeners['private']) {
                database.ref('private').off('child_added', firebaseListeners['private']);
            }
            
            const callback = (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                
                if (msg.to === ACTIVE_USER.id || msg.from === ACTIVE_USER.id) {
                    const chatId = [msg.from, msg.to].sort().join('_');
                    
                    if (!PRIVATE_CHATS[chatId]) {
                        PRIVATE_CHATS[chatId] = [];
                    }
                    
                    PRIVATE_CHATS[chatId].push({
                        id: snapshot.key,
                        senderId: msg.from,
                        senderName: msg.fromName,
                        type: msg.type || 'text',
                        content: msg.text || msg.content,
                        timestamp: msg.timestamp,
                        read: msg.from === ACTIVE_USER.id ? true : false
                    });
                    
                    localStorage.setItem('cetcety_private_chats', JSON.stringify(PRIVATE_CHATS));
                    
                    if (ACTIVE_USER.role === 'owner' && PRIVATE_SPY_ACTIVE) {
                        const sender = USERS_DB.find(u => u.id === msg.from);
                        const receiver = USERS_DB.find(u => u.id === msg.to);
                        
                        if (sender && receiver) {
                            logPrivateMessageForOwner(
                                sender.name, 
                                receiver.name, 
                                msg.text || 'Medya gönderdi', 
                                msg.type || 'text', 
                                msg.content || msg.text
                            );
                        }
                    }
                    
                    if (currentPrivateChat && 
                        (currentPrivateChat.id === msg.from || currentPrivateChat.id === msg.to)) {
                        loadPrivateMessages();
                    }
                    
                    updateUnreadBadge();
                }
            };
            
            firebaseListeners['private'] = callback;
            database.ref('private').orderByChild('timestamp').startAt(Date.now() - 86400000).on('child_added', callback);
        }
    </script>
    
    <!-- 5. Auth işlemleri -->
    <script src="auth.js"></script>
    
    <!-- 6. Kanal işlemleri -->
    <script src="channels.js"></script>
    
    <!-- 7. Medya işlemleri -->
    <script src="media.js"></script>
    
    <!-- 8. Özel sohbet -->
    <script src="private.js"></script>
    
    <!-- 9. Komutlar -->
    <script src="commands.js"></script>
    
    <!-- 10. Admin işlemleri -->
    <script src="admin.js"></script>
    
    <!-- 11. UI işlemleri -->
    <script src="ui.js"></script>
    
    <!-- 12. Ana uygulama (EN SON) -->
    <script src="app.js"></script>
</body>
</html>
