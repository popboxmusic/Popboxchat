<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Popbox ‚Ä¢ YouTube/Spotify Chat</title>
    
    <!-- FONTS & ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        /* ========== YOUTUBE RENK PALETƒ∞ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0f0f0f;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* ========== ANA KONTEYNER ========== */
        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ========== SOL MEN√ú - 80px ========== */
        .sidebar {
            width: 80px;
            background: #0a0a0a;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            gap: 24px;
            flex-shrink: 0;
        }

        .menu-item {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            position: relative;
        }

        .menu-item:hover {
            background: #272727;
            color: #fff;
        }

        .menu-item.active {
            color: #fff;
            background: #3f3f3f;
        }

        .menu-item i {
            font-size: 20px;
        }

        .user-avatar {
            margin-top: auto;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #3f3f3f;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========== KULLANICI PANELƒ∞ (SOL-2) ========== */
        .users-panel {
            width: 300px;
            background: #0f0f0f;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .panel-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .online-tabs {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .tab {
            flex: 1;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            color: #aaa;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .tab.active {
            background: #272727;
            border-color: #3f3f3f;
            color: #fff;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .user-item:hover {
            background: #1a1a1a;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ba640;
            flex-shrink: 0;
        }

        /* ========== CHAT PANELƒ∞ (ORTA) ========== */
        .chat-panel {
            flex: 1;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .chat-title i {
            color: #aaa;
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #aaa;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: #272727;
            color: #fff;
        }

        /* ========== MESAJLAR - BALONSUZ, ARKAPLAN RENKSƒ∞Z ========== */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.right {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 13px;
            color: #fff;
            cursor: pointer;
        }

        .message-time {
            font-size: 11px;
            color: #aaa;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
            color: #fff;
            word-break: break-word;
            padding: 0;
            background: none;
            border: none;
        }

        .system-message {
            align-self: center;
            color: #aaa;
            font-size: 12px;
            padding: 8px 16px;
            background: #1a1a1a;
            border-radius: 20px;
            margin: 8px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== MESAJ Gƒ∞Rƒ∞≈û ALANI ========== */
        .message-input-container {
            padding: 20px 24px;
            background: #0a0a0a;
            border-top: 1px solid #2a2a2a;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 28px;
            padding: 8px 8px 8px 20px;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            padding: 12px 0;
            resize: none;
            max-height: 120px;
            outline: none;
        }

        .message-input::placeholder {
            color: #666;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #272727;
            border: 1px solid #3f3f3f;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #3f3f3f;
        }

        /* ========== MEDYA PANELƒ∞ (SAƒû) ========== */
        .media-panel {
            width: 400px;
            background: #0a0a0a;
            border-left: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .media-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .media-tabs {
            display: flex;
            gap: 8px;
        }

        .media-tab {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .media-tab.active {
            background: #ff0000;
            color: #fff;
        }

        .media-tab.spotify.active {
            background: #1db954;
        }

        .media-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #272727;
        }

        /* ========== YOUTUBE PLAYER ========== */
        .youtube-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-bottom: 1px solid #2a2a2a;
        }

        .youtube-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ========== SPOTIFY PLAYER ========== */
        .spotify-player {
            width: 100%;
            height: 352px;
            background: #121212;
            border-bottom: 1px solid #2a2a2a;
            display: none;
        }

        .spotify-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ========== PLAYLIST ========== */
        .playlist {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .playlist-item:hover {
            background: #1a1a1a;
        }

        .playlist-item.active {
            background: #1a1a1a;
            border-left: 4px solid #ff0000;
        }

        .playlist-item.spotify.active {
            border-left-color: #1db954;
        }

        .playlist-thumb {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 20px;
            flex-shrink: 0;
        }

        .playlist-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-title {
            font-weight: 500;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-meta {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }

        .playlist-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .playlist-item:hover .playlist-actions {
            opacity: 1;
        }

        .playlist-action {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #272727;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        /* ========== ADD MEDIA MODAL ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 500px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #272727;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #ff0000;
        }

        .spotify .modal-input:focus {
            border-color: #1db954;
        }

        .modal-btn {
            width: 100%;
            padding: 14px;
            background: #ff0000;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.spotify {
            background: #1db954;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        /* ========== LOGIN PANEL ========== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f0f0f;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-box {
            width: 400px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            padding: 40px;
        }

        .login-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
        }

        .login-logo i {
            font-size: 48px;
            color: #ff0000;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            color: #fff;
        }

        .login-subtitle {
            text-align: center;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 16px;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .login-input:focus {
            outline: none;
            border-color: #ff0000;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: #ff0000;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .login-btn:hover {
            opacity: 0.9;
        }

        .login-error {
            background: rgba(255,0,0,0.1);
            border: 1px solid #ff0000;
            border-radius: 8px;
            padding: 12px;
            color: #ff0000;
            font-size: 13px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ========== HIDE CLASS ========== */
        .hidden {
            display: none !important;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .media-panel {
                width: 350px;
            }
        }

        @media (max-width: 900px) {
            .users-panel {
                display: none;
            }
            .media-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-logo">
                <i class="fab fa-youtube"></i>
            </div>
            <h2 class="login-title">Popbox</h2>
            <p class="login-subtitle">YouTube & Spotify ile sohbet et</p>
            
            <input type="text" id="nickname" class="login-input" placeholder="Kullanƒ±cƒ± adƒ±" autocomplete="off">
            <input type="password" id="password" class="login-input" placeholder="≈ûifre (opsiyonel)">
            
            <div id="loginError" class="login-error"></div>
            
            <button id="loginBtn" class="login-btn" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Giri≈ü Yap
            </button>
            
            <p style="color: #666; font-size: 12px; text-align: center;">
                MateKy (Owner) ‚Ä¢ popbox (Admin) ‚Ä¢ popboxmusic (Admin)
            </p>
        </div>
    </div>

    <div id="app" class="app hidden">
        <!-- SOL MEN√ú - 80px -->
        <div class="sidebar">
            <div class="menu-item active" onclick="showUsersPanel()" title="Kullanƒ±cƒ±lar">
                <i class="fas fa-users"></i>
            </div>
            <div class="menu-item" onclick="toggleNotificationPanel()" title="Bildirimler">
                <i class="fas fa-bell"></i>
                <span id="notificationBadge" style="display:none;">‚Ä¢</span>
            </div>
            <div class="menu-item" onclick="toggleTheme()" title="Tema">
                <i class="fas fa-moon"></i>
            </div>
            
            <div class="user-avatar" id="userAvatar" onclick="showProfileMenu()">
                <span id="avatarText"></span>
                <img id="avatarImg" src="" style="display:none;">
            </div>
        </div>

        <!-- KULLANICI PANELƒ∞ -->
        <div class="users-panel">
            <div class="panel-header">
                <h3><i class="fas fa-users"></i> √áevrimi√ßi</h3>
                <div class="online-tabs">
                    <div class="tab active" onclick="switchUserTab('online')" id="onlineTab">√áevrimi√ßi (0)</div>
                    <div class="tab" onclick="switchUserTab('chatting')" id="chattingTab">Sohbette (0)</div>
                </div>
            </div>
            
            <div class="user-list" id="userList">
                <!-- Kullanƒ±cƒ±lar buraya gelecek -->
            </div>
        </div>

        <!-- CHAT PANELƒ∞ -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-hashtag"></i>
                    <span id="currentChannel">genel</span>
                    <span id="onlineCount" style="color:#aaa; font-size:13px; margin-left:8px;"></span>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <!-- Mesajlar buraya gelecek - BALONSUZ, RENKSƒ∞Z -->
            </div>
            
            <div class="message-input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Mesaj yazƒ±n..."
                        rows="1"
                        oninput="autoResize(this)"
                    ></textarea>
                    <div class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEDYA PANELƒ∞ (SAƒû) - YOUTUBE / SPOTIFY -->
        <div class="media-panel">
            <div class="media-header">
                <div class="media-tabs">
                    <div class="media-tab active" onclick="switchMediaTab('youtube')" id="youtubeTab">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <div class="media-tab spotify" onclick="switchMediaTab('spotify')" id="spotifyTab">
                        <i class="fab fa-spotify"></i>
                    </div>
                </div>
                <div class="media-controls">
                    <div class="control-btn" onclick="openAddMediaModal()" title="Ekle">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="control-btn" onclick="clearPlaylist()" title="Temizle">
                        <i class="fas fa-trash"></i>
                    </div>
                </div>
            </div>
            
            <!-- YOUTUBE PLAYER -->
            <div id="youtubePlayer" class="youtube-player">
                <iframe 
                    id="youtubeIframe"
                    src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&mute=0&controls=1&modestbranding=1&rel=0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
            
            <!-- SPOTIFY PLAYER -->
            <div id="spotifyPlayer" class="spotify-player">
                <iframe 
                    id="spotifyIframe"
                    src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator"
                    allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            
            <!-- PLAYLIST -->
            <div class="playlist" id="playlist">
                <!-- Playlist buraya gelecek -->
            </div>
        </div>
    </div>

    <!-- MEDYA EKLEME MODAL -->
    <div id="addMediaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">YouTube Video Ekle</h3>
                <button class="modal-close" onclick="closeAddMediaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="text" id="mediaUrl" class="modal-input" placeholder="Video URL'si veya ID'si">
            <input type="text" id="mediaTitle" class="modal-input" placeholder="Ba≈ülƒ±k (opsiyonel)">
            
            <button id="addMediaBtn" class="modal-btn" onclick="addToPlaylist()">
                <i class="fas fa-plus"></i> Playlist'e Ekle
            </button>
        </div>
    </div>

    <!-- PROFƒ∞L MEN√úS√ú MODAL -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profil</h3>
                <button class="modal-close" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #0f0f0f; border-radius: 12px;">
                    <div class="user-avatar" style="width: 64px; height: 64px;">
                        <span id="profileAvatarText"></span>
                    </div>
                    <div>
                        <div id="profileName" style="font-weight: 600; margin-bottom: 4px;"></div>
                        <div id="profileRole" style="color: #aaa; font-size: 13px;"></div>
                    </div>
                </div>
                
                <div style="display: grid; gap: 8px;">
                    <button class="modal-btn" onclick="uploadAvatar()" style="background: #272727;">
                        <i class="fas fa-camera"></i> Fotoƒüraf Y√ºkle
                    </button>
                    <button class="modal-btn" onclick="logout()" style="background: #272727;">
                        <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">

    <script>
        // ========== FIREBASE KONFƒ∞G - D√úZELTƒ∞LDƒ∞ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",  // D√úZELTƒ∞LDƒ∞!
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835",
            measurementId: "G-SB1K22FLEX"
        };

        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let database;
        let storage;
        let currentUser = null;
        let isAdmin = false;
        let isOwner = false;
        let isFirebaseConnected = false;
        let currentMediaTab = 'youtube';
        let playlist = [];
        let spotifyPlaylist = [];
        let youtubePlaylist = [
            { id: 'jfKfPfyJRdk', title: 'Popbox Radio ‚Ä¢ 24/7 Canlƒ± M√ºzik', type: 'youtube' }
        ];
        let onlineUsers = [];
        let chattingUsers = [];
        let blockedUsers = [];

        // ========== FIREBASE BA≈ûLAT - D√úZELTƒ∞LDƒ∞ ==========
        function initializeFirebase() {
            try {
                console.log('üî• Firebase ba≈ülatƒ±lƒ±yor...');
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                storage = firebase.storage();
                
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        console.log('‚úÖ Firebase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!');
                        isFirebaseConnected = true;
                    } else {
                        console.log('‚ùå Firebase baƒülantƒ±sƒ± kesildi!');
                        isFirebaseConnected = false;
                    }
                });
                
                console.log('‚úÖ Firebase ba≈ülatƒ±ldƒ±!');
                
            } catch (error) {
                console.error('‚ùå Firebase ba≈ülatma hatasƒ±:', error);
                showError('Firebase baƒülantƒ± hatasƒ±: ' + error.message);
            }
        }

        // ========== Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMƒ∞ - D√úZELTƒ∞LDƒ∞ ==========
        async function handleLogin() {
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            
            if (!nickname) {
                showError('Kullanƒ±cƒ± adƒ± gerekli!');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Baƒülanƒ±yor...';
            loginBtn.disabled = true;
            
            setTimeout(() => {
                performLogin(nickname, password);
            }, 500);
        }

        function performLogin(nickname, password) {
            try {
                const normalizedNick = nickname.toLowerCase();
                
                // Owner kontrol√º
                if (normalizedNick === 'mateky') {
                    if (password !== 'Sahi17407@SCM') {
                        showError('Hatalƒ± owner ≈üifresi!');
                        resetLoginButton();
                        return;
                    }
                    isOwner = true;
                    isAdmin = true;
                    currentUser = { name: 'MateKy', role: 'owner' };
                }
                // Admin kontrol√º
                else if (normalizedNick === 'popbox' || normalizedNick === 'popboxmusic') {
                    currentUser = { name: nickname, role: 'admin' };
                    isAdmin = true;
                }
                // Normal kullanƒ±cƒ±
                else {
                    currentUser = { name: nickname, role: 'user' };
                }
                
                // Firebase'e kullanƒ±cƒ±yƒ± kaydet
                if (database) {
                    const usersRef = database.ref('onlineUsers');
                    usersRef.child(currentUser.name).set({
                        name: currentUser.name,
                        role: currentUser.role,
                        lastSeen: Date.now(),
                        isOnline: true
                    });
                    
                    // √áƒ±kƒ±≈üta temizle
                    usersRef.child(currentUser.name).onDisconnect().remove();
                }
                
                // Giri≈ü ba≈üarƒ±lƒ±
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Kullanƒ±cƒ± bilgilerini g√∂ster
                document.getElementById('avatarText').textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('profileAvatarText').textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileRole').textContent = currentUser.role;
                
                // Admin paneli g√∂ster
                if (isAdmin || isOwner) {
                    // Admin √∂zellikleri aktif
                }
                
                // Sistem mesajƒ±
                addSystemMessage(`üéâ ${currentUser.name} sohbete katƒ±ldƒ±!`);
                
                // Listener'larƒ± ba≈ülat
                startFirebaseListeners();
                
            } catch (error) {
                console.error('Giri≈ü hatasƒ±:', error);
                showError('Giri≈ü yapƒ±lamadƒ±: ' + error.message);
                resetLoginButton();
            }
        }

        function resetLoginButton() {
            const btn = document.getElementById('loginBtn');
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Giri≈ü Yap';
            btn.disabled = false;
        }

        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 3000);
        }

        // ========== FIREBASE Lƒ∞STENER'LAR ==========
        function startFirebaseListeners() {
            if (!database) return;
            
            // Online kullanƒ±cƒ±larƒ± dinle
            const usersRef = database.ref('onlineUsers');
            usersRef.on('value', (snapshot) => {
                updateOnlineUsers(snapshot.val());
            });
            
            // Mesajlarƒ± dinle
            const messagesRef = database.ref('messages');
            messagesRef.limitToLast(100).on('value', (snapshot) => {
                updateMessages(snapshot.val());
            });
        }

        // ========== ONLINE KULLANICILARI G√úNCELLE ==========
        function updateOnlineUsers(usersData) {
            if (!usersData) {
                document.getElementById('onlineTab').textContent = '√áevrimi√ßi (0)';
                document.getElementById('onlineCount').textContent = '(0 online)';
                return;
            }
            
            const now = Date.now();
            onlineUsers = [];
            let onlineCount = 0;
            let chattingCount = 0;
            
            Object.entries(usersData).forEach(([username, data]) => {
                if (!data) return;
                
                const timeDiff = now - (data.lastSeen || 0);
                if (timeDiff < 30000) {
                    onlineCount++;
                    if (username !== currentUser?.name) {
                        onlineUsers.push({
                            name: username,
                            role: data.role || 'user',
                            lastSeen: data.lastSeen,
                            isOnline: true
                        });
                    }
                    if (timeDiff < 10000) chattingCount++;
                }
            });
            
            document.getElementById('onlineTab').textContent = `√áevrimi√ßi (${onlineCount})`;
            document.getElementById('chattingTab').textContent = `Sohbette (${chattingCount})`;
            document.getElementById('onlineCount').textContent = `(${onlineCount} online)`;
            
            renderUserList();
        }

        // ========== KULLANICI Lƒ∞STESƒ∞Nƒ∞ G√ñSTER ==========
        function renderUserList() {
            const container = document.getElementById('userList');
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Kimse online deƒüil</div>';
                return;
            }
            
            let html = '';
            onlineUsers.forEach(user => {
                html += `
                    <div class="user-item" onclick="openPrivateChat('${user.name}')">
                        <div class="user-avatar-small">
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-status">${user.role || 'user'}</div>
                        </div>
                        <div class="online-dot"></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== MESAJLARI G√úNCELLE - BALONSUZ, RENKSƒ∞Z ==========
        function updateMessages(messagesData) {
            if (!messagesData) return;
            
            const container = document.getElementById('messages');
            const messagesArray = [];
            
            Object.entries(messagesData).forEach(([id, msg]) => {
                messagesArray.push({ id, ...msg });
            });
            
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            container.innerHTML = '';
            
            messagesArray.slice(-50).forEach(msg => {
                const isOwn = msg.sender === currentUser?.name;
                const time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'right' : ''}`;
                
                // YETKƒ∞ SEMBOLLERƒ∞
                let senderName = msg.sender;
                if (msg.role === 'owner') senderName = 'üëë ' + senderName;
                else if (msg.role === 'admin') senderName = '‚ö° ' + senderName;
                else if (msg.type === 'system') senderName = 'üîî ' + senderName;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender" onclick="openPrivateChat('${msg.sender}')">
                            ${senderName}
                        </span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHTML(msg.text)}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // ========== MESAJ G√ñNDER ==========
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser || !database) return;
            
            // Komut kontrol√º
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                autoResize(input);
                return;
            }
            
            const messageData = {
                sender: currentUser.name,
                text: text,
                role: currentUser.role,
                timestamp: Date.now(),
                type: 'user'
            };
            
            try {
                await database.ref('messages').push(messageData);
                input.value = '';
                autoResize(input);
                
                // LastSeen g√ºncelle
                database.ref(`onlineUsers/${currentUser.name}`).update({
                    lastSeen: Date.now()
                });
                
            } catch (error) {
                console.error('Mesaj g√∂nderme hatasƒ±:', error);
                addSystemMessage('‚ùå Mesaj g√∂nderilemedi!');
            }
        }

        // ========== Sƒ∞STEM MESAJI ==========
        function addSystemMessage(text) {
            if (!database) return;
            
            database.ref('messages').push({
                sender: 'Sistem',
                text: text,
                type: 'system',
                timestamp: Date.now()
            });
        }

        // ========== KOMUT ƒ∞≈ûLEME ==========
        function handleCommand(cmd) {
            const parts = cmd.substring(1).split(' ');
            const command = parts[0].toLowerCase();
            
            switch(command) {
                case 'yardƒ±m':
                case 'help':
                    addSystemMessage('üìã KOMUTLAR: /temizle, /online, /tema, /√ßƒ±kƒ±≈ü');
                    break;
                    
                case 'temizle':
                case 'clear':
                    if (isAdmin || isOwner) {
                        if (confirm('T√ºm mesajlarƒ± temizlemek istediƒüinize emin misiniz?')) {
                            database.ref('messages').remove();
                            addSystemMessage('‚úÖ T√ºm mesajlar temizlendi!');
                        }
                    }
                    break;
                    
                case 'online':
                    addSystemMessage(`üë• Online: ${onlineUsers.length} kullanƒ±cƒ±`);
                    break;
                    
                case 'tema':
                    toggleTheme();
                    break;
                    
                case '√ßƒ±kƒ±≈ü':
                case 'exit':
                    logout();
                    break;
            }
        }

        // ========== MEDYA TAB GE√áƒ∞≈ûƒ∞ (YOUTUBE / SPOTIFY) ==========
        function switchMediaTab(tab) {
            currentMediaTab = tab;
            
            const youtubeTab = document.getElementById('youtubeTab');
            const spotifyTab = document.getElementById('spotifyTab');
            const youtubePlayer = document.getElementById('youtubePlayer');
            const spotifyPlayer = document.getElementById('spotifyPlayer');
            const modal = document.getElementById('addMediaModal');
            const modalTitle = document.getElementById('modalTitle');
            const addBtn = document.getElementById('addMediaBtn');
            
            if (tab === 'youtube') {
                youtubeTab.classList.add('active');
                spotifyTab.classList.remove('active');
                youtubePlayer.style.display = 'block';
                spotifyPlayer.style.display = 'none';
                modalTitle.textContent = 'YouTube Video Ekle';
                addBtn.className = 'modal-btn';
                renderPlaylist();
            } else {
                youtubeTab.classList.remove('active');
                spotifyTab.classList.add('active');
                youtubePlayer.style.display = 'none';
                spotifyPlayer.style.display = 'block';
                modalTitle.textContent = 'Spotify Ekle';
                addBtn.className = 'modal-btn spotify';
                renderSpotifyPlaylist();
            }
        }

        // ========== PLAYLIST'E EKLE ==========
        function addToPlaylist() {
            const url = document.getElementById('mediaUrl').value.trim();
            const title = document.getElementById('mediaTitle').value.trim();
            
            if (!url) {
                alert('L√ºtfen URL girin!');
                return;
            }
            
            if (currentMediaTab === 'youtube') {
                // YouTube video ID'si √ßƒ±kar
                let videoId = '';
                if (url.includes('youtube.com/watch?v=')) {
                    videoId = url.split('v=')[1]?.split('&')[0];
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1]?.split('?')[0];
                } else if (url.includes('youtube.com/embed/')) {
                    videoId = url.split('embed/')[1]?.split('?')[0];
                } else {
                    videoId = url; // direkt ID
                }
                
                if (videoId) {
                    youtubePlaylist.push({
                        id: videoId,
                        title: title || `Video ${youtubePlaylist.length + 1}`,
                        type: 'youtube'
                    });
                    renderPlaylist();
                    closeAddMediaModal();
                    document.getElementById('mediaUrl').value = '';
                    document.getElementById('mediaTitle').value = '';
                }
            } else {
                // Spotify ekle
                let spotifyId = '';
                if (url.includes('open.spotify.com/playlist/')) {
                    spotifyId = url.split('playlist/')[1]?.split('?')[0];
                } else if (url.includes('open.spotify.com/track/')) {
                    spotifyId = url.split('track/')[1]?.split('?')[0];
                } else if (url.includes('open.spotify.com/album/')) {
                    spotifyId = url.split('album/')[1]?.split('?')[0];
                }
                
                if (spotifyId) {
                    spotifyPlaylist.push({
                        id: spotifyId,
                        title: title || `Spotify ${spotifyPlaylist.length + 1}`,
                        type: 'spotify'
                    });
                    renderSpotifyPlaylist();
                    closeAddMediaModal();
                    document.getElementById('mediaUrl').value = '';
                    document.getElementById('mediaTitle').value = '';
                }
            }
        }

        // ========== YOUTUBE PLAYLIST G√ñSTER ==========
        function renderPlaylist() {
            const container = document.getElementById('playlist');
            
            if (youtubePlaylist.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Playlist bo≈ü</div>';
                return;
            }
            
            let html = '';
            youtubePlaylist.forEach((item, index) => {
                const isActive = index === 0; // aktif video
                html += `
                    <div class="playlist-item ${isActive ? 'active' : ''}" onclick="playVideo(${index})">
                        <div class="playlist-thumb">
                            <i class="fab fa-youtube"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title">${item.title}</div>
                            <div class="playlist-meta">YouTube</div>
                        </div>
                        <div class="playlist-actions">
                            <div class="playlist-action" onclick="event.stopPropagation(); playVideo(${index})">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="playlist-action" onclick="event.stopPropagation(); removeFromPlaylist(${index})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== SPOTIFY PLAYLIST G√ñSTER ==========
        function renderSpotifyPlaylist() {
            const container = document.getElementById('playlist');
            
            if (spotifyPlaylist.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Spotify playlist bo≈ü</div>';
                return;
            }
            
            let html = '';
            spotifyPlaylist.forEach((item, index) => {
                const isActive = index === 0;
                html += `
                    <div class="playlist-item spotify ${isActive ? 'active' : ''}" onclick="playSpotify(${index})">
                        <div class="playlist-thumb">
                            <i class="fab fa-spotify" style="color:#1db954;"></i>
                        </div>
                        <div class="playlist-info">
                            <div class="playlist-title">${item.title}</div>
                            <div class="playlist-meta">Spotify</div>
                        </div>
                        <div class="playlist-actions">
                            <div class="playlist-action" onclick="event.stopPropagation(); playSpotify(${index})">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="playlist-action" onclick="event.stopPropagation(); removeFromSpotifyPlaylist(${index})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== Vƒ∞DEO OYNAT ==========
        function playVideo(index) {
            const video = youtubePlaylist[index];
            if (!video) return;
            
            const iframe = document.getElementById('youtubeIframe');
            iframe.src = `https://www.youtube.com/embed/${video.id}?autoplay=1&mute=0&controls=1&modestbranding=1&rel=0`;
            
            // Aktif sƒ±nƒ±fƒ±nƒ± g√ºncelle
            document.querySelectorAll('.playlist-item').forEach(el => {
                el.classList.remove('active');
            });
            event?.currentTarget?.classList.add('active');
        }

        // ========== SPOTIFY OYNAT ==========
        function playSpotify(index) {
            const item = spotifyPlaylist[index];
            if (!item) return;
            
            const iframe = document.getElementById('spotifyIframe');
            
            if (item.id.includes('playlist')) {
                iframe.src = `https://open.spotify.com/embed/playlist/${item.id}?utm_source=generator`;
            } else if (item.id.includes('track')) {
                iframe.src = `https://open.spotify.com/embed/track/${item.id}?utm_source=generator`;
            } else {
                iframe.src = `https://open.spotify.com/embed/${item.id}?utm_source=generator`;
            }
        }

        // ========== PLAYLIST'TEN KALDIR ==========
        function removeFromPlaylist(index) {
            youtubePlaylist.splice(index, 1);
            renderPlaylist();
        }

        function removeFromSpotifyPlaylist(index) {
            spotifyPlaylist.splice(index, 1);
            renderSpotifyPlaylist();
        }

        function clearPlaylist() {
            if (currentMediaTab === 'youtube') {
                youtubePlaylist = [];
                renderPlaylist();
            } else {
                spotifyPlaylist = [];
                renderSpotifyPlaylist();
            }
        }

        // ========== MODAL ƒ∞≈ûLEMLERƒ∞ ==========
        function openAddMediaModal() {
            document.getElementById('addMediaModal').classList.add('active');
        }

        function closeAddMediaModal() {
            document.getElementById('addMediaModal').classList.remove('active');
            document.getElementById('mediaUrl').value = '';
            document.getElementById('mediaTitle').value = '';
        }

        // ========== PROFƒ∞L ƒ∞≈ûLEMLERƒ∞ ==========
        function showProfileMenu() {
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function uploadAvatar() {
            document.getElementById('avatarUpload').click();
        }

        document.getElementById('avatarUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('avatarImg').src = event.target.result;
                document.getElementById('avatarImg').style.display = 'block';
                document.getElementById('avatarText').style.display = 'none';
            };
            reader.readAsDataURL(file);
        });

        // ========== √ñZEL SOHBET ==========
        function openPrivateChat(username) {
            addSystemMessage(`üí¨ ${username} ile √∂zel sohbet ba≈ülatƒ±ldƒ± (sim√ºlasyon)`);
        }

        // ========== TEMA DEƒûƒ∞≈ûTƒ∞R ==========
        function toggleTheme() {
            document.body.style.background = document.body.style.background === '#0f0f0f' ? '#fff' : '#0f0f0f';
        }

        // ========== PANEL ƒ∞≈ûLEMLERƒ∞ ==========
        function showUsersPanel() {
            // Zaten a√ßƒ±k
        }

        function toggleNotificationPanel() {
            addSystemMessage('üîî Bildirimler (sim√ºlasyon)');
        }

        function switchUserTab(tab) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // ========== √áIKI≈û ==========
        function logout() {
            if (database && currentUser) {
                database.ref(`onlineUsers/${currentUser.name}`).remove();
            }
            location.reload();
        }

        // ========== YARDIMCI FONKSƒ∞YONLAR ==========
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            // Enter tu≈üu
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (document.activeElement.id === 'nickname' || document.activeElement.id === 'password') {
                        handleLogin();
                    } else if (document.activeElement.id === 'messageInput') {
                        sendMessage();
                    }
                    e.preventDefault();
                }
            });
            
            // ESC tu≈üu
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAddMediaModal();
                    closeProfileModal();
                }
            });
            
            // Ba≈ülangƒ±√ß playlist
            renderPlaylist();
        });

        // ========== GLOBAL FONKSƒ∞YONLAR ==========
        window.handleLogin = handleLogin;
        window.sendMessage = sendMessage;
        window.switchMediaTab = switchMediaTab;
        window.addToPlaylist = addToPlaylist;
        window.playVideo = playVideo;
        window.playSpotify = playSpotify;
        window.removeFromPlaylist = removeFromPlaylist;
        window.removeFromSpotifyPlaylist = removeFromSpotifyPlaylist;
        window.clearPlaylist = clearPlaylist;
        window.openAddMediaModal = openAddMediaModal;
        window.closeAddMediaModal = closeAddMediaModal;
        window.openPrivateChat = openPrivateChat;
        window.showProfileMenu = showProfileMenu;
        window.closeProfileModal = closeProfileModal;
        window.uploadAvatar = uploadAvatar;
        window.toggleTheme = toggleTheme;
        window.toggleNotificationPanel = toggleNotificationPanel;
        window.showUsersPanel = showUsersPanel;
        window.switchUserTab = switchUserTab;
        window.autoResize = autoResize;
        window.logout = logout;
    </script>
</body>
</html>
