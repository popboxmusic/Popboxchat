<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CETCETY ‚Ä¢ Mobil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- YOUTUBE API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- FIREBASE K√úT√úPHANELERƒ∞ (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- BAƒûLANTI DURUMU FONKSƒ∞YONU -->
    <script>
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            if (statusEl && statusText) {
                statusEl.className = `connection-status ${status}`;
                statusText.textContent = text;
            }
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        /* TEMA DEƒûƒ∞≈ûKENLERƒ∞ (YouTube Live varsayƒ±lan) */
        :root {
            --primary: #ff0000;
            --secondary: #ff5555;
            --private: #9c27b0;
            --coadmin: #ff9800;
            --operator: #3b82f6;
            --owner: #ff4081;
            --online: #4caf50;
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --text-primary: #fff;
            --text-secondary: #aaa;
            --border-color: rgba(255,255,255,0.1);
            --message-user-bg: rgba(255,255,255,0.05);
            --message-admin-bg: rgba(255,85,85,0.15);
            --message-coadmin-bg: rgba(255,152,0,0.15);
            --message-operator-bg: rgba(59,130,246,0.15);
            --message-owner-bg: rgba(255,64,129,0.15);
            --message-system-bg: rgba(76,175,80,0.15);
            --message-private-bg: rgba(156,39,176,0.15);
            --message-ban-bg: rgba(255,51,51,0.15);
            --message-story-bg: rgba(255,107,107,0.15);
            --message-report-bg: rgba(255,68,68,0.15);
            --firebase: #ffa000;
        }

        body.night-mode {
            --bg-primary: #1a1a2e;
            --bg-secondary: #2d2d44;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: rgba(79, 195, 247, 0.2);
            --primary: #4fc3f7;
            --secondary: #ff5555;
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: rgba(0,0,0,0.1);
            --primary: #2196f3;
            --secondary: #f44336;
        }

        /* Giri≈ü Ekranƒ± */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; transition: 0.3s;
        }
        .login-overlay.hidden { display: none; }
        .login-panel {
            width: 90%; max-width: 360px;
            background: rgba(20,20,20,0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 28px; padding: 32px 24px;
            color: #fff; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .login-panel h2 {
            text-align: center; margin-bottom: 28px;
            font-size: 32px; font-weight: 700;
        }
        .login-panel h2 span { color: #ff0000; }
        .login-panel input {
            width: 100%; padding: 16px; margin-bottom: 16px;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; color: #fff; font-size: 16px;
        }
        .login-panel button {
            width: 100%; padding: 16px; background: #ff0000;
            border: none; border-radius: 16px; color: #fff;
            font-weight: 600; font-size: 16px; margin-top: 8px;
        }
        .login-info {
            text-align: center; margin-top: 20px; font-size: 12px;
            color: #888; line-height: 1.5;
        }
        .login-info a { color: #ff0000; text-decoration: none; font-weight: 600; }

        /* ANA UYGULAMA */
        .app {
            display: none;
            height: 100vh;
            width: 100vw;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
        }

        /* MEDYA PANELƒ∞ */
        .media-panel {
            width: 100%;
            background: #000;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
        }
        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            position: relative;
        }
        #youtubeContainer {
            width: 100%;
            height: 100%;
        }
        .video-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(45deg, var(--primary), var(--coadmin)); color: white;
        }
        .video-controls {
            position: absolute; bottom: 10px; right: 10px; display: flex; gap: 10px; z-index: 10;
        }
        .video-control-btn {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 18px; backdrop-filter: blur(5px);
        }
        .now-playing-bar {
            padding: 8px 16px; background: rgba(15,15,15,0.95); display: flex;
            align-items: center; justify-content: space-between; border-top: 1px solid var(--border-color);
        }
        .now-playing-info { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .now-playing-title { font-weight: 600; color: #fff; }
        .now-playing-artist { color: var(--primary); font-size: 12px; }
        .playlist-toggle {
            width: 36px; height: 36px; border-radius: 50%; background: rgba(26,26,26,0.8);
            display: flex; align-items: center; justify-content: center; color: #fff;
        }

        /* Playlist Dropdown */
        .playlist-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: rgba(15,15,15,0.98); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); max-height: 200px; overflow-y: auto; z-index: 20;
        }
        .playlist-dropdown.active { display: block; }
        .playlist-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .playlist-item:active { background: rgba(255,0,0,0.1); }
        .playlist-thumb {
            width: 40px; height: 40px; background: rgba(26,26,26,0.8); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; color: var(--primary);
        }
        .playlist-info { flex: 1; }
        .playlist-song { font-weight: 500; font-size: 14px; }
        .playlist-artist { font-size: 11px; color: #aaa; }
        .playlist-delete { color: #ff4444; padding: 8px; }

        /* ANA SOHBET ALANI */
        .chat-container {
            flex: 1; display: flex; flex-direction: column; background: var(--bg-secondary);
            overflow: hidden; position: relative;
        }

        .chat-header {
            padding: 12px 16px; background: rgba(15,15,15,0.95); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .channel-info { display: flex; align-items: center; gap: 8px; }
        .channel-name { font-weight: 700; font-size: 18px; }
        .channel-stats { font-size: 12px; color: var(--text-secondary); display: flex; gap: 8px; }
        .header-actions { display: flex; gap: 12px; }
        .header-btn {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(26,26,26,0.8); color: #fff; position: relative;
        }
        .badge {
            position: absolute; top: -2px; right: -2px; background: #ff4444; color: white;
            font-size: 10px; min-width: 18px; height: 18px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-secondary);
        }

        .messages {
            flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 12px;
        }

        .message {
            display: flex; flex-direction: column; max-width: 85%;
        }
        .message.right { align-self: flex-end; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .message-sender { font-weight: 600; font-size: 13px; color: var(--primary); cursor: pointer; }
        .message-time { font-size: 10px; color: var(--text-secondary); }
        .message-text {
            font-size: 14px; line-height: 1.4; padding: 8px 12px;
            background: var(--message-user-bg); border-radius: 18px; border-top-left-radius: 4px;
            color: var(--text-primary);
        }
        .right .message-text {
            background: var(--primary); color: #fff; border-top-left-radius: 18px; border-top-right-radius: 4px;
        }
        .system-message {
            align-self: center; background: var(--message-system-bg); padding: 10px 20px; border-radius: 30px;
            font-size: 12px; color: var(--text-secondary); max-width: 95%; text-align: center;
            border: 1px solid var(--border-color);
        }

        .message.admin .message-text { background: var(--message-admin-bg); border-left: 3px solid var(--secondary); }
        .message.coadmin .message-text { background: var(--message-coadmin-bg); border-left: 3px solid var(--coadmin); }
        .message.operator .message-text { background: var(--message-operator-bg); border-left: 3px solid var(--operator); }
        .message.owner .message-text { background: var(--message-owner-bg); border-left: 3px solid var(--owner); }
        .message.ban-message .message-text { background: var(--message-ban-bg); border-left: 3px solid var(--ban-color); }
        .message.story-message .message-text { background: var(--message-story-bg); border-left: 3px solid var(--story-color); }
        .message.report-message .message-text { background: var(--message-report-bg); border-left: 3px solid var(--report-color); }

        .message-image {
            max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px;
            border: 1px solid var(--border-color); cursor: pointer;
        }

        .message-input-container {
            padding: 12px 16px; background: rgba(10,10,10,0.95); border-top: 1px solid var(--border-color); flex-shrink: 0;
        }
        .input-wrapper {
            display: flex; align-items: center; gap: 10px; background: rgba(26,26,26,0.8);
            border: 1px solid var(--border-color); border-radius: 30px; padding: 4px 4px 4px 18px;
        }
        .message-input {
            flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 15px;
            padding: 12px 0; max-height: 100px; resize: none; outline: none;
        }
        .send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: var(--primary);
            display: flex; align-items: center; justify-content: center; color: #fff;
        }

        /* √ñZEL SOHBET PANELƒ∞ */
        .private-chat-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-secondary);
            display: none; flex-direction: column; z-index: 100; transform: translateX(100%); transition: transform 0.3s ease;
        }
        .private-chat-panel.active { display: flex; transform: translateX(0); }

        .private-header {
            padding: 12px 16px; background: rgba(15,15,15,0.95); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 16px; flex-shrink: 0;
        }
        .private-back {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(26,26,26,0.8);
        }
        .private-user { flex: 1; display: flex; align-items: center; gap: 12px; }
        .private-avatar {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(26,26,26,0.8);
            display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--primary);
        }
        .private-user-info { flex: 1; }
        .private-user-name { font-weight: 600; font-size: 16px; }
        .private-user-status { font-size: 12px; color: #2ecc71; }
        .private-actions { display: flex; gap: 8px; }
        .private-action {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(26,26,26,0.8);
        }

        .private-messages {
            flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 16px;
        }

        .private-input-area {
            padding: 16px; background: rgba(10,10,10,0.95); border-top: 1px solid var(--border-color); flex-shrink: 0;
        }
        .private-media-actions {
            display: flex; gap: 12px; padding: 0 4px 12px 4px;
        }
        .private-media-btn {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(26,26,26,0.8);
            display: flex; align-items: center; justify-content: center;
        }
        .private-input-wrapper {
            display: flex; align-items: center; gap: 10px; background: rgba(26,26,26,0.8);
            border: 1px solid var(--border-color); border-radius: 30px; padding: 4px 4px 4px 18px;
        }

        /* STORY PANELƒ∞ */
        .story-section {
            position: relative;
        }
        .story-toggle-btn {
            background: none; border: none; color: var(--story-color); font-size: 20px;
            cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .story-toggle-badge {
            position: absolute; top: 2px; right: 2px; background: var(--story-color); color: white;
            font-size: 10px; min-width: 16px; height: 16px; border-radius: 8px; display: flex;
            align-items: center; justify-content: center; padding: 0 4px; display: none;
        }
        .story-container {
            background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap; display: none; transition: all 0.3s ease;
            max-height: 0; opacity: 0; padding: 0;
        }
        .story-container.active {
            display: block; max-height: 120px; opacity: 1; padding: 10px 16px;
        }
        .story-wrapper { display: inline-flex; gap: 16px; padding: 8px; }
        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer; min-width: 80px; transition: all 0.3s ease;
        }
        .story-avatar {
            width: 60px; height: 60px; border-radius: 50%; position: relative;
            border: 3px solid transparent; background: linear-gradient(45deg, var(--story-color), var(--owner)) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .story-avatar.seen { background: linear-gradient(45deg, var(--text-secondary), var(--text-secondary)) border-box; }
        .story-user { font-size: 12px; font-weight: 500; color: var(--text-primary); text-align: center; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }
        .story-badge {
            position: absolute; bottom: -5px; right: -5px; background: var(--story-color); color: white;
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; border: 2px solid var(--bg-secondary);
        }

        .story-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .story-content { max-width: 90%; max-height: 80%; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; position: relative; }
        .story-media { max-width: 100%; max-height: 70vh; display: block; }
        .story-text { padding: 20px; color: var(--text-primary); font-size: 16px; line-height: 1.5; text-align: center; }
        .story-info {
            padding: 16px; display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--border-color); background: var(--bg-secondary);
        }
        .story-actions { display: flex; gap: 12px; align-items: center; }
        .like-btn { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; transition: all 0.3s ease; padding: 4px; }
        .like-btn.liked { color: #ff4757; }
        .report-btn { background: none; border: none; color: var(--text-primary); font-size: 20px; cursor: pointer; transition: all 0.3s ease; padding: 4px; }
        .like-count { font-size: 14px; color: var(--text-secondary); }
        .story-progress { display: flex; gap: 4px; padding: 10px; width: 100%; max-width: 500px; }
        .progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.1s linear; }

        /* Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ */
        .notification-section { position: relative; }
        .notification-icon { position: relative; background: none; border: none; color: var(--text-primary); font-size: 20px; cursor: pointer; padding: 8px; }
        .notification-badge {
            position: absolute; top: 2px; right: 2px; background: #ff0000; color: white; font-size: 10px;
            min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; padding: 0 4px; display: none;
        }
        .notification-panel {
            position: absolute; top: 100%; right: 0; width: 300px; max-height: 400px; background: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1001; display: none; flex-direction: column; overflow: hidden;
        }
        .notification-panel.active { display: flex; }
        .notification-header { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        .notification-list { flex: 1; overflow-y: auto; padding: 8px; }
        .notification-item {
            padding: 12px; border-radius: 8px; margin-bottom: 8px; background: var(--message-user-bg);
            cursor: pointer; transition: all 0.3s ease;
        }
        .notification-item.unread { background: rgba(var(--primary-rgb), 0.1); border-left: 3px solid var(--primary); }
        .notification-footer { padding: 12px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; }

        /* ROL BADGELERƒ∞ */
        .role-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px; color: white; display: inline-block;
        }
        .badge-owner { background: var(--owner); }
        .badge-admin { background: var(--secondary); }
        .badge-coadmin { background: var(--coadmin); }
        .badge-operator { background: var(--operator); }
        .badge-story { background: var(--story-color); }

        /* Alt Navigasyon */
        .mobile-nav {
            display: flex; justify-content: space-around; align-items: center; padding: 8px 12px 12px;
            background: rgba(10,10,10,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); flex-shrink: 0;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #888; font-size: 12px;
            gap: 4px; padding: 4px 12px; border-radius: 30px; position: relative;
        }
        .nav-item i { font-size: 22px; }
        .nav-item.active { color: var(--primary); }
        .nav-item .badge { position: absolute; top: -2px; right: -2px; }
        .profile-nav {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(26,26,26,0.8);
            border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
            font-weight: 600; color: #fff; overflow: hidden;
        }

        /* Yan Paneller */
        .side-panel {
            position: absolute; top: 0; width: 85%; height: 100%; background: rgba(10,10,10,0.98);
            backdrop-filter: blur(10px); z-index: 150; display: none; flex-direction: column;
        }
        .side-panel.left { left: 0; border-right: 1px solid var(--border-color); }
        .side-panel.right { right: 0; border-left: 1px solid var(--border-color); }
        .side-panel.active { display: flex; }

        .panel-header {
            padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;
        }
        .panel-header h3 { display: flex; align-items: center; gap: 8px; font-size: 16px; }
        .panel-close {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(26,26,26,0.8);
        }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }

        .panel-tabs {
            display: flex; border-bottom: 1px solid var(--border-color);
        }
        .panel-tab {
            flex: 1; padding: 14px; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-secondary);
        }
        .panel-tab.active { color: #fff; border-bottom: 2px solid var(--primary); }

        .channel-item, .user-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 4px;
        }
        .channel-item:active, .user-item:active { background: rgba(26,26,26,0.8); }
        .item-avatar {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(26,26,26,0.8);
            display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--primary); flex-shrink: 0; overflow: hidden;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 6px; }
        .item-meta { font-size: 12px; color: var(--text-secondary); }
        .online-status {
            width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; display: inline-block; margin-left: 6px;
        }

        .subscribe-small {
            padding: 6px 14px; background: rgba(26,26,26,0.8); border-radius: 30px; font-size: 12px; font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 300;
        }
        .modal-overlay.active { display: flex; }
        .modal-panel {
            width: 90%; max-width: 400px; background: rgba(26,26,26,0.95); border-radius: 24px; overflow: hidden;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        .modal-content { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; justify-content: flex-end; }
        .form-button { padding: 14px 24px; border-radius: 30px; border: none; font-weight: 600; }
        .form-button.primary { background: var(--primary); color: #fff; }
        .form-button.secondary { background: rgba(42,42,42,0.8); color: #fff; }

        /* Firebase Badge */
        .firebase-badge {
            position: fixed; bottom: 70px; right: 10px; background: var(--firebase); color: white;
            padding: 5px 10px; border-radius: 20px; font-size: 11px; z-index: 1000; display: flex; align-items: center; gap: 5px;
        }

        /* Baƒülantƒ± Durumu */
        .connection-status {
            position: fixed; bottom: 80px; right: 10px; padding: 6px 12px; border-radius: 20px;
            font-size: 11px; background: rgba(42,42,42,0.9); z-index: 1000; display: flex; align-items: center; gap: 6px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    </style>
</head>
<body>
    <!-- Gƒ∞Rƒ∞≈û EKRANI -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-panel">
            <h2>CETCETY <span>MOBƒ∞L</span></h2>
            <input type="text" id="loginNick" placeholder="Kullanƒ±cƒ± Adƒ±" autocomplete="off">
            <input type="password" id="loginPassword" placeholder="≈ûifre (varsa)" autocomplete="off">
            <button onclick="handleLogin()">Sohbete Katƒ±l</button>
            <div class="login-info">
                üî• Kayƒ±tsƒ±z nickler ≈üifresiz giri≈ü yapabilir<br>
                üëë Owner: MateKy ‚Ä¢ Admin ≈üifreli giri≈ü<br>
                üì± Story/Hikaye sistemi aktif
            </div>
        </div>
    </div>

    <!-- ANA UYGULAMA -->
    <div id="app" class="app">
        <!-- STORY/Hƒ∞KAYE B√ñL√úM√ú - A√áILIR/KAPANIR -->
        <div class="story-container" id="storyContainer">
            <div class="story-wrapper" id="storyWrapper">
                <!-- Story'ler buraya eklenecek -->
            </div>
        </div>

        <!-- MEDYA PANELƒ∞ (Video √ústte) -->
        <div class="media-panel">
            <div class="video-container">
                <div id="youtubeContainer"></div>
                <div class="video-placeholder" style="display: none;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üéµ</div>
                    <div style="font-size: 14px;">CETCETY Radio</div>
                </div>
                <div class="video-controls">
                    <div class="video-control-btn" onclick="toggleMute()">
                        <i class="fas fa-volume-up" id="muteIcon"></i>
                    </div>
                    <div class="video-control-btn" onclick="togglePlayPause()">
                        <i class="fas fa-pause" id="playPauseIcon"></i>
                    </div>
                </div>
            </div>
            <div class="now-playing-bar">
                <div class="now-playing-info">
                    <i class="fas fa-circle" style="color:var(--primary); font-size:8px;"></i>
                    <span class="now-playing-title" id="nowPlayingTitle">CETCETY Radio</span>
                    <span class="now-playing-artist" id="nowPlayingArtist">MateKy</span>
                </div>
                <div class="playlist-toggle" onclick="togglePlaylist()">
                    <i class="fas fa-list"></i>
                </div>
            </div>
            <!-- Playlist Dropdown -->
            <div class="playlist-dropdown" id="playlistDropdown">
                <div id="playlistItems"></div>
                <div style="padding:12px 16px;">
                    <button class="subscribe-small" onclick="openAddYoutubeModal()" style="width:100%; background:var(--primary);">
                        <i class="fas fa-plus"></i> Video Ekle
                    </button>
                </div>
            </div>
        </div>

        <!-- ANA SOHBET ALANI -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="channel-info">
                    <i class="fas fa-hashtag" style="color:var(--primary);"></i>
                    <span class="channel-name" id="currentChannelName">genel</span>
                </div>
                <div class="channel-stats">
                    <span id="channelUserCount">1</span> <i class="fas fa-user"></i>
                </div>
                <div class="header-actions">
                    <!-- Story Butonu -->
                    <div class="story-section">
                        <button class="header-btn story-toggle-btn" onclick="toggleStorySection()" title="Story/Hikaye">
                            <i class="fas fa-book-open"></i>
                            <span class="story-toggle-badge" id="storyToggleBadge">0</span>
                        </button>
                    </div>
                    
                    <!-- Bildirim Butonu -->
                    <div class="notification-section">
                        <button class="header-btn notification-icon" onclick="toggleNotificationPanel(event)" title="Bildirimler">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </button>
                        <div class="notification-panel" id="notificationPanel">
                            <div class="notification-header">
                                <span>Bildirimler</span>
                                <button onclick="closeNotificationPanel()" style="background:none; border:none; color:var(--text-primary); cursor:pointer;">√ó</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                            <div class="notification-footer">
                                <button class="clear-notifications-btn" onclick="clearAllNotifications()">Temizle</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="header-btn" onclick="openLeftPanel()">
                        <i class="fas fa-hashtag"></i>
                        <span class="badge" id="channelCountBadge">0</span>
                    </div>
                    <div class="header-btn" onclick="openRightPanel()">
                        <i class="fas fa-users"></i>
                        <span class="badge" id="onlineCountBadge">0</span>
                    </div>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="message-input-container">
                <div class="input-wrapper">
                    <textarea id="messageInput" class="message-input" placeholder="Mesaj yaz veya / komutlarƒ± kullan..." rows="1"></textarea>
                    <div class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- √ñZEL SOHBET PANELƒ∞ -->
        <div class="private-chat-panel" id="privateChatPanel">
            <div class="private-header">
                <div class="private-back" onclick="closePrivateChat()">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="private-user">
                    <div class="private-avatar" id="privateChatAvatar">?</div>
                    <div class="private-user-info">
                        <div class="private-user-name" id="privateChatName">Kullanƒ±cƒ±</div>
                        <div class="private-user-status" id="privateChatStatus">√ßevrimi√ßi</div>
                    </div>
                </div>
                <div class="private-actions">
                    <div class="private-action" onclick="blockUser()">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>

            <div class="private-messages" id="privateChatMessages"></div>

            <div class="private-input-area">
                <div class="private-media-actions">
                    <div class="private-media-btn" onclick="triggerPrivateImageUpload()">
                        <i class="fas fa-image"></i>
                    </div>
                    <input type="file" id="privateImageUpload" accept="image/*" style="display:none;">
                </div>
                <div class="private-input-wrapper">
                    <textarea id="privateMessageInput" class="message-input" placeholder="√ñzel mesaj yaz..." rows="1"></textarea>
                    <div class="send-btn" onclick="sendPrivateMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOL PANEL (Kanallar) -->
        <div class="side-panel left" id="leftPanel">
            <div class="panel-header">
                <h3><i class="fas fa-hashtag" style="color:var(--primary);"></i> <span id="leftPanelTitle">Kanallar</span></h3>
                <div class="panel-close" onclick="closeLeftPanel()">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchLeftTab('subscriptions')">Abonelikler</div>
                <div class="panel-tab" onclick="switchLeftTab('channels')">Ke≈üfet</div>
                <div class="panel-tab" onclick="switchLeftTab('chats')">Sohbetler</div>
            </div>
            <div class="panel-content" id="leftPanelContent"></div>
        </div>

        <!-- SAƒû PANEL (√áevrimi√ßi) -->
        <div class="side-panel right" id="rightPanel">
            <div class="panel-header">
                <h3><i class="fas fa-users" style="color:#7289da;"></i> <span id="rightPanelTitle">√áevrimi√ßi</span></h3>
                <div class="panel-close" onclick="closeRightPanel()">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="panel-content" id="rightPanelContent"></div>
        </div>

        <!-- ALT NAVƒ∞GASYON -->
        <div class="mobile-nav">
            <div class="nav-item" onclick="openLeftPanel()">
                <i class="fas fa-hashtag"></i>
                <span>Kanallar</span>
            </div>
            <div class="nav-item" onclick="openStoryCreateModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Story</span>
            </div>
            <div class="nav-item" onclick="openNotifications()">
                <i class="fas fa-bell"></i>
                <span>Bildirim</span>
                <span class="badge" id="navNotificationBadge">0</span>
            </div>
            <div class="profile-nav" id="profileNav" onclick="openProfilePanel()">
                <span id="navAvatarText">?</span>
            </div>
        </div>

        <!-- FIREBASE BADGE -->
        <div class="firebase-badge">
            <span>üî•</span> Firebase Active
        </div>

        <!-- BAƒûLANTI DURUMU -->
        <div class="connection-status connected" id="connectionStatus">
            <span class="status-dot"></span>
            <span id="statusText">CETCETY ‚Ä¢ Mobil</span>
        </div>
    </div>

    <!-- MODALLAR -->
    <div id="youtubeModal" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-header">
                <h3><i class="fab fa-youtube" style="color:var(--primary);"></i> Video Ekle</h3>
                <div class="panel-close" onclick="closeModal('youtubeModal')"><i class="fas fa-times"></i></div>
            </div>
            <div class="modal-content">
                <input type="text" id="youtubeUrlInput" class="message-input" placeholder="YouTube URL veya ID" style="width:100%; margin-bottom:12px;">
                <input type="text" id="youtubeTitleInput" class="message-input" placeholder="Video ba≈ülƒ±ƒüƒ±" style="width:100%;">
            </div>
            <div class="modal-footer">
                <button class="form-button secondary" onclick="closeModal('youtubeModal')">ƒ∞ptal</button>
                <button class="form-button primary" onclick="addYoutubeVideo()">Ekle</button>
            </div>
        </div>
    </div>

    <!-- STORY OLU≈ûTURMA MODALI -->
    <div id="storyCreateModal" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-header">
                <h3>üì± Yeni Story Olu≈ütur</h3>
                <div class="panel-close" onclick="closeModal('storyCreateModal')"><i class="fas fa-times"></i></div>
            </div>
            <div class="modal-content">
                <div class="story-options" style="display:flex; gap:8px; margin-bottom:16px;">
                    <button class="story-option-btn active" onclick="selectStoryOption('public')" id="publicStoryBtn" style="flex:1; padding:10px; background:var(--input-bg); border:1px solid var(--border-color); border-radius:8px;">üåç Herkese</button>
                    <button class="story-option-btn" onclick="selectStoryOption('private')" id="privateStoryBtn" style="flex:1; padding:10px; background:var(--input-bg); border:1px solid var(--border-color); border-radius:8px;">üîí √ñzel</button>
                </div>
                <textarea id="storyText" class="message-input" placeholder="Story metni..." style="width:100%; min-height:100px; margin-bottom:12px;"></textarea>
                <input type="file" id="storyImageUpload" accept="image/*" style="margin-bottom:12px;">
                <div id="storyImagePreview" style="display:none; margin-bottom:12px;">
                    <img id="previewImage" style="max-width:100%; max-height:200px; border-radius:8px;">
                    <button onclick="removeStoryImage()" style="margin-top:5px; padding:5px; background:var(--secondary); border:none; border-radius:4px; color:white;">Kaldƒ±r</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="form-button secondary" onclick="closeModal('storyCreateModal')">ƒ∞ptal</button>
                <button class="form-button primary" onclick="createStory()">Yayƒ±nla</button>
            </div>
        </div>
    </div>

    <!-- STORY G√ñSTERƒ∞M MODALI -->
    <div class="story-modal" id="storyModal">
        <div class="story-progress" id="storyProgress"></div>
        <div class="story-content" id="storyContent"></div>
        <div class="story-info" id="storyInfo"></div>
    </div>

    <!-- SES ELEMENTƒ∞ -->
    <audio id="notificationSound" style="display:none;">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========== FIREBASE KONFƒ∞G√úRASYONU ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let database = null;
        let usersRef, messagesRef, privateChatsRef, coAdminsRef, bansRef, registeredUsersRef, operatorsRef;
        let userLocksRef, adminPasswordsRef, customCommandsRef, adminListRef, storiesRef, storyLikesRef, storyReportsRef;
        let isFirebaseConnected = false;
        
        let currentUser = null;
        let isAdmin = false, isCoAdmin = false, isOperator = false, isOwner = false;
        let ytPlayer = null, ytPlayerReady = false;
        let isMuted = false, isPlaying = true;
        let privateChatWith = null, currentPrivateChatId = null;
        let coAdminList = [], operatorList = [], adminList = [], bannedUsers = {}, registeredUsers = {}, customCommands = {};
        let ownerPasswordHash = null;
        let originalTitle = document.title;

        // ========== CETCETY √ñZEL DEƒûƒ∞≈ûKENLER ==========
        let USERS_DB = JSON.parse(localStorage.getItem('cetcety_users')) || [];
        let ACTIVE_USER = null;
        let BLOCKED_USERS = JSON.parse(localStorage.getItem('cetcety_blocks')) || {};
        let PRIVATE_CHATS = JSON.parse(localStorage.getItem('cetcety_private_chats')) || {};
        let BANNED_WORDS = JSON.parse(localStorage.getItem('cetcety_banned_words')) || ['spam', 'reklam', '≈üiddet', 'hakaret'];
        let CHANNEL_MESSAGES = JSON.parse(localStorage.getItem('cetcety_channel_messages')) || { 'genel': [] };
        let currentChannel = 'genel';
        const OWNER_PASSWORD = 'Sahi17407@SCM';

        // Kanallar
        let channels = JSON.parse(localStorage.getItem('cetcety_channels')) || {
            'genel': { 
                name:'genel', owner:'MateKy', ownerRole:'owner', coAdmins:[], subscribers:1, online:1, isHidden:false,
                youtube: { 
                    currentVideo:'jfKfPfyJRdk', currentTitle:'CETCETY Radio', currentArtist:'MateKy', 
                    playlist:[{id:'jfKfPfyJRdk', title:'CETCETY Radio', addedBy:'MateKy', role:'owner'}]
                },
                onlineUsers:['MateKy']
            },
            'admin': { 
                name:'admin', owner:'MateKy', ownerRole:'owner', coAdmins:[], subscribers:1, online:1, isHidden:false,
                youtube: { 
                    currentVideo:'jfKfPfyJRdk', currentTitle:'Admin Kanalƒ±', currentArtist:'MateKy', 
                    playlist:[{id:'jfKfPfyJRdk', title:'Admin Kanalƒ±', addedBy:'MateKy', role:'owner'}]
                },
                onlineUsers:['MateKy']
            }
        };

        // ========== STORY Sƒ∞STEMƒ∞ ==========
        let stories = [], storyLikes = {}, storyReports = [];
        let currentStoryIndex = 0, currentStories = [], storyVisibility = 'public';
        let currentStoryId = null, storySectionOpen = false, storyProgressInterval = null;

        // ========== Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ==========
        let notificationCount = 0, notifications = [], notificationPanelOpen = false;

        // ========== FIREBASE BA≈ûLATMA ==========
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        isFirebaseConnected = true;
                        updateConnectionStatus('connected', 'Firebase Aktif');
                        
                        usersRef = database.ref('onlineUsers');
                        messagesRef = database.ref('messages');
                        privateChatsRef = database.ref('privateChats');
                        coAdminsRef = database.ref('coAdmins');
                        bansRef = database.ref('bans');
                        registeredUsersRef = database.ref('registeredUsers');
                        operatorsRef = database.ref('operators');
                        userLocksRef = database.ref('userLocks');
                        adminPasswordsRef = database.ref('adminPasswords');
                        customCommandsRef = database.ref('customCommands');
                        adminListRef = database.ref('adminList');
                        storiesRef = database.ref('stories');
                        storyLikesRef = database.ref('storyLikes');
                        storyReportsRef = database.ref('storyReports');
                        
                        loadCustomCommands();
                        updateBannedUsers();
                        loadStories();
                        loadStoryLikes();
                        loadStoryReports();
                        
                        if (ACTIVE_USER) {
                            saveUserToFirebase(ACTIVE_USER);
                        }
                    } else {
                        isFirebaseConnected = false;
                        updateConnectionStatus('disconnected', 'Yerel Mod');
                    }
                });
            } catch (error) {
                updateConnectionStatus('disconnected', 'Baƒülantƒ± Hatasƒ±');
            }
        }

        // ========== SHA-256 ≈ûƒ∞FRELEME ==========
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ========== OWNER ≈ûƒ∞FRE Sƒ∞STEMƒ∞ ==========
        async function initOwnerPassword() {
            try {
                const ownerPassword = "Sahi17407@SCM";
                const salt = "cetcety_secure_salt_2024";
                const hashedPassword = await sha256(ownerPassword + salt);
                ownerPasswordHash = { hash: hashedPassword, salt: salt };
            } catch (error) {
                ownerPasswordHash = { hash: "secure_hash", salt: "emergency" };
            }
        }

        async function verifyOwnerPassword(inputPassword) {
            if (!ownerPasswordHash) await initOwnerPassword();
            const inputHash = await sha256(inputPassword + ownerPasswordHash.salt);
            return inputHash === ownerPasswordHash.hash;
        }

        // ========== NICK NORMALƒ∞ZASYON ==========
        function normalizeNick(nick) {
            return nick ? nick.toLowerCase().trim() : '';
        }

        // ========== Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ==========
        async function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('Kullanƒ±cƒ± adƒ± bo≈ü olamaz!'); return; }

            let existingUser = USERS_DB.find(u => u.name.toLowerCase() === nick.toLowerCase());
            
            if (existingUser) {
                if (existingUser.password && existingUser.password !== pass) { 
                    alert('Hatalƒ± ≈üifre!'); return; 
                }
                if (nick.toLowerCase() === 'mateky' && pass !== OWNER_PASSWORD) { 
                    alert('Owner ≈üifresi hatalƒ±!'); return; 
                }
                ACTIVE_USER = existingUser;
            } else {
                if (nick.toLowerCase() === 'mateky') {
                    if (pass !== OWNER_PASSWORD) { alert('Owner ≈üifresi hatalƒ±!'); return; }
                }
                ACTIVE_USER = {
                    id: Date.now(), name: nick, role: (nick.toLowerCase() === 'mateky') ? 'owner' : 'user',
                    roleLevel: (nick.toLowerCase() === 'mateky') ? 5 : 1, subscribedChannels: ['genel'],
                    myChannel: null, joinDate: new Date().toISOString(), avatar: nick.charAt(0).toUpperCase(),
                    avatarData: null, password: pass || '', privateMode: 'all', blockedNicks: []
                };
                USERS_DB.push(ACTIVE_USER);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            }

            // Yetki kontrolleri
            if (nick.toLowerCase() === 'mateky') {
                isOwner = true;
                ACTIVE_USER.role = 'owner';
            }

            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));

            if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                channels.genel.onlineUsers.push(ACTIVE_USER.name);
            }
            saveChannels();

            if (database) {
                saveUserToFirebase(ACTIVE_USER);
            }

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';

            updateUIForUser();
            updateAllBadges();
            loadChannelMessages('genel');
            updateMediaDisplay();
            addSystemMessage(`üëã Ho≈ü geldin, ${ACTIVE_USER.name}!`);

            if (typeof YT === 'undefined' || !YT.Player) {
                let tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(tag);
            } else {
                initYouTubePlayer();
            }

            initOwnerPassword();
        }

        // ========== YOUTUBE ƒ∞≈ûLEMLERƒ∞ ==========
        function initYouTubePlayer() {
            let c = channels[currentChannel];
            if (!c || !document.getElementById('youtubeContainer')) return;
            
            try {
                ytPlayer = new YT.Player('youtubeContainer', {
                    height: '100%', width: '100%',
                    videoId: c.youtube.currentVideo,
                    playerVars: { 
                        autoplay: 1, controls: 0, modestbranding: 1, rel: 0, playsinline: 1
                    },
                    events: {
                        onReady: function(event) {
                            ytPlayerReady = true;
                            document.querySelector('.video-placeholder').style.display = 'none';
                            event.target.playVideo();
                        },
                        onStateChange: function(event) {
                            let icon = document.getElementById('playPauseIcon');
                            if (icon) icon.className = event.data === YT.PlayerState.PLAYING ? 'fas fa-pause' : 'fas fa-play';
                            isPlaying = event.data === YT.PlayerState.PLAYING;
                            
                            if (event.data === YT.PlayerState.ENDED) playNextVideo();
                        }
                    }
                });
            } catch (e) {}
        }

        function onYouTubeIframeAPIReady() { initYouTubePlayer(); }

        function toggleMute() {
            if (!ytPlayer || !ytPlayerReady) return;
            if (isMuted) { ytPlayer.unMute(); document.getElementById('muteIcon').className = 'fas fa-volume-up'; }
            else { ytPlayer.mute(); document.getElementById('muteIcon').className = 'fas fa-volume-mute'; }
            isMuted = !isMuted;
        }

        function togglePlayPause() {
            if (!ytPlayer || !ytPlayerReady) return;
            if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) ytPlayer.pauseVideo();
            else ytPlayer.playVideo();
        }

        function playNextVideo() {
            let c = channels[currentChannel];
            if (!c || !c.youtube.playlist || c.youtube.playlist.length === 0) return;
            
            let currentIndex = c.youtube.playlist.findIndex(item => item.id === c.youtube.currentVideo);
            let nextIndex = (currentIndex + 1) % c.youtube.playlist.length;
            let nextVideo = c.youtube.playlist[nextIndex];
            
            playYoutubeVideo(nextVideo.id, nextVideo.title, nextVideo.addedBy, nextVideo.role);
        }

        function playYoutubeVideo(vid, title, by, role) {
            let c = channels[currentChannel];
            c.youtube.currentVideo = vid;
            c.youtube.currentTitle = title;
            c.youtube.currentArtist = by;
            saveChannels();
            
            if (ytPlayer && ytPlayerReady) ytPlayer.loadVideoById(vid);
            
            updateMediaDisplay();
            document.getElementById('playlistDropdown').classList.remove('active');
            addSystemMessage(`üé¨ ${by} yeni video oynatƒ±yor: ${title}`);
        }

        function togglePlaylist() {
            document.getElementById('playlistDropdown').classList.toggle('active');
            loadPlaylist();
        }

        function loadPlaylist() {
            let c = channels[currentChannel];
            let container = document.getElementById('playlistItems');
            if (!container) return;
            
            let html = '';
            c.youtube.playlist.forEach((item, i) => {
                let canDel = ACTIVE_USER && (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || 
                           (c.coAdmins?.includes(ACTIVE_USER.name) && item.addedBy === ACTIVE_USER.name));
                
                html += `<div class="playlist-item" onclick="playYoutubeVideo('${item.id}', '${escapeHTML(item.title)}', '${escapeHTML(item.addedBy)}', '${item.role}')">
                    <div class="playlist-thumb"><i class="fab fa-youtube"></i></div>
                    <div class="playlist-info">
                        <div class="playlist-song">${escapeHTML(item.title)}</div>
                        <div class="playlist-artist">${escapeHTML(item.addedBy)}</div>
                    </div>
                    ${canDel ? `<div class="playlist-delete" onclick="event.stopPropagation(); removeFromPlaylist(${i})"><i class="fas fa-trash"></i></div>` : ''}
                </div>`;
            });
            container.innerHTML = html;
        }

        function removeFromPlaylist(index) {
            let c = channels[currentChannel];
            c.youtube.playlist.splice(index, 1);
            if (c.youtube.playlist.length > 0) {
                let first = c.youtube.playlist[0];
                playYoutubeVideo(first.id, first.title, first.addedBy, first.role);
            }
            saveChannels();
            loadPlaylist();
        }

        function openAddYoutubeModal() {
            let c = channels[currentChannel];
            if (!ACTIVE_USER || !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name))) {
                addSystemMessage('‚ùå Video ekleme yetkiniz yok!');
                return;
            }
            document.getElementById('youtubeUrlInput').value = '';
            document.getElementById('youtubeTitleInput').value = '';
            document.getElementById('youtubeModal').classList.add('active');
            document.getElementById('playlistDropdown').classList.remove('active');
        }

        function addYoutubeVideo() {
            let url = document.getElementById('youtubeUrlInput').value.trim();
            let title = document.getElementById('youtubeTitleInput').value.trim();
            if (!url) { addSystemMessage('‚ùå Video URL/ID girin!'); return; }

            let vid = '';
            if (url.includes('youtube.com/watch?v=')) vid = url.split('v=')[1]?.split('&')[0];
            else if (url.includes('youtu.be/')) vid = url.split('youtu.be/')[1]?.split('?')[0];
            else if (url.match(/^[a-zA-Z0-9_-]{11}$/)) vid = url;
            else { addSystemMessage('‚ùå Ge√ßersiz YouTube URL/ID!'); return; }

            let c = channels[currentChannel];
            if (!title) title = `Video ${c.youtube.playlist.length + 1}`;

            c.youtube.playlist.push({
                id: vid, title: title, addedBy: ACTIVE_USER.name,
                role: ACTIVE_USER.role === 'owner' ? 'owner' : ACTIVE_USER.role === 'admin' ? 'admin' : 'coadmin'
            });
            saveChannels();
            closeModal('youtubeModal');
            addSystemMessage(`‚úÖ "${title}" eklendi!`);
            loadPlaylist();
        }

        function updateMediaDisplay() {
            let c = channels[currentChannel];
            if (!c) return;
            document.getElementById('nowPlayingTitle').textContent = c.youtube.currentTitle;
            document.getElementById('nowPlayingArtist').textContent = c.youtube.currentArtist;
        }

        function saveChannels() { localStorage.setItem('cetcety_channels', JSON.stringify(channels)); }

        // ========== SOHBET ƒ∞≈ûLEMLERƒ∞ ==========
        function addSystemMessage(text) {
            let container = document.getElementById('messages');
            let msgDiv = document.createElement('div');
            msgDiv.className = 'system-message';
            msgDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${escapeHTML(text)}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function escapeHTML(text) {
            if (!text) return '';
            let div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendMessage() {
            let inp = document.getElementById('messageInput');
            let txt = inp.value.trim();
            if (!txt) return;
            
            if (txt.startsWith('/')) {
                handleCommand(txt);
                inp.value = '';
                return;
            }

            let time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            let msg = { 
                sender: ACTIVE_USER.name, text: txt, time: time, timestamp: Date.now(),
                type: isOwner ? 'owner' : (isAdmin ? 'admin' : (isCoAdmin ? 'coadmin' : (isOperator ? 'operator' : 'user')))
            };

            if (!CHANNEL_MESSAGES[currentChannel]) CHANNEL_MESSAGES[currentChannel] = [];
            CHANNEL_MESSAGES[currentChannel].push(msg);
            localStorage.setItem('cetcety_channel_messages', JSON.stringify(CHANNEL_MESSAGES));

            if (database) {
                saveMessageToFirebase(currentChannel, msg);
            }

            appendMessageToChat(msg, true);
            inp.value = '';
        }

        function appendMessageToChat(msg, isMe) {
            let container = document.getElementById('messages');
            if (!container) return;

            let msgDiv = document.createElement('div');
            msgDiv.className = `message ${isMe ? 'right' : ''} ${msg.type || 'user'}`;
            
            let roleBadge = '';
            if (msg.type === 'owner') roleBadge = '<span class="role-badge badge-owner">OWNER</span>';
            else if (msg.type === 'admin') roleBadge = '<span class="role-badge badge-admin">ADMIN</span>';
            else if (msg.type === 'coadmin') roleBadge = '<span class="role-badge badge-coadmin">CO-ADMIN</span>';
            else if (msg.type === 'operator') roleBadge = '<span class="role-badge badge-operator">OPERATOR</span>';
            
            msgDiv.innerHTML = `
                <div class="message-header" style="${isMe ? 'justify-content:flex-end;' : ''}">
                    <span class="message-time">${msg.time || ''}</span>
                    <span class="message-sender" onclick="${!isMe ? `openPrivateChat('${msg.sender}')` : ''}">
                        ${escapeHTML(msg.sender)} ${roleBadge}
                    </span>
                </div>
                <div class="message-text">${escapeHTML(msg.text)}</div>`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function loadChannelMessages(channel) {
            let container = document.getElementById('messages');
            container.innerHTML = '';
            addSystemMessage(`üì¢ #${channel} kanalƒ±na ho≈ü geldin!`);

            if (!CHANNEL_MESSAGES[channel]) CHANNEL_MESSAGES[channel] = [];
            CHANNEL_MESSAGES[channel].forEach(msg => {
                let isMe = msg.sender === ACTIVE_USER?.name;
                appendMessageToChat(msg, isMe);
            });
            container.scrollTop = container.scrollHeight;
        }

        // ========== KOMUT Sƒ∞STEMƒ∞ ==========
        async function handleCommand(cmd) {
            let parts = cmd.substring(1).split(' ');
            let main = parts[0].toLowerCase();

            // √ñzel komut kontrol√º
            if (customCommands[main]) {
                addSystemMessage(customCommands[main].response);
                return;
            }

            switch(main) {
                case 'help':
                case 'yardƒ±m':
                    let help = 'üìã <strong>KOMUTLAR:</strong><br>';
                    help += '‚Ä¢ /story olu≈ütur - Yeni story<br>';
                    help += '‚Ä¢ /story liste - Story\'leri g√∂ster<br>';
                    help += '‚Ä¢ /admin [≈üifre] - Admin giri≈üi<br>';
                    help += '‚Ä¢ /ban [kullanƒ±cƒ±] [dk] [sebep] - Banla<br>';
                    help += '‚Ä¢ /unban [kullanƒ±cƒ±] - Ban kaldƒ±r<br>';
                    help += '‚Ä¢ /banlist - Ban listesi<br>';
                    help += '‚Ä¢ /temizle - Sohbeti temizle (yetkili)<br>';
                    help += '‚Ä¢ /kullanƒ±cƒ±lar - Online kullanƒ±cƒ±lar<br>';
                    help += '‚Ä¢ /tema - Tema deƒüi≈ütir<br>';
                    help += '‚Ä¢ /√ßƒ±kƒ±≈ü - √áƒ±kƒ±≈ü yap';
                    addSystemMessage(help);
                    break;
                    
                case 'story':
                case 'hikaye':
                    if (parts[1] === 'olustur' || parts[1] === 'olu≈ütur') openStoryCreateModal();
                    else if (parts[1] === 'liste') showStories();
                    else addSystemMessage('Kullanƒ±m: /story olu≈ütur veya /story liste');
                    break;
                    
                case 'admin':
                    if (parts.length === 1) addSystemMessage('Kullanƒ±m: /admin [≈üifre]');
                    else await handleAdminLogin(parts[1]);
                    break;
                    
                case 'ban':
                case 'kick':
                    if (!isAdmin && !isCoAdmin && !isOperator && !isOwner) 
                        addSystemMessage('‚õî Yetkiniz yok!');
                    else if (parts.length >= 1) 
                        await kickUser(parts[0], parts[1] || 5, parts.slice(2).join(' ') || 'Belirtilmemi≈ü');
                    else addSystemMessage('Kullanƒ±m: /ban [kullanƒ±cƒ±] [dakika] [sebep]');
                    break;
                    
                case 'unban':
                    if (!isAdmin && !isCoAdmin && !isOperator && !isOwner) 
                        addSystemMessage('‚õî Yetkiniz yok!');
                    else if (parts.length === 1) 
                        await unbanUser(parts[0]);
                    else addSystemMessage('Kullanƒ±m: /unban [kullanƒ±cƒ±]');
                    break;
                    
                case 'banlist':
                    await showBanList();
                    break;
                    
                case 'temizle':
                    if (!isAdmin && !isCoAdmin && !isOperator && !isOwner) 
                        addSystemMessage('‚õî Yetkiniz yok!');
                    else {
                        document.getElementById('messages').innerHTML = '';
                        addSystemMessage('‚úÖ Sohbet temizlendi!');
                    }
                    break;
                    
                case 'kullanƒ±cƒ±lar':
                case 'users':
                case 'online':
                    showOnlineUsers();
                    break;
                    
                case 'tema':
                case 'theme':
                    toggleTheme();
                    break;
                    
                case 'ping':
                    addSystemMessage('üèì Pong!');
                    break;
                    
                case '√ßƒ±kƒ±≈ü':
                case 'exit':
                case 'logout':
                    logout();
                    break;
                    
                default:
                    addSystemMessage(`‚ùå Bilinmeyen komut: ${cmd}`);
            }
        }

        // ========== YETKƒ∞ Sƒ∞STEMƒ∞ ==========
        async function handleAdminLogin(password) {
            const normalizedName = normalizeNick(ACTIVE_USER.name);
            
            if (normalizedName === normalizeNick('mateky')) {
                if (await verifyOwnerPassword(password)) {
                    isOwner = true;
                    ACTIVE_USER.role = 'owner';
                    addSystemMessage('‚úÖ Owner giri≈üi ba≈üarƒ±lƒ±!');
                } else addSystemMessage('‚ùå Hatalƒ± ≈üifre!');
                return;
            }
            
            if (adminList.includes(ACTIVE_USER.name) || SECURE_CONFIG?.DEFAULT_ADMINS?.includes(ACTIVE_USER.name)) {
                if (await verifyAdminPassword(password)) {
                    isAdmin = true;
                    ACTIVE_USER.role = 'admin';
                    addSystemMessage('‚úÖ Admin giri≈üi ba≈üarƒ±lƒ±!');
                } else addSystemMessage('‚ùå Hatalƒ± ≈üifre!');
            } else addSystemMessage('‚ùå Bu kullanƒ±cƒ± admin deƒüil!');
        }

        async function verifyAdminPassword(password) {
            // Basit admin ≈üifre kontrol√º
            return password === 'admin123' || password === 'Sahi17407@SCM';
        }

        // ========== BAN Sƒ∞STEMƒ∞ ==========
        async function kickUser(username, duration = 5, reason = "Kick") {
            if (!username || username === ACTIVE_USER.name) {
                addSystemMessage('‚ùå Ge√ßersiz kullanƒ±cƒ±!');
                return;
            }
            
            const banUntil = Date.now() + (parseInt(duration) * 60000);
            
            if (!bansRef) {
                // Yerel ban
                bannedUsers[username] = { bannedUntil: banUntil, bannedBy: ACTIVE_USER.name, reason: reason };
                addBanMessage(`üö´ ${username} ${duration} dakika banlandƒ±! Sebep: ${reason}`);
            } else {
                await bansRef.child(username).set({
                    bannedUntil: banUntil, bannedBy: ACTIVE_USER.name, reason: reason,
                    timestamp: Date.now(), duration: duration
                });
                addBanMessage(`üö´ ${username} ${duration} dakika banlandƒ±! Sebep: ${reason}`);
            }
            
            // Kanal listesinden √ßƒ±kar
            if (channels[currentChannel] && channels[currentChannel].onlineUsers.includes(username)) {
                channels[currentChannel].onlineUsers = channels[currentChannel].onlineUsers.filter(u => u !== username);
                saveChannels();
            }
        }

        async function unbanUser(username) {
            if (bansRef) await bansRef.child(username).remove();
            else delete bannedUsers[username];
            addSystemMessage(`‚úÖ ${username} banƒ± kaldƒ±rƒ±ldƒ±!`);
        }

        async function showBanList() {
            let banList = 'üö´ <strong>BANLI KULLANICILAR:</strong><br>';
            let activeBans = 0;
            
            if (bansRef) {
                const snapshot = await bansRef.once('value');
                const bans = snapshot.val() || {};
                Object.entries(bans).forEach(([user, data]) => {
                    if (data.bannedUntil > Date.now()) {
                        activeBans++;
                        banList += `‚Ä¢ ${user} - ${Math.ceil((data.bannedUntil - Date.now())/60000)} dk kaldƒ±<br>`;
                    }
                });
            } else {
                Object.entries(bannedUsers).forEach(([user, data]) => {
                    if (data.bannedUntil > Date.now()) {
                        activeBans++;
                        banList += `‚Ä¢ ${user} - ${Math.ceil((data.bannedUntil - Date.now())/60000)} dk kaldƒ±<br>`;
                    }
                });
            }
            
            if (activeBans === 0) banList += 'Aktif ban yok.';
            addSystemMessage(banList);
        }

        function updateBannedUsers() {
            if (!bansRef) return;
            bansRef.on('value', (snapshot) => {
                bannedUsers = snapshot.val() || {};
            });
        }

        // ========== √ñZEL SOHBET ==========
        function openPrivateChat(username) {
            if (!username || !ACTIVE_USER || username === ACTIVE_USER.name) return;
            
            privateChatWith = username;
            document.getElementById('privateChatName').textContent = username;
            document.getElementById('privateChatAvatar').innerHTML = username.charAt(0).toUpperCase();
            document.getElementById('privateChatPanel').classList.add('active');
            loadPrivateMessages();
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            privateChatWith = null;
            currentPrivateChatId = null;
        }

        function loadPrivateMessages() {
            if (!privateChatWith || !ACTIVE_USER) return;
            let chatId = [ACTIVE_USER.id, privateChatWith].sort().join('_');
            let msgs = PRIVATE_CHATS[chatId] || [];
            let container = document.getElementById('privateChatMessages');
            let html = '';
            
            msgs.forEach(msg => {
                let isMe = msg.senderId === ACTIVE_USER.id;
                let time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                
                if (msg.type === 'text') {
                    html += `<div class="message ${isMe ? 'right' : ''}">
                        <div class="message-header" style="${isMe ? 'justify-content:flex-end;' : ''}">
                            <span class="message-time">${time}</span>
                            <span class="message-sender">${msg.senderName}</span>
                        </div>
                        <div class="message-text">${escapeHTML(msg.content)}</div>
                    </div>`;
                } else if (msg.type === 'image') {
                    html += `<div class="message ${isMe ? 'right' : ''}">
                        <div class="message-header" style="${isMe ? 'justify-content:flex-end;' : ''}">
                            <span class="message-time">${time}</span>
                            <span class="message-sender">${msg.senderName}</span>
                        </div>
                        <img src="${escapeHTML(msg.content)}" style="max-width:200px; border-radius:12px;" onclick="window.open(this.src)">
                    </div>`;
                }
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function sendPrivateMessage() {
            let input = document.getElementById('privateMessageInput');
            let text = input.value.trim();
            if (!text || !privateChatWith || !ACTIVE_USER) return;

            let chatId = [ACTIVE_USER.id, privateChatWith].sort().join('_');
            if (!PRIVATE_CHATS[chatId]) PRIVATE_CHATS[chatId] = [];

            PRIVATE_CHATS[chatId].push({
                id: Date.now(), senderId: ACTIVE_USER.id, senderName: ACTIVE_USER.name,
                type: 'text', content: text, timestamp: Date.now()
            });
            
            localStorage.setItem('cetcety_private_chats', JSON.stringify(PRIVATE_CHATS));
            input.value = '';
            loadPrivateMessages();
            updateAllBadges();
        }

        function triggerPrivateImageUpload() { document.getElementById('privateImageUpload').click(); }

        document.getElementById('privateImageUpload').addEventListener('change', function(e) {
            if (!e.target.files[0] || !privateChatWith) return;
            let reader = new FileReader();
            reader.onload = (e) => {
                let chatId = [ACTIVE_USER.id, privateChatWith].sort().join('_');
                if (!PRIVATE_CHATS[chatId]) PRIVATE_CHATS[chatId] = [];
                PRIVATE_CHATS[chatId].push({
                    id: Date.now(), senderId: ACTIVE_USER.id, senderName: ACTIVE_USER.name,
                    type: 'image', content: e.target.result, timestamp: Date.now()
                });
                localStorage.setItem('cetcety_private_chats', JSON.stringify(PRIVATE_CHATS));
                loadPrivateMessages();
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        function blockUser() {
            if (privateChatWith) {
                addSystemMessage(`üö´ ${privateChatWith} engellendi.`);
                closePrivateChat();
            }
        }

        // ========== STORY Sƒ∞STEMƒ∞ ==========
        function toggleStorySection() {
            const container = document.getElementById('storyContainer');
            storySectionOpen = !storySectionOpen;
            if (storySectionOpen) {
                container.classList.add('active');
                updateStoryContainer();
            } else {
                container.classList.remove('active');
            }
        }

        async function loadStories() {
            if (!storiesRef) return;
            try {
                const snapshot = await storiesRef.once('value');
                const storiesData = snapshot.val() || {};
                stories = [];
                Object.entries(storiesData).forEach(([storyId, story]) => {
                    if (story && story.expiresAt > Date.now()) {
                        stories.push({ id: storyId, ...story });
                    }
                });
                updateStoryContainer();
                updateStoryBadge();
            } catch (error) {}
        }

        function updateStoryContainer() {
            const wrapper = document.getElementById('storyWrapper');
            if (!wrapper) return;
            wrapper.innerHTML = '';
            
            if (!storySectionOpen) return;
            
            let visibleStories = stories.filter(story => {
                if (story.visibility === 'public') return true;
                else if (story.visibility === 'private' && ACTIVE_USER) {
                    return story.sender === ACTIVE_USER.name || story.receiver === ACTIVE_USER.name;
                }
                return false;
            });
            
            const userStories = {};
            visibleStories.forEach(story => {
                if (!userStories[story.sender] || story.timestamp > userStories[story.sender].timestamp) {
                    userStories[story.sender] = story;
                }
            });
            
            Object.values(userStories).forEach(story => {
                const storyItem = document.createElement('div');
                storyItem.className = 'story-item';
                storyItem.onclick = () => openStoryModal(story.sender);
                
                let avatarText = story.sender.charAt(0).toUpperCase();
                if (story.sender === 'MateKy') avatarText = 'üëë';
                
                storyItem.innerHTML = `
                    <div class="story-avatar">${avatarText}</div>
                    <div class="story-user">${story.sender}</div>
                `;
                wrapper.appendChild(storyItem);
            });
        }

        function updateStoryBadge() {
            const badge = document.getElementById('storyToggleBadge');
            if (badge && stories.length > 0) {
                badge.textContent = stories.length;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }

        async function openStoryModal(username) {
            if (!ACTIVE_USER) return;
            
            const userStories = stories.filter(story => 
                story.sender === username && story.expiresAt > Date.now()
            ).sort((a, b) => a.timestamp - b.timestamp);
            
            if (userStories.length === 0) return;
            
            currentStories = userStories;
            currentStoryIndex = 0;
            
            document.getElementById('storyModal').style.display = 'flex';
            showStory(currentStoryIndex);
            createProgressBars();
            startStoryProgress();
        }

        function showStory(index) {
            if (index < 0 || index >= currentStories.length) {
                closeStoryModal();
                return;
            }
            
            const story = currentStories[index];
            const content = document.getElementById('storyContent');
            const info = document.getElementById('storyInfo');
            
            currentStoryId = story.id;
            
            let storyHTML = '';
            if (story.image) {
                storyHTML = `<img src="${story.image}" class="story-media" onclick="nextStory()">`;
            } else {
                storyHTML = `<div class="story-text">${story.text}</div>`;
            }
            
            content.innerHTML = storyHTML;
            
            const time = new Date(story.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const likeCount = storyLikes[story.id] || 0;
            
            info.innerHTML = `
                <div><strong>${story.sender}</strong><div style="font-size:12px; color:var(--text-secondary);">${time}</div></div>
                <div class="story-actions">
                    <button class="like-btn" onclick="toggleStoryLike('${story.id}')">‚ù§Ô∏è</button>
                    <span class="like-count">${likeCount}</span>
                </div>
            `;
            
            updateProgressBar(index);
        }

        function createProgressBars() {
            const progressContainer = document.getElementById('storyProgress');
            progressContainer.innerHTML = '';
            currentStories.forEach((story, index) => {
                progressContainer.innerHTML += `
                    <div class="progress-bar"><div class="progress-fill" id="progress_${index}"></div></div>
                `;
            });
        }

        function updateProgressBar(index) {
            for (let i = 0; i < currentStories.length; i++) {
                const progressFill = document.getElementById(`progress_${i}`);
                if (progressFill) progressFill.style.width = i <= index ? '100%' : '0%';
            }
        }

        function startStoryProgress() {
            stopStoryProgress();
            const duration = 5000;
            let startTime = Date.now();
            
            storyProgressInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = (elapsed / duration) * 100;
                
                const currentProgress = document.getElementById(`progress_${currentStoryIndex}`);
                if (currentProgress) currentProgress.style.width = Math.min(progress, 100) + '%';
                
                if (elapsed >= duration) nextStory();
            }, 100);
        }

        function stopStoryProgress() {
            if (storyProgressInterval) {
                clearInterval(storyProgressInterval);
                storyProgressInterval = null;
            }
        }

        function nextStory() {
            currentStoryIndex++;
            if (currentStoryIndex >= currentStories.length) closeStoryModal();
            else {
                showStory(currentStoryIndex);
                startStoryProgress();
            }
        }

        function prevStory() {
            currentStoryIndex--;
            if (currentStoryIndex < 0) closeStoryModal();
            else {
                showStory(currentStoryIndex);
                startStoryProgress();
            }
        }

        function closeStoryModal() {
            stopStoryProgress();
            document.getElementById('storyModal').style.display = 'none';
        }

        async function toggleStoryLike(storyId) {
            if (!ACTIVE_USER) return;
            storyLikes[storyId] = (storyLikes[storyId] || 0) + 1;
            if (storyLikesRef) await storyLikesRef.child(storyId).set(storyLikes[storyId]);
        }

        async function loadStoryLikes() {
            if (!storyLikesRef) return;
            const snapshot = await storyLikesRef.once('value');
            storyLikes = snapshot.val() || {};
        }

        async function loadStoryReports() {
            if (!storyReportsRef) return;
            const snapshot = await storyReportsRef.once('value');
            storyReports = snapshot.val() || {};
        }

        function openStoryCreateModal() {
            if (!ACTIVE_USER) { addSystemMessage('√ñnce giri≈ü yapƒ±n!'); return; }
            document.getElementById('storyCreateModal').classList.add('active');
            document.getElementById('storyText').value = '';
            document.getElementById('storyImagePreview').style.display = 'none';
            selectStoryOption('public');
        }

        function selectStoryOption(option) {
            storyVisibility = option;
            const publicBtn = document.getElementById('publicStoryBtn');
            const privateBtn = document.getElementById('privateStoryBtn');
            if (option === 'public') {
                publicBtn.classList.add('active');
                privateBtn.classList.remove('active');
            } else {
                publicBtn.classList.remove('active');
                privateBtn.classList.add('active');
            }
        }

        function handleStoryImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('storyImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removeStoryImage() {
            document.getElementById('storyImagePreview').style.display = 'none';
            document.getElementById('storyImageUpload').value = '';
        }

        async function createStory() {
            if (!ACTIVE_USER || !storiesRef) return;
            
            const text = document.getElementById('storyText').value.trim();
            const imageFile = document.getElementById('storyImageUpload').files[0];
            
            if (!text && !imageFile) { alert('Metin veya resim girin!'); return; }
            
            let imageData = null;
            if (imageFile) {
                const reader = new FileReader();
                imageData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageFile);
                });
            }
            
            const storyData = {
                sender: ACTIVE_USER.name,
                text: text,
                image: imageData,
                timestamp: Date.now(),
                expiresAt: Date.now() + (24 * 60 * 60 * 1000),
                visibility: storyVisibility
            };
            
            await storiesRef.push(storyData);
            closeModal('storyCreateModal');
            addSystemMessage('üì± Story payla≈üƒ±ldƒ±!');
            await loadStories();
        }

        function showStories() {
            if (stories.length === 0) {
                addSystemMessage('üì± Aktif story yok.');
                return;
            }
            
            let storyList = 'üì± <strong>STORY\'LER:</strong><br>';
            stories.forEach(story => {
                storyList += `‚Ä¢ ${story.sender}: ${story.text ? story.text.substring(0,30) : 'üì∏ Resim'}<br>`;
            });
            addSystemMessage(storyList);
        }

        // ========== Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ==========
        function toggleNotificationPanel(e) {
            if (e) e.stopPropagation();
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            panel.classList.toggle('active', notificationPanelOpen);
            if (notificationPanelOpen) updateNotificationPanel();
        }

        function closeNotificationPanel() {
            document.getElementById('notificationPanel').classList.remove('active');
            notificationPanelOpen = false;
        }

        function addNotification(sender, message, type = 'private') {
            notificationCount++;
            notifications.unshift({
                id: Date.now() + Math.random(),
                sender: sender, message: message, type: type,
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(), read: false
            });
            updateNotificationBadge();
            playNotificationSound();
            if (notificationPanelOpen) updateNotificationPanel();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.textContent = notificationCount > 0 ? notificationCount : '';
                badge.style.display = notificationCount > 0 ? 'flex' : 'none';
            }
            document.getElementById('navNotificationBadge').textContent = notificationCount || '';
        }

        function updateNotificationPanel() {
            const container = document.getElementById('notificationList');
            if (notifications.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">Bildirim yok</div>';
                return;
            }
            let html = '';
            notifications.slice(0, 20).forEach(notif => {
                html += `<div class="notification-item" onclick="handleNotificationClick('${notif.id}')">
                    <strong>${notif.sender}</strong> <small>${notif.time}</small><br>
                    <span>${notif.message}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        function handleNotificationClick(id) {
            const notif = notifications.find(n => n.id == id);
            if (notif) notif.read = true;
            updateNotificationPanel();
        }

        function clearAllNotifications() {
            notifications = [];
            notificationCount = 0;
            updateNotificationBadge();
            updateNotificationPanel();
        }

        function playNotificationSound() {
            try {
                const sound = document.getElementById('notificationSound');
                sound.currentTime = 0;
                sound.play().catch(e => {});
            } catch (error) {}
        }

        // ========== TEMA Sƒ∞STEMƒ∞ ==========
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('night-mode')) {
                body.classList.remove('night-mode');
                body.classList.add('light-mode');
            } else if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                body.classList.add('youtube-live-mode');
            } else {
                body.classList.add('night-mode');
            }
        }

        // ========== FIREBASE SENKRONƒ∞ZASYON ==========
        function saveMessageToFirebase(channel, message) {
            if (database && messagesRef) {
                messagesRef.push({ ...message, channel: channel });
            }
        }

        function saveUserToFirebase(user) {
            if (database && usersRef) {
                usersRef.child(user.name).set({
                    name: user.name,
                    role: user.role,
                    lastSeen: Date.now(),
                    isOnline: true
                });
            }
        }

        async function loadCustomCommands() {
            if (!customCommandsRef) return;
            const snapshot = await customCommandsRef.once('value');
            customCommands = snapshot.val() || {};
        }

        // ========== KANAL ƒ∞≈ûLEMLERƒ∞ ==========
        function joinChannel(ch) {
            if (!channels[ch]) return;

            if (currentChannel && channels[currentChannel]) {
                channels[currentChannel].onlineUsers = channels[currentChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
            }

            currentChannel = ch;
            let c = channels[ch];
            if (!c.onlineUsers.includes(ACTIVE_USER.name)) c.onlineUsers.push(ACTIVE_USER.name);
            saveChannels();

            document.getElementById('currentChannelName').textContent = ch;
            document.getElementById('channelUserCount').textContent = c.onlineUsers.length;

            loadChannelMessages(ch);
            updateMediaDisplay();
            updateAllBadges();
            addSystemMessage(`üì¢ #${ch} kanalƒ±na katƒ±ldƒ±n!`);
            closeLeftPanel();
        }

        // ========== ONLINE KULLANICILAR ==========
        function showOnlineUsers() {
            let users = channels[currentChannel]?.onlineUsers || [];
            let list = 'üë• <strong>√áevrimi√ßi:</strong> ';
            list += users.join(', ');
            addSystemMessage(list);
        }

        // ========== PANEL KONTROLLERƒ∞ ==========
        function openLeftPanel() {
            document.getElementById('leftPanel').classList.add('active');
            loadLeftPanelContent('subscriptions');
        }
        function closeLeftPanel() { document.getElementById('leftPanel').classList.remove('active'); }
        function openRightPanel() {
            document.getElementById('rightPanel').classList.add('active');
            loadOnlineUsers();
        }
        function closeRightPanel() { document.getElementById('rightPanel').classList.remove('active'); }

        function switchLeftTab(tab) {
            document.querySelectorAll('#leftPanel .panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#leftPanel .panel-tab')[tab === 'subscriptions' ? 0 : tab === 'channels' ? 1 : 2].classList.add('active');
            document.getElementById('leftPanelTitle').textContent = 
                tab === 'subscriptions' ? 'Abonelikler' : tab === 'channels' ? 'Ke≈üfet' : 'Sohbetler';
            loadLeftPanelContent(tab);
        }

        function loadLeftPanelContent(tab) {
            let html = '';
            
            if (tab === 'subscriptions') {
                ACTIVE_USER.subscribedChannels.forEach(ch => {
                    let c = channels[ch] || { owner: 'Bilinmiyor', subscribers: 0, onlineUsers: [] };
                    html += `<div class="channel-item" onclick="joinChannel('${ch}')">
                        <div class="item-avatar"><i class="fas fa-hashtag"></i></div>
                        <div class="item-info">
                            <div class="item-name">${ch}</div>
                            <div class="item-meta">${c.owner} ‚Ä¢ ${c.onlineUsers?.length || 0} online</div>
                        </div>
                    </div>`;
                });
            } else if (tab === 'channels') {
                Object.values(channels).forEach(c => {
                    html += `<div class="channel-item" onclick="joinChannel('${c.name}')">
                        <div class="item-avatar"><i class="fas fa-hashtag"></i></div>
                        <div class="item-info">
                            <div class="item-name">${c.name}</div>
                            <div class="item-meta">${c.owner} ‚Ä¢ ${c.onlineUsers?.length || 0} online</div>
                        </div>
                    </div>`;
                });
            } else if (tab === 'chats') {
                let chats = [];
                for (let chatId in PRIVATE_CHATS) {
                    if (!PRIVATE_CHATS[chatId]) continue;
                    let ids = chatId.split('_');
                    let otherId = ids[0] == ACTIVE_USER.id ? ids[1] : ids[0];
                    let otherUser = USERS_DB.find(u => u.id == otherId) || { name: 'Kullanƒ±cƒ±' };
                    let lastMsg = PRIVATE_CHATS[chatId].slice(-1)[0];
                    chats.push({ name: otherUser.name, lastMsg: lastMsg ? (lastMsg.type === 'text' ? lastMsg.content : 'üìé medya') : '...' });
                }
                chats.forEach(chat => {
                    html += `<div class="channel-item" onclick="openPrivateChat('${chat.name}'); closeLeftPanel();">
                        <div class="item-avatar"><span>${chat.name.charAt(0)}</span></div>
                        <div class="item-info">
                            <div class="item-name">${chat.name}</div>
                            <div class="item-meta">${escapeHTML(chat.lastMsg)}</div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('leftPanelContent').innerHTML = html || 'Liste bo≈ü.';
        }

        function loadOnlineUsers() {
            let users = channels[currentChannel]?.onlineUsers || [];
            let html = '';
            users.forEach(u => {
                if (u !== ACTIVE_USER.name) {
                    html += `<div class="user-item" onclick="openPrivateChat('${u}'); closeRightPanel();">
                        <div class="item-avatar"><span>${u.charAt(0)}</span></div>
                        <div class="item-info">
                            <div class="item-name">${u} <span class="online-status"></span></div>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('rightPanelContent').innerHTML = html || 'Kimse yok.';
        }

        function openCreateChannel() {
            document.getElementById('leftPanelTitle').textContent = 'Kanal A√ß';
            let html = `
                <div class="panel-content">
                    <input type="text" id="newChannelName" class="message-input" placeholder="Kanal adƒ±" style="width:100%; margin-bottom:12px;">
                    <button class="subscribe-small" onclick="createChannel()" style="width:100%; background:var(--primary); padding:14px;">Olu≈ütur</button>
                </div>`;
            document.getElementById('leftPanelContent').innerHTML = html;
            document.getElementById('leftPanel').classList.add('active');
        }

        function createChannel() {
            let name = document.getElementById('newChannelName')?.value?.toLowerCase().trim();
            if (!name || !/^[a-z0-9-]+$/.test(name)) { alert('Ge√ßersiz kanal adƒ±!'); return; }
            if (channels[name]) { alert('Kanal zaten var!'); return; }

            channels[name] = {
                name, owner: ACTIVE_USER.name, ownerRole: 'coadmin', coAdmins: [ACTIVE_USER.name],
                subscribers: 1, online: 1, description: '',
                isHidden: false,
                youtube: { 
                    currentVideo: 'jfKfPfyJRdk', currentTitle: 'CETCETY Radio', currentArtist: ACTIVE_USER.name,
                    playlist: [{ id: 'jfKfPfyJRdk', title: 'CETCETY Radio', addedBy: ACTIVE_USER.name, role: 'coadmin' }]
                },
                onlineUsers: [ACTIVE_USER.name]
            };
            saveChannels();
            
            ACTIVE_USER.myChannel = name;
            if (!ACTIVE_USER.subscribedChannels.includes(name)) ACTIVE_USER.subscribedChannels.push(name);
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
            
            addSystemMessage(`‚úÖ #${name} kanalƒ± olu≈üturuldu!`);
            joinChannel(name);
            closeLeftPanel();
        }

        function openNotifications() {
            document.getElementById('leftPanelTitle').textContent = 'Bildirimler';
            document.getElementById('leftPanelContent').innerHTML = '<div style="text-align:center; color:#aaa; padding:20px;">Bildirim paneli</div>';
            document.getElementById('leftPanel').classList.add('active');
        }

        function openProfilePanel() {
            document.getElementById('leftPanelTitle').textContent = 'Profil';
            let html = `
                <div style="text-align:center; padding:20px;">
                    <div class="item-avatar" style="width:80px; height:80px; margin:0 auto 12px; font-size:40px;">${ACTIVE_USER.name.charAt(0)}</div>
                    <h3>${ACTIVE_USER.name}</h3>
                    <div style="margin:8px 0;"><span class="subscribe-small">${ACTIVE_USER.role}</span></div>
                    <button class="subscribe-small" onclick="logout()" style="width:100%; background:var(--primary); padding:14px; margin-top:20px;">√áƒ±kƒ±≈ü Yap</button>
                </div>`;
            document.getElementById('leftPanelContent').innerHTML = html;
            document.getElementById('leftPanel').classList.add('active');
        }

        function updateUIForUser() {
            let avatarSpan = document.getElementById('navAvatarText');
            if (ACTIVE_USER) avatarSpan.textContent = ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase();
        }

        function updateAllBadges() {
            document.getElementById('channelCountBadge').textContent = Object.keys(channels).length;
            document.getElementById('onlineCountBadge').textContent = channels[currentChannel]?.onlineUsers?.length || 1;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function logout() {
            if (ACTIVE_USER && channels[currentChannel]) {
                channels[currentChannel].onlineUsers = channels[currentChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
                saveChannels();
                
                if (database && usersRef) {
                    usersRef.child(ACTIVE_USER.name).remove();
                }
            }
            localStorage.removeItem('cetcety_active_user');
            location.reload();
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            ACTIVE_USER = JSON.parse(localStorage.getItem('cetcety_active_user'));
            
            if (ACTIVE_USER) {
                if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                    channels.genel.onlineUsers.push(ACTIVE_USER.name);
                    saveChannels();
                }
                
                if (ACTIVE_USER.role === 'owner') isOwner = true;
                else if (ACTIVE_USER.role === 'admin') isAdmin = true;
                else if (ACTIVE_USER.role === 'coadmin') isCoAdmin = true;
                else if (ACTIVE_USER.role === 'operator') isOperator = true;
                
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').style.display = 'flex';
                updateUIForUser();
                updateAllBadges();
                loadChannelMessages('genel');
                updateMediaDisplay();
                addSystemMessage(`üëã Ho≈ü geldin, ${ACTIVE_USER.name}!`);
                
                if (typeof YT === 'undefined') {
                    let tag = document.createElement('script');
                    tag.src = 'https://www.youtube.com/iframe_api';
                    document.head.appendChild(tag);
                }
            }

            // Enter ile mesaj g√∂nderme
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (document.activeElement && document.activeElement.id === 'messageInput') {
                        e.preventDefault(); sendMessage();
                    } else if (document.activeElement && document.activeElement.id === 'privateMessageInput') {
                        e.preventDefault(); sendPrivateMessage();
                    }
                }
            });

            // Story resim y√ºkleme
            document.getElementById('storyImageUpload').addEventListener('change', handleStoryImageUpload);
        });
    </script>
</body>
</html>
