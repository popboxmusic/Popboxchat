<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popbox Music Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #0f0f0f;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f0f;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: #272727;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #ff0000;
        }
        
        .login-title {
            text-align: center;
            color: #ff0000;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0f0f0f;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }
        
        .login-button {
            width: 100%;
            padding: 12px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .login-button:hover {
            background: #cc0000;
        }
        
        .error-message {
            color: #ff5555;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .main-container {
            display: none;
            height: 100vh;
            padding-top: 60px;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #272727;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #444;
            z-index: 100;
        }
        
        .logo {
            color: #ff0000;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0f0f0f;
        }
        
        .users-sidebar {
            width: 250px;
            background: #272727;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #272727;
            display: flex;
            padding: 10px;
            border-top: 1px solid #444;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
        
        .send-button {
            width: 50px;
            margin-left: 10px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            background: #272727;
            border-radius: 8px;
            border-left: 3px solid #444;
        }
        
        .message.system {
            border-left-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .message.owner {
            border-left-color: #ff4081;
            background: rgba(255, 64, 129, 0.1);
        }
        
        .message.admin {
            border-left-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-sender {
            color: #ff5555;
            font-weight: bold;
        }
        
        .message-time {
            color: #888;
            font-size: 12px;
        }
        
        .user-item {
            padding: 10px;
            margin: 5px 0;
            background: #0f0f0f;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            background: #ff0000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .badge.owner {
            background: #ff4081;
            color: white;
        }
        
        .badge.admin {
            background: #ff0000;
            color: white;
        }
        
        .badge.online {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- GiriÅŸ EkranÄ± -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">ğŸµ Popbox Music Chat</div>
            <input type="text" id="login-nick" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±" autocomplete="off">
            <input type="password" id="login-password" class="login-input" placeholder="Åifre (Sadece kayÄ±tlÄ±lar)" style="display: none;">
            <button class="login-button" onclick="login()">GiriÅŸ Yap</button>
            <div class="error-message" id="login-error"></div>
            <div style="text-align: center; margin-top: 15px; color: #888; font-size: 14px;">
                ğŸ”¥ Firebase Realtime Chat<br>
                ğŸ‘‘ TÃ¼m yÃ¶netici yetkileri<br>
                ğŸ“± Modern arayÃ¼z
            </div>
        </div>
    </div>

    <!-- Ana Uygulama -->
    <div class="main-container" id="main-app">
        <!-- Header -->
        <div class="header">
            <div class="logo">ğŸµ Popbox Live</div>
            <div class="user-info">
                <span id="current-user">Misafir</span>
                <div class="badge" id="user-role-badge"></div>
                <button onclick="logout()" style="background: #444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                    Ã‡Ä±kÄ±ÅŸ
                </button>
            </div>
        </div>

        <!-- Chat AlanÄ± -->
        <div class="chat-container">
            <!-- Mesajlar -->
            <div class="messages-area" id="messages">
                <div class="message system">
                    ğŸ‰ Popbox Music Chat'e hoÅŸ geldiniz! CanlÄ± sohbete katÄ±lÄ±n.
                </div>
            </div>

            <!-- Online KullanÄ±cÄ±lar -->
            <div class="users-sidebar">
                <div style="color: #ff0000; font-weight: bold; margin-bottom: 15px;">ğŸ‘¥ Online KullanÄ±cÄ±lar</div>
                <div id="userList"></div>
            </div>
        </div>

        <!-- Mesaj Input -->
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." autocomplete="off">
            <button class="send-button" onclick="sendMessage()">â†—</button>
        </div>
    </div>

    <script>
        // Firebase konfigÃ¼rasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat"
        };

        // Global deÄŸiÅŸkenler
        let currentUser = null;
        let usersRef = null;
        let messagesRef = null;
        let database = null;

        // Uygulama baÅŸlatma
        window.addEventListener('load', function() {
            console.log("Uygulama yÃ¼klendi");
            
            // Firebase SDK kontrolÃ¼
            if (typeof firebase === 'undefined') {
                console.error("Firebase SDK yÃ¼klenemedi!");
                showError("Firebase SDK yÃ¼klenemedi. LÃ¼tferen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                return;
            }
            
            try {
                // Firebase'i baÅŸlat
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase baÅŸlatÄ±ldÄ±");
                
                // Database referanslarÄ±nÄ± oluÅŸtur
                database = firebase.database();
                usersRef = database.ref('users');
                messagesRef = database.ref('messages');
                
                // BaÄŸlantÄ± kontrolÃ¼
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("Firebase'e baÄŸlandÄ±!");
                    } else {
                        console.log("Firebase baÄŸlantÄ±sÄ± kesildi");
                    }
                });
                
            } catch (error) {
                console.error("Firebase baÅŸlatma hatasÄ±:", error);
                showError("Firebase baÄŸlantÄ±sÄ± kurulamadÄ±: " + error.message);
            }
            
            // Enter tuÅŸu ile giriÅŸ
            document.getElementById('login-nick').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Enter tuÅŸu ile mesaj gÃ¶nderme
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        });

        // GiriÅŸ fonksiyonu
        async function login() {
            const nickInput = document.getElementById('login-nick');
            const passwordInput = document.getElementById('login-password');
            const nick = nickInput.value.trim();
            const password = passwordInput.value;
            
            // Basit validasyon
            if (!nick) {
                showError("LÃ¼tfen kullanÄ±cÄ± adÄ± girin!");
                return;
            }
            
            if (nick.length < 2 || nick.length > 20) {
                showError("KullanÄ±cÄ± adÄ± 2-20 karakter arasÄ±nda olmalÄ±!");
                return;
            }
            
            // Ã–zel owner kontrolÃ¼
            if (nick.toLowerCase() === 'mateky') {
                if (password !== 'Sahi17407@SCM') {
                    showError("Owner ÅŸifresi hatalÄ±!");
                    return;
                }
                currentUser = {
                    name: 'MateKy',
                    role: 'owner',
                    isOwner: true
                };
            } else {
                currentUser = {
                    name: nick,
                    role: 'user',
                    isOwner: false
                };
            }
            
            try {
                // KullanÄ±cÄ± adÄ±nÄ±n online olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                const userSnapshot = await usersRef.child(nick).once('value');
                if (userSnapshot.exists()) {
                    showError("Bu kullanÄ±cÄ± adÄ± ÅŸu anda kullanÄ±mda!");
                    return;
                }
                
                // KullanÄ±cÄ±yÄ± online listeye ekle
                await usersRef.child(nick).set({
                    name: nick,
                    role: currentUser.role,
                    joinedAt: Date.now(),
                    isOnline: true
                });
                
                // Disconnect handler
                usersRef.child(nick).onDisconnect().remove();
                
                // GiriÅŸ baÅŸarÄ±lÄ±
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('current-user').textContent = currentUser.name;
                
                // Role badge gÃ¶ster
                updateUserBadge();
                
                // Sistem mesajÄ± gÃ¶nder
                addSystemMessage(`ğŸ‰ HoÅŸ geldin, ${currentUser.name}!`);
                
                // KullanÄ±cÄ± listesini dinle
                startUserListListener();
                
                // MesajlarÄ± dinle
                startMessageListener();
                
                console.log("GiriÅŸ baÅŸarÄ±lÄ±:", currentUser);
                
            } catch (error) {
                console.error("GiriÅŸ hatasÄ±:", error);
                showError("GiriÅŸ yapÄ±lamadÄ±: " + error.message);
            }
        }

        // KullanÄ±cÄ± badge gÃ¼ncelleme
        function updateUserBadge() {
            const badge = document.getElementById('user-role-badge');
            if (!currentUser) return;
            
            if (currentUser.role === 'owner') {
                badge.textContent = 'OWNER';
                badge.className = 'badge owner';
                badge.style.display = 'inline-block';
            } else if (currentUser.role === 'admin') {
                badge.textContent = 'ADMIN';
                badge.className = 'badge admin';
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // KullanÄ±cÄ± listesi listener
        function startUserListListener() {
            if (!usersRef) return;
            
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                updateUserList(users);
            });
        }

        // KullanÄ±cÄ± listesini gÃ¼ncelle
        function updateUserList(users) {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = '';
            
            Object.entries(users).forEach(([username, userData]) => {
                if (!userData) return;
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = username.charAt(0).toUpperCase();
                
                const name = document.createElement('span');
                name.textContent = username;
                name.style.color = userData.role === 'owner' ? '#ff4081' : 
                                  userData.role === 'admin' ? '#ff0000' : '#fff';
                
                const onlineDot = document.createElement('div');
                onlineDot.className = 'badge online';
                
                userItem.appendChild(avatar);
                userItem.appendChild(name);
                userItem.appendChild(onlineDot);
                userList.appendChild(userItem);
            });
        }

        // Mesaj listener
        function startMessageListener() {
            if (!messagesRef) return;
            
            // Ã–nceki mesajlarÄ± temizle
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<div class="message system">ğŸ’¬ Sohbet baÅŸlatÄ±ldÄ±...</div>';
            
            // Yeni mesajlarÄ± dinle
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                addMessageToChat(message);
            });
        }

        // Mesaj gÃ¶nderme
        async function sendMessage() {
            if (!currentUser) {
                showError("Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z!");
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Komut kontrolÃ¼
            if (text.startsWith('/')) {
                handleCommand(text);
                input.value = '';
                return;
            }
            
            try {
                const messageData = {
                    sender: currentUser.name,
                    text: text,
                    role: currentUser.role,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                };
                
                await messagesRef.push(messageData);
                input.value = '';
                input.focus();
                
            } catch (error) {
                console.error("Mesaj gÃ¶nderme hatasÄ±:", error);
                showError("Mesaj gÃ¶nderilemedi!");
            }
        }

        // MesajÄ± chat'e ekle
        function addMessageToChat(message) {
            if (!message || !message.sender) return;
            
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'message';
            if (message.role === 'owner') messageDiv.classList.add('owner');
            else if (message.role === 'admin') messageDiv.classList.add('admin');
            else if (message.sender === 'System') messageDiv.classList.add('system');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender" style="color: ${getUserColor(message.sender, message.role)}">
                        ${message.sender}
                        ${message.role === 'owner' ? ' ğŸ‘‘' : ''}
                        ${message.role === 'admin' ? ' â­' : ''}
                    </span>
                    <span class="message-time">${message.time || 'Åimdi'}</span>
                </div>
                <div>${escapeHtml(message.text)}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Sistem mesajÄ± ekle
        function addSystemMessage(text) {
            const messageData = {
                sender: 'System',
                text: text,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            };
            
            addMessageToChat(messageData);
        }

        // Komut iÅŸleme
        function handleCommand(command) {
            const parts = command.split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            switch(cmd) {
                case '/yardÄ±m':
                    showHelp();
                    break;
                case '/online':
                    showOnlineUsers();
                    break;
                case '/clear':
                    if (currentUser.isOwner || currentUser.role === 'admin') {
                        clearChat();
                    } else {
                        addSystemMessage("â›” Bu komutu kullanma yetkiniz yok!");
                    }
                    break;
                case '/kick':
                    if (currentUser.isOwner || currentUser.role === 'admin') {
                        kickUser(args[0]);
                    } else {
                        addSystemMessage("â›” Bu komutu kullanma yetkiniz yok!");
                    }
                    break;
                case '/ban':
                    if (currentUser.isOwner) {
                        banUser(args[0]);
                    } else {
                        addSystemMessage("â›” Bu komutu kullanma yetkiniz yok!");
                    }
                    break;
                default:
                    addSystemMessage("âŒ Bilinmeyen komut: " + cmd);
            }
        }

        // YardÄ±m komutu
        function showHelp() {
            const helpText = `
                ğŸ“‹ KULLANILABÄ°LÄ°R KOMUTLAR:
                
                /yardÄ±m - Bu yardÄ±m mesajÄ±nÄ± gÃ¶ster
                /online - Online kullanÄ±cÄ±larÄ± listele
                
                ğŸ‘‘ YÃ–NETÄ°CÄ° KOMUTLARI:
                /clear - Sohbeti temizle
                /kick [kullanÄ±cÄ±] - KullanÄ±cÄ±yÄ± at
                /ban [kullanÄ±cÄ±] - KullanÄ±cÄ±yÄ± banla
                
                ğŸ“± DÄ°ÄER:
                /me [mesaj] - Aksiyon mesajÄ± gÃ¶nder
                /msg [kullanÄ±cÄ±] [mesaj] - Ã–zel mesaj gÃ¶nder
            `;
            
            addSystemMessage(helpText);
        }

        // Online kullanÄ±cÄ±larÄ± gÃ¶ster
        function showOnlineUsers() {
            // Bu fonksiyon kullanÄ±cÄ± listesini zaten gÃ¶steriyor
            addSystemMessage("ğŸ‘¥ Online kullanÄ±cÄ±lar saÄŸ tarafta listeleniyor...");
        }

        // Sohbeti temizle
        function clearChat() {
            const container = document.getElementById('messages');
            container.innerHTML = '<div class="message system">ğŸ’¥ Sohbet temizlendi!</div>';
            addSystemMessage("ğŸ’¥ Sohbet " + currentUser.name + " tarafÄ±ndan temizlendi!");
        }

        // KullanÄ±cÄ±yÄ± at
        async function kickUser(username) {
            if (!username) {
                addSystemMessage("âŒ KullanÄ±cÄ± adÄ± gerekli!");
                return;
            }
            
            try {
                await usersRef.child(username).remove();
                addSystemMessage(`ğŸšª ${username} kullanÄ±cÄ±sÄ± atÄ±ldÄ±!`);
            } catch (error) {
                console.error("Kick hatasÄ±:", error);
                addSystemMessage("âŒ KullanÄ±cÄ± atÄ±lamadÄ±!");
            }
        }

        // KullanÄ±cÄ±yÄ± banla
        async function banUser(username) {
            if (!username) {
                addSystemMessage("âŒ KullanÄ±cÄ± adÄ± gerekli!");
                return;
            }
            
            if (!confirm(`${username} kullanÄ±cÄ±sÄ±nÄ± banlamak istediÄŸinize emin misiniz?`)) {
                return;
            }
            
            try {
                // Ã–nce at
                await usersRef.child(username).remove();
                
                // Ban listesine ekle (basit versiyon)
                const banRef = database.ref('bans');
                await banRef.child(username).set({
                    bannedBy: currentUser.name,
                    bannedAt: Date.now(),
                    reason: 'Owner tarafÄ±ndan banlandÄ±'
                });
                
                addSystemMessage(`ğŸš« ${username} kullanÄ±cÄ±sÄ± banlandÄ±!`);
                
            } catch (error) {
                console.error("Ban hatasÄ±:", error);
                addSystemMessage("âŒ KullanÄ±cÄ± banlanamadÄ±!");
            }
        }

        // Ã‡Ä±kÄ±ÅŸ yap
        async function logout() {
            if (currentUser && usersRef) {
                await usersRef.child(currentUser.name).remove();
            }
            
            // Firebase listener'larÄ±nÄ± temizle
            if (messagesRef) {
                messagesRef.off();
            }
            if (usersRef) {
                usersRef.off();
            }
            
            // SayfayÄ± yenile
            location.reload();
        }

        // YardÄ±mcÄ± fonksiyonlar
        function showError(message) {
            const errorElement = document.getElementById('login-error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function getUserColor(username, role) {
            if (role === 'owner') return '#ff4081';
            if (role === 'admin') return '#ff0000';
            if (username === 'System') return '#ff5555';
            return '#4caf50';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Owner test giriÅŸi (debug iÃ§in)
        window.testOwnerLogin = function() {
            document.getElementById('login-nick').value = 'MateKy';
            document.getElementById('login-password').style.display = 'block';
            document.getElementById('login-password').value = 'Sahi17407@SCM';
            setTimeout(() => login(), 100);
        };

        console.log("âœ… Uygulama hazÄ±r! Test iÃ§in: testOwnerLogin()");
    </script>
</body>
</html>
