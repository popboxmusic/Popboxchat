<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY ‚Ä¢ Tam Yetki Panelleri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- IRC Komut Sistemi -->
    <script type="module" src="irc-commands.js"></script>
    <style>
        /* T√ºm stiller aynen korundu */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0f0f0f; color: #fff; overflow: hidden; height: 100vh; transition: 0.2s; }
        body.light-theme { background: #f5f5f5; color: #1a1a1a; }
        .app { display: flex; height: 100vh; width: 100vw; position: relative; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        body.light-theme ::-webkit-scrollbar-track { background: #ddd; }
        ::-webkit-scrollbar-thumb { background: #3f3f3f; border-radius: 3px; }
        body.light-theme ::-webkit-scrollbar-thumb { background: #aaa; }

        /* Giri≈ü Ekranƒ± */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.3s;
        }
        .login-overlay.hidden { display: none; }
        .login-panel {
            width: 360px; background: rgba(20,20,20,0.6); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 32px; backdrop-filter: blur(10px); color: #fff;
        }
        body.light-theme .login-panel { background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); color: #333; }
        .login-panel h2 { text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: 600; }
        .form-group { margin-bottom: 20px; position: relative; }
        .login-panel label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; }
        body.light-theme .login-panel label { color: #666; }
        .login-panel input {
            width: 100%; padding: 12px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: #fff; font-size: 14px; outline: none; padding-right: 40px;
        }
        body.light-theme .login-panel input { background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); color: #333; }
        .login-panel input:focus { border-color: #ff0000; }
        .login-panel .password-toggle {
            position: absolute; right: 12px; top: 38px; cursor: pointer; color: #aaa; font-size: 18px;
        }
        .login-panel button {
            width: 100%; padding: 14px; background: #ff0000; border: none; border-radius: 8px;
            color: #fff; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.2s; margin-top: 8px;
        }
        .login-panel button:hover { background: #cc0000; }
        .login-info { text-align: center; margin-top: 16px; font-size: 12px; color: #aaa; }

        /* Sol ƒ∞kon Paneli */
        .icon-panel {
            width: 72px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; align-items: center; padding: 24px 0; gap: 24px;
            flex-shrink: 0; z-index: 20; transition: 0.2s;
        }
        body.light-theme .icon-panel { background: #fff; border-right: 1px solid #ddd; }
        .icon-item {
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer; transition: 0.2s; font-size: 20px; position: relative;
        }
        .icon-item:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .icon-item:hover { background: #e0e0e0; color: #333; }
        .icon-item.active { color: #fff; background: #ff0000; }
        .icon-badge {
            position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; border-radius: 50%;
            background: #ff4444; color: white; font-size: 10px; display: flex; align-items: center;
            justify-content: center; border: 2px solid #0a0a0a;
        }
        body.light-theme .icon-badge { border: 2px solid #fff; }
        .profile-avatar {
            margin-top: auto; width: 48px; height: 48px; border-radius: 50%;
            background: #1a1a1a; border: 2px solid #3f3f3f; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; color: #fff; position: relative;
        }
        body.light-theme .profile-avatar { background: #ddd; border: 2px solid #aaa; color: #333; }

        /* Ana ƒ∞√ßerik */
        .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* Sol Panel */
        .left-panel {
            width: 320px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 15;
        }
        body.light-theme .left-panel { background: #fff; border-right: 1px solid #ddd; }
        .panel-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        body.light-theme .panel-header { border-bottom: 1px solid #ddd; }
        .panel-header h3 {
            display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #fff;
        }
        body.light-theme .panel-header h3 { color: #333; }
        .panel-close {
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .panel-close:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .panel-close:hover { background: #ddd; color: #333; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* Sekmeler */
        .panel-tabs {
            display: flex; border-bottom: 1px solid #2a2a2a; background: #0a0a0a;
        }
        body.light-theme .panel-tabs { background: #fff; border-bottom: 1px solid #ddd; }
        .panel-tab {
            flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600;
            color: #aaa; cursor: pointer; transition: 0.2s;
        }
        .panel-tab:hover { background: #1a1a1a; color: #fff; }
        .panel-tab.active { color: #fff; border-bottom: 2px solid #ff0000; }
        body.light-theme .panel-tab.active { color: #333; }

        /* Arama */
        .search-container {
            display: flex; align-items: center; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 30px;
            padding: 0 16px; margin-bottom: 20px;
        }
        body.light-theme .search-container { background: #f0f0f0; border: 1px solid #ccc; }
        .search-container i { color: #aaa; font-size: 14px; }
        body.light-theme .search-container i { color: #666; }
        .search-input {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 15px;
            padding: 14px 8px; outline: none;
        }
        body.light-theme .search-input { color: #333; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: #aaa; margin-bottom: 6px; }
        body.light-theme .form-label { color: #666; }
        .form-input, .form-select {
            width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px;
            color: #fff; font-size: 14px; outline: none;
        }
        body.light-theme .form-input, body.light-theme .form-select { background: #f0f0f0; border: 1px solid #ccc; color: #333; }
        .form-input:focus { border-color: #ff0000; }
        .form-button {
            width: 100%; padding: 12px; background: #ff0000; border: none; border-radius: 8px;
            color: #fff; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .form-button:hover { background: #cc0000; }
        .form-button.secondary { background: #2a2a2a; color: #fff; }
        body.light-theme .form-button.secondary { background: #ddd; color: #333; }
        .form-button.secondary:hover { background: #3f3f3f; }
        .form-button.danger { background: #6d0000; }
        .form-button.danger:hover { background: #8a0000; }
        .info-box {
            background: #1a1a1a; border-left: 4px solid #ff0000; padding: 16px; border-radius: 8px; margin-bottom: 16px;
        }
        body.light-theme .info-box { background: #f9f9f9; }
        .info-box p { color: #aaa; font-size: 13px; line-height: 1.5; }
        body.light-theme .info-box p { color: #666; }

        /* Liste √ñƒüeleri */
        .subscription-item, .channel-item, .chat-item, .online-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px;
            cursor: pointer; margin-bottom: 4px; transition: 0.2s;
        }
        .subscription-item:hover, .channel-item:hover, .chat-item:hover, .online-item:hover { background: #1a1a1a; }
        body.light-theme .subscription-item:hover, body.light-theme .channel-item:hover,
        body.light-theme .chat-item:hover, body.light-theme .online-item:hover { background: #f0f0f0; }
        .subscription-item.active { background: #1a1a1a; border-left: 4px solid #ff0000; }
        .subscription-avatar, .channel-avatar, .chat-avatar, .online-avatar, .profile-avatar-panel {
            width: 36px; height: 36px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000; font-size: 16px; flex-shrink: 0;
        }
        body.light-theme .subscription-avatar, body.light-theme .channel-avatar,
        body.light-theme .chat-avatar, body.light-theme .online-avatar,
        body.light-theme .profile-avatar-panel { background: #ddd; color: #ff0000; }
        .online-avatar { background: #0a5c36; color: #fff; }
        .profile-avatar-panel { background: #ff0000; color: #fff; }
        .subscription-info, .channel-info, .chat-info, .online-info { flex: 1; min-width: 0; }
        .subscription-name, .channel-name, .chat-name, .online-name {
            font-weight: 600; font-size: 14px; color: #fff; display: flex; align-items: center; gap: 6px;
        }
        body.light-theme .subscription-name, body.light-theme .channel-name,
        body.light-theme .chat-name, body.light-theme .online-name { color: #333; }
        .online-status { width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; margin-left: 4px; }
        .subscription-meta, .channel-meta, .chat-meta, .online-meta {
            font-size: 11px; color: #aaa; margin-top: 2px; display: flex; align-items: center; gap: 8px;
        }
        body.light-theme .subscription-meta, body.light-theme .channel-meta,
        body.light-theme .chat-meta, body.light-theme .online-meta { color: #666; }
        .subscription-stats { font-size: 11px; color: #aaa; text-align: right; }
        
        /* Yetki Badge'leri */
        .badge {
            display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px;
            border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 6px;
            background: transparent;
            border: 1px solid;
        }
        .badge-owner { color: #ffd700; border-color: rgba(255,215,0,0.5); }
        .badge-admin { color: #ff6b6b; border-color: rgba(255,107,107,0.5); }
        .badge-coadmin { color: #6495ed; border-color: rgba(100,149,237,0.5); }
        .badge-operator { color: #ffa500; border-color: rgba(255,165,0,0.5); }
        .badge-hidden { color: #aaa; border-color: rgba(170,170,170,0.5); }

        /* Pop√ºler */
        .popular-channels { margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a2a2a; }
        body.light-theme .popular-channels { border-top: 1px solid #ddd; }
        .popular-header { display: flex; align-items: center; gap: 8px; color: #ffd700; font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .popular-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 2px; }
        .popular-item:hover { background: #1a1a1a; }
        body.light-theme .popular-item:hover { background: #f0f0f0; }
        .popular-info { flex: 1; }
        .popular-name { font-weight: 500; font-size: 13px; color: #fff; display: flex; align-items: center; gap: 6px; }
        body.light-theme .popular-name { color: #333; }
        .popular-subscribers { font-size: 10px; color: #aaa; }
        .subscribe-btn {
            padding: 6px 12px; background: #ff0000; border: none; border-radius: 20px;
            color: #fff; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .subscribe-btn.subscribed { background: #272727; color: #ffd700; }
        body.light-theme .subscribe-btn.subscribed { background: #ddd; color: #666; }

        /* Chat Paneli */
        .chat-container {
            flex: 1; display: flex; flex-direction: column; min-width: 0; background: #0f0f0f;
            position: relative;
        }
        body.light-theme .chat-container { background: #f9f9f9; }
        .chat-header {
            padding: 16px 24px; border-bottom: 1px solid #2a2a2a; display: flex;
            align-items: center; justify-content: space-between;
        }
        body.light-theme .chat-header { border-bottom: 1px solid #ddd; }
        .chat-title { display: flex; align-items: center; gap: 12px; font-weight: 600; color: #fff; }
        body.light-theme .chat-title { color: #333; }
        .chat-title i { color: #ff0000; }
        .channel-info-bar { display: flex; align-items: center; gap: 16px; color: #aaa; font-size: 13px; }
        body.light-theme .channel-info-bar { color: #666; }
        .channel-subscribe-btn {
            padding: 6px 16px; background: #272727; border: 1px solid #3f3f3f; border-radius: 20px;
            color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        body.light-theme .channel-subscribe-btn { background: #ddd; border: 1px solid #ccc; color: #333; }
        .channel-subscribe-btn.subscribed { background: #ff0000; border-color: #ff0000; color: #fff; }
        .messages {
            flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }
        .message {
            display: flex; flex-direction: column; max-width: 70%; animation: fadeIn 0.2s;
        }
        .message.right { align-self: flex-end; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .message-sender { font-weight: 600; font-size: 13px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        body.light-theme .message-sender { color: #333; }
        .message-time { font-size: 11px; color: #aaa; }
        .message-text {
            font-size: 14px; line-height: 1.5; color: #fff; word-break: break-word;
            background: transparent;
            padding: 0;
        }
        body.light-theme .message-text { color: #333; }
        .message.right .message-text { color: #ff0000; }
        .system-message {
            align-self: center; color: #aaa; font-size: 12px; padding: 8px 16px;
            background: #1a1a1a; border-radius: 20px; margin: 8px 0; border: 1px solid #2a2a2a;
        }
        body.light-theme .system-message { background: #e0e0e0; color: #666; border: 1px solid #ccc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-input-container {
            padding: 20px 24px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        body.light-theme .message-input-container { background: #fff; border-top: 1px solid #ddd; }
        .input-wrapper {
            display: flex; align-items: center; gap: 12px; background: #1a1a1a;
            border: 1px solid #2a2a2a; border-radius: 28px; padding: 4px 4px 4px 20px;
        }
        body.light-theme .input-wrapper { background: #f0f0f0; border: 1px solid #ccc; }
        .message-input {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 14px;
            padding: 12px 0; resize: none; max-height: 80px; outline: none;
        }
        body.light-theme .message-input { color: #333; }
        .send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #2a2a2a; border: 1px solid #3f3f3f;
            color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .send-btn:hover { background: #ff0000; border-color: #ff0000; }

        /* √ñzel Sohbet Paneli */
        .private-chat-panel {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; background: #0a0a0a; display: none;
            flex-direction: column; z-index: 30;
        }
        body.light-theme .private-chat-panel { background: #fff; }
        .private-chat-panel.active { display: flex; }
        .private-chat-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .private-chat-user { display: flex; align-items: center; gap: 12px; }
        .private-chat-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000;
        }
        .private-chat-info h4 { font-size: 14px; font-weight: 600; color: #fff; }
        .private-chat-info span { font-size: 11px; color: #aaa; }
        .private-chat-actions { display: flex; gap: 12px; }
        .private-chat-action {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .private-chat-action:hover { background: #1a1a1a; color: #fff; }
        body.light-theme .private-chat-action:hover { background: #ddd; color: #333; }
        .private-tabs {
            display: flex; border-bottom: 1px solid #2a2a2a;
        }
        .private-tab {
            flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600;
            color: #aaa; cursor: pointer; transition: 0.2s;
        }
        .private-tab:hover { background: #1a1a1a; color: #fff; }
        .private-tab.active { color: #fff; border-bottom: 2px solid #ff0000; }
        body.light-theme .private-tab.active { color: #333; }
        .private-chat-messages {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;
        }
        .private-message {
            display: flex; flex-direction: column; max-width: 80%;
        }
        .private-message.right { align-self: flex-end; }
        .private-message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .private-message-sender { font-weight: 600; font-size: 12px; color: #fff; }
        .private-message-time { font-size: 10px; color: #aaa; }
        .private-message-text {
            font-size: 13px; line-height: 1.4; color: #fff; word-break: break-word;
            background: transparent;
            padding: 0;
        }
        .private-message.right .private-message-text { color: #ff0000; }
        .private-message-media { margin-top: 8px; border-radius: 12px; overflow: hidden; }
        .private-message-media img, .private-message-media video {
            width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px; cursor: pointer;
        }
        .delete-msg {
            position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%;
            background: #ff4444; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 5;
        }
        .private-message:hover .delete-msg { opacity: 1; }
        .private-input-container {
            padding: 20px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        body.light-theme .private-input-container { background: #fff; border-top: 1px solid #ddd; }
        .private-input-wrapper { display: flex; flex-direction: column; gap: 12px; }
        .private-media-actions { display: flex; gap: 12px; padding: 0 4px; }
        .private-media-btn {
            width: 36px; height: 36px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #aaa; cursor: pointer;
        }
        .private-media-btn:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .private-media-btn { background: #ddd; color: #666; }
        body.light-theme .private-media-btn:hover { background: #ccc; color: #333; }
        .private-text-input { display: flex; gap: 12px; }
        .private-input {
            flex: 1; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 24px;
            padding: 12px 16px; color: #fff; font-size: 13px; resize: none; outline: none;
        }
        body.light-theme .private-input { background: #f0f0f0; border: 1px solid #ccc; color: #333; }
        .private-send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #2a2a2a; border: 1px solid #3f3f3f;
            color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .private-send-btn:hover { background: #ff0000; border-color: #ff0000; }

        /* Medya Paneli */
        .media-panel {
            width: 420px; background: #0a0a0a; border-left: 1px solid #2a2a2a;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        body.light-theme .media-panel { background: #fff; border-left: 1px solid #ddd; }
        .media-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a; display: flex;
            align-items: center; justify-content: space-between;
        }
        body.light-theme .media-header { border-bottom: 1px solid #ddd; }
        .media-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; color: #fff; }
        body.light-theme .media-title { color: #333; }
        .media-controls { display: flex; gap: 8px; }
        .media-control {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .media-control:hover { background: #1a1a1a; color: #fff; }
        body.light-theme .media-control:hover { background: #ddd; color: #333; }
        .media-control.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .youtube-player { width: 100%; aspect-ratio: 16/9; background: #000; border-bottom: 1px solid #2a2a2a; position: relative; }
        #youtubeContainer { width: 100%; height: 100%; }
        .player-controls {
            position: absolute; bottom: 16px; left: 0; right: 0; display: flex;
            justify-content: center; gap: 20px; z-index: 10;
        }
        .player-btn {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.7);
            border: 2px solid #fff; color: #fff; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s; font-size: 18px;
        }
        .player-btn:hover { background: #ff0000; border-color: #ff0000; }
        .now-playing {
            padding: 12px 20px; background: #0f0f0f; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; gap: 12px; font-size: 13px; color: #fff;
        }
        body.light-theme .now-playing { background: #f5f5f5; border-bottom: 1px solid #ddd; color: #333; }
        .playlist-container { flex: 1; overflow-y: auto; padding: 20px; }
        .playlist-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #2a2a2a;
        }
        body.light-theme .playlist-header { border-bottom: 1px solid #ddd; }
        .playlist-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; color: #fff; }
        body.light-theme .playlist-title { color: #333; }
        .playlist-count { color: #aaa; font-size: 12px; }
        .playlist-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px;
            margin-bottom: 4px; cursor: pointer; transition: 0.2s;
        }
        .playlist-item:hover { background: #1a1a1a; }
        body.light-theme .playlist-item:hover { background: #f0f0f0; }
        .playlist-item.active { background: #1a1a1a; border-left: 4px solid #ff0000; }
        .playlist-thumb {
            width: 48px; height: 48px; border-radius: 6px; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000; font-size: 24px; flex-shrink: 0;
        }

        /* Yetki Panelleri ƒ∞√ßin Ortak Stil */
        .role-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .role-panel.active {
            display: flex;
        }
        .role-panel-content {
            background: #1a1a1a;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .role-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2a2a2a;
        }
        .role-panel-header h2 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .role-panel-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #272727;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .role-panel-close:hover {
            background: #3f3f3f;
        }
        .panel-section {
            background: #0f0f0f;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel-section h3 {
            color: #ffd700;
            margin-bottom: 16px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .user-list-item .user-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .user-list-item select, .user-list-item button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        .user-list-item button {
            background: #ff4444;
            color: white;
        }
        .user-list-item button:hover {
            background: #cc0000;
        }
        .command-chip {
            display: inline-block;
            background: #2a2a2a;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 0 4px 4px 0;
            font-size: 12px;
        }
        .command-chip i {
            margin-left: 6px;
            cursor: pointer;
            color: #ff4444;
        }
    </style>
</head>
<body>
    <!-- Giri≈ü Ekranƒ± -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-panel">
            <h2>üéß CETCETY</h2>
            <div class="form-group">
                <label>Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="loginNick" placeholder="√∂rn: mateky" autocomplete="off">
            </div>
            <div class="form-group">
                <label>≈ûifre</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <i class="fas fa-eye password-toggle" id="togglePassword" onclick="togglePasswordVisibility()"></i>
            </div>
            <button onclick="handleLogin()">Giri≈ü Yap / Kayƒ±t Ol</button>
            <div class="login-info">Yeni kullanƒ±cƒ±lar sadece nick yazarak girebilir.</div>
        </div>
    </div>

    <!-- Ana Uygulama -->
    <div id="app" class="app" style="display: none;">
        <!-- Sol ƒ∞kon Paneli -->
        <div class="icon-panel">
            <div class="icon-item" onclick="showHome()" title="Ana Sayfa"><i class="fas fa-home"></i></div>
            <div class="icon-item" onclick="openSubscriptions()" title="Abonelikler"><i class="fas fa-bell"></i><span class="icon-badge" id="subscriptionBadge">0</span></div>
            <div class="icon-item" onclick="openChannelPanel()" title="Kanallar"><i class="fas fa-list-ul"></i><span class="icon-badge" id="channelCountBadge">0</span></div>
            <div class="icon-item" onclick="openChatListPanel()" title="Sohbetlerim"><i class="fas fa-comment"></i><span class="icon-badge" id="chatListBadge">0</span></div>
            <div class="icon-item" onclick="openCreateChannelPanel()" title="Kanal A√ß"><i class="fas fa-plus-circle"></i></div>
            <div class="icon-item" onclick="openNotificationPanel()" title="Bildirimler"><i class="fas fa-bell"></i><span class="icon-badge" id="notificationBadge">0</span></div>
            <div class="icon-item" onclick="openSupportPanel()" title="Destek"><i class="fas fa-headset"></i></div>
            <!-- Yetki ƒ∞konlarƒ±: sadece ilgili rol g√∂recek -->
            <div id="ownerPanelIcon" class="icon-item" onclick="openOwnerPanel()" title="üëë Owner Paneli" style="display: none;">
                <i class="fas fa-crown" style="color: #ffd700;"></i>
            </div>
            <div id="adminPanelIcon" class="icon-item" onclick="openAdminPanel()" title="‚ö° Admin Paneli" style="display: none;">
                <i class="fas fa-bolt" style="color: #ff6b6b;"></i>
            </div>
            <div id="coadminPanelIcon" class="icon-item" onclick="openCoAdminPanel()" title="üîß Co-Admin Paneli" style="display: none;">
                <i class="fas fa-tools" style="color: #6495ed;"></i>
            </div>
            <div id="operatorPanelIcon" class="icon-item" onclick="openOperatorPanel()" title="üõ°Ô∏è Operator Paneli" style="display: none;">
                <i class="fas fa-shield-alt" style="color: #ffa500;"></i>
            </div>
            <div class="icon-item" onclick="toggleTheme()" id="themeIcon" title="Tema Deƒüi≈ütir"><i class="fas fa-moon"></i></div>
            <div class="profile-avatar" id="profileAvatar" onclick="openProfilePanel()"><span id="avatarText">?</span></div>
        </div>

        <div class="main-content">
            <!-- Sol Panel (dinamik) -->
            <div class="left-panel" id="leftPanel"></div>

            <!-- Chat Paneli -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-hashtag"></i>
                        <span id="currentChannelName">genel</span>
                        <span class="channel-info-bar">
                            <span id="channelUserCount">0</span> √ßevrimi√ßi ‚Ä¢ 
                            <span id="channelSubscribers">0</span> abone
                        </span>
                    </div>
                    <button id="subscribeChannelBtn" class="channel-subscribe-btn" onclick="toggleChannelSubscribe()"><i class="fas fa-plus"></i> Abone Ol</button>
                </div>
                <div class="messages" id="messages">
                    <div class="system-message"><i class="fas fa-info-circle"></i> CETCETY'ye ho≈ü geldin! /help yazarak komutlarƒ± g√∂rebilirsin.</div>
                </div>
                <div class="message-input-container">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" placeholder="Mesaj yazƒ±n... /help" rows="1" oninput="autoResize(this)" onkeydown="handleMessageKeyDown(event)"></textarea>
                        <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>

                <!-- √ñzel Sohbet Paneli -->
                <div id="privateChatPanel" class="private-chat-panel">
                    <div class="private-chat-header">
                        <div class="private-chat-user">
                            <div class="private-chat-avatar" id="privateChatAvatar">üë§</div>
                            <div class="private-chat-info">
                                <h4 id="privateChatName">Kullanƒ±cƒ±</h4>
                                <span id="privateChatStatus">√áevrimi√ßi</span>
                            </div>
                        </div>
                        <div class="private-chat-actions">
                            <div class="private-chat-action" onclick="blockUser()" title="Engelle (24 saat)"><i class="fas fa-ban"></i></div>
                            <div class="private-chat-action" onclick="reportUser()" title="≈ûikayet Et"><i class="fas fa-flag"></i></div>
                            <div class="private-chat-action" onclick="closePrivateChat()" title="Kapat"><i class="fas fa-times"></i></div>
                        </div>
                    </div>
                    <div class="private-tabs">
                        <div class="private-tab active" onclick="switchPrivateTab('chat')">Sohbet</div>
                        <div class="private-tab" onclick="switchPrivateTab('voice')" title="Yakƒ±nda">Sesli</div>
                        <div class="private-tab" onclick="switchPrivateTab('video')" title="Yakƒ±nda">G√∂r√ºnt√ºl√º</div>
                        <div class="private-tab" onclick="switchPrivateTab('file')" title="Yakƒ±nda">Dosya</div>
                    </div>
                    <div class="private-chat-messages" id="privateChatMessages"></div>
                    <div class="private-input-container">
                        <div class="private-input-wrapper">
                            <div class="private-media-actions">
                                <div class="private-media-btn" onclick="triggerPrivateImageUpload()" title="Resim G√∂nder"><i class="fas fa-image"></i></div>
                                <div class="private-media-btn" onclick="triggerPrivateVideoUpload()" title="Video G√∂nder"><i class="fas fa-video"></i></div>
                                <input type="file" id="privateImageUpload" accept="image/*" style="display:none;" onchange="sendPrivateImageFile(this)">
                                <input type="file" id="privateVideoUpload" accept="video/*" style="display:none;" onchange="sendPrivateVideoFile(this)">
                            </div>
                            <div class="private-text-input">
                                <textarea id="privateMessageInput" class="private-input" placeholder="Mesaj yazƒ±n..." rows="1" onkeydown="handlePrivateKeyDown(event)"></textarea>
                                <div class="private-send-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medya Paneli -->
            <div class="media-panel">
                <div class="media-header">
                    <div class="media-title"><i class="fab fa-youtube"></i><span id="currentChannelPlaylist">#genel playlist</span></div>
                    <div class="media-controls">
                        <div id="liveStreamBtn" class="media-control" onclick="openLiveStreamModal()" title="Canlƒ± Yayƒ±n"><i class="fas fa-video"></i></div>
                        <div id="hideChannelBtn" class="media-control" onclick="toggleChannelHidden()" title="Gizle/G√∂ster"><i id="hideIcon" class="fas fa-eye"></i></div>
                        <div id="reportChannelBtn" class="media-control" onclick="reportChannel()" title="≈ûikayet"><i class="fas fa-flag"></i></div>
                        <div id="addMediaBtn" class="media-control" onclick="openAddMediaModal()" title="Video ekle"><i class="fas fa-plus"></i></div>
                    </div>
                </div>
                <div class="youtube-player"><div id="youtubeContainer"></div>
                    <div class="player-controls">
                        <div class="player-btn" id="playerMuteBtn" onclick="toggleMute()"><i class="fas fa-volume-up" id="muteIcon"></i></div>
                        <div class="player-btn" id="playerPlayPauseBtn" onclick="togglePlayPause()" style="display: none;"><i class="fas fa-pause" id="playPauseIcon"></i></div>
                    </div>
                </div>
                <div class="now-playing"><i class="fas fa-circle"></i><span id="nowPlayingTitle">CETCETY Radio</span><span id="nowPlayingOwner" style="color: #6495ed; margin-left: auto;">üëë MateKy</span></div>
                <div class="playlist-container">
                    <div class="playlist-header"><span class="playlist-title"><i class="fas fa-list"></i> Kanal Playlist</span><span class="playlist-count" id="playlistCount">1 video</span></div>
                    <div id="playlistItems" class="playlist-items"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- OWNER PANELƒ∞ -->
    <div id="ownerPanel" class="role-panel">
        <div class="role-panel-content">
            <div class="role-panel-header">
                <h2><i class="fas fa-crown" style="color:#ffd700;"></i> üëë Owner Komuta Merkezi</h2>
                <button class="role-panel-close" onclick="closeOwnerPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-users"></i> Kullanƒ±cƒ± Y√∂netimi</h3>
                <div id="ownerUserList"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-robot"></i> Bot Olu≈ütur</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <input type="text" id="botName" placeholder="Bot adƒ±" style="flex:2; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <select id="botType" style="flex:1; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                        <option value="chat">Sohbet Botu</option>
                        <option value="music">M√ºzik Botu</option>
                        <option value="game">Oyun Botu</option>
                    </select>
                    <select id="botChannel" style="flex:1; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;"></select>
                    <button class="form-button secondary" onclick="createBot()">Olu≈ütur</button>
                </div>
                <div id="botList" style="margin-top: 16px;"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-ban"></i> Yasaklƒ± Kelimeler</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="newBannedWordOwner" placeholder="Yeni kelime" style="flex:1; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <button class="form-button secondary" onclick="ownerAddBannedWord()">Ekle</button>
                </div>
                <div id="ownerBannedWordsList" style="background: #0f0f0f; border-radius: 8px; padding: 12px;"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-terminal"></i> √ñzel Komutlar</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <input type="text" id="newCommandNameOwner" placeholder="Komut (√∂rn: /selam)" style="flex:2; min-width: 200px; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <input type="text" id="newCommandResponseOwner" placeholder="Yanƒ±t" style="flex:3; min-width: 200px; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <button class="form-button secondary" onclick="ownerAddCustomCommand()">Ekle</button>
                </div>
                <div id="ownerCommandsList" style="background: #0f0f0f; border-radius: 8px; padding: 12px;"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-envelope"></i> T√ºm √ñzel Sohbetler</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="ownerPrivateSearch" placeholder="Kullanƒ±cƒ± adƒ± yazƒ±n" style="flex: 1; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <button class="form-button secondary" onclick="ownerViewAllPrivateChats()">G√∂ster</button>
                </div>
                <div id="ownerPrivateMessages" style="max-height: 400px; overflow-y: auto; background: #0f0f0f; border-radius: 8px; padding: 16px; font-size: 12px;"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-hashtag"></i> Kanal Y√∂netimi</h3>
                <div id="ownerChannelList"></div>
                <button class="form-button secondary" onclick="ownerCreateChannel()" style="margin-top: 16px;">Yeni Kanal Olu≈ütur</button>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-database"></i> Sistem</h3>
                <button class="form-button danger" onclick="ownerClearAllMessages()">T√ºm Mesajlarƒ± Sil</button>
                <button class="form-button danger" onclick="ownerResetAllData()">T√ºm Verileri Sƒ±fƒ±rla</button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANELƒ∞ -->
    <div id="adminPanel" class="role-panel">
        <div class="role-panel-content">
            <div class="role-panel-header">
                <h2><i class="fas fa-bolt" style="color:#ff6b6b;"></i> ‚ö° Admin Paneli</h2>
                <button class="role-panel-close" onclick="closeAdminPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-users"></i> Kullanƒ±cƒ± Y√∂netimi</h3>
                <div id="adminUserList"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-hashtag"></i> Kanal Y√∂netimi</h3>
                <div id="adminChannelList"></div>
            </div>
        </div>
    </div>

    <!-- COADMIN PANELƒ∞ -->
    <div id="coadminPanel" class="role-panel">
        <div class="role-panel-content">
            <div class="role-panel-header">
                <h2><i class="fas fa-tools" style="color:#6495ed;"></i> üîß Co-Admin Paneli</h2>
                <button class="role-panel-close" onclick="closeCoAdminPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-users"></i> Kanal √úyeleri ve Operator Y√∂netimi</h3>
                <div id="coadminMemberList"></div>
                <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <input type="text" id="newOperatorNick" placeholder="Kullanƒ±cƒ± adƒ±" style="flex:2; padding: 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff;">
                    <button class="form-button secondary" onclick="coadminAddOperator()">Operator Yap</button>
                    <button class="form-button secondary" onclick="coadminRemoveOperator()">Operator Sil</button>
                </div>
                <div id="coadminOperatorsList" style="margin-top: 16px; background: #0f0f0f; border-radius: 8px; padding: 12px;"></div>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-music"></i> Playlist Y√∂netimi</h3>
                <button class="form-button secondary" onclick="openAddMediaModal()">Video Ekle</button>
                <button class="form-button secondary" onclick="clearPlaylist()">Playlist'i Temizle</button>
            </div>
        </div>
    </div>

    <!-- OPERATOR PANELƒ∞ -->
    <div id="operatorPanel" class="role-panel">
        <div class="role-panel-content">
            <div class="role-panel-header">
                <h2><i class="fas fa-shield-alt" style="color:#ffa500;"></i> üõ°Ô∏è Operator Paneli</h2>
                <button class="role-panel-close" onclick="closeOperatorPanel()"><i class="fas fa-times"></i></button>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-flag"></i> ≈ûikayetler</h3>
                <p>≈ûikayet listesi yakƒ±nda...</p>
            </div>
            <div class="panel-section">
                <h3><i class="fas fa-trash-alt"></i> Sohbet Temizleme</h3>
                <button class="form-button secondary" onclick="if(confirm('Sohbeti temizlemek istediƒüinize emin misiniz?')) database.ref('messages/'+currentChannel).remove();">Mevcut Kanal Sohbetini Temizle</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ========== FIREBASE KONFƒ∞G ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // ========== GLOBAL ==========
        let ytPlayer, isMuted = false, isPlaying = true;
        let USERS_DB = JSON.parse(localStorage.getItem('cetcety_users')) || [];
        let ACTIVE_USER = null;
        let BLOCKED_USERS = JSON.parse(localStorage.getItem('cetcety_blocks')) || {};
        let BANNED_WORDS = JSON.parse(localStorage.getItem('cetcety_banned_words')) || ['spam', 'reklam', '≈üiddet', 'hakaret'];
        let CUSTOM_COMMANDS = JSON.parse(localStorage.getItem('cetcety_custom_commands')) || [];
        let BOTS = JSON.parse(localStorage.getItem('cetcety_bots')) || [];

        let currentPrivateChat = null;
        let currentChannel = 'genel';
        let messagesListener = null;
        let privateMessagesListener = null;
        let onlineUsersListener = null;
        let heartbeatInterval = null;

        const OWNER_PASSWORD = 'Sahi17407@SCM';

        // Kanallar
        let channels = JSON.parse(localStorage.getItem('cetcety_channels')) || {
            'genel': { name:'genel', owner:'MateKy', ownerRole:'owner', coAdmins:[], operators:[], subscribers:15000000, online:15420, isHidden:false, currentVideo:'jfKfPfyJRdk', currentTitle:'CETCETY Radio', currentArtist:'üëë MateKy', playlist:[{id:'jfKfPfyJRdk',title:'CETCETY Radio',addedBy:'MateKy',role:'owner'}], onlineUsers:[] }
        };

        // ========== IRC KOMUT Sƒ∞STEMƒ∞Nƒ∞ ƒ∞MPORT ET ==========
        import { handleCommand, initIRCSystem } from './irc-commands.js';
        
        // Global yap
        window.handleCommand = handleCommand;
        window.initIRCSystem = initIRCSystem;

        // ========== YARDIMCI FONKSƒ∞YONLAR ==========
        function saveChannels() {
            localStorage.setItem('cetcety_channels', JSON.stringify(channels));
        }

        function getRoleLevel(role) {
            if (role === 'owner') return 5;
            if (role === 'admin') return 4;
            if (role === 'coadmin') return 3;
            if (role === 'operator') return 2;
            return 1;
        }

        function togglePasswordVisibility() {
            const pwd = document.getElementById('loginPassword');
            const icon = document.getElementById('togglePassword');
            if (pwd.type === 'password') {
                pwd.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                pwd.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // ========== ENTER TU≈ûU ƒ∞≈ûLEMLERƒ∞ ==========
        function handleMessageKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function handlePrivateKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendPrivateMessage();
            }
        }

        // ========== ONLINE KULLANICI TAKƒ∞Bƒ∞ ==========
        function initOnlineStatus() {
            if (!database || !ACTIVE_USER) return;
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            const userRef = database.ref('onlineUsers/' + ACTIVE_USER.name);
            userRef.set({
                name: ACTIVE_USER.name,
                role: ACTIVE_USER.role,
                channel: currentChannel,
                lastSeen: Date.now()
            });
            userRef.onDisconnect().remove();

            heartbeatInterval = setInterval(() => {
                userRef.update({
                    lastSeen: Date.now(),
                    channel: currentChannel
                });
            }, 15000);

            if (onlineUsersListener) onlineUsersListener.off();
            onlineUsersListener = database.ref('onlineUsers').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const now = Date.now();
                const onlineNames = [];
                Object.keys(users).forEach(name => {
                    const user = users[name];
                    if (now - user.lastSeen < 30000) onlineNames.push(name);
                    else database.ref('onlineUsers/' + name).remove();
                });
                Object.keys(channels).forEach(ch => {
                    channels[ch].onlineUsers = channels[ch].onlineUsers.filter(u => onlineNames.includes(u));
                });
                if (channels[currentChannel]) {
                    document.getElementById('channelUserCount').textContent = channels[currentChannel].onlineUsers.length;
                }
                if (document.getElementById('tabOnline')?.classList.contains('active')) showOnlineTab();
                saveChannels();
            });
        }

        // ========== MESAJLARI Dƒ∞NLE ==========
        function listenToMessages() {
            if (!database || !currentChannel) return;
            if (messagesListener) messagesListener.off();
            messagesListener = database.ref('messages/' + currentChannel).orderByChild('timestamp').on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                if (msg.type === 'system') addSystemMessage(msg.text, false);
                else {
                    const isMe = msg.sender === ACTIVE_USER?.name;
                    appendMessageToChat(msg, isMe);
                }
            });
        }

        function appendMessageToChat(msg, isMe) {
            let msgDiv = document.createElement('div');
            msgDiv.className = `message ${isMe ? 'right' : ''}`;
            let senderDisplay = msg.sender;
            if (msg.role === 'owner') senderDisplay = 'üëë ' + senderDisplay;
            else if (msg.role === 'admin') senderDisplay = '‚ö° ' + senderDisplay;
            else if (msg.role === 'coadmin') senderDisplay = 'üîß ' + senderDisplay;
            else if (msg.role === 'operator') senderDisplay = 'üõ°Ô∏è ' + senderDisplay;
            msgDiv.innerHTML = `<div class="message-header" style="${isMe ? 'justify-content: flex-end;' : ''}">
                <span class="message-time">${msg.time || new Date(msg.timestamp).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</span>
                <span class="message-sender">${escapeHTML(senderDisplay)}</span>
            </div>
            <div class="message-text">${escapeHTML(msg.text)}</div>`;
            document.getElementById('messages').appendChild(msgDiv);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function addSystemMessage(text, saveToFirebase = true, targetChannel = null) {
            let d = document.createElement('div');
            d.className = 'system-message';
            d.innerHTML = `<i class="fas fa-info-circle"></i> ${escapeHTML(text)}`;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            if (saveToFirebase && database) {
                const channel = targetChannel || currentChannel;
                database.ref('messages/' + channel).push({
                    sender: 'Sistem',
                    text: text,
                    type: 'system',
                    timestamp: Date.now()
                });
            }
        }

        // ========== √ñZEL MESAJLARI Dƒ∞NLE ==========
        function listenToPrivateMessages() {
            if (!database || !ACTIVE_USER) return;
            if (privateMessagesListener) privateMessagesListener.off();
            privateMessagesListener = database.ref('privateMessages/' + ACTIVE_USER.name).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                snapshot.ref.remove();
                if (BLOCKED_USERS[msg.sender] && BLOCKED_USERS[msg.sender].expiry > Date.now()) return;
                if (currentPrivateChat && currentPrivateChat.name === msg.sender) appendPrivateMessage(msg);
                else addSystemMessage(`üí¨ ${msg.sender} size √∂zel mesaj g√∂nderdi!`, false);
            });
        }

        function appendPrivateMessage(msg) {
            let container = document.getElementById('privateChatMessages');
            let isMe = msg.sender === ACTIVE_USER?.name;
            let time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            let senderDisplay = msg.sender;
            if (msg.role === 'owner') senderDisplay = 'üëë ' + senderDisplay;
            else if (msg.role === 'admin') senderDisplay = '‚ö° ' + senderDisplay;
            else if (msg.role === 'coadmin') senderDisplay = 'üîß ' + senderDisplay;
            else if (msg.role === 'operator') senderDisplay = 'üõ°Ô∏è ' + senderDisplay;
            let html = `<div class="private-message ${isMe ? 'right' : ''}">
                <div class="private-message-header" style="${isMe ? 'justify-content:flex-end;' : ''}">
                    <span class="private-message-time">${time}</span>
                    <span class="private-message-sender">${escapeHTML(senderDisplay)}</span>
                </div>
                <div class="private-message-text">${escapeHTML(msg.text || '')}</div>`;
            if (msg.mediaUrl) {
                if (msg.mediaType && msg.mediaType.startsWith('image/')) html += `<div class="private-message-media"><img src="${escapeHTML(msg.mediaUrl)}" onclick="window.open(this.src)"></div>`;
                else if (msg.mediaType && msg.mediaType.startsWith('video/')) html += `<div class="private-message-media"><video controls src="${escapeHTML(msg.mediaUrl)}"></video></div>`;
            }
            html += `</div>`;
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
        }

        // ========== Gƒ∞Rƒ∞≈û ==========
        function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('Kullanƒ±cƒ± adƒ± bo≈ü olamaz!'); return; }

            let user = USERS_DB.find(u => u.name.toLowerCase() === nick.toLowerCase());
            if (user) {
                if (user.password && user.password !== pass) { alert('Hatalƒ± ≈üifre!'); return; }
                if (nick.toLowerCase() === 'mateky' && pass !== OWNER_PASSWORD) { alert('Owner ≈üifresi hatalƒ±!'); return; }
            } else {
                user = {
                    id: Date.now(),
                    name: nick,
                    role: (nick.toLowerCase() === 'mateky') ? 'owner' : 'user',
                    roleLevel: (nick.toLowerCase() === 'mateky') ? 5 : 1,
                    subscribedChannels: ['genel'],
                    myChannel: null,
                    joinDate: new Date().toISOString(),
                    avatar: nick.charAt(0).toUpperCase(),
                    password: pass || '',
                    privateMode: 'all',
                    blockedNicks: []
                };
                USERS_DB.push(user);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            }

            ACTIVE_USER = user;
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';

            updateUIForUser();
            loadLeftPanel('subscriptions');
            updateAllBadges();
            updatePlaylist();

            // Yetki ikonlarƒ±nƒ± g√∂ster/gizle
            document.getElementById('ownerPanelIcon').style.display = 'none';
            document.getElementById('adminPanelIcon').style.display = 'none';
            document.getElementById('coadminPanelIcon').style.display = 'none';
            document.getElementById('operatorPanelIcon').style.display = 'none';

            if (ACTIVE_USER.role === 'owner') {
                document.getElementById('ownerPanelIcon').style.display = 'flex';
            } else if (ACTIVE_USER.role === 'admin') {
                document.getElementById('adminPanelIcon').style.display = 'flex';
            } else if (ACTIVE_USER.role === 'coadmin') {
                document.getElementById('coadminPanelIcon').style.display = 'flex';
            } else if (ACTIVE_USER.role === 'operator') {
                document.getElementById('operatorPanelIcon').style.display = 'flex';
            }

            initOnlineStatus();
            listenToMessages();
            listenToPrivateMessages();

            if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                channels.genel.onlineUsers.push(ACTIVE_USER.name);
                saveChannels();
            }

            MateBot.init();
            addSystemMessage(`üëã Ho≈ü geldin, ${ACTIVE_USER.name}!`, true);
            
            // IRC sistemini ba≈ülat
            if (typeof initIRCSystem === 'function') {
                initIRCSystem();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) {
                e.preventDefault(); 
                handleLogin();
            }
        });

        function logout() {
            if (database && ACTIVE_USER) database.ref('onlineUsers/' + ACTIVE_USER.name).remove();
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            localStorage.removeItem('cetcety_active_user');
            location.reload();
        }

        // ========== MATE BOT ==========
        const MateBot = {
            name: 'MateBot', role: 'admin', roleLevel: 4,
            spamCount: new Map(), lastMessageTime: new Map(),
            init() {
                this.joinAllChannels();
                setInterval(() => this.checkSpam(), 10000);
            },
            joinAllChannels() {
                Object.keys(channels).forEach(ch => {
                    if (!channels[ch].onlineUsers.includes(this.name)) channels[ch].onlineUsers.push(this.name);
                });
                saveChannels();
                addSystemMessage('ü§ñ MateBot aktif | Spam koruma devrede.', true);
            },
            checkSpam() {
                if (!ACTIVE_USER) return;
                const now = Date.now(), userId = ACTIVE_USER.id;
                const last = this.lastMessageTime.get(userId) || 0;
                const count = this.spamCount.get(userId) || 0;
                if (now - last < 3000) {
                    this.spamCount.set(userId, count + 1);
                    if (count >= 2) {
                        addSystemMessage(`‚ö†Ô∏è MateBot: ${ACTIVE_USER.name}, l√ºtfen spam yapma! 10 saniye beklemelisin.`, true);
                        document.getElementById('messageInput').disabled = true;
                        setTimeout(() => {
                            document.getElementById('messageInput').disabled = false;
                            this.spamCount.delete(userId);
                        }, 10000);
                    }
                } else { this.spamCount.set(userId, 0); }
                this.lastMessageTime.set(userId, now);
            },
            sendToAdmin(msg) { addSystemMessage(`ü§ñ MateBot (admin): ${msg}`, true); }
        };

        function checkBannedWords(text) {
            if (!text) return false;
            const lower = text.toLowerCase();
            for (let word of BANNED_WORDS) if (lower.includes(word.toLowerCase())) return word;
            return false;
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const i = document.getElementById('themeIcon').querySelector('i');
            i.className = document.body.classList.contains('light-theme') ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('cetcety_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        (function loadTheme() {
            if (localStorage.getItem('cetcety_theme') === 'light') document.body.classList.add('light-theme');
        })();

        function closeAllPanels() {
            closePrivateChat();
            const panelHeader = document.querySelector('.panel-header h3');
            if (panelHeader && !panelHeader.innerText.includes('Abonelikler')) closeLeftPanel();
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeAllPanels();
        });

        // ========== SOL PANEL (dinamik) ==========
        function loadLeftPanel(panelName) {
            if (!ACTIVE_USER) return;
            const panel = document.getElementById('leftPanel');
            if (panelName === 'subscriptions') loadSubscriptionsPanel(panel);
            else if (panelName === 'channels') loadChannelsPanel(panel);
            else if (panelName === 'chatlist') loadChatListPanel(panel);
            else if (panelName === 'notifications') loadNotificationsPanel(panel);
            else if (panelName === 'createchannel') loadCreateChannelPanel(panel);
            else if (panelName === 'profile') loadProfilePanel(panel);
            else if (panelName === 'support') loadSupportPanel(panel);
            else loadSubscriptionsPanel(panel);
            setActiveIcon(panelName);
        }

        function closeLeftPanel() { 
            loadLeftPanel('subscriptions'); 
        }

        function updateUIForUser() {
            document.getElementById('avatarText').textContent = ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase();
        }

        function loadSubscriptionsPanel(panel) {
            let html = `<div class="panel-header"><h3><i class="fas fa-bell" style="color:#ffd700;"></i> Abonelikler</h3><span class="subscription-count">${ACTIVE_USER.subscribedChannels.length}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            html += `<div class="search-container"><i class="fas fa-search"></i><input type="text" class="search-input" placeholder="Kanal, kullanƒ±cƒ± ara..." id="panelSearchInput"></div>`;
            let visible = ACTIVE_USER.subscribedChannels.filter(ch => {
                let c = channels[ch]; if (!c) return true;
                return (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') ? true : !c.isHidden;
            });
            if (visible.length===0) html += '<div style="color:#aaa; padding:16px; text-align:center;">Abone olunan kanal yok.</div>';
            else visible.forEach(ch=>{
                let c = channels[ch]||{owner:'Sistem',subscribers:1000,online:0,ownerRole:'user',isHidden:false};
                let icon = 'fa-hashtag';
                let sub = c.subscribers||1000;
                let fmt = sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let active = ch===currentChannel?'active':'';
                let hidden = c.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                html += `<div class="subscription-item ${active}" onclick="joinChannel('${ch}')"><div class="subscription-avatar"><i class="fas ${icon}"></i></div><div class="subscription-info"><div class="subscription-name">${ch} ${hidden}<span class="subscription-badge ${c.ownerRole==='owner'?'badge-owner':c.ownerRole==='admin'?'badge-admin':c.ownerRole==='coadmin'?'badge-coadmin':'badge-operator'}">${c.ownerRole==='owner'?'üëë':c.ownerRole==='admin'?'‚ö°':c.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span></div><div class="subscription-meta"><span>${c.owner}</span><span>‚Ä¢ ${fmt} abone</span></div></div><div class="subscription-stats">${c.onlineUsers ? c.onlineUsers.length : 0}</div></div>`;
            });
            html += `</div><div class="popular-channels"><div class="popular-header"><i class="fas fa-fire" style="color:#ff4444;"></i> Pop√ºler Kanallar</div><div id="popularChannelsList"></div></div>`;
            panel.innerHTML = html;
            updatePopularChannels();
        }

        function loadChannelsPanel(panel) {
            let html = `<div class="panel-header"><h3><i class="fas fa-list-ul" style="color:#ff0000;"></i> T√ºm Kanallar</h3><span class="subscription-count">${Object.keys(channels).length}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            html += `<div class="search-container"><i class="fas fa-search"></i><input type="text" class="search-input" placeholder="Kanal ara..."></div>`;
            let vis = Object.values(channels).filter(ch=> {
                if (ch.name === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) return false;
                return (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') ? true : !ch.isHidden;
            });
            vis.sort((a,b)=>(b.subscribers||0)-(a.subscribers||0)).forEach(ch=>{
                let sub = ch.subscribers||0, fmt=sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let isSub = ACTIVE_USER.subscribedChannels.includes(ch.name);
                let hidden = ch.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                html += `<div class="channel-item" onclick="joinChannel('${ch.name}')"><div class="channel-avatar"><i class="fas fa-hashtag"></i></div><div class="channel-info"><div class="channel-name">${ch.name} ${hidden}<span class="subscription-badge ${ch.ownerRole==='owner'?'badge-owner':ch.ownerRole==='admin'?'badge-admin':ch.ownerRole==='coadmin'?'badge-coadmin':'badge-operator'}">${ch.ownerRole==='owner'?'üëë':ch.ownerRole==='admin'?'‚ö°':ch.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span></div><div class="channel-meta"><span>${ch.owner}</span><span>‚Ä¢ ${fmt} abone</span><span>‚Ä¢ ${ch.onlineUsers ? ch.onlineUsers.length : 0} √ßevrimi√ßi</span></div></div><button class="subscribe-btn ${isSub?'subscribed':''}" onclick="event.stopPropagation(); ${isSub?'unsubscribeChannel':'subscribeChannel'}('${ch.name}')"><i class="fas ${isSub?'fa-check':'fa-plus'}"></i> ${isSub?'Abone Olundu':'Abone Ol'}</button></div>`;
            });
            html += `</div>`;
            panel.innerHTML = html;
        }

        function loadChatListPanel(panel) {
            updateUnreadBadge();
            let html = `<div class="panel-header"><h3><i class="fas fa-comment" style="color:#7289da;"></i> Sohbetlerim</h3><span class="subscription-count" id="chatListCount">${document.getElementById('chatListBadge').textContent}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>`;
            html += `<div class="panel-tabs"><div id="tabChats" class="panel-tab active" onclick="switchChatTab('chats')">Sohbetler</div><div id="tabOnline" class="panel-tab" onclick="switchChatTab('online')">√áevrimi√ßi (${channels[currentChannel]?.onlineUsers?.length||0})</div></div>`;
            html += `<div class="panel-content" id="chatPanelContent"></div>`;
            panel.innerHTML = html;
            showChatsTab();
        }

        function switchChatTab(tab) {
            document.getElementById('tabChats').classList.toggle('active', tab==='chats');
            document.getElementById('tabOnline').classList.toggle('active', tab==='online');
            if(tab==='chats') showChatsTab(); else showOnlineTab();
        }

        function showChatsTab() {
            let c = document.getElementById('chatPanelContent');
            c.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Sohbet listesi yakƒ±nda.</div>';
        }

        function showOnlineTab() {
            let c = document.getElementById('chatPanelContent');
            let users = channels[currentChannel]?.onlineUsers || [];
            let h = '';
            users.forEach(u=>{
                if (u !== MateBot.name) h+=`<div class="online-item" onclick="openPrivateChat('${u}')"><div class="online-avatar"><span>${u.charAt(0)}</span></div><div class="online-info"><div class="online-name">${u}<span class="online-status"></span></div><div class="online-meta"><span>#${currentChannel}</span></div></div></div>`;
            });
            c.innerHTML = h;
        }

        function updateUnreadBadge() {
            document.getElementById('chatListBadge').textContent = '0';
        }

        function loadNotificationsPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-bell" style="color:#ff4444;"></i> Bildirimler</h3><span class="subscription-count">2</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            let nots = [{text:'#rock kanalƒ±nda yeni video eklendi',time:'5 dk √∂nce'},{text:'Mehmet sana √∂zel mesaj g√∂nderdi',time:'12 dk √∂nce'},{text:'#arabesk kanalƒ± pop√ºler oldu!',time:'1 saat √∂nce'}];
            nots.forEach(n=>{ h+=`<div style="display:flex; align-items:center; gap:12px; padding:12px;"><i class="fas fa-info-circle" style="color:#6495ed;"></i><div style="flex:1;"><div style="font-size:13px; color:#fff;">${n.text}</div><div style="font-size:10px; color:#aaa; margin-top:2px;">${n.time}</div></div></div>`; });
            h+=`</div>`; panel.innerHTML = h;
        }

        function loadCreateChannelPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-plus-circle" style="color:#ff0000;"></i> Kanal A√ß</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            if (ACTIVE_USER.role !== 'owner' && ACTIVE_USER.myChannel) {
                h+=`<div class="info-box"><p><i class="fas fa-info-circle"></i> Zaten bir kanalƒ±nƒ±z var: <strong>#${ACTIVE_USER.myChannel}</strong>.</p></div>`;
            } else {
                h+=`<div class="form-group"><label class="form-label">Kanal Adƒ±</label><input type="text" id="newChannelName" class="form-input" placeholder="√∂rnek: teknoloji" maxlength="20"></div>
                <div class="form-group"><label class="form-label">A√ßƒ±klama</label><input type="text" id="newChannelDesc" class="form-input" placeholder="Kanalƒ±n konusu..."></div>
                <button class="form-button" onclick="createChannel()">Kanalƒ± Olu≈ütur</button>`;
            }
            h+=`</div>`; panel.innerHTML = h;
        }

        function loadProfilePanel(panel) {
            let date = ACTIVE_USER.joinDate ? new Date(ACTIVE_USER.joinDate) : new Date();
            let fmtDate = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()}`;
            let roleText = ACTIVE_USER.role==='owner'?'üëë Kurucu': ACTIVE_USER.role==='admin'?'‚ö° Admin': ACTIVE_USER.role==='coadmin'?'üîß Co-Admin': ACTIVE_USER.role==='operator'?'üõ°Ô∏è Operator':'üë§ Kullanƒ±cƒ±';
            let roleClass = ACTIVE_USER.role==='owner'?'badge-owner':ACTIVE_USER.role==='admin'?'badge-admin':ACTIVE_USER.role==='coadmin'?'badge-coadmin':ACTIVE_USER.role==='operator'?'badge-operator':'';
            let h = `<div class="panel-header"><h3><i class="fas fa-user" style="color:#ff0000;"></i> Profil</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content">
                <div style="display:flex; flex-direction:column; align-items:center; padding:20px 0;">
                    <div class="profile-avatar-panel" style="width:80px; height:80px; font-size:32px; margin-bottom:12px; cursor:pointer;" onclick="changeAvatar()">${ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase()}</div>
                    <h2 style="font-size:20px; font-weight:700; color:#fff; margin-bottom:4px;">${ACTIVE_USER.name}</h2>
                    <span class="badge ${roleClass}" style="margin-bottom:16px;">${roleText}</span>
                </div>
                <div style="display:flex; justify-content:space-around; padding:16px 0; border-top:1px solid #2a2a2a; border-bottom:1px solid #2a2a2a; margin-bottom:16px;">
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${ACTIVE_USER.subscribedChannels.length}</div><div style="font-size:11px; color:#aaa;">Abonelik</div></div>
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${ACTIVE_USER.myChannel?'1':'0'}</div><div style="font-size:11px; color:#aaa;">Kanalƒ±m</div></div>
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${fmtDate.split('.')[0]}</div><div style="font-size:11px; color:#aaa;">Katƒ±lƒ±m</div></div>
                </div>
                <div class="form-group"><label class="form-label">Kullanƒ±cƒ± Adƒ±</label><input type="text" id="profileNick" class="form-input" value="${ACTIVE_USER.name}"><button class="form-button secondary" style="margin-top:8px;" onclick="changeNick()">Deƒüi≈ütir</button></div>
                <div class="form-group"><label class="form-label">≈ûifre</label><input type="password" id="profilePassword" class="form-input" placeholder="Yeni ≈üifre"><button class="form-button secondary" style="margin-top:8px;" onclick="changePassword()">≈ûifreyi Kaydet</button></div>
                <div class="form-group"><label class="form-label">√ñzel Sohbet</label>
                    <select id="privateModeSelect" class="form-select" onchange="changePrivateMode()">
                        <option value="all" ${ACTIVE_USER.privateMode==='all'?'selected':''}>Herkese A√ßƒ±k</option>
                        <option value="none" ${ACTIVE_USER.privateMode==='none'?'selected':''}>Herkese Kapalƒ±</option>
                        <option value="blocked" ${ACTIVE_USER.privateMode==='blocked'?'selected':''}>Sadece Engellenenler</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Belirli ki≈üiyi engelle (nick)</label><input type="text" id="blockNickInput" class="form-input" placeholder="Kullanƒ±cƒ± adƒ±"><button class="form-button secondary" style="margin-top:8px;" onclick="blockSpecificNick()">Engelle</button></div>
                ${ACTIVE_USER.blockedNicks && ACTIVE_USER.blockedNicks.length ? `
                <div style="margin-bottom:16px;">
                    <label class="form-label">Engellenen Ki≈üiler</label>
                    <div style="background:#1a1a1a; border-radius:8px; padding:12px;">
                        ${ACTIVE_USER.blockedNicks.map(nick => `<span style="display:inline-block; background:#2a2a2a; padding:4px 10px; border-radius:20px; margin:0 4px 4px 0; font-size:12px;">${nick} <i class="fas fa-times" style="margin-left:6px; cursor:pointer;" onclick="unblockNick('${nick}')"></i></span>`).join('')}
                    </div>
                </div>` : ''}
                ${ACTIVE_USER.myChannel ? `<div style="margin-top:16px;"><button class="form-button danger" onclick="deleteMyChannel()">Kanalƒ±mƒ± Sil</button></div>` : ''}
                <div style="margin-top:24px;"><button class="form-button" onclick="logout()">G√ºvenli √áƒ±kƒ±≈ü</button></div>
            </div>`;
            panel.innerHTML = h;
        }

        function loadSupportPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-headset" style="color:#7289da;"></i> Destek</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content"><div class="info-box"><p><i class="fas fa-info-circle"></i> Canlƒ± destek talebiniz #admin kanalƒ±na iletilir.</p></div>
            <div style="background:#1a1a1a; border-radius:8px; padding:16px; margin-bottom:16px;"><h4 style="color:#fff; margin-bottom:12px;">üìã Sƒ±k Sorulan Sorular</h4>
                <div onclick="addSystemMessage('üìå Kanal a√ßmak i√ßin sol men√ºde + ikonuna tƒ±klayƒ±n.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px; margin-bottom:8px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> Kanal nasƒ±l a√ßarƒ±m?</div>
                <div onclick="addSystemMessage('üìå Yetki sistemi: Owner her ≈üeyi g√∂r√ºr, Admin sistem genelinde, Co-admin kendi kanalƒ±nda yetkilidir.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> Yetki sistemi nasƒ±l √ßalƒ±≈üƒ±r?</div>
                <div onclick="addSystemMessage('üìå √ñzel sohbetlerde resim/video g√∂nderebilirsiniz.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> √ñzel sohbet √∂zellikleri</div>
            </div>
            <div class="form-group"><label class="form-label">Destek Talebi</label><textarea id="supportMessage" class="form-input" placeholder="Sorununuzu yazƒ±n..." rows="3"></textarea></div>
            <button class="form-button" style="background:#7289da;" onclick="sendSupportTicket()">G√∂nder</button></div>`;
            panel.innerHTML = h;
        }

        function sendSupportTicket() {
            let msg = document.getElementById('supportMessage')?.value.trim();
            if(msg) { addSystemMessage(`üõü Destek talebiniz #admin kanalƒ±na iletildi: "${msg}"`, true); document.getElementById('supportMessage').value=''; loadLeftPanel('notifications'); }
        }

        function updatePopularChannels() {
            let c = document.getElementById('popularChannelsList'); if(!c) return;
            c.innerHTML = '';
            let vis = Object.values(channels).filter(ch=> {
                if (ch.name === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) return false;
                return (ACTIVE_USER.role==='owner'||ACTIVE_USER.role==='admin') ? true : !ch.isHidden;
            });
            vis.sort((a,b)=>(b.subscribers||0)-(a.subscribers||0)).slice(0,3).forEach(ch=>{
                let sub = ch.subscribers||0, fmt = sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let isSub = ACTIVE_USER.subscribedChannels.includes(ch.name);
                let hidden = ch.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                let roleClass = ch.ownerRole==='owner'?'badge-owner':ch.ownerRole==='admin'?'badge-admin':ch.ownerRole==='coadmin'?'badge-coadmin':'badge-operator';
                c.innerHTML += `<div class="popular-item" onclick="joinChannel('${ch.name}')"><div class="popular-info"><div class="popular-name">${ch.name} ${hidden}<span class="badge ${roleClass}">${ch.ownerRole==='owner'?'üëë':ch.ownerRole==='admin'?'‚ö°':ch.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span>${ch.name==='genel'?'<span class="badge badge-owner">ANA</span>':''}${ch.subscribers>1000000?'<span class="badge badge-coadmin">POP</span>':''}</div><div class="popular-subscribers">${fmt} abone</div></div><button class="subscribe-btn ${isSub?'subscribed':''}" onclick="event.stopPropagation(); ${isSub?'unsubscribeChannel':'subscribeChannel'}('${ch.name}')"><i class="fas ${isSub?'fa-check':'fa-plus'}"></i> ${isSub?'Abone Olundu':'Abone Ol'}</button></div>`;
            });
        }

        // ========== √ñZEL SOHBET ==========
        function openPrivateChat(username) {
            if (!username) return;
            if (ACTIVE_USER.privateMode === 'none') { addSystemMessage('‚ùå √ñzel sohbetlere kapalƒ±sƒ±nƒ±z.', true); return; }
            if (ACTIVE_USER.blockedNicks && ACTIVE_USER.blockedNicks.includes(username)) { addSystemMessage(`üö´ ${username} engellenmi≈ü.`, true); return; }
            let blockKey = `${ACTIVE_USER.id}_${username}`;
            if (BLOCKED_USERS[blockKey] && BLOCKED_USERS[blockKey].expiry > Date.now()) { addSystemMessage(`üö´ ${username} 24 saat engellendi.`, true); return; }
            let reverseKey = `${username}_${ACTIVE_USER.id}`;
            if (BLOCKED_USERS[reverseKey] && BLOCKED_USERS[reverseKey].expiry > Date.now()) { addSystemMessage(`üö´ ${username} tarafƒ±ndan engellendiniz.`, true); return; }

            currentPrivateChat = { name: username, id: username };
            document.getElementById('privateChatName').textContent = username;
            document.getElementById('privateChatAvatar').innerHTML = username.charAt(0).toUpperCase();
            document.getElementById('privateChatPanel').classList.add('active');
            document.getElementById('privateChatMessages').innerHTML = '';
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChat = null;
        }

        function sendPrivateMessage() {
            let input = document.getElementById('privateMessageInput');
            let text = input.value.trim();
            if (!text || !currentPrivateChat || !ACTIVE_USER) return;
            let banned = checkBannedWords(text);
            if (banned) {
                addSystemMessage(`üö´ Yasaklƒ± kelime tespit edildi: "${banned}". Mesajƒ±nƒ±z g√∂nderilmedi.`, true);
                MateBot.sendToAdmin(`‚ö†Ô∏è ${ACTIVE_USER.name} √∂zel sohbette yasaklƒ± kelime kullandƒ±: ${banned}`);
                input.value = ''; return;
            }
            if (database) {
                database.ref('privateMessages/' + currentPrivateChat.name).push({
                    sender: ACTIVE_USER.name,
                    role: ACTIVE_USER.role,
                    text: text,
                    timestamp: Date.now()
                });
                appendPrivateMessage({ sender: ACTIVE_USER.name, role: ACTIVE_USER.role, text: text, timestamp: Date.now() });
            }
            input.value = '';
        }

        function triggerPrivateImageUpload() { document.getElementById('privateImageUpload').click(); }

        function sendPrivateImageFile(input) {
            if (!input.files || !input.files[0] || !currentPrivateChat) return;
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = (e) => {
                if (database) {
                    database.ref('privateMessages/' + currentPrivateChat.name).push({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                    appendPrivateMessage({ sender: ACTIVE_USER.name, role: ACTIVE_USER.role, text: '', mediaUrl: e.target.result, mediaType: file.type, timestamp: Date.now() });
                }
            };
            reader.readAsDataURL(file); input.value = '';
        }

        function triggerPrivateVideoUpload() { document.getElementById('privateVideoUpload').click(); }

        function sendPrivateVideoFile(input) {
            if (!input.files || !input.files[0] || !currentPrivateChat) return;
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = (e) => {
                if (database) {
                    database.ref('privateMessages/' + currentPrivateChat.name).push({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                    appendPrivateMessage({ sender: ACTIVE_USER.name, role: ACTIVE_USER.role, text: '', mediaUrl: e.target.result, mediaType: file.type, timestamp: Date.now() });
                }
            };
            reader.readAsDataURL(file); input.value = '';
        }

        function blockUser() {
            if (!currentPrivateChat || !ACTIVE_USER) return;
            let blockKey = `${ACTIVE_USER.id}_${currentPrivateChat.id}`;
            BLOCKED_USERS[blockKey] = { userId: currentPrivateChat.id, userName: currentPrivateChat.name, expiry: Date.now() + 24*60*60*1000, blockedBy: ACTIVE_USER.id };
            localStorage.setItem('cetcety_blocks', JSON.stringify(BLOCKED_USERS));
            addSystemMessage(`üö´ ${currentPrivateChat.name} 24 saatliƒüine engellendi.`, true);
            closePrivateChat();
        }

        function reportUser() { if (currentPrivateChat) addSystemMessage(`‚ö†Ô∏è ${currentPrivateChat.name} ≈üikayet edildi.`, true); }

        function switchPrivateTab(tab) { if (tab !== 'chat') addSystemMessage('üîú Bu √∂zellik yakƒ±nda aktif olacak.', true); }

        // ========== OWNER PANELƒ∞ FONKSƒ∞YONLARI ==========
        function openOwnerPanel() {
            if (ACTIVE_USER.role !== 'owner') return;
            document.getElementById('ownerPanel').classList.add('active');
            refreshOwnerPanel();
        }

        function closeOwnerPanel() {
            document.getElementById('ownerPanel').classList.remove('active');
        }

        function refreshOwnerPanel() {
            let userListHtml = '';
            USERS_DB.sort((a,b) => getRoleLevel(b.role) - getRoleLevel(a.role)).forEach(user => {
                userListHtml += `
                <div class="user-list-item">
                    <div><strong>${user.name}</strong> (${user.role})</div>
                    <div class="user-actions">
                        <select onchange="ownerChangeRole('${user.name}', this.value)">
                            <option value="user" ${user.role==='user'?'selected':''}>user</option>
                            <option value="operator" ${user.role==='operator'?'selected':''}>operator</option>
                            <option value="coadmin" ${user.role==='coadmin'?'selected':''}>coadmin</option>
                            <option value="admin" ${user.role==='admin'?'selected':''}>admin</option>
                            <option value="owner" ${user.role==='owner'?'selected':''} disabled>owner</option>
                        </select>
                        <button onclick="ownerDeleteUser('${user.name}')">Sil</button>
                    </div>
                </div>`;
            });
            document.getElementById('ownerUserList').innerHTML = userListHtml || '<p>Kullanƒ±cƒ± yok.</p>';

            let channelListHtml = '';
            Object.keys(channels).forEach(chName => {
                let ch = channels[chName];
                channelListHtml += `
                <div class="user-list-item">
                    <div><strong>#${ch.name}</strong> (sahip: ${ch.owner})</div>
                    <div class="user-actions">
                        <button onclick="ownerToggleHideChannel('${ch.name}')">${ch.isHidden ? 'G√∂ster' : 'Gizle'}</button>
                        <button onclick="ownerDeleteChannel('${ch.name}')" style="background:#ff4444;">Sil</button>
                    </div>
                </div>`;
            });
            document.getElementById('ownerChannelList').innerHTML = channelListHtml || '<p>Kanal yok.</p>';

            let bannedHtml = '';
            BANNED_WORDS.forEach(word => {
                bannedHtml += `<span class="command-chip">${word} <i class="fas fa-times" onclick="ownerRemoveBannedWord('${word}')"></i></span>`;
            });
            document.getElementById('ownerBannedWordsList').innerHTML = bannedHtml || '<p>Yasaklƒ± kelime yok.</p>';

            let cmdHtml = '';
            CUSTOM_COMMANDS.forEach(cmd => {
                cmdHtml += `<span class="command-chip">${cmd.command} ‚Üí ${cmd.response} <i class="fas fa-times" onclick="ownerRemoveCommand('${cmd.command}')"></i></span>`;
            });
            document.getElementById('ownerCommandsList').innerHTML = cmdHtml || '<p>√ñzel komut yok.</p>';

            let botHtml = '';
            BOTS.forEach((bot, index) => {
                botHtml += `<div class="user-list-item"><span>${bot.name} (${bot.type}) - #${bot.channel}</span><button onclick="deleteBot(${index})">Sil</button></div>`;
            });
            document.getElementById('botList').innerHTML = botHtml || '<p>Bot yok.</p>';

            let channelOptions = '';
            Object.keys(channels).forEach(ch => {
                channelOptions += `<option value="${ch}">#${ch}</option>`;
            });
            document.getElementById('botChannel').innerHTML = channelOptions;
        }

        function ownerChangeRole(username, newRole) {
            if (ACTIVE_USER.role !== 'owner') return;
            let user = USERS_DB.find(u => u.name === username);
            if (!user || user.role === 'owner') return;
            user.role = newRole;
            localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            addSystemMessage(`üëë ${username} rol√º ${newRole} olarak deƒüi≈ütirildi.`, true);
            refreshOwnerPanel();
        }

        function ownerDeleteUser(username) {
            if (ACTIVE_USER.role !== 'owner') return;
            if (username === 'MateKy') { alert('Owner silinemez!'); return; }
            if (confirm(`${username} kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz?`)) {
                USERS_DB = USERS_DB.filter(u => u.name !== username);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                database.ref('onlineUsers/' + username).remove();
                addSystemMessage(`üëë ${username} silindi.`, true);
                refreshOwnerPanel();
            }
        }

        function ownerToggleHideChannel(chName) {
            if (ACTIVE_USER.role !== 'owner') return;
            let ch = channels[chName];
            if (!ch) return;
            ch.isHidden = !ch.isHidden;
            saveChannels();
            addSystemMessage(`üëë #${chName} ${ch.isHidden ? 'gizlendi' : 'g√∂steriliyor'}.`, true);
            refreshOwnerPanel();
        }

        function ownerDeleteChannel(chName) {
            if (ACTIVE_USER.role !== 'owner') return;
            if (chName === 'genel') { alert('Genel kanal silinemez!'); return; }
            if (confirm(`#${chName} kanalƒ±nƒ± silmek istediƒüinize emin misiniz?`)) {
                delete channels[chName];
                saveChannels();
                addSystemMessage(`üëë #${chName} kanalƒ± silindi.`, true);
                refreshOwnerPanel();
            }
        }

        function ownerCreateChannel() {
            let name = prompt('Yeni kanal adƒ± girin (k√º√ß√ºk harf):');
            if (!name) return;
            name = name.toLowerCase().trim();
            if (channels[name]) { alert('Bu kanal zaten var!'); return; }
            channels[name] = {
                name, owner: ACTIVE_USER.name, ownerRole: 'owner', coAdmins: [ACTIVE_USER.name], operators: [],
                subscribers: 1, online: 1, isHidden: false,
                currentVideo: 'jfKfPfyJRdk', currentTitle: 'CETCETY Radio', currentArtist: `üëë ${ACTIVE_USER.name}`,
                playlist: [{ id: 'jfKfPfyJRdk', title: 'CETCETY Radio', addedBy: ACTIVE_USER.name, role: 'owner' }],
                onlineUsers: [ACTIVE_USER.name]
            };
            saveChannels();
            addSystemMessage(`üëë #${name} kanalƒ± olu≈üturuldu.`, true);
            refreshOwnerPanel();
        }

        function ownerAddBannedWord() {
            let word = document.getElementById('newBannedWordOwner').value.trim();
            if (!word) return;
            if (!BANNED_WORDS.includes(word)) {
                BANNED_WORDS.push(word);
                localStorage.setItem('cetcety_banned_words', JSON.stringify(BANNED_WORDS));
                addSystemMessage(`üö´ Yasaklƒ± kelime eklendi: ${word}`, true);
                refreshOwnerPanel();
                document.getElementById('newBannedWordOwner').value = '';
            }
        }

        function ownerRemoveBannedWord(word) {
            BANNED_WORDS = BANNED_WORDS.filter(w => w !== word);
            localStorage.setItem('cetcety_banned_words', JSON.stringify(BANNED_WORDS));
            addSystemMessage(`‚úÖ Yasaklƒ± kelime kaldƒ±rƒ±ldƒ±: ${word}`, true);
            refreshOwnerPanel();
        }

        function ownerAddCustomCommand() {
            let cmd = document.getElementById('newCommandNameOwner').value.trim();
            let resp = document.getElementById('newCommandResponseOwner').value.trim();
            if (!cmd || !resp) return;
            if (!cmd.startsWith('/')) cmd = '/' + cmd;
            CUSTOM_COMMANDS.push({ command: cmd, response: resp });
            localStorage.setItem('cetcety_custom_commands', JSON.stringify(CUSTOM_COMMANDS));
            addSystemMessage(`‚úÖ Yeni komut eklendi: ${cmd}`, true);
            refreshOwnerPanel();
            document.getElementById('newCommandNameOwner').value = '';
            document.getElementById('newCommandResponseOwner').value = '';
        }

        function ownerRemoveCommand(cmd) {
            CUSTOM_COMMANDS = CUSTOM_COMMANDS.filter(c => c.command !== cmd);
            localStorage.setItem('cetcety_custom_commands', JSON.stringify(CUSTOM_COMMANDS));
            addSystemMessage(`üóëÔ∏è Komut kaldƒ±rƒ±ldƒ±: ${cmd}`, true);
            refreshOwnerPanel();
        }

        function ownerClearAllMessages() {
            if (ACTIVE_USER.role !== 'owner') return;
            if (confirm('T√ºm kanallardaki t√ºm mesajlarƒ± silmek istediƒüinize emin misiniz?')) {
                database.ref('messages').remove();
                addSystemMessage('üëë T√ºm mesajlar silindi.', true);
            }
        }

        function ownerResetAllData() {
            if (ACTIVE_USER.role !== 'owner') return;
            if (confirm('T√úM VERƒ∞LER SIFIRLANACAK! (Kullanƒ±cƒ±lar, Kanallar, Mesajlar) Emin misiniz?')) {
                localStorage.clear();
                database.ref().remove();
                location.reload();
            }
        }

        function createBot() {
            let name = document.getElementById('botName').value.trim();
            let type = document.getElementById('botType').value;
            let channel = document.getElementById('botChannel').value;
            if (!name) return;
            let bot = { name, type, channel, role: 'bot', online: true };
            BOTS.push(bot);
            localStorage.setItem('cetcety_bots', JSON.stringify(BOTS));
            if (!channels[channel].onlineUsers.includes(name)) channels[channel].onlineUsers.push(name);
            saveChannels();
            addSystemMessage(`ü§ñ Bot ${name} olu≈üturuldu ve #${channel} kanalƒ±na eklendi.`, true);
            refreshOwnerPanel();
        }

        function deleteBot(index) {
            let bot = BOTS[index];
            if (confirm(`Bot ${bot.name} silinsin mi?`)) {
                BOTS.splice(index, 1);
                localStorage.setItem('cetcety_bots', JSON.stringify(BOTS));
                Object.keys(channels).forEach(ch => {
                    channels[ch].onlineUsers = channels[ch].onlineUsers.filter(u => u !== bot.name);
                });
                saveChannels();
                addSystemMessage(`ü§ñ Bot ${bot.name} silindi.`, true);
                refreshOwnerPanel();
            }
        }

        function ownerViewAllPrivateChats() {
            let username = document.getElementById('ownerPrivateSearch').value.trim();
            if (username) {
                database.ref('privateMessages/' + username).once('value', (snapshot) => {
                    let msgs = snapshot.val() || {};
                    let html = '';
                    Object.values(msgs).forEach(msg => {
                        let time = new Date(msg.timestamp).toLocaleString('tr-TR');
                        let media = msg.mediaUrl ? (msg.mediaType.startsWith('image/') ? `<img src="${msg.mediaUrl}" style="max-width:100px;">` : `<video src="${msg.mediaUrl}" style="max-width:100px;"></video>`) : '';
                        html += `<div style="border-bottom:1px solid #333; padding:8px;"><strong>${msg.sender}</strong> (${msg.role}): ${msg.text || ''} ${media} <span style="color:#aaa;">${time}</span></div>`;
                    });
                    document.getElementById('ownerPrivateMessages').innerHTML = html || 'Mesaj yok.';
                });
            } else {
                database.ref('privateMessages').once('value', (snapshot) => {
                    let all = snapshot.val() || {};
                    let html = '';
                    Object.keys(all).forEach(user => {
                        let msgs = all[user];
                        let lastMsg = Object.values(msgs).pop();
                        if (lastMsg) {
                            let time = new Date(lastMsg.timestamp).toLocaleString('tr-TR');
                            let media = lastMsg.mediaUrl ? (lastMsg.mediaType.startsWith('image/') ? `<img src="${lastMsg.mediaUrl}" style="max-width:100px;">` : `<video src="${lastMsg.mediaUrl}" style="max-width:100px;"></video>`) : '';
                            html += `<div style="border-bottom:1px solid #333; padding:8px;"><strong>${user}</strong> son mesaj: ${lastMsg.text || ''} ${media} <span style="color:#aaa;">${time}</span></div>`;
                        }
                    });
                    document.getElementById('ownerPrivateMessages').innerHTML = html || 'Mesaj yok.';
                });
            }
        }

        // ========== ADMIN PANELƒ∞ ==========
        function openAdminPanel() {
            if (ACTIVE_USER.role !== 'admin' && ACTIVE_USER.role !== 'owner') return;
            document.getElementById('adminPanel').classList.add('active');
            refreshAdminPanel();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
        }

        function refreshAdminPanel() {
            let userListHtml = '';
            USERS_DB.sort((a,b) => getRoleLevel(b.role) - getRoleLevel(a.role)).forEach(user => {
                if (user.role === 'owner' || user.role === 'admin') return;
                userListHtml += `
                <div class="user-list-item">
                    <div><strong>${user.name}</strong> (${user.role})</div>
                    <div class="user-actions">
                        <select onchange="adminChangeRole('${user.name}', this.value)">
                            <option value="user" ${user.role==='user'?'selected':''}>user</option>
                            <option value="operator" ${user.role==='operator'?'selected':''}>operator</option>
                            <option value="coadmin" ${user.role==='coadmin'?'selected':''}>coadmin</option>
                        </select>
                        <button onclick="adminDeleteUser('${user.name}')">Sil</button>
                    </div>
                </div>`;
            });
            document.getElementById('adminUserList').innerHTML = userListHtml || '<p>Kullanƒ±cƒ± yok.</p>';

            let channelListHtml = '';
            Object.keys(channels).forEach(chName => {
                let ch = channels[chName];
                channelListHtml += `
                <div class="user-list-item">
                    <div><strong>#${ch.name}</strong> (sahip: ${ch.owner})</div>
                    <div class="user-actions">
                        <button onclick="adminToggleHideChannel('${ch.name}')">${ch.isHidden ? 'G√∂ster' : 'Gizle'}</button>
                        <button onclick="adminDeleteChannel('${ch.name}')" style="background:#ff4444;">Sil</button>
                    </div>
                </div>`;
            });
            document.getElementById('adminChannelList').innerHTML = channelListHtml || '<p>Kanal yok.</p>';
        }

        function adminChangeRole(username, newRole) {
            if (!(ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            let user = USERS_DB.find(u => u.name === username);
            if (!user || user.role === 'owner' || user.role === 'admin') return;
            user.role = newRole;
            localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            addSystemMessage(`‚ö° ${username} rol√º ${newRole} olarak deƒüi≈ütirildi.`, true);
            refreshAdminPanel();
        }

        function adminDeleteUser(username) {
            if (!(ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            let user = USERS_DB.find(u => u.name === username);
            if (!user || user.role === 'owner' || user.role === 'admin') return;
            if (confirm(`${username} kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz?`)) {
                USERS_DB = USERS_DB.filter(u => u.name !== username);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                database.ref('onlineUsers/' + username).remove();
                addSystemMessage(`‚ö° ${username} silindi.`, true);
                refreshAdminPanel();
            }
        }

        function adminToggleHideChannel(chName) {
            if (!(ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            let ch = channels[chName];
            if (!ch) return;
            ch.isHidden = !ch.isHidden;
            saveChannels();
            addSystemMessage(`‚ö° #${chName} ${ch.isHidden ? 'gizlendi' : 'g√∂steriliyor'}.`, true);
            refreshAdminPanel();
        }

        function adminDeleteChannel(chName) {
            if (!(ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            if (chName === 'genel') { alert('Genel kanal silinemez!'); return; }
            if (confirm(`#${chName} kanalƒ±nƒ± silmek istediƒüinize emin misiniz?`)) {
                delete channels[chName];
                saveChannels();
                addSystemMessage(`‚ö° #${chName} kanalƒ± silindi.`, true);
                refreshAdminPanel();
            }
        }

        // ========== COADMIN PANELƒ∞ ==========
        function openCoAdminPanel() {
            if (!(ACTIVE_USER.role === 'coadmin' || ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            document.getElementById('coadminPanel').classList.add('active');
            refreshCoAdminPanel();
        }

        function closeCoAdminPanel() {
            document.getElementById('coadminPanel').classList.remove('active');
        }

        function refreshCoAdminPanel() {
            let myChannel = ACTIVE_USER.myChannel;
            if (!myChannel) {
                document.getElementById('coadminMemberList').innerHTML = '<p>Kendi kanalƒ±nƒ±z yok. L√ºtfen √∂nce bir kanal a√ßƒ±n.</p>';
                document.getElementById('coadminOperatorsList').innerHTML = '';
                return;
            }
            let ch = channels[myChannel];
            if (!ch) return;
            let members = ch.onlineUsers || [];
            let html = '<p>Kanal √ºyeleri: ' + members.join(', ') + '</p>';
            document.getElementById('coadminMemberList').innerHTML = html;

            let opsHtml = '<strong>Mevcut Operatorler:</strong> ';
            if (ch.operators && ch.operators.length > 0) {
                opsHtml += ch.operators.map(op => `<span class="command-chip">${op} <i class="fas fa-times" onclick="coadminRemoveOperatorByName('${op}')"></i></span>`).join('');
            } else {
                opsHtml += 'Yok';
            }
            document.getElementById('coadminOperatorsList').innerHTML = opsHtml;
        }

        function coadminAddOperator() {
            let nick = document.getElementById('newOperatorNick').value.trim();
            if (!nick) return;
            let myChannel = ACTIVE_USER.myChannel;
            if (!myChannel) { alert('Kendi kanalƒ±nƒ±z yok!'); return; }
            let ch = channels[myChannel];
            if (!ch) return;
            let user = USERS_DB.find(u => u.name === nick);
            if (!user) { alert('Kullanƒ±cƒ± bulunamadƒ±!'); return; }
            if (user.role === 'operator' || user.role === 'coadmin' || user.role === 'admin' || user.role === 'owner') {
                alert('Bu kullanƒ±cƒ± zaten daha √ºst bir role sahip!');
                return;
            }
            user.role = 'operator';
            if (!ch.operators) ch.operators = [];
            if (!ch.operators.includes(nick)) ch.operators.push(nick);
            localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            saveChannels();
            addSystemMessage(`üîß ${nick} artƒ±k #${myChannel} kanalƒ±nda operator.`, true);
            refreshCoAdminPanel();
        }

        function coadminRemoveOperator() {
            let nick = document.getElementById('newOperatorNick').value.trim();
            coadminRemoveOperatorByName(nick);
        }

        function coadminRemoveOperatorByName(nick) {
            if (!nick) return;
            let myChannel = ACTIVE_USER.myChannel;
            if (!myChannel) { alert('Kendi kanalƒ±nƒ±z yok!'); return; }
            let ch = channels[myChannel];
            if (!ch) return;
            if (ch.operators && ch.operators.includes(nick)) {
                ch.operators = ch.operators.filter(op => op !== nick);
                let user = USERS_DB.find(u => u.name === nick);
                if (user && user.role === 'operator') {
                    user.role = 'user';
                }
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                saveChannels();
                addSystemMessage(`üî® ${nick} operator yetkisi alƒ±ndƒ±.`, true);
                refreshCoAdminPanel();
            } else {
                alert(`${nick} operator listesinde bulunamadƒ±.`);
            }
        }

        // ========== OPERATOR PANELƒ∞ ==========
        function openOperatorPanel() {
            if (!(ACTIVE_USER.role === 'operator' || ACTIVE_USER.role === 'coadmin' || ACTIVE_USER.role === 'admin' || ACTIVE_USER.role === 'owner')) return;
            document.getElementById('operatorPanel').classList.add('active');
        }

        function closeOperatorPanel() {
            document.getElementById('operatorPanel').classList.remove('active');
        }

        // ========== ƒ∞KON FONKSƒ∞YONLARI ==========
        function showHome() { addSystemMessage('üè† Ana sayfa hazƒ±rlanƒ±yor...', true); }
        function openSubscriptions() { loadLeftPanel('subscriptions'); }
        function openChannelPanel() { loadLeftPanel('channels'); }
        function openChatListPanel() { loadLeftPanel('chatlist'); }
        function openCreateChannelPanel() { loadLeftPanel('createchannel'); }
        function openNotificationPanel() { loadLeftPanel('notifications'); }
        function openSupportPanel() { loadLeftPanel('support'); }
        function openProfilePanel() { loadLeftPanel('profile'); }

        function setActiveIcon(active) {
            document.querySelectorAll('.icon-item').forEach(el => el.classList.remove('active'));
            if (active === 'subscriptions') document.querySelector('.icon-item[onclick*="openSubscriptions"]')?.classList.add('active');
            else if (active === 'channels') document.querySelector('.icon-item[onclick*="openChannelPanel"]')?.classList.add('active');
            else if (active === 'chatlist') document.querySelector('.icon-item[onclick*="openChatListPanel"]')?.classList.add('active');
            else if (active === 'notifications') document.querySelector('.icon-item[onclick*="openNotificationPanel"]')?.classList.add('active');
            else if (active === 'createchannel') document.querySelector('.icon-item[onclick*="openCreateChannelPanel"]')?.classList.add('active');
            else if (active === 'profile') document.querySelector('.profile-avatar')?.classList.add('active');
            else if (active === 'support') document.querySelector('.icon-item[onclick*="openSupportPanel"]')?.classList.add('active');
        }

        // ========== KANAL ƒ∞≈ûLEMLERƒ∞ ==========
        function joinChannel(ch) {
            if (!channels[ch]) return;
            if (currentChannel && channels[currentChannel] && channels[currentChannel].onlineUsers) {
                channels[currentChannel].onlineUsers = channels[currentChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
            }
            if (database && ACTIVE_USER) {
                database.ref('onlineUsers/' + ACTIVE_USER.name).update({ channel: ch });
            }

            currentChannel = ch;
            let c = channels[ch];

            if (!c.onlineUsers.includes(ACTIVE_USER.name)) {
                c.onlineUsers.push(ACTIVE_USER.name);
            }
            saveChannels();

            document.getElementById('currentChannelName').textContent = ch;
            document.getElementById('currentChannelPlaylist').textContent = `#${ch} playlist`;
            let sub = c.subscribers || 0;
            let fmt = sub >= 1000000 ? (sub/1000000).toFixed(1)+'M' : sub >= 1000 ? (sub/1000).toFixed(1)+'K' : sub;
            document.getElementById('channelSubscribers').textContent = fmt;
            document.getElementById('channelUserCount').textContent = c.onlineUsers.length;
            if (ytPlayer) { ytPlayer.loadVideoById(c.currentVideo); ytPlayer.playVideo(); }
            document.getElementById('nowPlayingTitle').textContent = c.currentTitle;
            document.getElementById('nowPlayingOwner').innerHTML = `${c.ownerRole === 'owner' ? 'üëë' : 'üîß'} ${c.owner}`;
            updatePlaylist();

            listenToMessages();

            let subBtn = document.getElementById('subscribeChannelBtn');
            if (ACTIVE_USER.subscribedChannels.includes(ch)) { subBtn.innerHTML = '<i class="fas fa-check"></i> Abone Olundu'; subBtn.classList.add('subscribed'); }
            else { subBtn.innerHTML = '<i class="fas fa-plus"></i> Abone Ol'; subBtn.classList.remove('subscribed'); }

            let addBtn = document.getElementById('addMediaBtn');
            let liveBtn = document.getElementById('liveStreamBtn');
            let hideBtn = document.getElementById('hideChannelBtn');
            let playPauseBtn = document.getElementById('playerPlayPauseBtn');

            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name)) {
                addBtn.classList.remove('disabled'); addBtn.style.opacity = '1'; addBtn.style.pointerEvents = 'auto';
                liveBtn.classList.remove('disabled'); liveBtn.style.opacity = '1'; liveBtn.style.pointerEvents = 'auto';
                hideBtn.classList.remove('disabled'); hideBtn.style.opacity = '1'; hideBtn.style.pointerEvents = 'auto';
                playPauseBtn.style.display = 'flex';
            } else {
                addBtn.classList.add('disabled'); addBtn.style.opacity = '0.4'; addBtn.style.pointerEvents = 'none';
                liveBtn.classList.add('disabled'); liveBtn.style.opacity = '0.4'; liveBtn.style.pointerEvents = 'none';
                hideBtn.classList.add('disabled'); hideBtn.style.opacity = '0.4'; hideBtn.style.pointerEvents = 'none';
                playPauseBtn.style.display = 'none';
            }

            let reportBtn = document.getElementById('reportChannelBtn');
            reportBtn.classList.remove('disabled'); reportBtn.style.opacity = '1'; reportBtn.style.pointerEvents = 'auto';

            addSystemMessage(`üì¢ #${ch} kanalƒ±na katƒ±ldƒ±n! ${fmt} abone, ${c.onlineUsers.length} √ßevrimi√ßi.`, true);
        }

        function toggleChannelHidden() {
            let c = channels[currentChannel]; if (!c) return;
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name)) {
                c.isHidden = !c.isHidden;
                saveChannels();
                document.getElementById('hideIcon').className = c.isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
                addSystemMessage(`üëÅÔ∏è #${currentChannel} ${c.isHidden ? 'gizlendi' : 'g√∂steriliyor'}.`, true);
                updatePopularChannels();
            } else {
                addSystemMessage('‚ùå Bu kanalƒ± gizleme yetkiniz yok!', true);
            }
        }

        // ========== PLAYLIST ==========
        function updatePlaylist() {
            let c = channels[currentChannel]; if (!c) return;
            let cont = document.getElementById('playlistItems'); let html = '';
            c.playlist.forEach((item, i) => {
                let active = item.id === c.currentVideo ? 'active' : '';
                let canDel = ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || (c.coAdmins?.includes(ACTIVE_USER.name) && item.addedBy === ACTIVE_USER.name);
                let canClick = (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name));
                let clickAction = canClick ? `onclick="playVideo('${item.id}','${escapeHTML(item.title)}','${escapeHTML(item.addedBy)}','${item.role}')"` : '';
                html += `<div class="playlist-item ${active}" ${clickAction}><div class="playlist-thumb"><i class="fab fa-youtube"></i></div><div class="playlist-info"><div class="playlist-song">${escapeHTML(item.title)}</div><div class="playlist-artist"><span>${item.role === 'owner' ? 'üëë' : item.role === 'admin' ? '‚ö°' : 'üîß'} ${escapeHTML(item.addedBy)}</span><span class="badge ${item.role === 'owner' ? 'badge-owner' : item.role === 'admin' ? 'badge-admin' : 'badge-coadmin'}">${item.role}</span></div></div>${canDel ? `<div class="playlist-actions"><div class="playlist-action" onclick="event.stopPropagation(); removeFromPlaylist(${i})"><i class="fas fa-trash"></i></div></div>` : ''}</div>`;
            });
            cont.innerHTML = html; document.getElementById('playlistCount').textContent = `${c.playlist.length} video`;
        }

        function playVideo(vid, title, by, role) {
            let c = channels[currentChannel]; c.currentVideo = vid; c.currentTitle = title; c.currentArtist = `${role === 'owner' ? 'üëë' : role === 'admin' ? '‚ö°' : 'üîß'} ${by}`;
            saveChannels();
            if (ytPlayer) ytPlayer.loadVideoById(vid);
            document.getElementById('nowPlayingTitle').textContent = title; document.getElementById('nowPlayingOwner').innerHTML = `${role === 'owner' ? 'üëë' : role === 'admin' ? '‚ö°' : 'üîß'} ${by}`;
            updatePlaylist();
        }

        function removeFromPlaylist(i) {
            let c = channels[currentChannel]; let rem = c.playlist[i]; c.playlist.splice(i, 1);
            if (rem.id === c.currentVideo && c.playlist.length > 0) { let n = c.playlist[0]; playVideo(n.id, n.title, n.addedBy, n.role); }
            saveChannels();
            updatePlaylist(); addSystemMessage(`üóëÔ∏è "${rem.title}" kaldƒ±rƒ±ldƒ±.`, true);
        }

        function openAddMediaModal() {
            let c = channels[currentChannel];
            if (!(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name))) { alert('Yetkiniz yok!'); return; }
            let url = prompt('YouTube URL/ID:', ''); if (!url) return;
            let vid = ''; if (url.includes('youtube.com/watch?v=')) vid = url.split('v=')[1]?.split('&')[0]; else if (url.includes('youtu.be/')) vid = url.split('youtu.be/')[1]?.split('?')[0]; else vid = url;
            if (vid) { let t = prompt('Ba≈ülƒ±k:', `Video ${c.playlist.length + 1}`); c.playlist.push({ id: vid, title: t || `Video ${c.playlist.length + 1}`, addedBy: ACTIVE_USER.name, role: ACTIVE_USER.role }); updatePlaylist(); saveChannels(); addSystemMessage(`‚úÖ "${t}" eklendi!`, true); }
        }

        function clearPlaylist() {
            let c = channels[currentChannel];
            if (!(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name))) { alert('Yetkiniz yok!'); return; }
            if (confirm('Playlist temizlensin mi?')) {
                c.playlist = [];
                saveChannels();
                updatePlaylist();
                addSystemMessage('üóëÔ∏è Playlist temizlendi.', true);
            }
        }

        // ========== ABONELƒ∞K ==========
        function subscribeChannel(ch) {
            if (!channels[ch]) channels[ch] = { name: ch, owner: 'Sistem', ownerRole: 'user', subscribers: 1000, online: 0, isHidden: false, currentVideo: 'dQw4w9WgXcQ', currentTitle: `${ch} kanalƒ±`, currentArtist: 'üë§ Sistem', playlist: [], onlineUsers: [] };
            if (!ACTIVE_USER.subscribedChannels.includes(ch)) {
                ACTIVE_USER.subscribedChannels.push(ch);
                channels[ch].subscribers = (channels[ch].subscribers || 1000) + 1;
                saveChannels();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                addSystemMessage(`‚úÖ #${ch} abone olundu!`, true);
                updateAllBadges(); updateSubsIfNeeded(); updatePopularChannels();
            }
        }

        function unsubscribeChannel(ch) {
            let i = ACTIVE_USER.subscribedChannels.indexOf(ch); if (i > -1) {
                ACTIVE_USER.subscribedChannels.splice(i, 1);
                if (channels[ch]) channels[ch].subscribers = Math.max(0, (channels[ch].subscribers || 1000) - 1);
                saveChannels();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                addSystemMessage(`‚ùå #${ch} abonelikten √ßƒ±kƒ±ldƒ±.`, true);
                updateAllBadges(); updateSubsIfNeeded(); updatePopularChannels();
            }
        }

        function toggleChannelSubscribe() {
            if (ACTIVE_USER.subscribedChannels.includes(currentChannel)) unsubscribeChannel(currentChannel);
            else subscribeChannel(currentChannel);
        }

        function updateAllBadges() {
            document.getElementById('subscriptionBadge').textContent = ACTIVE_USER.subscribedChannels.length;
            let subCountEl = document.getElementById('subscriptionCount');
            if (subCountEl) subCountEl.textContent = ACTIVE_USER.subscribedChannels.length;
            document.getElementById('channelCountBadge').textContent = Object.keys(channels).length;
            updateUnreadBadge();
        }

        function updateSubsIfNeeded() {
            if (document.querySelector('.panel-header h3')?.innerText.includes('Abonelikler')) loadSubscriptionsPanel(document.getElementById('leftPanel'));
            if (document.querySelector('.panel-header h3')?.innerText.includes('T√ºm Kanallar')) loadChannelsPanel(document.getElementById('leftPanel'));
        }

        // ========== MESAJ G√ñNDER ==========
        function sendMessage() {
            MateBot.checkSpam();
            let inp = document.getElementById('messageInput'); 
            let txt = inp.value.trim();
            if (!txt) return;
            
            if (txt.startsWith('/')) { 
                if (typeof handleCommand === 'function') {
                    handleCommand(txt);
                } else {
                    console.error('handleCommand fonksiyonu bulunamadƒ±!');
                    addSystemMessage('‚ùå Komut sistemi y√ºklenemedi!', true);
                }
                inp.value = ''; 
                autoResize(inp); 
                return; 
            }
            
            let banned = checkBannedWords(txt);
            if (banned) {
                addSystemMessage(`üö´ Yasaklƒ± kelime tespit edildi: "${banned}". Mesajƒ±nƒ±z g√∂nderilmedi.`, true);
                MateBot.sendToAdmin(`‚ö†Ô∏è ${ACTIVE_USER.name} genel sohbette yasaklƒ± kelime kullandƒ±: ${banned}`);
                inp.value = ''; autoResize(inp); return;
            }

            if (database && currentChannel) {
                database.ref('messages/' + currentChannel).push({
                    sender: ACTIVE_USER.name,
                    role: ACTIVE_USER.role,
                    text: txt,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                });
            }
            inp.value = ''; autoResize(inp);
        }

        // ========== CANLI YAYIN ==========
        function openLiveStreamModal() {
            let ch = channels[currentChannel];
            if (!(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || ch.coAdmins?.includes(ACTIVE_USER.name))) {
                alert('Yetkiniz yok!'); return;
            }
            const streamKey = prompt('YouTube Canlƒ± Yayƒ±n Anahtarƒ± (sim√ºlasyon):', '');
            if (streamKey) {
                addSystemMessage(`üìπ ${ACTIVE_USER.name} canlƒ± yayƒ±n ba≈ülattƒ±! #${currentChannel}`, true);
                ch.currentVideo = 'jfKfPfyJRdk';
                if (ytPlayer) ytPlayer.loadVideoById(ch.currentVideo);
                ch.currentTitle = `üî¥ CANLI YAYIN - ${ACTIVE_USER.name}`;
                document.getElementById('nowPlayingTitle').innerHTML = `üî¥ CANLI YAYIN - ${ACTIVE_USER.name}`;
                MateBot.sendToAdmin(`${ACTIVE_USER.name}, #${currentChannel} kanalƒ±nda canlƒ± yayƒ±n ba≈ülattƒ±.`);
                saveChannels();
            }
        }

        // ========== KANALI ≈ûƒ∞KAYET ET ==========
        function reportChannel() {
            let reason = prompt('Bu kanalƒ± neden ≈üikayet ediyorsunuz?', '');
            let msg = `üö© ${ACTIVE_USER.name}, #${currentChannel} kanalƒ±nƒ± ≈üikayet etti.` + (reason ? ` Sebep: ${reason}` : '');
            addSystemMessage(msg, true); MateBot.sendToAdmin(msg);
        }

        // ========== YOUTUBE ==========
        function onYouTubeIframeAPIReady() {
            let ch = channels[currentChannel];
            ytPlayer = new YT.Player('youtubeContainer', {
                height: '100%', width: '100%',
                videoId: ch.currentVideo,
                playerVars: { autoplay: 1, controls: 0, modestbranding: 1, rel: 0, disablekb: 1, fs: 0, iv_load_policy: 3, playsinline: 1 },
                events: {
                    onReady: e => e.target.playVideo(),
                    onStateChange: e => {
                        document.getElementById('playPauseIcon').className = e.data === YT.PlayerState.PLAYING ? 'fas fa-pause' : 'fas fa-play';
                        isPlaying = e.data === YT.PlayerState.PLAYING;
                    }
                }
            });
        }

        function toggleMute() { if (!ytPlayer) return; if (isMuted) { ytPlayer.unMute(); document.getElementById('muteIcon').className = 'fas fa-volume-up'; } else { ytPlayer.mute(); document.getElementById('muteIcon').className = 'fas fa-volume-mute'; } isMuted = !isMuted; }
        function togglePlayPause() { if (!ytPlayer) return; if (isPlaying) ytPlayer.pauseVideo(); else ytPlayer.playVideo(); }

        function autoResize(t) { t.style.height = 'auto'; t.style.height = Math.min(t.scrollHeight, 80) + 'px'; }
        function escapeHTML(t) { if (!t) return ''; let d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // ========== KANAL OLU≈ûTUR ==========
        function createChannel() {
            if (ACTIVE_USER.role !== 'owner' && ACTIVE_USER.myChannel) { alert('Zaten bir kanalƒ±nƒ±z var!'); return; }
            let name = document.getElementById('newChannelName')?.value?.toLowerCase().trim();
            if (!name) { alert('Kanal adƒ± girin!'); return; }
            if (channels[name]) { alert('Bu kanal adƒ± zaten mevcut!'); return; }
            let desc = document.getElementById('newChannelDesc')?.value?.trim() || `${ACTIVE_USER.name} tarafƒ±ndan olu≈üturuldu.`;
            channels[name] = {
                name, owner: ACTIVE_USER.name, ownerRole: 'coadmin', coAdmins: [ACTIVE_USER.name], operators: [],
                subscribers: 1, online: 1, description: desc, isPrivate: false, isHidden: false,
                currentVideo: 'jfKfPfyJRdk', currentTitle: 'CETCETY Radio', currentArtist: `üëë ${ACTIVE_USER.name}`,
                playlist: [{ id: 'jfKfPfyJRdk', title: 'CETCETY Radio', addedBy: ACTIVE_USER.name, role: 'coadmin' }],
                onlineUsers: [ACTIVE_USER.name]
            };
            saveChannels();
            ACTIVE_USER.myChannel = name;
            if (ACTIVE_USER.role !== 'owner') ACTIVE_USER.role = 'coadmin';
            if (!ACTIVE_USER.subscribedChannels.includes(name)) ACTIVE_USER.subscribedChannels.push(name);
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
            updateAllBadges(); addSystemMessage(`‚úÖ #${name} kanalƒ± olu≈üturuldu!`, true); joinChannel(name); loadLeftPanel('channels');
        }

        // ========== PROFƒ∞L FONKSƒ∞YONLARI ==========
        function changeAvatar() {
            let em = prompt('Avatar olarak bir emoji veya harf girin (tek karakter):', ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase());
            if (em && em.length > 0) {
                ACTIVE_USER.avatar = em.charAt(0).toUpperCase();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                loadLeftPanel('profile');
                document.getElementById('avatarText').textContent = em.charAt(0).toUpperCase();
                addSystemMessage('‚úÖ Avatar g√ºncellendi.', true);
            }
        }

        function changeNick() {
            let newNick = document.getElementById('profileNick')?.value.trim();
            if (!newNick) return;
            if (USERS_DB.find(u => u.name.toLowerCase() === newNick.toLowerCase() && u.id !== ACTIVE_USER.id)) {
                alert('Bu kullanƒ±cƒ± adƒ± zaten kullanƒ±lƒ±yor!'); return;
            }
            ACTIVE_USER.name = newNick;
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
            const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
            if (index !== -1) USERS_DB[index] = ACTIVE_USER;
            localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            document.getElementById('avatarText').textContent = newNick.charAt(0).toUpperCase();
            loadLeftPanel('profile');
            addSystemMessage(`‚úÖ Kullanƒ±cƒ± adƒ± deƒüi≈ütirildi: ${newNick}`, true);
        }

        function changePassword() {
            let pwd = document.getElementById('profilePassword')?.value.trim();
            if (pwd) {
                ACTIVE_USER.password = pwd;
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage('‚úÖ ≈ûifre g√ºncellendi.', true);
                document.getElementById('profilePassword').value = '';
            } else alert('≈ûifre bo≈ü olamaz!');
        }

        function changePrivateMode() {
            let mode = document.getElementById('privateModeSelect')?.value;
            if (mode) {
                ACTIVE_USER.privateMode = mode;
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`üîí √ñzel sohbet modu: ${mode==='all'?'Herkese A√ßƒ±k':mode==='none'?'Herkese Kapalƒ±':'Sadece Engellenenler'}`, true);
            }
        }

        function blockSpecificNick() {
            let nick = document.getElementById('blockNickInput')?.value.trim();
            if (!nick) return;
            if (!ACTIVE_USER.blockedNicks) ACTIVE_USER.blockedNicks = [];
            if (!ACTIVE_USER.blockedNicks.includes(nick)) {
                ACTIVE_USER.blockedNicks.push(nick);
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`üö´ ${nick} engellendi.`, true);
                loadLeftPanel('profile');
            }
        }

        function unblockNick(nick) {
            if (ACTIVE_USER.blockedNicks) {
                ACTIVE_USER.blockedNicks = ACTIVE_USER.blockedNicks.filter(n => n !== nick);
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`‚úÖ ${nick} engeli kaldƒ±rƒ±ldƒ±.`, true);
                loadLeftPanel('profile');
            }
        }

        function deleteMyChannel() {
            if (!ACTIVE_USER.myChannel) return;
            if (confirm(`#${ACTIVE_USER.myChannel} kanalƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?`)) {
                delete channels[ACTIVE_USER.myChannel];
                saveChannels();
                ACTIVE_USER.myChannel = null;
                if (ACTIVE_USER.role !== 'owner') ACTIVE_USER.role = 'user';
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage('üóëÔ∏è Kanalƒ±nƒ±z silindi.', true);
                updateAllBadges();
                joinChannel('genel');
                loadLeftPanel('profile');
            }
        }

        // ========== GLOBAL FONKSƒ∞YONLARI WINDOW'A EKLE ==========
        window.database = database;
        window.storage = storage;
        window.USERS_DB = USERS_DB;
        window.ACTIVE_USER = ACTIVE_USER;
        window.BLOCKED_USERS = BLOCKED_USERS;
        window.BANNED_WORDS = BANNED_WORDS;
        window.CUSTOM_COMMANDS = CUSTOM_COMMANDS;
        window.channels = channels;
        window.currentChannel = currentChannel;
        window.MateBot = MateBot;
        window.addSystemMessage = addSystemMessage;
        window.joinChannel = joinChannel;
        window.openPrivateChat = openPrivateChat;
        window.sendPrivateMessage = sendPrivateMessage;
        window.saveChannels = saveChannels;
        window.getRoleLevel = getRoleLevel;
        window.updatePlaylist = updatePlaylist;
        window.appendPrivateMessage = appendPrivateMessage;
        window.handleMessageKeyDown = handleMessageKeyDown;
        window.handlePrivateKeyDown = handlePrivateKeyDown;

        // T√ºm fonksiyonlarƒ± window'a ekle
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.handleLogin = handleLogin;
        window.logout = logout;
        window.toggleTheme = toggleTheme;
        window.closeAllPanels = closeAllPanels;
        window.closeLeftPanel = closeLeftPanel;
        window.openSubscriptions = openSubscriptions;
        window.openChannelPanel = openChannelPanel;
        window.openChatListPanel = openChatListPanel;
        window.openCreateChannelPanel = openCreateChannelPanel;
        window.openNotificationPanel = openNotificationPanel;
        window.openSupportPanel = openSupportPanel;
        window.openProfilePanel = openProfilePanel;
        window.showHome = showHome;
        window.switchChatTab = switchChatTab;
        window.joinChannel = joinChannel;
        window.toggleChannelSubscribe = toggleChannelSubscribe;
        window.sendMessage = sendMessage;
        window.autoResize = autoResize;
        window.openPrivateChat = openPrivateChat;
        window.closePrivateChat = closePrivateChat;
        window.sendPrivateMessage = sendPrivateMessage;
        window.triggerPrivateImageUpload = triggerPrivateImageUpload;
        window.sendPrivateImageFile = sendPrivateImageFile;
        window.triggerPrivateVideoUpload = triggerPrivateVideoUpload;
        window.sendPrivateVideoFile = sendPrivateVideoFile;
        window.blockUser = blockUser;
        window.reportUser = reportUser;
        window.switchPrivateTab = switchPrivateTab;
        window.openOwnerPanel = openOwnerPanel;
        window.closeOwnerPanel = closeOwnerPanel;
        window.openAdminPanel = openAdminPanel;
        window.closeAdminPanel = closeAdminPanel;
        window.openCoAdminPanel = openCoAdminPanel;
        window.closeCoAdminPanel = closeCoAdminPanel;
        window.openOperatorPanel = openOperatorPanel;
        window.closeOperatorPanel = closeOperatorPanel;
        window.ownerChangeRole = ownerChangeRole;
        window.ownerDeleteUser = ownerDeleteUser;
        window.ownerToggleHideChannel = ownerToggleHideChannel;
        window.ownerDeleteChannel = ownerDeleteChannel;
        window.ownerCreateChannel = ownerCreateChannel;
        window.ownerAddBannedWord = ownerAddBannedWord;
        window.ownerRemoveBannedWord = ownerRemoveBannedWord;
        window.ownerAddCustomCommand = ownerAddCustomCommand;
        window.ownerRemoveCommand = ownerRemoveCommand;
        window.ownerClearAllMessages = ownerClearAllMessages;
        window.ownerResetAllData = ownerResetAllData;
        window.createBot = createBot;
        window.deleteBot = deleteBot;
        window.ownerViewAllPrivateChats = ownerViewAllPrivateChats;
        window.adminChangeRole = adminChangeRole;
        window.adminDeleteUser = adminDeleteUser;
        window.adminToggleHideChannel = adminToggleHideChannel;
        window.adminDeleteChannel = adminDeleteChannel;
        window.coadminAddOperator = coadminAddOperator;
        window.coadminRemoveOperator = coadminRemoveOperator;
        window.coadminRemoveOperatorByName = coadminRemoveOperatorByName;
        window.toggleChannelHidden = toggleChannelHidden;
        window.playVideo = playVideo;
        window.removeFromPlaylist = removeFromPlaylist;
        window.openAddMediaModal = openAddMediaModal;
        window.clearPlaylist = clearPlaylist;
        window.subscribeChannel = subscribeChannel;
        window.unsubscribeChannel = unsubscribeChannel;
        window.openLiveStreamModal = openLiveStreamModal;
        window.reportChannel = reportChannel;
        window.toggleMute = toggleMute;
        window.togglePlayPause = togglePlayPause;
        window.createChannel = createChannel;
        window.changeAvatar = changeAvatar;
        window.changeNick = changeNick;
        window.changePassword = changePassword;
        window.changePrivateMode = changePrivateMode;
        window.blockSpecificNick = blockSpecificNick;
        window.unblockNick = unblockNick;
        window.deleteMyChannel = deleteMyChannel;
        window.sendSupportTicket = sendSupportTicket;

        // ========== BA≈ûLANGI√á ==========
        document.addEventListener('DOMContentLoaded', function () {
            if (localStorage.getItem('cetcety_theme') === 'light') document.body.classList.add('light-theme');
            ACTIVE_USER = JSON.parse(localStorage.getItem('cetcety_active_user'));
            window.ACTIVE_USER = ACTIVE_USER;
            
            if (ACTIVE_USER) {
                if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                    channels.genel.onlineUsers.push(ACTIVE_USER.name);
                    saveChannels();
                }
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').style.display = 'flex';
                updateUIForUser();
                loadLeftPanel('subscriptions');
                updateAllBadges();
                updatePlaylist();

                document.getElementById('ownerPanelIcon').style.display = 'none';
                document.getElementById('adminPanelIcon').style.display = 'none';
                document.getElementById('coadminPanelIcon').style.display = 'none';
                document.getElementById('operatorPanelIcon').style.display = 'none';

                if (ACTIVE_USER.role === 'owner') {
                    document.getElementById('ownerPanelIcon').style.display = 'flex';
                } else if (ACTIVE_USER.role === 'admin') {
                    document.getElementById('adminPanelIcon').style.display = 'flex';
                } else if (ACTIVE_USER.role === 'coadmin') {
                    document.getElementById('coadminPanelIcon').style.display = 'flex';
                } else if (ACTIVE_USER.role === 'operator') {
                    document.getElementById('operatorPanelIcon').style.display = 'flex';
                }

                initOnlineStatus();
                listenToMessages();
                listenToPrivateMessages();

                MateBot.init();
                addSystemMessage(`üëã Tekrar ho≈ü geldin, ${ACTIVE_USER.name}!`, true);
                
                // IRC sistemini ba≈ülat
                if (typeof initIRCSystem === 'function') {
                    initIRCSystem();
                }
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('app').style.display = 'none';
            }
            if (!window.YT) { let s = document.createElement('script'); s.src = 'https://www.youtube.com/iframe_api'; document.getElementsByTagName('script')[0].parentNode.insertBefore(s, document.getElementsByTagName('script')[0]); }
        });
    </script>
</body>
</html>
