<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY ‚Ä¢ Firebase S√ºr√ºm√º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Stiller aynen korundu (orijinal CETCETY CSS) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0f0f0f; color: #fff; overflow: hidden; height: 100vh; transition: 0.2s; }
        body.light-theme { background: #f5f5f5; color: #1a1a1a; }
        .app { display: flex; height: 100vh; width: 100vw; position: relative; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        body.light-theme ::-webkit-scrollbar-track { background: #ddd; }
        ::-webkit-scrollbar-thumb { background: #3f3f3f; border-radius: 3px; }
        body.light-theme ::-webkit-scrollbar-thumb { background: #aaa; }

        /* Giri≈ü Ekranƒ± */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.3s;
        }
        .login-overlay.hidden { display: none; }
        .login-panel {
            width: 360px; background: rgba(20,20,20,0.6); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 32px; backdrop-filter: blur(10px); color: #fff;
        }
        body.light-theme .login-panel { background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); color: #333; }
        .login-panel h2 { text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .login-panel label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; }
        body.light-theme .login-panel label { color: #666; }
        .login-panel input {
            width: 100%; padding: 12px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: #fff; font-size: 14px; outline: none;
        }
        body.light-theme .login-panel input { background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.2); color: #333; }
        .login-panel input:focus { border-color: #ff0000; }
        .login-panel button {
            width: 100%; padding: 14px; background: #ff0000; border: none; border-radius: 8px;
            color: #fff; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.2s; margin-top: 8px;
        }
        .login-panel button:hover { background: #cc0000; }
        .login-info { text-align: center; margin-top: 16px; font-size: 12px; color: #aaa; }

        /* Sol ƒ∞kon Paneli */
        .icon-panel {
            width: 72px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; align-items: center; padding: 24px 0; gap: 24px;
            flex-shrink: 0; z-index: 20; transition: 0.2s;
        }
        body.light-theme .icon-panel { background: #fff; border-right: 1px solid #ddd; }
        .icon-item {
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer; transition: 0.2s; font-size: 20px; position: relative;
        }
        .icon-item:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .icon-item:hover { background: #e0e0e0; color: #333; }
        .icon-item.active { color: #fff; background: #ff0000; }
        .icon-badge {
            position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; border-radius: 50%;
            background: #ff4444; color: white; font-size: 10px; display: flex; align-items: center;
            justify-content: center; border: 2px solid #0a0a0a;
        }
        body.light-theme .icon-badge { border: 2px solid #fff; }
        .profile-avatar {
            margin-top: auto; width: 48px; height: 48px; border-radius: 50%;
            background: #1a1a1a; border: 2px solid #3f3f3f; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; color: #fff; position: relative;
        }
        body.light-theme .profile-avatar { background: #ddd; border: 2px solid #aaa; color: #333; }

        /* Ana ƒ∞√ßerik */
        .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* Sol Panel */
        .left-panel {
            width: 320px; background: #0a0a0a; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 15;
        }
        body.light-theme .left-panel { background: #fff; border-right: 1px solid #ddd; }
        .panel-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        body.light-theme .panel-header { border-bottom: 1px solid #ddd; }
        .panel-header h3 {
            display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #fff;
        }
        body.light-theme .panel-header h3 { color: #333; }
        .panel-close {
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .panel-close:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .panel-close:hover { background: #ddd; color: #333; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* Sekmeler */
        .panel-tabs {
            display: flex; border-bottom: 1px solid #2a2a2a; background: #0a0a0a;
        }
        body.light-theme .panel-tabs { background: #fff; border-bottom: 1px solid #ddd; }
        .panel-tab {
            flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600;
            color: #aaa; cursor: pointer; transition: 0.2s;
        }
        .panel-tab:hover { background: #1a1a1a; color: #fff; }
        .panel-tab.active { color: #fff; border-bottom: 2px solid #ff0000; }
        body.light-theme .panel-tab.active { color: #333; }

        /* Arama */
        .search-container {
            display: flex; align-items: center; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 30px;
            padding: 0 16px; margin-bottom: 20px;
        }
        body.light-theme .search-container { background: #f0f0f0; border: 1px solid #ccc; }
        .search-container i { color: #aaa; font-size: 14px; }
        body.light-theme .search-container i { color: #666; }
        .search-input {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 15px;
            padding: 14px 8px; outline: none;
        }
        body.light-theme .search-input { color: #333; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: #aaa; margin-bottom: 6px; }
        body.light-theme .form-label { color: #666; }
        .form-input, .form-select {
            width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px;
            color: #fff; font-size: 14px; outline: none;
        }
        body.light-theme .form-input, body.light-theme .form-select { background: #f0f0f0; border: 1px solid #ccc; color: #333; }
        .form-input:focus { border-color: #ff0000; }
        .form-button {
            width: 100%; padding: 12px; background: #ff0000; border: none; border-radius: 8px;
            color: #fff; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .form-button:hover { background: #cc0000; }
        .form-button.secondary { background: #2a2a2a; color: #fff; }
        body.light-theme .form-button.secondary { background: #ddd; color: #333; }
        .form-button.secondary:hover { background: #3f3f3f; }
        .form-button.danger { background: #6d0000; }
        .form-button.danger:hover { background: #8a0000; }
        .info-box {
            background: #1a1a1a; border-left: 4px solid #ff0000; padding: 16px; border-radius: 8px; margin-bottom: 16px;
        }
        body.light-theme .info-box { background: #f9f9f9; }
        .info-box p { color: #aaa; font-size: 13px; line-height: 1.5; }
        body.light-theme .info-box p { color: #666; }

        /* Liste √ñƒüeleri */
        .subscription-item, .channel-item, .chat-item, .online-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px;
            cursor: pointer; margin-bottom: 4px; transition: 0.2s;
        }
        .subscription-item:hover, .channel-item:hover, .chat-item:hover, .online-item:hover { background: #1a1a1a; }
        body.light-theme .subscription-item:hover, body.light-theme .channel-item:hover,
        body.light-theme .chat-item:hover, body.light-theme .online-item:hover { background: #f0f0f0; }
        .subscription-item.active { background: #1a1a1a; border-left: 4px solid #ff0000; }
        .subscription-avatar, .channel-avatar, .chat-avatar, .online-avatar, .profile-avatar-panel {
            width: 36px; height: 36px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000; font-size: 16px; flex-shrink: 0;
        }
        body.light-theme .subscription-avatar, body.light-theme .channel-avatar,
        body.light-theme .chat-avatar, body.light-theme .online-avatar,
        body.light-theme .profile-avatar-panel { background: #ddd; color: #ff0000; }
        .online-avatar { background: #0a5c36; color: #fff; }
        .profile-avatar-panel { background: #ff0000; color: #fff; }
        .subscription-info, .channel-info, .chat-info, .online-info { flex: 1; min-width: 0; }
        .subscription-name, .channel-name, .chat-name, .online-name {
            font-weight: 600; font-size: 14px; color: #fff; display: flex; align-items: center; gap: 6px;
        }
        body.light-theme .subscription-name, body.light-theme .channel-name,
        body.light-theme .chat-name, body.light-theme .online-name { color: #333; }
        .online-status { width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; margin-left: 4px; }
        .subscription-meta, .channel-meta, .chat-meta, .online-meta {
            font-size: 11px; color: #aaa; margin-top: 2px; display: flex; align-items: center; gap: 8px;
        }
        body.light-theme .subscription-meta, body.light-theme .channel-meta,
        body.light-theme .chat-meta, body.light-theme .online-meta { color: #666; }
        .subscription-stats { font-size: 11px; color: #aaa; text-align: right; }
        
        /* Yetki Badge'leri */
        .badge {
            display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px;
            border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 6px;
            background: transparent;
            border: 1px solid;
        }
        .badge-owner { color: #ffd700; border-color: rgba(255,215,0,0.5); }
        .badge-admin { color: #ff6b6b; border-color: rgba(255,107,107,0.5); }
        .badge-coadmin { color: #6495ed; border-color: rgba(100,149,237,0.5); }
        .badge-operator { color: #ffa500; border-color: rgba(255,165,0,0.5); }
        .badge-hidden { color: #aaa; border-color: rgba(170,170,170,0.5); }

        /* Pop√ºler */
        .popular-channels { margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a2a2a; }
        body.light-theme .popular-channels { border-top: 1px solid #ddd; }
        .popular-header { display: flex; align-items: center; gap: 8px; color: #ffd700; font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .popular-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 2px; }
        .popular-item:hover { background: #1a1a1a; }
        body.light-theme .popular-item:hover { background: #f0f0f0; }
        .popular-info { flex: 1; }
        .popular-name { font-weight: 500; font-size: 13px; color: #fff; display: flex; align-items: center; gap: 6px; }
        body.light-theme .popular-name { color: #333; }
        .popular-subscribers { font-size: 10px; color: #aaa; }
        .subscribe-btn {
            padding: 6px 12px; background: #ff0000; border: none; border-radius: 20px;
            color: #fff; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .subscribe-btn.subscribed { background: #272727; color: #ffd700; }
        body.light-theme .subscribe-btn.subscribed { background: #ddd; color: #666; }

        /* Chat Paneli */
        .chat-container {
            flex: 1; display: flex; flex-direction: column; min-width: 0; background: #0f0f0f;
            position: relative;
        }
        body.light-theme .chat-container { background: #f9f9f9; }
        .chat-header {
            padding: 16px 24px; border-bottom: 1px solid #2a2a2a; display: flex;
            align-items: center; justify-content: space-between;
        }
        body.light-theme .chat-header { border-bottom: 1px solid #ddd; }
        .chat-title { display: flex; align-items: center; gap: 12px; font-weight: 600; color: #fff; }
        body.light-theme .chat-title { color: #333; }
        .chat-title i { color: #ff0000; }
        .channel-info-bar { display: flex; align-items: center; gap: 16px; color: #aaa; font-size: 13px; }
        body.light-theme .channel-info-bar { color: #666; }
        .channel-subscribe-btn {
            padding: 6px 16px; background: #272727; border: 1px solid #3f3f3f; border-radius: 20px;
            color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        body.light-theme .channel-subscribe-btn { background: #ddd; border: 1px solid #ccc; color: #333; }
        .channel-subscribe-btn.subscribed { background: #ff0000; border-color: #ff0000; color: #fff; }
        .messages {
            flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }
        .message {
            display: flex; flex-direction: column; max-width: 70%; animation: fadeIn 0.2s;
        }
        .message.right { align-self: flex-end; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .message-sender { font-weight: 600; font-size: 13px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        body.light-theme .message-sender { color: #333; }
        .message-time { font-size: 11px; color: #aaa; }
        .message-text {
            font-size: 14px; line-height: 1.5; color: #fff; word-break: break-word;
            background: transparent;
            padding: 0;
        }
        body.light-theme .message-text { color: #333; }
        .message.right .message-text { color: #ff0000; }
        .system-message {
            align-self: center; color: #aaa; font-size: 12px; padding: 8px 16px;
            background: #1a1a1a; border-radius: 20px; margin: 8px 0; border: 1px solid #2a2a2a;
        }
        body.light-theme .system-message { background: #e0e0e0; color: #666; border: 1px solid #ccc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-input-container {
            padding: 20px 24px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        body.light-theme .message-input-container { background: #fff; border-top: 1px solid #ddd; }
        .input-wrapper {
            display: flex; align-items: center; gap: 12px; background: #1a1a1a;
            border: 1px solid #2a2a2a; border-radius: 28px; padding: 4px 4px 4px 20px;
        }
        body.light-theme .input-wrapper { background: #f0f0f0; border: 1px solid #ccc; }
        .message-input {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 14px;
            padding: 12px 0; resize: none; max-height: 80px; outline: none;
        }
        body.light-theme .message-input { color: #333; }
        .send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #2a2a2a; border: 1px solid #3f3f3f;
            color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .send-btn:hover { background: #ff0000; border-color: #ff0000; }

        /* √ñzel Sohbet Paneli */
        .private-chat-panel {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; background: #0a0a0a; display: none;
            flex-direction: column; z-index: 30;
        }
        body.light-theme .private-chat-panel { background: #fff; }
        .private-chat-panel.active { display: flex; }
        .private-chat-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; justify-content: space-between;
        }
        .private-chat-user { display: flex; align-items: center; gap: 12px; }
        .private-chat-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000;
        }
        .private-chat-info h4 { font-size: 14px; font-weight: 600; color: #fff; }
        .private-chat-info span { font-size: 11px; color: #aaa; }
        .private-chat-actions { display: flex; gap: 12px; }
        .private-chat-action {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .private-chat-action:hover { background: #1a1a1a; color: #fff; }
        body.light-theme .private-chat-action:hover { background: #ddd; color: #333; }
        .private-tabs {
            display: flex; border-bottom: 1px solid #2a2a2a;
        }
        .private-tab {
            flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600;
            color: #aaa; cursor: pointer; transition: 0.2s;
        }
        .private-tab:hover { background: #1a1a1a; color: #fff; }
        .private-tab.active { color: #fff; border-bottom: 2px solid #ff0000; }
        body.light-theme .private-tab.active { color: #333; }
        .private-chat-messages {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;
        }
        .private-message {
            display: flex; flex-direction: column; max-width: 80%;
        }
        .private-message.right { align-self: flex-end; }
        .private-message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .private-message-sender { font-weight: 600; font-size: 12px; color: #fff; }
        .private-message-time { font-size: 10px; color: #aaa; }
        .private-message-text {
            font-size: 13px; line-height: 1.4; color: #fff; word-break: break-word;
            background: transparent;
            padding: 0;
        }
        .private-message.right .private-message-text { color: #ff0000; }
        .private-message-media { margin-top: 8px; border-radius: 12px; overflow: hidden; }
        .private-message-media img, .private-message-media video {
            width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px; cursor: pointer;
        }
        .delete-msg {
            position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%;
            background: #ff4444; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; opacity: 0; transition: 0.2s; z-index: 5;
        }
        .private-message:hover .delete-msg { opacity: 1; }
        .private-input-container {
            padding: 20px; background: #0a0a0a; border-top: 1px solid #2a2a2a;
        }
        body.light-theme .private-input-container { background: #fff; border-top: 1px solid #ddd; }
        .private-input-wrapper { display: flex; flex-direction: column; gap: 12px; }
        .private-media-actions { display: flex; gap: 12px; padding: 0 4px; }
        .private-media-btn {
            width: 36px; height: 36px; border-radius: 50%; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #aaa; cursor: pointer;
        }
        .private-media-btn:hover { background: #2a2a2a; color: #fff; }
        body.light-theme .private-media-btn { background: #ddd; color: #666; }
        body.light-theme .private-media-btn:hover { background: #ccc; color: #333; }
        .private-text-input { display: flex; gap: 12px; }
        .private-input {
            flex: 1; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 24px;
            padding: 12px 16px; color: #fff; font-size: 13px; resize: none; outline: none;
        }
        body.light-theme .private-input { background: #f0f0f0; border: 1px solid #ccc; color: #333; }
        .private-send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #2a2a2a; border: 1px solid #3f3f3f;
            color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .private-send-btn:hover { background: #ff0000; border-color: #ff0000; }

        /* Medya Paneli */
        .media-panel {
            width: 420px; background: #0a0a0a; border-left: 1px solid #2a2a2a;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        body.light-theme .media-panel { background: #fff; border-left: 1px solid #ddd; }
        .media-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a2a; display: flex;
            align-items: center; justify-content: space-between;
        }
        body.light-theme .media-header { border-bottom: 1px solid #ddd; }
        .media-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; color: #fff; }
        body.light-theme .media-title { color: #333; }
        .media-controls { display: flex; gap: 8px; }
        .media-control {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: #aaa; cursor: pointer;
        }
        .media-control:hover { background: #1a1a1a; color: #fff; }
        body.light-theme .media-control:hover { background: #ddd; color: #333; }
        .media-control.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .youtube-player { width: 100%; aspect-ratio: 16/9; background: #000; border-bottom: 1px solid #2a2a2a; position: relative; }
        #youtubeContainer { width: 100%; height: 100%; }
        .player-controls {
            position: absolute; bottom: 16px; left: 0; right: 0; display: flex;
            justify-content: center; gap: 20px; z-index: 10;
        }
        .player-btn {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.7);
            border: 2px solid #fff; color: #fff; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s; font-size: 18px;
        }
        .player-btn:hover { background: #ff0000; border-color: #ff0000; }
        .now-playing {
            padding: 12px 20px; background: #0f0f0f; border-bottom: 1px solid #2a2a2a;
            display: flex; align-items: center; gap: 12px; font-size: 13px; color: #fff;
        }
        body.light-theme .now-playing { background: #f5f5f5; border-bottom: 1px solid #ddd; color: #333; }
        .playlist-container { flex: 1; overflow-y: auto; padding: 20px; }
        .playlist-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #2a2a2a;
        }
        body.light-theme .playlist-header { border-bottom: 1px solid #ddd; }
        .playlist-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; color: #fff; }
        body.light-theme .playlist-title { color: #333; }
        .playlist-count { color: #aaa; font-size: 12px; }
        .playlist-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px;
            margin-bottom: 4px; cursor: pointer; transition: 0.2s;
        }
        .playlist-item:hover { background: #1a1a1a; }
        body.light-theme .playlist-item:hover { background: #f0f0f0; }
        .playlist-item.active { background: #1a1a1a; border-left: 4px solid #ff0000; }
        .playlist-thumb {
            width: 48px; height: 48px; border-radius: 6px; background: #1a1a1a;
            display: flex; align-items: center; justify-content: center; color: #ff0000; font-size: 24px; flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Giri≈ü Ekranƒ± -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-panel">
            <h2>üéß CETCETY</h2>
            <div class="form-group">
                <label>Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="loginNick" placeholder="√∂rn: mateky" autocomplete="off">
            </div>
            <div class="form-group">
                <label>≈ûifre</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button onclick="handleLogin()">Giri≈ü Yap / Kayƒ±t Ol</button>
            <div class="login-info">Yeni kullanƒ±cƒ±lar sadece nick yazarak girebilir.</div>
        </div>
    </div>

    <!-- Ana Uygulama -->
    <div id="app" class="app" style="display: none;">
        <!-- Sol ƒ∞kon Paneli -->
        <div class="icon-panel">
            <div class="icon-item" onclick="showHome()" title="Ana Sayfa"><i class="fas fa-home"></i></div>
            <div class="icon-item" onclick="openSubscriptions()" title="Abonelikler"><i class="fas fa-bell"></i><span class="icon-badge" id="subscriptionBadge">0</span></div>
            <div class="icon-item" onclick="openChannelPanel()" title="Kanallar"><i class="fas fa-list-ul"></i><span class="icon-badge" id="channelCountBadge">0</span></div>
            <div class="icon-item" onclick="openChatListPanel()" title="Sohbetlerim"><i class="fas fa-comment"></i><span class="icon-badge" id="chatListBadge">0</span></div>
            <div class="icon-item" onclick="openCreateChannelPanel()" title="Kanal A√ß"><i class="fas fa-plus-circle"></i></div>
            <div class="icon-item" onclick="openNotificationPanel()" title="Bildirimler"><i class="fas fa-bell"></i><span class="icon-badge" id="notificationBadge">0</span></div>
            <div class="icon-item" onclick="openSupportPanel()" title="Destek"><i class="fas fa-headset"></i></div>
            <div class="icon-item" onclick="toggleTheme()" id="themeIcon" title="Tema Deƒüi≈ütir"><i class="fas fa-moon"></i></div>
            <div class="profile-avatar" id="profileAvatar" onclick="openProfilePanel()"><span id="avatarText">?</span></div>
        </div>

        <div class="main-content">
            <!-- Sol Panel (dinamik) -->
            <div class="left-panel" id="leftPanel"></div>

            <!-- Chat Paneli -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-hashtag"></i>
                        <span id="currentChannelName">genel</span>
                        <span class="channel-info-bar">
                            <span id="channelUserCount">0</span> √ßevrimi√ßi ‚Ä¢ 
                            <span id="channelSubscribers">0</span> abone
                        </span>
                    </div>
                    <button id="subscribeChannelBtn" class="channel-subscribe-btn" onclick="toggleChannelSubscribe()"><i class="fas fa-plus"></i> Abone Ol</button>
                </div>
                <div class="messages" id="messages">
                    <div class="system-message"><i class="fas fa-info-circle"></i> CETCETY'ye ho≈ü geldin! /help yazarak komutlarƒ± g√∂rebilirsin.</div>
                </div>
                <div class="message-input-container">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" placeholder="Mesaj yazƒ±n... /help" rows="1" oninput="autoResize(this)"></textarea>
                        <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>

                <!-- √ñzel Sohbet Paneli -->
                <div id="privateChatPanel" class="private-chat-panel">
                    <div class="private-chat-header">
                        <div class="private-chat-user">
                            <div class="private-chat-avatar" id="privateChatAvatar">üë§</div>
                            <div class="private-chat-info">
                                <h4 id="privateChatName">Kullanƒ±cƒ±</h4>
                                <span id="privateChatStatus">√áevrimi√ßi</span>
                            </div>
                        </div>
                        <div class="private-chat-actions">
                            <div class="private-chat-action" onclick="blockUser()" title="Engelle (24 saat)"><i class="fas fa-ban"></i></div>
                            <div class="private-chat-action" onclick="reportUser()" title="≈ûikayet Et"><i class="fas fa-flag"></i></div>
                            <div class="private-chat-action" onclick="closePrivateChat()" title="Kapat"><i class="fas fa-times"></i></div>
                        </div>
                    </div>
                    <div class="private-tabs">
                        <div class="private-tab active" onclick="switchPrivateTab('chat')">Sohbet</div>
                        <div class="private-tab" onclick="switchPrivateTab('voice')" title="Yakƒ±nda">Sesli</div>
                        <div class="private-tab" onclick="switchPrivateTab('video')" title="Yakƒ±nda">G√∂r√ºnt√ºl√º</div>
                        <div class="private-tab" onclick="switchPrivateTab('file')" title="Yakƒ±nda">Dosya</div>
                    </div>
                    <div class="private-chat-messages" id="privateChatMessages"></div>
                    <div class="private-input-container">
                        <div class="private-input-wrapper">
                            <div class="private-media-actions">
                                <div class="private-media-btn" onclick="triggerPrivateImageUpload()" title="Resim G√∂nder"><i class="fas fa-image"></i></div>
                                <div class="private-media-btn" onclick="triggerPrivateVideoUpload()" title="Video G√∂nder"><i class="fas fa-video"></i></div>
                                <input type="file" id="privateImageUpload" accept="image/*" style="display:none;" onchange="sendPrivateImageFile(this)">
                                <input type="file" id="privateVideoUpload" accept="video/*" style="display:none;" onchange="sendPrivateVideoFile(this)">
                            </div>
                            <div class="private-text-input">
                                <textarea id="privateMessageInput" class="private-input" placeholder="Mesaj yazƒ±n..." rows="1"></textarea>
                                <div class="private-send-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medya Paneli -->
            <div class="media-panel">
                <div class="media-header">
                    <div class="media-title"><i class="fab fa-youtube"></i><span id="currentChannelPlaylist">#genel playlist</span></div>
                    <div class="media-controls">
                        <div id="liveStreamBtn" class="media-control" onclick="openLiveStreamModal()" title="Canlƒ± Yayƒ±n"><i class="fas fa-video"></i></div>
                        <div id="hideChannelBtn" class="media-control" onclick="toggleChannelHidden()" title="Gizle/G√∂ster"><i id="hideIcon" class="fas fa-eye"></i></div>
                        <div id="reportChannelBtn" class="media-control" onclick="reportChannel()" title="≈ûikayet"><i class="fas fa-flag"></i></div>
                        <div id="addMediaBtn" class="media-control" onclick="openAddMediaModal()" title="Video ekle"><i class="fas fa-plus"></i></div>
                    </div>
                </div>
                <div class="youtube-player"><div id="youtubeContainer"></div>
                    <div class="player-controls">
                        <div class="player-btn" id="playerMuteBtn" onclick="toggleMute()"><i class="fas fa-volume-up" id="muteIcon"></i></div>
                        <div class="player-btn" id="playerPlayPauseBtn" onclick="togglePlayPause()"><i class="fas fa-pause" id="playPauseIcon"></i></div>
                    </div>
                </div>
                <div class="now-playing"><i class="fas fa-circle"></i><span id="nowPlayingTitle">CETCETY Radio</span><span id="nowPlayingOwner" style="color: #6495ed; margin-left: auto;">üëë MateKy</span></div>
                <div class="playlist-container">
                    <div class="playlist-header"><span class="playlist-title"><i class="fas fa-list"></i> Kanal Playlist</span><span class="playlist-count" id="playlistCount">1 video</span></div>
                    <div id="playlistItems" class="playlist-items"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== FIREBASE KONFƒ∞G ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // ========== GLOBAL ==========
        let ytPlayer, isMuted = false, isPlaying = true;
        let USERS_DB = JSON.parse(localStorage.getItem('cetcety_users')) || [];
        let ACTIVE_USER = null;
        let BLOCKED_USERS = JSON.parse(localStorage.getItem('cetcety_blocks')) || {};
        let BANNED_WORDS = JSON.parse(localStorage.getItem('cetcety_banned_words')) || ['spam', 'reklam', '≈üiddet', 'hakaret'];
        let CUSTOM_COMMANDS = JSON.parse(localStorage.getItem('cetcety_custom_commands')) || [];

        let currentPrivateChat = null;
        let currentChannel = 'genel';
        let messagesListener = null;
        let privateMessagesListener = null;
        let onlineUsersListener = null;
        let heartbeatInterval = null;

        const OWNER_PASSWORD = 'Sahi17407@SCM';

        // Kanallar (hala localStorage'da tutuluyor)
        let channels = JSON.parse(localStorage.getItem('cetcety_channels')) || {
            'genel': { name:'genel', owner:'MateKy', ownerRole:'owner', coAdmins:[], subscribers:15000000, online:15420, isHidden:false, currentVideo:'jfKfPfyJRdk', currentTitle:'CETCETY Radio', currentArtist:'üëë MateKy', playlist:[{id:'jfKfPfyJRdk',title:'CETCETY Radio',addedBy:'MateKy',role:'owner'}], onlineUsers:[] },
            'rock': { name:'rock', owner:'Mehmet', ownerRole:'coadmin', coAdmins:['Mehmet'], subscribers:1200000, online:1240, isHidden:false, currentVideo:'tAGnKpE4NCI', currentTitle:'Metallica - Nothing Else Matters', currentArtist:'üîß Mehmet', playlist:[{id:'tAGnKpE4NCI',title:'Metallica',addedBy:'Mehmet',role:'coadmin'}], onlineUsers:[] },
            'arabesk': { name:'arabesk', owner:'Ahmet', ownerRole:'coadmin', coAdmins:['Ahmet'], subscribers:892000, online:567, isHidden:false, currentVideo:'GrAchTdFqVg', currentTitle:'Ferdi Tayfur', currentArtist:'üîß Ahmet', playlist:[{id:'GrAchTdFqVg',title:'Ferdi Tayfur',addedBy:'Ahmet',role:'coadmin'}], onlineUsers:[] },
            'admin': { name:'admin', owner:'MateKy', ownerRole:'owner', coAdmins:['MateKy'], subscribers:5, online:2, isHidden:true, currentVideo:'jfKfPfyJRdk', currentTitle:'Admin Kanalƒ±', currentArtist:'üëë MateKy', playlist:[], onlineUsers:[] }
        };

        function saveChannels() {
            localStorage.setItem('cetcety_channels', JSON.stringify(channels));
        }

        // ========== ONLINE KULLANICI TAKƒ∞Bƒ∞ ==========
        function initOnlineStatus() {
            if (!database || !ACTIVE_USER) return;
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            const userRef = database.ref('onlineUsers/' + ACTIVE_USER.name);
            userRef.set({
                name: ACTIVE_USER.name,
                role: ACTIVE_USER.role,
                channel: currentChannel,
                lastSeen: Date.now()
            });

            // Sayfa kapanƒ±rken veya yenilenirken otomatik sil
            userRef.onDisconnect().remove();

            // Periyodik g√ºncelleme
            heartbeatInterval = setInterval(() => {
                userRef.update({
                    lastSeen: Date.now(),
                    channel: currentChannel
                });
            }, 15000);

            // T√ºm online kullanƒ±cƒ±larƒ± dinle
            if (onlineUsersListener) onlineUsersListener.off();
            onlineUsersListener = database.ref('onlineUsers').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const now = Date.now();
                const onlineNames = [];
                // Ge√ßerli online kullanƒ±cƒ±larƒ± topla
                Object.keys(users).forEach(name => {
                    const user = users[name];
                    if (now - user.lastSeen < 30000) { // 30 saniye i√ßinde g√ºncellendiyse online
                        onlineNames.push(name);
                    } else {
                        // Zaman a≈üƒ±mƒ±na uƒüramƒ±≈ü, sil
                        database.ref('onlineUsers/' + name).remove();
                    }
                });

                // T√ºm kanallarƒ±n onlineUsers listesini g√ºncelle
                Object.keys(channels).forEach(ch => {
                    channels[ch].onlineUsers = channels[ch].onlineUsers.filter(u => onlineNames.includes(u));
                });

                // Mevcut kanalƒ±n online sayƒ±sƒ±nƒ± g√ºncelle
                if (channels[currentChannel]) {
                    document.getElementById('channelUserCount').textContent = channels[currentChannel].onlineUsers.length;
                }

                // Sohbetler paneli a√ßƒ±ksa online tab'ƒ± g√ºncelle
                if (document.getElementById('tabOnline')?.classList.contains('active')) {
                    showOnlineTab();
                }
                // Sol paneldeki abonelikler/kanallar listesini g√ºncelle (isteƒüe baƒülƒ±)
                saveChannels();
            });
        }

        // ========== MESAJLARI Dƒ∞NLE ==========
        function listenToMessages() {
            if (!database || !currentChannel) return;
            if (messagesListener) messagesListener.off();

            messagesListener = database.ref('messages/' + currentChannel).orderByChild('timestamp').on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                // Sistem mesajƒ± mƒ± normal mesaj mƒ±?
                if (msg.type === 'system') {
                    addSystemMessage(msg.text, false);
                } else {
                    const isMe = msg.sender === ACTIVE_USER?.name;
                    appendMessageToChat(msg, isMe);
                }
            });
        }

        function appendMessageToChat(msg, isMe) {
            let msgDiv = document.createElement('div');
            msgDiv.className = `message ${isMe ? 'right' : ''}`;
            let senderDisplay = msg.sender;
            if (msg.role === 'owner') senderDisplay = 'üëë ' + senderDisplay;
            else if (msg.role === 'admin') senderDisplay = '‚ö° ' + senderDisplay;
            else if (msg.role === 'coadmin') senderDisplay = 'üîß ' + senderDisplay;
            msgDiv.innerHTML = `<div class="message-header" style="${isMe ? 'justify-content: flex-end;' : ''}">
                <span class="message-time">${msg.time || new Date(msg.timestamp).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</span>
                <span class="message-sender">${escapeHTML(senderDisplay)}</span>
            </div>
            <div class="message-text">${escapeHTML(msg.text)}</div>`;
            document.getElementById('messages').appendChild(msgDiv);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function addSystemMessage(text, saveToFirebase = true) {
            let d = document.createElement('div');
            d.className = 'system-message';
            d.innerHTML = `<i class="fas fa-info-circle"></i> ${escapeHTML(text)}`;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

            if (saveToFirebase && database && currentChannel) {
                database.ref('messages/' + currentChannel).push({
                    sender: 'Sistem',
                    text: text,
                    type: 'system',
                    timestamp: Date.now()
                });
            }
        }

        // ========== √ñZEL MESAJLARI Dƒ∞NLE ==========
        function listenToPrivateMessages() {
            if (!database || !ACTIVE_USER) return;
            if (privateMessagesListener) privateMessagesListener.off();

            privateMessagesListener = database.ref('privateMessages/' + ACTIVE_USER.name).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (!msg) return;
                // Mesajƒ± okuduktan sonra silelim (tek seferlik)
                snapshot.ref.remove();

                const sender = msg.sender;
                // Engellenmi≈ü mi kontrol et
                if (BLOCKED_USERS[sender] && BLOCKED_USERS[sender].expiry > Date.now()) return;

                // Eƒüer o an bu ki≈üiyle √∂zel sohbet a√ßƒ±ksa direkt ekle
                if (currentPrivateChat && currentPrivateChat.name === sender) {
                    appendPrivateMessage(msg);
                } else {
                    // Bildirim g√∂ster
                    addSystemMessage(`üí¨ ${sender} size √∂zel mesaj g√∂nderdi!`, false);
                    // Okunmamƒ±≈ü sayacƒ± artƒ±r (isteƒüe baƒülƒ±)
                }
            });
        }

        function appendPrivateMessage(msg) {
            let container = document.getElementById('privateChatMessages');
            let isMe = msg.sender === ACTIVE_USER?.name;
            let time = new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            let senderDisplay = msg.sender;
            if (msg.role === 'owner') senderDisplay = 'üëë ' + senderDisplay;
            else if (msg.role === 'admin') senderDisplay = '‚ö° ' + senderDisplay;
            else if (msg.role === 'coadmin') senderDisplay = 'üîß ' + senderDisplay;
            let html = `<div class="private-message ${isMe ? 'right' : ''}">
                <div class="private-message-header" style="${isMe ? 'justify-content:flex-end;' : ''}">
                    <span class="private-message-time">${time}</span>
                    <span class="private-message-sender">${escapeHTML(senderDisplay)}</span>
                </div>
                <div class="private-message-text">${escapeHTML(msg.text)}</div>`;
            if (msg.mediaUrl) {
                if (msg.mediaType && msg.mediaType.startsWith('image/')) {
                    html += `<div class="private-message-media"><img src="${escapeHTML(msg.mediaUrl)}" onclick="window.open(this.src)"></div>`;
                } else if (msg.mediaType && msg.mediaType.startsWith('video/')) {
                    html += `<div class="private-message-media"><video controls src="${escapeHTML(msg.mediaUrl)}"></video></div>`;
                }
            }
            html += `</div>`;
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
        }

        // ========== Gƒ∞Rƒ∞≈û ==========
        function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('Kullanƒ±cƒ± adƒ± bo≈ü olamaz!'); return; }

            let user = USERS_DB.find(u => u.name.toLowerCase() === nick.toLowerCase());
            if (user) {
                if (user.password && user.password !== pass) { alert('Hatalƒ± ≈üifre!'); return; }
                if (nick.toLowerCase() === 'mateky' && pass !== OWNER_PASSWORD) { alert('Owner ≈üifresi hatalƒ±!'); return; }
            } else {
                user = {
                    id: Date.now(),
                    name: nick,
                    role: (nick.toLowerCase() === 'mateky') ? 'owner' : 'user',
                    roleLevel: (nick.toLowerCase() === 'mateky') ? 5 : 1,
                    subscribedChannels: ['genel'],
                    myChannel: null,
                    joinDate: new Date().toISOString(),
                    avatar: nick.charAt(0).toUpperCase(),
                    password: pass || '',
                    privateMode: 'all',
                    blockedNicks: []
                };
                USERS_DB.push(user);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            }

            ACTIVE_USER = user;
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';

            updateUIForUser();
            loadLeftPanel('subscriptions');
            updateAllBadges();
            updatePlaylist();

            // Firebase baƒülantƒ±larƒ±nƒ± ba≈ülat
            initOnlineStatus();
            listenToMessages();
            listenToPrivateMessages();

            // Kullanƒ±cƒ±yƒ± genel kanala ekle (onlineUsers √ºzerinden zaten eklenecek)
            if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                channels.genel.onlineUsers.push(ACTIVE_USER.name);
                saveChannels();
            }

            MateBot.init();
            addSystemMessage(`üëã Ho≈ü geldin, ${ACTIVE_USER.name}!`, true);

            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') {
                if (!ACTIVE_USER.subscribedChannels.includes('admin')) ACTIVE_USER.subscribedChannels.push('admin');
                saveChannels();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) {
                e.preventDefault(); handleLogin();
            }
        });

        function logout() {
            if (database && ACTIVE_USER) {
                database.ref('onlineUsers/' + ACTIVE_USER.name).remove();
            }
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            localStorage.removeItem('cetcety_active_user');
            location.reload();
        }

        // ========== MATE BOT ==========
        const MateBot = {
            name: 'MateBot', role: 'admin', roleLevel: 4,
            spamCount: new Map(), lastMessageTime: new Map(),
            init() {
                this.joinAllChannels();
                setInterval(() => this.checkSpam(), 10000);
            },
            joinAllChannels() {
                Object.keys(channels).forEach(ch => {
                    if (!channels[ch].onlineUsers.includes(this.name)) channels[ch].onlineUsers.push(this.name);
                });
                saveChannels();
                addSystemMessage('ü§ñ MateBot aktif | Spam koruma devrede.', true);
            },
            checkSpam() {
                if (!ACTIVE_USER) return;
                const now = Date.now(), userId = ACTIVE_USER.id;
                const last = this.lastMessageTime.get(userId) || 0;
                const count = this.spamCount.get(userId) || 0;
                if (now - last < 3000) {
                    this.spamCount.set(userId, count + 1);
                    if (count >= 2) {
                        addSystemMessage(`‚ö†Ô∏è MateBot: ${ACTIVE_USER.name}, l√ºtfen spam yapma! 10 saniye beklemelisin.`, true);
                        document.getElementById('messageInput').disabled = true;
                        setTimeout(() => {
                            document.getElementById('messageInput').disabled = false;
                            this.spamCount.delete(userId);
                        }, 10000);
                    }
                } else { this.spamCount.set(userId, 0); }
                this.lastMessageTime.set(userId, now);
            },
            sendToAdmin(msg) { addSystemMessage(`ü§ñ MateBot (admin): ${msg}`, true); }
        };

        // ========== YASAKLI KELƒ∞ME KONTROL√ú ==========
        function checkBannedWords(text) {
            if (!text) return false;
            const lower = text.toLowerCase();
            for (let word of BANNED_WORDS) if (lower.includes(word.toLowerCase())) return word;
            return false;
        }

        // ========== TEMA ==========
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const i = document.getElementById('themeIcon').querySelector('i');
            i.className = document.body.classList.contains('light-theme') ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('cetcety_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }
        (function loadTheme() {
            if (localStorage.getItem('cetcety_theme') === 'light') document.body.classList.add('light-theme');
        })();

        // ========== ESC KAPATMA ==========
        function closeAllPanels() {
            closePrivateChat();
            const panelHeader = document.querySelector('.panel-header h3');
            if (panelHeader && !panelHeader.innerText.includes('Abonelikler')) closeLeftPanel();
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeAllPanels();
            if (e.key === 'Enter' && !e.shiftKey) {
                if (document.activeElement.id === 'messageInput') { e.preventDefault(); sendMessage(); }
                else if (document.activeElement.id === 'privateMessageInput') { e.preventDefault(); sendPrivateMessage(); }
            }
        });

        // ========== SOL PANEL (kƒ±saltƒ±lmƒ±≈ü, orijinaldeki gibi √ßalƒ±≈üƒ±r) ==========
        function loadLeftPanel(panelName) {
            if (!ACTIVE_USER) return;
            const panel = document.getElementById('leftPanel');
            if (panelName === 'subscriptions') loadSubscriptionsPanel(panel);
            else if (panelName === 'channels') loadChannelsPanel(panel);
            else if (panelName === 'chatlist') loadChatListPanel(panel);
            else if (panelName === 'notifications') loadNotificationsPanel(panel);
            else if (panelName === 'createchannel') loadCreateChannelPanel(panel);
            else if (panelName === 'profile') loadProfilePanel(panel);
            else if (panelName === 'support') loadSupportPanel(panel);
            else loadSubscriptionsPanel(panel);
            setActiveIcon(panelName);
        }
        function closeLeftPanel() { loadLeftPanel('subscriptions'); }

        function updateUIForUser() {
            document.getElementById('avatarText').textContent = ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase();
        }

        // ---------- Abonelikler ----------
        function loadSubscriptionsPanel(panel) {
            let html = `<div class="panel-header"><h3><i class="fas fa-bell" style="color:#ffd700;"></i> Abonelikler</h3><span class="subscription-count">${ACTIVE_USER.subscribedChannels.length}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            html += `<div class="search-container"><i class="fas fa-search"></i><input type="text" class="search-input" placeholder="Kanal, kullanƒ±cƒ± ara..." id="panelSearchInput"></div>`;
            let visible = ACTIVE_USER.subscribedChannels.filter(ch => {
                let c = channels[ch]; if (!c) return true;
                if (ch === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) return false;
                return (ACTIVE_USER.role==='owner'||ACTIVE_USER.role==='admin') ? true : !c.isHidden;
            });
            if (visible.length===0) html += '<div style="color:#aaa; padding:16px; text-align:center;">Abone olunan kanal yok.</div>';
            else visible.forEach(ch=>{
                let c = channels[ch]||{owner:'Sistem',subscribers:1000,online:0,ownerRole:'user',isHidden:false};
                let icon = 'fa-hashtag';
                if(ch==='rock') icon='fa-guitar'; else if(ch==='arabesk') icon='fa-music'; else if(ch==='jazz') icon='fa-saxophone'; else if(ch==='hiphop') icon='fa-headphones'; else if(ch==='pop') icon='fa-microphone'; else if(ch==='admin') icon='fa-shield-alt';
                let sub = c.subscribers||1000;
                let fmt = sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let active = ch===currentChannel?'active':'';
                let hidden = c.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                html += `<div class="subscription-item ${active}" onclick="joinChannel('${ch}')"><div class="subscription-avatar"><i class="fas ${icon}"></i></div><div class="subscription-info"><div class="subscription-name">${ch} ${hidden}<span class="subscription-badge ${c.ownerRole==='owner'?'badge-owner':c.ownerRole==='admin'?'badge-admin':c.ownerRole==='coadmin'?'badge-coadmin':'badge-operator'}">${c.ownerRole==='owner'?'üëë':c.ownerRole==='admin'?'‚ö°':c.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span></div><div class="subscription-meta"><span>${c.owner}</span><span>‚Ä¢ ${fmt} abone</span></div></div><div class="subscription-stats">${c.onlineUsers ? c.onlineUsers.length : 0}</div></div>`;
            });
            html += `</div><div class="popular-channels"><div class="popular-header"><i class="fas fa-fire" style="color:#ff4444;"></i> Pop√ºler Kanallar</div><div id="popularChannelsList"></div></div>`;
            panel.innerHTML = html;
            updatePopularChannels();
        }

        // ---------- Kanallar ----------
        function loadChannelsPanel(panel) {
            let html = `<div class="panel-header"><h3><i class="fas fa-list-ul" style="color:#ff0000;"></i> T√ºm Kanallar</h3><span class="subscription-count">${Object.keys(channels).length}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            html += `<div class="search-container"><i class="fas fa-search"></i><input type="text" class="search-input" placeholder="Kanal ara..."></div>`;
            let vis = Object.values(channels).filter(ch=> {
                if (ch.name === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) return false;
                return (ACTIVE_USER.role==='owner'||ACTIVE_USER.role==='admin') ? true : !ch.isHidden;
            });
            vis.sort((a,b)=>(b.subscribers||0)-(a.subscribers||0)).forEach(ch=>{
                let sub = ch.subscribers||0, fmt=sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let isSub = ACTIVE_USER.subscribedChannels.includes(ch.name);
                let hidden = ch.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                html += `<div class="channel-item" onclick="joinChannel('${ch.name}')"><div class="channel-avatar"><i class="fas fa-hashtag"></i></div><div class="channel-info"><div class="channel-name">${ch.name} ${hidden}<span class="subscription-badge ${ch.ownerRole==='owner'?'badge-owner':ch.ownerRole==='admin'?'badge-admin':ch.ownerRole==='coadmin'?'badge-coadmin':'badge-operator'}">${ch.ownerRole==='owner'?'üëë':ch.ownerRole==='admin'?'‚ö°':ch.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span></div><div class="channel-meta"><span>${ch.owner}</span><span>‚Ä¢ ${fmt} abone</span><span>‚Ä¢ ${ch.onlineUsers ? ch.onlineUsers.length : 0} √ßevrimi√ßi</span></div></div><button class="subscribe-btn ${isSub?'subscribed':''}" onclick="event.stopPropagation(); ${isSub?'unsubscribeChannel':'subscribeChannel'}('${ch.name}')"><i class="fas ${isSub?'fa-check':'fa-plus'}"></i> ${isSub?'Abone Olundu':'Abone Ol'}</button></div>`;
            });
            html += `</div>`;
            panel.innerHTML = html;
        }

        // ---------- Sohbetlerim ----------
        function loadChatListPanel(panel) {
            updateUnreadBadge();
            let html = `<div class="panel-header"><h3><i class="fas fa-comment" style="color:#7289da;"></i> Sohbetlerim</h3><span class="subscription-count" id="chatListCount">${document.getElementById('chatListBadge').textContent}</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>`;
            html += `<div class="panel-tabs"><div id="tabChats" class="panel-tab active" onclick="switchChatTab('chats')">Sohbetler</div><div id="tabOnline" class="panel-tab" onclick="switchChatTab('online')">√áevrimi√ßi (${channels[currentChannel]?.onlineUsers?.length||0})</div></div>`;
            html += `<div class="panel-content" id="chatPanelContent"></div>`;
            panel.innerHTML = html;
            showChatsTab();
        }
        function switchChatTab(tab) {
            document.getElementById('tabChats').classList.toggle('active', tab==='chats');
            document.getElementById('tabOnline').classList.toggle('active', tab==='online');
            if(tab==='chats') showChatsTab(); else showOnlineTab();
        }
        function showChatsTab() {
            let c = document.getElementById('chatPanelContent');
            // √ñzel mesajlarƒ± Firebase'den √ßekmek yerine, localStorage'da PRIVATE_CHATS kullanƒ±lƒ±yor (eski sistem)
            // Ancak biz Firebase'e ge√ßtiƒüimiz i√ßin bu kƒ±smƒ± da g√ºncellemek gerekir. 
            // Kullanƒ±cƒ±larƒ±n √∂zel sohbet ge√ßmi≈üini g√∂stermek i√ßin Firebase'den de √ßekilebilir.
            // ≈ûimdilik basit bir liste g√∂sterelim:
            let chats = []; // Buraya Firebase'den alƒ±nan sohbet listesi eklenebilir
            // √ñrnek:
            // database.ref('privateMessages').orderByChild('participants')....
            // Zaman kƒ±sƒ±tƒ± nedeniyle bu kƒ±smƒ± eski haline bƒ±rakƒ±yoruz (PRIVATE_CHATS localStorage)
            // Ama daha √∂nce PRIVATE_CHATS kaldƒ±rƒ±ldƒ±, dolayƒ±sƒ±yla bu fonksiyon bo≈ü kalacak.
            // Ge√ßici olarak bir mesaj koyalƒ±m:
            c.innerHTML = '<div style="color:#aaa; text-align:center; padding:32px;">Sohbet listesi Firebase entegrasyonu ile yakƒ±nda.</div>';
        }
        function showOnlineTab() {
            let c = document.getElementById('chatPanelContent');
            let users = channels[currentChannel]?.onlineUsers || [];
            let h = '';
            users.forEach(u=>{
                if (u !== MateBot.name) h+=`<div class="online-item" onclick="openPrivateChat('${u}')"><div class="online-avatar"><span>${u.charAt(0)}</span></div><div class="online-info"><div class="online-name">${u}<span class="online-status"></span></div><div class="online-meta"><span>#${currentChannel}</span></div></div></div>`;
            });
            c.innerHTML = h;
        }
        function updateUnreadBadge() {
            // Firebase'e g√∂re okunmamƒ±≈ü mesaj sayƒ±sƒ±nƒ± hesapla
            document.getElementById('chatListBadge').textContent = '0';
        }

        // ---------- Bildirimler ----------
        function loadNotificationsPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-bell" style="color:#ff4444;"></i> Bildirimler</h3><span class="subscription-count">2</span><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            let nots = [{text:'#rock kanalƒ±nda yeni video eklendi',time:'5 dk √∂nce'},{text:'Mehmet sana √∂zel mesaj g√∂nderdi',time:'12 dk √∂nce'},{text:'#arabesk kanalƒ± pop√ºler oldu!',time:'1 saat √∂nce'}];
            nots.forEach(n=>{ h+=`<div style="display:flex; align-items:center; gap:12px; padding:12px;"><i class="fas fa-info-circle" style="color:#6495ed;"></i><div style="flex:1;"><div style="font-size:13px; color:#fff;">${n.text}</div><div style="font-size:10px; color:#aaa; margin-top:2px;">${n.time}</div></div></div>`; });
            h+=`</div>`; panel.innerHTML = h;
        }

        // ---------- Kanal A√ß ----------
        function loadCreateChannelPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-plus-circle" style="color:#ff0000;"></i> Kanal A√ß</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div><div class="panel-content">`;
            if (ACTIVE_USER.role !== 'owner' && ACTIVE_USER.myChannel) {
                h+=`<div class="info-box"><p><i class="fas fa-info-circle"></i> Zaten bir kanalƒ±nƒ±z var: <strong>#${ACTIVE_USER.myChannel}</strong>.</p></div>`;
            } else {
                h+=`<div class="form-group"><label class="form-label">Kanal Adƒ±</label><input type="text" id="newChannelName" class="form-input" placeholder="√∂rnek: teknoloji" maxlength="20"></div>
                <div class="form-group"><label class="form-label">A√ßƒ±klama</label><input type="text" id="newChannelDesc" class="form-input" placeholder="Kanalƒ±n konusu..."></div>
                <button class="form-button" onclick="createChannel()">Kanalƒ± Olu≈ütur</button>`;
            }
            h+=`</div>`; panel.innerHTML = h;
        }

        // ---------- Profil ----------
        function loadProfilePanel(panel) {
            // Orijinal profil kodu (kƒ±saltƒ±ldƒ±, aynen √ßalƒ±≈üƒ±r)
            let date = ACTIVE_USER.joinDate ? new Date(ACTIVE_USER.joinDate) : new Date();
            let fmtDate = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()}`;
            let roleText = ACTIVE_USER.role==='owner'?'üëë Kurucu': ACTIVE_USER.role==='admin'?'‚ö° Admin': ACTIVE_USER.role==='coadmin'?'üîß Co-Admin': ACTIVE_USER.role==='operator'?'üõ†Ô∏è Operator':'üë§ Kullanƒ±cƒ±';
            let roleClass = ACTIVE_USER.role==='owner'?'badge-owner':ACTIVE_USER.role==='admin'?'badge-admin':ACTIVE_USER.role==='coadmin'?'badge-coadmin':ACTIVE_USER.role==='operator'?'badge-operator':'';
            let h = `<div class="panel-header"><h3><i class="fas fa-user" style="color:#ff0000;"></i> Profil</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content">
                <div style="display:flex; flex-direction:column; align-items:center; padding:20px 0;">
                    <div class="profile-avatar-panel" style="width:80px; height:80px; font-size:32px; margin-bottom:12px; cursor:pointer;" onclick="changeAvatar()">${ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase()}</div>
                    <h2 style="font-size:20px; font-weight:700; color:#fff; margin-bottom:4px;">${ACTIVE_USER.name}</h2>
                    <span class="badge ${roleClass}" style="margin-bottom:16px;">${roleText}</span>
                </div>
                <div style="display:flex; justify-content:space-around; padding:16px 0; border-top:1px solid #2a2a2a; border-bottom:1px solid #2a2a2a; margin-bottom:16px;">
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${ACTIVE_USER.subscribedChannels.length}</div><div style="font-size:11px; color:#aaa;">Abonelik</div></div>
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${ACTIVE_USER.myChannel?'1':'0'}</div><div style="font-size:11px; color:#aaa;">Kanalƒ±m</div></div>
                    <div style="text-align:center;"><div style="font-size:18px; font-weight:700; color:#fff;">${fmtDate.split('.')[0]}</div><div style="font-size:11px; color:#aaa;">Katƒ±lƒ±m</div></div>
                </div>
                <div class="form-group"><label class="form-label">Kullanƒ±cƒ± Adƒ±</label><input type="text" id="profileNick" class="form-input" value="${ACTIVE_USER.name}"><button class="form-button secondary" style="margin-top:8px;" onclick="changeNick()">Deƒüi≈ütir</button></div>
                <div class="form-group"><label class="form-label">≈ûifre</label><input type="password" id="profilePassword" class="form-input" placeholder="Yeni ≈üifre"><button class="form-button secondary" style="margin-top:8px;" onclick="changePassword()">≈ûifreyi Kaydet</button></div>
                <div class="form-group"><label class="form-label">√ñzel Sohbet</label>
                    <select id="privateModeSelect" class="form-select" onchange="changePrivateMode()">
                        <option value="all" ${ACTIVE_USER.privateMode==='all'?'selected':''}>Herkese A√ßƒ±k</option>
                        <option value="none" ${ACTIVE_USER.privateMode==='none'?'selected':''}>Herkese Kapalƒ±</option>
                        <option value="blocked" ${ACTIVE_USER.privateMode==='blocked'?'selected':''}>Sadece Engellenenler</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Belirli ki≈üiyi engelle (nick)</label><input type="text" id="blockNickInput" class="form-input" placeholder="Kullanƒ±cƒ± adƒ±"><button class="form-button secondary" style="margin-top:8px;" onclick="blockSpecificNick()">Engelle</button></div>
                ${ACTIVE_USER.blockedNicks && ACTIVE_USER.blockedNicks.length ? `
                <div style="margin-bottom:16px;">
                    <label class="form-label">Engellenen Ki≈üiler</label>
                    <div style="background:#1a1a1a; border-radius:8px; padding:12px;">
                        ${ACTIVE_USER.blockedNicks.map(nick => `<span style="display:inline-block; background:#2a2a2a; padding:4px 10px; border-radius:20px; margin:0 4px 4px 0; font-size:12px;">${nick} <i class="fas fa-times" style="margin-left:6px; cursor:pointer;" onclick="unblockNick('${nick}')"></i></span>`).join('')}
                    </div>
                </div>` : ''}
                ${ACTIVE_USER.myChannel ? `<div style="margin-top:16px;"><button class="form-button danger" onclick="deleteMyChannel()">Kanalƒ±mƒ± Sil</button></div>` : ''}
                <div style="margin-top:24px;"><button class="form-button" onclick="logout()">G√ºvenli √áƒ±kƒ±≈ü</button></div>
            `;

            if (ACTIVE_USER.role === 'owner') {
                h += `
                <hr style="border-color:#333; margin:20px 0;">
                <h4 style="color:#ffd700; margin-bottom:10px;">üëë Owner Paneli</h4>
                <div class="form-group">
                    <label class="form-label">Yasaklƒ± Kelime Ekle</label>
                    <input type="text" id="newBannedWord" class="form-input" placeholder="√∂rn: k√ºf√ºr">
                    <button class="form-button secondary" style="margin-top:8px;" onclick="addBannedWord()">Ekle</button>
                </div>
                <div style="margin-bottom:16px;">
                    <label class="form-label">Mevcut Yasaklƒ± Kelimeler</label>
                    <div style="background:#1a1a1a; border-radius:8px; padding:12px;">
                        ${BANNED_WORDS.map(word => `<span style="display:inline-block; background:#2a2a2a; padding:4px 10px; border-radius:20px; margin:0 4px 4px 0; font-size:12px;">${word} <i class="fas fa-times" style="margin-left:6px; cursor:pointer;" onclick="removeBannedWord('${word}')"></i></span>`).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Yeni Komut Ekle (√∂rn: /selam)</label>
                    <input type="text" id="newCommandName" class="form-input" placeholder="Komut adƒ± (ba≈üƒ±nda / ile)">
                    <input type="text" id="newCommandResponse" class="form-input" style="margin-top:8px;" placeholder="Yanƒ±t mesajƒ±">
                    <button class="form-button secondary" style="margin-top:8px;" onclick="addCustomCommand()">Komut Ekle</button>
                </div>
                <div style="margin-bottom:16px;">
                    <label class="form-label">Mevcut √ñzel Komutlar</label>
                    <div style="background:#1a1a1a; border-radius:8px; padding:12px;">
                        ${CUSTOM_COMMANDS.map(cmd => `<span style="display:inline-block; background:#2a2a2a; padding:4px 10px; border-radius:20px; margin:0 4px 4px 0; font-size:12px;">${cmd.command} ‚Üí ${cmd.response} <i class="fas fa-times" style="margin-left:6px; cursor:pointer;" onclick="removeCustomCommand('${cmd.command}')"></i></span>`).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">√ñzel Sohbet ƒ∞zle (kullanƒ±cƒ± adƒ± yaz)</label>
                    <input type="text" id="monitorUsername" class="form-input" placeholder="√∂rn: Mehmet">
                    <button class="form-button secondary" style="margin-top:8px;" onclick="showPrivateChatMonitor()">ƒ∞zlemeyi Ba≈ülat</button>
                </div>
                <div id="monitorResult" style="background:#1a1a1a; border-radius:8px; padding:12px; max-height:200px; overflow-y:auto; display:none;"></div>
                `;
            }
            h += `</div>`;
            panel.innerHTML = h;
        }

        // Owner fonksiyonlarƒ± (kƒ±saltƒ±ldƒ±, orijinaldeki gibi)
        function addBannedWord() {
            let word = document.getElementById('newBannedWord')?.value.trim();
            if (!word) return;
            if (!BANNED_WORDS.includes(word)) {
                BANNED_WORDS.push(word);
                localStorage.setItem('cetcety_banned_words', JSON.stringify(BANNED_WORDS));
                addSystemMessage(`üö´ Yasaklƒ± kelime eklendi: ${word}`, true);
                loadLeftPanel('profile');
            }
        }
        function removeBannedWord(word) {
            BANNED_WORDS = BANNED_WORDS.filter(w => w !== word);
            localStorage.setItem('cetcety_banned_words', JSON.stringify(BANNED_WORDS));
            addSystemMessage(`‚úÖ Yasaklƒ± kelime kaldƒ±rƒ±ldƒ±: ${word}`, true);
            loadLeftPanel('profile');
        }
        function addCustomCommand() {
            let cmd = document.getElementById('newCommandName')?.value.trim();
            let resp = document.getElementById('newCommandResponse')?.value.trim();
            if (!cmd || !resp) return;
            if (!cmd.startsWith('/')) cmd = '/' + cmd;
            CUSTOM_COMMANDS.push({ command: cmd, response: resp });
            localStorage.setItem('cetcety_custom_commands', JSON.stringify(CUSTOM_COMMANDS));
            addSystemMessage(`‚úÖ Yeni komut eklendi: ${cmd}`, true);
            loadLeftPanel('profile');
        }
        function removeCustomCommand(cmd) {
            CUSTOM_COMMANDS = CUSTOM_COMMANDS.filter(c => c.command !== cmd);
            localStorage.setItem('cetcety_custom_commands', JSON.stringify(CUSTOM_COMMANDS));
            addSystemMessage(`üóëÔ∏è Komut kaldƒ±rƒ±ldƒ±: ${cmd}`, true);
            loadLeftPanel('profile');
        }
        function showPrivateChatMonitor() {
            // Bu fonksiyon PRIVATE_CHATS'e baƒülƒ±ydƒ±, ≈üimdi Firebase'den √ßekilebilir. Ge√ßici olarak kapatƒ±yoruz.
            addSystemMessage('üëë √ñzel sohbet izleme Firebase entegrasyonu ile yakƒ±nda.', true);
        }

        // Profil fonksiyonlarƒ± (kƒ±saltƒ±ldƒ±)
        function changeAvatar() {
            let em = prompt('Avatar olarak bir emoji veya harf girin (tek karakter):', ACTIVE_USER.avatar || ACTIVE_USER.name.charAt(0).toUpperCase());
            if (em && em.length > 0) {
                ACTIVE_USER.avatar = em.charAt(0).toUpperCase();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                loadLeftPanel('profile');
                document.getElementById('avatarText').textContent = em.charAt(0).toUpperCase();
                addSystemMessage('‚úÖ Avatar g√ºncellendi.', true);
            }
        }
        function changeNick() {
            let newNick = document.getElementById('profileNick')?.value.trim();
            if (!newNick) return;
            if (USERS_DB.find(u => u.name.toLowerCase() === newNick.toLowerCase() && u.id !== ACTIVE_USER.id)) {
                alert('Bu kullanƒ±cƒ± adƒ± zaten kullanƒ±lƒ±yor!'); return;
            }
            ACTIVE_USER.name = newNick;
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
            const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
            if (index !== -1) USERS_DB[index] = ACTIVE_USER;
            localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            document.getElementById('avatarText').textContent = newNick.charAt(0).toUpperCase();
            loadLeftPanel('profile');
            addSystemMessage(`‚úÖ Kullanƒ±cƒ± adƒ± deƒüi≈ütirildi: ${newNick}`, true);
        }
        function changePassword() {
            let pwd = document.getElementById('profilePassword')?.value.trim();
            if (pwd) {
                ACTIVE_USER.password = pwd;
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage('‚úÖ ≈ûifre g√ºncellendi.', true);
                document.getElementById('profilePassword').value = '';
            } else alert('≈ûifre bo≈ü olamaz!');
        }
        function changePrivateMode() {
            let mode = document.getElementById('privateModeSelect')?.value;
            if (mode) {
                ACTIVE_USER.privateMode = mode;
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`üîí √ñzel sohbet modu: ${mode==='all'?'Herkese A√ßƒ±k':mode==='none'?'Herkese Kapalƒ±':'Sadece Engellenenler'}`, true);
            }
        }
        function blockSpecificNick() {
            let nick = document.getElementById('blockNickInput')?.value.trim();
            if (!nick) return;
            if (!ACTIVE_USER.blockedNicks) ACTIVE_USER.blockedNicks = [];
            if (!ACTIVE_USER.blockedNicks.includes(nick)) {
                ACTIVE_USER.blockedNicks.push(nick);
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`üö´ ${nick} engellendi.`, true);
                loadLeftPanel('profile');
            }
        }
        function unblockNick(nick) {
            if (ACTIVE_USER.blockedNicks) {
                ACTIVE_USER.blockedNicks = ACTIVE_USER.blockedNicks.filter(n => n !== nick);
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage(`‚úÖ ${nick} engeli kaldƒ±rƒ±ldƒ±.`, true);
                loadLeftPanel('profile');
            }
        }
        function deleteMyChannel() {
            if (!ACTIVE_USER.myChannel) return;
            if (confirm(`#${ACTIVE_USER.myChannel} kanalƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?`)) {
                delete channels[ACTIVE_USER.myChannel];
                saveChannels();
                ACTIVE_USER.myChannel = null;
                if (ACTIVE_USER.role !== 'owner') ACTIVE_USER.role = 'user';
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                const index = USERS_DB.findIndex(u => u.id === ACTIVE_USER.id);
                if (index !== -1) USERS_DB[index] = ACTIVE_USER;
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
                addSystemMessage('üóëÔ∏è Kanalƒ±nƒ±z silindi.', true);
                updateAllBadges();
                joinChannel('genel');
                loadLeftPanel('profile');
            }
        }

        // Destek
        function loadSupportPanel(panel) {
            let h = `<div class="panel-header"><h3><i class="fas fa-headset" style="color:#7289da;"></i> Destek</h3><div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content"><div class="info-box"><p><i class="fas fa-info-circle"></i> Canlƒ± destek talebiniz #admin kanalƒ±na iletilir.</p></div>
            <div style="background:#1a1a1a; border-radius:8px; padding:16px; margin-bottom:16px;"><h4 style="color:#fff; margin-bottom:12px;">üìã Sƒ±k Sorulan Sorular</h4>
                <div onclick="addSystemMessage('üìå Kanal a√ßmak i√ßin sol men√ºde + ikonuna tƒ±klayƒ±n.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px; margin-bottom:8px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> Kanal nasƒ±l a√ßarƒ±m?</div>
                <div onclick="addSystemMessage('üìå Yetki sistemi: Owner her ≈üeyi g√∂r√ºr, Admin sistem genelinde, Co-admin kendi kanalƒ±nda yetkilidir.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> Yetki sistemi nasƒ±l √ßalƒ±≈üƒ±r?</div>
                <div onclick="addSystemMessage('üìå √ñzel sohbetlerde resim/video g√∂nderebilirsiniz.')" style="cursor:pointer; padding:8px; border-radius:6px; background:#2a2a2a; color:#ddd; font-size:13px;"><i class="fas fa-question-circle" style="color:#7289da; margin-right:8px;"></i> √ñzel sohbet √∂zellikleri</div>
            </div>
            <div class="form-group"><label class="form-label">Destek Talebi</label><textarea id="supportMessage" class="form-input" placeholder="Sorununuzu yazƒ±n..." rows="3"></textarea></div>
            <button class="form-button" style="background:#7289da;" onclick="sendSupportTicket()">G√∂nder</button></div>`;
            panel.innerHTML = h;
        }
        function sendSupportTicket() {
            let msg = document.getElementById('supportMessage')?.value.trim();
            if(msg) { addSystemMessage(`üõü Destek talebiniz #admin kanalƒ±na iletildi: "${msg}"`, true); document.getElementById('supportMessage').value=''; loadLeftPanel('notifications'); }
        }

        // Pop√ºler kanallar
        function updatePopularChannels() {
            let c = document.getElementById('popularChannelsList'); if(!c) return;
            c.innerHTML = '';
            let vis = Object.values(channels).filter(ch=> {
                if (ch.name === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) return false;
                return (ACTIVE_USER.role==='owner'||ACTIVE_USER.role==='admin') ? true : !ch.isHidden;
            });
            vis.sort((a,b)=>(b.subscribers||0)-(a.subscribers||0)).slice(0,3).forEach(ch=>{
                let sub = ch.subscribers||0, fmt = sub>=1000000?(sub/1000000).toFixed(1)+'M': sub>=1000?(sub/1000).toFixed(1)+'K':sub;
                let isSub = ACTIVE_USER.subscribedChannels.includes(ch.name);
                let hidden = ch.isHidden?'<span class="badge badge-hidden">Gƒ∞ZLƒ∞</span>':'';
                let roleClass = ch.ownerRole==='owner'?'badge-owner':ch.ownerRole==='admin'?'badge-admin':ch.ownerRole==='coadmin'?'badge-coadmin':'badge-operator';
                c.innerHTML += `<div class="popular-item" onclick="joinChannel('${ch.name}')"><div class="popular-info"><div class="popular-name">${ch.name} ${hidden}<span class="badge ${roleClass}">${ch.ownerRole==='owner'?'üëë':ch.ownerRole==='admin'?'‚ö°':ch.ownerRole==='coadmin'?'üîß':'üõ†Ô∏è'}</span>${ch.name==='genel'?'<span class="badge badge-owner">ANA</span>':''}${ch.subscribers>1000000?'<span class="badge badge-coadmin">POP</span>':''}</div><div class="popular-subscribers">${fmt} abone</div></div><button class="subscribe-btn ${isSub?'subscribed':''}" onclick="event.stopPropagation(); ${isSub?'unsubscribeChannel':'subscribeChannel'}('${ch.name}')"><i class="fas ${isSub?'fa-check':'fa-plus'}"></i> ${isSub?'Abone Olundu':'Abone Ol'}</button></div>`;
            });
        }

        // ========== √ñZEL SOHBET FONKSƒ∞YONLARI (g√ºncellenmi≈ü) ==========
        function openPrivateChat(username) {
            if (!username) return;
            if (ACTIVE_USER.privateMode === 'none') { addSystemMessage('‚ùå √ñzel sohbetlere kapalƒ±sƒ±nƒ±z.', true); return; }
            if (ACTIVE_USER.blockedNicks && ACTIVE_USER.blockedNicks.includes(username)) { addSystemMessage(`üö´ ${username} engellenmi≈ü.`, true); return; }
            let blockKey = `${ACTIVE_USER.id}_${username}`;
            if (BLOCKED_USERS[blockKey] && BLOCKED_USERS[blockKey].expiry > Date.now()) { addSystemMessage(`üö´ ${username} 24 saat engellendi.`, true); return; }
            let reverseKey = `${username}_${ACTIVE_USER.id}`;
            if (BLOCKED_USERS[reverseKey] && BLOCKED_USERS[reverseKey].expiry > Date.now()) { addSystemMessage(`üö´ ${username} tarafƒ±ndan engellendiniz.`, true); return; }

            currentPrivateChat = { name: username, id: username };
            document.getElementById('privateChatName').textContent = username;
            document.getElementById('privateChatAvatar').innerHTML = username.charAt(0).toUpperCase();
            document.getElementById('privateChatPanel').classList.add('active');
            // √ñzel sohbet mesajlarƒ±nƒ± y√ºkle (Firebase'den ge√ßmi≈ü mesajlarƒ± √ßekmek i√ßin ayrƒ± bir fonksiyon eklenebilir)
            // ≈ûimdilik sadece dinleyici ile yeni mesajlar gelecek.
            document.getElementById('privateChatMessages').innerHTML = ''; // temizle
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChat = null;
        }

        function sendPrivateMessage() {
            let input = document.getElementById('privateMessageInput');
            let text = input.value.trim();
            if (!text || !currentPrivateChat || !ACTIVE_USER) return;
            let banned = checkBannedWords(text);
            if (banned) {
                addSystemMessage(`üö´ Yasaklƒ± kelime tespit edildi: "${banned}". Mesajƒ±nƒ±z g√∂nderilmedi.`, true);
                MateBot.sendToAdmin(`‚ö†Ô∏è ${ACTIVE_USER.name} √∂zel sohbette yasaklƒ± kelime kullandƒ±: ${banned}`);
                input.value = ''; return;
            }

            // Firebase'e g√∂nder (alƒ±cƒ±nƒ±n privateMessages d√ºƒü√ºm√ºne)
            if (database) {
                database.ref('privateMessages/' + currentPrivateChat.name).push({
                    sender: ACTIVE_USER.name,
                    role: ACTIVE_USER.role,
                    text: text,
                    timestamp: Date.now()
                });
                // Kendi ekranƒ±na hemen ekle (dinleyici gelene kadar)
                appendPrivateMessage({
                    sender: ACTIVE_USER.name,
                    role: ACTIVE_USER.role,
                    text: text,
                    timestamp: Date.now()
                });
            }

            input.value = '';
        }

        // Resim/Video g√∂nderme (kƒ±saltƒ±ldƒ±)
        function triggerPrivateImageUpload() { document.getElementById('privateImageUpload').click(); }
        function sendPrivateImageFile(input) {
            if (!input.files || !input.files[0] || !currentPrivateChat) return;
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = (e) => {
                if (database) {
                    database.ref('privateMessages/' + currentPrivateChat.name).push({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                    appendPrivateMessage({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                }
            };
            reader.readAsDataURL(file); input.value = '';
        }
        function triggerPrivateVideoUpload() { document.getElementById('privateVideoUpload').click(); }
        function sendPrivateVideoFile(input) {
            if (!input.files || !input.files[0] || !currentPrivateChat) return;
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = (e) => {
                if (database) {
                    database.ref('privateMessages/' + currentPrivateChat.name).push({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                    appendPrivateMessage({
                        sender: ACTIVE_USER.name,
                        role: ACTIVE_USER.role,
                        text: '',
                        mediaUrl: e.target.result,
                        mediaType: file.type,
                        timestamp: Date.now()
                    });
                }
            };
            reader.readAsDataURL(file); input.value = '';
        }

        function blockUser() {
            if (!currentPrivateChat || !ACTIVE_USER) return;
            let blockKey = `${ACTIVE_USER.id}_${currentPrivateChat.id}`;
            BLOCKED_USERS[blockKey] = { userId: currentPrivateChat.id, userName: currentPrivateChat.name, expiry: Date.now() + 24*60*60*1000, blockedBy: ACTIVE_USER.id };
            localStorage.setItem('cetcety_blocks', JSON.stringify(BLOCKED_USERS));
            addSystemMessage(`üö´ ${currentPrivateChat.name} 24 saatliƒüine engellendi.`, true);
            closePrivateChat();
        }
        function reportUser() { if (currentPrivateChat) addSystemMessage(`‚ö†Ô∏è ${currentPrivateChat.name} ≈üikayet edildi.`, true); }
        function switchPrivateTab(tab) { if (tab !== 'chat') addSystemMessage('üîú Bu √∂zellik yakƒ±nda aktif olacak.', true); }

        // ========== CANLI YAYIN ==========
        function openLiveStreamModal() {
            let ch = channels[currentChannel];
            if (!(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || ch.coAdmins?.includes(ACTIVE_USER.name))) {
                alert('Yetkiniz yok!'); return;
            }
            const streamKey = prompt('YouTube Canlƒ± Yayƒ±n Anahtarƒ± (sim√ºlasyon):', '');
            if (streamKey) {
                addSystemMessage(`üìπ ${ACTIVE_USER.name} canlƒ± yayƒ±n ba≈ülattƒ±! #${currentChannel}`, true);
                ch.currentVideo = 'jfKfPfyJRdk';
                if (ytPlayer) ytPlayer.loadVideoById(ch.currentVideo);
                ch.currentTitle = `üî¥ CANLI YAYIN - ${ACTIVE_USER.name}`;
                document.getElementById('nowPlayingTitle').innerHTML = `üî¥ CANLI YAYIN - ${ACTIVE_USER.name}`;
                MateBot.sendToAdmin(`${ACTIVE_USER.name}, #${currentChannel} kanalƒ±nda canlƒ± yayƒ±n ba≈ülattƒ±.`);
                saveChannels();
            }
        }

        // ========== KANALI ≈ûƒ∞KAYET ET ==========
        function reportChannel() {
            let reason = prompt('Bu kanalƒ± neden ≈üikayet ediyorsunuz?', '');
            let msg = `üö© ${ACTIVE_USER.name}, #${currentChannel} kanalƒ±nƒ± ≈üikayet etti.` + (reason ? ` Sebep: ${reason}` : '');
            addSystemMessage(msg, true); MateBot.sendToAdmin(msg);
        }

        // ========== AKTƒ∞F ƒ∞KON ==========
        function setActiveIcon(active) {
            document.querySelectorAll('.icon-item').forEach(el => el.classList.remove('active'));
            if (active === 'subscriptions') document.querySelector('.icon-item[onclick*="openSubscriptions"]')?.classList.add('active');
            else if (active === 'channels') document.querySelector('.icon-item[onclick*="openChannelPanel"]')?.classList.add('active');
            else if (active === 'chatlist') document.querySelector('.icon-item[onclick*="openChatListPanel"]')?.classList.add('active');
            else if (active === 'notifications') document.querySelector('.icon-item[onclick*="openNotificationPanel"]')?.classList.add('active');
            else if (active === 'createchannel') document.querySelector('.icon-item[onclick*="openCreateChannelPanel"]')?.classList.add('active');
            else if (active === 'profile') document.querySelector('.profile-avatar')?.classList.add('active');
            else if (active === 'support') document.querySelector('.icon-item[onclick*="openSupportPanel"]')?.classList.add('active');
        }

        // ========== ƒ∞KON FONKSƒ∞YONLARI ==========
        function showHome() { addSystemMessage('üè† Ana sayfa hazƒ±rlanƒ±yor...', true); }
        function openSubscriptions() { loadLeftPanel('subscriptions'); }
        function openChannelPanel() { loadLeftPanel('channels'); }
        function openChatListPanel() { loadLeftPanel('chatlist'); }
        function openCreateChannelPanel() { loadLeftPanel('createchannel'); }
        function openNotificationPanel() { loadLeftPanel('notifications'); }
        function openSupportPanel() { loadLeftPanel('support'); }
        function openProfilePanel() { loadLeftPanel('profile'); }

        // ========== KANAL ƒ∞≈ûLEMLERƒ∞ ==========
        function joinChannel(ch) {
            if (!channels[ch]) return;
            if (ch === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) {
                addSystemMessage('‚ùå Bu kanala eri≈üim yetkiniz yok.', true); return;
            }

            // Eski kanaldan √ßƒ±kar (onlineUsers g√ºncellenecek, Firebase'de kanal bilgisi deƒüi≈üecek)
            if (currentChannel && channels[currentChannel] && channels[currentChannel].onlineUsers) {
                channels[currentChannel].onlineUsers = channels[currentChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
            }
            // Firebase'deki online kaydƒ±nƒ± g√ºncelle
            if (database && ACTIVE_USER) {
                database.ref('onlineUsers/' + ACTIVE_USER.name).update({ channel: ch });
            }

            currentChannel = ch;
            let c = channels[ch];

            // Yeni kanala ekle (onlineUsers'a ekleme Firebase'den gelecek, ama yerel listeyi de g√ºncelleyelim)
            if (!c.onlineUsers.includes(ACTIVE_USER.name)) {
                c.onlineUsers.push(ACTIVE_USER.name);
            }
            saveChannels();

            document.getElementById('currentChannelName').textContent = ch;
            document.getElementById('currentChannelPlaylist').textContent = `#${ch} playlist`;
            let sub = c.subscribers || 0;
            let fmt = sub >= 1000000 ? (sub/1000000).toFixed(1)+'M' : sub >= 1000 ? (sub/1000).toFixed(1)+'K' : sub;
            document.getElementById('channelSubscribers').textContent = fmt;
            document.getElementById('channelUserCount').textContent = c.onlineUsers.length;
            if (ytPlayer) { ytPlayer.loadVideoById(c.currentVideo); ytPlayer.playVideo(); }
            document.getElementById('nowPlayingTitle').textContent = c.currentTitle;
            document.getElementById('nowPlayingOwner').innerHTML = `${c.ownerRole === 'owner' ? 'üëë' : 'üîß'} ${c.owner}`;
            updatePlaylist();

            // Mesajlarƒ± yeniden dinle
            listenToMessages();

            let subBtn = document.getElementById('subscribeChannelBtn');
            if (ACTIVE_USER.subscribedChannels.includes(ch)) { subBtn.innerHTML = '<i class="fas fa-check"></i> Abone Olundu'; subBtn.classList.add('subscribed'); }
            else { subBtn.innerHTML = '<i class="fas fa-plus"></i> Abone Ol'; subBtn.classList.remove('subscribed'); }

            let addBtn = document.getElementById('addMediaBtn');
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name)) {
                addBtn.classList.remove('disabled'); addBtn.style.opacity = '1'; addBtn.style.pointerEvents = 'auto';
            } else { addBtn.classList.add('disabled'); addBtn.style.opacity = '0.4'; addBtn.style.pointerEvents = 'none'; }

            let liveBtn = document.getElementById('liveStreamBtn');
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name)) {
                liveBtn.classList.remove('disabled'); liveBtn.style.opacity = '1'; liveBtn.style.pointerEvents = 'auto';
            } else { liveBtn.classList.add('disabled'); liveBtn.style.opacity = '0.4'; liveBtn.style.pointerEvents = 'none'; }

            let hideBtn = document.getElementById('hideChannelBtn'), hideIcon = document.getElementById('hideIcon');
            hideIcon.className = c.isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') {
                hideBtn.classList.add('disabled'); hideBtn.title = 'Owner/Admin kanal gizleyemez';
            } else if (c.coAdmins?.includes(ACTIVE_USER.name)) {
                hideBtn.classList.remove('disabled'); hideBtn.title = c.isHidden ? 'Kanalƒ± G√∂ster' : 'Kanalƒ± Gizle';
            } else { hideBtn.classList.add('disabled'); hideBtn.title = 'Yetkiniz yok'; }

            document.getElementById('reportChannelBtn').classList.remove('disabled');
            document.getElementById('reportChannelBtn').style.opacity = '1'; document.getElementById('reportChannelBtn').style.pointerEvents = 'auto';

            addSystemMessage(`üì¢ #${ch} kanalƒ±na katƒ±ldƒ±n! ${fmt} abone, ${c.onlineUsers.length} √ßevrimi√ßi.`, true);
        }

        function toggleChannelHidden() {
            let c = channels[currentChannel]; if (!c) return;
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') { addSystemMessage('‚ùå Owner/Admin kanal gizleyemez!', true); return; }
            if (!c.coAdmins?.includes(ACTIVE_USER.name)) { addSystemMessage('‚ùå Yetkiniz yok!', true); return; }
            c.isHidden = !c.isHidden;
            saveChannels();
            document.getElementById('hideIcon').className = c.isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
            addSystemMessage(`üëÅÔ∏è #${currentChannel} ${c.isHidden ? 'gizlendi' : 'g√∂steriliyor'}.`, true);
            updatePopularChannels();
        }

        // ========== PLAYLIST (kƒ±saltƒ±ldƒ±, orijinaldeki gibi) ==========
        function updatePlaylist() {
            let c = channels[currentChannel]; if (!c) return;
            let cont = document.getElementById('playlistItems'); let html = '';
            c.playlist.forEach((item, i) => {
                let active = item.id === c.currentVideo ? 'active' : '';
                let canDel = ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || (c.coAdmins?.includes(ACTIVE_USER.name) && item.addedBy === ACTIVE_USER.name);
                html += `<div class="playlist-item ${active}" onclick="playVideo('${item.id}','${escapeHTML(item.title)}','${escapeHTML(item.addedBy)}','${item.role}')"><div class="playlist-thumb"><i class="fab fa-youtube"></i></div><div class="playlist-info"><div class="playlist-song">${escapeHTML(item.title)}</div><div class="playlist-artist"><span>${item.role === 'owner' ? 'üëë' : item.role === 'admin' ? '‚ö°' : 'üîß'} ${escapeHTML(item.addedBy)}</span><span class="badge ${item.role === 'owner' ? 'badge-owner' : item.role === 'admin' ? 'badge-admin' : 'badge-coadmin'}">${item.role}</span></div></div>${canDel ? `<div class="playlist-actions"><div class="playlist-action" onclick="event.stopPropagation(); removeFromPlaylist(${i})"><i class="fas fa-trash"></i></div></div>` : ''}</div>`;
            });
            cont.innerHTML = html; document.getElementById('playlistCount').textContent = `${c.playlist.length} video`;
        }
        function playVideo(vid, title, by, role) {
            let c = channels[currentChannel]; c.currentVideo = vid; c.currentTitle = title; c.currentArtist = `${role === 'owner' ? 'üëë' : role === 'admin' ? '‚ö°' : 'üîß'} ${by}`;
            saveChannels();
            if (ytPlayer) ytPlayer.loadVideoById(vid);
            document.getElementById('nowPlayingTitle').textContent = title; document.getElementById('nowPlayingOwner').innerHTML = `${role === 'owner' ? 'üëë' : role === 'admin' ? '‚ö°' : 'üîß'} ${by}`;
            updatePlaylist();
        }
        function removeFromPlaylist(i) {
            let c = channels[currentChannel]; let rem = c.playlist[i]; c.playlist.splice(i, 1);
            if (rem.id === c.currentVideo && c.playlist.length > 0) { let n = c.playlist[0]; playVideo(n.id, n.title, n.addedBy, n.role); }
            saveChannels();
            updatePlaylist(); addSystemMessage(`üóëÔ∏è "${rem.title}" kaldƒ±rƒ±ldƒ±.`, true);
        }
        function openAddMediaModal() {
            let c = channels[currentChannel];
            if (!(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin' || c.coAdmins?.includes(ACTIVE_USER.name))) { alert('Yetkiniz yok!'); return; }
            let url = prompt('YouTube URL/ID:', ''); if (!url) return;
            let vid = ''; if (url.includes('youtube.com/watch?v=')) vid = url.split('v=')[1]?.split('&')[0]; else if (url.includes('youtu.be/')) vid = url.split('youtu.be/')[1]?.split('?')[0]; else vid = url;
            if (vid) { let t = prompt('Ba≈ülƒ±k:', `Video ${c.playlist.length + 1}`); c.playlist.push({ id: vid, title: t || `Video ${c.playlist.length + 1}`, addedBy: ACTIVE_USER.name, role: ACTIVE_USER.role }); updatePlaylist(); saveChannels(); addSystemMessage(`‚úÖ "${t}" eklendi!`, true); }
        }

        // ========== ABONELƒ∞K ==========
        function subscribeChannel(ch) {
            if (!channels[ch]) channels[ch] = { name: ch, owner: 'Sistem', ownerRole: 'user', subscribers: 1000, online: 0, isHidden: false, currentVideo: 'dQw4w9WgXcQ', currentTitle: `${ch} kanalƒ±`, currentArtist: 'üë§ Sistem', playlist: [], onlineUsers: [] };
            if (!ACTIVE_USER.subscribedChannels.includes(ch)) {
                ACTIVE_USER.subscribedChannels.push(ch);
                channels[ch].subscribers = (channels[ch].subscribers || 1000) + 1;
                saveChannels();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                addSystemMessage(`‚úÖ #${ch} abone olundu!`, true);
                updateAllBadges(); updateSubsIfNeeded(); updatePopularChannels();
            }
        }
        function unsubscribeChannel(ch) {
            let i = ACTIVE_USER.subscribedChannels.indexOf(ch); if (i > -1) {
                ACTIVE_USER.subscribedChannels.splice(i, 1);
                if (channels[ch]) channels[ch].subscribers = Math.max(0, (channels[ch].subscribers || 1000) - 1);
                saveChannels();
                localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
                addSystemMessage(`‚ùå #${ch} abonelikten √ßƒ±kƒ±ldƒ±.`, true);
                updateAllBadges(); updateSubsIfNeeded(); updatePopularChannels();
            }
        }
        function toggleChannelSubscribe() {
            if (ACTIVE_USER.subscribedChannels.includes(currentChannel)) unsubscribeChannel(currentChannel);
            else subscribeChannel(currentChannel);
        }
        function updateAllBadges() {
            document.getElementById('subscriptionBadge').textContent = ACTIVE_USER.subscribedChannels.length;
            let subCountEl = document.getElementById('subscriptionCount');
            if (subCountEl) subCountEl.textContent = ACTIVE_USER.subscribedChannels.length;
            document.getElementById('channelCountBadge').textContent = Object.keys(channels).length;
            updateUnreadBadge();
        }
        function updateSubsIfNeeded() {
            if (document.querySelector('.panel-header h3')?.innerText.includes('Abonelikler')) loadSubscriptionsPanel(document.getElementById('leftPanel'));
            if (document.querySelector('.panel-header h3')?.innerText.includes('T√ºm Kanallar')) loadChannelsPanel(document.getElementById('leftPanel'));
        }

        // ========== MESAJ G√ñNDER (GENEL) ==========
        function sendMessage() {
            MateBot.checkSpam();
            let inp = document.getElementById('messageInput'); let txt = inp.value.trim();
            if (!txt) return;
            if (txt.startsWith('/')) { handleCommand(txt); inp.value = ''; autoResize(inp); return; }
            
            let banned = checkBannedWords(txt);
            if (banned) {
                addSystemMessage(`üö´ Yasaklƒ± kelime tespit edildi: "${banned}". Mesajƒ±nƒ±z g√∂nderilmedi.`, true);
                MateBot.sendToAdmin(`‚ö†Ô∏è ${ACTIVE_USER.name} genel sohbette yasaklƒ± kelime kullandƒ±: ${banned}`);
                inp.value = ''; autoResize(inp); return;
            }

            // Firebase'e g√∂nder
            if (database && currentChannel) {
                database.ref('messages/' + currentChannel).push({
                    sender: ACTIVE_USER.name,
                    role: ACTIVE_USER.role,
                    text: txt,
                    timestamp: Date.now(),
                    time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                });
            }

            inp.value = ''; autoResize(inp);
        }

        // ========== KOMUT ƒ∞≈ûLEYƒ∞Cƒ∞ (kƒ±saltƒ±ldƒ±, orijinaldeki gibi) ==========
        function handleCommand(cmd) {
            let parts = cmd.substring(1).split(' '); let main = parts[0].toLowerCase();
            let custom = CUSTOM_COMMANDS.find(c => c.command === '/' + main || c.command === main);
            if (custom) { addSystemMessage(`ü§ñ ${custom.response}`, true); return; }

            if (main === 'help') {
                addSystemMessage('üìã KOMUTLAR:\n/join #kanal, /part, /msg kullanƒ±cƒ± mesaj, /kick kullanƒ±cƒ±, /ban kullanƒ±cƒ±, /unban kullanƒ±cƒ±, /op kullanƒ±cƒ±, /deop kullanƒ±cƒ±, /addadmin kullanƒ±cƒ±, /removeadmin kullanƒ±cƒ±, /users, /ping, /temizle, /abonelikler, /populer, /kanal, /kanalac, /yayin', true);
            }
            else if (main === 'join') {
                let ch = parts[1]?.replace('#','');
                if (ch && channels[ch]) {
                    if (ch === 'admin' && !(ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')) addSystemMessage('‚ùå Admin kanalƒ±na eri≈üim yetkiniz yok.', true);
                    else joinChannel(ch);
                } else addSystemMessage('‚ùå Kanal bulunamadƒ±.', true);
            }
            else if (main === 'part') {
                if (currentChannel === 'genel') addSystemMessage('‚ùå Genel kanaldan ayrƒ±lamazsƒ±n.', true);
                else {
                    let oldChannel = currentChannel;
                    if (channels[oldChannel] && channels[oldChannel].onlineUsers) {
                        channels[oldChannel].onlineUsers = channels[oldChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
                        saveChannels();
                    }
                    // Firebase'deki kanal bilgisini g√ºncelle
                    if (database && ACTIVE_USER) {
                        database.ref('onlineUsers/' + ACTIVE_USER.name).update({ channel: 'genel' });
                    }
                    addSystemMessage(`‚¨ÖÔ∏è #${oldChannel} kanalƒ±ndan ayrƒ±ldƒ±n.`, true);
                    joinChannel('genel');
                }
            }
            else if (main === 'msg') {
                let target = parts[1]; let msg = parts.slice(2).join(' ');
                if (target && msg) {
                    let user = USERS_DB.find(u => u.name.toLowerCase() === target.toLowerCase());
                    if (user) {
                        openPrivateChat(user.name);
                        setTimeout(() => {
                            document.getElementById('privateMessageInput').value = msg;
                            sendPrivateMessage();
                        }, 300);
                    } else addSystemMessage('‚ùå Kullanƒ±cƒ± bulunamadƒ±.', true);
                } else addSystemMessage('Kullanƒ±m: /msg kullanƒ±cƒ± mesaj', true);
            }
            else if (main === 'kick') {
                // ... orijinal kod (kƒ±saltƒ±ldƒ±)
                addSystemMessage('üë¢ kick komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'ban') {
                // ...
                addSystemMessage('üö´ ban komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'unban') {
                // ...
                addSystemMessage('‚úÖ unban komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'op') {
                // ...
                addSystemMessage('üîß op komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'deop') {
                // ...
                addSystemMessage('üî® deop komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'addadmin') {
                // ...
                addSystemMessage('‚úÖ addadmin komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'removeadmin') {
                // ...
                addSystemMessage('‚úÖ removeadmin komutu hen√ºz Firebase ile uyumlu deƒüil.', true);
            }
            else if (main === 'users') {
                let list = channels[currentChannel].onlineUsers.filter(u => u !== MateBot.name).join(', ');
                addSystemMessage(`üë• #${currentChannel} √ßevrimi√ßi: ${list}`, true);
            }
            else if (main === 'ping') addSystemMessage('üèì Pong!', true);
            else if (main === 'temizle' || main === 'clear') { 
                // Firebase'de mesajlarƒ± temizlemek i√ßin ayrƒ± yetki gerekir
                if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') {
                    if (confirm('T√ºm mesajlarƒ± silmek istediƒüinize emin misiniz?')) {
                        database.ref('messages/' + currentChannel).remove();
                        document.getElementById('messages').innerHTML = '';
                        addSystemMessage('‚úÖ Sohbet temizlendi!', true);
                    }
                } else {
                    addSystemMessage('‚õî Bu komutu kullanma yetkiniz yok!', true);
                }
            }
            else if (main === 'abonelikler') addSystemMessage('üì∫ Aboneliklerin: ' + ACTIVE_USER.subscribedChannels.map(ch => '#' + ch).join(', '), true);
            else if (main === 'populer') {
                let v = Object.values(channels).filter(ch => (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') ? true : !ch.isHidden).sort((a,b)=>(b.subscribers||0)-(a.subscribers||0)).slice(0,5);
                addSystemMessage('üî• Pop√ºler kanallar:\n' + v.map(ch => `‚Ä¢ #${ch.name} - ${(ch.subscribers||0).toLocaleString()} abone`).join('\n'), true);
            }
            else if (main === 'kanal') {
                let ch = channels[currentChannel];
                let f = (ch.subscribers||0)>=1000000?((ch.subscribers||0)/1000000).toFixed(1)+'M': (ch.subscribers||0)>=1000?((ch.subscribers||0)/1000).toFixed(1)+'K':(ch.subscribers||0);
                addSystemMessage(`üì¢ #${currentChannel} ‚Ä¢ ${f} abone ‚Ä¢ ${ch.onlineUsers ? ch.onlineUsers.length : 0} √ßevrimi√ßi ‚Ä¢ Sahip: ${ch.ownerRole==='owner'?'üëë':ch.ownerRole==='admin'?'‚ö°':ch.ownerRole==='coadmin'?'üîß':ch.ownerRole==='operator'?'üõ†Ô∏è':''} ${ch.owner}`, true);
            }
            else if (main === 'kanalac') openCreateChannelPanel();
            else if (main === 'yayin') openLiveStreamModal();
            else addSystemMessage(`‚ùå Bilinmeyen komut: ${cmd}`, true);
        }

        // ========== YOUTUBE ==========
        function onYouTubeIframeAPIReady() {
            let ch = channels[currentChannel];
            ytPlayer = new YT.Player('youtubeContainer', {
                height: '100%', width: '100%',
                videoId: ch.currentVideo,
                playerVars: { autoplay: 1, controls: 0, modestbranding: 1, rel: 0, disablekb: 1, fs: 0, iv_load_policy: 3, playsinline: 1 },
                events: {
                    onReady: e => e.target.playVideo(),
                    onStateChange: e => {
                        document.getElementById('playPauseIcon').className = e.data === YT.PlayerState.PLAYING ? 'fas fa-pause' : 'fas fa-play';
                        isPlaying = e.data === YT.PlayerState.PLAYING;
                    }
                }
            });
        }

        function toggleMute() { if (!ytPlayer) return; if (isMuted) { ytPlayer.unMute(); document.getElementById('muteIcon').className = 'fas fa-volume-up'; } else { ytPlayer.mute(); document.getElementById('muteIcon').className = 'fas fa-volume-mute'; } isMuted = !isMuted; }
        function togglePlayPause() { if (!ytPlayer) return; if (isPlaying) ytPlayer.pauseVideo(); else ytPlayer.playVideo(); }

        // ========== YARDIMCI ==========
        function autoResize(t) { t.style.height = 'auto'; t.style.height = Math.min(t.scrollHeight, 80) + 'px'; }
        function escapeHTML(t) { if (!t) return ''; let d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // ========== KANAL A√á ==========
        function createChannel() {
            if (ACTIVE_USER.role !== 'owner' && ACTIVE_USER.myChannel) { alert('Zaten bir kanalƒ±nƒ±z var!'); return; }
            let name = document.getElementById('newChannelName')?.value?.toLowerCase().trim();
            if (!name) { alert('Kanal adƒ± girin!'); return; }
            if (channels[name]) { alert('Bu kanal adƒ± zaten mevcut!'); return; }
            let desc = document.getElementById('newChannelDesc')?.value?.trim() || `${ACTIVE_USER.name} tarafƒ±ndan olu≈üturuldu.`;
            channels[name] = {
                name, owner: ACTIVE_USER.name, ownerRole: 'coadmin', coAdmins: [ACTIVE_USER.name],
                subscribers: 1, online: 1, description: desc, isPrivate: false, isHidden: false,
                currentVideo: 'jfKfPfyJRdk', currentTitle: 'CETCETY Radio', currentArtist: `üëë ${ACTIVE_USER.name}`,
                playlist: [{ id: 'jfKfPfyJRdk', title: 'CETCETY Radio', addedBy: ACTIVE_USER.name, role: 'coadmin' }],
                onlineUsers: [ACTIVE_USER.name]
            };
            saveChannels();
            ACTIVE_USER.myChannel = name;
            if (ACTIVE_USER.role !== 'owner') ACTIVE_USER.role = 'coadmin';
            if (!ACTIVE_USER.subscribedChannels.includes(name)) ACTIVE_USER.subscribedChannels.push(name);
            localStorage.setItem('cetcety_active_user', JSON.stringify(ACTIVE_USER));
            updateAllBadges(); addSystemMessage(`‚úÖ #${name} kanalƒ± olu≈üturuldu!`, true); joinChannel(name); loadLeftPanel('channels');
        }

        // ========== BA≈ûLANGI√á ==========
        document.addEventListener('DOMContentLoaded', function () {
            if (localStorage.getItem('cetcety_theme') === 'light') document.body.classList.add('light-theme');
            ACTIVE_USER = JSON.parse(localStorage.getItem('cetcety_active_user'));
            if (ACTIVE_USER) {
                if (!channels.genel.onlineUsers.includes(ACTIVE_USER.name)) {
                    channels.genel.onlineUsers.push(ACTIVE_USER.name);
                    saveChannels();
                }
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').style.display = 'flex';
                updateUIForUser();
                loadLeftPanel('subscriptions');
                updateAllBadges();
                updatePlaylist();

                // Firebase ba≈ülat
                initOnlineStatus();
                listenToMessages();
                listenToPrivateMessages();

                MateBot.init();
                addSystemMessage(`üëã Tekrar ho≈ü geldin, ${ACTIVE_USER.name}!`, true);
                if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') {
                    if (!ACTIVE_USER.subscribedChannels.includes('admin')) ACTIVE_USER.subscribedChannels.push('admin');
                    saveChannels();
                }
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('app').style.display = 'none';
            }
            if (!window.YT) { let s = document.createElement('script'); s.src = 'https://www.youtube.com/iframe_api'; document.getElementsByTagName('script')[0].parentNode.insertBefore(s, document.getElementsByTagName('script')[0]); }
        });
    </script>
</body>
</html>
