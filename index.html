<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY â€¢ Ã‡ift Medya</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Firebase.js dosyasÄ± -->
    <script src="firebase.js"></script>
    <style>
        /* AYNI CSS KODLARI (deÄŸiÅŸiklik yok) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: #0f0f0f; 
            color: #fff; 
            overflow: hidden; 
            height: 100vh;
            position: relative;
        }
        
        /* ... diÄŸer tÃ¼m CSS stilleri aynen kalacak ... */
    </style>
</head>
<body>
    <!-- TÃœM HTML YAPISI AYNEN KALACAK -->
    <!-- Login, modaller, paneller vs. -->
    
    <script>
        // ========== GLOBAL DEÄžÄ°ÅžKENLER ==========
        let ytPlayer = null;
        let ytPlayerReady = false;
        let isMuted = false;
        let isPlaying = true;
        let USERS_DB = JSON.parse(localStorage.getItem('cetcety_users')) || [];
        let ACTIVE_USER = null;
        let BLOCKED_USERS = JSON.parse(localStorage.getItem('cetcety_blocks')) || {};
        let BANNED_WORDS = JSON.parse(localStorage.getItem('cetcety_banned_words')) || ['spam', 'reklam', 'ÅŸiddet', 'hakaret'];
        let CUSTOM_COMMANDS = JSON.parse(localStorage.getItem('cetcety_custom_commands')) || [];
        
        // Kanal ve sohbet deÄŸiÅŸkenleri
        let currentPrivateChat = null;
        let currentChannel = 'genel';
        let channels = {};
        let PRIVATE_CHATS = {};
        
        // Firebase listener referanslarÄ±
        let onlineUsersListener = null;
        let messagesListener = null;
        let privateMessagesListener = null;
        let channelsListener = null;
        let notificationsListener = null;

        // Owner Ã¶zel mesaj takip
        let PRIVATE_SPY_CHANNELS = JSON.parse(localStorage.getItem('cetcety_private_spy')) || {};
        let PRIVATE_SPY_ACTIVE = false;
        let PRIVATE_SPY_CURRENT_CHANNEL = null;
        let SUPER_HIDDEN_CHANNELS = JSON.parse(localStorage.getItem('cetcety_super_hidden')) || [];

        const OWNER_PASSWORD = 'Sahi17407@SCM';

        // ========== BAÅžLANGIÃ‡ ==========
        document.addEventListener('DOMContentLoaded', async function() {
            // Firebase'i baÅŸlat
            await initializeFirebase();
            
            // BaÄŸlantÄ± durumunu dinle
            onConnectionChange((connected) => {
                updateConnectionStatus(connected ? 'connected' : 'disconnected', 
                                     connected ? 'BaÄŸlÄ±' : 'BaÄŸlantÄ± Koptu');
                
                if (connected && ACTIVE_USER) {
                    setupRealTimeListeners();
                }
            });
            
            // LocalStorage'dan kanallarÄ± yÃ¼kle
            loadChannelsFromStorage();
            
            // Aktif kullanÄ±cÄ±yÄ± kontrol et
            ACTIVE_USER = JSON.parse(localStorage.getItem('cetcety_active_user'));
            if (ACTIVE_USER) {
                await loginUser(ACTIVE_USER);
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('app').style.display = 'none';
            }
        });

        // ========== GÄ°RÄ°Åž Ä°ÅžLEMÄ° ==========
        async function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('KullanÄ±cÄ± adÄ± boÅŸ olamaz!'); return; }

            // Owner kontrolÃ¼
            if (nick.toLowerCase() === 'mateky' && pass !== OWNER_PASSWORD) { 
                alert('Owner ÅŸifresi hatalÄ±!'); 
                return; 
            }

            let existingUser = USERS_DB.find(u => u.name.toLowerCase() === nick.toLowerCase());
            
            if (existingUser) {
                if (existingUser.password && existingUser.password !== pass) { 
                    alert('HatalÄ± ÅŸifre!'); 
                    return; 
                }
                ACTIVE_USER = existingUser;
            } else {
                ACTIVE_USER = {
                    id: Date.now() + Math.random(),
                    name: nick,
                    role: (nick.toLowerCase() === 'mateky') ? 'owner' : 'user',
                    roleLevel: (nick.toLowerCase() === 'mateky') ? 5 : 1,
                    subscribedChannels: ['genel'],
                    myChannel: null,
                    joinDate: new Date().toISOString(),
                    avatar: nick.charAt(0).toUpperCase(),
                    avatarData: null,
                    password: pass || '',
                    privateMode: 'all',
                    blockedNicks: []
                };
                USERS_DB.push(ACTIVE_USER);
                localStorage.setItem('cetcety_users', JSON.stringify(USERS_DB));
            }

            await loginUser(ACTIVE_USER);
        }

        // ========== KULLANICI GÄ°RÄ°ÅžÄ° SONRASI ==========
        async function loginUser(user) {
            localStorage.setItem('cetcety_active_user', JSON.stringify(user));
            
            // VarsayÄ±lan kanallarÄ± oluÅŸtur
            createDefaultChannels();
            
            // KullanÄ±cÄ±yÄ± genel kanala ekle
            if (!channels.genel.onlineUsers) channels.genel.onlineUsers = [];
            if (!channels.genel.onlineUsers.includes(user.name)) {
                channels.genel.onlineUsers.push(user.name);
            }
            saveChannelsToStorage();

            // UI'Ä± gÃ¼ncelle
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';

            updateUIForUser();
            loadLeftPanel('subscriptions');
            updateAllBadges();
            
            // Real-time listenerlarÄ± kur
            setupRealTimeListeners();
            
            // YouTube player'Ä± baÅŸlat
            initYouTubePlayer();
            
            // Firebase'de online olarak iÅŸaretle
            await updateUserOnlineStatus(user.name, true, currentChannel);
            
            addSystemMessage(`ðŸ‘‹ HoÅŸ geldin, ${user.name}!`);
        }

        // ========== REAL-TIME LISTENERLAR ==========
        function setupRealTimeListeners() {
            if (!ACTIVE_USER) return;
            
            // Eski listenerlarÄ± temizle
            if (onlineUsersListener) onlineUsersListener.off();
            if (messagesListener) messagesListener.off();
            if (channelsListener) channelsListener.off();
            if (notificationsListener) notificationsListener.off();
            
            // Online kullanÄ±cÄ±larÄ± dinle
            onlineUsersListener = listenToOnlineUsers((onlineUsers) => {
                updateOnlineUsers(onlineUsers);
            });
            
            // Kanal mesajlarÄ±nÄ± dinle
            messagesListener = listenToChannelMessages(currentChannel, (message) => {
                handleNewMessage(message);
            });
            
            // Kanal deÄŸiÅŸikliklerini dinle
            channelsListener = listenToChannels((firebaseChannels) => {
                syncChannelsWithFirebase(firebaseChannels);
            });
            
            // Bildirimleri dinle (owner/admin iÃ§in)
            if (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin') {
                notificationsListener = listenToNotifications(ACTIVE_USER.id, (notification) => {
                    handleNewNotification(notification);
                });
            }
            
            // Ã–zel sohbet varsa onu da dinle
            if (currentPrivateChat) {
                startListeningPrivateChat();
            }
        }

        // ========== ONLINE KULLANICILARI GÃœNCELLE ==========
        function updateOnlineUsers(onlineUsers) {
            // TÃ¼m kanallardaki online kullanÄ±cÄ±larÄ± sÄ±fÄ±rla
            Object.keys(channels).forEach(channelName => {
                if (!channels[channelName].onlineUsers) {
                    channels[channelName].onlineUsers = [];
                } else {
                    channels[channelName].onlineUsers = [];
                }
            });
            
            // Online kullanÄ±cÄ±larÄ± kanallara daÄŸÄ±t
            onlineUsers.forEach(user => {
                const channel = user.currentChannel || 'genel';
                if (channels[channel]) {
                    if (!channels[channel].onlineUsers.includes(user.username)) {
                        channels[channel].onlineUsers.push(user.username);
                    }
                }
            });
            
            saveChannelsToStorage();
            
            // UI'Ä± gÃ¼ncelle
            if (currentChannel && channels[currentChannel]) {
                document.getElementById('channelUserCount').textContent = 
                    channels[currentChannel].onlineUsers.length;
            }
            
            // Sohbetler panelini gÃ¼ncelle
            if (document.getElementById('leftPanel').innerHTML.includes('Sohbetlerim')) {
                showOnlineTab();
            }
        }

        // ========== YENÄ° MESAJ Ä°ÅžLE ==========
        function handleNewMessage(message) {
            // MesajÄ± ekrana ekle
            appendMessageToChat({
                sender: message.sender,
                text: message.text,
                time: new Date(message.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
            }, message.sender === ACTIVE_USER?.name);
            
            // Admin mesajÄ±ysa admin kanalÄ±na da ekle
            if (message.isAdmin && message.channel !== 'admin') {
                sendToAdminChannel(message.text);
            }
        }

        // ========== YENÄ° BÄ°LDÄ°RÄ°M Ä°ÅžLE ==========
        function handleNewNotification(notification) {
            // Bildirim sayÄ±sÄ±nÄ± gÃ¼ncelle
            updateNotificationBadge();
            
            // Sistem mesajÄ± olarak gÃ¶ster
            if (!notification.read) {
                addSystemMessage(`ðŸ”” ${notification.message}`);
            }
        }

        // ========== Ã–ZEL SOHBET DÄ°NLEME ==========
        function startListeningPrivateChat() {
            if (!currentPrivateChat || !ACTIVE_USER) return;
            
            if (privateMessagesListener) {
                privateMessagesListener.off();
            }
            
            const chatId = [ACTIVE_USER.id, currentPrivateChat.id].sort().join('_');
            
            privateMessagesListener = listenToPrivateMessages(chatId, (message) => {
                handleNewPrivateMessage(message, chatId);
            });
        }

        // ========== YENÄ° Ã–ZEL MESAJ Ä°ÅžLE ==========
        function handleNewPrivateMessage(message, chatId) {
            // MesajÄ± yerel depolamaya ekle
            if (!PRIVATE_CHATS[chatId]) PRIVATE_CHATS[chatId] = [];
            PRIVATE_CHATS[chatId].push(message);
            localStorage.setItem('cetcety_private_chats', JSON.stringify(PRIVATE_CHATS));
            
            // Sadece mevcut Ã¶zel sohbet aÃ§Ä±ksa gÃ¶ster
            if (currentPrivateChat && 
                (message.senderId === ACTIVE_USER?.id || message.senderId === currentPrivateChat.id)) {
                loadPrivateMessages();
            }
            
            // OkunmamÄ±ÅŸ mesaj sayÄ±sÄ±nÄ± gÃ¼ncelle
            updateUnreadBadge();
            
            // Owner takibi varsa logla
            if (ACTIVE_USER?.role === 'owner' && PRIVATE_SPY_ACTIVE) {
                logPrivateMessageForOwner(
                    message.senderName,
                    message.senderId === ACTIVE_USER.id ? currentPrivateChat?.name : ACTIVE_USER.name,
                    message.content,
                    message.type,
                    message.content
                );
            }
        }

        // ========== KANAL DEÄžÄ°ÅžTÄ°RME ==========
        async function joinChannel(ch) {
            if (!channels[ch]) return;

            // Eski kanaldan ayrÄ±l
            if (currentChannel && channels[currentChannel]) {
                if (channels[currentChannel].onlineUsers) {
                    channels[currentChannel].onlineUsers = 
                        channels[currentChannel].onlineUsers.filter(u => u !== ACTIVE_USER.name);
                }
                saveChannelsToStorage();
            }

            currentChannel = ch;
            
            // Yeni kanala katÄ±l
            if (!channels[ch].onlineUsers) channels[ch].onlineUsers = [];
            if (!channels[ch].onlineUsers.includes(ACTIVE_USER.name)) {
                channels[ch].onlineUsers.push(ACTIVE_USER.name);
            }
            saveChannelsToStorage();

            // Firebase'de kullanÄ±cÄ± durumunu gÃ¼ncelle
            await updateUserOnlineStatus(ACTIVE_USER.name, true, ch);
            
            // Mesaj listener'Ä±nÄ± gÃ¼ncelle
            if (messagesListener) messagesListener.off();
            messagesListener = listenToChannelMessages(currentChannel, handleNewMessage);

            // UI'Ä± gÃ¼ncelle
            document.getElementById('currentChannelName').textContent = ch;
            document.getElementById('channelUserCount').textContent = channels[ch].onlineUsers.length;
            
            let sub = channels[ch].subscribers || 1;
            let fmt = sub >= 1000000 ? (sub / 1000000).toFixed(1) + 'M' : 
                      sub >= 1000 ? (sub / 1000).toFixed(1) + 'K' : sub;
            document.getElementById('channelSubscribers').textContent = fmt;

            updateMediaDisplay();
            clearMessages();
            addSystemMessage(`ðŸ“¢ #${ch} kanalÄ±na katÄ±ldÄ±n! ${fmt} abone, ${channels[ch].onlineUsers.length} Ã§evrimiÃ§i.`);

            // Abone butonunu gÃ¼ncelle
            let subBtn = document.getElementById('subscribeChannelBtn');
            if (ACTIVE_USER.subscribedChannels.includes(ch)) {
                subBtn.innerHTML = '<i class="fas fa-check"></i> Abone Olundu';
                subBtn.classList.add('subscribed');
            } else {
                subBtn.innerHTML = '<i class="fas fa-plus"></i> Abone Ol';
                subBtn.classList.remove('subscribed');
            }
        }

        // ========== MESAJ GÃ–NDER ==========
        async function sendMessage() {
            let inp = document.getElementById('messageInput');
            let txt = inp.value.trim();
            if (!txt) return;
            
            if (txt.startsWith('/')) {
                handleCommand(txt);
                inp.value = '';
                autoResize(inp);
                return;
            }

            let banned = checkBannedWords(txt);
            if (banned) {
                addSystemMessage(`ðŸš« YasaklÄ± kelime tespit edildi: "${banned}"`);
                inp.value = '';
                autoResize(inp);
                return;
            }

            let messageData = {
                sender: ACTIVE_USER.name,
                senderId: ACTIVE_USER.id,
                text: txt,
                channel: currentChannel,
                isAdmin: (ACTIVE_USER.role === 'owner' || ACTIVE_USER.role === 'admin')
            };

            // Firebase'e gÃ¶nder
            const success = await sendMessage(messageData);
            
            if (!success) {
                // Firebase yoksa yerel depolamaya kaydet
                let time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                let localMsg = {
                    sender: ACTIVE_USER.name,
                    text: txt,
                    time: time
                };
                appendMessageToChat(localMsg, true);
            }
            
            inp.value = '';
            autoResize(inp);
        }

        // ========== Ã–ZEL MESAJ GÃ–NDER ==========
        async function sendPrivateMessage() {
            let input = document.getElementById('privateMessageInput');
            if (!input) return;
            let text = input.value.trim();
            if (!text || !currentPrivateChat || !ACTIVE_USER) return;
            
            let banned = checkBannedWords(text);
            if (banned) {
                addSystemMessage(`ðŸš« YasaklÄ± kelime tespit edildi: "${banned}"`);
                input.value = '';
                return;
            }
            
            let chatId = [ACTIVE_USER.id, currentPrivateChat.id].sort().join('_');

            let messageData = {
                senderId: ACTIVE_USER.id,
                senderName: ACTIVE_USER.name,
                type: 'text',
                content: text
            };

            // Firebase'e gÃ¶nder
            const success = await sendPrivateMessage(chatId, messageData);
            
            if (!success) {
                // Firebase yoksa yerel depolamaya kaydet
                if (!PRIVATE_CHATS[chatId]) PRIVATE_CHATS[chatId] = [];
                PRIVATE_CHATS[chatId].push({
                    ...messageData,
                    timestamp: Date.now()
                });
                localStorage.setItem('cetcety_private_chats', JSON.stringify(PRIVATE_CHATS));
                loadPrivateMessages();
            }

            input.value = '';
        }

        // ========== VarsayÄ±lan KanallarÄ± OluÅŸtur ==========
        function createDefaultChannels() {
            if (Object.keys(channels).length === 0) {
                channels = {
                    'genel': { 
                        name:'genel', 
                        owner:'MateKy', 
                        ownerRole:'owner', 
                        coAdmins:[], 
                        subscribers:1, 
                        online:1, 
                        isHidden:false,
                        isSuperHidden: false,
                        youtube: { 
                            currentVideo:'QKEHXrDVBF8', 
                            currentTitle:'Crispy Concords', 
                            currentArtist:'MateKy', 
                            playlist:[{id:'QKEHXrDVBF8', title:'Crispy Concords', addedBy:'MateKy', role:'owner'}]
                        },
                        onlineUsers:[]
                    },
                    'admin': { 
                        name:'admin', 
                        owner:'MateKy', 
                        ownerRole:'owner', 
                        coAdmins:[], 
                        subscribers:1, 
                        online:1, 
                        isHidden:false,
                        isSuperHidden: false,
                        youtube: { 
                            currentVideo:'QKEHXrDVBF8', 
                            currentTitle:'Crispy Concords', 
                            currentArtist:'MateKy', 
                            playlist:[{id:'QKEHXrDVBF8', title:'Crispy Concords', addedBy:'MateKy', role:'owner'}]
                        },
                        onlineUsers:[]
                    }
                };
            }
        }

        // ========== LocalStorage Ä°ÅŸlemleri ==========
        function loadChannelsFromStorage() {
            channels = JSON.parse(localStorage.getItem('cetcety_channels')) || {};
            createDefaultChannels();
        }

        function saveChannelsToStorage() {
            localStorage.setItem('cetcety_channels', JSON.stringify(channels));
        }

        function syncChannelsWithFirebase(firebaseChannels) {
            // Firebase'deki kanallarÄ± yerel kanallarla birleÅŸtir
            Object.keys(firebaseChannels).forEach(channelName => {
                channels[channelName] = firebaseChannels[channelName];
            });
            
            // Silinen kanallarÄ± temizle
            Object.keys(channels).forEach(channelName => {
                if (!firebaseChannels[channelName] && channelName !== 'genel' && channelName !== 'admin') {
                    delete channels[channelName];
                }
            });
            
            saveChannelsToStorage();
            
            // UI'Ä± gÃ¼ncelle
            if (currentChannel && !channels[currentChannel]) {
                joinChannel('genel');
            }
            
            updateMediaDisplay();
        }

        // ========== DiÄŸer yardÄ±mcÄ± fonksiyonlar ==========
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function updateNotificationBadge() {
            // Bildirim sayÄ±sÄ±nÄ± gÃ¼ncelle (ilerde eklenecek)
        }

        // ========== Mevcut diÄŸer tÃ¼m fonksiyonlar aynen kalacak ==========
        // (loadLeftPanel, loadSubscriptionsPanel, loadChannelsPanel, 
        //  loadChatListPanel, loadProfilePanel, YouTube fonksiyonlarÄ±,
        //  komut iÅŸleyiciler, vs.)
        
    </script>
</body>
</html>
