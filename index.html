<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY ‚Ä¢ Ger√ßek Zamanlƒ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* AYNI CSS KODLARI - KISALTMAK ƒ∞√áƒ∞N √áIKARDIM */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0f0f0f; color: #fff; overflow: hidden; height: 100vh; }
        body.light-theme { background: #f5f5f5; color: #1a1a1a; }
        .app { display: flex; height: 100vh; width: 100vw; position: relative; }
        /* T√ºm CSS stilleri aynen kalacak - buraya kopyalayƒ±n */
    </style>
</head>
<body>
    <!-- Gƒ∞Rƒ∞≈û EKRANI -->
    <div id="loginOverlay" class="login-overlay" style="background: url('https://source.unsplash.com/1920x1080/?abstract,technology,dark')">
        <div class="login-panel">
            <h2>üéß CETCETY</h2>
            <div class="form-group">
                <label>Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="loginNick" placeholder="√∂rn: kullanici" autocomplete="off">
            </div>
            <div class="form-group">
                <label>≈ûifre</label>
                <div class="password-wrapper">
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <i class="fas fa-eye password-toggle" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <button onclick="handleLogin()">Giri≈ü Yap / Kayƒ±t Ol</button>
            <div class="login-info">Kayƒ±tlƒ± nickler ≈üifre ile. Kayƒ±tsƒ±z nickler ≈üifresiz.</div>
        </div>
    </div>

    <!-- ANA UYGULAMA -->
    <div id="app" class="app" style="display: none;">
        <!-- SOL ƒ∞KON PANELƒ∞ -->
        <div class="icon-panel">
            <div class="icon-item" onclick="showHome()" title="Ana Sayfa"><i class="fas fa-home"></i></div>
            <div class="icon-item" onclick="openSubscriptions()" title="Abonelikler"><i class="fas fa-bell"></i><span class="icon-badge" id="subscriptionBadge">0</span></div>
            <div class="icon-item" onclick="openChannelPanel()" title="Kanallar"><i class="fas fa-list-ul"></i><span class="icon-badge" id="channelCountBadge">0</span></div>
            <div class="icon-item" onclick="openChatListPanel()" title="Sohbetlerim"><i class="fas fa-comment"></i><span class="icon-badge" id="chatListBadge">0</span></div>
            <div class="icon-item" onclick="openNotificationPanel()" title="Bildirimler"><i class="fas fa-bell"></i><span class="icon-badge" id="notificationBadge">0</span></div>
            <div class="icon-item" onclick="toggleTheme()" id="themeIcon" title="Tema Deƒüi≈ütir"><i class="fas fa-moon"></i></div>
            <div class="profile-avatar" id="profileAvatar" onclick="openProfilePanel()"><span id="avatarText">?</span></div>
        </div>

        <div class="main-content">
            <!-- SOL PANEL -->
            <div class="left-panel" id="leftPanel"></div>

            <!-- CHAT PANELƒ∞ -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-hashtag"></i>
                        <span id="currentChannelName">genel</span>
                        <span class="channel-info-bar">
                            <span id="channelUserCount">0</span> √ßevrimi√ßi ‚Ä¢ 
                            <span id="channelSubscribers">0</span> abone
                        </span>
                    </div>
                    <button id="subscribeChannelBtn" class="channel-subscribe-btn" onclick="toggleChannelSubscribe()"><i class="fas fa-plus"></i> Abone Ol</button>
                </div>
                <div class="messages" id="messages">
                    <div class="system-message"><i class="fas fa-info-circle"></i> CETCETY'ye ho≈ü geldin!</div>
                </div>
                <div class="message-input-container">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" placeholder="Mesaj yazƒ±n..." rows="1" oninput="autoResize(this)"></textarea>
                        <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>

                <!-- √ñZEL SOHBET PANELƒ∞ -->
                <div id="privateChatPanel" class="private-chat-panel">
                    <div class="private-chat-header">
                        <div class="private-chat-user">
                            <div class="private-chat-avatar" id="privateChatAvatar">üë§</div>
                            <div class="private-chat-info">
                                <h4 id="privateChatName">Kullanƒ±cƒ±</h4>
                                <span id="privateChatStatus">√áevrimi√ßi</span>
                            </div>
                        </div>
                        <div class="private-chat-actions">
                            <div class="private-chat-action" onclick="blockUser()" title="Engelle (24 saat)"><i class="fas fa-ban"></i></div>
                            <div class="private-chat-action" onclick="reportUser()" title="≈ûikayet Et"><i class="fas fa-flag"></i></div>
                            <div class="private-chat-action" onclick="closePrivateChat()" title="Kapat"><i class="fas fa-times"></i></div>
                        </div>
                    </div>
                    <div class="private-chat-messages" id="privateChatMessages"></div>
                    <div class="private-input-container">
                        <div class="private-input-wrapper">
                            <div class="private-text-input">
                                <textarea id="privateMessageInput" class="private-input" placeholder="Mesaj yazƒ±n..." rows="1"></textarea>
                                <div class="private-send-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MEDYA PANELƒ∞ -->
            <div class="media-panel">
                <div class="media-header">
                    <div class="media-title"><i class="fab fa-youtube"></i><span id="currentChannelPlaylist">#genel playlist</span></div>
                    <div class="media-controls">
                        <div id="addMediaBtn" class="media-control" onclick="openAddVideoModal()" title="Video Ekle">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>
                
                <!-- YouTube Player -->
                <div class="youtube-player">
                    <div id="youtubeContainer"></div>
                    <div class="player-controls">
                        <div class="player-btn" id="playerMuteBtn" onclick="toggleMute()">
                            <i class="fas fa-volume-up" id="muteIcon"></i>
                        </div>
                        <div class="player-btn" id="playerPlayPauseBtn" onclick="togglePlayPause()">
                            <i class="fas fa-pause" id="playPauseIcon"></i>
                        </div>
                    </div>
                </div>
                
                <!-- ≈ûu An √áalƒ±yor -->
                <div class="now-playing">
                    <i class="fas fa-circle"></i>
                    <span id="nowPlayingTitle">CETCETY Radio</span>
                    <span id="nowPlayingOwner" style="color: #6495ed; margin-left: auto;">üë§ -</span>
                </div>
                
                <!-- Playlist -->
                <div class="playlist-container">
                    <div class="playlist-header">
                        <span class="playlist-title"><i class="fas fa-list"></i> Kanal Playlist</span>
                        <span class="playlist-count" id="playlistCount">0 video</span>
                    </div>
                    <div id="playlistItems" class="playlist-items"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vƒ∞DEO EKLEME MODAL -->
    <div id="addVideoModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a1a; padding:20px; border-radius:12px; z-index:2000; width:400px;">
        <h3 style="color:#ffd700; margin-bottom:15px;">Video Ekle</h3>
        <input type="text" id="videoUrl" placeholder="YouTube URL veya ID" style="width:100%; padding:10px; margin-bottom:10px; background:#0a0a0a; border:1px solid #333; color:#fff; border-radius:6px;">
        <input type="text" id="videoTitle" placeholder="Video Ba≈ülƒ±ƒüƒ±" style="width:100%; padding:10px; margin-bottom:10px; background:#0a0a0a; border:1px solid #333; color:#fff; border-radius:6px;">
        <div style="display:flex; gap:10px;">
            <button onclick="addVideoToPlaylist()" style="flex:1; padding:10px; background:#ff0000; color:#fff; border:none; border-radius:6px; cursor:pointer;">Ekle</button>
            <button onclick="closeAddVideoModal()" style="flex:1; padding:10px; background:#333; color:#fff; border:none; border-radius:6px; cursor:pointer;">ƒ∞ptal</button>
        </div>
    </div>

    <script>
        // ========== FIREBASE KONFƒ∞G√úRASYONU ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.appspot.com",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };

        // Firebase ba≈ülat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ========== GLOBAL DEƒûƒ∞≈ûKENLER ==========
        let ytPlayer, isMuted = false, isPlaying = true;
        let ACTIVE_USER = null;
        let currentChannel = 'genel';
        let currentPrivateChat = null;
        let activeListeners = {};

        // ========== Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞ ==========
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('togglePassword');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash password-toggle';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye password-toggle';
            }
        }

        function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('Kullanƒ±cƒ± adƒ± bo≈ü olamaz!'); return; }

            // Kullanƒ±cƒ±yƒ± Firebase'de kontrol et/kaydet
            database.ref(`users/${nick.toLowerCase()}`).once('value', snapshot => {
                let userData = snapshot.val();
                
                if (userData) {
                    // ≈ûifre kontrol√º
                    if (userData.password && userData.password !== pass) {
                        alert('Hatalƒ± ≈üifre!');
                        return;
                    }
                    
                    ACTIVE_USER = {
                        id: userData.id,
                        name: userData.name,
                        role: userData.role || 'user',
                        subscribedChannels: userData.subscribedChannels || ['genel']
                    };
                } else {
                    // Yeni kullanƒ±cƒ±
                    ACTIVE_USER = {
                        id: Date.now().toString(),
                        name: nick,
                        role: 'user',
                        subscribedChannels: ['genel']
                    };
                    
                    // Firebase'e kaydet
                    database.ref(`users/${nick.toLowerCase()}`).set({
                        id: ACTIVE_USER.id,
                        name: nick,
                        password: pass || '',
                        role: 'user',
                        subscribedChannels: ['genel'],
                        joinDate: Date.now()
                    });
                }

                // Giri≈ü yap
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').style.display = 'flex';
                
                // Kullanƒ±cƒ±yƒ± online yap
                userJoined();
                
                // UI'ƒ± g√ºncelle
                updateUIForUser();
                loadLeftPanel('subscriptions');
                addSystemMessage(`üëã Ho≈ü geldin, ${ACTIVE_USER.name}!`);
            });
        }

        // ========== GER√áEK ZAMANLI FONKSƒ∞YONLAR ==========
        function userJoined() {
            if (!ACTIVE_USER) return;
            
            // Kullanƒ±cƒ±yƒ± online listesine ekle
            const userRef = database.ref(`online/${currentChannel}/${ACTIVE_USER.id}`);
            userRef.set({
                name: ACTIVE_USER.name,
                role: ACTIVE_USER.role,
                lastSeen: Date.now()
            });
            
            // Baƒülantƒ± kesilince otomatik sil
            userRef.onDisconnect().remove();
            
            // Kanal deƒüi≈üimini dinle
            startChannelListeners(currentChannel);
            
            // T√ºm kullanƒ±cƒ±larƒ±n online durumunu dinle
            startOnlineListeners();
        }

        function startOnlineListeners() {
            // T√ºm kanallardaki online kullanƒ±cƒ±larƒ± dinle
            database.ref('online').on('value', snapshot => {
                const allOnline = snapshot.val() || {};
                
                // Sol paneldeki online listesini g√ºncelle
                if (document.getElementById('tabOnline')?.classList.contains('active')) {
                    showOnlineTab();
                }
                
                // Bildirim rozetini g√ºncelle (opsiyonel)
            });
        }

        function startChannelListeners(channel) {
            // Eski listener'larƒ± temizle
            if (activeListeners[channel]) {
                database.ref(`chats/${channel}`).off();
                database.ref(`online/${channel}`).off();
                database.ref(`playlist/${channel}`).off();
                database.ref(`nowplaying/${channel}`).off();
            }
            
            // Yeni mesajlarƒ± dinle
            database.ref(`chats/${channel}`).on('child_added', snapshot => {
                const msg = snapshot.val();
                if (channel === currentChannel) {
                    appendMessageToChat(msg, msg.sender === ACTIVE_USER?.name);
                }
            });
            
            // Online kullanƒ±cƒ±larƒ± dinle
            database.ref(`online/${channel}`).on('value', snapshot => {
                const onlineUsers = snapshot.val() || {};
                const onlineCount = Object.keys(onlineUsers).length;
                
                if (channel === currentChannel) {
                    document.getElementById('channelUserCount').textContent = onlineCount;
                    
                    // Online listesini g√ºncelle
                    if (document.getElementById('tabOnline')?.classList.contains('active')) {
                        showOnlineTab();
                    }
                }
            });
            
            // Playlist deƒüi≈üimlerini dinle
            database.ref(`playlist/${channel}`).on('value', snapshot => {
                const playlist = snapshot.val() || [];
                if (channel === currentChannel) {
                    updatePlaylistUI(playlist);
                }
            });
            
            // ≈ûu an oynayan videoyu dinle
            database.ref(`nowplaying/${channel}`).on('value', snapshot => {
                const nowPlaying = snapshot.val();
                if (channel === currentChannel && nowPlaying) {
                    document.getElementById('nowPlayingTitle').textContent = nowPlaying.title || 'CETCETY Radio';
                    
                    if (ytPlayer && nowPlaying.id) {
                        ytPlayer.loadVideoById(nowPlaying.id);
                    }
                }
            });
            
            activeListeners[channel] = true;
        }

        // ========== MESAJ FONKSƒ∞YONLARI ==========
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !ACTIVE_USER) return;
            
            const msg = {
                sender: ACTIVE_USER.name,
                text: text,
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                userId: ACTIVE_USER.id
            };
            
            // Firebase'e g√∂nder
            database.ref(`chats/${currentChannel}`).push(msg);
            
            input.value = '';
            autoResize(input);
        }

        function appendMessageToChat(msg, isMe) {
            const container = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isMe ? 'right' : ''}`;
            msgDiv.innerHTML = `
                <div class="message-header" style="${isMe ? 'justify-content: flex-end;' : ''}">
                    <span class="message-time">${msg.time}</span>
                    <span class="message-sender">${escapeHTML(msg.sender)}</span>
                </div>
                <div class="message-text">${escapeHTML(msg.text)}</div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'system-message';
            div.innerHTML = `<i class="fas fa-info-circle"></i> ${escapeHTML(text)}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ========== KANAL ƒ∞≈ûLEMLERƒ∞ ==========
        function joinChannel(channelName) {
            if (!ACTIVE_USER) return;
            
            // Eski kanaldan √ßƒ±k
            if (currentChannel) {
                database.ref(`online/${currentChannel}/${ACTIVE_USER.id}`).remove();
            }
            
            // Yeni kanala katƒ±l
            currentChannel = channelName;
            database.ref(`online/${channelName}/${ACTIVE_USER.id}`).set({
                name: ACTIVE_USER.name,
                role: ACTIVE_USER.role,
                lastSeen: Date.now()
            });
            
            // UI g√ºncelle
            document.getElementById('currentChannelName').textContent = channelName;
            document.getElementById('currentChannelPlaylist').textContent = `#${channelName} playlist`;
            
            // Mesajlarƒ± temizle
            document.getElementById('messages').innerHTML = '';
            
            // Kanal listener'larƒ±nƒ± ba≈ülat
            startChannelListeners(channelName);
            
            // Playlist'i y√ºkle
            database.ref(`playlist/${channelName}`).once('value', snapshot => {
                const playlist = snapshot.val() || [];
                updatePlaylistUI(playlist);
            });
            
            // ≈ûu an oynayanƒ± y√ºkle
            database.ref(`nowplaying/${channelName}`).once('value', snapshot => {
                const nowPlaying = snapshot.val();
                if (nowPlaying) {
                    document.getElementById('nowPlayingTitle').textContent = nowPlaying.title || 'CETCETY Radio';
                    document.getElementById('nowPlayingOwner').innerHTML = `üë§ ${nowPlaying.addedBy || '-'}`;
                    
                    if (ytPlayer && nowPlaying.id) {
                        ytPlayer.loadVideoById(nowPlaying.id);
                    }
                }
            });
            
            // Abone sayƒ±sƒ±nƒ± g√ºncelle
            database.ref(`channels/${channelName}/subscribers`).once('value', snapshot => {
                const subs = snapshot.val() || 0;
                document.getElementById('channelSubscribers').textContent = formatSubscribers(subs);
            });
            
            updateSubscribeButton();
            closeLeftPanel();
        }

        function subscribeChannel() {
            if (!ACTIVE_USER) return;
            
            // Firebase'de abone sayƒ±sƒ±nƒ± g√ºncelle
            database.ref(`channels/${currentChannel}/subscribers`).transaction(current => {
                return (current || 0) + 1;
            });
            
            // Kullanƒ±cƒ±nƒ±n aboneliklerini g√ºncelle
            if (!ACTIVE_USER.subscribedChannels.includes(currentChannel)) {
                ACTIVE_USER.subscribedChannels.push(currentChannel);
                
                database.ref(`users/${ACTIVE_USER.name.toLowerCase()}/subscribedChannels`).set(ACTIVE_USER.subscribedChannels);
            }
            
            updateSubscribeButton();
        }

        function unsubscribeChannel() {
            if (!ACTIVE_USER) return;
            
            // Firebase'de abone sayƒ±sƒ±nƒ± g√ºncelle
            database.ref(`channels/${currentChannel}/subscribers`).transaction(current => {
                return Math.max(0, (current || 0) - 1);
            });
            
            // Kullanƒ±cƒ±nƒ±n aboneliklerini g√ºncelle
            const index = ACTIVE_USER.subscribedChannels.indexOf(currentChannel);
            if (index > -1) {
                ACTIVE_USER.subscribedChannels.splice(index, 1);
                database.ref(`users/${ACTIVE_USER.name.toLowerCase()}/subscribedChannels`).set(ACTIVE_USER.subscribedChannels);
            }
            
            updateSubscribeButton();
        }

        function toggleChannelSubscribe() {
            if (ACTIVE_USER.subscribedChannels.includes(currentChannel)) {
                unsubscribeChannel();
            } else {
                subscribeChannel();
            }
        }

        function updateSubscribeButton() {
            const btn = document.getElementById('subscribeChannelBtn');
            if (ACTIVE_USER.subscribedChannels.includes(currentChannel)) {
                btn.innerHTML = '<i class="fas fa-check"></i> Abone Olundu';
                btn.classList.add('subscribed');
            } else {
                btn.innerHTML = '<i class="fas fa-plus"></i> Abone Ol';
                btn.classList.remove('subscribed');
            }
        }

        // ========== PLAYLIST ƒ∞≈ûLEMLERƒ∞ ==========
        function openAddVideoModal() {
            document.getElementById('addVideoModal').style.display = 'block';
        }

        function closeAddVideoModal() {
            document.getElementById('addVideoModal').style.display = 'none';
            document.getElementById('videoUrl').value = '';
            document.getElementById('videoTitle').value = '';
        }

        function addVideoToPlaylist() {
            const url = document.getElementById('videoUrl').value.trim();
            const title = document.getElementById('videoTitle').value.trim() || 'Yeni Video';
            
            if (!url) return;
            
            // YouTube ID'sini √ßƒ±kar
            let videoId = url;
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            if (match) {
                videoId = match[1];
            }
            
            // Playlist'e ekle
            database.ref(`playlist/${currentChannel}`).once('value', snapshot => {
                const playlist = snapshot.val() || [];
                playlist.push({
                    id: videoId,
                    title: title,
                    addedBy: ACTIVE_USER.name,
                    addedAt: Date.now()
                });
                
                database.ref(`playlist/${currentChannel}`).set(playlist);
            });
            
            closeAddVideoModal();
        }

        function updatePlaylistUI(playlist) {
            const container = document.getElementById('playlistItems');
            if (!container) return;
            
            document.getElementById('playlistCount').textContent = `${playlist.length} video`;
            
            let html = '';
            playlist.forEach((video, index) => {
                html += `
                    <div class="playlist-item" onclick="playVideo(${index})">
                        <div class="playlist-thumb"><i class="fab fa-youtube"></i></div>
                        <div class="playlist-info">
                            <div class="playlist-title">${escapeHTML(video.title)}</div>
                            <div class="playlist-meta">${video.addedBy || 'Sistem'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function playVideo(index) {
            database.ref(`playlist/${currentChannel}`).once('value', snapshot => {
                const playlist = snapshot.val() || [];
                if (playlist[index]) {
                    const video = playlist[index];
                    
                    // ≈ûu an oynayanƒ± g√ºncelle
                    database.ref(`nowplaying/${currentChannel}`).set({
                        id: video.id,
                        title: video.title,
                        addedBy: video.addedBy,
                        index: index
                    });
                }
            });
        }

        // ========== √ñZEL SOHBET ==========
        function openPrivateChat(username) {
            if (!ACTIVE_USER || username === ACTIVE_USER.name) return;
            
            currentPrivateChat = username;
            
            document.getElementById('privateChatName').textContent = username;
            document.getElementById('privateChatAvatar').innerHTML = username.charAt(0).toUpperCase();
            document.getElementById('privateChatPanel').classList.add('active');
            
            // √ñzel sohbet mesajlarƒ±nƒ± dinle
            const chatId = [ACTIVE_USER.id, username].sort().join('_');
            
            // Eski listener'ƒ± temizle
            if (activeListeners[`private_${chatId}`]) {
                database.ref(`private/${chatId}`).off();
            }
            
            // Mesajlarƒ± dinle
            database.ref(`private/${chatId}`).on('child_added', snapshot => {
                const msg = snapshot.val();
                appendPrivateMessage(msg, msg.senderId === ACTIVE_USER.id);
            });
            
            activeListeners[`private_${chatId}`] = true;
        }

        function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            if (!text || !currentPrivateChat) return;
            
            const chatId = [ACTIVE_USER.id, currentPrivateChat].sort().join('_');
            
            const msg = {
                senderId: ACTIVE_USER.id,
                senderName: ACTIVE_USER.name,
                text: text,
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
            
            database.ref(`private/${chatId}`).push(msg);
            
            input.value = '';
        }

        function appendPrivateMessage(msg, isMe) {
            const container = document.getElementById('privateChatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `private-message ${isMe ? 'right' : ''}`;
            msgDiv.innerHTML = `
                <div class="private-message-header" style="${isMe ? 'justify-content: flex-end;' : ''}">
                    <span class="private-message-time">${msg.time}</span>
                    <span class="private-message-sender">${msg.senderName}</span>
                </div>
                <div class="private-message-text">${escapeHTML(msg.text)}</div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChat = null;
            
            // Listener'ƒ± temizle
            if (activeListeners.private) {
                database.ref('private').off();
                activeListeners.private = false;
            }
        }

        function blockUser() {
            if (currentPrivateChat) {
                addSystemMessage(`üö´ ${currentPrivateChat} 24 saatliƒüine engellendi.`);
                closePrivateChat();
            }
        }

        function reportUser() {
            if (currentPrivateChat) {
                addSystemMessage(`‚ö†Ô∏è ${currentPrivateChat} ≈üikayet edildi.`);
            }
        }

        // ========== SOL PANEL FONKSƒ∞YONLARI ==========
        function loadLeftPanel(panelName) {
            const panel = document.getElementById('leftPanel');
            
            if (panelName === 'subscriptions') loadSubscriptionsPanel(panel);
            else if (panelName === 'channels') loadChannelsPanel(panel);
            else if (panelName === 'chatlist') loadChatListPanel(panel);
            else if (panelName === 'notifications') loadNotificationsPanel(panel);
            else if (panelName === 'profile') loadProfilePanel(panel);
            
            setActiveIcon(panelName);
        }

        function loadSubscriptionsPanel(panel) {
            let html = `
                <div class="panel-header">
                    <h3><i class="fas fa-bell" style="color:#ffd700;"></i> Abonelikler</h3>
                    <div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div>
                </div>
                <div class="panel-content" id="subscriptionsContent">
                    <div style="color:#aaa; text-align:center; padding:20px;">Y√ºkleniyor...</div>
                </div>
            `;
            panel.innerHTML = html;
            
            // Abonelikleri Firebase'den y√ºkle
            database.ref('channels').once('value', snapshot => {
                const allChannels = snapshot.val() || {};
                const subs = ACTIVE_USER.subscribedChannels || [];
                
                let content = '';
                subs.forEach(chName => {
                    const ch = allChannels[chName] || { owner: 'Sistem', subscribers: 0 };
                    content += `
                        <div class="subscription-item ${chName === currentChannel ? 'active' : ''}" onclick="joinChannel('${chName}')">
                            <div class="subscription-avatar"><i class="fas fa-hashtag"></i></div>
                            <div class="subscription-info">
                                <div class="subscription-name">${chName}</div>
                                <div class="subscription-meta">${ch.owner} ‚Ä¢ ${formatSubscribers(ch.subscribers || 0)} abone</div>
                            </div>
                        </div>
                    `;
                });
                
                if (content === '') {
                    content = '<div style="color:#aaa; padding:16px; text-align:center;">Abone olunan kanal yok.</div>';
                }
                
                document.getElementById('subscriptionsContent').innerHTML = content;
            });
        }

        function loadChannelsPanel(panel) {
            let html = `
                <div class="panel-header">
                    <h3><i class="fas fa-list-ul" style="color:#ff0000;"></i> T√ºm Kanallar</h3>
                    <div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div>
                </div>
                <div class="panel-content" id="channelsContent">
                    <div style="color:#aaa; text-align:center; padding:20px;">Y√ºkleniyor...</div>
                </div>
            `;
            panel.innerHTML = html;
            
            // Kanallarƒ± Firebase'den y√ºkle
            database.ref('channels').once('value', snapshot => {
                const channels = snapshot.val() || {};
                
                let content = '';
                Object.entries(channels).sort((a,b) => (b[1].subscribers || 0) - (a[1].subscribers || 0)).forEach(([name, data]) => {
                    const isSub = ACTIVE_USER.subscribedChannels.includes(name);
                    content += `
                        <div class="channel-item" onclick="joinChannel('${name}')">
                            <div class="channel-avatar"><i class="fas fa-hashtag"></i></div>
                            <div class="channel-info">
                                <div class="channel-name">${name}</div>
                                <div class="channel-meta">${data.owner || 'Sistem'} ‚Ä¢ ${formatSubscribers(data.subscribers || 0)} abone</div>
                            </div>
                            <button class="subscribe-btn ${isSub ? 'subscribed' : ''}" onclick="event.stopPropagation(); ${isSub ? 'unsubscribeChannel' : 'subscribeChannel'}('${name}')">
                                <i class="fas ${isSub ? 'fa-check' : 'fa-plus'}"></i> ${isSub ? 'Abone Olundu' : 'Abone Ol'}
                            </button>
                        </div>
                    `;
                });
                
                document.getElementById('channelsContent').innerHTML = content;
            });
        }

        function loadChatListPanel(panel) {
            let html = `
                <div class="panel-header">
                    <h3><i class="fas fa-comment" style="color:#7289da;"></i> Sohbetlerim</h3>
                    <div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div>
                </div>
                <div class="panel-tabs">
                    <div id="tabChats" class="panel-tab active" onclick="switchChatTab('chats')">Sohbetler</div>
                    <div id="tabOnline" class="panel-tab" onclick="switchChatTab('online')">√áevrimi√ßi</div>
                </div>
                <div class="panel-content" id="chatPanelContent"></div>
            `;
            panel.innerHTML = html;
            showOnlineTab(); // Varsayƒ±lan olarak online g√∂ster
        }

        function switchChatTab(tab) {
            document.getElementById('tabChats').classList.toggle('active', tab === 'chats');
            document.getElementById('tabOnline').classList.toggle('active', tab === 'online');
            
            if (tab === 'chats') showChatsTab();
            else showOnlineTab();
        }

        function showOnlineTab() {
            const container = document.getElementById('chatPanelContent');
            
            database.ref(`online/${currentChannel}`).once('value', snapshot => {
                const onlineUsers = snapshot.val() || {};
                
                let content = '';
                Object.values(onlineUsers).forEach(user => {
                    if (user.name !== ACTIVE_USER.name) {
                        content += `
                            <div class="online-item" onclick="openPrivateChat('${user.name}')">
                                <div class="online-avatar"><span>${user.name.charAt(0)}</span></div>
                                <div class="online-info">
                                    <div class="online-name">${user.name}<span class="online-status"></span></div>
                                    <div class="online-meta">${user.role || 'user'}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (content === '') {
                    content = '<div style="color:#aaa; padding:16px; text-align:center;">√áevrimi√ßi kullanƒ±cƒ± yok.</div>';
                }
                
                container.innerHTML = content;
            });
        }

        function showChatsTab() {
            const container = document.getElementById('chatPanelContent');
            container.innerHTML = '<div style="color:#aaa; padding:16px; text-align:center;">√ñzel sohbet ge√ßmi≈üi yakƒ±nda...</div>';
        }

        function loadNotificationsPanel(panel) {
            panel.innerHTML = `
                <div class="panel-header">
                    <h3><i class="fas fa-bell" style="color:#ff4444;"></i> Bildirimler</h3>
                    <div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div>
                </div>
                <div class="panel-content">
                    <div style="color:#aaa; padding:16px; text-align:center;">Hen√ºz bildirim yok.</div>
                </div>
            `;
        }

        function loadProfilePanel(panel) {
            panel.innerHTML = `
                <div class="panel-header">
                    <h3><i class="fas fa-user" style="color:#ff0000;"></i> Profil</h3>
                    <div class="panel-close" onclick="closeLeftPanel()"><i class="fas fa-times"></i></div>
                </div>
                <div class="panel-content">
                    <div style="display:flex; flex-direction:column; align-items:center; padding:20px 0;">
                        <div class="profile-avatar-panel" style="width:80px; height:80px; font-size:32px;">${ACTIVE_USER.name.charAt(0)}</div>
                        <h2 style="font-size:20px; margin:10px 0;">${ACTIVE_USER.name}</h2>
                        <span class="badge badge-${ACTIVE_USER.role}">${ACTIVE_USER.role}</span>
                    </div>
                    
                    <div style="margin:20px 0;">
                        <button class="form-button secondary" onclick="logout()" style="width:100%;">
                            <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap
                        </button>
                    </div>
                </div>
            `;
        }

        function closeLeftPanel() {
            document.getElementById('leftPanel').innerHTML = '';
            setActiveIcon(null);
        }

        function setActiveIcon(active) {
            document.querySelectorAll('.icon-item').forEach(el => el.classList.remove('active'));
            if (active === 'subscriptions') document.querySelector('.icon-item[onclick*="openSubscriptions"]')?.classList.add('active');
            else if (active === 'channels') document.querySelector('.icon-item[onclick*="openChannelPanel"]')?.classList.add('active');
            else if (active === 'chatlist') document.querySelector('.icon-item[onclick*="openChatListPanel"]')?.classList.add('active');
            else if (active === 'notifications') document.querySelector('.icon-item[onclick*="openNotificationPanel"]')?.classList.add('active');
            else if (active === 'profile') document.querySelector('.profile-avatar')?.classList.add('active');
        }

        function openSubscriptions() { loadLeftPanel('subscriptions'); }
        function openChannelPanel() { loadLeftPanel('channels'); }
        function openChatListPanel() { loadLeftPanel('chatlist'); }
        function openNotificationPanel() { loadLeftPanel('notifications'); }
        function openProfilePanel() { loadLeftPanel('profile'); }
        function showHome() { addSystemMessage('üè† Ana sayfa hazƒ±rlanƒ±yor...'); }

        // ========== YOUTUBE PLAYER ==========
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtubeContainer', {
                height: '100%',
                width: '100%',
                videoId: 'jfKfPfyJRdk',
                playerVars: { 
                    autoplay: 1, 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    disablekb: 1, 
                    fs: 0, 
                    iv_load_policy: 3, 
                    playsinline: 1 
                },
                events: {
                    onReady: e => e.target.playVideo(),
                    onStateChange: e => {
                        document.getElementById('playPauseIcon').className = 
                            e.data === YT.PlayerState.PLAYING ? 'fas fa-pause' : 'fas fa-play';
                        isPlaying = e.data === YT.PlayerState.PLAYING;
                    }
                }
            });
        }

        function toggleMute() {
            if (!ytPlayer) return;
            if (isMuted) {
                ytPlayer.unMute();
                document.getElementById('muteIcon').className = 'fas fa-volume-up';
            } else {
                ytPlayer.mute();
                document.getElementById('muteIcon').className = 'fas fa-volume-mute';
            }
            isMuted = !isMuted;
        }

        function togglePlayPause() {
            if (!ytPlayer) return;
            if (isPlaying) ytPlayer.pauseVideo();
            else ytPlayer.playVideo();
        }

        // ========== YARDIMCI FONKSƒ∞YONLAR ==========
        function formatSubscribers(num) {
            if (num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num/1000).toFixed(1) + 'K';
            return num || 0;
        }

        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
        }

        function logout() {
            if (ACTIVE_USER) {
                database.ref(`online/${currentChannel}/${ACTIVE_USER.id}`).remove();
            }
            ACTIVE_USER = null;
            location.reload();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const icon = document.getElementById('themeIcon').querySelector('i');
            icon.className = document.body.classList.contains('light-theme') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function updateUIForUser() {
            document.getElementById('avatarText').textContent = ACTIVE_USER.name.charAt(0).toUpperCase();
            document.getElementById('subscriptionBadge').textContent = ACTIVE_USER.subscribedChannels.length;
            
            database.ref('channels').once('value', snapshot => {
                const channels = snapshot.val() || {};
                document.getElementById('channelCountBadge').textContent = Object.keys(channels).length;
            });
        }

        // ========== BA≈ûLANGI√á ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Tema kontrol√º
            if (localStorage.getItem('cetcety_theme') === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeIcon').querySelector('i').className = 'fas fa-sun';
            }
            
            // Otomatik giri≈ü kontrol√º yok - her seferinde giri≈ü yapƒ±lmalƒ±
        });
    </script>
</body>
</html>
