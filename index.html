<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CETCETY ‚Ä¢ Tam Mobil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- FIREBASE v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background: #0a0a0a; color: #fff; height: 100vh; width: 100vw; overflow: hidden; position: fixed; }

        /* LOGIN */
        .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: 0.3s; }
        .login-overlay.hidden { display: none; }
        .login-panel { width: 90%; max-width: 360px; background: #1a1a1a; border-radius: 24px; padding: 32px 24px; border: 1px solid #333; }
        .login-panel h2 { text-align: center; font-size: 32px; font-weight: 700; margin-bottom: 32px; color: #ff0000; }
        .login-input { width: 100%; padding: 16px; background: #2a2a2a; border: 1px solid #3f3f3f; border-radius: 12px; color: #fff; font-size: 16px; margin-bottom: 16px; outline: none; }
        .login-input:focus { border-color: #ff0000; }
        .login-btn { width: 100%; padding: 16px; background: #ff0000; border: none; border-radius: 12px; color: #fff; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .login-info { text-align: center; margin-top: 20px; font-size: 12px; color: #888; }
        .login-info a { color: #ff0000; text-decoration: none; font-weight: 600; cursor: pointer; }

        /* ANA UYGULAMA */
        .app { height: 100vh; width: 100vw; display: flex; flex-direction: column; position: relative; background: #0a0a0a; }

        /* √úST BAR */
        .top-bar { height: 56px; background: #0f0f0f; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; z-index: 100; }
        .top-bar-left { display: flex; align-items: center; gap: 16px; }
        .search-btn, .logo, .profile-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border-radius: 50%; }
        .search-btn:hover, .profile-btn:hover { background: #2a2a2a; }
        .logo span { font-weight: 700; font-size: 18px; color: #ff0000; }
        .profile-btn { position: relative; }
        .profile-avatar { width: 32px; height: 32px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* ANA ƒ∞√áERƒ∞K */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* Vƒ∞DEO */
        .video-section { width: 100%; background: #000; position: relative; flex-shrink: 0; }
        @media (max-width: 768px) { .video-section { height: 30vh; } }
        @media (min-width: 769px) and (max-width: 1024px) { .video-section { height: 35vh; } }
        .video-wrapper { width: 100%; height: 100%; position: relative; background: #000; }
        #youtube-player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .video-controls { position: absolute; bottom: 16px; right: 16px; display: flex; gap: 12px; z-index: 10; }
        .video-control-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.3); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); font-size: 20px; }
        .video-control-btn:active { background: #ff0000; border-color: #ff0000; }

        /* ALT BAR (T√úM ƒ∞KONLAR) */
        .bottom-bar { height: 64px; background: #0f0f0f; border-top: 1px solid #2a2a2a; display: flex; align-items: center; justify-content: space-around; padding: 0 8px; flex-shrink: 0; z-index: 100; }
        .bottom-bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #aaa; cursor: pointer; padding: 8px 0; border-radius: 8px; transition: 0.2s; position: relative; }
        .bottom-bar-item.active { color: #ff0000; }
        .bottom-bar-item i { font-size: 22px; }
        .bottom-bar-item span { font-size: 11px; font-weight: 500; }
        .bottom-bar-item:active { background: #2a2a2a; }
        .badge { position: absolute; top: 2px; right: 20%; background: #ff4444; color: white; font-size: 10px; font-weight: 600; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #0f0f0f; }

        /* KAYAN PANEL (Saƒü) */
        .slide-panel { position: fixed; top: 0; right: -100%; width: 85%; max-width: 400px; height: 100vh; background: #0f0f0f; border-left: 1px solid #2a2a2a; z-index: 1000; transition: right 0.3s ease; display: flex; flex-direction: column; }
        .slide-panel.active { right: 0; }
        .panel-header { height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #2a2a2a; background: #0a0a0a; }
        .panel-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .panel-close { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; }
        .panel-close:active { background: #2a2a2a; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* PLAYLIST PANELƒ∞ (Sol) */
        .playlist-panel { position: fixed; top: 0; left: -100%; width: 85%; max-width: 400px; height: 100vh; background: #0f0f0f; border-right: 1px solid #2a2a2a; z-index: 1000; transition: left 0.3s ease; display: flex; flex-direction: column; }
        .playlist-panel.active { left: 0; }

        /* PANEL ƒ∞√áƒ∞ √ñƒûELER */
        .panel-item { display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 12px; cursor: pointer; margin-bottom: 4px; background: #1a1a1a; }
        .panel-item:active { background: #2a2a2a; }
        .panel-item-avatar { width: 48px; height: 48px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .panel-item-info { flex: 1; }
        .panel-item-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #fff; }
        .panel-item-subtitle { font-size: 12px; color: #aaa; }

        /* SOHBET ALANI */
        .chat-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #0a0a0a; position: relative; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #2a2a2a; background: #0f0f0f; }
        .chat-title { display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .chat-title i { color: #ff0000; }
        .channel-info { font-size: 12px; color: #aaa; }
        .subscribe-btn { padding: 6px 12px; background: #2a2a2a; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .subscribe-btn.subscribed { background: #ff0000; }

        /* MESAJLAR */
        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; flex-direction: column; max-width: 85%; animation: fade 0.2s; }
        .message.right { align-self: flex-end; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 12px; }
        .message-sender { font-weight: 600; color: #ff0000; cursor: pointer; }
        .message-time { color: #aaa; }
        .message-text { font-size: 14px; line-height: 1.4; color: #fff; background: #1a1a1a; padding: 10px 14px; border-radius: 18px; word-break: break-word; }
        .message.right .message-text { background: #ff0000; color: #fff; }
        .system-message { align-self: center; background: #2a2a2a; color: #aaa; padding: 8px 16px; border-radius: 20px; font-size: 12px; margin: 8px 0; max-width: 90%; text-align: center; }

        /* MESAJ Gƒ∞Rƒ∞≈û */
        .message-input-container { padding: 12px 16px; background: #0f0f0f; border-top: 1px solid #2a2a2a; }
        .input-wrapper { display: flex; align-items: center; gap: 12px; background: #1a1a1a; border-radius: 28px; padding: 4px 4px 4px 16px; }
        .message-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 14px; padding: 12px 0; resize: none; max-height: 80px; outline: none; }
        .send-btn { width: 44px; height: 44px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; }

        /* √ñZEL SOHBET */
        .private-chat-panel { position: fixed; inset: 0; background: #0a0a0a; z-index: 2000; display: none; flex-direction: column; }
        .private-chat-panel.active { display: flex; }
        .private-chat-header { height: 60px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; background: #0f0f0f; border-bottom: 1px solid #2a2a2a; }
        .private-chat-user { display: flex; align-items: center; gap: 12px; }
        .private-chat-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; }
        .private-chat-info h4 { font-size: 16px; font-weight: 600; }
        .private-chat-info span { font-size: 12px; color: #aaa; }
        .private-chat-actions { display: flex; gap: 12px; }
        .private-chat-action { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #aaa; cursor: pointer; }
        .private-chat-action:active { background: #2a2a2a; }
        .private-chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .private-message { max-width: 85%; }
        .private-message.right { align-self: flex-end; }
        .private-message-text { background: #1a1a1a; padding: 10px 14px; border-radius: 18px; font-size: 14px; }
        .private-message.right .private-message-text { background: #ff0000; }
        .private-message-media img, .private-message-media video { max-width: 100%; max-height: 200px; border-radius: 12px; }
        .private-input-container { padding: 16px; background: #0f0f0f; border-top: 1px solid #2a2a2a; }
        .private-media-actions { display: flex; gap: 12px; margin-bottom: 12px; }
        .private-media-btn { width: 44px; height: 44px; border-radius: 50%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .private-input-wrapper { display: flex; gap: 12px; }
        .private-input { flex: 1; background: #1a1a1a; border: none; border-radius: 24px; padding: 14px 16px; color: #fff; resize: none; outline: none; }
        .private-send-btn { width: 48px; height: 48px; border-radius: 50%; background: #ff0000; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 3000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-panel { width: 90%; max-width: 500px; background: #1a1a1a; border-radius: 24px; overflow: hidden; }
        .modal-header { padding: 20px; background: #0f0f0f; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; justify-content: space-between; }
        .modal-content { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #2a2a2a; display: flex; gap: 12px; justify-content: flex-end; }

        /* Y√úKLENƒ∞YOR */
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #ff0000; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BAƒûLANTI DURUMU */
        .connection-status { position: fixed; bottom: 80px; right: 16px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 9999; display: flex; align-items: center; gap: 8px; background: #1a1a1a; border: 1px solid #2a2a2a; }
        .connection-status.connected { background: #0a5c36; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .connected .status-dot { background: #2ecc71; }

        /* FORM ELEMANLARI */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: #aaa; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #3f3f3f; border-radius: 8px; color: #fff; font-size: 14px; outline: none; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #ff0000; }

        /* AVATAR Y√úKLEME */
        .avatar-upload { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 20px; padding: 20px; background: #2a2a2a; border-radius: 12px; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; background: #3f3f3f; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #ff0000; overflow: hidden; }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .upload-btn { background: #3f3f3f; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <!-- Gƒ∞Rƒ∞≈û -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-panel">
            <h2>CETCETY</h2>
            <input type="text" id="loginNick" class="login-input" placeholder="Kullanƒ±cƒ± adƒ±">
            <input type="password" id="loginPassword" class="login-input" placeholder="≈ûifre (opsiyonel)">
            <button class="login-btn" onclick="handleLogin()">Gƒ∞Rƒ∞≈û YAP</button>
            <div class="login-info">
                Giri≈ü yaparak <a onclick="openModal('kvkkModal')">KVKK</a> ve <a onclick="openModal('termsModal')">≈ûartlar</a>'ƒ± kabul edersiniz.
            </div>
        </div>
    </div>

    <!-- ANA UYGULAMA -->
    <div id="app" class="app" style="display: none;">
        <!-- √úST BAR -->
        <div class="top-bar">
            <div class="top-bar-left">
                <div class="search-btn" onclick="openSearch()"><i class="fas fa-search"></i></div>
                <div class="logo" onclick="goHome()"><span>CETCETY</span></div>
            </div>
            <div class="profile-btn" onclick="openProfilePanel()">
                <div class="profile-avatar" id="profileAvatar">
                    <span id="avatarText">?</span>
                    <img id="avatarImage" style="display: none;">
                </div>
            </div>
        </div>

        <!-- ANA ƒ∞√áERƒ∞K -->
        <div class="main-content">
            <!-- Vƒ∞DEO -->
            <div class="video-section">
                <div class="video-wrapper">
                    <div id="youtube-player"></div>
                    <div class="video-controls">
                        <div class="video-control-btn" onclick="toggleMute()" id="muteBtn"><i class="fas fa-volume-up" id="muteIcon"></i></div>
                        <div class="video-control-btn" onclick="togglePlayPause()" id="playPauseBtn"><i class="fas fa-pause" id="playPauseIcon"></i></div>
                    </div>
                </div>
            </div>

            <!-- ALT BAR -->
            <div class="bottom-bar">
                <div class="bottom-bar-item" onclick="openPlaylistPanel()" id="playlistIcon"><i class="fas fa-list"></i><span>Liste</span></div>
                <div class="bottom-bar-item" onclick="openShareSheet()"><i class="fas fa-share-alt"></i><span>Payla≈ü</span></div>
                <div class="bottom-bar-item active" onclick="switchToGeneralChat()" id="generalChatIcon"><i class="fas fa-comment"></i><span>Sohbet</span></div>
                <div class="bottom-bar-item" onclick="openNotificationsPanel()" id="notificationsIcon"><i class="fas fa-bell"></i><span>Bildirim</span><span class="badge" id="notificationBadge" style="display: none;">0</span></div>
                <div class="bottom-bar-item" onclick="openMorePanel()"><i class="fas fa-ellipsis-h"></i><span>Diƒüer</span></div>
            </div>

            <!-- SOHBET -->
            <div class="chat-section" id="chatSection">
                <div class="chat-header">
                    <div class="chat-title"><i class="fas fa-hashtag"></i><span id="currentChannelName">genel</span></div>
                    <div class="channel-info"><span id="channelUserCount">0</span> √ßevrimi√ßi</div>
                    <div class="subscribe-btn" id="subscribeBtn" onclick="toggleSubscribe()"><i class="fas fa-plus"></i> Abone Ol</div>
                </div>
                <div class="messages" id="messages"><div class="system-message">CETCETY'ye ho≈ü geldin!</div></div>
                <div class="message-input-container">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" placeholder="Mesaj yaz..." rows="1" oninput="autoResize(this)"></textarea>
                        <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLAYLIST PANELƒ∞ -->
        <div class="playlist-panel" id="playlistPanel">
            <div class="panel-header"><h3><i class="fas fa-list" style="color: #ff0000;"></i> Kanal Playlist</h3><div class="panel-close" onclick="closePlaylistPanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content" id="playlistContent"></div>
        </div>

        <!-- Dƒ∞ƒûER PANEL -->
        <div class="slide-panel" id="morePanel">
            <div class="panel-header"><h3><i class="fas fa-bars"></i> Men√º</h3><div class="panel-close" onclick="closeMorePanel()"><i class="fas fa-times"></i></div></div>
            <div class="panel-content" id="morePanelContent">
                <div class="panel-item" onclick="openSubscriptionsPanel()"><div class="panel-item-avatar"><i class="fas fa-bell"></i></div><div class="panel-item-info"><div class="panel-item-title">Abonelikler</div><div class="panel-item-subtitle">Takip ettiƒüin kanallar</div></div></div>
                <div class="panel-item" onclick="openChannelsPanel()"><div class="panel-item-avatar"><i class="fas fa-list-ul"></i></div><div class="panel-item-info"><div class="panel-item-title">Kanallar</div><div class="panel-item-subtitle">T√ºm kanallarƒ± ke≈üfet</div></div></div>
                <div class="panel-item" onclick="openPrivateChatList()"><div class="panel-item-avatar"><i class="fas fa-comment-dots"></i></div><div class="panel-item-info"><div class="panel-item-title">√ñzel Sohbetler</div><div class="panel-item-subtitle" id="privateChatCount">0 yeni</div></div></div>
                <div class="panel-item" onclick="openSupportPanel()"><div class="panel-item-avatar"><i class="fas fa-headset"></i></div><div class="panel-item-info"><div class="panel-item-title">Destek</div><div class="panel-item-subtitle">Yardƒ±m ve geri bildirim</div></div></div>
                <div class="panel-item" onclick="openSettingsPanel()"><div class="panel-item-avatar"><i class="fas fa-cog"></i></div><div class="panel-item-info"><div class="panel-item-title">Ayarlar</div><div class="panel-item-subtitle">Profil, gizlilik, tema</div></div></div>
            </div>
        </div>

        <!-- √ñZEL SOHBET -->
        <div class="private-chat-panel" id="privateChatPanel">
            <div class="private-chat-header">
                <div class="private-chat-user"><div class="private-chat-avatar" id="privateChatAvatar">?</div><div class="private-chat-info"><h4 id="privateChatName">Kullanƒ±cƒ±</h4><span id="privateChatStatus">√ßevrimi√ßi</span></div></div>
                <div class="private-chat-actions"><div class="private-chat-action" onclick="blockUser()"><i class="fas fa-ban"></i></div><div class="private-chat-action" onclick="closePrivateChat()"><i class="fas fa-times"></i></div></div>
            </div>
            <div class="private-chat-messages" id="privateChatMessages"></div>
            <div class="private-input-container">
                <div class="private-media-actions">
                    <div class="private-media-btn" onclick="triggerPrivateImageUpload()"><i class="fas fa-image"></i></div>
                    <div class="private-media-btn" onclick="triggerPrivateVideoUpload()"><i class="fas fa-video"></i></div>
                    <input type="file" id="privateImageUpload" accept="image/*" style="display: none;" onchange="sendPrivateImageFile(this)">
                    <input type="file" id="privateVideoUpload" accept="video/*" style="display: none;" onchange="sendPrivateVideoFile(this)">
                </div>
                <div class="private-input-wrapper">
                    <textarea id="privateMessageInput" class="private-input" placeholder="Mesaj yaz..." rows="1" oninput="autoResize(this)"></textarea>
                    <div class="private-send-btn" onclick="sendPrivateMessage()"><i class="fas fa-paper-plane"></i></div>
                </div>
            </div>
        </div>

        <!-- MODALLAR -->
        <div id="kvkkModal" class="modal-overlay"><div class="modal-panel"><div class="modal-header"><h3>KVKK</h3><div class="modal-close" onclick="closeModal('kvkkModal')"><i class="fas fa-times"></i></div></div><div class="modal-content"><p>Ki≈üisel verileriniz platformun √ßalƒ±≈ümasƒ± i√ßin kullanƒ±lƒ±r.</p></div><div class="modal-footer"><button class="login-btn" onclick="closeModal('kvkkModal')">Kapat</button></div></div></div>
        <div id="termsModal" class="modal-overlay"><div class="modal-panel"><div class="modal-header"><h3>≈ûartlar</h3><div class="modal-close" onclick="closeModal('termsModal')"><i class="fas fa-times"></i></div></div><div class="modal-content"><p>Kurallara uymak zorundasƒ±nƒ±z.</p></div><div class="modal-footer"><button class="login-btn" onclick="closeModal('termsModal')">Kapat</button></div></div></div>
        <div id="youtubeModal" class="modal-overlay"><div class="modal-panel"><div class="modal-header"><h3>Video Ekle</h3><div class="modal-close" onclick="closeModal('youtubeModal')"><i class="fas fa-times"></i></div></div><div class="modal-content"><input type="text" id="youtubeUrl" class="form-input" placeholder="YouTube URL"><input type="text" id="youtubeTitle" class="form-input" placeholder="Ba≈ülƒ±k"></div><div class="modal-footer"><button class="login-btn" onclick="closeModal('youtubeModal')">ƒ∞ptal</button><button class="login-btn" onclick="addYoutubeVideo()">Ekle</button></div></div></div>
        <div id="avatarModal" class="modal-overlay"><div class="modal-panel"><div class="modal-header"><h3>Profil Resmi</h3><div class="modal-close" onclick="closeModal('avatarModal')"><i class="fas fa-times"></i></div></div><div class="modal-content"><div class="avatar-upload"><div class="avatar-preview" id="avatarPreview"><span id="avatarPreviewText">?</span><img id="avatarPreviewImage" style="display: none;"></div><input type="file" id="avatarFile" accept="image/*" style="display: none;" onchange="previewAvatar(this)"><div class="upload-btn" onclick="document.getElementById('avatarFile').click()">Resim Se√ß</div></div></div><div class="modal-footer"><button class="login-btn" onclick="closeModal('avatarModal')">ƒ∞ptal</button><button class="login-btn" onclick="uploadAvatar()">Kaydet</button></div></div></div>

        <!-- BAƒûLANTI -->
        <div id="connectionStatus" class="connection-status connecting"><span class="status-dot"></span><span id="statusText">Baƒülanƒ±yor...</span></div>
    </div>

    <script>
        // ========== FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
            authDomain: "popboxmusicchat.firebaseapp.com",
            databaseURL: "https://popboxmusicchat-default-rtdb.firebaseio.com",
            projectId: "popboxmusicchat",
            storageBucket: "popboxmusicchat.firebasestorage.app",
            messagingSenderId: "206625719024",
            appId: "1:206625719024:web:d28f478a2c96d10412f835"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // ========== REFERANSLAR ==========
        const usersRef = db.ref('users');
        const channelsRef = db.ref('channels');
        const messagesRef = db.ref('messages');
        const privateChatsRef = db.ref('privateChats');
        const bannedWordsRef = db.ref('bannedWords');
        const customCommandsRef = db.ref('customCommands');
        const blockedRef = db.ref('blocked');
        const superHiddenRef = db.ref('superHidden');
        const privateSpyRef = db.ref('privateSpy');

        // ========== GLOBAL ==========
        let currentUser = null;
        let currentChannel = 'genel';
        let currentPrivateChat = null;
        let ytPlayer = null;
        let ytPlayerReady = false;
        let isMuted = false;
        let isPlaying = true;
        let BANNED_WORDS = [];
        let CUSTOM_COMMANDS = [];

        // Owner ≈üifresi (Gƒ∞ZLƒ∞ - KESƒ∞NLƒ∞KLE YAZMAYACAK)
        const OWNER_PASSWORD = 'Sahi17407@SCM';
        let ownerHash = null;

        // ========== SHA-256 ==========
        async function sha256(msg) {
            const buf = new TextEncoder().encode(msg);
            const hash = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ========== OWNER ≈ûƒ∞FRE ==========
        async function initOwner() {
            const salt = 'cetcety_2024';
            ownerHash = await sha256(OWNER_PASSWORD + salt);
        }

        async function verifyOwner(pass) {
            if (!ownerHash) await initOwner();
            const input = await sha256(pass + 'cetcety_2024');
            return input === ownerHash;
        }

        // ========== MODAL ==========
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ========== BAƒûLANTI ==========
        db.ref('.info/connected').on('value', (snap) => {
            const el = document.getElementById('connectionStatus');
            if (snap.val()) {
                el.className = 'connection-status connected';
                document.getElementById('statusText').textContent = 'Baƒülƒ±';
                if (currentUser) updateOnlineStatus(true);
            } else {
                el.className = 'connection-status';
                document.getElementById('statusText').textContent = 'Baƒülantƒ± yok';
            }
        });

        // ========== Gƒ∞Rƒ∞≈û ==========
        async function handleLogin() {
            const nick = document.getElementById('loginNick').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if (!nick) { alert('Nick gerekli!'); return; }

            const norm = nick.toLowerCase();
            const snap = await usersRef.orderByChild('nameLower').equalTo(norm).once('value');
            let user = null;
            let uid = null;

            snap.forEach(c => { user = c.val(); uid = c.key; });

            if (user) {
                if (user.password && user.password !== pass) { alert('Hatalƒ± ≈üifre!'); return; }
                if (norm === 'mateky') {
                    const ok = await verifyOwner(pass);
                    if (!ok) { alert('Owner ≈üifresi hatalƒ±!'); return; }
                }
            } else {
                if (norm === 'mateky') {
                    const ok = await verifyOwner(pass);
                    if (!ok) { alert('Owner ≈üifresi hatalƒ±!'); return; }
                }
                const newUser = {
                    name: nick,
                    nameLower: norm,
                    role: norm === 'mateky' ? 'owner' : 'user',
                    roleLevel: norm === 'mateky' ? 5 : 1,
                    subscribed: ['genel'],
                    myChannel: null,
                    joined: Date.now(),
                    avatar: nick[0].toUpperCase(),
                    avatarData: null,
                    password: pass || '',
                    privateMode: 'all',
                    blocked: [],
                    lastSeen: Date.now(),
                    online: true
                };
                const ref = await usersRef.push(newUser);
                uid = ref.key;
                user = newUser;
            }

            currentUser = { id: uid, ...user };
            await updateOnlineStatus(true);
            await joinChannel('genel');

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').style.display = 'flex';
            updateAvatar();
            startMessageListener();
            startPrivateListener();
            loadBannedWords();
            loadCustomCommands();
            loadChannels();

            addSystemMessage(`üëã Ho≈ü geldin, ${currentUser.name}!`);

            if (currentUser.role === 'owner' || currentUser.role === 'admin') {
                if (!currentUser.subscribed.includes('admin')) {
                    currentUser.subscribed.push('admin');
                    await usersRef.child(uid).child('subscribed').set(currentUser.subscribed);
                }
                await addToChannel('admin');
            }

            initYouTubePlayer();
        }

        // ========== ONLINE ==========
        async function updateOnlineStatus(online) {
            if (!currentUser) return;
            await usersRef.child(currentUser.id).update({
                online: online,
                lastSeen: Date.now(),
                currentChannel: online ? currentChannel : null
            });
        }

        // ========== KANAL ==========
        async function addToChannel(ch) {
            const snap = await channelsRef.child(ch).once('value');
            let channel = snap.val() || {
                name: ch,
                owner: 'MateKy',
                ownerRole: 'owner',
                coAdmins: [],
                subscribers: 1,
                hidden: false,
                superHidden: false,
                youtube: {
                    current: 'jfKfPfyJRdk',
                    title: 'CETCETY Radio',
                    artist: 'MateKy',
                    playlist: [{ id: 'jfKfPfyJRdk', title: 'CETCETY Radio', by: 'MateKy', role: 'owner' }]
                },
                online: {}
            };
            if (!channel.online) channel.online = {};
            channel.online[currentUser.id] = true;
            channel.onlineCount = Object.keys(channel.online).length;
            await channelsRef.child(ch).set(channel);
        }

        async function removeFromChannel(ch) {
            const snap = await channelsRef.child(ch).once('value');
            const channel = snap.val();
            if (channel?.online) {
                delete channel.online[currentUser.id];
                channel.onlineCount = Object.keys(channel.online).length;
                await channelsRef.child(ch).set(channel);
            }
        }

        async function joinChannel(ch) {
            const snap = await channelsRef.child(ch).once('value');
            const channel = snap.val();
            if (!channel) return;

            await removeFromChannel(currentChannel);
            currentChannel = ch;
            await addToChannel(ch);
            await usersRef.child(currentUser.id).update({ currentChannel: ch });

            document.getElementById('currentChannelName').textContent = ch;
            document.getElementById('channelUserCount').textContent = channel.onlineCount || 1;

            updateSubscribeButton();
            updateYoutubeInfo(channel);
            startMessageListener();
            addSystemMessage(`üì¢ #${ch} kanalƒ±na katƒ±ldƒ±n!`);
        }

        function updateSubscribeButton() {
            const btn = document.getElementById('subscribeBtn');
            if (currentUser.subscribed?.includes(currentChannel)) {
                btn.innerHTML = '<i class="fas fa-check"></i> Abone';
                btn.classList.add('subscribed');
            } else {
                btn.innerHTML = '<i class="fas fa-plus"></i> Abone Ol';
                btn.classList.remove('subscribed');
            }
        }

        async function toggleSubscribe() {
            if (!currentUser.subscribed) currentUser.subscribed = [];
            if (currentUser.subscribed.includes(currentChannel)) {
                currentUser.subscribed = currentUser.subscribed.filter(c => c !== currentChannel);
                await usersRef.child(currentUser.id).child('subscribed').set(currentUser.subscribed);
                addSystemMessage(`‚ùå #${currentChannel} abonelikten √ßƒ±kƒ±ldƒ±.`);
            } else {
                currentUser.subscribed.push(currentChannel);
                await usersRef.child(currentUser.id).child('subscribed').set(currentUser.subscribed);
                addSystemMessage(`‚úÖ #${currentChannel} abone olundu.`);
            }
            updateSubscribeButton();
        }

        // ========== YOUTUBE ==========
        function initYouTubePlayer() {
            channelsRef.child(currentChannel).once('value', (s) => {
                const c = s.val();
                if (!c || !document.getElementById('youtube-player')) return;
                try {
                    ytPlayer = new YT.Player('youtube-player', {
                        height: '100%', width: '100%',
                        videoId: c.youtube.current,
                        playerVars: { autoplay: 1, controls: 0, modestbranding: 1, rel: 0, playsinline: 1 },
                        events: {
                            onReady: (e) => { ytPlayerReady = true; e.target.playVideo(); },
                            onStateChange: (e) => {
                                document.getElementById('playPauseIcon').className = 
                                    e.data === YT.PlayerState.PLAYING ? 'fas fa-pause' : 'fas fa-play';
                                if (e.data === YT.PlayerState.ENDED) playNext();
                            }
                        }
                    });
                } catch (e) { console.log('YouTube error', e); }
            });
        }

        function onYouTubeIframeAPIReady() { initYouTubePlayer(); }

        function toggleMute() {
            if (!ytPlayer || !ytPlayerReady) return;
            if (isMuted) { ytPlayer.unMute(); document.getElementById('muteIcon').className = 'fas fa-volume-up'; }
            else { ytPlayer.mute(); document.getElementById('muteIcon').className = 'fas fa-volume-mute'; }
            isMuted = !isMuted;
        }

        function togglePlayPause() {
            if (!ytPlayer || !ytPlayerReady) return;
            const s = ytPlayer.getPlayerState();
            if (s === YT.PlayerState.PLAYING) ytPlayer.pauseVideo();
            else ytPlayer.playVideo();
        }

        async function playNext() {
            const snap = await channelsRef.child(currentChannel).once('value');
            const c = snap.val();
            if (!c?.youtube.playlist?.length) return;
            const idx = c.youtube.playlist.findIndex(v => v.id === c.youtube.current);
            const next = c.youtube.playlist[(idx + 1) % c.youtube.playlist.length];
            c.youtube.current = next.id;
            c.youtube.title = next.title;
            c.youtube.artist = next.by;
            await channelsRef.child(currentChannel).set(c);
            if (ytPlayer?.loadVideoById) ytPlayer.loadVideoById(next.id);
            updateYoutubeInfo(c);
        }

        function updateYoutubeInfo(c) {
            document.getElementById('youtubeNowPlayingTitle').textContent = c.youtube.title;
            document.getElementById('youtubeNowPlayingOwner').textContent = c.youtube.artist;
            updatePlaylist(c);
        }

        function updatePlaylist(c) {
            const cont = document.getElementById('playlistContent');
            if (!cont) return;
            let html = '';
            c.youtube.playlist.forEach((v, i) => {
                html += `<div class="panel-item" onclick="playVideo('${v.id}','${v.title}','${v.by}')">
                    <div class="panel-item-avatar"><i class="fab fa-youtube"></i></div>
                    <div class="panel-item-info">
                        <div class="panel-item-title">${v.title}</div>
                        <div class="panel-item-subtitle">${v.by}</div>
                    </div>
                </div>`;
            });
            cont.innerHTML = html;
        }

        async function playVideo(id, title, by) {
            const snap = await channelsRef.child(currentChannel).once('value');
            const c = snap.val();
            c.youtube.current = id;
            c.youtube.title = title;
            c.youtube.artist = by;
            await channelsRef.child(currentChannel).set(c);
            if (ytPlayer?.loadVideoById) ytPlayer.loadVideoById(id);
            updateYoutubeInfo(c);
        }

        // ========== MESAJLAR ==========
        function startMessageListener() {
            messagesRef.child(currentChannel).off();
            messagesRef.child(currentChannel).limitToLast(50).on('child_added', (s) => {
                const m = s.val();
                if (m) appendMessage(m, m.senderId === currentUser?.id);
            });
        }

        function appendMessage(m, isMe) {
            const cont = document.getElementById('messages');
            const d = document.createElement('div');
            d.className = `message ${isMe ? 'right' : ''}`;
            d.innerHTML = `
                <div class="message-header">
                    <span class="message-time">${m.time || ''}</span>
                    <span class="message-sender" onclick="openPrivateChat('${m.senderName}')">${escapeHTML(m.senderName)}</span>
                </div>
                <div class="message-text">${escapeHTML(m.text)}</div>
            `;
            cont.appendChild(d);
            cont.scrollTop = cont.scrollHeight;
        }

        function addSystemMessage(t) {
            const cont = document.getElementById('messages');
            const d = document.createElement('div');
            d.className = 'system-message';
            d.innerHTML = t;
            cont.appendChild(d);
            cont.scrollTop = cont.scrollHeight;
        }

        async function sendMessage() {
            const inp = document.getElementById('messageInput');
            const txt = inp.value.trim();
            if (!txt) return;

            if (txt.startsWith('/')) {
                handleCommand(txt);
                inp.value = ''; autoResize(inp);
                return;
            }

            if (checkBanned(txt)) {
                addSystemMessage('üö´ Yasaklƒ± kelime!');
                inp.value = ''; return;
            }

            const msg = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                text: txt,
                time: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
            await messagesRef.child(currentChannel).push(msg);
            inp.value = ''; autoResize(inp);
        }

        function checkBanned(t) {
            const l = t.toLowerCase();
            return BANNED_WORDS.some(w => l.includes(w.toLowerCase()));
        }

        // ========== √ñZEL SOHBET ==========
        function startPrivateListener() {
            privateChatsRef.on('child_added', (s) => {
                const id = s.key;
                if (!id.includes(currentUser?.id)) return;
                s.ref.limitToLast(1).on('child_added', (m) => {
                    const msg = m.val();
                    if (msg && currentPrivateChat && 
                        (msg.senderId === currentPrivateChat.id || msg.receiverId === currentPrivateChat.id)) {
                        appendPrivate(msg);
                    }
                });
            });
        }

        async function openPrivateChat(name) {
            const snap = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
            let target = null, tid = null;
            snap.forEach(c => { target = c.val(); tid = c.key; });
            if (!target) { addSystemMessage('‚ùå Kullanƒ±cƒ± yok'); return; }

            currentPrivateChat = { id: tid, name: target.name };
            document.getElementById('privateChatName').textContent = target.name;
            document.getElementById('privateChatAvatar').innerHTML = target.name[0].toUpperCase();
            document.getElementById('privateChatPanel').classList.add('active');
            await loadPrivate(tid);
        }

        function closePrivateChat() {
            document.getElementById('privateChatPanel').classList.remove('active');
            currentPrivateChat = null;
        }

        async function loadPrivate(tid) {
            const id = [currentUser.id, tid].sort().join('_');
            const cont = document.getElementById('privateChatMessages');
            cont.innerHTML = '';
            const snap = await privateChatsRef.child(id).once('value');
            const msgs = snap.val() || {};
            Object.values(msgs).sort((a,b) => a.timestamp - b.timestamp).forEach(m => appendPrivate(m));
        }

        function appendPrivate(m) {
            const cont = document.getElementById('privateChatMessages');
            const isMe = m.senderId === currentUser.id;
            const d = document.createElement('div');
            d.className = `private-message ${isMe ? 'right' : ''}`;
            if (m.type === 'text') {
                d.innerHTML = `<div class="private-message-text">${escapeHTML(m.content)}</div>`;
            } else if (m.type === 'image') {
                d.innerHTML = `<div class="private-message-media"><img src="${escapeHTML(m.content)}" onclick="window.open(this.src)"></div>`;
            } else if (m.type === 'video') {
                d.innerHTML = `<div class="private-message-media"><video controls src="${escapeHTML(m.content)}"></video></div>`;
            }
            cont.appendChild(d);
            cont.scrollTop = cont.scrollHeight;
        }

        async function sendPrivateMessage() {
            const inp = document.getElementById('privateMessageInput');
            const txt = inp.value.trim();
            if (!txt || !currentPrivateChat) return;
            if (checkBanned(txt)) { addSystemMessage('üö´ Yasaklƒ± kelime!'); inp.value = ''; return; }

            const id = [currentUser.id, currentPrivateChat.id].sort().join('_');
            const msg = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                receiverId: currentPrivateChat.id,
                receiverName: currentPrivateChat.name,
                type: 'text',
                content: txt,
                timestamp: Date.now()
            };
            await privateChatsRef.child(id).push(msg);
            inp.value = '';
        }

        function triggerPrivateImageUpload() { document.getElementById('privateImageUpload').click(); }
        function triggerPrivateVideoUpload() { document.getElementById('privateVideoUpload').click(); }

        async function sendPrivateImageFile(inp) {
            if (!inp.files?.[0] || !currentPrivateChat) return;
            const f = inp.files[0];
            const r = new FileReader();
            r.onload = async (e) => {
                const id = [currentUser.id, currentPrivateChat.id].sort().join('_');
                await privateChatsRef.child(id).push({
                    senderId: currentUser.id, senderName: currentUser.name,
                    receiverId: currentPrivateChat.id, receiverName: currentPrivateChat.name,
                    type: 'image', content: e.target.result, timestamp: Date.now()
                });
            };
            r.readAsDataURL(f);
            inp.value = '';
        }

        async function sendPrivateVideoFile(inp) {
            if (!inp.files?.[0] || !currentPrivateChat) return;
            const f = inp.files[0];
            const r = new FileReader();
            r.onload = async (e) => {
                const id = [currentUser.id, currentPrivateChat.id].sort().join('_');
                await privateChatsRef.child(id).push({
                    senderId: currentUser.id, senderName: currentUser.name,
                    receiverId: currentPrivateChat.id, receiverName: currentPrivateChat.name,
                    type: 'video', content: e.target.result, timestamp: Date.now()
                });
            };
            r.readAsDataURL(f);
            inp.value = '';
        }

        // ========== YASAKLI KELƒ∞MELER ==========
        async function loadBannedWords() {
            const s = await bannedWordsRef.once('value');
            BANNED_WORDS = s.val() || [];
        }

        // ========== √ñZEL KOMUTLAR ==========
        async function loadCustomCommands() {
            const s = await customCommandsRef.once('value');
            CUSTOM_COMMANDS = s.val() || [];
        }

        // ========== KOMUT ƒ∞≈ûLEME ==========
        function handleCommand(cmd) {
            const p = cmd.substring(1).split(' ');
            const m = p[0].toLowerCase();

            const cust = CUSTOM_COMMANDS.find(c => c.cmd === '/' + m || c.cmd === m);
            if (cust) { addSystemMessage(`ü§ñ ${cust.resp}`); return; }

            if (m === 'help') {
                let h = 'üìã KOMUTLAR:\n';
                h += '/help - Yardƒ±m\n/join #kanal - Katƒ±l\n/part - Ayrƒ±l\n/msg kullanƒ±cƒ± mesaj - √ñzel mesaj\n/users - √áevrimi√ßi\n/clear - Temizle\n';
                if (currentUser.role === 'coadmin' || currentUser.role === 'admin' || currentUser.role === 'owner') {
                    h += '\nüîß CO-ADMIN:\n/kick kullanƒ±cƒ± - At\n/ban kullanƒ±cƒ± - Yasakla\n/op kullanƒ±cƒ± - Co-admin yap\n/deop - Yetki al\n';
                }
                if (currentUser.role === 'admin' || currentUser.role === 'owner') {
                    h += '\n‚ö° ADMIN:\n/unban - Yasaƒüƒ± kaldƒ±r\n';
                }
                addSystemMessage(h);
                return;
            }

            if (m === 'join') {
                const ch = p[1]?.replace('#','');
                if (ch) joinChannel(ch);
                else addSystemMessage('Kullanƒ±m: /join #kanal');
            } else if (m === 'part') {
                if (currentChannel === 'genel') addSystemMessage('Genelden ayrƒ±lamazsƒ±n');
                else {
                    removeFromChannel(currentChannel);
                    joinChannel('genel');
                }
            } else if (m === 'msg') {
                const t = p[1];
                const msg = p.slice(2).join(' ');
                if (t && msg) openPrivateChat(t);
                else addSystemMessage('Kullanƒ±m: /msg kullanƒ±cƒ± mesaj');
            } else if (m === 'users') {
                channelsRef.child(currentChannel).once('value', s => {
                    const c = s.val();
                    addSystemMessage(`üë• √áevrimi√ßi: ${c?.onlineCount || 0}`);
                });
            } else if (m === 'clear') {
                document.getElementById('messages').innerHTML = '';
                addSystemMessage('‚úÖ Temizlendi');
            } else {
                addSystemMessage(`‚ùå Bilinmeyen: ${cmd}`);
            }
        }
               // ========== KOMUT ƒ∞≈ûLEME DEVAM ==========
            else if (m === 'kick' && (currentUser.role === 'coadmin' || currentUser.role === 'admin' || currentUser.role === 'owner')) {
                const target = p[1];
                if (!target) { addSystemMessage('Kullanƒ±m: /kick kullanƒ±cƒ±'); return; }
                channelsRef.child(currentChannel).once('value', async (s) => {
                    const ch = s.val();
                    if (!ch?.online) { addSystemMessage('‚ùå Kanal bulunamadƒ±'); return; }
                    let targetId = null;
                    for (let uid in ch.online) {
                        const u = await usersRef.child(uid).once('value');
                        if (u.val()?.name === target) { targetId = uid; break; }
                    }
                    if (!targetId) { addSystemMessage(`‚ùå ${target} kanalda deƒüil`); return; }
                    delete ch.online[targetId];
                    ch.onlineCount = Object.keys(ch.online).length;
                    await channelsRef.child(currentChannel).set(ch);
                    addSystemMessage(`üë¢ ${target} kanaldan atƒ±ldƒ±.`);
                });
            } else if (m === 'ban' && (currentUser.role === 'coadmin' || currentUser.role === 'admin' || currentUser.role === 'owner')) {
                const target = p[1];
                if (!target) { addSystemMessage('Kullanƒ±m: /ban kullanƒ±cƒ±'); return; }
                const snap = await usersRef.orderByChild('nameLower').equalTo(target.toLowerCase()).once('value');
                let targetUser = null, targetId = null;
                snap.forEach(c => { targetUser = c.val(); targetId = c.key; });
                if (!targetUser) { addSystemMessage('‚ùå Kullanƒ±cƒ± bulunamadƒ±'); return; }
                await blockedRef.child(targetId).set({ by: currentUser.id, until: Date.now() + 86400000 });
                await removeFromChannel(currentChannel);
                addSystemMessage(`üö´ ${target} 24 saat yasaklandƒ±.`);
            } else if (m === 'op' && (currentUser.role === 'coadmin' || currentUser.role === 'admin' || currentUser.role === 'owner')) {
                const target = p[1];
                if (!target) { addSystemMessage('Kullanƒ±m: /op kullanƒ±cƒ±'); return; }
                channelsRef.child(currentChannel).once('value', async (s) => {
                    const ch = s.val();
                    if (!ch) return;
                    if (!ch.coAdmins) ch.coAdmins = [];
                    if (!ch.coAdmins.includes(target)) {
                        ch.coAdmins.push(target);
                        await channelsRef.child(currentChannel).set(ch);
                        addSystemMessage(`üîß ${target} co-admin yapƒ±ldƒ±.`);
                    }
                });
            } else if (m === 'deop' && (currentUser.role === 'coadmin' || currentUser.role === 'admin' || currentUser.role === 'owner')) {
                const target = p[1];
                if (!target) { addSystemMessage('Kullanƒ±m: /deop kullanƒ±cƒ±'); return; }
                channelsRef.child(currentChannel).once('value', async (s) => {
                    const ch = s.val();
                    if (!ch?.coAdmins) return;
                    ch.coAdmins = ch.coAdmins.filter(u => u !== target);
                    await channelsRef.child(currentChannel).set(ch);
                    addSystemMessage(`üî® ${target} co-admin yetkisi alƒ±ndƒ±.`);
                });
            } else if (m === 'unban' && (currentUser.role === 'admin' || currentUser.role === 'owner')) {
                const target = p[1];
                if (!target) { addSystemMessage('Kullanƒ±m: /unban kullanƒ±cƒ±'); return; }
                const snap = await usersRef.orderByChild('nameLower').equalTo(target.toLowerCase()).once('value');
                let targetId = null;
                snap.forEach(c => { targetId = c.key; });
                if (targetId) {
                    await blockedRef.child(targetId).remove();
                    addSystemMessage(`‚úÖ ${target} yasaƒüƒ± kaldƒ±rƒ±ldƒ±.`);
                }
            } else if (m === 'addbanned' && currentUser.role === 'owner') {
                const word = p.slice(1).join(' ');
                if (!word) { addSystemMessage('Kelime girin'); return; }
                BANNED_WORDS.push(word);
                await bannedWordsRef.set(BANNED_WORDS);
                addSystemMessage(`üö´ Yasaklƒ± kelime eklendi: ${word}`);
            } else if (m === 'removebanned' && currentUser.role === 'owner') {
                const word = p.slice(1).join(' ');
                if (!word) { addSystemMessage('Kelime girin'); return; }
                BANNED_WORDS = BANNED_WORDS.filter(w => w !== word);
                await bannedWordsRef.set(BANNED_WORDS);
                addSystemMessage(`‚úÖ Kelime kaldƒ±rƒ±ldƒ±: ${word}`);
            } else if (m === 'addcmd' && currentUser.role === 'owner') {
                const cmd = p[1];
                const resp = p.slice(2).join(' ');
                if (!cmd || !resp) { addSystemMessage('Kullanƒ±m: /addcmd komut yanƒ±t'); return; }
                CUSTOM_COMMANDS.push({ cmd: '/' + cmd, resp: resp });
                await customCommandsRef.set(CUSTOM_COMMANDS);
                addSystemMessage(`‚úÖ /${cmd} komutu eklendi`);
            } else if (m === 'removecmd' && currentUser.role === 'owner') {
                const cmd = p[1];
                if (!cmd) { addSystemMessage('Kullanƒ±m: /removecmd komut'); return; }
                CUSTOM_COMMANDS = CUSTOM_COMMANDS.filter(c => c.cmd !== '/' + cmd);
                await customCommandsRef.set(CUSTOM_COMMANDS);
                addSystemMessage(`üóëÔ∏è /${cmd} komutu silindi`);
            } else if (m === 'channelopen' && currentUser.role === 'owner') {
                const ch = p[1]?.replace('#', '');
                if (!ch) { addSystemMessage('Kullanƒ±m: /channelopen #kanal'); return; }
                const newChan = {
                    name: ch, owner: 'MateKy', ownerRole: 'owner', coAdmins: [], subscribers: 1,
                    hidden: true, superHidden: true, online: {}, onlineCount: 0,
                    youtube: { current: 'jfKfPfyJRdk', title: 'S√ºper Gizli', artist: 'MateKy', playlist: [] }
                };
                await channelsRef.child(ch).set(newChan);
                const list = (await superHiddenRef.once('value')).val() || [];
                list.push(ch);
                await superHiddenRef.set(list);
                addSystemMessage(`üîí S√ºper gizli #${ch} olu≈üturuldu`);
            } else if (m === 'channelsil' && currentUser.role === 'owner') {
                const ch = p[1]?.replace('#', '');
                if (!ch) { addSystemMessage('Kullanƒ±m: /channelsil #kanal'); return; }
                await channelsRef.child(ch).remove();
                const list = (await superHiddenRef.once('value')).val() || [];
                await superHiddenRef.set(list.filter(c => c !== ch));
                addSystemMessage(`üóëÔ∏è #${ch} silindi`);
            } else if (m === 'showprv' && currentUser.role === 'owner') {
                addSystemMessage('üëÅÔ∏è √ñzel sohbet takibi aktif (demo)');
            } else if (m === 'stopshowprv' && currentUser.role === 'owner') {
                addSystemMessage('üëÅÔ∏è Takip durduruldu');
            }
        }

        // ========== PANEL FONKSƒ∞YONLARI ==========
        function openPlaylistPanel() { document.getElementById('playlistPanel').classList.add('active'); }
        function closePlaylistPanel() { document.getElementById('playlistPanel').classList.remove('active'); }
        function openMorePanel() { document.getElementById('morePanel').classList.add('active'); }
        function closeMorePanel() { document.getElementById('morePanel').classList.remove('active'); }
        function openProfilePanel() { openMorePanel(); loadProfilePanel(); }
        function openSearch() { addSystemMessage('üîç Arama yakƒ±nda'); }
        function goHome() { joinChannel('genel'); }
        function openShareSheet() { addSystemMessage('üì§ Payla≈ü yakƒ±nda'); }
        function switchToGeneralChat() { closePrivateChat(); }
        function openNotificationsPanel() { addSystemMessage('üîî Bildirimler yakƒ±nda'); }

        // ABONELƒ∞KLER PANELƒ∞
        function openSubscriptionsPanel() {
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = '<div class="panel-header"><h3>Abonelikler</h3></div>';
            if (!currentUser.subscribed || currentUser.subscribed.length === 0) {
                cont.innerHTML += '<div class="system-message">Hen√ºz abone olunan kanal yok.</div>';
            } else {
                currentUser.subscribed.forEach(async (ch) => {
                    const snap = await channelsRef.child(ch).once('value');
                    const c = snap.val();
                    if (c) {
                        cont.innerHTML += `<div class="panel-item" onclick="joinChannel('${ch}')">
                            <div class="panel-item-avatar"><i class="fas fa-hashtag"></i></div>
                            <div class="panel-item-info">
                                <div class="panel-item-title">#${ch}</div>
                                <div class="panel-item-subtitle">${c.onlineCount || 0} √ßevrimi√ßi</div>
                            </div>
                        </div>`;
                    }
                });
            }
        }

        // KANALLAR PANELƒ∞
        function openChannelsPanel() {
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = '<div class="panel-header"><h3>T√ºm Kanallar</h3></div>';
            channelsRef.once('value', (s) => {
                const chans = s.val() || {};
                Object.values(chans).forEach(c => {
                    if (!c.superHidden || currentUser.role === 'owner') {
                        cont.innerHTML += `<div class="panel-item" onclick="joinChannel('${c.name}')">
                            <div class="panel-item-avatar"><i class="fas fa-hashtag"></i></div>
                            <div class="panel-item-info">
                                <div class="panel-item-title">#${c.name}</div>
                                <div class="panel-item-subtitle">${c.onlineCount || 0} √ßevrimi√ßi</div>
                            </div>
                        </div>`;
                    }
                });
            });
        }

        // √ñZEL SOHBET Lƒ∞STESƒ∞
        function openPrivateChatList() {
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = '<div class="panel-header"><h3>√ñzel Sohbetler</h3></div>';
            privateChatsRef.once('value', (s) => {
                const chats = s.val() || {};
                let found = false;
                for (let id in chats) {
                    if (id.includes(currentUser.id)) {
                        const ids = id.split('_');
                        const otherId = ids[0] === currentUser.id ? ids[1] : ids[0];
                        usersRef.child(otherId).once('value', (u) => {
                            const user = u.val();
                            if (user) {
                                found = true;
                                cont.innerHTML += `<div class="panel-item" onclick="openPrivateChat('${user.name}')">
                                    <div class="panel-item-avatar">${user.name[0]}</div>
                                    <div class="panel-item-info">
                                        <div class="panel-item-title">${user.name}</div>
                                        <div class="panel-item-subtitle">Sohbet</div>
                                    </div>
                                </div>`;
                            }
                        });
                    }
                }
                if (!found) cont.innerHTML += '<div class="system-message">Hen√ºz √∂zel sohbet yok.</div>';
            });
        }

        // DESTEK PANELƒ∞
        function openSupportPanel() {
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = `
                <div class="panel-header"><h3>Destek</h3></div>
                <div class="form-group"><label class="form-label">Konu</label>
                    <select id="supportTopic" class="form-select">
                        <option value="bug">Hata</option><option value="suggestion">√ñneri</option>
                        <option value="complaint">≈ûikayet</option><option value="other">Diƒüer</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Mesaj</label>
                    <textarea id="supportMsg" class="form-textarea" placeholder="Detaylƒ± a√ßƒ±klama..."></textarea>
                </div>
                <button class="login-btn" onclick="sendSupport()">G√∂nder</button>
            `;
        }

        function sendSupport() {
            const topic = document.getElementById('supportTopic')?.value;
            const msg = document.getElementById('supportMsg')?.value.trim();
            if (!msg) { alert('Mesaj yazƒ±n'); return; }
            const topics = { bug: 'Hata', suggestion: '√ñneri', complaint: '≈ûikayet', other: 'Diƒüer' };
            const supportMsg = `üÜò ${currentUser.name}: ${topics[topic]}\n${msg}`;
            addSystemMessage('‚úÖ Destek talebi g√∂nderildi');
            // Admin kanalƒ±na mesaj
            messagesRef.child('admin').push({
                senderId: 'system', senderName: 'üîî DESTEK',
                text: supportMsg, time: new Date().toLocaleTimeString('tr-TR'), timestamp: Date.now()
            });
            closeMorePanel();
        }

        // AYARLAR PANELƒ∞
        function openSettingsPanel() {
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = `
                <div class="panel-header"><h3>Ayarlar</h3></div>
                <div class="form-group"><label class="form-label">Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="settingsNick" class="form-input" value="${currentUser.name}">
                    <button class="login-btn" style="margin-top:8px;" onclick="changeNick()">Deƒüi≈ütir</button>
                </div>
                <div class="form-group"><label class="form-label">≈ûifre</label>
                    <input type="password" id="settingsPass" class="form-input" placeholder="Yeni ≈üifre">
                    <button class="login-btn" style="margin-top:8px;" onclick="changePassword()">G√ºncelle</button>
                </div>
                <div class="form-group"><label class="form-label">√ñzel Sohbet</label>
                    <select id="settingsPrivate" class="form-select" onchange="changePrivateMode(this.value)">
                        <option value="all" ${currentUser.privateMode === 'all' ? 'selected' : ''}>Herkese A√ßƒ±k</option>
                        <option value="none" ${currentUser.privateMode === 'none' ? 'selected' : ''}>Herkese Kapalƒ±</option>
                        <option value="blocked" ${currentUser.privateMode === 'blocked' ? 'selected' : ''}>Sadece Engellenenler</option>
                    </select>
                </div>
                <button class="login-btn" onclick="openAvatarModal()">Profil Resmi</button>
                ${currentUser.role === 'owner' ? '<button class="login-btn" style="background:#6d0000; margin-top:16px;" onclick="showOwnerPanel()">Owner Paneli</button>' : ''}
                <button class="login-btn" style="background:#6d0000; margin-top:16px;" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
            `;
        }

        function changeNick() {
            const newNick = document.getElementById('settingsNick')?.value.trim();
            if (!newNick) return;
            currentUser.name = newNick;
            currentUser.nameLower = newNick.toLowerCase();
            usersRef.child(currentUser.id).update({ name: newNick, nameLower: newNick.toLowerCase() });
            updateAvatar();
            addSystemMessage(`‚úÖ Kullanƒ±cƒ± adƒ± deƒüi≈ütirildi: ${newNick}`);
        }

        function changePassword() {
            const newPass = document.getElementById('settingsPass')?.value.trim();
            if (newPass) {
                currentUser.password = newPass;
                usersRef.child(currentUser.id).update({ password: newPass });
                addSystemMessage('‚úÖ ≈ûifre g√ºncellendi');
            }
        }

        function changePrivateMode(mode) {
            currentUser.privateMode = mode;
            usersRef.child(currentUser.id).update({ privateMode: mode });
            addSystemMessage(`üîí √ñzel sohbet modu: ${mode}`);
        }

        // OWNER PANELƒ∞ (Gƒ∞ZLƒ∞)
        function showOwnerPanel() {
            if (currentUser.role !== 'owner') return;
            const cont = document.getElementById('morePanelContent');
            cont.innerHTML = `
                <div class="panel-header"><h3>Owner Paneli</h3></div>
                <div class="form-group"><label class="form-label">Yasaklƒ± Kelime Ekle</label>
                    <input type="text" id="ownerBannedWord" class="form-input" placeholder="kelime">
                    <button class="login-btn" style="margin-top:8px;" onclick="addBannedWord()">Ekle</button>
                </div>
                <div class="form-group"><label class="form-label">Yasaklƒ± Kelime Sil</label>
                    <input type="text" id="ownerRemoveWord" class="form-input" placeholder="kelime">
                    <button class="login-btn" style="margin-top:8px;" onclick="removeBannedWord()">Sil</button>
                </div>
                <div class="form-group"><label class="form-label">√ñzel Komut Ekle</label>
                    <input type="text" id="ownerCmdName" class="form-input" placeholder="komut adƒ±">
                    <textarea id="ownerCmdResp" class="form-textarea" placeholder="yanƒ±t"></textarea>
                    <button class="login-btn" style="margin-top:8px;" onclick="addCustomCommand()">Ekle</button>
                </div>
                <div class="form-group"><label class="form-label">√ñzel Komut Sil</label>
                    <input type="text" id="ownerRemoveCmd" class="form-input" placeholder="komut adƒ±">
                    <button class="login-btn" style="margin-top:8px;" onclick="removeCustomCommand()">Sil</button>
                </div>
            `;
        }

        async function addBannedWord() {
            const w = document.getElementById('ownerBannedWord')?.value.trim();
            if (!w) return;
            BANNED_WORDS.push(w);
            await bannedWordsRef.set(BANNED_WORDS);
            addSystemMessage(`üö´ Yasaklƒ± kelime eklendi: ${w}`);
        }

        async function removeBannedWord() {
            const w = document.getElementById('ownerRemoveWord')?.value.trim();
            if (!w) return;
            BANNED_WORDS = BANNED_WORDS.filter(x => x !== w);
            await bannedWordsRef.set(BANNED_WORDS);
            addSystemMessage(`‚úÖ Kelime kaldƒ±rƒ±ldƒ±: ${w}`);
        }

        async function addCustomCommand() {
            const cmd = document.getElementById('ownerCmdName')?.value.trim();
            const resp = document.getElementById('ownerCmdResp')?.value.trim();
            if (!cmd || !resp) return;
            CUSTOM_COMMANDS.push({ cmd: '/' + cmd, resp: resp });
            await customCommandsRef.set(CUSTOM_COMMANDS);
            addSystemMessage(`‚úÖ /${cmd} eklendi`);
        }

        async function removeCustomCommand() {
            const cmd = document.getElementById('ownerRemoveCmd')?.value.trim();
            if (!cmd) return;
            CUSTOM_COMMANDS = CUSTOM_COMMANDS.filter(c => c.cmd !== '/' + cmd);
            await customCommandsRef.set(CUSTOM_COMMANDS);
            addSystemMessage(`üóëÔ∏è /${cmd} silindi`);
        }

        // PROFƒ∞L PANELƒ∞ (Avatar)
        function openAvatarModal() { openModal('avatarModal'); }

        function previewAvatar(input) {
            if (input.files?.[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    document.getElementById('avatarPreviewText').style.display = 'none';
                    document.getElementById('avatarPreviewImage').style.display = 'block';
                    document.getElementById('avatarPreviewImage').src = e.target.result;
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        async function uploadAvatar() {
            const file = document.getElementById('avatarFile').files[0];
            if (!file) { alert('Resim se√ßin'); return; }
            const r = new FileReader();
            r.onload = async (e) => {
                currentUser.avatarData = e.target.result;
                await usersRef.child(currentUser.id).update({ avatarData: e.target.result });
                updateAvatar();
                closeModal('avatarModal');
                addSystemMessage('‚úÖ Profil resmi g√ºncellendi');
            };
            r.readAsDataURL(file);
        }

        function updateAvatar() {
            const s = document.getElementById('avatarText');
            const i = document.getElementById('avatarImage');
            if (currentUser.avatarData) {
                s.style.display = 'none';
                i.style.display = 'block';
                i.src = currentUser.avatarData;
            } else {
                s.style.display = 'block';
                i.style.display = 'none';
                s.textContent = currentUser.avatar || currentUser.name[0].toUpperCase();
            }
        }

        // ========== YARDIMCI ==========
        function autoResize(t) {
            t.style.height = 'auto';
            t.style.height = Math.min(t.scrollHeight, 80) + 'px';
        }

        function escapeHTML(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // ========== Y√úKLE ==========
        async function loadChannels() {
            await channelsRef.child('genel').once('value', s => {
                const c = s.val();
                if (c) updateYoutubeInfo(c);
            });
        }

        async function loadBannedWords() {
            const s = await bannedWordsRef.once('value');
            BANNED_WORDS = s.val() || [];
        }

        async function loadCustomCommands() {
            const s = await customCommandsRef.once('value');
            CUSTOM_COMMANDS = s.val() || [];
        }

        // ========== ENGELLE ==========
        function blockUser() {
            if (!currentPrivateChat) return;
            addSystemMessage(`üö´ ${currentPrivateChat.name} engellendi`);
            closePrivateChat();
        }

        // ========== √áIKI≈û ==========
        async function logout() {
            if (currentUser) {
                await removeFromChannel(currentChannel);
                await usersRef.child(currentUser.id).update({ online: false, lastSeen: Date.now() });
            }
            location.reload();
        }

        // ========== YOUTUBE Vƒ∞DEO EKLE ==========
        async function addYoutubeVideo() {
            const url = document.getElementById('youtubeUrl')?.value.trim();
            const title = document.getElementById('youtubeTitle')?.value.trim();
            if (!url) { addSystemMessage('URL girin'); return; }

            let vid = '';
            if (url.includes('youtube.com/watch?v=')) vid = url.split('v=')[1]?.split('&')[0];
            else if (url.includes('youtu.be/')) vid = url.split('youtu.be/')[1]?.split('?')[0];
            else if (url.match(/^[a-zA-Z0-9_-]{11}$/)) vid = url;
            if (!vid) { addSystemMessage('Ge√ßersiz URL'); return; }

            const snap = await channelsRef.child(currentChannel).once('value');
            const c = snap.val();
            c.youtube.playlist.push({ id: vid, title: title || `Video ${c.youtube.playlist.length+1}`, by: currentUser.name, role: currentUser.role });
            await channelsRef.child(currentChannel).set(c);
            updatePlaylist(c);
            closeModal('youtubeModal');
            addSystemMessage(`‚úÖ Video eklendi`);
        }

        // ========== BA≈ûLAT ==========
        window.addEventListener('load', async () => {
            await initOwner();
            await loadBannedWords();
            await loadCustomCommands();
        });

        // Enter ile g√∂nder
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (document.activeElement?.id === 'messageInput') {
                    e.preventDefault(); sendMessage();
                } else if (document.activeElement?.id === 'privateMessageInput') {
                    e.preventDefault(); sendPrivateMessage();
                }
            }
            if (e.key === 'Escape') {
                closePrivateChat();
                closePlaylistPanel();
                closeMorePanel();
            }
        });
    </script>
</body>
</html> 
