<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Popbox IRC</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, setDoc, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrn_tXJZCAlKhem45aXxj4f0h26EPOQ70",
  authDomain: "popboxmusicchat.firebaseapp.com",
  projectId: "popboxmusicchat"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let nick=null, role="user", activePM=null;

const loginBtn=document.getElementById("loginBtn");

loginBtn.onclick=async()=>{
  const n=nickIn.value.trim();
  const p=passIn.value.trim();
  if(!n||!p) return;

  const ref=doc(db,"users",n);
  const snap=await getDoc(ref);

  if(snap.exists()){
    if(snap.data().pass!==p) return alert("Şifre yanlış");
    role=snap.data().role||"user";
  }else{
    await setDoc(ref,{pass:p,role:"user"});
  }

  nick=n;
  login.style.display="none";
  chatBox.style.display="flex";
  baslat();
};

async function baslat(){
  await setDoc(doc(db,"online",nick),{nick});

  const q=query(collection(db,"messages"),orderBy("time"));
  onSnapshot(q,(s)=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      chat.innerHTML+=`<div><b onclick="openPM('${m.nick}')">${m.nick}</b>: ${m.text}</div>`;
    });
    chat.scrollTop=chat.scrollHeight;
  });

  onSnapshot(collection(db,"online"),(s)=>{
    users.innerHTML="";
    s.forEach(d=>{
      users.innerHTML+=`<div onclick="openPM('${d.data().nick}')">${d.data().nick}</div>`;
    });
  });

  const pmq=query(collection(db,"pm"),orderBy("time"));
  onSnapshot(pmq,(s)=>{
    pmChat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      if(
        (m.from===nick && m.to===activePM) ||
        (m.from===activePM && m.to===nick)
      ){
        if(m.img){
          pmChat.innerHTML+=`<div><b>${m.from}:</b><br><img src="${m.img}" width="150"></div>`;
        }else{
          pmChat.innerHTML+=`<div><b>${m.from}:</b> ${m.text}</div>`;
        }
      }
    });
  });
}

window.sendMsg=async()=>{
  let t=msg.value.trim();
  if(!t) return;

  // IRC MOD KOMUTU
  if(t.startsWith("/mode") && role==="admin"){
    const parts=t.split(" ");
    const target=parts[1];
    await setDoc(doc(db,"users",target),{role:"admin"},{merge:true});
    alert(target+" artık admin");
    msg.value="";return;
  }

  await addDoc(collection(db,"messages"),{
    nick,text:t,time:Date.now()
  });

  msg.value="";
};

window.openPM=(n)=>{
  if(n===nick) return;
  activePM=n;
  pmBox.style.display="flex";
  pmTitle.innerText="PM: "+n;
};

pmSend.onclick=async()=>{
  const text=pmMsg.value.trim();
  const file=imgSend.files[0];

  if(file){
    const reader=new FileReader();
    reader.onload=async e=>{
      await addDoc(collection(db,"pm"),{
        from:nick,to:activePM,img:e.target.result,time:Date.now()
      });
    };
    reader.readAsDataURL(file);
  }else if(text){
    await addDoc(collection(db,"pm"),{
      from:nick,to:activePM,text,time:Date.now()
    });
  }

  pmMsg.value="";
  imgSend.value="";
};
</script>

<style>
body{margin:0;background:#111;color:#fff;font-family:Arial;height:100vh;display:flex;flex-direction:column}
#video{width:100%;height:220px;border:0}
#chatBox{flex:1;display:none;flex-direction:row}
#main{flex:3;display:flex;flex-direction:column}
#chat{flex:1;overflow:auto;padding:10px;background:#1b1b1b}
#users{flex:1;background:#000;padding:10px;overflow:auto}
#input{display:flex}
#msg{flex:1;padding:15px;border:none}
button{width:100px;border:none;background:#333;color:#fff}
#login{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;justify-content:center;align-items:center}
#login input{padding:15px;margin:10px;width:240px}

#pmBox{position:fixed;bottom:0;right:0;width:320px;height:420px;background:#222;display:none;flex-direction:column}
#pmChat{flex:1;overflow:auto;padding:10px}
</style>
</head>

<body>

<div id="login">
  <h2>Popbox IRC</h2>
  <input id="nickIn" placeholder="Nick">
  <input id="passIn" type="password" placeholder="Şifre">
  <button id="loginBtn">Giriş</button>
</div>

<iframe id="video"
src="https://www.youtube.com/embed/if4gZc4v0ag?autoplay=1&mute=1"
allowfullscreen></iframe>

<div id="chatBox">
  <div id="main">
    <div id="chat"></div>
    <div id="input">
      <input id="msg" onkeypress="if(event.key==='Enter')sendMsg()">
      <button onclick="sendMsg()">Gönder</button>
    </div>
  </div>
  <div id="users"></div>
</div>

<div id="pmBox">
  <div id="pmTitle"></div>
  <div id="pmChat"></div>
  <input id="pmMsg" placeholder="Mesaj">
  <input type="file" id="imgSend">
  <button id="pmSend">Gönder</button>
</div>

</body>
</html>
